# === AU_DB_FORCE_EMERGENT_V1 ===
# AmaÃ§: tÃ¼m sqlite baÄŸlantÄ±larÄ± tek dosyaya gitsin (/app/backend/data.db)
# Emergent platform iÃ§in dÃ¼zenlendi
import os
from pathlib import Path as _AU_Path

# âœ… WINDOWS LOCAL PATH FIX
# Production (Linux): /root/backend/data.db
# Local (Windows): c:\Users\Atalay Ulusoy\Desktop\yeni\data.db
_EMERGENT_DB = os.path.join(os.path.dirname(os.path.abspath(__file__)), "data.db")
os.environ["DB_PATH"] = _EMERGENT_DB
globals()["DB_PATH"] = _EMERGENT_DB
globals()["DB_FILE"] = _EMERGENT_DB

# Port ve Host ayarlarÄ± (Emergent platform iÃ§in)
os.environ["PORT"] = "8080"  # AU_PORT_ENVFIX
os.environ["HOST"] = "0.0.0.0"
# === END AU_DB_FORCE_EMERGENT_V1 ===

# -*- coding: utf-8 -*-

# Emoji-safe constants (dosyada gerÃ§ek emoji karakteri YOK)
E_ON    = "\U0001F7E2"          # green circle
E_OFF   = "\U0001F534"          # red circle
E_OK    = "\u2705"              # check
E_X     = "\u274C"              # cross
E_STOP  = "\u26D4"              # no entry
E_PLAY  = "\u25B6\uFE0F"        # play
E_PAUS  = "\u23F8\uFE0F"        # pause
E_USER  = "\U0001F464"          # user
E_MNY   = "\U0001F4B0"          # money bag
E_TST   = "\U0001F9EA"          # test tube
E_BANK  = "\U0001F3E6"          # bank
E_NOTE  = "\U0001F4DD"          # memo
E_PIN   = "\U0001F4CC"          # pin
E_HOME  = "\U0001F3E0"          # house
E_SHLD  = "\U0001F6E1\uFE0F"    # shield
E_PPL   = "\U0001F465"          # people
E_LOGS  = "\U0001F9FE"          # receipt (logs)
E_PLUS  = "\u2795"              # plus
E_EXIT  = "\U0001F6AA"          # door
E_LOCK  = "\U0001F510"          # lock
E_CHART = "\U0001F4CA"          # bar chart
E_MAIL  = "\U0001F4E8"          # incoming envelope
E_MOUSE = "\U0001F5B1\uFE0F"    # mouse
E_SAVE  = "\U0001F4BE"          # floppy
E_BOT   = "\U0001F916"          # robot
E_INBOX = "\U0001F4E5"          # inbox tray
E_WARN  = "\u26A0\uFE0F"        # warning
E_BOOM  = "\U0001F4A5"          # collision
E_BACK  = "\u21A9\uFE0F"        # back arrow
E_BROOM = "\U0001F9F9"          # broom
E_TRASH = "\U0001F5D1\uFE0F"    # trash
E_EDIT  = "\u270F\uFE0F"        # pencil
E_UP    = "\U0001F4C8"          # chart up
E_BOX   = "\U0001F4E6"          # package
E_TAB   = "\U0001F4B2"          # dollar sign style icon
E_TIME  = "\u23F0"              # alarm clock

from flask import Flask, Response, render_template_string, request, session, redirect, url_for, jsonify, send_file, abort

EXCHANGE_API_TEMPLATE = """
{% extends "base" %}
{% block head %}
<script>
    function openApiModal(n){
        document.getElementById('apiModal').classList.remove('hidden');
        document.getElementById('modalTitle').innerText = n + ' API Ayarlari';
        document.getElementById('exchangeInput').value = n;
        // Reset
        document.getElementById('apiKey').value = '';
        document.getElementById('apiSecret').value = '';
        document.getElementById('passphrase').value = '';
    }
    function closeApiModal(){
        document.getElementById('apiModal').classList.add('hidden');
    }
    async function saveApiConfig() {
        const k = document.getElementById('apiKey').value;
        const s = document.getElementById('apiSecret').value;
        const p = document.getElementById('passphrase').value;
        const ex = document.getElementById('exchangeInput').value;
        
        if(!k || !s) { alert('API Key ve Secret gereklidir.'); return; }

        try {
            const r = await fetch('/api/exchange/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({exchange: ex, api_key: k, api_secret: s, passphrase: p})
            });
            const j = await r.json();
            if(j.success) {
                alert(ex + ' API Basariyla Kaydedildi!');
                location.reload();
            } else {
                alert('Hata: ' + j.message);
            }
        } catch(e) { alert('Baglanti Hatasi!'); }
    }
</script>
{% endblock %}
{% block content %}
<div class="p-6 text-white">
    <h1 class="text-3xl font-bold mb-6">Borsa API Yonetimi</h1>
    <p class="mb-8 text-gray-400">Otomatik alim-satim islemleri icin borsa API anahtarlarinizi asagidan ekleyebilirsiniz.</p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        
        <!-- OKX -->
        <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 hover:border-blue-500 transition shadow-lg">
            <h2 class="text-xl font-bold text-white mb-2 flex items-center gap-2">OKX <span class="bg-blue-900 text-blue-200 text-xs px-2 py-0.5 rounded">Onerilen</span></h2>
            <p class="text-gray-400 text-sm mb-4">Vadeli ve Spot islem destegi.</p>
            <button onclick="openApiModal('OKX')" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-medium">Ayarlari Duzenle</button>
        </div>

        <!-- BINANCE -->
        <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 hover:border-yellow-500 transition shadow-lg">
            <h2 class="text-xl font-bold text-white mb-2">BINANCE</h2>
            <p class="text-gray-400 text-sm mb-4">Global Binance API baglantisi.</p>
            <button onclick="openApiModal('BINANCE')" class="w-full px-4 py-2 bg-[#FCD535] hover:bg-yellow-500 text-black font-medium">Ayarlari Duzenle</button>
        </div>

        <!-- BYBIT -->
        <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 hover:border-orange-500 transition shadow-lg">
            <h2 class="text-xl font-bold text-white mb-2">BYBIT</h2>
            <p class="text-gray-400 text-sm mb-4">Hizli ve guvenilir vadeli islem.</p>
            <button onclick="openApiModal('BYBIT')" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-white font-medium">Ayarlari Duzenle</button>
        </div>

        <!-- GATE.IO -->
        <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 hover:border-green-500 transition shadow-lg">
            <h2 class="text-xl font-bold text-white mb-2">GATE.IO</h2>
            <p class="text-gray-400 text-sm mb-4">Genis altcoin yelpazesi.</p>
            <button onclick="openApiModal('GATEIO')" class="w-full px-4 py-2 bg-green-700 hover:bg-green-600 rounded text-white font-medium">Ayarlari Duzenle</button>
        </div>

        <!-- BTCTURK -->
        <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 hover:border-red-500 transition shadow-lg">
            <h2 class="text-xl font-bold text-white mb-2">BTCTURK</h2>
            <p class="text-gray-400 text-sm mb-4">Yerli borsa entegrasyonu.</p>
            <button onclick="openApiModal('BTCTURK')" class="w-full px-4 py-2 bg-red-700 hover:bg-red-600 rounded text-white font-medium">Ayarlari Duzenle</button>
        </div>

    </div>
</div>

<!-- Simple Modal -->
<div id="apiModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-[9999]">
    <div class="bg-[#222] p-8 rounded-2xl w-full max-w-md border border-gray-700 shadow-2xl relative">
        <button onclick="closeApiModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
        <h3 id="modalTitle" class="text-2xl font-bold text-white mb-6">API Ayarlari</h3>
        <input id="exchangeInput" type="hidden">
        
        <div class="space-y-4">
             <div>
                <label class="block text-gray-400 text-sm mb-1">API Key</label>
                <input id="apiKey" class="w-full bg-[#111] border border-gray-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition" placeholder="Borsa API Anahtari">
             </div>
             <div>
                <label class="block text-gray-400 text-sm mb-1">Secret Key</label>
                <input id="apiSecret" type="password" class="w-full bg-[#111] border border-gray-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition" placeholder="Gizli Anahtar">
             </div>
             <div>
                <label class="block text-gray-400 text-sm mb-1">Passphrase (Varsa)</label>
                <input id="passphrase" type="password" class="w-full bg-[#111] border border-gray-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition" placeholder="OKX icin gereklidir">
             </div>
        </div>
        
        <div class="flex justify-end gap-3 mt-8">
            <button onclick="closeApiModal()" class="px-5 py-2.5 text-gray-300 hover:text-white font-medium">Vazgec</button>
            <button onclick="saveApiConfig()" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold shadow-lg shadow-blue-900/50">Kaydet ve Baglan</button>
        </div>
    </div>
</div>
{% endblock %}
"""


PAYMENT_TEMPLATE = """
{% extends "base" %}
{% block content %}
<div class="p-8 text-center">
    <h1 class="text-3xl font-bold text-white mb-4">Odeme Plani</h1>
    <p class="text-gray-400">Odeme servisi su anda bakimdadir veya yapilandirilmamistir.</p>
</div>
{% endblock %}
"""


PORTFOLIO_ANALYTICS_TEMPLATE = """
{% extends "base" %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
{% endblock %}
{% block content %}
<div class="p-6 max-w-[1600px] mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold text-white">PortfÃ¶y Analizi</h1>
            <p class="text-gray-400 text-sm mt-1">DetaylÄ± performans raporlarÄ± ve varlÄ±k daÄŸÄ±lÄ±mÄ±</p>
        </div>
        <div class="flex gap-3">
            <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium text-sm transition">
                ğŸ”„ Yenile
            </button>
            <button onclick="downloadPDF()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-medium text-sm transition">
                ğŸ“¥ Rapor Ä°ndir
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="flex gap-3 mb-6">
        <select id="exchangeFilter" class="px-4 py-2 bg-[#1a1a1a] border border-white/10 rounded-lg text-white text-sm focus:border-blue-500 outline-none">
            <option>TÃ¼m Borsalar</option>
            <option>Binance</option>
            <option>OKX</option>
            <option>Bybit</option>
            <option>Gate.io</option>
            <option>BTCTURK</option>
        </select>
        <select id="strategyFilter" class="px-4 py-2 bg-[#1a1a1a] border border-white/10 rounded-lg text-white text-sm focus:border-blue-500 outline-none">
            <option>TÃ¼m Stratejiler</option>
            <option>Scalping</option>
            <option>Day Trading</option>
            <option>Swing Trading</option>
        </select>
        <button onclick="applyFilters()" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium text-sm transition">
            SÄ±rala
        </button>
    </div>

    <!-- Main Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-[#1a1a1a] p-5 rounded-xl border border-white/10">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-gray-400 text-sm">Toplam PortfÃ¶y DeÄŸeri</h3>
                <span class="text-2xl">ğŸ’°</span>
            </div>
            <p class="text-2xl font-bold text-white">155.000,00 â‚º</p>
            <p class="text-green-400 text-sm mt-1">+24,2% (Son 30 gÃ¼n)</p>
        </div>
        <div class="bg-[#1a1a1a] p-5 rounded-xl border border-white/10">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-gray-400 text-sm">GerÃ§ekleÅŸmemiÅŸ Kar/Zarar</h3>
                <span class="text-2xl">ğŸ“ˆ</span>
            </div>
            <p class="text-2xl font-bold text-green-400">+18.250,75 â‚º</p>
            <p class="text-gray-400 text-sm mt-1">+13,4%</p>
        </div>
        <div class="bg-[#1a1a1a] p-5 rounded-xl border border-white/10">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-gray-400 text-sm">BaÅŸarÄ± OranÄ±</h3>
                <span class="text-2xl">ğŸ¯</span>
            </div>
            <p class="text-2xl font-bold text-white">64,8%</p>
            <p class="text-gray-400 text-sm mt-1">KÃ¢rlÄ± iÅŸlem yÃ¼zdesi</p>
        </div>
        <div class="bg-[#1a1a1a] p-5 rounded-xl border border-white/10">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-gray-400 text-sm">Sharpe OranÄ±</h3>
                <span class="text-2xl">ğŸ“Š</span>
            </div>
            <p class="text-2xl font-bold text-white">1,85</p>
            <p class="text-gray-400 text-sm mt-1">KÃ¢r performansÄ±</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Performance Trend Chart -->
        <div class="lg:col-span-2 bg-[#1a1a1a] p-6 rounded-xl border border-white/10">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Performance Trendi</h2>
                <div class="flex gap-2">
                    <button class="px-3 py-1 bg-blue-600 rounded-lg text-white text-xs font-medium">1G</button>
                    <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-xs">7G</button>
                    <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-xs">1A</button>
                    <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-xs">3A</button>
                    <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-xs">1Y</button>
                </div>
            </div>
            <div class="h-64">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Asset Distribution Pie Chart -->
        <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10">
            <h2 class="text-xl font-bold text-white mb-4">VarlÄ±k DaÄŸÄ±lÄ±mÄ±</h2>
            <div class="h-64 flex items-center justify-center">
                <canvas id="assetPieChart"></canvas>
            </div>
            <div class="mt-4 space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-400">ğŸŸ¦ BTC/TRY</span><span class="text-white font-medium">29.03%</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ğŸŸ© XRP/TRY</span><span class="text-white font-medium">23.58%</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ğŸŸ¨ SOL/TRY</span><span class="text-white font-medium">22.19%</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ğŸŸ§ ADA/TRY</span><span class="text-white font-medium">9.60%</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ğŸŸ¥ AVAX/TRY</span><span class="text-white font-medium">5.49%</span></div>
                <div class="flex justify-between"><span class="text-gray-400">â¬œ DiÄŸer</span><span class="text-white font-medium">3.23%</span></div>
            </div>
        </div>
    </div>

    <!-- Performance Distribution Table -->
    <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 mb-6">
        <h2 class="text-xl font-bold text-white mb-4">Performans DaÄŸÄ±lÄ±mÄ±</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-white/10">
                        <th class="text-left text-gray-400 font-medium py-3 px-4">Ä°ÅŸlem Ã‡ifti</th>
                        <th class="text-left text-gray-400 font-medium py-3 px-4">Borsa</th>
                        <th class="text-center text-gray-400 font-medium py-3 px-4">Ä°ÅŸlem SayÄ±sÄ±</th>
                        <th class="text-left text-gray-400 font-medium py-3 px-4">BaÅŸarÄ± OranÄ±</th>
                        <th class="text-right text-gray-400 font-medium py-3 px-4">Kar/Zarar</th>
                        <th class="text-right text-gray-400 font-medium py-3 px-4">ROI</th>
                    </tr>
                </thead>
                <tbody id="performanceTable">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-[#1a1a1a] p-5 rounded-xl border border-white/10">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">âš¡</span>
                <h3 class="text-gray-400 text-sm">Toplam Ä°ÅŸlem</h3>
            </div>
            <p class="text-2xl font-bold text-white">0</p>
        </div>
        <div class="bg-[#1a1a1a] p-5 rounded-xl border border-white/10">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">ğŸ²</span>
                <h3 class="text-gray-400 text-sm">KazanÃ§ OranÄ±</h3>
            </div>
            <p class="text-2xl font-bold text-green-400">0.0%</p>
        </div>
        <div class="bg-[#1a1a1a] p-5 rounded-xl border border-white/10">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">ğŸ“Š</span>
                <h3 class="text-gray-400 text-sm">Sharpe OranÄ±</h3>
            </div>
            <p class="text-2xl font-bold text-white">1.50</p>
        </div>
        <div class="bg-[#1a1a1a] p-5 rounded-xl border border-white/10">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">ğŸ“‰</span>
                <h3 class="text-gray-400 text-sm">Max Drawdown</h3>
            </div>
            <p class="text-2xl font-bold text-red-400">15.0%</p>
        </div>
    </div>

    <!-- Risk Management & PDF Report -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Risk Management -->
        <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Risk YÃ¶netimi</h2>
                <button onclick="saveRiskSettings()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium text-sm transition">
                    Kaydet
                </button>
            </div>
            
            <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4 mb-4">
                <p class="text-red-400 text-sm">âš ï¸ Maksimum Drawdown UyarÄ± EÅŸiÄŸi</p>
                <p class="text-gray-300 text-xs mt-1">GeÃ§miÅŸ son %10 hesaplanmÄ±ÅŸ, sÄ±nÄ±rÄ±nÄ±z %10'a gelmeden uyarÄ± alÄ±rsÄ±nÄ±z!</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-gray-400 text-sm block mb-2">Pozisyon BÃ¼yÃ¼klÃ¼ÄŸÃ¼ Limiti (USDT)</label>
                    <input type="number" value="100" class="w-full px-4 py-2 bg-[#111] border border-white/10 rounded-lg text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-gray-400 text-sm block mb-2">KaldÄ±raÃ§ KontrolÃ¼</label>
                    <input type="number" value="3" max="10" class="w-full px-4 py-2 bg-[#111] border border-white/10 rounded-lg text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-gray-400 text-sm block mb-2">GÃ¼nlÃ¼k Zarar Limiti (%)</label>
                    <input type="number" value="10" class="w-full px-4 py-2 bg-[#111] border border-white/10 rounded-lg text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-gray-400 text-sm block mb-2">UyarÄ± EÅŸiÄŸi (%)</label>
                    <input type="number" value="15.00" step="0.01" class="w-full px-4 py-2 bg-[#111] border border-white/10 rounded-lg text-white focus:border-blue-500 outline-none">
                </div>
            </div>

            <div class="mt-6 grid grid-cols-2 gap-3">
                <div class="bg-[#111] p-4 rounded-lg border border-white/10">
                    <p class="text-gray-400 text-xs mb-1">Minimum Risk/Pozisyon</p>
                    <p class="text-white font-bold">100 USDT</p>
                </div>
                <div class="bg-[#111] p-4 rounded-lg border border-white/10">
                    <p class="text-gray-400 text-xs mb-1">Toplam Maksimum Risk</p>
                    <p class="text-white font-bold">500 USDT</p>
                </div>
                <div class="bg-[#111] p-4 rounded-lg border border-white/10">
                    <p class="text-gray-400 text-xs mb-1">GÃ¼nlÃ¼k KayÄ±p</p>
                    <p class="text-white font-bold">50 USDT</p>
                </div>
                <div class="bg-[#111] p-4 rounded-lg border border-white/10">
                    <p class="text-gray-400 text-xs mb-1">Minimum AÃ§Ä±k Pozisyon</p>
                    <p class="text-white font-bold">5</p>
                </div>
            </div>
        </div>

        <!-- PDF Report -->
        <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10">
            <h2 class="text-xl font-bold text-white mb-4">PDF Rapor OluÅŸtur</h2>
            
            <div class="flex gap-2 mb-4">
                <button class="flex-1 py-2 bg-blue-600 rounded-lg text-white text-sm font-medium">Genel</button>
                <button class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-sm">HaftalÄ±k</button>
                <button class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-sm">AylÄ±k</button>
            </div>

            <div class="bg-[#111] p-4 rounded-lg border border-white/10 mb-4">
                <p class="text-gray-300 text-sm mb-3">ğŸ“„ PortfÃ¶y analiz raporunuzu PDF olarak indirebilirsiniz</p>
                <button onclick="downloadPDF()" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-bold transition">
                    ğŸ“¥ PDF Rapor Ä°ndir
                </button>
            </div>

            <div class="space-y-2 text-sm">
                <p class="text-gray-400">Rapor iÃ§eriÄŸi:</p>
                <ul class="text-gray-300 space-y-1 ml-4">
                    <li>âœ… Genel performans metrikleri</li>
                    <li>âœ… Ä°ÅŸlem listesi ve analizleri</li>
                    <li>âœ… Risk yÃ¶netimi Ã¶zeti</li>
                    <li>âœ… VarlÄ±k daÄŸÄ±lÄ±mÄ± grafiÄŸi</li>
                    <li>âœ… Kar/zarar raporu</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Performance Trend Chart
const perfCtx = document.getElementById('performanceChart');
new Chart(perfCtx, {
    type: 'line',
    data: {
        labels: ['01 Oca', '05 Oca', '10 Oca', '15 Oca', '20 Oca', '25 Oca', '30 Oca', '04 Åub'],
        datasets: [{
            label: 'PortfÃ¶y DeÄŸeri',
            data: [125000, 128000, 135000, 140000, 145000, 150000, 152000, 155000],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
        }, {
            label: 'Benchmark',
            data: [125000, 126000, 128000, 130000, 132000, 135000, 137000, 140000],
            borderColor: '#6b7280',
            borderDash: [5, 5],
            fill: false,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: true, labels: { color: '#fff' } }
        },
        scales: {
            y: { 
                beginAtZero: false,
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            x: { 
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});

// Asset Pie Chart
const pieCtx = document.getElementById('assetPieChart');
new Chart(pieCtx, {
    type: 'doughnut',
    data: {
        labels: ['BTC/TRY', 'XRP/TRY', 'SOL/TRY', 'ADA/TRY', 'AVAX/TRY', 'DiÄŸer'],
        datasets: [{
            data: [29.03, 23.58, 22.19, 9.60, 5.49, 3.23],
            backgroundColor: ['#3b82f6', '#22c55e', '#eab308', '#f97316', '#ef4444', '#6b7280'],
            borderWidth: 2,
            borderColor: '#1a1a1a'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        }
    }
});

// Performance Table Data
const performanceData = [
    { coin: 'BTC/TRY', exchange: 'Binance', trades: 145, successRate: 68, pl: '+15.568,45 â‚º', roi: '+6,5%', roiVal: 6.5 },
    { coin: 'ETH/TRY', exchange: 'OKX', trades: 132, successRate: 65, pl: '+6.768,25 â‚º', roi: '+6,2%', roiVal: 6.2 },
    { coin: 'XRP/TRY', exchange: 'Bybit', trades: 98, successRate: 72, pl: '+3.269,75 â‚º', roi: '+4,8%', roiVal: 4.8 },
    { coin: 'SOL/TRY', exchange: 'Gate.io', trades: 87, successRate: 58, pl: '+3.859,80 â‚º', roi: '+3,8%', roiVal: 3.8 },
    { coin: 'ADA/TRY', exchange: 'BTCTURK', trades: 76, successRate: 62, pl: '+2.198,18 â‚º', roi: '+2,8%', roiVal: 2.8 },
    { coin: 'AVAX/TRY', exchange: 'Binance', trades: 54, successRate: 55, pl: '+1.358,25 â‚º', roi: '+1,9%', roiVal: 1.9 },
    { coin: 'DOGE/TRY', exchange: 'Bybit', trades: 38, successRate: 52, pl: '+658,68 â‚º', roi: '+8,8%', roiVal: 8.8 },
    { coin: 'MATIC/TRY', exchange: 'OKX', trades: 63, successRate: 48, pl: '-58,75 â‚º', roi: '-1,2%', roiVal: -1.2 }
];

const tbody = document.getElementById('performanceTable');
performanceData.forEach(row => {
    const tr = document.createElement('tr');
    tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
    tr.innerHTML = `
        <td class="py-3 px-4 font-bold text-white">${row.coin}</td>
        <td class="py-3 px-4 text-gray-300">${row.exchange}</td>
        <td class="py-3 px-4 text-center text-gray-300">${row.trades}</td>
        <td class="py-3 px-4">
            <div class="flex items-center gap-2">
                <div class="flex-1 bg-gray-700 h-2 rounded-full overflow-hidden">
                    <div class="bg-green-500 h-full" style="width: ${row.successRate}%"></div>
                </div>
                <span class="text-gray-300 text-xs">${row.successRate}%</span>
            </div>
        </td>
        <td class="py-3 px-4 text-right font-bold ${row.roiVal > 0 ? 'text-green-400' : 'text-red-400'}">${row.pl}</td>
        <td class="py-3 px-4 text-right font-bold ${row.roiVal > 0 ? 'text-green-400' : 'text-red-400'}">${row.roi}</td>
    `;
    tbody.appendChild(tr);
});

function applyFilters() {
    alert('Filtre uygulandÄ±!');
}

function saveRiskSettings() {
    alert('Risk ayarlarÄ± kaydedildi!');
}

function downloadPDF() {
    alert('PDF raporu indiriliyor...');
    // Implement PDF generation using html2pdf.js or similar
}
</script>
{% endblock %}
"""


EDUCATION_TEMPLATE = """
{% extends "base" %}
{% block content %}
<div class="p-6">
    <h1 class="text-3xl font-bold text-white mb-6">Egitim Merkezi</h1>
    <p class="text-gray-400">Egitim icerikleri yakinda eklenecektir.</p>
</div>
{% endblock %}
"""




from functools import wraps


# ============================================
# TEMPLATE FALLBACKS (prevent NameError on import)
# ============================================
# Bu template stringleri, bazÄ± build'lerde DictLoader iÃ§inde referans olup aÅŸaÄŸÄ±da tanÄ±mlÄ± gelmeyebiliyor.
# Burada en baÅŸta fallback tanÄ±mÄ± yaparak servis boot sÄ±rasÄ±nda NameError ile dÃ¼ÅŸmesini engelliyoruz.

def _tpl_fallback(title: str, body_html: str) -> str:
    return f"""{{% extends "base" %}}{{% block content %}}
    <div class="max-w-5xl mx-auto px-4 py-8">
      <div class="rounded-2xl border border-slate-700/40 bg-slate-900/40 p-6 shadow">
        <h1 class="text-2xl font-semibold mb-3 text-slate-100">{title}</h1>
        <div class="prose prose-invert max-w-none">
          {body_html}
        </div>
      </div>
    </div>
{{% endblock %}}"""

try:
    ABOUT_US_TEMPLATE
except Exception:
    ABOUT_US_TEMPLATE = _tpl_fallback(
        "HakkÄ±mÄ±zda",
        "<p>Bu sayfa sistem kurulumu sÄ±rasÄ±nda otomatik oluÅŸturuldu. Ä°Ã§erik daha sonra gÃ¼ncellenebilir.</p>"
    )

try:
    FAQ_TEMPLATE
except Exception:
    FAQ_TEMPLATE = _tpl_fallback(
        "SSS",
        "<p>SSS iÃ§eriÄŸi daha sonra eklenecek.</p>"
    )

# BazÄ± sÃ¼rÃ¼mlerde bu template'ler DictLoader iÃ§inde var ama tanÄ±mÄ± yok
try:
    ARBITRAGE_MONITOR_TEMPLATE
except Exception:
    ARBITRAGE_MONITOR_TEMPLATE = _tpl_fallback(
        "Arbitraj Takibi",
        "<p>Arbitraj izleme ekranÄ± yakÄ±nda aktif olacak.</p>"
    )

# ===============================================
# COMMODITY PRICES (Gold, Silver, Copper, Palladium)
# ===============================================
# Bu fiyatlar emtia coinleri iÃ§in kullanÄ±lÄ±r
# GerÃ§ek sistemde external API'den Ã§ekilebilir
COMMODITY_PRICES = {
    "XAU/USDT": 2652.75,   # Gold (AltÄ±n) - gÃ¼ncel spot fiyat
    "XAUUSDT": 2652.75,    # Alternative format
    "XAG/USDT": 30.85,     # Silver (GÃ¼mÃ¼ÅŸ)
    "XAGUSDT": 30.85,
    "XCU/USDT": 4.18,      # Copper (BakÄ±r)
    "XCUUSDT": 4.18,
    "XPD/USDT": 1048.50,   # Palladium
    "XPDUSDT": 1048.50
}

GETTING_STARTED_GUIDE_TEMPLATE = r'''<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BaÅŸlangÄ±Ã§ KÄ±lavuzu | AU Auto Trade</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#050916;
      --bg2:#071029;
      --panel:rgba(18,26,42,.76);
      --panel2:rgba(0,0,0,.22);
      --border:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --blue:#3b82f6;
      --green:#22c55e;
      --amber:#f59e0b;
      --red:#ef4444;
      --radius:18px;
      --shadow:0 14px 40px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 50% 0%, rgba(59,130,246,.26), transparent 55%),
                  radial-gradient(900px 500px at 85% 25%, rgba(34,197,94,.14), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2) 45%, #060a14);
    }
    /* Sidebar Custom CSS - Tailwind class override */
    #sidebar{position:fixed;left:0;top:0;height:100vh;width:256px;background:#1a1a1a;border-right:1px solid rgba(255,255,255,.1);z-index:100;display:flex;flex-direction:column;transform:translateX(0);}
    #sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;display:none;}
    #sidebar-toggle{position:fixed;top:16px;left:16px;z-index:101;width:40px;height:40px;border-radius:8px;background:#1a1a1a;border:1px solid rgba(255,255,255,.1);display:none;align-items:center;justify-content:center;color:#fff;cursor:pointer;}
    #sidebar .p-4{padding:16px;}
    #sidebar .p-3{padding:12px;}
    #sidebar .border-b{border-bottom:1px solid rgba(255,255,255,.1);}
    #sidebar .border-t{border-top:1px solid rgba(255,255,255,.1);}
    #sidebar .flex{display:flex;}
    #sidebar .flex-1{flex:1;}
    #sidebar .flex-col{flex-direction:column;}
    #sidebar .items-center{align-items:center;}
    #sidebar .justify-between{justify-content:space-between;}
    #sidebar .gap-3{gap:12px;}
    #sidebar .space-y-1>*+*{margin-top:4px;}
    #sidebar .overflow-y-auto{overflow-y:auto;}
    #sidebar .w-10{width:40px;}
    #sidebar .h-10{height:40px;}
    #sidebar .rounded-lg{border-radius:8px;}
    #sidebar .bg-blue-600{background:#2563eb;}
    #sidebar .text-white{color:#fff;}
    #sidebar .text-lg{font-size:18px;}
    #sidebar .text-sm{font-size:14px;}
    #sidebar .font-bold{font-weight:700;}
    #sidebar .font-medium{font-weight:500;}
    #sidebar .text-gray-400{color:#9ca3af;}
    #sidebar .text-gray-500{color:#6b7280;}
    #sidebar .text-green-500{color:#22c55e;}
    #sidebar .text-red-400{color:#f87171;}
    #sidebar .bg-\\[\\#161616\\]{background:#161616;}
    #sidebar .px-2{padding-left:8px;padding-right:8px;}
    #sidebar .px-3{padding-left:12px;padding-right:12px;}
    #sidebar .py-2{padding-top:8px;padding-bottom:8px;}
    #sidebar .mb-3{margin-bottom:12px;}
    #sidebar .mb-1\\.5{margin-bottom:6px;}
    #sidebar .uppercase{text-transform:uppercase;}
    #sidebar .tracking-wider{letter-spacing:.05em;}
    #sidebar .rounded-full{border-radius:9999px;}
    #sidebar .w-1\\.5{width:6px;}
    #sidebar .h-1\\.5{height:6px;}
    #sidebar a{text-decoration:none;color:inherit;}
    #sidebar nav a{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;font-size:14px;color:#9ca3af;transition:all .15s;}
    #sidebar nav a:hover{background:rgba(255,255,255,.05);color:#fff;}
    #sidebar nav a.active{background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.3);}
    @media(max-width:1024px){
      #sidebar{transform:translateX(-100%);}
      #sidebar.open{transform:translateX(0);}
      #sidebar-toggle{display:flex;}
      #sidebar-overlay.show{display:block;}
    }
    .app{display:flex; min-height:100vh;}
    .sidebar-wrap{width:270px; flex:0 0 270px;}
    .content{flex:1; padding:22px 22px 28px; margin-left:256px;}
    .wrap{max-width:980px; margin:0 auto;}
    .hdr{
      padding:18px 18px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(18,26,42,.65);
      box-shadow: var(--shadow);
      display:flex; gap:12px; align-items:center;
      margin-bottom:14px;
    }
    .hdr .ic{
      width:34px; height:34px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(34,197,94,.15);
      border:1px solid rgba(34,197,94,.25);
      font-size:18px;
    }
    .hdr h1{margin:0; font-size:20px;}
    .hdr p{margin:4px 0 0; color:var(--muted); font-size:12px}
    .panel{
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(18,26,42,.65);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .top{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .stepper{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      align-items:center;
    }
    .step{
      display:flex; align-items:center; gap:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      transition:.15s;
      position:relative;
    }
    .step:hover{transform:translateY(-1px); background: rgba(255,255,255,.04);}
    .step .b{
      width:34px; height:34px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
    }
    .step.active{
      border-color: rgba(59,130,246,.35);
      background: rgba(59,130,246,.16);
    }
    .step.active .b{
      background: rgba(59,130,246,.22);
      border-color: rgba(59,130,246,.40);
    }
    .step .t{display:flex; flex-direction:column; gap:3px;}
    .step .t .a{font-size:12px; font-weight:900;}
    .step .t .d{font-size:11px; color:var(--muted);}
    .progress{
      height:6px; background: rgba(255,255,255,.06);
      border-radius:999px; overflow:hidden;
      margin-top:12px;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(59,130,246,.85), rgba(34,197,94,.85));
    }
    .body{padding:16px 18px;}
    .h2{margin:0 0 10px; font-size:16px; font-weight:900;}
    .p{margin:0 0 14px; color:var(--muted); font-size:12px; line-height:1.55;}
    .cards{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .xcard{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      padding:14px 14px;
      cursor:pointer;
      transition:.15s;
      min-height:86px;
      display:flex; gap:12px; align-items:center;
    }
    .xcard:hover{transform:translateY(-1px); background: rgba(255,255,255,.04);}
    .xlogo{
      width:40px; height:40px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .xname{font-weight:900; font-size:13px;}
    .xsub{color:var(--muted); font-size:11px; margin-top:4px;}
    .modegrid{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;}
    .mode{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      padding:14px 14px;
    }
    .mode .ttl{font-weight:900; display:flex; align-items:center; gap:8px;}
    .mode ul{margin:10px 0 0 18px; padding:0; color:rgba(255,255,255,.70); font-size:12px; line-height:1.6;}
    .btnrow{display:flex; gap:10px; justify-content:flex-end; margin-top:14px;}
    .btn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.35);}
    .note{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:rgba(255,255,255,.70);
      font-size:12px;
    }

    /* modal */
    .modal-bg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(980px, 96vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,26,42,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .modal .mh{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.02);
    }
    .modal .mh .ttl{display:flex; align-items:center; gap:10px; font-weight:900;}
    .modal .mh .close{
      width:38px; height:38px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer; color:#fff; font-weight:900;
    }
    .modal .mb{padding:14px 16px;}
    .grid2{display:grid; grid-template-columns: 1.25fr .75fr; gap:14px;}
    .video{
      border-radius:16px; overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      aspect-ratio: 16 / 9;
    }
    .steps{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      padding:12px 12px;
      color:rgba(255,255,255,.72);
      font-size:12px;
    }
    .steps ol{margin:8px 0 0 18px;}
    .steps li{margin:6px 0;}
    .links{display:flex; gap:10px; margin-top:12px;}
    .linkbtn{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      text-align:center;
      text-decoration:none;
      font-size:12px;
    }
    .linkbtn.primary{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.35);}
    @media (max-width:1100px){ .content{padding:16px; margin-left: 0;} }
    @media (max-width:900px){ .cards{grid-template-columns:1fr;} .grid2{grid-template-columns:1fr;} .stepper{grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="app">
    {{ sidebar|safe }}
    <div class="content">
      <div class="wrap">
        <div class="hdr">
          <div class="ic">ğŸ“—</div>
          <div>
            <h1>BaÅŸlangÄ±Ã§ Rehberi</h1>
            <p>AdÄ±m adÄ±m kurulum ve test sÃ¼reci</p>
          </div>
        </div>

        <div class="panel">
          <div class="top">
            <div class="stepper" id="stepper">
              <div class="step active" data-step="1">
                <div class="b">ğŸ”‘</div>
                <div class="t"><div class="a">API AnahtarÄ± Alma</div><div class="d">Borsandan API anahtarÄ± al</div></div>
              </div>
              <div class="step" data-step="2">
                <div class="b">ğŸ”—</div>
                <div class="t"><div class="a">API Entegrasyonu</div><div class="d">AnahtarlarÄ± sisteme ekle</div></div>
              </div>
              <div class="step" data-step="3">
                <div class="b">ğŸ§ª</div>
                <div class="t"><div class="a"></div><div class="d">Sanal para ile test et</div></div>
              </div>
              <div class="step" data-step="4">
                <div class="b">ğŸ’°</div>
                <div class="t"><div class="a">GerÃ§ek Mod Aktivasyonu</div><div class="d">GerÃ§ek iÅŸlemlere baÅŸla</div></div>
              </div>
            </div>
            <div class="progress"><div id="progressBar"></div></div>
          </div>

          <div class="body">
            <div id="step1" class="stepview">
              <div class="h2">AdÄ±m 1: API AnahtarÄ± Alma</div>
              <div class="p">Ä°ÅŸlem yapmak istediÄŸiniz borsadan API anahtarÄ± almanÄ±z gerekiyor. AÅŸaÄŸÄ±daki karttan borsayÄ± seÃ§ip video rehberi izleyin.</div>

              <div class="cards">
                <div class="xcard" data-ex="binance">
                  <div class="xlogo" style="background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.25)">ğŸŸ </div>
                  <div><div class="xname">Binance</div><div class="xsub">Video rehberi izle</div></div>
                </div>
                <div class="xcard" data-ex="okx">
                  <div class="xlogo" style="background:rgba(59,130,246,.16);border-color:rgba(59,130,246,.28)">ğŸ”µ</div>
                  <div><div class="xname">OKX</div><div class="xsub">Video rehberi izle</div></div>
                </div>
                <div class="xcard" data-ex="bybit">
                  <div class="xlogo" style="background:rgba(168,85,247,.14);border-color:rgba(168,85,247,.25)">ğŸŸ£</div>
                  <div><div class="xname">Bybit</div><div class="xsub">Video rehberi izle</div></div>
                </div>
                <div class="xcard" data-ex="gate">
                  <div class="xlogo" style="background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.25)">ğŸŸ¢</div>
                  <div><div class="xname">Gate.io</div><div class="xsub">Video rehberi izle</div></div>
                </div>
                <div class="xcard" data-ex="btcturk">
                  <div class="xlogo" style="background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.25)">ğŸ”´</div>
                  <div><div class="xname">BTCTURK</div><div class="xsub">Video rehberi izle</div></div>
                </div>
              </div>

              <div class="note">
                <b>Ã–nemli Notlar</b>
                <ul style="margin:8px 0 0 18px; padding:0;">
                  <li>API anahtarÄ± oluÅŸtururken â€œSpot Tradingâ€ iznini aktif edin</li>
                  <li>IP kÄ±sÄ±tlamasÄ± koymayÄ±n veya sunucu IPâ€™nizi ekleyin</li>
                  <li>API Secretâ€™i gÃ¼venli bir yerde kaydedin (bir daha gÃ¶sterilmez)</li>
                  <li>Withdrawal (para Ã§ekme) iznini vermeyin</li>
                </ul>
              </div>

              <div class="btnrow">
                <button class="btn primary" data-next="2">API AnahtarÄ±nÄ± AldÄ±m âœ</button>
              </div>
            </div>

            <div id="step2" class="stepview" style="display:none;">
              <div class="h2">AdÄ±m 2: API Entegrasyonu</div>

              <div class="cards">
                <div class="xcard" onclick="location.href='/exchange-api?ex=binance'">
                  <div class="xlogo" style="background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.25)">ğŸŸ </div>
                  <div><div class="xname">Binance</div><div class="xsub">API anahtarÄ± ekle</div></div>
                </div>
                <div class="xcard" onclick="location.href='/exchange-api?ex=okx'">
                  <div class="xlogo" style="background:rgba(59,130,246,.16);border-color:rgba(59,130,246,.28)">ğŸ”µ</div>
                  <div><div class="xname">OKX</div><div class="xsub">API anahtarÄ± ekle</div></div>
                </div>
                <div class="xcard" onclick="location.href='/exchange-api?ex=bybit'">
                  <div class="xlogo" style="background:rgba(168,85,247,.14);border-color:rgba(168,85,247,.25)">ğŸŸ£</div>
                  <div><div class="xname">Bybit</div><div class="xsub">API anahtarÄ± ekle</div></div>
                </div>
                <div class="xcard" onclick="location.href='/exchange-api?ex=gate'">
                  <div class="xlogo" style="background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.25)">ğŸŸ¢</div>
                  <div><div class="xname">Gate.io</div><div class="xsub">API anahtarÄ± ekle</div></div>
                </div>
                <div class="xcard" onclick="location.href='/exchange-api?ex=btcturk'">
                  <div class="xlogo" style="background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.25)">ğŸ”´</div>
                  <div><div class="xname">BTCTURK</div><div class="xsub">API anahtarÄ± ekle</div></div>
                </div>
              </div>

              <div class="modegrid">
                <div class="mode" style="border-color:rgba(245,158,11,.28); background: rgba(245,158,11,.08);">
                  <ul>
                    <li>Sanal para ile iÅŸlem yapar</li>
                    <li>GerÃ§ek para riski yoktur</li>
                    <li>AnÄ±nda aktif olur (onay gerekmez)</li>
                    <li>Strateji testi iÃ§in idealdir</li>
                  </ul>
                </div>
                <div class="mode" style="border-color:rgba(34,197,94,.22); background: rgba(34,197,94,.08);">
                  <div class="ttl">ğŸ’° REAL Modu</div>
                  <ul>
                    <li>GerÃ§ek para ile iÅŸlem yapar</li>
                    <li>GerÃ§ek API eriÅŸimi gerekir</li>
                    <li>KÃ¢r / zarar gerÃ§ektir</li>
                    <li>Deneyim kazandÄ±ktan sonra Ã¶nerilir</li>
                  </ul>
                </div>
              </div>

              <div class="note">
                <b>GÃ¼venlik</b><br>
                API anahtarlarÄ±nÄ±z AES-256 ÅŸifreleme ile korunur ve gÃ¼venli sunucularda saklanÄ±r. Withdrawal izni vermeyin.
              </div>

              <div class="btnrow">
                <button class="btn" data-prev="1">â¬… Geri</button>
                <button class="btn primary" data-next="3">API Ekledim, Devam Et âœ</button>
              </div>
            </div>

            <div id="step3" class="stepview" style="display:none;">
              <div class="h2">AdÄ±m 3: </div>
              <div class="p">

              <div style="padding:12px 14px; border-radius:14px; border:1px solid rgba(245,158,11,.22); background: rgba(245,158,11,.08); color:rgba(255,255,255,.78); font-size:12px; margin-bottom:12px;">
              </div>

              <div class="modegrid">
                <div class="mode">
                  <div class="ttl">ğŸ’³ Sanal Bakiye</div>
                  <div style="margin-top:8px; color:rgba(255,255,255,.70); font-size:12px;">10,000 USDT sanal bakiye ile baÅŸlayÄ±n. GerÃ§ek piyasa verilerini kullanarak iÅŸlem yapÄ±n.</div>
                </div>
                <div class="mode">
                  <div class="ttl">ğŸ“ˆ GerÃ§ek Piyasa Verileri</div>
                  <div style="margin-top:8px; color:rgba(255,255,255,.70); font-size:12px;">CanlÄ± piyasa fiyatlarÄ± ve gerÃ§ek zamanlÄ± verilerle test edin. GerÃ§ek deneyim yaÅŸayÄ±n.</div>
                </div>
                <div class="mode">
                  <div class="ttl">ğŸ“Š Performans Takibi</div>
                  <div style="margin-top:8px; color:rgba(255,255,255,.70); font-size:12px;">KÃ¢r / zarar, kazanma oranÄ± ve diÄŸer metrikleri izleyin. Stratejinizi optimize edin.</div>
                </div>
                <div class="mode">
                  <div class="ttl">ğŸ›¡ï¸ Risk YÃ¶netimi</div>
                  <div style="margin-top:8px; color:rgba(255,255,255,.70); font-size:12px;">Stop-loss, take-profit ve trailing stop Ã¶zelliklerini test edin. GÃ¼venli Ã¶ÄŸrenin.</div>
                </div>
              </div>

              <div class="note">
                <b>Test Kontrol Listesi</b>
                <ul style="margin:8px 0 0 18px; padding:0;">
                  <li>âœ… Manuel alÄ±m / satÄ±m iÅŸlemi yapÄ±n</li>
                  <li>âœ… Otomatik trading botunu aktif edin</li>
                  <li>âœ… Stop-loss ve take-profit ayarlarÄ±nÄ± test edin</li>
                  <li>âœ… FarklÄ± coinlerle test edin</li>
                  <li>âœ… Performans raporlarÄ±nÄ± inceleyin</li>
                  <li></li>
                </ul>
              </div>

              <div class="btnrow">
                <button class="btn" data-prev="2">â¬… Geri</button>
                <button class="btn primary" data-next="4">Sonraki AdÄ±ma GeÃ§ âœ</button>
              </div>
            </div>

            <div id="step4" class="stepview" style="display:none;">
              <div class="h2">AdÄ±m 4: GerÃ§ek Mod Aktivasyonu</div>
              <div class="p">

              <div class="note" style="border-color:rgba(59,130,246,.25); background: rgba(59,130,246,.10);">
                <b>REAL Mod API AnahtarÄ± Ekleyin</b><br>
                API YÃ¶netimi sayfasÄ±ndan REAL mod API anahtarÄ±nÄ± ekleyin
              </div>

              <div class="modegrid">
                <div class="mode">
                  <div class="ttl">âœ… REAL Mod Gereksinimleri</div>
                  <ul>
                    <li></li>
                    <li>Trading stratejilerinizi anlamak ve test etmek</li>
                    <li>Risk yÃ¶netimi araÃ§larÄ±nÄ± kullanabilmek</li>
                    <li>REAL mod API anahtarÄ±nÄ± eklemek</li>
                    <li>Admin onayÄ±nÄ± almak (1-2 iÅŸ gÃ¼nÃ¼)</li>
                  </ul>
                </div>
                <div class="mode" style="border-color:rgba(239,68,68,.25); background: rgba(239,68,68,.08);">
                  <div class="ttl">âš ï¸ Risk UyarÄ±sÄ±</div>
                  <ul>
                    <li>Kripto para ticareti yÃ¼ksek risk iÃ§erir</li>
                    <li>Kaybetmeyi gÃ¶ze alabileceÄŸiniz miktarla baÅŸlayÄ±n</li>
                    <li>Stop-loss mutlaka kullanÄ±n</li>
                    <li>GeÃ§miÅŸ performans geleceÄŸi garanti etmez</li>
                    <li>Piyasa volatilitesine hazÄ±rlÄ±klÄ± olun</li>
                  </ul>
                </div>
              </div>

              <div class="modegrid" style="margin-top:12px;">
                <div class="mode">
                  <ul><li>Sanal para</li><li>Risk yok</li><li>AnÄ±nda aktif</li><li>Ã–ÄŸrenme iÃ§in ideal</li></ul>
                </div>
                <div class="mode" style="border-color:rgba(34,197,94,.22); background: rgba(34,197,94,.08);">
                  <div class="ttl">ğŸ’° REAL Modu</div>
                  <ul><li>GerÃ§ek para</li><li>GerÃ§ek kÃ¢r</li><li>Admin onayÄ±</li><li>Deneyim sonrasÄ±</li></ul>
                </div>
              </div>

              <div class="btnrow">
                <button class="btn" data-prev="3">â¬… Geri</button>
                <button class="btn primary" onclick="location.href='/exchange-api'">REAL Mod API Ekle âœ</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="modalBg" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div class="ttl" id="modalTitle">Borsa API AnahtarÄ± Alma</div>
        <button class="close" id="modalClose">âœ–</button>
      </div>
      <div class="mb">
        <div class="grid2">
          <div class="video" id="modalVideo"></div>
          <div class="steps">
            <b>AdÄ±m AdÄ±m Talimatlar</b>
            <ol id="modalSteps"></ol>
            <div class="links">
              <a class="linkbtn primary" id="modalGo" href="#" target="_blank" rel="noopener">Borsa Sitesine Git</a>
              <a class="linkbtn" id="modalDocs" href="#" target="_blank" rel="noopener">API DokÃ¼mantasyonu</a>
            </div>
            <div style="margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(59,130,246,.25); background: rgba(59,130,246,.10); color:rgba(255,255,255,.70); font-size:12px;">
              <b>Ã–neri</b><br>API anahtarÄ±nÄ± oluÅŸturduktan sonra kopyalayÄ±p gÃ¼venli bir yerde saklayÄ±n.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const STEPS = {
  binance: {
    title:"Binance API AnahtarÄ± Alma",
    video:"https://www.youtube.com/embed/M4z_5nJ6Lf4",
    go:"https://www.binance.com/tr/my/settings/api-management",
    docs:"https://www.binance.com/en/support/faq/how-to-create-api-keys-on-binance-360002502072",
    steps:[
      "Binance hesabÄ±nÄ±za giriÅŸ yapÄ±n",
      "SaÄŸ Ã¼stteki profil ikonuna tÄ±klayÄ±n",
      "API Management (API YÃ¶netimi) seÃ§in",
      "Create API butonuna tÄ±klayÄ±n",
      "API anahtarÄ±na isim verin (Ã¶rn: AutoTrade)",
      "E-posta ve 2FA doÄŸrulamasÄ±nÄ± tamamlayÄ±n",
      "Spot Trading iznini AKTÄ°F edin",
      "Enable Withdrawals (Para Ã‡ekme) KAPALI bÄ±rakÄ±n",
      "API Key ve Secret'Ä± gÃ¼venli kaydedin"
    ]
  },
  okx: {
    title:"OKX API AnahtarÄ± Alma",
    video:"https://www.youtube.com/embed/9rtS35OJ8Xk",
    go:"https://www.okx.com/account/my-api",
    docs:"https://www.okx.com/docs-v5/en/#overview-api-key-creation",
    steps:[
      "OKX hesabÄ±nÄ±za giriÅŸ yapÄ±n",
      "Profil > API seÃ§eneÄŸine gidin",
      "Create V5 API Key butonuna tÄ±klayÄ±n",
      "API'ye isim ve Passphrase belirleyin",
      "Trade (Ä°ÅŸlem) iznini AKTÄ°F edin",
      "Withdraw (Para Ã‡ekme) iznini KAPALI bÄ±rakÄ±n",
      "Passphrase'i mutlaka kaydedin (tekrar gÃ¶sterilmez)",
      "API Key, Secret ve Passphrase'i gÃ¼venli saklayÄ±n"
    ]
  },
  bybit: {
    title:"Bybit API AnahtarÄ± Alma",
    video:"https://www.youtube.com/embed/EfKRN7xRwZA",
    go:"https://www.bybit.com/app/user/api-management",
    docs:"https://bybit-exchange.github.io/docs/v5/intro",
    steps:[
      "Bybit hesabÄ±nÄ±za giriÅŸ yapÄ±n",
      "Account & Security > API bÃ¶lÃ¼mÃ¼ne gidin",
      "Create New Key butonuna tÄ±klayÄ±n",
      "System-generated API Keys seÃ§in",
      "Unified Trading iznini AKTÄ°F edin",
      "Withdrawal iznini KAPALI bÄ±rakÄ±n",
      "API Key ve Secret'Ä± gÃ¼venli kaydedin"
    ]
  },
  gate: {
    title:"Gate.io API AnahtarÄ± Alma",
    video:"https://www.youtube.com/embed/OYOe_mI-Y20",
    go:"https://www.gate.io/myaccount/api_key_manage",
    docs:"https://www.gate.io/docs/developers/apiv4/en/",
    steps:[
      "Gate.io hesabÄ±nÄ±za giriÅŸ yapÄ±n",
      "My Profile > API Management seÃ§in",
      "Create API Key butonuna tÄ±klayÄ±n",
      "Spot Trade iznini AKTÄ°F edin",
      "Withdraw iznini KAPALI bÄ±rakÄ±n",
      "IP whitelist'e sunucu IP'nizi ekleyin",
      "API Key ve Secret'Ä± gÃ¼venli kaydedin"
    ]
  },
  btcturk: {
    title:"BTCTURK API AnahtarÄ± Alma",
    video:"https://www.youtube.com/embed/OYOe_mI-Y20",
    go:"https://www.btcturk.com/hesap/api",
    docs:"https://docs.btcturk.com/",
    steps:[
      "BTCTURK hesabÄ±nÄ±za giriÅŸ yapÄ±n",
      "Hesap > API YÃ¶netimi bÃ¶lÃ¼mÃ¼ne gidin",
      "Yeni API AnahtarÄ± OluÅŸtur butonuna tÄ±klayÄ±n",
      "API anahtarÄ±na isim verin",
      "Spot Trading iznini AKTÄ°F edin",
      "Para Ã‡ekme iznini KAPALI bÄ±rakÄ±n",
      "API Key ve Secret'Ä± gÃ¼venli kaydedin"
    ]
  }
};

const stepper = document.getElementById("stepper");
const progressBar = document.getElementById("progressBar");

function setStep(n){
  const steps = [...document.querySelectorAll(".step")];
  steps.forEach(s=>s.classList.toggle("active", Number(s.dataset.step)===n));
  document.querySelectorAll(".stepview").forEach(v=>v.style.display="none");
  document.getElementById("step"+n).style.display="block";
  progressBar.style.width = ((n-1)/3*100).toFixed(0)+"%";
  history.replaceState(null,"", "#adim-"+n);
}
stepper.addEventListener("click", (e)=>{
  const el = e.target.closest(".step");
  if(!el) return;
  setStep(Number(el.dataset.step));
});
document.querySelectorAll("[data-next]").forEach(b=>b.addEventListener("click", ()=> setStep(Number(b.dataset.next))));
document.querySelectorAll("[data-prev]").forEach(b=>b.addEventListener("click", ()=> setStep(Number(b.dataset.prev))));

function openModal(ex){
  const cfg = STEPS[ex];
  if(!cfg) return;
  document.getElementById("modalTitle").textContent = cfg.title;
  document.getElementById("modalVideo").innerHTML = `<iframe width="100%" height="100%" src="${cfg.video}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
  const ol = document.getElementById("modalSteps");
  ol.innerHTML = cfg.steps.map(s=>`<li>${s}</li>`).join("");
  document.getElementById("modalGo").href = cfg.go;
  document.getElementById("modalDocs").href = cfg.docs;
  document.getElementById("modalBg").style.display="flex";
}
document.querySelectorAll(".xcard[data-ex]").forEach(c=>c.addEventListener("click", ()=> openModal(c.dataset.ex)));
document.getElementById("modalClose").addEventListener("click", ()=> document.getElementById("modalBg").style.display="none");
document.getElementById("modalBg").addEventListener("click", (e)=>{ if(e.target.id==="modalBg") document.getElementById("modalBg").style.display="none"; });

(function initFromHash(){
  const h = location.hash || "";
  const m = h.match(/adim-(\d)/);
  if(m) setStep(Number(m[1])); else setStep(1);
})();

    // __AU_BALANCE_LOCK
    window.__AU_BALANCE_LOCK = false;
    
</script>
<script>
(function(){
  function fmt(n){
    try { return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    catch(e){ return String(n); }
  }

  async function fetchDemoBalance(){
    try{
      const r = await fetch("/api/real/balance", { credentials: "include" });
      const j = await r.json();
      const bal = Number(j.balance_usdt ?? j.balance ?? 0);
      if (!Number.isNaN(bal)) return bal;
    }catch(e){}
    return null;
  }

  function setBalanceUI(bal){
    try{
      const b = Number(bal);
      if (Number.isNaN(b)) return;

      const el = document.getElementById("balanceDisplay");
      if (el) el.textContent = fmt(b) + " USDT";

      const demoBtn = document.getElementById("demoBtnBalance");
      if (demoBtn) demoBtn.textContent = "$" + fmt(b) + " USDT";
    }catch(e){}
  }

  // Sayfa aÃ§Ä±lÄ±nca gerÃ§ek (cookie'li) balance'Ä± Ã§ek
  document.addEventListener("DOMContentLoaded", async () => {
    const bal = await fetchDemoBalance();
    if (bal !== null) setBalanceUI(bal);
  });

  // Global helper: trade sonrasÄ± UI'yi gÃ¼ncellemek iÃ§in
  window.__AU_SET_BALANCE_UI = async function(maybeNewBalance){
    // 1) response new_balance geldiyse Ã¶nce onu bas
    try{
      if (maybeNewBalance !== undefined && maybeNewBalance !== null){
        const nb = Number(maybeNewBalance);
        if (!Number.isNaN(nb)) setBalanceUI(nb);
      }
    }catch(e){}
    // 2) sonra kesin doÄŸrulama iÃ§in cookie'li refetch
    const bal = await fetchDemoBalance();
    if (bal !== null) setBalanceUI(bal);
  };
})();
</script>

</body>
</html>'''

# === UI TEMPLATE OVERRIDES (Arbitraj Takibi) ===
# Not: Bu blok, placeholder template'i ezer ve tasarÄ±mÄ± sabitler.

ARBITRAGE_MONITOR_TEMPLATE = r'''<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arbitraj Takibi | AU Auto Trade</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#121a2a;
      --panel2:#0f1726;
      --card:#0f1722;
      --border:rgba(255,255,255,.08);
      --muted:rgba(255,255,255,.62);
      --text:rgba(255,255,255,.92);
      --blue:#3b82f6;
      --green:#22c55e;
      --red:#ef4444;
      --amber:#f59e0b;
      --shadow: 0 10px 35px rgba(0,0,0,.45);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 40% 0%, rgba(59,130,246,.20), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(34,197,94,.12), transparent 55%),
                  linear-gradient(180deg, #060b16, #0b1220 45%, #070b14);
      color:var(--text);
    }
    /* Sidebar Custom CSS - Tailwind class override */
    #sidebar{position:fixed;left:0;top:0;height:100vh;width:256px;background:#1a1a1a;border-right:1px solid rgba(255,255,255,.1);z-index:100;display:flex;flex-direction:column;transform:translateX(0);}
    #sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;display:none;}
    #sidebar-toggle{position:fixed;top:16px;left:16px;z-index:101;width:40px;height:40px;border-radius:8px;background:#1a1a1a;border:1px solid rgba(255,255,255,.1);display:none;align-items:center;justify-content:center;color:#fff;cursor:pointer;}
    #sidebar .p-4{padding:16px;}
    #sidebar .p-3{padding:12px;}
    #sidebar .border-b{border-bottom:1px solid rgba(255,255,255,.1);}
    #sidebar .border-t{border-top:1px solid rgba(255,255,255,.1);}
    #sidebar .flex{display:flex;}
    #sidebar .flex-1{flex:1;}
    #sidebar .flex-col{flex-direction:column;}
    #sidebar .items-center{align-items:center;}
    #sidebar .justify-between{justify-content:space-between;}
    #sidebar .gap-3{gap:12px;}
    #sidebar .space-y-1>*+*{margin-top:4px;}
    #sidebar .overflow-y-auto{overflow-y:auto;}
    #sidebar .w-10{width:40px;}
    #sidebar .h-10{height:40px;}
    #sidebar .rounded-lg{border-radius:8px;}
    #sidebar .bg-blue-600{background:#2563eb;}
    #sidebar .text-white{color:#fff;}
    #sidebar .text-lg{font-size:18px;}
    #sidebar .text-sm{font-size:14px;}
    #sidebar .font-bold{font-weight:700;}
    #sidebar .font-medium{font-weight:500;}
    #sidebar .text-gray-400{color:#9ca3af;}
    #sidebar .text-gray-500{color:#6b7280;}
    #sidebar .text-green-500{color:#22c55e;}
    #sidebar .text-red-400{color:#f87171;}
    #sidebar .bg-\\[\\#161616\\]{background:#161616;}
    #sidebar .px-2{padding-left:8px;padding-right:8px;}
    #sidebar .px-3{padding-left:12px;padding-right:12px;}
    #sidebar .py-2{padding-top:8px;padding-bottom:8px;}
    #sidebar .mb-3{margin-bottom:12px;}
    #sidebar .mb-1\\.5{margin-bottom:6px;}
    #sidebar .uppercase{text-transform:uppercase;}
    #sidebar .tracking-wider{letter-spacing:.05em;}
    #sidebar .rounded-full{border-radius:9999px;}
    #sidebar .w-1\\.5{width:6px;}
    #sidebar .h-1\\.5{height:6px;}
    #sidebar a{text-decoration:none;color:inherit;}
    #sidebar nav a{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;font-size:14px;color:#9ca3af;transition:all .15s;}
    #sidebar nav a:hover{background:rgba(255,255,255,.05);color:#fff;}
    #sidebar nav a.active{background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.3);}
    @media(max-width:1024px){
      #sidebar{transform:translateX(-100%);}
      #sidebar.open{transform:translateX(0);}
      #sidebar-toggle{display:flex;}
      #sidebar-overlay.show{display:block;}
      .content{margin-left:0;}
    }
    .app{display:flex; min-height:100vh;}
    .content{flex:1; padding:22px 22px 28px; margin-left: 256px;}
    .toprow{display:flex; align-items:center; justify-content:space-between; margin:2px 0 14px;}
    .title h1{margin:0; font-size:26px; letter-spacing:.2px}
    .title p{margin:6px 0 0; color:var(--muted); font-size:13px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius:999px; color:var(--text); font-weight:600; font-size:12px;
    }
    .pill .dot{width:8px; height:8px; border-radius:50%; background:var(--green); box-shadow:0 0 0 4px rgba(34,197,94,.14);}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background: rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      font-weight:700; font-size:12px;
    }
    .btn.primary{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.35);}
    .grid{display:grid; grid-template-columns: 1.2fr .9fr; gap:16px;}
    .card{
      background: rgba(18,26,42,.72);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .card .hd h2{margin:0; font-size:15px;}
    .card .bd{padding:16px 18px;}
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; white-space:nowrap;}
    th{color:rgba(255,255,255,.70); font-weight:700; font-size:11px; letter-spacing:.35px;}
    td.sym{font-weight:800}
    .pos{color:var(--green); font-weight:800}
    .neg{color:var(--red); font-weight:800}
    .spr{color:var(--amber); font-weight:900}
    .mini{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;
      margin-bottom:14px;
    }
    .mini .k{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.20);
      border-radius:14px;
      padding:12px 12px;
    }
    .mini .k .lbl{color:rgba(255,255,255,.62); font-size:11px}
    .mini .k .val{margin-top:6px; font-weight:900; font-size:18px}
    .mini .k .sub{margin-top:4px; color:rgba(255,255,255,.55); font-size:11px}
    .chartbox{height:300px;}
    .tabs{display:flex; gap:8px;}
    .tab{
      padding:8px 10px; border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      color:rgba(255,255,255,.82); font-weight:800; font-size:11px;
      cursor:pointer;
    }
    .tab.active{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.35); color:#fff;}
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px;}
    .statgrid{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;}
    .stat{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.20);
      border-radius:14px;
      padding:12px 12px;
    }
    .stat .lbl{color:rgba(255,255,255,.62); font-size:11px}
    .stat .val{margin-top:8px; font-weight:900; font-size:18px}
    .stat .val.ok{color:var(--green)}
    .stat .val.mid{color:var(--amber)}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr;} .content{padding:16px; margin-left: 0;} .statgrid{grid-template-columns: repeat(2,1fr);} }
  </style>
</head>
<body>
  <div class="app">
    {{ sidebar|safe }}

    <div class="content">
      <div class="toprow">
        <div class="title">
          <h1>Arbitraj Takibi</h1>
          <p>Borsalar arasÄ± fiyat farklarÄ± ve fÄ±rsatlar</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="pill"><span class="dot"></span> CanlÄ± Veri</div>
          <button class="btn primary" id="btnSettings">âš™ï¸ Ayarlar</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Fiyat KarÅŸÄ±laÅŸtÄ±rma</h2>
            <div style="color:rgba(255,255,255,.65); font-size:12px;">En dÃ¼ÅŸÃ¼k fiyat (Al) â€¢ En yÃ¼ksek fiyat (Sat)</div>
          </div>
          <div class="bd">
            <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.06);">
              <table id="priceTable">
                <thead>
                  <tr>
                    <th>Ä°ÅŸlem Ã‡ifti</th>
                    <th>OKX</th>
                    <th>Binance</th>
                    <th>Bybit</th>
                    <th>Gate.io</th>
                    <th>BTCTURK</th>
                    <th>Spread</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div style="display:flex; gap:14px; align-items:center; margin-top:10px; color:rgba(255,255,255,.62); font-size:11px;">
              <span style="display:flex; gap:8px; align-items:center;"><span style="width:10px;height:10px;border-radius:3px;background:rgba(34,197,94,.9)"></span> En DÃ¼ÅŸÃ¼k Fiyat (Al)</span>
              <span style="display:flex; gap:8px; align-items:center;"><span style="width:10px;height:10px;border-radius:3px;background:rgba(239,68,68,.9)"></span> En YÃ¼ksek Fiyat (Sat)</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Spread GrafiÄŸi</h2>
            <div class="tabs">
              <button class="tab active" data-range="1h">1 Saat</button>
              <button class="tab" data-range="6h">6 Saat</button>
              <button class="tab" data-range="24h">24 Saat</button>
            </div>
          </div>
          <div class="bd">
            <div class="mini">
              <div class="k">
                <div class="lbl">Mevcut Spread</div>
                <div class="val" id="curSpread">0.00%</div>
                <div class="sub" id="curPair">BTC/USDT</div>
              </div>
              <div class="k">
                <div class="lbl">Ortalama Spread</div>
                <div class="val" id="avgSpread">0.00%</div>
                <div class="sub">Son 1h</div>
              </div>
              <div class="k">
                <div class="lbl">Maksimum Spread</div>
                <div class="val" id="maxSpread">0.00%</div>
                <div class="sub">En yÃ¼ksek fÄ±rsat</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; background:rgba(0,0,0,.18); border-color:rgba(255,255,255,.06);">
              <div class="hd" style="border-bottom-color:rgba(255,255,255,.06);">
                <h2>Spread GeÃ§miÅŸi</h2>
              </div>
              <div class="bd">
                <div class="chartbox"><canvas id="spreadChart"></canvas></div>
              </div>
            </div>

            <div class="card" style="margin-top:14px; box-shadow:none; background:rgba(0,0,0,.18); border-color:rgba(255,255,255,.06);">
              <div class="hd" style="border-bottom-color:rgba(255,255,255,.06);"><h2>Trend Analizi</h2></div>
              <div class="bd" style="display:grid; grid-template-columns: 1fr auto; gap:10px; font-size:12px; color:rgba(255,255,255,.70);">
                <div>Spread Trendi</div><div style="font-weight:900; color:var(--green)" id="trend">YÃ¼kseliÅŸ</div>
                <div>Volatilite</div><div style="font-weight:900; color:var(--amber)" id="vol">Orta</div>
                <div>Optimal Ä°ÅŸlem ZamanÄ±</div><div style="font-weight:900; color:var(--blue)">Åimdi</div>
                <div>Tahmini SÃ¼re</div><div style="font-weight:900;">15-30 dakika</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row2">
        <div class="card">
          <div class="hd"><h2>Risk FaktÃ¶rleri</h2></div>
          <div class="bd" style="color:rgba(255,255,255,.72); font-size:12px; line-height:1.55;">
            <div style="margin-bottom:10px;"><b style="color:#fff;">ğŸ“‰ Slippage Etkisi</b><br/>Ä°ÅŸlem sÄ±rasÄ±nda fiyat kaymasÄ± nedeniyle oluÅŸabilecek kayÄ±p. YÃ¼ksek hacimli iÅŸlemlerde daha fazla etki eder.</div>
            <div style="margin-bottom:10px;"><b style="color:#fff;">ğŸŒªï¸ Piyasa Volatilitesi</b><br/>Fiyat dalgalanmalarÄ± arbitraj fÄ±rsatÄ±nÄ±n kaybolmasÄ±na neden olabilir. DÃ¼ÅŸÃ¼k volatilite tercih edilir.</div>
            <div style="margin-bottom:10px;"><b style="color:#fff;">â±ï¸ Ä°ÅŸlem HÄ±zÄ±</b><br/>Transfer ve onay sÃ¼releri uzadÄ±kÃ§a fÄ±rsatÄ± kaÃ§Ä±rma riski artar. HÄ±zlÄ± blockchainler avantajlÄ±dÄ±r.</div>
            <div><b style="color:#fff;">ğŸ’¸ Ä°ÅŸlem Ãœcretleri</b><br/>Trading ve transfer Ã¼cretleri net kÃ¢rÄ± azaltÄ±r. YÃ¼ksek spreadâ€™li fÄ±rsatlar tercih edilmelidir.</div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><h2>Transfer SÃ¼releri (Dakika)</h2></div>
          <div class="bd">
            <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.06);">
              <table>
                <thead>
                  <tr>
                    <th>Coin</th><th>Onay SayÄ±sÄ±</th><th>OKX</th><th>Binance</th><th>Bybit</th><th>Gate.io</th><th>BTCTURK</th>
                  </tr>
                </thead>
                <tbody id="transferTable"></tbody>
              </table>
            </div>

            <div style="display:flex; gap:18px; justify-content:center; margin-top:12px; font-size:11px; color:rgba(255,255,255,.65);">
              <span style="display:flex; gap:8px; align-items:center;"><span style="width:10px;height:10px;border-radius:50%;background:rgba(34,197,94,.95)"></span> Ã‡ok HÄ±zlÄ±</span>
              <span style="display:flex; gap:8px; align-items:center;"><span style="width:10px;height:10px;border-radius:50%;background:rgba(59,130,246,.95)"></span> HÄ±zlÄ±</span>
              <span style="display:flex; gap:8px; align-items:center;"><span style="width:10px;height:10px;border-radius:50%;background:rgba(245,158,11,.95)"></span> Orta</span>
              <span style="display:flex; gap:8px; align-items:center;"><span style="width:10px;height:10px;border-radius:50%;background:rgba(239,68,68,.95)"></span> YavaÅŸ</span>
            </div>

            <div style="margin-top:12px; padding:12px 14px; border-radius:14px; border:1px solid rgba(59,130,246,.25); background: rgba(59,130,246,.10); color:rgba(255,255,255,.72); font-size:12px;">
              <b style="color:#fff;">â„¹ï¸ Ã–nemli Notlar</b>
              <ul style="margin:8px 0 0 18px; padding:0;">
                <li>Transfer sÃ¼releri aÄŸ yoÄŸunluÄŸuna gÃ¶re deÄŸiÅŸiklik gÃ¶sterebilir.</li>
                <li>BazÄ± borsalar yÃ¼ksek hacimli transferlerde ek doÄŸrulama isteyebilir.</li>
                <li>HÄ±zlÄ± transferler iÃ§in dÃ¼ÅŸÃ¼k onay sayÄ±sÄ± gerektiren coinleri tercih edin.</li>
                <li>Arbitraj iÅŸlemlerinde transfer sÃ¼resi kritik Ã¶nem taÅŸÄ±r.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="settingsCard" style="margin-top:16px; display:none;">
        <div class="hd"><h2>Bildirim KanallarÄ±</h2><button class="btn" id="closeSettings">âœ– Kapat</button></div>
        <div class="bd">
          <div style="display:grid; gap:10px;">
            <label style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.07); background: rgba(0,0,0,.20);">
              <div>
                <div style="font-weight:900;">ğŸ“§ E-posta Bildirimleri</div>
                <div style="color:rgba(255,255,255,.62); font-size:12px;">FÄ±rsatlar e-posta ile gÃ¶nderilsin</div>
              </div>
              <input type="checkbox" id="notifyEmail" checked />
            </label>

            <label style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.07); background: rgba(0,0,0,.20);">
              <div>
                <div style="font-weight:900;">ğŸ“± Push Bildirimleri</div>
                <div style="color:rgba(255,255,255,.62); font-size:12px;">Mobil cihaza anlÄ±k bildirim</div>
              </div>
              <input type="checkbox" id="notifyPush" />
            </label>

            <label style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.07); background: rgba(0,0,0,.20);">
              <div>
                <div style="font-weight:900;">ğŸ’¬ Telegram Bildirimleri</div>
                <div style="color:rgba(255,255,255,.62); font-size:12px;">Telegram Ã¼zerinden bildirim</div>
              </div>
              <input type="checkbox" id="notifyTelegram" />
            </label>
          </div>

          <div style="margin-top:14px;">
            <div style="font-weight:900; margin-bottom:8px;">UyarÄ± EÅŸikleri</div>
            <div style="display:grid; gap:10px;">
              <div>
                <div style="color:rgba(255,255,255,.65); font-size:12px;">Minimum Spread (%)</div>
                <input id="minSpread" type="number" value="1" step="0.1" style="width:100%; margin-top:6px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.22); color:#fff;">
              </div>
              <div>
                <div style="color:rgba(255,255,255,.65); font-size:12px;">Minimum KÃ¢r MiktarÄ± ($)</div>
                <input id="minProfit" type="number" value="50" step="1" style="width:100%; margin-top:6px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.22); color:#fff;">
              </div>
              <div>
                <div style="color:rgba(255,255,255,.65); font-size:12px;">Bildirim SÄ±klÄ±ÄŸÄ±</div>
                <select id="notifyFreq" style="width:100%; margin-top:6px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.22); color:#fff;">
                  <option>AnÄ±nda</option>
                  <option>5 dk</option>
                  <option>15 dk</option>
                  <option>1 saat</option>
                </select>
              </div>
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:12px;">
              <button class="btn primary" id="saveSettings">ğŸ’¾ AyarlarÄ± Kaydet</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
const PAIRS = ["BTC/USDT","ETH/USDT","XRP/USDT","ADA/USDT","SOL/USDT","DOGE/USDT","MATIC/USDT","DOT/USDT","AVAX/USDT","LINK/USDT"];
const EXS = ["OKX","Binance","Bybit","Gate.io","BTCTURK"];

function rnd(min,max){ return Math.random()*(max-min)+min; }
function fmt(n){ return Number(n).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2}); }

function buildPriceRow(pair){
  const base = rnd(100, 50000) * (pair.startsWith("BTC")? 1 : pair.startsWith("ETH")? 0.4 : pair.startsWith("SOL")? 0.08 : 0.02);
  const prices = EXS.map(()=> base*(1+rnd(-0.012,0.012)));
  const min = Math.min(...prices), max = Math.max(...prices);
  const spread = ((max-min)/min)*100;
  return {pair, prices, min, max, spread};
}

function renderTable(rows){
  const tb = document.querySelector("#priceTable tbody");
  tb.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    const td0 = document.createElement("td");
    td0.className="sym";
    td0.textContent = r.pair;
    tr.appendChild(td0);

    r.prices.forEach((p)=>{
      const td=document.createElement("td");
      const cls = (p===r.min) ? "pos" : (p===r.max) ? "neg" : "";
      td.innerHTML = `<span class="${cls}">$${fmt(p)}</span>`;
      tr.appendChild(td);
    });

    const tdS=document.createElement("td");
    tdS.className="spr";
    tdS.textContent = `${r.spread.toFixed(2)}%`;
    tr.appendChild(tdS);

    tb.appendChild(tr);
  });
}

const ctx = document.getElementById("spreadChart");
let chart;

function makeChart(){
  const labels = Array.from({length:13}, (_,i)=> {
    const m = String(5 + i*5).padStart(2,"0");
    return `05:${m}`;
  });
  const now = Array.from({length:13}, ()=> rnd(0.2, 2.6));
  const avg = now.map((v,i)=> (now.slice(0,i+1).reduce((a,b)=>a+b,0)/(i+1)));
  const mx  = now.map((v,i)=> Math.max(...now.slice(0,i+1)));

  const cur = now[now.length-1];
  document.getElementById("curSpread").textContent = `${cur.toFixed(2)}%`;
  document.getElementById("avgSpread").textContent = `${avg[avg.length-1].toFixed(2)}%`;
  document.getElementById("maxSpread").textContent = `${Math.max(...mx).toFixed(2)}%`;

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"AnlÄ±k Spread", data: now, tension:.35},
        {label:"Ortalama", data: avg, tension:.35},
        {label:"Maksimum", data: mx, tension:.35}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{labels:{color:"rgba(255,255,255,.75)", boxWidth:10}}},
      scales:{
        x:{ticks:{color:"rgba(255,255,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"}},
        y:{ticks:{color:"rgba(255,255,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"}, title:{display:true, text:"Spread (%)", color:"rgba(255,255,255,.55)"}}
      }
    }
  });
}

function renderTransfers(){
  const tb = document.getElementById("transferTable");
  const coins = ["BTC","ETH","XRP","ADA","SOL","DOGE","MATIC","DOT","AVAX","LINK"];
  tb.innerHTML = "";
  coins.forEach((c)=>{
    const tr=document.createElement("tr");
    const onay = c==="BTC"? 3 : c==="ETH"? 12 : c==="MATIC"? 128 : (c==="ADA"?15:1);
    const times = EXS.map(()=> rnd(2, 40));
    const cells = [
      `<td class="sym">${c}<div style="color:rgba(255,255,255,.55); font-size:10px; margin-top:2px;">${c}/USDT</div></td>`,
      `<td>${onay}</td>`,
      ...times.map(t=>{
        const cls = t<5 ? "pos" : t<15 ? "" : t<25 ? "spr" : "neg";
        const txt = `${Math.round(t)} dk`;
        return `<td><span class="${cls}">â—</span> <span style="color:rgba(255,255,255,.82)">${txt}</span><div style="color:rgba(255,255,255,.45); font-size:10px; margin-top:2px;">${Math.max(1,Math.round(t-3))}-${Math.round(t+3)} dk</div></td>`;
      })
    ];
    tr.innerHTML = cells.join("");
    tb.appendChild(tr);
  });
}

function tick(){
  const rows = PAIRS.map(buildPriceRow);
  renderTable(rows);
  makeChart();
  renderTransfers();
}
tick();
// __AU_FETCH_INTERCEPT_V1
(function(){
  try{
    if (window.__AU_FETCH_INTERCEPT_V1) return;
    window.__AU_FETCH_INTERCEPT_V1 = true;

    const _fetch = window.fetch;
    window.fetch = async function(input, init){
      const url = (typeof input === "string") ? input : ((input && input.url) ? input.url : "");
      const method = (init && init.method) ? String(init.method).toUpperCase() : "GET";
      const isTradeExec = (url.indexOf("/api/trade/execute") !== -1) && method === "POST";
      const isSellPos   = (url.indexOf("/api/positions/sell") !== -1) && method === "POST";

      const res = await _fetch(input, init);

      try{
        if (isTradeExec || isSellPos){
          const c = res.clone();
          const data = await c.json();

          if (data && data.ok && typeof data.new_balance !== "undefined" && data.new_balance !== null){
            // 12sn boyunca poll/refresh eski deÄŸeri basamasÄ±n
            window.__AU_BALANCE_LOCK_UNTIL = Date.now() + 12000;

            const b = Number(data.new_balance);
            if (!Number.isNaN(b)){
              const fmt = (n)=>{ try{return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});}catch(e){return String(n);} };
              const el = document.getElementById("balanceDisplay");
              if (el) el.textContent = fmt(b) + " USDT";
              const demoBtn = document.getElementById("demoBtnBalance");
              if (demoBtn) demoBtn.textContent = "$" + fmt(b) + " USDT";
            }
          }
        }
      }catch(e){}

      return res;
    };
  }catch(e){}
})();

setInterval(tick, 10000);

document.getElementById("btnSettings").addEventListener("click", ()=> {
  document.getElementById("settingsCard").style.display = "block";
});
document.getElementById("closeSettings").addEventListener("click", ()=> {
  document.getElementById("settingsCard").style.display = "none";
});
document.getElementById("saveSettings").addEventListener("click", async ()=> {
  const payload = {
    notify_email: document.getElementById("notifyEmail").checked,
    notify_push: document.getElementById("notifyPush").checked,
    notify_telegram: document.getElementById("notifyTelegram").checked,
    min_spread: Number(document.getElementById("minSpread").value||0),
    min_profit: Number(document.getElementById("minProfit").value||0),
    freq: document.getElementById("notifyFreq").value
  };
  try{
    await fetch("/api/arbitrage/settings", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
  }catch(e){}
  document.getElementById("settingsCard").style.display="none";
});
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    // demo only; chart rebuild
    makeChart();
  });
});
</script>
</body>
</html>'''



# ============================================
# PACKAGE LIMITS SYSTEM
# ============================================
PACKAGE_LIMITS = {
    "basic": {"max_coins": 2, "monthly_trades": 100, "name": "Temel", "price_tl": 7500},
    "premium": {"max_coins": 3, "monthly_trades": 500, "name": "Premium", "price_tl": 12500},
    "elite": {"max_coins": 5, "monthly_trades": -1, "name": "Elit", "price_tl": 20000}  # -1 = unlimited
}

def get_user_package(user_id):
    """Get user's package info"""
    try:
        conn = db()
        row = conn.execute("SELECT package FROM users WHERE id=?", (user_id,)).fetchone()
        conn.close()
        if row:
            pkg = dict(row).get("package", "basic") if hasattr(row, 'keys') else (row[0] if row else "basic")
            return str(pkg).lower() if pkg else "basic"
    except:
        pass
    return "basic"

def check_package_limits(user_id, action_type="trade"):
    """Check if user can perform action based on package limits"""
    pkg = get_user_package(user_id)
    limits = PACKAGE_LIMITS.get(pkg, PACKAGE_LIMITS["basic"])
    
    if action_type == "add_coin":
        try:
            conn = db()
            count = conn.execute("SELECT COUNT(*) FROM auto_trades WHERE user_id=? AND deleted=0", (user_id,)).fetchone()[0]
            conn.close()
            if count >= limits["max_coins"]:
                return False, f"{limits['name']} paketinde maksimum {limits['max_coins']} coin ekleyebilirsiniz."
        except:
            pass
    
    if action_type == "trade" and limits["monthly_trades"] != -1:
        try:
            conn = db()
            month_start = int(time.time()) - (30 * 24 * 60 * 60)
            count = conn.execute("SELECT COUNT(*) FROM trades WHERE user_id=? AND created_at>?", (user_id, month_start)).fetchone()[0]
            conn.close()
            if count >= limits["monthly_trades"]:
                return False, f"{limits['name']} paketinde aylÄ±k maksimum {limits['monthly_trades']} iÅŸlem yapabilirsiniz."
        except:
            pass
    
    return True, "OK"



def require_login(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        # API Ã§aÄŸrÄ±larÄ±nda redirect HTML dÃ¶nmek yerine JSON 401 dÃ¶nmeliyiz (frontend JSON bekliyor)
        if not session.get("logged_in"):
            try:
                from flask import request, jsonify
                if request.path.startswith("/api/"):
                    return jsonify({"ok": False, "error": "LOGIN_REQUIRED"}), 401
            except Exception:
                pass
            return redirect("/api/app/login")
        return f(*args, **kwargs)
    return decorated_function
def get_current_user_profile():
    """Return dict with current user's id, role, plan and usage counters."""
    uid = session.get("user_id")
    if not uid:
        return None
    try:
        conn = get_db()
        c = conn.cursor()
        c.execute("SELECT id, username, email, role, subscription_plan, usage_count, usage_limit FROM users WHERE id=?", (uid,))
        row = c.fetchone()
        if not row:
            return None
        return {
            "id": row[0],
            "username": row[1],
            "email": row[2],
            "role": row[3],
            "subscription_plan": row[4] or "Temel",
            "usage_count": int(row[5] or 0),
            "usage_limit": int(row[6] or 0),
        }
    except Exception:
        return {"id": uid, "role": session.get("role"), "subscription_plan": session.get("subscription_plan")}

def _send_bytes(data: bytes, filename: str, mime: str = "application/octet-stream"):
    if data is None:
        data = b""
    r = Response(data, mimetype=mime)
    r.headers["Content-Disposition"] = f'attachment; filename="{filename}"'
    r.headers["Cache-Control"] = "no-store"
    return r


from io import BytesIO

def _contract_pdf_bytes(row: dict) -> bytes:
    """
    Profesyonel PDF Ã¼retimi (TR font destekli).
    """
    from io import BytesIO
    from datetime import datetime, timezone, timedelta

    # ReportLab (platypus) ile profesyonel layout
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.units import mm
    from reportlab.lib import colors

    # TR font: DejaVuSans (Ubuntu'da genelde var)
    from reportlab.pdfbase import pdfmetrics
    from reportlab.pdfbase.ttfonts import TTFont

    # ---- data ----
    username  = safe_str(row.get("username") or "")
    full_name = safe_str(row.get("full_name") or "")
    idno      = safe_str(row.get("id_no") or row.get("tc") or "")
    ip        = safe_str(row.get("ip") or "")
    ts        = int(row.get("accepted_at") or 0)
    dt_str    = ""
    if ts:
        try:
            dt_str = datetime.fromtimestamp(ts, tz=timezone.utc).astimezone(
                timezone(timedelta(hours=3))
            ).strftime("%Y-%m-%d %H:%M:%S")
        except Exception:
            dt_str = ""

    body_txt = row.get("contract_text") or row.get("body") or ""
    body_txt = body_txt.replace("\r", "")

    # ---- font register ----
    # Not: Bu path Ubuntu'da genelde mevcut. Yoksa fallback yapar.
    font_name = "DejaVuSans"
    try:
        pdfmetrics.registerFont(TTFont(font_name, "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"))
    except Exception:
        # fallback (en azÄ±ndan patlamasÄ±n)
        font_name = "Helvetica"

    # ---- pdf build ----
    buf = BytesIO()
    doc = SimpleDocTemplate(
        buf,
        pagesize=A4,
        leftMargin=18*mm,
        rightMargin=18*mm,
        topMargin=16*mm,
        bottomMargin=16*mm,
        title="Atalay Ulusoy Auto Trade - SÃ¶zleÅŸme"
    )

    styles = getSampleStyleSheet()
    base = ParagraphStyle(
        "base",
        parent=styles["Normal"],
        fontName=font_name,
        fontSize=10.5,
        leading=14,
        textColor=colors.black,
    )
    h1 = ParagraphStyle(
        "h1",
        parent=base,
        fontSize=18,
        leading=22,
        spaceAfter=10,
    )
    small = ParagraphStyle(
        "small",
        parent=base,
        fontSize=10,
        leading=13,
        textColor=colors.HexColor("#222222"),
    )
    section = ParagraphStyle(
        "section",
        parent=base,
        fontSize=12.5,
        leading=16,
        spaceBefore=10,
        spaceAfter=6,
    )

    def esc(s: str) -> str:
        # reportlab Paragraph xml escape
        return (s or "").replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")

    story = []

    # Header kÃ¼Ã§Ã¼k yazÄ±
    story.append(Paragraph("Atalay Ulusoy Auto Trade", small))
    story.append(Spacer(1, 2*mm))

    # BÃ¼yÃ¼k baÅŸlÄ±k
    story.append(Paragraph("Atalay Ulusoy Auto Trade â€” KullanÄ±m ve Risk SÃ¶zleÅŸmesi", h1))

    # Alt Ã§izgi (tablo ile Ã§izgi gibi)
    story.append(Table([[""]], colWidths=[170*mm], rowHeights=[0.6*mm],
                      style=[("BACKGROUND", (0,0),(0,0), colors.HexColor("#E5E7EB")),
                             ("LINEBELOW", (0,0),(0,0), 0, colors.white)]))
    story.append(Spacer(1, 6*mm))

    # Bilgi tablosu
    data = [
        ["KullanÄ±cÄ± AdÄ±", username],
        ["Ad Soyad", full_name],
        ["Kimlik No", idno],
        ["Tarih", dt_str],
        ["IP", ip],
    ]
    t = Table(data, colWidths=[42*mm, 120*mm])
    t.setStyle(TableStyle([
        ("FONTNAME", (0,0), (-1,-1), font_name),
        ("FONTSIZE", (0,0), (-1,-1), 10.5),
        ("BACKGROUND", (0,0), (-1,-1), colors.HexColor("#F3F4F6")),
        ("TEXTCOLOR", (0,0), (-1,-1), colors.HexColor("#111827")),
        ("ALIGN", (0,0), (0,-1), "LEFT"),
        ("VALIGN", (0,0), (-1,-1), "MIDDLE"),
        ("INNERGRID", (0,0), (-1,-1), 0.6, colors.HexColor("#D1D5DB")),
        ("BOX", (0,0), (-1,-1), 0.6, colors.HexColor("#D1D5DB")),
        ("LEFTPADDING", (0,0), (-1,-1), 10),
        ("RIGHTPADDING", (0,0), (-1,-1), 10),
        ("TOPPADDING", (0,0), (-1,-1), 7),
        ("BOTTOMPADDING", (0,0), (-1,-1), 7),
    ]))
    story.append(t)
    story.append(Spacer(1, 8*mm))

    # GÃ¶vde metin: satÄ±r satÄ±r Paragraph (TR destekli)
    # BaÅŸlÄ±k gibi gÃ¶rÃ¼nen satÄ±rlar iÃ§in basit yakalama
    for raw in body_txt.split("\n"):
        line = raw.rstrip()
        if not line.strip():
            story.append(Spacer(1, 3*mm))
            continue

        # BÃ¶lÃ¼m baÅŸlÄ±klarÄ± A. / B. / C. gibi
        if len(line) >= 2 and line[1] == "." and line[0].isalpha():
            story.append(Spacer(1, 2*mm))
            story.append(Paragraph(esc(line), section))
            continue

        story.append(Paragraph(esc(line), base))

    def on_page(c, d):
        # Header sol Ã¼st + sayfa saÄŸ Ã¼st
        c.saveState()
        c.setFont(font_name if font_name != "Helvetica" else "Helvetica", 9)
        c.setFillColor(colors.HexColor("#111827"))
        c.drawString(18*mm, 286*mm, "Atalay Ulusoy Auto Trade")
        c.drawRightString(210*mm - 18*mm, 286*mm, f"Sayfa {c.getPageNumber()}")
        c.restoreState()

    doc.build(story, onFirstPage=on_page, onLaterPages=on_page)
    return buf.getvalue()


import requests
import time
import urllib.request
import urllib.parse
import base64
import hmac
import urllib.parse
import urllib.request
import os
import json
import time
import sqlite3
import secrets
import hashlib
import threading
import shutil
import ipaddress
from datetime import datetime, timedelta, timezone
from typing import Dict, Any, Optional, List

COMMODITY_ALIASES = {
    "XAG": "XAG/USDT",         # GÃ¼mÃ¼ÅŸ token (varsa)
    "SILVER": "XAG/USDT",

    "XPD": "XPD/USDT",         # Paladyum token (varsa)
    "PALLADIUM": "XPD/USDT",

    "COPPER": "COPPER/USDT",   # BakÄ±r token (varsa)
    "HG": "COPPER/USDT",
}

# =========================
# UI / FRONTEND (Single File Mode)
# =========================

GLOBAL_CSS = """
/* Derived from src/styles/index.css */
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500&display=swap');
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

:root {
    --color-primary: #0066cc;
    --color-primary-foreground: #ffffff;
    --color-secondary: #4a9eff;
    --color-secondary-foreground: #000000;
    --color-accent: #00d4ff;
    --color-accent-foreground: #000000;
    --color-background: #0f0f0f;
    --color-foreground: #e8e8e8;
    --color-card: #1a1a1a;
    --color-card-foreground: #e8e8e8;
    --color-muted: #252525;
    --color-muted-foreground: #a0a0a0;
    --color-border: rgba(255, 255, 255, 0.1);
    --color-input: #1a1a1a;
    --color-success: #00c851;
    --color-warning: #ff8f00;
    --color-error: #ff4444;
}

body {
    font-family: 'Outfit', sans-serif;
    background-color: var(--color-background);
    color: var(--color-foreground);
    -webkit-font-smoothing: antialiased;
}

/* Custom Utilities mimicking original @apply */
.btn-touch {
    min-height: 44px;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.btn-touch:active { transform: scale(0.98); }

.btn-primary {
    background-color: var(--color-primary);
    color: var(--color-primary-foreground);
    border: none;
}
.btn-primary:hover { opacity: 0.9; }

.btn-secondary {
    background-color: var(--color-secondary);
    color: var(--color-secondary-foreground);
    border: none;
}

.card-mobile {
    background-color: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.input-field {
    width: 100%;
    background-color: var(--color-input);
    border: 1px solid var(--color-border);
    color: var(--color-foreground);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.2s;
}
.input-field:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
}
"""

BASE_TEMPLATE = r"""
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ title }} | Atalay Ulusoy Auto Trade</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0066cc',
                        background: '#0f0f0f',
                        card: '#1a1a1a',
                        border: 'rgba(255, 255, 255, 0.1)',
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        {{ global_css | safe }}
        
        /* Smooth scrolling for anchor links */
        html { scroll-behavior: smooth; }
        
        /* Sticky footer adjustments */
        body { min-height: 100vh; display: flex; flex-direction: column; }
        main { flex: 1; }
    </style>
    {% block head %}{% endblock %}
</head>
<body class="bg-background text-white font-sans overflow-x-hidden">
    
    <div class="flex flex-col min-h-screen w-full">
        {% if sidebar %}
            {{ sidebar | safe }}
        {% endif %}

        <div class="grow min-w-0 px-8 {% if sidebar %}lg:ml-64{% endif %}">
            {% block content %}{% endblock %}
        </div>
        
        {{ footer | safe }}
    </div>

    <script>
        console.log('Auto Trade Frontend Loaded');
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
"""

FOOTER_HTML = r"""
<footer class="bg-[#0a0a0a] border-t border-white/5 py-8 mt-auto z-40 lg:ml-64 relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
            <div class="col-span-1 md:col-span-2">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center font-bold text-white text-sm">â‚¿</div>
                    <span class="text-white font-bold tracking-tight">Atalay Ulusoy Auto Trade</span>
                </div>
                <p class="text-gray-500 text-sm max-w-md leading-relaxed">
                    GeliÅŸmiÅŸ yapay zeka ve algoritmik ticaret sistemleri ile kripto para piyasalarÄ±nda profesyonel portfÃ¶y yÃ¶netimi. 7/24 kesintisiz, gÃ¼venli ve ÅŸeffaf iÅŸlem altyapÄ±sÄ±.
                </p>
            </div>
            <div>
                <h4 class="text-white font-semibold mb-4 text-sm uppercase tracking-wider">Kurumsal</h4>
                <ul class="space-y-2">
                    <li><a href="#" onclick="openInfoPopup('about'); return false;" class="text-gray-500 hover:text-blue-500 transition-colors text-sm cursor-pointer">HakkÄ±mÄ±zda</a></li>
                    <li><a href="#" onclick="openInfoPopup('faq'); return false;" class="text-gray-400 hover:text-blue-500 transition-colors text-sm cursor-pointer">SÄ±kÃ§a Sorulan Sorular</a></li>
                    <li><a href="/api/app/terms-of-use" class="text-gray-400 hover:text-blue-500 transition-colors text-sm">KullanÄ±m KoÅŸullarÄ±</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-white font-semibold mb-4 text-sm uppercase tracking-wider">Destek</h4>
                <ul class="space-y-2">
                    <li><a href="#" onclick="openInfoPopup('support'); return false;" class="text-gray-400 hover:text-blue-500 transition-colors text-sm cursor-pointer">Destek Merkezi</a></li>
                    <li><a href="#" onclick="openInfoPopup('contact'); return false;" class="text-gray-400 hover:text-blue-500 transition-colors text-sm cursor-pointer">Ä°letiÅŸim</a></li>
                    <li><a href="/api/app/privacy-policy" class="text-gray-400 hover:text-blue-500 transition-colors text-sm">Gizlilik PolitikasÄ±</a></li>
                </ul>
            </div>
        </div>
        <div class="pt-8 border-t border-white/5 flex flex-col md:flex-row justify-between items-center gap-4">
            <p class="text-gray-600 text-xs text-center md:text-left">
                &copy; 2026 Atalay Ulusoy. TÃ¼m haklarÄ± saklÄ±dÄ±r. Kripto varlÄ±k yatÄ±rÄ±mlarÄ± risk iÃ§erir.
            </p>
            <div class="flex gap-6">
                <a href="#" class="text-gray-600 hover:text-white transition-colors"><span class="sr-only">Twitter</span>ğ•</a>
                <a href="#" class="text-gray-600 hover:text-white transition-colors"><span class="sr-only">Telegram</span>ğŸ“±</a>
                <a href="#" class="text-gray-600 hover:text-white transition-colors"><span class="sr-only">Email</span>âœ‰ï¸</a>
            </div>
        </div>
    </div>
</footer>

<!-- Info Popup Modal -->
<div id="infoPopupModal" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
    <div class="bg-[#1a1a1a] rounded-2xl border border-white/10 w-full max-w-2xl max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 id="infoPopupTitle" class="text-lg font-semibold text-white">Bilgi</h3>
            <button onclick="closeInfoPopup()" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div id="infoPopupContent" class="p-6 overflow-y-auto max-h-[60vh]">
            <div class="text-center py-8 text-gray-400">YÃ¼kleniyor...</div>
        </div>
    </div>
</div>

<script>
async function openInfoPopup(page) {
    const modal = document.getElementById('infoPopupModal');
    const content = document.getElementById('infoPopupContent');
    const title = document.getElementById('infoPopupTitle');
    
    const titles = {
        'about': 'HakkÄ±mÄ±zda',
        'faq': 'SÄ±k Sorulan Sorular',
        'support': 'Destek Merkezi',
        'contact': 'Ä°letiÅŸim'
    };
    
    title.textContent = titles[page] || 'Bilgi';
    content.innerHTML = '<div class="text-center py-8 text-gray-400">YÃ¼kleniyor...</div>';
    modal.classList.remove('hidden');
    
    try {
        const res = await fetch('/api/popup/content/' + page, {credentials: 'include'});
        const data = await res.json();
        if (data.ok) {
            content.innerHTML = data.html;
        } else {
            content.innerHTML = '<div class="text-center py-8 text-red-400">Ä°Ã§erik yÃ¼klenemedi.</div>';
        }
    } catch(e) {
        content.innerHTML = '<div class="text-center py-8 text-red-400">BaÄŸlantÄ± hatasÄ±.</div>';
    }
}

function closeInfoPopup() {
    document.getElementById('infoPopupModal').classList.add('hidden');
}

// Close on backdrop click
document.getElementById('infoPopupModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeInfoPopup();
});

// Close on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeInfoPopup();
});
</script>
"""




# SIDEBAR_HTML REMOVED - Using get_sidebar_html() function instead to fix raw tag rendering issues.


REGISTER_TEMPLATE = r"""
{% extends "base" %}
{% block content %}
<div class="fixed inset-0 w-full h-full z-0">
    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1639762681485-074b7f938ba0?q=80&w=2832&auto=format&fit=crop')] bg-cover bg-center opacity-20"></div>
    <div class="absolute inset-0 bg-gradient-to-br from-black/90 via-[#0a0a0a]/95 to-black/90 backdrop-blur-sm"></div>
</div>

<div class="relative z-10 w-full min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8">
    <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-start">
        <!-- Left Side: Hero Content -->
        <!-- Fixed Sticky Position and Content -->
        <div class="hidden lg:block space-y-8 sticky top-24">
            <div class="space-y-4">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-sm font-medium">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                    </span>
                    Yapay Zeka Destekli
                </div>
                <h1 class="text-5xl font-bold text-white leading-tight">
                    GeleceÄŸin Ticaret <br/>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">Otomasyonu</span>
                </h1>
                <p class="text-gray-400 text-lg leading-relaxed max-w-md">
                    Atalay Ulusoy Trading Bot ile portfÃ¶yÃ¼nÃ¼zÃ¼ 7/24 yÃ¶netin. Duygusal kararlarÄ± ortadan kaldÄ±rÄ±n, profesyonel stratejilerle kazancÄ±nÄ±zÄ± optimize edin.
                </p>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="p-4 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-md">
                    <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center mb-3">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                    <h3 class="text-white font-semibold mb-1">HÄ±zlÄ± Ä°ÅŸlem</h3>
                    <p class="text-sm text-gray-500">Milisaniyeler iÃ§inde emir iletimi</p>
                </div>
                <div class="p-4 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-md">
                    <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center mb-3">
                        <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    </div>
                    <h3 class="text-white font-semibold mb-1">Tam GÃ¼venlik</h3>
                    <p class="text-sm text-gray-500">AES-256 ÅŸifreli API saklama</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 pt-4">
                <div class="flex -space-x-3">
                    <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face" alt="KullanÄ±cÄ±" class="w-10 h-10 rounded-full border-2 border-black object-cover">
                    <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face" alt="KullanÄ±cÄ±" class="w-10 h-10 rounded-full border-2 border-black object-cover">
                    <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=100&h=100&fit=crop&crop=face" alt="KullanÄ±cÄ±" class="w-10 h-10 rounded-full border-2 border-black object-cover">
                </div>
                <div class="text-sm text-gray-400">
                    <strong class="text-white">1000+</strong> Aktif YatÄ±rÄ±mcÄ±
                </div>
            </div>
        </div>

        <!-- Right Side: Register Form -->
        <div class="w-full max-w-lg mx-auto">
            <div class="bg-card/80 backdrop-blur-xl border border-white/10 rounded-3xl p-6 sm:p-8 shadow-2xl">
                <div class="mb-6 text-center">
                    <div class="inline-flex justify-center mb-4">
                        <div class="p-3 rounded-2xl bg-blue-600/20 text-blue-400">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-1">Hesap OluÅŸtur</h2>
                    <p class="text-gray-400 text-sm">Ãœcretsiz deneme ile baÅŸlayÄ±n</p>
                </div>

                {% if error or success %}
                <div class="mb-6 p-4 rounded-xl {{ 'bg-red-500/10 border-red-500/20 text-red-200' if error else 'bg-green-500/10 border-green-500/20 text-green-200' }} border flex items-center gap-3">
                    <span class="text-sm">{{ error or success }}</span>
                </div>
                {% endif %}

                <form method="POST" action="/register" class="space-y-4">
                    <div class="space-y-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-400 ml-1">E-posta Adresi <span class="text-red-500">*</span></label>
                            <input type="email" name="email" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl px-4 py-3 text-white placeholder-gray-600 transition-all" placeholder="ornek@email.com" required>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-gray-400 ml-1">Åifre <span class="text-red-500">*</span></label>
                                <input type="password" name="password" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl px-4 py-3 text-white placeholder-gray-600 transition-all" placeholder="En az 8 karakter" required minlength="8">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-gray-400 ml-1">Åifre OnayÄ± <span class="text-red-500">*</span></label>
                                <input type="password" name="confirm_password" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl px-4 py-3 text-white placeholder-gray-600 transition-all" placeholder="Tekrar girin" required minlength="8">
                            </div>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-400 ml-1">Ad Soyad <span class="text-red-500">*</span></label>
                            <input type="text" name="full_name" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl px-4 py-3 text-white placeholder-gray-600 transition-all" placeholder="AdÄ±nÄ±z ve soyadÄ±nÄ±z" required>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-400 ml-1">Telefon NumarasÄ± <span class="text-red-500">*</span></label>
                            <input type="tel" name="phone" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl px-4 py-3 text-white placeholder-gray-600 transition-all" placeholder="+90" required>
                            <p class="text-[10px] text-gray-500 ml-1">+90 ile baÅŸlayan 10 haneli telefon numaranÄ±zÄ± girin</p>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-400 ml-1">Ä°ÅŸlem Deneyimi <span class="text-red-500">*</span></label>
                            <select name="experience" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl px-4 py-3 text-white text-sm transition-all appearance-none cursor-pointer">
                                <option value="" disabled selected>Deneyim seviyenizi seÃ§in</option>
                                <option value="beginner">BaÅŸlangÄ±Ã§ (0-1 YÄ±l)</option>
                                <option value="intermediate">Orta (1-3 YÄ±l)</option>
                                <option value="advanced">Ä°leri (3+ YÄ±l)</option>
                                <option value="professional">Profesyonel</option>
                            </select>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-400 ml-1">Tercih Edilen Borsalar <span class="text-red-500">*</span></label>
                            <select name="exchanges" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl px-4 py-3 text-white text-sm transition-all appearance-none cursor-pointer">
                                <option value="" disabled selected>Bir seÃ§enek seÃ§in</option>
                                <option value="binance">Binance</option>
                                <option value="binance_tr">Binance TR</option>
                                <option value="okx">OKX</option>
                                <option value="bybit">Bybit</option>
                                <option value="meksa">Meksa</option>
                                <option value="info">Ä°nfo YatÄ±rÄ±m</option>
                            </select>
                            <p class="text-[10px] text-gray-500 ml-1">KullanmayÄ± planladÄ±ÄŸÄ±nÄ±z kripto para borsalarÄ±nÄ± seÃ§in</p>
                        </div>
                    </div>

                    <div class="space-y-3 pt-2">
                        <label class="flex items-start gap-2 cursor-pointer group">
                            <input type="checkbox" required class="mt-1 w-4 h-4 rounded border-gray-600 bg-[#1A1A1A] text-blue-600 focus:ring-blue-500/20">
                            <span class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors">
                                <a href="#" onclick="openTermsPopup('terms'); return false;" class="text-blue-500 hover:text-blue-400">KullanÄ±m KoÅŸullarÄ±</a>'nÄ± okudum ve kabul ediyorum
                            </span>
                        </label>
                        
                        <label class="flex items-start gap-2 cursor-pointer group">
                            <input type="checkbox" required class="mt-1 w-4 h-4 rounded border-gray-600 bg-[#1A1A1A] text-blue-600 focus:ring-blue-500/20">
                            <span class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors">
                                <a href="#" onclick="openTermsPopup('privacy'); return false;" class="text-blue-500 hover:text-blue-400">Gizlilik PolitikasÄ±</a>'nÄ± okudum ve kabul ediyorum
                            </span>
                        </label>

                        <label class="flex items-start gap-2 cursor-pointer group">
                            <input type="checkbox" required class="mt-1 w-4 h-4 rounded border-gray-600 bg-[#1A1A1A] text-blue-600 focus:ring-blue-500/20">
                            <span class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors">
                                Kripto para iÅŸlemlerinin risklerini anladÄ±ÄŸÄ±mÄ± ve sorumluluÄŸun bana ait olduÄŸunu kabul ediyorum
                            </span>
                        </label>

                        <label class="flex items-start gap-2 cursor-pointer group">
                            <input type="checkbox" required class="mt-1 w-4 h-4 rounded border-gray-600 bg-[#1A1A1A] text-blue-600 focus:ring-blue-500/20">
                            <span class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors">
                                <strong class="text-gray-300">YatÄ±rÄ±m SÃ¶zleÅŸmesi:</strong> Bu platform yatÄ±rÄ±m tavsiyesi vermemektedir. TÃ¼m iÅŸlemler kullanÄ±cÄ±nÄ±n kendi sorumluluÄŸundadÄ±r. Kripto para yatÄ±rÄ±mlarÄ± yÃ¼ksek risk iÃ§erir ve sermaye kaybÄ±na yol aÃ§abilir. GeÃ§miÅŸ performans gelecekteki sonuÃ§larÄ±n garantisi deÄŸildir.
                            </span>
                        </label>
                    </div>

                    <div class="pt-2">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-blue-500/25 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                            Hesap OluÅŸtur
                        </button>
                    </div>

                    <div class="text-center pt-2">
                        <p class="text-sm text-gray-400">
                            Zaten hesabÄ±nÄ±z var mÄ±? 
                            <a href="/login" class="text-blue-500 font-medium hover:text-blue-400 transition-colors">GiriÅŸ YapÄ±n</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Terms/Privacy Popup Modal -->
<div id="termsPopupModal" class="hidden fixed inset-0 bg-black/90 z-[200] flex items-center justify-center p-4">
    <div class="bg-[#1a1a1a] rounded-2xl border border-white/10 w-full max-w-3xl max-h-[85vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b border-white/10 sticky top-0 bg-[#1a1a1a]">
            <h3 id="termsPopupTitle" class="text-lg font-semibold text-white">Bilgi</h3>
            <button onclick="closeTermsPopup()" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div id="termsPopupContent" class="p-6 overflow-y-auto max-h-[70vh] text-gray-300 text-sm leading-relaxed">
            <div class="text-center py-8 text-gray-400">YÃ¼kleniyor...</div>
        </div>
    </div>
</div>

<script>
function openTermsPopup(type) {
    const modal = document.getElementById('termsPopupModal');
    const content = document.getElementById('termsPopupContent');
    const title = document.getElementById('termsPopupTitle');
    
    content.innerHTML = '<div class="text-center py-8 text-gray-400">YÃ¼kleniyor...</div>';
    modal.classList.remove('hidden');
    
    if (type === 'terms') {
        title.textContent = 'KullanÄ±m KoÅŸullarÄ±';
        content.innerHTML = `
            <h2 class="text-xl font-bold text-white mb-4">ATALAY ULUSOY AUTO TRADE - KULLANIM KOÅULLARI</h2>
            <p class="text-gray-500 text-xs mb-6">Son gÃ¼ncelleme: Ocak 2026</p>
            
            <div class="space-y-6">
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">1. TARAFLAR</h3>
                    <p>Bu sÃ¶zleÅŸme, Atalay Ulusoy Auto Trade platformu ("Platform", "Biz", "Hizmet SaÄŸlayÄ±cÄ±") ile platformu kullanan gerÃ§ek veya tÃ¼zel kiÅŸi ("KullanÄ±cÄ±", "Siz") arasÄ±nda akdedilmiÅŸtir.</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">2. HÄ°ZMET TANIMI</h3>
                    <p>Platform, kripto para alÄ±m-satÄ±m iÅŸlemleri iÃ§in otomatik iÅŸlem sistemi, sinyal hizmeti ve analiz araÃ§larÄ± sunmaktadÄ±r:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li>TradingView entegrasyonu ile otomatik alÄ±m sinyalleri</li>
                        <li>AI destekli satÄ±ÅŸ karar motoru</li>
                        <li>Ã‡oklu borsa desteÄŸi (Binance, OKX, Bybit, Gate.io)</li>
                        <li>Demo ve Real mod iÅŸlem seÃ§enekleri</li>
                        <li>Portfolio analizi ve raporlama</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">3. KULLANICI YÃœKÃœMLÃœLÃœKLERÄ°</h3>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>18 yaÅŸÄ±ndan bÃ¼yÃ¼k olmak</li>
                        <li>DoÄŸru ve gÃ¼ncel bilgi saÄŸlamak</li>
                        <li>Hesap gÃ¼venliÄŸini saÄŸlamak (gÃ¼Ã§lÃ¼ ÅŸifre, 2FA)</li>
                        <li>API anahtarlarÄ±nÄ± gÃ¼venli tutmak</li>
                        <li>Platformu yasal amaÃ§larla kullanmak</li>
                        <li>Kara para aklama faaliyetlerinde bulunmamak</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">4. RÄ°SK BÄ°LDÄ°RÄ°MÄ°</h3>
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                        <p class="text-red-400 font-semibold mb-2">âš ï¸ Ã–NEMLÄ° UYARI</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li>Kripto para yatÄ±rÄ±mlarÄ± yÃ¼ksek risk iÃ§erir</li>
                            <li>YatÄ±rdÄ±ÄŸÄ±nÄ±z sermayenin tamamÄ±nÄ± kaybedebilirsiniz</li>
                            <li>GeÃ§miÅŸ performans gelecekteki sonuÃ§larÄ±n garantisi deÄŸildir</li>
                            <li>Platform yatÄ±rÄ±m tavsiyesi vermemektedir</li>
                            <li>TÃ¼m iÅŸlem kararlarÄ± kullanÄ±cÄ±nÄ±n sorumluluÄŸundadÄ±r</li>
                        </ul>
                    </div>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">5. API VE BORSA BAÄLANTISI</h3>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>KullanÄ±cÄ± kendi borsa API anahtarlarÄ±nÄ± saÄŸlar</li>
                        <li>Platform sadece iÅŸlem emirleri gÃ¶nderir, para transferi yapmaz</li>
                        <li>API anahtarlarÄ± ÅŸifrelenmiÅŸ olarak saklanÄ±r</li>
                        <li>Borsalardaki fonlar kullanÄ±cÄ±nÄ±n sorumluluÄŸundadÄ±r</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">6. ÃœCRETLENDÄ°RME</h3>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>Demo mod Ã¼cretsizdir</li>
                        <li>Real mod iÃ§in aylÄ±k abonelik gereklidir</li>
                        <li>Paket fiyatlarÄ± web sitesinde belirtilmiÅŸtir</li>
                        <li>Ã–denen Ã¼cretler iade edilmez</li>
                        <li>Borsa iÅŸlem komisyonlarÄ± kullanÄ±cÄ±ya aittir</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">7. SORUMLULUK SINIRLAMASI</h3>
                    <p>Platform, aÅŸaÄŸÄ±daki durumlardan sorumlu deÄŸildir:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li>Piyasa dalgalanmalarÄ±ndan kaynaklanan zararlar</li>
                        <li>Borsa kesintileri veya arÄ±zalarÄ±</li>
                        <li>Internet baÄŸlantÄ± sorunlarÄ±</li>
                        <li>API gecikmeleri veya hatalarÄ±</li>
                        <li>ÃœÃ§Ã¼ncÃ¼ taraf hizmet kesintileri</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">8. FÄ°KRÄ° MÃœLKÄ°YET</h3>
                    <p>Platform Ã¼zerindeki tÃ¼m iÃ§erik, yazÄ±lÄ±m, algoritmalar ve tasarÄ±mlar Atalay Ulusoy'a aittir ve telif hakkÄ± ile korunmaktadÄ±r.</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">9. HESAP ASKIYA ALMA VE FESÄ°H</h3>
                    <p>Platform, kullanÄ±m koÅŸullarÄ±nÄ± ihlal eden hesaplarÄ± askÄ±ya alma veya kapatma hakkÄ±nÄ± saklÄ± tutar.</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">10. UYGULANACAK HUKUK</h3>
                    <p>Bu sÃ¶zleÅŸme TÃ¼rkiye Cumhuriyeti kanunlarÄ±na tabidir. UyuÅŸmazlÄ±klarda Ä°stanbul Mahkemeleri ve Ä°cra Daireleri yetkilidir.</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">11. Ä°LETÄ°ÅÄ°M</h3>
                    <p>SorularÄ±nÄ±z iÃ§in: <a href="mailto:atalayulusoyy@gmail.com" class="text-blue-400">atalayulusoyy@gmail.com</a></p>
                </section>
            </div>
        `;
    } else if (type === 'privacy') {
        title.textContent = 'Gizlilik PolitikasÄ±';
        content.innerHTML = `
            <h2 class="text-xl font-bold text-white mb-4">ATALAY ULUSOY AUTO TRADE - GÄ°ZLÄ°LÄ°K POLÄ°TÄ°KASI</h2>
            <p class="text-gray-500 text-xs mb-6">Son gÃ¼ncelleme: Ocak 2026</p>
            
            <div class="space-y-6">
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">1. GÄ°RÄ°Å</h3>
                    <p>Atalay Ulusoy Auto Trade olarak kullanÄ±cÄ±larÄ±mÄ±zÄ±n gizliliÄŸine bÃ¼yÃ¼k Ã¶nem veriyoruz. Bu politika, kiÅŸisel verilerinizin nasÄ±l toplandÄ±ÄŸÄ±nÄ±, kullanÄ±ldÄ±ÄŸÄ±nÄ± ve korunduÄŸunu aÃ§Ä±klar.</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">2. TOPLANAN VERÄ°LER</h3>
                    <h4 class="font-medium text-gray-200 mt-3 mb-2">2.1 Hesap Bilgileri</h4>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>KullanÄ±cÄ± adÄ± ve e-posta adresi</li>
                        <li>Åifre (hash'lenmiÅŸ olarak)</li>
                        <li>Telegram kullanÄ±cÄ± ID (opsiyonel)</li>
                        <li>Tercih edilen iletiÅŸim yÃ¶ntemi</li>
                    </ul>
                    
                    <h4 class="font-medium text-gray-200 mt-3 mb-2">2.2 Ä°ÅŸlem Verileri</h4>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>Auto trade ayarlarÄ± ve geÃ§miÅŸi</li>
                        <li>Portfolio bilgileri</li>
                        <li>P&L raporlarÄ±</li>
                        <li>Borsa API anahtarlarÄ± (ÅŸifrelenmiÅŸ)</li>
                    </ul>
                    
                    <h4 class="font-medium text-gray-200 mt-3 mb-2">2.3 Teknik Veriler</h4>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>IP adresi ve konum bilgisi</li>
                        <li>Cihaz ve tarayÄ±cÄ± bilgileri</li>
                        <li>Oturum ve Ã§erez verileri</li>
                        <li>KullanÄ±m istatistikleri</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">3. VERÄ° KULLANIM AMAÃ‡LARI</h3>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>Hizmet sunumu ve iyileÅŸtirme</li>
                        <li>Hesap gÃ¼venliÄŸi ve doÄŸrulama</li>
                        <li>MÃ¼ÅŸteri desteÄŸi saÄŸlama</li>
                        <li>Bildirim ve iletiÅŸim</li>
                        <li>Analiz ve raporlama</li>
                        <li>Yasal yÃ¼kÃ¼mlÃ¼lÃ¼klerin yerine getirilmesi</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">4. VERÄ° GÃœVENLÄ°ÄÄ°</h3>
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                        <ul class="list-disc list-inside space-y-2">
                            <li>256-bit SSL ÅŸifreleme</li>
                            <li>API anahtarlarÄ± iÃ§in AES ÅŸifreleme</li>
                            <li>Åifreler iÃ§in gÃ¼venli hash algoritmalarÄ±</li>
                            <li>DÃ¼zenli gÃ¼venlik gÃ¼ncellemeleri</li>
                            <li>Ä°ki faktÃ¶rlÃ¼ kimlik doÄŸrulama (2FA)</li>
                            <li>GÃ¼venli sunucu altyapÄ±sÄ±</li>
                        </ul>
                    </div>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">5. VERÄ° PAYLAÅIMI</h3>
                    <p>KiÅŸisel verileriniz aÅŸaÄŸÄ±daki durumlar dÄ±ÅŸÄ±nda Ã¼Ã§Ã¼ncÃ¼ taraflarla paylaÅŸÄ±lmaz:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li>Yasal zorunluluklar (mahkeme kararÄ± vb.)</li>
                        <li>Hizmet saÄŸlayÄ±cÄ±lar (Ã¶deme iÅŸlemcileri)</li>
                        <li>KullanÄ±cÄ±nÄ±n aÃ§Ä±k rÄ±zasÄ±</li>
                    </ul>
                    <p class="mt-2 text-yellow-400">âš ï¸ Verileriniz hiÃ§bir ÅŸekilde satÄ±lmaz veya pazarlama amaÃ§lÄ± kullanÄ±lmaz.</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">6. Ã‡EREZ POLÄ°TÄ°KASI</h3>
                    <p>Platformumuz oturum yÃ¶netimi ve kullanÄ±cÄ± deneyimi iÃ§in Ã§erezler kullanÄ±r:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li>Zorunlu Ã§erezler: Oturum yÃ¶netimi</li>
                        <li>Ä°ÅŸlevsel Ã§erezler: Tercihler</li>
                        <li>Analitik Ã§erezler: KullanÄ±m istatistikleri</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">7. KULLANICI HAKLARI</h3>
                    <p>KVKK kapsamÄ±nda aÅŸaÄŸÄ±daki haklara sahipsiniz:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li>Verilerinize eriÅŸim hakkÄ±</li>
                        <li>DÃ¼zeltme ve gÃ¼ncelleme hakkÄ±</li>
                        <li>Silme talep hakkÄ±</li>
                        <li>Ä°ÅŸleme itiraz hakkÄ±</li>
                        <li>Veri taÅŸÄ±nabilirliÄŸi hakkÄ±</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">8. VERÄ° SAKLAMA SÃœRESÄ°</h3>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>Hesap verileri: Hesap aktif olduÄŸu sÃ¼rece</li>
                        <li>Ä°ÅŸlem kayÄ±tlarÄ±: 10 yÄ±l (yasal zorunluluk)</li>
                        <li>Log verileri: 1 yÄ±l</li>
                        <li>Ã‡erezler: Oturum sÃ¼resi veya maksimum 1 yÄ±l</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">9. Ã‡OCUKLARIN GÄ°ZLÄ°LÄ°ÄÄ°</h3>
                    <p>Platformumuz 18 yaÅŸ altÄ±ndaki kiÅŸilere hizmet vermemektedir. ReÅŸit olmayan kullanÄ±cÄ±larÄ±n bilgilerini bilerek toplamÄ±yoruz.</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">10. POLÄ°TÄ°KA GÃœNCELLEMELERÄ°</h3>
                    <p>Bu gizlilik politikasÄ± zaman zaman gÃ¼ncellenebilir. Ã–nemli deÄŸiÅŸikliklerde kullanÄ±cÄ±larÄ±mÄ±zÄ± bilgilendiririz.</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold text-white mb-2">11. Ä°LETÄ°ÅÄ°M</h3>
                    <p>Gizlilik ile ilgili sorularÄ±nÄ±z iÃ§in:</p>
                    <p class="mt-2">ğŸ“§ <a href="mailto:atalayulusoyy@gmail.com" class="text-blue-400">atalayulusoyy@gmail.com</a></p>
                    <p>ğŸ“± Telegram: <a href="https://t.me/atalayulusoy" class="text-blue-400">@atalayulusoy</a></p>
                </section>
            </div>
        `;
    }
}

function closeTermsPopup() {
    document.getElementById('termsPopupModal').classList.add('hidden');
}

document.getElementById('termsPopupModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeTermsPopup();
});
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeTermsPopup(); });
</script>
{% endblock %}

"""

FORGOT_PASSWORD_TEMPLATE = r"""
{% extends "base" %}

{% block content %}
<div class="w-full min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4">
    <div class="w-full max-w-lg mx-auto">
        <div class="card-mobile">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <div class="p-4 rounded-xl bg-blue-500/10">
                        <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">Åifremi Unuttum</h1>
                <p class="text-gray-400">HesabÄ±nÄ±za eriÅŸimi geri kazanÄ±n</p>
            </div>

            <!-- Form -->
            <form method="POST" action="/forgot-password" class="space-y-6">
                {% if error %}
                <div class="p-4 rounded-lg bg-red-500/10 border border-red-500/20 flex items-center gap-3">
                    <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span class="text-sm text-red-200">{{ error }}</span>
                </div>
                {% endif %}
                
                {% if success %}
                <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20 flex items-center gap-3">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    <span class="text-sm text-green-200">Åifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± <strong>{{ email }}</strong> adresine gÃ¶nderildi.</span>
                </div>
                {% endif %}

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">GiriÅŸ E-postanÄ±z</label>
                    <input type="email" name="email" class="input-field" placeholder="ornek@email.com" required>
                    <p class="mt-2 text-xs text-gray-500">KayÄ±tlÄ± e-posta adresinize sÄ±fÄ±rlama talimatlarÄ± gÃ¶nderilecektir.</p>
                </div>

                <button type="submit" class="btn-touch btn-primary w-full text-lg shadow-lg shadow-blue-900/30">
                    SÄ±fÄ±rlama Linki GÃ¶nder
                </button>
            </form>

            <!-- Footer -->
            <div class="mt-8 pt-6 border-t border-gray-700 text-center">
                <p class="text-sm text-gray-400">
                    Åifrenizi hatÄ±rladÄ±nÄ±z mÄ±? 
                    <a href="/login" class="text-blue-400 hover:text-blue-300 font-medium transition-colors">GiriÅŸ Yap</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
"""

LOGIN_TEMPLATE = r"""
{% extends "base" %}
{% block content %}
<div class="fixed inset-0 w-full h-full z-0">
    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1642543492481-44e81e3914a7?q=80&w=2832&auto=format&fit=crop')] bg-cover bg-center opacity-20"></div>
    <div class="absolute inset-0 bg-gradient-to-br from-black/90 via-[#0a0a0a]/95 to-black/90 backdrop-blur-sm"></div>
</div>

<div class="relative z-10 w-full min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8">
    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-center">
        <!-- Left Side: Hero Content (Hidden on Mobile) -->
        <div class="hidden lg:block space-y-8">
            <div class="space-y-4">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-sm font-medium">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                    </span>
                    GÃ¼venli GiriÅŸ
                </div>
                <h1 class="text-5xl font-bold text-white leading-tight">
                    PortfÃ¶yÃ¼nÃ¼ze <br/>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">EriÅŸin</span>
                </h1>
                <p class="text-gray-400 text-lg leading-relaxed max-w-md">
                    AI destekli algoritmalarÄ±mÄ±z piyasayÄ± analiz ederken siz arkanÄ±za yaslanÄ±n. 7/24 kesintisiz otomasyon.
                </p>
            </div>
            
             <div class="flex items-center gap-4 pt-4">
                <div class="flex -space-x-3">
                    <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face" alt="KullanÄ±cÄ±" class="w-10 h-10 rounded-full border-2 border-black object-cover">
                    <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face" alt="KullanÄ±cÄ±" class="w-10 h-10 rounded-full border-2 border-black object-cover">
                    <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=100&h=100&fit=crop&crop=face" alt="KullanÄ±cÄ±" class="w-10 h-10 rounded-full border-2 border-black object-cover">
                </div>
                <div class="text-sm text-gray-400">
                    <strong class="text-white">GÃ¼venli</strong> SSL Åifreleme
                </div>
            </div>
        </div>

        <!-- Right Side: Login Form -->
        <div class="w-full max-w-md mx-auto">
            <div class="bg-card/80 backdrop-blur-xl border border-white/10 rounded-3xl p-6 sm:p-8 shadow-2xl">
                <div class="mb-8 text-center">
                    <div class="inline-flex justify-center mb-4">
                        <div class="p-3 rounded-2xl bg-blue-600/20 text-blue-400">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">HoÅŸgeldiniz</h2>
                    <p class="text-gray-400 text-sm">HesabÄ±nÄ±za giriÅŸ yapÄ±n ve kazanmaya devam edin</p>
                </div>

                {% if error %}
                <div class="mb-6 p-4 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center gap-3 animate-pulse">
                    <svg class="w-5 h-5 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span class="text-sm text-red-200">{{ error }}</span>
                </div>
                {% endif %}

                <form method="POST" action="/api/app/login" class="space-y-5">
                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-gray-400 ml-1">KullanÄ±cÄ± AdÄ±</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                            </span>
                            <input type="text" name="username" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl pl-10 pr-4 py-3.5 text-white placeholder-gray-600 transition-all" placeholder="KullanÄ±cÄ± adÄ±nÄ±z" required>
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-gray-400 ml-1">Åifre</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                            </span>
                            <input type="password" name="password" class="input-field w-full bg-[#1A1A1A] border-white/10 focus:border-blue-500/50 rounded-xl pl-10 pr-4 py-3.5 text-white placeholder-gray-600 transition-all" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-1">
                        <label class="flex items-center gap-2 cursor-pointer group">
                             <input type="checkbox" class="w-4 h-4 rounded border-gray-600 bg-[#1A1A1A] text-blue-600 focus:ring-blue-500/20">
                             <span class="text-xs text-gray-400 group-hover:text-gray-300">Beni hatÄ±rla</span>
                        </label>
                        <a href="/api/app/forgot-password" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">Åifremi unuttum?</a>
                    </div>

                    <div class="pt-2">
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-blue-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2">
                            <span>GiriÅŸ Yap</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                        </button>
                    </div>

                    <div class="text-center pt-4 border-t border-white/5 mt-4">
                        <p class="text-sm text-gray-400">
                            HesabÄ±nÄ±z yok mu? 
                            <a href="/api/app/register" class="text-blue-500 font-medium hover:text-blue-400 transition-colors">Hemen KayÄ±t Olun</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
"""

DASHBOARD_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    {{ sidebar | safe }}

    <!-- Main Content -->
    <div class="max-w-[1920px] mx-auto min-h-screen pt-16 lg:pt-8 p-4 sm:p-6 lg:p-8">
            <!-- Header with Account Mode -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold text-white mb-2">Trading Dashboard</h1>
                        <p class="text-sm text-gray-400">Otomatik ve manuel iÅŸlem yÃ¶netimi</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- Account Mode Toggle -->
                        <div class="flex items-center gap-2 bg-[#0f0f0f] rounded-lg p-1">
                        <div class="flex items-center gap-2 px-4 py-2 rounded-lg bg-[#0f0f0f] border border-white/10">
                            <span class="text-lg">ğŸ’°</span>
                            <span class="text-sm font-mono text-white">373.00 USDT</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exchange Status Bar -->
            <div class="flex flex-wrap items-center gap-4 mb-6 text-sm">
                <span class="text-gray-400">â­ Borsa BaÄŸlantÄ±larÄ±</span>
                <span class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[#1a1a1a] border border-white/10">
                    <span class="font-bold text-white">OKX</span> <span class="text-blue-400">Aktiv</span>
                </span>
                <span class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[#1a1a1a] border border-white/10">
                    <span class="font-bold text-white">Binance</span> <span class="text-blue-400">Aktiv</span>
                </span>
                <span class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[#1a1a1a] border border-white/10">
                    <span class="font-bold text-white">Bybit</span> <span class="text-gray-500">Offline</span>
                </span>
                <span class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[#1a1a1a] border border-white/10">
                    <span class="font-bold text-white">Gateio</span> <span class="text-gray-500">Offline</span>
                </span>
                <span class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[#1a1a1a] border border-white/10">
                    <span class="font-bold text-white">BITTÃœRK</span> <span class="text-gray-500">Offline</span>
                </span>
                <div class="ml-auto flex items-center gap-2 text-blue-400">
                    <span>ğŸ“ˆ TradingView</span>
                    <span class="text-gray-500">Aktiv</span>
                    <span class="text-gray-400">Son Sinyal: 52 Saat</span>
                </div>
            </div>

            <!-- Auto + Manual Trading Row -->
            
            <!-- Bot KontrolÃ¼ section removed -->


            <!-- Bot Controls -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                        ğŸ¤– Otomatik Ä°ÅŸlem Kontrolleri
                    </h2>
                    <span class="text-xs text-blue-400 cursor-pointer">Yenile</span>
                </div>
                
                <div class="bg-[#0f0f0f] rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-white">ğŸ›ï¸ Bot KontrolÃ¼</h3>
                        <div class="flex gap-2">
                            <span class="px-2 py-1 rounded bg-orange-500/20 text-orange-400 text-xs"></span>
                            <span class="px-2 py-1 rounded bg-gray-800 text-gray-400 text-xs">â€¢ ASSET</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-center">
                            <button class="w-full bg-gray-800 text-gray-400 rounded-lg py-3 flex items-center justify-center gap-2">
                                <span>â¸ï¸</span> Duraklat
                            </button>
                            <div class="mt-2">
                                <span class="text-xs text-gray-500">Toplam PNL</span>
                                <div class="text-lg font-bold text-red-400">+$0.00</div>
                                <div class="text-xs text-gray-500">Her sayÄ±ma: 0 USD gelecek!</div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button class="w-full bg-red-500 text-white rounded-lg py-3 flex items-center justify-center gap-2">
                                <span>â¹ï¸</span> Durdur
                            </button>
                            <div class="mt-2">
                                <span class="text-xs text-gray-500">AÃ§Ä±k/GÃ¼nlÃ¼k PNL</span>
                                <div class="text-lg font-bold text-red-400">+$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div class="bg-[#0f0f0f] rounded-lg p-4">
                    <h3 class="text-sm font-medium text-white mb-3">ğŸ“Š Ä°statistikler</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">Kazanma OranÄ±</span><span class="text-white">0.0%</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Toplam Ä°ÅŸlem</span><span class="text-white">0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Aktif Pozisyon</span><span class="text-white">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Bot Settings + Pending Trades + Active Coins -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <h3 class="text-sm font-medium text-white mb-4">ğŸš€ Bekleyen Auto Ä°ÅŸlemler <span class="text-gray-500">0 adet</span></h3>
                    <div class="flex items-center justify-center h-24 text-gray-500 text-sm">
                        <div class="text-center">
                            <div class="text-2xl mb-2">ğŸ“¦</div>
                            Bekleyen auto iÅŸlem yok
                        </div>
                    </div>
                </div>
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <h3 class="text-sm font-medium text-white mb-4">ğŸª™ Aktif Coinler <span class="text-gray-500">0 adet/0 saat</span></h3>
                    <div class="flex items-center justify-center h-24 text-gray-500 text-sm">
                        <div class="text-center">
                            <div class="text-2xl mb-2">ğŸ“¦</div>
                            Aktif coin bulunmuyor
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signal History -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-white">ğŸ“œ Sinyal GeÃ§miÅŸi</h2>
                    <span class="text-xs text-blue-400 cursor-pointer">Yenile</span>
                </div>
                <div class="bg-[#0f0f0f] rounded-lg p-4">
                    <div class="flex flex-wrap items-center gap-4 mb-4">
                        <input type="text" class="bg-[#1a1a1a] border border-white/10 rounded-lg px-3 py-2 text-white text-sm w-48" placeholder="ğŸ” Sembol ara...">
                        <select class="bg-[#1a1a1a] border border-white/10 rounded-lg px-3 py-2 text-white text-sm">
                            <option>TÃ¼m Durumlar</option>
                        </select>
                        <select class="bg-[#1a1a1a] border border-white/10 rounded-lg px-3 py-2 text-white text-sm">
                            <option>TÃ¼m Tipler</option>
                        </select>
                        <span class="text-xs text-gray-500">ğŸ” 0 Sinyal</span>
                    </div>
                    <div class="flex items-center justify-center h-24 text-gray-500 text-sm">
                        <div class="text-center">
                            <div class="text-2xl mb-2">ğŸ”„</div>
                            HenÃ¼z sinyal geÃ§miÅŸi yok
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart + Coin List -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        ğŸ“ˆ Grafik Analizi
                    </h2>
                    <div class="bg-[#0f0f0f] rounded-lg h-[400px] overflow-hidden border border-white/10">
                         <!-- Chart Container -->
                         <div id="dashboard_tv_chart" style="height:100%; width:100%"></div>
                    </div>
                </div>
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <h3 class="text-lg font-semibold text-white mb-4">Coin Listesi</h3>
                    <div class="bg-[#0f0f0f] rounded-lg p-4">
                        <h4 class="text-sm font-medium text-white mb-3">Coin Listesi</h4>
                        <input type="text" class="w-full bg-[#1a1a1a] border border-white/10 rounded-lg px-3 py-2 text-white text-sm mb-3" placeholder="ğŸ” Coin ara...">
                        <div class="flex gap-2 mb-4">
                            <button class="flex-1 bg-blue-600 text-white rounded-lg py-2 text-sm">Hacim</button>
                            <button class="flex-1 bg-transparent border border-white/10 text-gray-400 rounded-lg py-2 text-sm">DeÄŸiÅŸim</button>
                            <button class="flex-1 bg-transparent border border-white/10 text-gray-400 rounded-lg py-2 text-sm">Fiyat</button>
                        </div>
                        <div class="space-y-2 max-h-80 overflow-y-auto">
                            <div class="flex items-center justify-between p-2 hover:bg-gray-800 rounded-lg cursor-pointer">
                                <div class="flex items-center gap-2">
                                    <span class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold text-xs">B1</span>
                                    <div>
                                        <div class="text-white font-medium">BTC</div>
                                        <div class="text-xs text-gray-500">BTC/TRY</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-white font-mono">$2,851,792.23</div>
                                    <div class="text-xs text-green-400">â–² 2.28%</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-2 hover:bg-gray-800 rounded-lg cursor-pointer">
                                <div class="flex items-center gap-2">
                                    <span class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xs">E</span>
                                    <div>
                                        <div class="text-white font-medium">ETH</div>
                                        <div class="text-xs text-gray-500">ETH/TRY</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-white font-mono">$124,576.60</div>
                                    <div class="text-xs text-green-400">â–² 1.56%</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-2 hover:bg-gray-800 rounded-lg cursor-pointer">
                                <div class="flex items-center gap-2">
                                    <span class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold text-xs">SO</span>
                                    <div>
                                        <div class="text-white font-medium">SOL</div>
                                        <div class="text-xs text-gray-500">SOL/TRY</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-white font-mono">$4,942.53</div>
                                    <div class="text-xs text-green-400">â–² 2.54%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
    new TradingView.widget({
        "autosize": true,
        "symbol": "BINANCE:BTCUSDT",
        "interval": "D",
        "timezone": "Etc/UTC",
        "theme": "dark",
        "style": "1",
        "locale": "tr",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "allow_symbol_change": true,
        "container_id": "dashboard_tv_chart"
    });
</script>
{% endblock %}
"""

# Admin Dashboard Template
ADMIN_DASHBOARD_TEMPLATE = r"""
{% extends "base" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Tab Switching Logic
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.add('hidden');
            el.classList.remove('block');
        });
        const activeTab = document.getElementById(tabId);
        if (activeTab) {
            activeTab.classList.remove('hidden');
            activeTab.classList.add('block');
        }
        history.pushState(null, null, '#' + tabId);
    }

    // Modal Logic
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }

    // User Management Functions
    async function showUserDetails(userId) {
        try {
            const res = await fetch(`/api/admin/users/${userId}`);
            const data = await res.json();
            if (data.ok) {

                  // __AU_UI_SELLPOS_REFRESH_V1
                  try{
                      if (String(currentMode||"").toLowerCase() === "demo"){
                          await __auRefreshDemoBalance2();
                      
                window.__AU_BALANCE_LOCK = false;}
                  }catch(e){}

                const user = data.user;
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editTelegramId').value = user.telegram_id || '';
                document.getElementById('editPassword').value = '';
                document.getElementById('editPackage').value = user.package || 'trial';
                document.getElementById('editPackageMonths').value = user.package_months || 1;
                document.getElementById('editWebhook').value = user.webhook_url || `${window.location.origin}/webhook/tv/${userId}`;
                openModal('user-modal');
            } else {
                alert('KullanÄ±cÄ± bilgileri alÄ±namadÄ±: ' + (data.error || 'Bilinmeyen hata'));
            }
        } catch (e) {
            alert('Hata: ' + e.message);
        }
    }

    async function saveUserEdit() {
        const userId = document.getElementById('editUserId').value;
        const data = {
            email: document.getElementById('editEmail').value,
            telegram_id: document.getElementById('editTelegramId').value,
            password: document.getElementById('editPassword').value,
            package: document.getElementById('editPackage').value,
            package_months: parseInt(document.getElementById('editPackageMonths').value) || 1
        };
        
        try {
            const res = await fetch(`/api/admin/users/${userId}`, {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.ok) {
                alert('âœ… KullanÄ±cÄ± gÃ¼ncellendi!');
                closeModal('user-modal');
                location.reload();
            } else {
                alert('âŒ Hata: ' + (result.error || 'Bilinmeyen hata'));
            }
        } catch (e) {
            alert('âŒ Hata: ' + e.message);
        }
    }

    function confirmDeleteUser() {
        const userId = document.getElementById('editUserId').value;
        const username = document.getElementById('editUsername').value;
        document.getElementById('deleteUserName').textContent = `"${username}" kullanÄ±cÄ±sÄ± kalÄ±cÄ± olarak silinecek.`;
        openModal('delete-user-modal');
    }

    async function executeDeleteUser() {
        const userId = document.getElementById('editUserId').value;
        try {
            const res = await fetch(`/api/admin/users/${userId}/delete`, {method: 'POST'});
            const result = await res.json();
            if (result.ok) {
                alert('âœ… KullanÄ±cÄ± silindi!');
                closeModal('delete-user-modal');
                closeModal('user-modal');
                location.reload();
            } else {
                alert('âŒ Hata: ' + (result.error || 'Bilinmeyen hata'));
            }
        } catch (e) {
            alert('âŒ Hata: ' + e.message);
        }
    }

    function copyWebhook() {
        const webhook = document.getElementById('editWebhook').value;
        navigator.clipboard.writeText(webhook).then(() => {
            alert('ğŸ“‹ Webhook URL kopyalandÄ±!');
        });
    }

    function downloadContract(contractId) {
        window.location.href = `/api/admin/contracts/${contractId}/download`;
    }

    window.addEventListener('load', () => {
        const hash = window.location.hash.substring(1);
        if (hash && document.getElementById(hash)) { showTab(hash); } else { showTab('dashboard-view'); }
    });
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    {{ sidebar | safe }}

    <main class="lg:ml-64 p-4 md:p-8 pt-16 lg:pt-8 min-h-screen">
        <div class="max-w-[1400px] mx-auto space-y-8">
            
            <!-- --- TAB NAVIGATION (Integrated) --- -->
            <div class="flex items-center gap-2 overflow-x-auto pb-2 border-b border-white/5 scrollbar-hide">
                <button onclick="showTab('dashboard-view')" class="px-6 py-2 rounded-xl bg-white/5 text-gray-400 hover:text-white transition-all text-sm font-bold border border-transparent hover:border-white/10">Genel BakÄ±ÅŸ</button>
                <button onclick="showTab('users-view')" class="px-6 py-2 rounded-xl bg-white/5 text-gray-400 hover:text-white transition-all text-sm font-bold border border-transparent hover:border-white/10">KullanÄ±cÄ±lar</button>
                <button onclick="showTab('contracts-view')" class="px-6 py-2 rounded-xl bg-white/5 text-gray-400 hover:text-white transition-all text-sm font-bold border border-transparent hover:border-white/10">SÃ¶zleÅŸmeler</button>
                <button onclick="showTab('trading-view')" class="px-6 py-2 rounded-xl bg-white/5 text-gray-400 hover:text-white transition-all text-sm font-bold border border-transparent hover:border-white/10">Ä°ÅŸlemler</button>
                <button onclick="showTab('payment-view')" class="px-6 py-2 rounded-xl bg-white/5 text-gray-400 hover:text-white transition-all text-sm font-bold border border-transparent hover:border-white/10">Ã–demeler</button>
                <button onclick="showTab('system-view')" class="px-6 py-2 rounded-xl bg-white/5 text-gray-400 hover:text-white transition-all text-sm font-bold border border-transparent hover:border-white/10">Sistem</button>
            </div>

            <!-- --- VIEW 1: MAIN DASHBOARD --- -->
            <div id="dashboard-view" class="tab-content block animate-in fade-in duration-500">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
                    <div class="flex items-center gap-4">
                        <div class="bg-red-600/10 p-3 rounded-xl border border-red-500/20"><svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg></div>
                        <div><h1 class="text-3xl font-black text-white">Admin Paneli</h1><p class="text-sm text-gray-400">Genel sistem durumu ve kontroller</p></div>
                    </div>
                    <div class="px-4 py-2 rounded-full bg-green-500/10 border border-green-500/20 flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-green-400 animate-pulse"></span><span class="text-xs font-bold text-green-400 uppercase tracking-widest">Sistem Aktif</span></div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                    <div class="bg-gradient-to-br from-[#1a1f35] to-[#121421] border border-blue-500/20 rounded-2xl p-6 shadow-xl relative overflow-hidden">
                        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-blue-500/5 rounded-full"></div>
                        <p class="text-[10px] font-black text-blue-400 uppercase tracking-[0.2em] mb-2">Toplam KullanÄ±cÄ±</p>
                        <p class="text-4xl font-black text-white">{{ total_users }}</p>
                        <div class="absolute top-6 right-6 p-2 bg-blue-500/10 rounded-lg text-blue-400">ğŸ‘¤</div>
                    </div>
                    <div class="bg-gradient-to-br from-[#162721] to-[#0e1614] border border-green-500/20 rounded-2xl p-6 shadow-xl relative overflow-hidden">
                        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-green-500/5 rounded-full"></div>
                        <p class="text-[10px] font-black text-green-400 uppercase tracking-[0.2em] mb-2">Aktif Ãœyeler</p>
                        <p class="text-4xl font-black text-white">{{ active_users }}</p>
                        <div class="absolute top-6 right-6 p-2 bg-green-500/10 rounded-lg text-green-400">âœ…</div>
                    </div>
                    <div class="bg-gradient-to-br from-[#231a31] to-[#140e1b] border border-purple-500/20 rounded-2xl p-6 shadow-xl relative overflow-hidden">
                        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-purple-500/5 rounded-full"></div>
                        <p class="text-[10px] font-black text-purple-400 uppercase tracking-[0.2em] mb-2">BugÃ¼nkÃ¼ Ä°ÅŸlem</p>
                        <p class="text-4xl font-black text-white">{{ total_trades }}</p>
                        <div class="absolute top-6 right-6 p-2 bg-purple-500/10 rounded-lg text-purple-400">ğŸ“‰</div>
                    </div>
                    <div class="bg-gradient-to-br from-[#2b1f16] to-[#1a120e] border border-orange-500/20 rounded-2xl p-6 shadow-xl relative overflow-hidden">
                        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-orange-500/5 rounded-full"></div>
                        <p class="text-[10px] font-black text-orange-400 uppercase tracking-[0.2em] mb-2">Toplam Hacim</p>
                        <p class="text-3xl font-black text-white">${{ total_volume }}</p>
                        <div class="absolute top-6 right-6 p-2 bg-orange-500/10 rounded-lg text-orange-400">ğŸ’°</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div onclick="showTab('users-view')" class="bg-[#1a1a1a] rounded-2xl p-7 border border-white/5 hover:border-blue-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                        <div class="flex items-center gap-5 mb-5"><div class="bg-blue-600/10 p-4 rounded-2xl text-blue-500 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-inner">ğŸ‘¤</div><h3 class="text-xl font-bold text-white uppercase tracking-wider">KullanÄ±cÄ± YÃ¶netimi</h3></div>
                        <p class="text-sm text-gray-400">KullanÄ±cÄ± listesi, detaylar ve dÃ¼zenleme iÅŸlemleri.</p>
                    </div>
                    <div onclick="showTab('contracts-view')" class="bg-[#1a1a1a] rounded-2xl p-7 border border-white/5 hover:border-orange-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                        <div class="flex items-center gap-5 mb-5"><div class="bg-orange-600/10 p-4 rounded-2xl text-orange-500 group-hover:bg-orange-600 group-hover:text-white transition-all shadow-inner">ğŸ“„</div><h3 class="text-xl font-bold text-white uppercase tracking-wider">SÃ¶zleÅŸme YÃ¶netimi</h3></div>
                        <p class="text-sm text-gray-400">Dijital onaylÄ± kullanÄ±cÄ± sÃ¶zleÅŸmeleri ve PDF iÅŸlemleri.</p>
                    </div>
                    <div onclick="showTab('trading-view')" class="bg-[#1a1a1a] rounded-2xl p-7 border border-white/5 hover:border-purple-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                        <div class="flex items-center gap-5 mb-5"><div class="bg-purple-600/10 p-4 rounded-2xl text-purple-500 group-hover:bg-purple-600 group-hover:text-white transition-all shadow-inner">ğŸ“Š</div><h3 class="text-xl font-bold text-white uppercase tracking-wider">Ä°ÅŸlem Ä°zleme</h3></div>
                        <p class="text-sm text-gray-400">CanlÄ± alÄ±m-satÄ±m performansÄ± ve iÅŸlem loglarÄ±.</p>
                    </div>
                </div>
            </div>

            <!-- --- VIEW 2: KULLANICI YÃ–NETÄ°MÄ° --- -->
            <div id="users-view" class="tab-content hidden animate-in slide-in-from-bottom-4 duration-500">
                <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 overflow-hidden shadow-2xl">
                    <div class="p-6 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white">KullanÄ±cÄ± YÃ¶netimi</h3>
                        <div class="flex items-center gap-4">
                            <input type="text" placeholder="KullanÄ±cÄ± ara..." class="bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                            <button class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-black/40 text-[10px] font-black text-gray-500 uppercase tracking-widest border-b border-white/5">
                                <tr>
                                    <th class="px-8 py-5">KullanÄ±cÄ±</th>
                                    <th class="px-8 py-5">E-posta</th>
                                    <th class="px-8 py-5">Rol</th>
                                    <th class="px-8 py-5">Abonelik</th>
                                    <th class="px-8 py-5">Bakiye</th>
                                    <th class="px-8 py-5 text-center">Durum</th>
                                    <th class="px-8 py-5 text-right">Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-white/[0.02] text-sm">
                                {% for user in users %}
                                <tr class="hover:bg-white/[0.02] transition-colors group">
                                    <td class="px-8 py-5 flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-{{ 'red' if user.is_admin else 'blue' }}-600 flex items-center justify-center font-bold text-white">{{ user.username[0]|upper }}</div>
                                        <div class="font-bold text-white">{{ user.username }}</div>
                                    </td>
                                    <td class="px-8 py-5 text-gray-400">{{ user.email or '-' }}</td>
                                    <td class="px-8 py-5"><span class="px-3 py-1 rounded-lg bg-{{ 'red' if user.is_admin else 'blue' }}-500/20 text-{{ 'red' if user.is_admin else 'blue' }}-500 text-[10px] font-black">{{ 'Admin' if user.is_admin else 'KullanÄ±cÄ±' }}</span></td>
                                    <td class="px-8 py-5"><span class="px-3 py-1 rounded-lg bg-purple-500/20 text-purple-400 text-[10px] font-black">{{ user.package_name or 'Deneme' }}</span></td>
                                    <td class="px-8 py-5 font-bold text-cyan-400">{{ "%.2f"|format(user.demo_balance or 0) }} USDT</td>
                                    <td class="px-8 py-5 text-center"><div class="flex items-center justify-center gap-2 text-{{ 'green' if user.trade_enabled else 'red' }}-400 font-bold text-[10px] uppercase"><span class="w-1.5 h-1.5 rounded-full bg-{{ 'green' if user.trade_enabled else 'red' }}-400"></span> {{ 'Aktif' if user.trade_enabled else 'Pasif' }}</div></td>
                                    <td class="px-8 py-5 text-right"><button onclick="showUserDetails({{ user.rowid }})" class="px-5 py-2 rounded-xl bg-white/5 hover:bg-blue-600 hover:text-white text-gray-400 text-xs font-bold transition-all border border-white/5">DÃ¼zenle</button></td>
                                </tr>
                                {% endfor %}
                                {% if not users %}
                                <tr><td colspan="7" class="px-8 py-10 text-center text-gray-500">HenÃ¼z kullanÄ±cÄ± yok.</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- --- VIEW 3: SÃ–ZLEÅME YÃ–NETÄ°MÄ° --- -->
            <div id="contracts-view" class="tab-content hidden animate-in slide-in-from-bottom-4 duration-500">
                <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 shadow-2xl p-6 mb-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-white">SÃ¶zleÅŸme YÃ¶netimi</h3>
                    <button class="p-2 rounded-lg bg-white/5 text-gray-400 hover:bg-white/10 transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Contract Card 1 -->
                    <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 relative overflow-hidden group shadow-lg">
                        <div class="absolute top-0 right-0 p-3"><span class="px-3 py-1 rounded-lg bg-green-500/20 text-green-400 text-[10px] font-black uppercase tracking-wider">âœ… Kabul Edildi</span></div>
                        <h4 class="text-lg font-bold text-white mb-2">Trading Service Agreement</h4>
                        <div class="flex flex-col gap-1 text-[11px] text-gray-500 mb-6">
                            <span class="flex items-center gap-2">ğŸ‘¤ Atalay Ulusoy</span>
                            <span class="flex items-center gap-2">âœ‰ï¸ atalay@example.com</span>
                            <span class="flex items-center gap-2">ğŸ“… 14.01.2026</span>
                        </div>
                        <p class="text-[10px] text-gray-400 leading-relaxed mb-6">This agreement outlines the terms and conditions for automated trading services. The user agrees to provide valid API keys and maintain sufficient balance.</p>
                        <div class="flex gap-3">
                            <button onclick="downloadContract(1)" class="flex-1 px-4 py-2 rounded-xl bg-blue-600 text-white text-xs font-black uppercase transition-all hover:bg-blue-700 flex items-center justify-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> PDF Ä°ndir</button>
                            <button class="flex-1 px-4 py-2 rounded-xl bg-white/5 text-gray-400 text-xs font-black uppercase border border-white/5 hover:bg-white/10 transition-all">GÃ¶rÃ¼ntÃ¼le</button>
                        </div>
                    </div>
                    <!-- Contract Card 2 -->
                    <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 relative overflow-hidden group shadow-lg">
                        <div class="absolute top-0 right-0 p-3"><span class="px-3 py-1 rounded-lg bg-yellow-500/20 text-yellow-500 text-[10px] font-black uppercase tracking-wider">âŒ› Bekliyor</span></div>
                        <h4 class="text-lg font-bold text-white mb-2">Trading Service Agreement</h4>
                        <div class="flex flex-col gap-1 text-[11px] text-gray-500 mb-6">
                            <span class="flex items-center gap-2">ğŸ‘¤ Trader Two</span>
                            <span class="flex items-center gap-2">âœ‰ï¸ trader2@example.com</span>
                            <span class="flex items-center gap-2">ğŸ“… 14.01.2026</span>
                        </div>
                        <p class="text-[10px] text-gray-400 leading-relaxed mb-6">This agreement outlines the terms and conditions for automated trading services. The user agrees to provide valid API keys and maintain sufficient balance.</p>
                        <div class="flex gap-3">
                            <button onclick="downloadContract(2)" class="flex-1 px-4 py-2 rounded-xl bg-blue-600 text-white text-xs font-black uppercase transition-all hover:bg-blue-700 flex items-center justify-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> PDF Ä°ndir</button>
                            <button class="flex-1 px-4 py-2 rounded-xl bg-white/5 text-gray-400 text-xs font-black uppercase border border-white/5 hover:bg-white/10 transition-all">GÃ¶rÃ¼ntÃ¼le</button>
                        </div>
                    </div>
                </div>
            </div>

            
            
            <!-- --- VIEW 6: Ã–DEME Ä°ÅLEMLERÄ° MERKEZÄ° --- -->
            <div id="payment-view" class="tab-content hidden animate-in slide-in-from-bottom-4 duration-500">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="showTab('dashboard-view')" class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                    <div class="bg-green-600/10 p-3 rounded-xl text-green-500">ğŸ’³</div>
                    <div><h2 class="text-xl font-bold text-white">Ã–deme Ä°ÅŸlemleri Merkezi</h2><p class="text-xs text-gray-400">Ã–demeler, abonelikler ve finansal yÃ¶netim</p></div>
                    <button class="ml-auto p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Bekleyen Ã–demeler</p><p class="text-2xl font-bold text-white">0</p><div class="text-yellow-400 text-lg absolute top-4 right-4">â³</div></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-green-500/20"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Toplam Gelir</p><p class="text-2xl font-bold text-green-400">â‚º0.00</p><div class="text-green-400 text-lg absolute top-4 right-4">ğŸ“ˆ</div></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Aktif Abonelikler</p><p class="text-2xl font-bold text-white">1</p><div class="text-blue-400 text-lg absolute top-4 right-4">ğŸ“Š</div></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">AylÄ±k Tahsilat</p><p class="text-2xl font-bold text-white">0</p><div class="text-purple-400 text-lg absolute top-4 right-4">ğŸ’°</div></div>
                </div>

                <!-- Ä°ÅŸlem YÃ¶netimi Section -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 mb-6">
                    <div class="p-4 border-b border-white/5 flex items-center justify-between">
                        <h3 class="text-sm font-bold text-white">Ä°ÅŸlem YÃ¶netimi</h3>
                        <div class="flex items-center gap-2">
                            <input type="text" placeholder="Ä°ÅŸi Zaman aralÄ±ÄŸÄ± girin..." class="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white focus:outline-none focus:border-blue-500 w-48">
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex gap-2 mb-4">
                            <button class="px-3 py-1.5 rounded-lg bg-green-600 text-white text-xs font-bold">Onaylanan (0)</button>
                            <button class="px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 text-xs font-bold hover:bg-white/10">Ä°ÅŸlemde (0)</button>
                            <button class="px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 text-xs font-bold hover:bg-white/10">Bekleyen (0)</button>
                            <button class="px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 text-xs font-bold hover:bg-white/10">Ä°ptal</button>
                        </div>
                        <table class="w-full text-left">
                            <thead class="text-[10px] font-black text-gray-500 uppercase tracking-widest border-b border-white/5">
                                <tr><th class="px-4 py-3">KullanÄ±cÄ±</th><th class="px-4 py-3">Ä°ÅŸlem ID</th><th class="px-4 py-3">Tutar</th><th class="px-4 py-3">Ã–deme</th><th class="px-4 py-3">Tarih</th><th class="px-4 py-3">Ä°ÅŸlemler</th></tr>
                            </thead>
                            <tbody class="text-sm text-gray-400">
                                <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Ä°ÅŸlem bulunamadÄ±</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Abonelik YÃ¶netimi Section -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 mb-6">
                    <div class="p-4 border-b border-white/5">
                        <h3 class="text-sm font-bold text-green-400">Abonelik YÃ¶netimi</h3>
                    </div>
                    <table class="w-full text-left">
                        <thead class="text-[10px] font-black text-gray-500 uppercase tracking-widest border-b border-white/5">
                            <tr><th class="px-6 py-3">KullanÄ±cÄ±</th><th class="px-6 py-3">Plan</th><th class="px-6 py-3">BitiÅŸ Tarihi</th><th class="px-6 py-3">Bakiye</th></tr>
                        </thead>
                        <tbody class="divide-y divide-white/[0.02] text-sm">
                            <tr class="hover:bg-white/[0.02]">
                                <td class="px-6 py-4"><div><span class="font-bold text-white">Atalay Ulusoy</span><br><span class="text-[10px] text-gray-500">atalayulusoyyy@gmail.com</span></div></td>
                                <td class="px-6 py-4 text-gray-400">Unlimited</td>
                                <td class="px-6 py-4 text-gray-400">N/A</td>
                                <td class="px-6 py-4 text-cyan-400 font-bold">â‚º100000.00</td>
                            </tr>
                            <tr class="hover:bg-white/[0.02]">
                                <td class="px-6 py-4"><div><span class="font-bold text-white">Trader Two</span><br><span class="text-[10px] text-gray-500">trader-2@example.com</span></div></td>
                                <td class="px-6 py-4 text-gray-400">Deneme</td>
                                <td class="px-6 py-4 text-gray-400">N/A</td>
                                <td class="px-6 py-4 text-cyan-400 font-bold">â‚º3000.00</td>
                            </tr>
                            <tr class="hover:bg-white/[0.02]">
                                <td class="px-6 py-4"><div><span class="font-bold text-white">Trader One</span><br><span class="text-[10px] text-gray-500">trader1@example.com</span></div></td>
                                <td class="px-6 py-4 text-gray-400">Deneme</td>
                                <td class="px-6 py-4 text-gray-400">N/A</td>
                                <td class="px-6 py-4 text-cyan-400 font-bold">â‚º5000.00</td>
                            </tr>
                            <tr class="hover:bg-white/[0.02]">
                                <td class="px-6 py-4"><div><span class="font-bold text-white">Atalay Ulusoy</span><br><span class="text-[10px] text-gray-500">admin@autotrade.com</span></div></td>
                                <td class="px-6 py-4 text-gray-400">Deneme</td>
                                <td class="px-6 py-4 text-gray-400">N/A</td>
                                <td class="px-6 py-4 text-cyan-400 font-bold">â‚º10619.42</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Webhook YapÄ±landÄ±rmasÄ± Section -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5">
                    <div class="p-4 border-b border-white/5 flex items-center gap-3">
                        <div class="bg-blue-600/20 p-2 rounded-lg"><svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg></div>
                        <div><h3 class="font-bold text-white">Webhook YapÄ±landÄ±rmasÄ±</h3><p class="text-[10px] text-gray-500">KullanÄ±cÄ± webhook'larÄ±nÄ± yÃ¶netin</p></div>
                        <button class="ml-auto p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                    </div>
                    
                    <!-- Yeni Webhook Ekle -->
                    <div class="p-4 border-b border-white/5">
                        <h4 class="text-sm font-bold text-white mb-4">Yeni Webhook Ekle</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-2">KullanÄ±cÄ± SeÃ§</label>
                                <select class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option>KullanÄ±cÄ± seÃ§iniz...</option>
                                    <option>Atalay Ulusoy</option>
                                    <option>Trader Two</option>
                                    <option>Trader One</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-2">Webhook URL</label>
                                <input type="text" placeholder="https://example.com/webhook" class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 placeholder-gray-600">
                            </div>
                        </div>
                        <input type="text" placeholder="Bu alanÄ±ma aÃ§Ä±klama..." class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 placeholder-gray-600 mb-4">
                    </div>
                    
                    <!-- Mevcut Webhook'lar -->
                    <div class="p-4">
                        <h4 class="text-sm font-bold text-green-400 mb-4">Mevcut Webhook'lar</h4>
                        <table class="w-full text-left">
                            <thead class="text-[10px] font-black text-gray-500 uppercase tracking-widest border-b border-white/5">
                                <tr><th class="px-4 py-3">KullanÄ±cÄ±</th><th class="px-4 py-3">Webhook URL</th><th class="px-4 py-3 text-center">Durum</th><th class="px-4 py-3 text-right">Ä°ÅŸlemler</th></tr>
                            </thead>
                            <tbody class="divide-y divide-white/[0.02] text-sm">
                                <tr class="hover:bg-white/[0.02]">
                                    <td class="px-4 py-3"><span class="text-green-400 font-bold">Atalay Ulusoy</span></td>
                                    <td class="px-4 py-3 text-gray-400 font-mono text-xs truncate max-w-xs">https://api.app1.appsheet.com/...Atalay%5BTrades%5D</td>
                                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-[10px] font-bold">Aktif</span></td>
                                    <td class="px-4 py-3 text-right"><div class="flex justify-end gap-2"><button class="p-1.5 rounded bg-blue-600 text-white hover:bg-blue-700"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button><button class="p-1.5 rounded bg-red-600 text-white hover:bg-red-700"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                                </tr>
                                <tr class="hover:bg-white/[0.02]">
                                    <td class="px-4 py-3"><span class="text-blue-400 font-bold">Trader One</span></td>
                                    <td class="px-4 py-3 text-gray-400 font-mono text-xs truncate max-w-xs">https://api.app1.appsheet.com/.../trades/webhook</td>
                                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-[10px] font-bold">Aktif</span></td>
                                    <td class="px-4 py-3 text-right"><div class="flex justify-end gap-2"><button class="p-1.5 rounded bg-blue-600 text-white hover:bg-blue-700"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button><button class="p-1.5 rounded bg-red-600 text-white hover:bg-red-700"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                                </tr>
                                <tr class="hover:bg-white/[0.02]">
                                    <td class="px-4 py-3"><span class="text-purple-400 font-bold">Trader Two</span></td>
                                    <td class="px-4 py-3 text-gray-400 font-mono text-xs truncate max-w-xs">https://api.app1.appsheet.com/.../webhook/notify</td>
                                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-[10px] font-bold">Aktif</span></td>
                                    <td class="px-4 py-3 text-right"><div class="flex justify-end gap-2"><button class="p-1.5 rounded bg-blue-600 text-white hover:bg-blue-700"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button><button class="p-1.5 rounded bg-red-600 text-white hover:bg-red-700"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                                </tr>
                                <tr class="hover:bg-white/[0.02]">
                                    <td class="px-4 py-3"><span class="text-orange-400 font-bold">Atalay Ulusoy</span></td>
                                    <td class="px-4 py-3 text-gray-400 font-mono text-xs truncate max-w-xs">https://api.app1.appsheet.com/.../webhook/Trades</td>
                                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-[10px] font-bold">Aktif</span></td>
                                    <td class="px-4 py-3 text-right"><div class="flex justify-end gap-2"><button class="p-1.5 rounded bg-blue-600 text-white hover:bg-blue-700"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button><button class="p-1.5 rounded bg-red-600 text-white hover:bg-red-700"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- --- VIEW 5: SÄ°STEM METRÄ°KLERÄ° --- -->
            <div id="system-view" class="tab-content hidden animate-in slide-in-from-bottom-4 duration-500">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="showTab('dashboard-view')" class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                    <div class="bg-orange-600/10 p-3 rounded-xl text-orange-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></div>
                    <div><h2 class="text-xl font-bold text-white">Sistem Metrikleri</h2><p class="text-xs text-gray-400">Performans istatistikleri ve saÄŸlÄ±k durumu</p></div>
                    <button class="ml-auto p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Toplam KullanÄ±cÄ±</p><p class="text-2xl font-bold text-white">4</p><div class="text-blue-400 text-lg absolute top-4 right-4">ğŸ‘¤</div></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Aktif Ãœyeler</p><p class="text-2xl font-bold text-white">4</p><div class="text-green-400 text-lg absolute top-4 right-4">âœ…</div></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">BugÃ¼nkÃ¼ Ä°ÅŸlem</p><p class="text-2xl font-bold text-white">3</p><div class="text-purple-400 text-lg absolute top-4 right-4">ğŸ“Š</div></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-green-500/20"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Toplam Hacim</p><p class="text-2xl font-bold text-green-400">$85.00</p><div class="text-orange-400 text-lg absolute top-4 right-4">ğŸ’°</div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/5">
                        <h3 class="text-sm font-bold text-white mb-4">Sistem SaÄŸlÄ±ÄŸÄ±</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><span class="text-xs text-gray-400">Uptime</span><span class="text-xs font-bold text-green-400">99.9%</span></div>
                            <div class="flex justify-between items-center"><span class="text-xs text-gray-400">Ortalama YanÄ±t SÃ¼resi</span><span class="text-xs font-bold text-white">127ms</span></div>
                            <div class="flex justify-between items-center"><span class="text-xs text-gray-400">Hata OranÄ±</span><span class="text-xs font-bold text-yellow-400">0.07%</span></div>
                            <div class="flex justify-between items-center"><span class="text-xs text-gray-400">API Ã‡aÄŸrÄ±larÄ±</span><span class="text-xs font-bold text-white">0</span></div>
                        </div>
                    </div>
                    <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/5">
                        <h3 class="text-sm font-bold text-white mb-4">Sistem Durumu</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-2 rounded-lg bg-green-500/10"><span class="text-xs text-white flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-400"></span>Database</span><span class="text-[10px] font-bold text-green-400">Aktif</span></div>
                            <div class="flex justify-between items-center p-2 rounded-lg bg-green-500/10"><span class="text-xs text-white flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-400"></span>API Gateway</span><span class="text-[10px] font-bold text-green-400">Aktif</span></div>
                            <div class="flex justify-between items-center p-2 rounded-lg bg-green-500/10"><span class="text-xs text-white flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-400"></span>Ä°ÅŸlem Motoru</span><span class="text-[10px] font-bold text-green-400">Aktif</span></div>
                            <div class="flex justify-between items-center p-2 rounded-lg bg-green-500/10"><span class="text-xs text-white flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-400"></span>Webhook Servisi</span><span class="text-[10px] font-bold text-green-400">Aktif</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- --- VIEW 4: TRADÄ°NG Ä°ZLEME --- -->
            <div id="trading-view" class="tab-content hidden animate-in slide-in-from-bottom-4 duration-500">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="showTab('dashboard-view')" class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                    <div class="bg-orange-600/10 p-3 rounded-xl text-orange-500">ğŸ“Š</div>
                    <div><h2 class="text-xl font-bold text-white">Trading Ä°zleme</h2><p class="text-xs text-gray-400">CanlÄ± iÅŸlem takibi ve performans analizi</p></div>
                    <button class="ml-auto p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Aktif Bot</p><p class="text-2xl font-bold text-white">0</p></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-green-500/20"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">BugÃ¼nkÃ¼ KÃ¢r</p><p class="text-2xl font-bold text-green-400">$85.00</p></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">BaÅŸarÄ± OranÄ±</p><p class="text-2xl font-bold text-white">$0.10</p></div>
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-white/5"><p class="text-[10px] text-gray-500 uppercase font-bold mb-1">BugÃ¼n Zarar</p><p class="text-2xl font-bold text-white">0.00%</p></div>
                </div>

                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 overflow-hidden">
                    <div class="p-4 border-b border-white/5"><h3 class="text-sm font-bold text-white">Son Ä°ÅŸlemler</h3></div>
                    <table class="w-full text-left">
                        <thead class="bg-black/40 text-[10px] font-black text-gray-500 uppercase tracking-widest border-b border-white/5">
                            <tr><th class="px-6 py-4">KullanÄ±cÄ±</th><th class="px-6 py-4">Coin</th><th class="px-6 py-4">Miktar</th><th class="px-6 py-4">AlÄ±ÅŸ FiyatÄ±</th><th class="px-6 py-4">Ä°ÅŸlem</th><th class="px-6 py-4">Tarih</th></tr>
                        </thead>
                        <tbody class="divide-y divide-white/[0.02] text-sm">
                            <tr class="hover:bg-white/[0.02]">
                                <td class="px-6 py-4"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold text-white">T</div><span class="text-white">Trader One</span></div></td>
                                <td class="px-6 py-4 text-gray-400">atalayulusoyyy@gmail.com</td>
                                <td class="px-6 py-4 text-white">$29.90</td>
                                <td class="px-6 py-4 text-red-400">$0.18</td>
                                <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-[10px] font-bold">SatÄ±ÅŸ</span></td>
                                <td class="px-6 py-4 text-gray-400">16.01.2026, 12:09 A</td>
                            </tr>
                            <tr class="hover:bg-white/[0.02]">
                                <td class="px-6 py-4"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-xs font-bold text-white">T</div><span class="text-white">Trader One</span></div></td>
                                <td class="px-6 py-4 text-gray-400">test@tempmailo.com</td>
                                <td class="px-6 py-4 text-white">$40.00</td>
                                <td class="px-6 py-4 text-red-400">$0.83</td>
                                <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-[10px] font-bold">SatÄ±ÅŸ</span></td>
                                <td class="px-6 py-4 text-gray-400">16.01.2026, 12:09:16</td>
                            </tr>
                            <tr class="hover:bg-white/[0.02]">
                                <td class="px-6 py-4"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center text-xs font-bold text-white">T</div><span class="text-white">Trader Two</span></div></td>
                                <td class="px-6 py-4 text-gray-400">testingmail@gmail.com</td>
                                <td class="px-6 py-4 text-white">$75.00</td>
                                <td class="px-6 py-4 text-red-400">$3.62</td>
                                <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-[10px] font-bold">SatÄ±ÅŸ</span></td>
                                <td class="px-6 py-4 text-gray-400">17.01.2026, 12:09 PM</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- --- MODAL: KULLANICI DETAYLARI --- -->
            <div id="user-modal" class="fixed inset-0 z-[200] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                <div class="bg-[#1a1d2d] w-full max-w-lg rounded-2xl border border-white/10 shadow-2xl relative overflow-hidden max-h-[90vh] overflow-y-auto">
                    <button onclick="closeModal('user-modal')" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-all z-10"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                    
                    <!-- Edit Mode (Combined View & Edit) -->
                    <div id="user-edit-content" class="p-8 space-y-6">
                        <div class="flex items-center gap-3">
                            <span class="text-blue-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></span>
                            <h2 class="text-2xl font-black text-white">KullanÄ±cÄ± DÃ¼zenle</h2>
                        </div>
                        
                        <input type="hidden" id="editUserId" value="">
                        
                        <!-- Basic Info -->
                        <div class="bg-black/20 rounded-2xl p-6 border border-white/5 space-y-4">
                            <h4 class="text-xs font-black text-blue-400 uppercase tracking-[0.2em] flex items-center gap-2"><span class="w-1.5 h-4 bg-blue-500 rounded-full"></span> Temel Bilgiler</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] text-gray-500 uppercase font-black block mb-2">KullanÄ±cÄ± AdÄ±</label>
                                    <input type="text" id="editUsername" class="w-full bg-[#121421] border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500" readonly>
                                </div>
                                <div>
                                    <label class="text-[10px] text-gray-500 uppercase font-black block mb-2">E-posta</label>
                                    <input type="email" id="editEmail" class="w-full bg-[#121421] border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase font-black block mb-2">ğŸ“± Telegram Chat ID</label>
                                <input type="text" id="editTelegramId" placeholder="123456789" class="w-full bg-[#121421] border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase font-black block mb-2">ğŸ”‘ Yeni Åifre (DeÄŸiÅŸtirmek iÃ§in doldurun)</label>
                                <input type="password" id="editPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full bg-[#121421] border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                        
                        <!-- Subscription Info -->
                        <div class="bg-black/20 rounded-2xl p-6 border border-white/5 space-y-4">
                            <h4 class="text-xs font-black text-purple-400 uppercase tracking-[0.2em] flex items-center gap-2"><span class="w-1.5 h-4 bg-purple-500 rounded-full"></span> Abonelik Bilgileri</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] text-gray-500 uppercase font-black block mb-2">ğŸ“¦ Paket</label>
                                    <select id="editPackage" class="w-full bg-[#121421] border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none">
                                        <option value="trial">Deneme</option>
                                        <option value="basic">Basic</option>
                                        <option value="pro">Pro</option>
                                        <option value="elite">Elit</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] text-gray-500 uppercase font-black block mb-2">ğŸ“… Paket SÃ¼resi (Ay)</label>
                                    <input type="number" id="editPackageMonths" min="1" max="24" value="1" class="w-full bg-[#121421] border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Webhook Info -->
                        <div class="bg-black/20 rounded-2xl p-6 border border-white/5 space-y-4">
                            <h4 class="text-xs font-black text-cyan-400 uppercase tracking-[0.2em] flex items-center gap-2"><span class="w-1.5 h-4 bg-cyan-500 rounded-full"></span> Webhook AyarlarÄ±</h4>
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase font-black block mb-2">ğŸ”— TradingView Webhook URL</label>
                                <div class="flex gap-2">
                                    <input type="text" id="editWebhook" readonly class="flex-1 bg-[#121421] border border-white/10 rounded-xl px-4 py-3 text-sm text-cyan-400 font-mono focus:outline-none">
                                    <button onclick="copyWebhook()" class="px-4 py-2 rounded-xl bg-cyan-600/20 text-cyan-400 hover:bg-cyan-600 hover:text-white transition-all text-xs font-bold">ğŸ“‹ Kopyala</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-4 pt-4">
                            <button onclick="saveUserEdit()" class="flex-1 py-4 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-black uppercase text-xs tracking-widest transition-all shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Kaydet
                            </button>
                            <button onclick="closeModal('user-modal')" class="flex-1 py-4 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 font-black uppercase text-xs tracking-widest border border-white/10 transition-all">Ä°ptal</button>
                        </div>
                        
                        <!-- Delete Button -->
                        <div class="pt-4 border-t border-white/5">
                            <button onclick="confirmDeleteUser()" class="w-full py-3 rounded-xl bg-red-500/10 hover:bg-red-600 text-red-500 hover:text-white font-black uppercase text-xs tracking-widest transition-all border border-red-500/30 flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                KullanÄ±cÄ±yÄ± Sil
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Delete Confirmation Modal -->
            <div id="delete-user-modal" class="fixed inset-0 z-[300] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                <div class="bg-[#1a1d2d] w-full max-w-md rounded-2xl border border-red-500/30 shadow-2xl p-8 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    </div>
                    <h3 class="text-xl font-black text-white mb-2">KullanÄ±cÄ±yÄ± Sil?</h3>
                    <p id="deleteUserName" class="text-gray-400 mb-6">Bu kullanÄ±cÄ± kalÄ±cÄ± olarak silinecek.</p>
                    <div class="flex gap-4">
                        <button onclick="executeDeleteUser()" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-black uppercase text-xs transition-all">Evet, Sil</button>
                        <button onclick="closeModal('delete-user-modal')" class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 font-black uppercase text-xs border border-white/10 transition-all">Ä°ptal</button>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<style>
/* Smooth View Switch Animation */
.tab-content { transition: all 0.4s ease; }
.scrollbar-hide::-webkit-scrollbar { display: none; }
</style>
{% endblock %}
"""

# Exchange API Template


# Portfolio Analytics Template


MARKET_ANALYSIS_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f] font-sans text-gray-100">
    <!-- Main Content -->
    <div class="p-6 md:p-8 pt-16 lg:pt-8">
        <div class="max-w-7xl mx-auto space-y-8">
            
            <!-- Header -->
            <div class="flex flex-col xl:flex-row xl:items-center justify-between gap-6">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                        Piyasa Analizi
                    </h1>
                    <p class="text-gray-400 text-sm">KapsamlÄ± kripto para piyasa istihbaratÄ±</p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 w-full xl:w-auto">
                    <!-- Actions -->
                    <div class="flex items-center gap-3">
                         <div class="flex items-center gap-2 px-3 py-2 bg-[#111] border border-white/10 rounded-lg">
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            <span class="text-xs font-medium text-gray-400">CanlÄ± Veri</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="border-b border-white/10">
                <div class="flex items-center gap-1 overflow-x-auto pb-1 hide-scrollbar">
                    <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active group flex items-center gap-2 px-4 py-3 rounded-t-lg bg-[#111] border-b-2 border-blue-500 text-white transition-all min-w-max">
                        <span class="text-sm font-medium">Genel BakÄ±ÅŸ</span>
                    </button>
                    <button onclick="switchTab('orderbook')" id="tab-orderbook" class="tab-btn group flex items-center gap-2 px-4 py-3 rounded-t-lg text-gray-400 hover:text-white hover:bg-[#111] border-b-2 border-transparent hover:border-white/10 transition-all min-w-max">
                        <span class="text-sm font-medium">Emir Defteri</span>
                    </button>
                    <button onclick="switchTab('screener')" id="tab-screener" class="tab-btn group flex items-center gap-2 px-4 py-3 rounded-t-lg text-gray-400 hover:text-white hover:bg-[#111] border-b-2 border-transparent hover:border-white/10 transition-all min-w-max">
                        <span class="text-sm font-medium">TarayÄ±cÄ±</span>
                    </button>
                    <button onclick="switchTab('heatmap')" id="tab-heatmap" class="tab-btn group flex items-center gap-2 px-4 py-3 rounded-t-lg text-gray-400 hover:text-white hover:bg-[#111] border-b-2 border-transparent hover:border-white/10 transition-all min-w-max">
                        <span class="text-sm font-medium">IsÄ± HaritasÄ±</span>
                    </button>
                    <button onclick="switchTab('technical')" id="tab-technical" class="tab-btn group flex items-center gap-2 px-4 py-3 rounded-t-lg text-gray-400 hover:text-white hover:bg-[#111] border-b-2 border-transparent hover:border-white/10 transition-all min-w-max">
                        <span class="text-sm font-medium">Teknik Analiz</span>
                    </button>
                    <button onclick="switchTab('news')" id="tab-news" class="tab-btn group flex items-center gap-2 px-4 py-3 rounded-t-lg text-gray-400 hover:text-white hover:bg-[#111] border-b-2 border-transparent hover:border-white/10 transition-all min-w-max">
                        <span class="text-sm font-medium">Haberler</span>
                    </button>
                     <button onclick="switchTab('alerts')" id="tab-alerts" class="tab-btn group flex items-center gap-2 px-4 py-3 rounded-t-lg text-gray-400 hover:text-white hover:bg-[#111] border-b-2 border-transparent hover:border-white/10 transition-all min-w-max">
                        <span class="text-sm font-medium">UyarÄ±lar</span>
                    </button>
                </div>
            </div>

            <!-- TAB CONTENT PLACEHOLDERS -->
            
            <!-- 1. OVERVIEW (Advanced Chart) -->
            <div id="content-overview" class="tab-content block animate-fade-in">
                <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl overflow-hidden h-[800px] w-full">
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                      <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                      <div class="tradingview-widget-copyright"><a href="https://tr.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">TradingView</span></a> platformundaki tÃ¼m piyasalarÄ± takip edin</div>
                      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                      {
                      "autosize": true,
                      "symbol": "BINANCE:BTCUSDT",
                      "interval": "60",
                      "timezone": "Etc/UTC",
                      "theme": "dark",
                      "style": "1",
                      "locale": "tr",
                      "withdateranges": true,
                      "hide_side_toolbar": false,
                      "allow_symbol_change": true,
                      "details": true,
                      "hotlist": true,
                      "calendar": false,
                      "studies": [
                        "RSI@tv-basicstudies",
                        "MASimple@tv-basicstudies",
                        "MACD@tv-basicstudies"
                      ],
                      "support_host": "https://www.tradingview.com"
                    }
                      </script>
                    </div>
                </div>
            </div>

            <!-- 2. ORDER BOOK (Depth Chart Proxy or Orderbook Widget) -->
            <!-- Note: TradingView does not provide a free raw orderbook widget. Using Symbol Info as nearest proxy for depth visualization. -->
            <div id="content-orderbook" class="tab-content hidden animate-fade-in">
                 <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl overflow-hidden h-[800px]">
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                      <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
                      {
                      "symbols": [
                        [
                          "BINANCE:BTCUSDT|1D"
                        ],
                        [
                          "BINANCE:ETHUSDT|1D"
                        ],
                        [
                          "BINANCE:SOLUSDT|1D"
                        ]
                      ],
                      "chartOnly": false,
                      "width": "100%",
                      "height": "100%",
                      "locale": "tr",
                      "colorTheme": "dark",
                      "autosize": true,
                      "showVolume": true,
                      "showMA": false,
                      "hideDateRanges": false,
                      "hideMarketStatus": false,
                      "hideSymbolLogo": false,
                      "scalePosition": "right",
                      "scaleMode": "Normal",
                      "fontFamily": "-apple-system, BlinkMacSystemFont, Trebuchet MS, Roboto, Ubuntu, sans-serif",
                      "fontSize": "10",
                      "noTimeScale": false,
                      "valuesTracking": "1",
                      "changeMode": "price-and-percent",
                      "chartType": "area",
                      "maLineColor": "#2962FF",
                      "maLineWidth": 1,
                      "maLength": 9,
                      "lineWidth": 2,
                      "lineType": 0,
                      "dateRanges": [
                        "1d|1",
                        "1m|30",
                        "3m|60",
                        "12m|1D",
                        "60m|1W",
                        "all|1M"
                      ]
                    }
                      </script>
                    </div>
                </div>
            </div>

            <!-- 3. SCREENER -->
            <div id="content-screener" class="tab-content hidden animate-fade-in">
                 <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl overflow-hidden h-[800px]">
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                      <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-screener.js" async>
                      {
                      "width": "100%",
                      "height": "100%",
                      "defaultColumn": "overview",
                      "defaultScreen": "general",
                      "market": "crypto",
                      "showToolbar": true,
                      "colorTheme": "dark",
                      "locale": "tr"
                    }
                      </script>
                    </div>
                </div>
            </div>

            <!-- 4. HEATMAP -->
            <div id="content-heatmap" class="tab-content hidden animate-fade-in">
                 <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl overflow-hidden h-[800px]">
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                      <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-crypto-coins-heatmap.js" async>
                      {
                      "dataSource": "Crypto",
                      "blockSize": "market_cap_calc",
                      "blockColor": "change",
                      "locale": "tr",
                      "symbolUrl": "",
                      "colorTheme": "dark",
                      "hasTopBar": false,
                      "isDataSetEnabled": false,
                      "isZoomEnabled": true,
                      "hasSymbolTooltip": true,
                      "width": "100%",
                      "height": "100%"
                    }
                      </script>
                    </div>
                </div>
            </div>

            <!-- 5. TECHNICAL ANALYSIS -->
            <div id="content-technical" class="tab-content hidden animate-fade-in">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- BTC -->
                    <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl overflow-hidden h-[450px]">
                        <div class="tradingview-widget-container" style="height:100%;width:100%">
                          <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                          {
                          "interval": "1h",
                          "width": "100%",
                          "isTransparent": false,
                          "height": "100%",
                          "symbol": "BINANCE:BTCUSDT",
                          "showIntervalTabs": true,
                          "displayMode": "single",
                          "locale": "tr",
                          "colorTheme": "dark"
                        }
                          </script>
                        </div>
                    </div>
                    <!-- ETH -->
                    <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl overflow-hidden h-[450px]">
                        <div class="tradingview-widget-container" style="height:100%;width:100%">
                          <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                          {
                          "interval": "1h",
                          "width": "100%",
                          "isTransparent": false,
                          "height": "100%",
                          "symbol": "BINANCE:ETHUSDT",
                          "showIntervalTabs": true,
                          "displayMode": "single",
                          "locale": "tr",
                          "colorTheme": "dark"
                        }
                          </script>
                        </div>
                    </div>
                    <!-- SOL -->
                    <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl overflow-hidden h-[450px]">
                        <div class="tradingview-widget-container" style="height:100%;width:100%">
                          <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                          {
                          "interval": "1h",
                          "width": "100%",
                          "isTransparent": false,
                          "height": "100%",
                          "symbol": "BINANCE:SOLUSDT",
                          "showIntervalTabs": true,
                          "displayMode": "single",
                          "locale": "tr",
                          "colorTheme": "dark"
                        }
                          </script>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- 6. NEWS -->
            <div id="content-news" class="tab-content hidden animate-fade-in">
                 <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl overflow-hidden h-[800px]">
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                      <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                      {
                      "feedMode": "all_symbols",
                      "isTransparent": false,
                      "displayMode": "regular",
                      "width": "100%",
                      "height": "100%",
                      "colorTheme": "dark",
                      "locale": "tr"
                    }
                      </script>
                    </div>
                </div>
            </div>
            
            <!-- 7. ALERTS (Placeholder) -->
             <div id="content-alerts" class="tab-content hidden animate-fade-in">
                 <div class="rounded-2xl bg-[#111] border border-white/5 shadow-2xl p-8 flex flex-col items-center justify-center text-center h-[400px]">
                    <div class="text-5xl mb-4">ğŸ””</div>
                    <h2 class="text-2xl font-bold text-white mb-2">Fiyat UyarÄ±larÄ±</h2>
                    <p class="text-gray-400 max-w-md">Ã‡ok yakÄ±nda! TradingView sinyalleri ile entegre edilmiÅŸ, SMS ve E-posta destekli Ã¶zel uyarÄ± sistemi.</p>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
/* CSS Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
}

/* Custom Scrollbar for Filters */
.overflow-x-auto::-webkit-scrollbar {
    height: 4px;
}
.overflow-x-auto::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}
.overflow-x-auto::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
}
</style>

<script>
    // Tab Switching Logic
    function switchTab(tabId) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
            content.classList.remove('block');
        });
        
        // Remove active state from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-[#111]', 'border-blue-500', 'text-white');
            btn.classList.add('text-gray-400', 'border-transparent');
            
            // Reset icons
            const icon = btn.querySelector('svg');
            if(icon) {
                 icon.classList.remove('text-blue-400'); // Assuming blue was active color
                 icon.classList.add('text-gray-400');
            }
        });
        
        // Show selected tab
        const selectedContent = document.getElementById('content-' + tabId);
        if(selectedContent) {
            selectedContent.classList.remove('hidden');
            selectedContent.classList.add('block');
        }
        
        // Set active state on clicked button
        const selectedBtn = document.getElementById('tab-' + tabId);
        if(selectedBtn) {
            selectedBtn.classList.add('active', 'bg-[#111]', 'border-blue-500', 'text-white');
            selectedBtn.classList.remove('text-gray-400', 'border-transparent');
        }
    }
</script>
{% endblock %}
"""

# P&L Reporting Center Template (Kar/Zarar Raporu)
PNL_REPORTING_CENTER_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    {{ sidebar | safe }}

    <!-- Main Content -->
     <div class="lg:ml-64 p-4 md:p-8 pt-16 lg:pt-8">
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- Header -->
             <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                     <h1 class="text-3xl font-bold text-white mb-2">Kar/Zarar Raporu</h1>
                    <p class="text-sm text-gray-400">AylÄ±k ve yÄ±llÄ±k detaylÄ± performans analizi</p>
                </div>
                 <button onclick="exportReport()" class="px-4 py-2 rounded-lg bg-[#242424] text-white hover:bg-[#2a2a2a] transition-colors border border-white/10 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Rapor Ä°ndir
                 </button>
            </div>

            <!-- Filters -->
             <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-4">
                 <div class="flex flex-wrap items-center gap-4">
                    <div class="space-y-1">
                        <label class="text-xs text-gray-400">GÃ¶rÃ¼nÃ¼m</label>
                        <select class="bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none">
                            <option value="monthly">AylÄ±k</option>
                            <option value="yearly">YÄ±llÄ±k</option>
                        </select>
                    </div>
                     <div class="space-y-1">
                        <label class="text-xs text-gray-400">YÄ±l</label>
                        <select class="bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none">
                            <option>2024</option>
                            <option>2023</option>
                        </select>
                    </div>
                     <div class="space-y-1">
                        <label class="text-xs text-gray-400">Borsa</label>
                        <select class="bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none">
                            <option value="all">TÃ¼mÃ¼</option>
                            <option value="Binance">Binance</option>
                            <option value="OKX">OKX</option>
                        </select>
                    </div>
                     <div class="space-y-1">
                        <label class="text-xs text-gray-400">Parite</label>
                        <select class="bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none">
                            <option value="all">TÃ¼mÃ¼</option>
                            <option value="BTC/USDT">BTC/USDT</option>
                            <option value="ETH/USDT">ETH/USDT</option>
                        </select>
                    </div>
                     <div class="space-y-1">
                        <label class="text-xs text-gray-400">Strateji</label>
                        <select class="bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none">
                            <option value="all">TÃ¼mÃ¼</option>
                            <option value="Scalping">Scalping</option>
                            <option value="Swing">Swing</option>
                        </select>
                    </div>
                     <div class="flex-1"></div>
                     <button class="px-4 py-2 mt-auto rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm font-medium">Filtrele</button>
                 </div>
            </div>

            <!-- Metrics Cards -->
             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <p class="text-sm text-gray-400 mb-1">Toplam Kar</p>
                    <div class="text-2xl font-bold text-gray-500">$0.00</div>
                </div>
                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <p class="text-sm text-gray-400 mb-1">GerÃ§ekleÅŸen</p>
                    <div class="text-2xl font-bold text-gray-500">$0.00</div>
                </div>
                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <p class="text-sm text-gray-400 mb-1">Komisyonlar</p>
                    <div class="text-2xl font-bold text-gray-500">$0.00</div>
                </div>
                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <p class="text-sm text-gray-400 mb-1">BaÅŸarÄ± OranÄ±</p>
                    <div class="text-2xl font-bold text-gray-500">%0.0</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                <h3 class="text-lg font-bold text-white mb-6">Kar/Zarar GrafiÄŸi</h3>
                <div class="h-80 w-full">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>

            <!-- Transactions Table -->
             <div class="bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden">
                <div class="p-6 border-b border-white/10">
                    <h3 class="text-lg font-bold text-white">Ä°ÅŸlem DetaylarÄ±</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-black/20 text-gray-400 text-xs uppercase font-medium">
                            <tr>
                                <th class="px-6 py-4">Tarih</th>
                                <th class="px-6 py-4">Sembol</th>
                                <th class="px-6 py-4">Borsa</th>
                                <th class="px-6 py-4 text-right">Miktar</th>
                                <th class="px-6 py-4 text-right">AlÄ±ÅŸ</th>
                                <th class="px-6 py-4 text-right">SatÄ±ÅŸ</th>
                                <th class="px-6 py-4 text-right">Kar/Zarar</th>
                                <th class="px-6 py-4 text-center">ROI</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5 text-sm">
                            <!-- Real trade data will be populated here from real_trades table -->
                            <tr>
                                <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                    <div class="flex flex-col items-center gap-2">
                                        <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                        <p class="text-sm">HenÃ¼z REAL modda kapalÄ± iÅŸlem yok</p>
                                        <p class="text-xs text-gray-600">Real modda iÅŸlem yaptÄ±ÄŸÄ±nÄ±zda burada gÃ¶rÃ¼necek</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('pnlChart').getContext('2d');
        
        // Mock data
        const labels = ['1 Jan', '5 Jan', '10 Jan', '15 Jan', '20 Jan', '25 Jan', '30 Jan'];
        const data = [100, 250, 180, 320, 290, 450, 410];
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'KÃ¼mÃ¼latif Kar (USDT)',
                    data: data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#1a1a1a',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#242424',
                        titleColor: '#fff',
                        bodyColor: '#9ca3af',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255,255,255,0.05)'
                        },
                        ticks: {
                            color: '#9ca3af'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255,255,255,0.05)'
                        },
                        ticks: {
                            color: '#9ca3af',
                            callback: function(value) {
                                return '$' + value;
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
            }
        });
    });

    function exportReport() {
        alert('Rapor indirme iÅŸlemi baÅŸlatÄ±ldÄ±. (PDF/CSV)');
    }
</script>
{% endblock %}
"""


UNIFIED_RISK_DASHBOARD_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    {{ sidebar | safe }}

    <!-- Main Content -->
     <div class="lg:ml-64 p-4 md:p-8 pt-16 lg:pt-8">
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                     <h1 class="text-3xl font-bold text-white mb-2">BirleÅŸik Risk YÃ¶netimi</h1>
                    <p class="text-sm text-gray-400">TÃ¼m borsalar iÃ§in merkezi risk kontrol paneli</p>
                </div>
                 <div class="flex flex-col sm:flex-row gap-3">
                     <button onclick="emergencyHalt()" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors font-bold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Acil Durdur
                     </button>
                      <button onclick="saveSettings()" id="saveBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors font-bold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                        AyarlarÄ± Kaydet
                     </button>
                 </div>
            </div>

            <!-- Current Metrics Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                             <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                             <span class="text-2xl font-bold text-green-400">2.4%</span>
                        </div>
                        <p class="text-sm text-gray-400">Mevcut Drawdown</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/5">
                        <p class="text-xs text-gray-500">Limit: %15</p>
                    </div>
                </div>
                
                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                             <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                             <span class="text-2xl font-bold text-green-400">$120</span>
                        </div>
                        <p class="text-sm text-gray-400">GÃ¼nlÃ¼k Zarar</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/5">
                        <p class="text-xs text-gray-500">Limit: $500</p>
                    </div>
                </div>

                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                             <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                             <span class="text-2xl font-bold text-white">3</span>
                        </div>
                        <p class="text-sm text-gray-400">AÃ§Ä±k Pozisyonlar</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/5">
                        <p class="text-xs text-gray-500">Limit: 5</p>
                    </div>
                </div>

                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6 flex flex-col justify-between bg-green-500/10">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                             <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                             <span class="text-2xl font-bold text-green-500">AKTÄ°F</span>
                        </div>
                        <p class="text-sm text-green-400/80">Ä°ÅŸlem Durumu</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-green-500/20">
                        <p class="text-xs text-green-500/80">TÃ¼m Borsalar</p>
                    </div>
                </div>
            </div>

            <!-- Global Risk Limits -->
             <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                <div class="flex items-center gap-2 mb-6">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    <h2 class="text-2xl font-bold text-white">Global Risk Limitleri</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Maksimum Drawdown (%)</label>
                        <input type="number" class="w-full bg-[#242424] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" value="15">
                        <p class="text-xs text-gray-500">PortfÃ¶y deÄŸerindeki maksimum dÃ¼ÅŸÃ¼ÅŸ</p>
                    </div>
                     <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">GÃ¼nlÃ¼k Zarar Limiti (USDT)</label>
                        <input type="number" class="w-full bg-[#242424] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" value="500">
                        <p class="text-xs text-gray-500">GÃ¼nlÃ¼k maksimum zarar tutarÄ±</p>
                    </div>
                     <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Maksimum KaldÄ±raÃ§ (x)</label>
                        <input type="number" class="w-full bg-[#242424] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" value="3">
                        <p class="text-xs text-gray-500">Ä°zin verilen maksimum kaldÄ±raÃ§</p>
                    </div>
                     <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Maksimum AÃ§Ä±k Pozisyon</label>
                        <input type="number" class="w-full bg-[#242424] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" value="5">
                        <p class="text-xs text-gray-500">AÃ§Ä±k olabilecek maksimum iÅŸlem</p>
                    </div>
                </div>
            </div>

            <!-- Position Size Caps & Auto Halt -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Position Size Caps -->
                 <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                     <div class="flex items-center gap-2 mb-6">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        <h2 class="text-xl font-bold text-white">Parite BazlÄ± Limitler (USDT)</h2>
                     </div>
                     
                     <div class="space-y-4">
                         <div class="flex items-center justify-between p-3 bg-[#242424] rounded-lg border border-white/5">
                             <span class="font-medium text-white">BTC/USDT</span>
                             <div class="flex items-center gap-2">
                                <input type="number" class="w-24 bg-[#1a1a1a] border border-white/10 rounded px-2 py-1 text-right text-white text-sm" value="1000">
                                <span class="text-xs text-gray-500">USDT</span>
                             </div>
                         </div>
                         <div class="flex items-center justify-between p-3 bg-[#242424] rounded-lg border border-white/5">
                             <span class="font-medium text-white">ETH/USDT</span>
                             <div class="flex items-center gap-2">
                                <input type="number" class="w-24 bg-[#1a1a1a] border border-white/10 rounded px-2 py-1 text-right text-white text-sm" value="800">
                                <span class="text-xs text-gray-500">USDT</span>
                             </div>
                         </div>
                         <div class="flex items-center justify-between p-3 bg-[#242424] rounded-lg border border-white/5">
                             <span class="font-medium text-white">SOL/USDT</span>
                             <div class="flex items-center gap-2">
                                <input type="number" class="w-24 bg-[#1a1a1a] border border-white/10 rounded px-2 py-1 text-right text-white text-sm" value="600">
                                <span class="text-xs text-gray-500">USDT</span>
                             </div>
                         </div>
                     </div>
                 </div>

                 <!-- Auto Halt Settings -->
                  <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                     <div class="flex items-center gap-2 mb-6">
                        <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        <h2 class="text-xl font-bold text-white">Otomatik Durdurma</h2>
                     </div>
                     
                     <div class="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg mb-6">
                         <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-yellow-500 mb-1">Otomatik Durdurma Etkin</h3>
                                <p class="text-xs text-yellow-200/70">Limitler aÅŸÄ±ldÄ±ÄŸÄ±nda sistem otomatik olarak durur.</p>
                            </div>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="haltToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                <label for="haltToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-yellow-500 cursor-pointer"></label>
                            </div>
                         </div>
                     </div>
                     
                     <div class="space-y-4">
                         <div class="bg-[#242424] p-4 rounded-lg border border-white/5">
                            <label class="block text-sm text-gray-400 font-medium mb-2">Durdurma Drawdown EÅŸiÄŸi (%)</label>
                            <input type="number" class="w-full bg-[#1a1a1a] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" value="20">
                            <p class="text-xs text-gray-500 mt-2">Bu drawdown seviyesine ulaÅŸÄ±lÄ±rsa tÃ¼m iÅŸlemler anÄ±nda durdurulur.</p>
                         </div>
                     </div>
                  </div>
            </div>

            <!-- Exchange Coverage -->
             <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                <h3 class="font-bold text-white mb-4">Aktif Borsa KapsamÄ±</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="p-3 bg-[#242424] rounded-lg border border-white/5 text-center">
                        <div class="text-green-500 mb-1"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <span class="text-gray-300 font-medium text-sm">Binance</span>
                    </div>
                     <div class="p-3 bg-[#242424] rounded-lg border border-white/5 text-center">
                        <div class="text-green-500 mb-1"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <span class="text-gray-300 font-medium text-sm">OKX</span>
                    </div>
                     <div class="p-3 bg-[#242424] rounded-lg border border-white/5 text-center">
                        <div class="text-green-500 mb-1"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <span class="text-gray-300 font-medium text-sm">Bybit</span>
                    </div>
                     <div class="p-3 bg-[#242424] rounded-lg border border-white/5 text-center">
                        <div class="text-green-500 mb-1"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <span class="text-gray-300 font-medium text-sm">Gate.io</span>
                    </div>
                     <div class="p-3 bg-[#242424] rounded-lg border border-white/5 text-center">
                        <div class="text-green-500 mb-1"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <span class="text-gray-300 font-medium text-sm">BTCTURK</span>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function saveSettings() {
        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerText = 'Kaydediliyor...';
        
        // Mock save
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Risk ayarlarÄ± baÅŸarÄ±yla kaydedildi!');
        }, 1000);
    }
    
    function emergencyHalt() {
        if(confirm('DÄ°KKAT: TÃ¼m borsalardaki iÅŸlemleri durdurmak istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz.')) {
            alert('TÃ¼m iÅŸlemler ACÄ°L olarak durduruldu!');
        }
    }
</script>
{% endblock %}
"""


LIVE_TRADING_CHAT_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    {{ sidebar | safe }}

    <!-- Main Content -->
     <div class="lg:ml-64 p-4 h-screen overflow-hidden flex flex-col pt-16 lg:pt-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4 flex-shrink-0">
            <div>
                 <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                    CanlÄ± Trading Sohbet
                 </h1>
                 <p class="text-sm text-gray-400">Trader'larla stratejileri tartÄ±ÅŸÄ±n ve sinyalleri paylaÅŸÄ±n</p>
            </div>
             <div class="flex items-center gap-2">
                 <label class="flex items-center gap-2 cursor-pointer">
                     <input type="checkbox" id="anonCheck" class="form-checkbox bg-[#242424] border-white/10 rounded text-blue-600">
                     <span class="text-sm text-gray-400">Anonim yaz</span>
                 </label>
             </div>
        </div>

        <!-- 3-Column Layout -->
        <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 min-h-0">
             <!-- Left Panel: Rooms -->
             <div class="hidden lg:block lg:col-span-3 bg-[#1a1a1a] rounded-xl border border-white/10 flex flex-col min-h-0">
                 <div class="p-4 border-b border-white/10">
                     <h2 class="font-bold text-white flex items-center gap-2">
                         <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                         Sohbet OdalarÄ±
                     </h2>
                 </div>
                 <div class="flex-1 overflow-y-auto p-2 space-y-2" id="roomList">
                     <!-- Populated by JS -->
                 </div>
             </div>

             <!-- Center Panel: Chat -->
             <div class="lg:col-span-6 col-span-12 bg-[#1a1a1a] rounded-xl border border-white/10 flex flex-col flex-1 min-h-0">
                <!-- Room Header -->
                 <div class="p-4 border-b border-white/10 flex items-center justify-between flex-shrink-0">
                     <div>
                         <h3 class="font-bold text-white" id="currentRoomName">Bitcoin (BTC)</h3>
                         <p class="text-xs text-gray-400" id="currentRoomDesc">Bitcoin analizi ve tartÄ±ÅŸmalarÄ±</p>
                     </div>
                     <div class="text-xs text-blue-400 bg-blue-400/10 px-2 py-1 rounded-full flex items-center gap-1">
                         <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                         <span id="activeUserCount">125</span> aktif
                     </div>
                 </div>

                 <!-- Messages Area -->
                 <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messagesArea">
                      <!-- Populated by JS -->
                 </div>

                 <!-- Signal Sending UI -->
                 <div class="p-3 border-t border-white/10 bg-[#1a1a1a]">
                     <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                         <div class="flex items-center gap-2 mb-2">
                             <span class="text-yellow-400 font-medium text-sm">ğŸ“Š Sinyal PaylaÅŸ</span>
                         </div>
                         <div class="flex flex-wrap gap-2">
                             <select id="signalCoinSelect" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white text-sm">
                                 <option value="BTC/USDT">BTC/USDT</option>
                                 <option value="ETH/USDT">ETH/USDT</option>
                                 <option value="SOL/USDT">SOL/USDT</option>
                                 <option value="XRP/USDT">XRP/USDT</option>
                                 <option value="BNB/USDT">BNB/USDT</option>
                             </select>
                             <select id="signalActionSelect" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white text-sm">
                                 <option value="AL">ğŸ“ˆ AL</option>
                                 <option value="SAT">ğŸ“‰ SAT</option>
                             </select>
                             <input type="text" id="signalTargetInput" placeholder="Hedef: +0.5%" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white text-sm w-28">
                             <button onclick="sendChatSignal()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                 GÃ¶nder
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Message Input -->
                 <div class="p-4 border-t border-white/10 flex-shrink-0 bg-[#242424]">
                     <div class="flex gap-2">
                         <input type="text" id="messageInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." class="flex-1 bg-[#1a1a1a] border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500" onkeypress="handleKeyPress(event)">
                         <button onclick="sendMessage()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                         </button>
                     </div>
                 </div>
             </div>

              <!-- Right Panel: Members -->
             <div class="hidden lg:block lg:col-span-3 bg-[#1a1a1a] rounded-xl border border-white/10 flex flex-col min-h-0">
                  <div class="p-4 border-b border-white/10">
                     <h2 class="font-bold text-white flex items-center gap-2">
                         <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                         KatÄ±lÄ±mcÄ±lar
                     </h2>
                 </div>
                 <div class="flex-1 overflow-y-auto p-2 space-y-2" id="memberList">
                      <!-- Populated by JS -->
                 </div>
             </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const rooms = [
        { id: 1, name: 'USDT/TRY Trading', code: 'USDT_TRY', desc: 'Tether TRY paritesi analiz odasÄ±', online: 5, messages: 234 },
        { id: 2, name: 'BTC/TRY Trading', code: 'BTC_TRY', desc: 'Bitcoin TRY paritesi tartÄ±ÅŸmalarÄ±', online: 1, messages: 108 },
        { id: 3, name: 'ETH/TRY Trading', code: 'ETH_TRY', desc: 'Ethereum TRY analiz ve tartÄ±ÅŸma', online: 1, messages: 89 },
        { id: 4, name: 'Genel TartÄ±ÅŸma', code: 'GENERAL', desc: 'Genel kripto para tartÄ±ÅŸmalarÄ±', online: 1, messages: 188 },
        { id: 5, name: 'â­ VIP Oda', code: 'VIP', desc: 'Sadece VIP Ã¼yeler iÃ§in Ã¶zel sohbet', online: 8, messages: 512, isVip: true }
    ];

    let currentRoomId = 1;
    let currentUser = "{{ session.get('full_name', 'Ben') }}"; 
    
    // Mock user list generator
    function generateMockUsers(count) {
        const names = ['CryptoKing', 'Mehmet_YFan', 'WhaleWatcher', 'HodlGange', 'ToTheMoon', 'BearHunter', 'BullRunner'];
        const users = [];
        for(let i=0; i<count; i++) {
             users.push({
                 name: names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random()*100),
                 role: Math.random() > 0.9 ? 'admin' : 'user',
                 status: 'online'
             });
        }
        return users;
    }

    function renderRooms() {
        const container = document.getElementById('roomList');
        container.innerHTML = rooms.map(room => `
            <button onclick="switchRoom(${room.id})" 
                class="w-full text-left p-3 rounded-lg flex items-center justify-between group transition-colors ${currentRoomId === room.id ? 'bg-blue-600/10 border border-blue-600/30' : 'hover:bg-white/5 border border-transparent'}">
                <div>
                    <div class="font-medium ${currentRoomId === room.id ? 'text-blue-400' : 'text-gray-300 group-hover:text-white'}">${room.name}</div>
                    <div class="text-xs text-gray-500 truncate max-w-[150px]">${room.desc}</div>
                </div>
                ${currentRoomId === room.id ? '<div class="w-2 h-2 rounded-full bg-blue-500"></div>' : ''}
            </button>
        `).join('');
    }
    
    async function renderMembers() {
        const container = document.getElementById('memberList');
        try {
            const response = await fetch('/api/chat/users');
            const data = await response.json();
            const users = data.users || [];
            
            document.getElementById('activeUserCount').innerText = users.length;
            
            container.innerHTML = users.map(name => `
                <div class="flex items-center gap-3 p-2 rounded hover:bg-white/5 transition-colors">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-700 to-gray-600 flex items-center justify-center text-xs font-bold text-white uppercase border border-white/10">
                        ${name.substring(0,2)}
                    </div>
                    <div class="flex-1 min-w-0">
                         <div class="text-sm font-medium text-gray-300 truncate flex items-center gap-2">
                            ${name}
                         </div>
                         <div class="text-xs text-green-500 flex items-center gap-1">
                             <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Ã‡evrimiÃ§i
                         </div>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error(e);
        }
    }
    
    // Mock messages
    let messages = [
        { id: 1, user: 'System', text: 'Sohbet odasÄ±na hoÅŸgeldiniz!', time: '10:00', type: 'system' }
    ];

    function renderMessages() {
        const container = document.getElementById('messagesArea');
        if (!container) {
            console.error('[CHAT] messagesArea element NOT FOUND!');
            return;
        }
        console.log('[CHAT] messagesArea found, rendering to:', container);
        
        container.innerHTML = messages.map(msg => {
            if (msg.type === 'system') {
                return `
                    <div class="flex justify-center my-4">
                        <span class="text-xs text-gray-500 bg-white/5 px-3 py-1 rounded-full">${msg.text}</span>
                    </div>
                `;
            }
            const isMe = msg.user === 'Ben' || msg.user === currentUser;
            return `
                <div class="flex gap-3 ${isMe ? 'flex-row-reverse' : ''}">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br ${isMe ? 'from-blue-600 to-blue-500' : 'from-gray-700 to-gray-600'} flex-shrink-0 flex items-center justify-center text-xs font-bold text-white uppercase">
                        ${msg.user.substring(0,2)}
                    </div>
                    <div class="max-w-[70%]">
                        <div class="flex items-center gap-2 mb-1 ${isMe ? 'flex-row-reverse' : ''}">
                            <span class="text-xs font-bold ${isMe ? 'text-blue-400' : 'text-gray-300'}">${msg.user}</span>
                            <span class="text-[10px] text-gray-500">${msg.time}</span>
                        </div>
                        <div class="p-3 rounded-xl ${isMe ? 'bg-blue-600/20 text-blue-100 rounded-tr-none border border-blue-600/20' : 'bg-[#242424] text-gray-200 rounded-tl-none border border-white/5'} text-sm">
                            ${msg.text}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        container.scrollTop = container.scrollHeight;
        console.log('[CHAT] Rendered', messages.length, 'messages, innerHTML length:', container.innerHTML.length);
    }

    function switchRoom(id) {
        currentRoomId = id;
        const room = rooms.find(r => r.id === id);
        document.getElementById('currentRoomName').innerText = room.name;
        document.getElementById('currentRoomDesc').innerText = room.desc;
        
        messages = [{ id: Date.now(), user: 'System', text: `${room.name} odasÄ±na katÄ±ldÄ±nÄ±z.`, time: new Date().toLocaleTimeString().substring(0,5), type: 'system' }];
        renderRooms();
        renderMessages();
        renderMembers();
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if(!text) return;
        
        const isAnon = document.getElementById('anonCheck').checked;
        const user = isAnon ? 'Anonim' : currentUser;
        
        // Send to API
        fetch('/api/chat_poll', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ message: text, anonymous: isAnon })
        }).then(response => {
            if(response.ok) {
                input.value = '';
                fetchMessages(); // Refresh messages immediately
            }
        }).catch(err => console.error('Send error:', err));
    }
    
    function handleKeyPress(e) {
        if(e.key === 'Enter') sendMessage();
    }
    
    // Fetch messages from API
    async function fetchMessages() {
        try {
            const response = await fetch('/api/chat_poll', { credentials: 'include' });
            const data = await response.json();
            
            console.log('[CHAT] fetchMessages response:', data);
            
            if(data.ok && data.messages) {
                console.log('[CHAT] Got', data.messages.length, 'messages');
                
                // Always start with system message
                messages = [{ id: 0, user: 'System', text: 'Sohbet odasÄ±na hoÅŸgeldiniz!', time: '00:00', type: 'system' }];
                
                data.messages.forEach(msg => {
                    let date;
                    if (typeof msg.created_at === 'number') {
                        // Unix timestamp (seconds)
                        date = new Date(msg.created_at * 1000);
                    } else if (msg.created_at) {
                        // ISO string or other format
                        date = new Date(msg.created_at);
                    } else {
                        date = new Date();
                    }
                    const timeStr = isNaN(date.getTime()) ? '--:--' : date.toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});
                    messages.push({
                        id: msg.id,
                        user: msg.username || 'Anonim',
                        text: msg.message,
                        time: timeStr,
                        type: 'user'
                    });
                });
                
                console.log('[CHAT] Rendering', messages.length, 'messages');
                renderMessages();
            } else {
                console.warn('[CHAT] No messages or response not OK:', data);
            }
        } catch(err) {
            console.error('Fetch messages error:', err);
        }
    }

    // Alias for legacy calls
    function loadMessages() { return fetchMessages(); }


    // Init
    renderRooms();
    renderMessages();
    renderMembers();
    
    // Start polling for new messages every 5 seconds
    fetchMessages();
    setInterval(fetchMessages, 5000);


async function sendSignal() {
    const coin = document.getElementById('signalCoin').value;
    const action = document.getElementById('signalAction').value;
    const target = document.getElementById('signalTarget').value || '+0.5%';
    
    try {
        const res = await fetch('/api/chat/signal', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({coin, action, target})
        });
        const data = await res.json();
        if (data.ok) {
            document.getElementById('signalTarget').value = '';
            loadMessages();
            alert('âœ… Sinyal paylaÅŸÄ±ldÄ±!');
        } else {
            alert('âŒ ' + (data.error || 'Hata'));
        }
    } catch(e) {
        alert('âŒ BaÄŸlantÄ± hatasÄ±');
    }
}


// Send signal to chat
async function sendChatSignal() {
    const coin = document.getElementById('signalCoinSelect')?.value || 'BTC/USDT';
    const action = document.getElementById('signalActionSelect')?.value || 'AL';
    const target = document.getElementById('signalTargetInput')?.value || '+0.5%';
    
    // Send as chat message with signal format
    const signalMsg = 'ğŸ“Š ' + action + ' Sinyali: ' + coin + ' - Hedef: ' + target;
    
    try {
        const res = await fetch('/api/chat_poll', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: signalMsg, room: currentRoomId})
        });
        const data = await res.json();
        if (data.ok) {
            document.getElementById('signalTargetInput').value = '';
            loadMessages();
        } else {
            alert('Hata: ' + (data.error || 'Sinyal gÃ¶nderilemedi'));
        }
    } catch(e) {
        console.error(e);
        alert('BaÄŸlantÄ± hatasÄ±');
    }
}

</script>
{% endblock %}
"""


# Arbitrage Monitor Template (Arbitraj Takibi)



GETTING_STARTED_GUIDE_TEMPLATE_DEPRECATED = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    <!-- Sidebar -->
    <div class="fixed left-0 top-0 h-full w-16 md:w-64 bg-[#1a1a1a] border-r border-white/10 z-50">
        <div class="flex flex-col h-full">
             <div class="p-4 border-b border-white/10">
                <a href="/dashboard" class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center"><span class="text-white text-lg font-bold">â‚¿</span></div>
                    <span class="hidden md:block text-white font-semibold">Atalay Ulusoy</span>
                </a>
            </div>
            <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
                <a href="/admin" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-red-400 hover:bg-gray-800 transition-colors"><span class="text-lg">âš™ï¸</span><span class="hidden md:block text-sm">Admin Panel</span></a>
                <a href="/trading-dashboard" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ“Š</span><span class="hidden md:block text-sm">Dashboard</span></a>
                <a href="/live-trading-chat" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ’¬</span><span class="hidden md:block text-sm">CanlÄ± Sohbet</span></a>
                <a href="/ai-trade-recommendations" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ¤–</span><span class="hidden md:block text-sm">AI Ã–nerileri</span></a>
                <a href="/arbitrage-monitor" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ“ˆ</span><span class="hidden md:block text-sm">Arbitraj Takibi</span></a>
                <a href="/pnl-reporting-center" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ’°</span><span class="hidden md:block text-sm">Kar/Zarar Raporu</span></a>
                <a href="/education-hub" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ“</span><span class="hidden md:block text-sm">EÄŸitim Merkezi</span></a>
                <a href="/market-analysis" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ“‰</span><span class="hidden md:block text-sm">Market Analysis</span></a>
                <a href="/trade-history" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ“‹</span><span class="hidden md:block text-sm">Trade History</span></a>
                <a href="/portfolio-analytics" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ§®</span><span class="hidden md:block text-sm">Portfolio Analytics</span></a>
                <a href="/payment-management" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ’³</span><span class="hidden md:block text-sm">Ã–deme YÃ¶netimi</span></a>
                <a href="/getting-started-guide" class="sidebar-link active flex items-center gap-3 px-3 py-2 rounded-lg bg-blue-600 text-white"><span class="text-lg">ğŸ“–</span><span class="hidden md:block text-sm">BaÅŸlangÄ±Ã§ KÄ±lavuzu</span></a>
                <a href="/api-validation" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ”—</span><span class="hidden md:block text-sm">API DoÄŸrulama</span></a>
                <a href="/system-health" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ”§</span><span class="hidden md:block text-sm">Sistem SaÄŸlÄ±ÄŸÄ±</span></a>
                <a href="/exchange-api" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ”‘</span><span class="hidden md:block text-sm">Exchange API</span></a>
                <a href="/notifications" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors"><span class="text-lg">ğŸ””</span><span class="hidden md:block text-sm">Bildirimler</span></a>
            </nav>
            <div class="p-3 border-t border-white/10">
                <div class="hidden md:block">
                    <div class="flex items-center justify-between mb-2"><span class="text-xs text-gray-500">Exchange Status</span><span class="text-xs text-gray-500">2/3</span></div>
                    <div class="space-y-1 text-xs">
                        <div class="flex items-center justify-between"><span class="text-gray-400">Binance</span><span class="text-green-400">â— connected</span></div>
                        <div class="flex items-center justify-between"><span class="text-gray-400">Coinbase</span><span class="text-green-400">â— connected</span></div>
                        <div class="flex items-center justify-between"><span class="text-gray-400">Kraken</span><span class="text-red-400">â— disconnected</span></div>
                        <div class="flex items-center justify-between"><span class="text-gray-400">Kucoin</span><span class="text-red-400">â— disconnected</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
     <div class="ml-16 md:ml-64 p-4 md:p-8">
        <div class="max-w-5xl mx-auto space-y-6">
            <!-- Header -->
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                <div class="flex items-center gap-4">
                    <div class="bg-gradient-to-br from-green-600 to-emerald-600 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white">BaÅŸlangÄ±Ã§ Rehberi</h1>
                        <p class="text-gray-400 text-sm">AdÄ±m adÄ±m kurulum ve test sÃ¼reci</p>
                    </div>
                </div>
            </div>

            <!-- Steps Progress -->
            <div class="flex items-center justify-between px-2 sm:px-10 mb-8 relative">
                 <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-800 -z-0"></div>
                 <div class="absolute top-1/2 left-0 h-1 bg-blue-600 -z-0 transition-all duration-500" id="progressBar" style="width: 0%"></div>
                 
                 <!-- Step 1 -->
                 <div class="relative z-10 flex flex-col items-center cursor-pointer" onclick="goToStep(1)">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center border-4 border-[#0f0f0f] text-white font-bold transition-colors" id="step1-circle">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                    </div>
                    <span class="mt-2 text-xs font-medium text-blue-400" id="step1-text">API AnahtarÄ±</span>
                 </div>
                 
                 <!-- Step 2 -->
                 <div class="relative z-10 flex flex-col items-center cursor-pointer" onclick="goToStep(2)">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center border-4 border-[#0f0f0f] text-gray-400 font-bold transition-colors" id="step2-circle">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                    </div>
                    <span class="mt-2 text-xs font-medium text-gray-400" id="step2-text">Entegrasyon</span>
                 </div>
                 
                 <!-- Step 3 -->
                  <div class="relative z-10 flex flex-col items-center cursor-pointer" onclick="goToStep(3)">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center border-4 border-[#0f0f0f] text-gray-400 font-bold transition-colors" id="step3-circle">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                    </div>
                    <span class="mt-2 text-xs font-medium text-gray-400" id="step3-text"></span>
                 </div>
                 
                 <!-- Step 4 -->
                  <div class="relative z-10 flex flex-col items-center cursor-pointer" onclick="goToStep(4)">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center border-4 border-[#0f0f0f] text-gray-400 font-bold transition-colors" id="step4-circle">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <span class="mt-2 text-xs font-medium text-gray-400" id="step4-text">Aktivasyon</span>
                 </div>
            </div>

            <!-- Content Container -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 md:p-8 border border-white/10 min-h-[400px]">
                
                <!-- Step 1 Content -->
                <div id="step1-content" class="step-content block">
                    <h2 class="text-2xl font-bold text-white mb-6">AdÄ±m 1: API AnahtarÄ± Alma</h2>
                    <p class="text-gray-400 mb-8">Ä°ÅŸlem yapmak istediÄŸiniz borsadan API anahtarÄ± almanÄ±z gerekiyor. AÅŸaÄŸÄ±daki borsalardan birini seÃ§erek detaylÄ± rehbere ulaÅŸabilirsiniz.</p>
                    
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                         <button onclick="selectExchange('Binance')" class="p-4 rounded-xl border-2 border-transparent bg-[#242424] hover:bg-[#2a2a2a] hover:border-blue-500/50 transition-all text-left">
                             <div class="w-10 h-10 rounded-lg bg-yellow-500/10 flex items-center justify-center mb-3">
                                <span class="text-yellow-500 font-bold">B</span>
                             </div>
                             <h3 class="font-bold text-white">Binance</h3>
                             <p class="text-xs text-gray-500 mt-1">Video rehber mevcut</p>
                         </button>
                         <button onclick="selectExchange('OKX')" class="p-4 rounded-xl border-2 border-transparent bg-[#242424] hover:bg-[#2a2a2a] hover:border-blue-500/50 transition-all text-left">
                             <div class="w-10 h-10 rounded-lg bg-black/30 flex items-center justify-center mb-3 text-white border border-white/10">
                                <span class="font-bold">OKX</span>
                             </div>
                             <h3 class="font-bold text-white">OKX</h3>
                             <p class="text-xs text-gray-500 mt-1">Video rehber mevcut</p>
                         </button>
                         <button onclick="selectExchange('Bybit')" class="p-4 rounded-xl border-2 border-transparent bg-[#242424] hover:bg-[#2a2a2a] hover:border-blue-500/50 transition-all text-left">
                             <div class="w-10 h-10 rounded-lg bg-yellow-500/10 flex items-center justify-center mb-3">
                                <span class="text-yellow-600 font-bold">BY</span>
                             </div>
                             <h3 class="font-bold text-white">Bybit</h3>
                             <p class="text-xs text-gray-500 mt-1">Video rehber mevcut</p>
                         </button>
                    </div>

                    <div id="exchange-guide" class="hidden mb-8 p-4 rounded-lg bg-blue-900/10 border border-blue-600/20">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <h4 class="font-bold text-white mb-2" id="exchange-name">Binance API Rehberi</h4>
                                <ol class="list-decimal list-inside text-sm text-gray-300 space-y-2">
                                    <li>HesabÄ±nÄ±za giriÅŸ yapÄ±n ve profil menÃ¼sÃ¼nden <strong>API YÃ¶netimi</strong>'ne gidin.</li>
                                    <li>Yeni bir API anahtarÄ± oluÅŸturun.</li>
                                    <li><strong>Spot Trading</strong> iznini etkinleÅŸtirin.</li>
                                    <li>Para Ã§ekme (Withdrawal) iznini <strong>ASLA</strong> vermeyin.</li>
                                    <li>API Key ve Secret Key'i gÃ¼venli bir yere kaydedin.</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button onclick="goToStep(2)" class="px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors font-semibold flex items-center gap-2">
                            API AnahtarÄ±mÄ± AldÄ±m
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2 Content -->
                <div id="step2-content" class="step-content hidden">
                     <h2 class="text-2xl font-bold text-white mb-6">AdÄ±m 2: API Entegrasyonu</h2>
                     <p class="text-gray-400 mb-8">AldÄ±ÄŸÄ±nÄ±z API anahtarlarÄ±nÄ± sisteme tanÄ±mlayÄ±n.</p>
                     
                     <div class="max-w-md mx-auto bg-[#242424] p-6 rounded-xl border border-white/5">
                        <div class="mb-4">
                            <label class="block text-sm text-gray-400 mb-2">Borsa SeÃ§in</label>
                            <select class="w-full bg-[#1a1a1a] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500">
                                <option>Binance</option>
                                <option>OKX</option>
                                <option>Bybit</option>
                            </select>
                        </div>
                         <div class="mb-4">
                            <label class="block text-sm text-gray-400 mb-2">API Key</label>
                            <input type="text" class="w-full bg-[#1a1a1a] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" placeholder="API Key giriniz">
                        </div>
                         <div class="mb-6">
                            <label class="block text-sm text-gray-400 mb-2">Secret Key</label>
                            <input type="password" class="w-full bg-[#1a1a1a] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" placeholder="Secret Key giriniz">
                        </div>
                        <button onclick="saveApiKeys()" class="w-full py-3 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors font-bold">
                            AnahtarÄ± Kaydet ve BaÄŸlan
                        </button>
                     </div>
                     
                     <div class="flex justify-between mt-8">
                        <button onclick="goToStep(1)" class="text-gray-400 hover:text-white">Geri DÃ¶n</button>
                        <button onclick="goToStep(3)" id="step2-next" class="px-6 py-3 rounded-lg bg-blue-600/50 text-white/50 cursor-not-allowed" disabled>
                            Devam Et
                        </button>
                    </div>
                </div>

                <!-- Step 3 Content -->
                <div id="step3-content" class="step-content hidden">
                     <h2 class="text-2xl font-bold text-white mb-6">AdÄ±m 3: </h2>
                     <p class="text-gray-400 mb-8">Sistemin doÄŸru Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± teyit etmek iÃ§in Demo (Paper Trading) modunu kullanÄ±n.</p>
                     
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                         <div class="bg-[#242424] p-6 rounded-xl border border-white/5">
                             <h3 class="font-bold text-white mb-4"></h3>
                             <div class="text-4xl font-bold text-blue-400 mb-2">$10,000</div>
                             <p class="text-sm text-gray-500">Sanal USDT</p>
                         </div>
                          <div class="bg-[#242424] p-6 rounded-xl border border-white/5 flex flex-col justify-center">
                             <button onclick="runTestTrade()" class="w-full py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors font-bold mb-3">
                                Test Ä°ÅŸlemi Yap (BTC/USDT)
                             </button>
                             <p class="text-center text-xs text-gray-400">Bu iÅŸlem gerÃ§ek paranÄ±zÄ± kullanmaz.</p>
                         </div>
                     </div>
                     
                      <div class="flex justify-between mt-8">
                        <button onclick="goToStep(2)" class="text-gray-400 hover:text-white">Geri DÃ¶n</button>
                        <button onclick="goToStep(4)" class="px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                            Test BaÅŸarÄ±lÄ±, Devam Et
                        </button>
                    </div>
                </div>

                <!-- Step 4 Content -->
                <div id="step4-content" class="step-content hidden">
                     <div class="text-center py-10">
                         <div class="w-20 h-20 rounded-full bg-green-500/20 text-green-500 flex items-center justify-center mx-auto mb-6">
                             <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                         </div>
                         <h2 class="text-3xl font-bold text-white mb-4">Tebrikler! Kurulum TamamlandÄ±</h2>
                         <p class="text-gray-400 max-w-lg mx-auto mb-8">
                             BaÅŸarÄ±yla API entegrasyonunu yaptÄ±nÄ±z ve sistemi test ettiniz. ArtÄ±k gerÃ§ek iÅŸlemler iÃ§in botunuzu yapÄ±landÄ±rabilir ve kazanmaya baÅŸlayabilirsiniz.
                         </p>
                         <div class="flex justify-center gap-4">
                              <a href="/dashboard" class="px-8 py-3 rounded-lg bg-[#242424] text-white hover:bg-[#2a2a2a] transition-colors border border-white/10">
                                 Dashboard'a Git
                             </a>
                             <a href="/market-analysis" class="px-8 py-3 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors font-bold shadow-lg shadow-green-600/20">
                                 PiyasalarÄ± Ä°ncele
                             </a>
                         </div>
                     </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStep = 1;

    function goToStep(step) {
        // Update basic visual state
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('block'));
        
        document.getElementById('step' + step + '-content').classList.remove('hidden');
        document.getElementById('step' + step + '-content').classList.add('block');
        
        currentStep = step;
        updateProgressBar();
    }

    function updateProgressBar() {
        const progress = ((currentStep - 1) / 3) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        
        // Update circles colors
        for(let i=1; i<=4; i++) {
            const circle = document.getElementById('step' + i + '-circle');
            const text = document.getElementById('step' + i + '-text');
            
            if (i <= currentStep) {
                circle.classList.remove('bg-gray-700', 'text-gray-400', 'border-[#0f0f0f]');
                circle.classList.add('bg-blue-600', 'text-white', 'border-[#0f0f0f]');
                text.classList.remove('text-gray-400');
                text.classList.add('text-blue-400');
                
                if(i < currentStep) {
                     // Completed steps green check style could be added here
                     circle.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                     circle.classList.remove('bg-blue-600');
                     circle.classList.add('bg-green-600');
                     text.classList.remove('text-blue-400');
                     text.classList.add('text-green-400');
                }
            } else {
                circle.classList.add('bg-gray-700', 'text-gray-400');
                circle.classList.remove('bg-blue-600', 'text-white', 'bg-green-600', 'text-green-400');
                text.classList.add('text-gray-400');
                text.classList.remove('text-blue-400', 'text-green-400');
                 // Reset icons if needed
            }
        }
    }

    function selectExchange(name) {
        document.getElementById('exchange-guide').classList.remove('hidden');
        document.getElementById('exchange-name').innerText = name + ' API Rehberi';
    }

    function saveApiKeys() {
        // Mock save
        const btn = event.target;
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Kaydediliyor...';
        
        setTimeout(() => {
            btn.innerText = 'BaÅŸarÄ±lÄ±!';
            btn.classList.replace('bg-green-600', 'bg-gray-600');
            
            const nextBtn = document.getElementById('step2-next');
            nextBtn.disabled = false;
            nextBtn.classList.remove('bg-blue-600/50', 'text-white/50', 'cursor-not-allowed');
            nextBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            
            alert('API anahtarlarÄ±nÄ±z baÅŸarÄ±yla kaydedildi.');
            goToStep(3);
        }, 1500);
    }
    
    function runTestTrade() {
        alert('Test iÅŸlemi baÅŸarÄ±yla gerÃ§ekleÅŸtirildi! (u)');
    }

    // Init
    updateProgressBar();
</script>
{% endblock %}
"""


AI_TRADE_RECOMMENDATIONS_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    {{ sidebar | safe }}
    
    <!-- Main Content -->
     <div class="lg:ml-64 p-4 md:p-8 pt-16 lg:pt-8">
        <div class="max-w-7xl mx-auto space-y-6">

            <!-- Header -->
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">AI Trade Recommendations</h1>
                    <p class="text-gray-400 text-sm">Yapay zeka destekli ticaret Ã¶nerileri ve piyasa analizi</p>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                 <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">AÃ§Ä±k Pozisyonlar</p>
                            <p class="text-2xl font-bold text-white">0</p>
                        </div>
                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    </div>
                </div>
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">Toplam P&L</p>
                            <p class="text-2xl font-bold text-green-400">$0.00</p>
                        </div>
                        <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">Aktif Ã–neriler</p>
                            <p class="text-2xl font-bold text-white" id="activeRecsCount">0</p>
                        </div>
                        <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="text-sm text-gray-400 mb-2 block">Borsa SeÃ§imi</label>
                        <select id="exchangeSelect" class="w-full bg-[#242424] border border-white/10 rounded-lg p-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="all">TÃ¼m Borsalar</option>
                            <option value="Binance">Binance</option>
                            <option value="OKX">OKX</option>
                            <option value="Bybit">Bybit</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-2 block">GÃ¼ven EÅŸiÄŸi: <span id="confidenceValue">70</span>%</label>
                        <input type="range" id="confidenceRange" min="50" max="95" value="70" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="flex items-end">
                        <button onclick="fetchRecommendations()" id="refreshBtn" class="w-full py-2 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white flex items-center justify-center gap-2 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Ã–nerileri Yenile
                        </button>
                    </div>
                </div>
            </div>

             <!-- Tabs -->
             <div class="bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden">
                <div class="flex overflow-x-auto">
                    <button onclick="switchTab('recs')" id="tab-recs" class="nav-tab flex-1 min-w-[120px] px-4 py-3 font-medium transition-colors bg-blue-600 text-white">
                        <div class="flex items-center justify-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            <span>Ã–neriler</span>
                        </div>
                    </button>
                    <button onclick="switchTab('sentiment')" id="tab-sentiment" class="nav-tab flex-1 min-w-[120px] px-4 py-3 font-medium transition-colors text-gray-400 hover:text-white hover:bg-white/5">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            <span>DuyarlÄ±lÄ±k</span>
                        </div>
                    </button>
                    <button onclick="switchTab('performance')" id="tab-performance" class="nav-tab flex-1 min-w-[120px] px-4 py-3 font-medium transition-colors text-gray-400 hover:text-white hover:bg-white/5">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <span>Performans</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="min-h-[300px]">
                <!-- Recommendations Tab -->
                <div id="content-recs" class="tab-content block">
                    <div id="recommendationsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Filled by JS -->
                        <div class="col-span-full text-center py-10 text-gray-500">
                             <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            YÃ¼kleniyor...
                        </div>
                    </div>
                </div>

                <!-- Sentiment Tab (Placeholder) -->
                <div id="content-sentiment" class="tab-content hidden">
                     <div class="bg-[#1a1a1a] rounded-xl p-8 border border-white/10 text-center">
                        <h3 class="text-xl font-bold text-white mb-2">Piyasa DuyarlÄ±lÄ±k Analizi</h3>
                        <p class="text-gray-400">Piyasa haberleri ve sosyal medya trendleri analiz ediliyor...</p>
                        <div class="mt-6 flex justify-center gap-4">
                            <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
                                <div class="text-2xl font-bold text-green-400">72/100</div>
                                <div class="text-xs text-gray-400">Korku & AÃ§gÃ¶zlÃ¼lÃ¼k</div>
                            </div>
                            <div class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/20">
                                <div class="text-2xl font-bold text-blue-400">Bullish</div>
                                <div class="text-xs text-gray-400">Genel Trend</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Tab (Placeholder) -->
                <div id="content-performance" class="tab-content hidden">
                    <div class="bg-[#1a1a1a] rounded-xl p-8 border border-white/10 text-center">
                        <h3 class="text-xl font-bold text-white mb-2">AI Performans Raporu</h3>
                         <p class="text-gray-400">Son 30 gÃ¼nlÃ¼k AI tahmin baÅŸarÄ±sÄ±</p>
                         <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-6">
                             <div class="p-4 bg-[#242424] rounded-lg">
                                 <div class="text-3xl font-bold text-green-400">92%</div>
                                 <div class="text-sm text-gray-400">BaÅŸarÄ± OranÄ±</div>
                             </div>
                             <div class="p-4 bg-[#242424] rounded-lg">
                                 <div class="text-3xl font-bold text-blue-400">145</div>
                                 <div class="text-sm text-gray-400">Toplam Sinyal</div>
                             </div>
                             <div class="p-4 bg-[#242424] rounded-lg">
                                 <div class="text-3xl font-bold text-yellow-400">12.5%</div>
                                 <div class="text-sm text-gray-400">Ortalama Kar</div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
     <!-- Trade Modal Via HTML/Dialog -->
    <dialog id="tradeModal" class="bg-[#1a1a1a] rounded-xl p-0 border border-white/10 backdrop:bg-black/50 backdrop:backdrop-blur-sm open:animate-fade-in w-full max-w-md text-white">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold"></h3>
                <button onclick="closeTradeModal()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="mb-4">
                 <p class="text-sm text-gray-400 mb-1">Sembol</p>
                 <p class="text-xl font-bold" id="modalSymbol">BTC/USDT</p>
            </div>
             <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">YÃ¶n</label>
                    <select class="w-full bg-[#242424] border border-white/10 rounded-lg p-2 text-white">
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div>
                     <label class="block text-sm text-gray-400 mb-2">USDT MiktarÄ±</label>
                    <input type="number" value="10" class="w-full bg-[#242424] border border-white/10 rounded-lg p-2 text-white">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeTradeModal()" class="flex-1 py-2 rounded-lg bg-[#242424] hover:bg-[#2a2a2a] transition-colors">VazgeÃ§</button>
                <button onclick="confirmTrade()" class="flex-1 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors font-bold">Onayla</button>
            </div>
        </div>
    </dialog>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Tab Switching
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('block'));
        
        document.getElementById('content-' + tabId).classList.remove('hidden');
        document.getElementById('content-' + tabId).classList.add('block');
        
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-white/5');
        });
        
        const activeBtn = document.getElementById('tab-' + tabId);
        activeBtn.classList.remove('text-gray-400', 'hover:text-white', 'hover:bg-white/5');
        activeBtn.classList.add('bg-blue-600', 'text-white');
    }
    
    // Range Slider
    const range = document.getElementById('confidenceRange');
    const valueDisp = document.getElementById('confidenceValue');
    range.addEventListener('input', (e) => {
        valueDisp.textContent = e.target.value;
    });

    // Mock Data Fetching
    async function fetchRecommendations() {
        const grid = document.getElementById('recommendationsGrid');
        const countSpan = document.getElementById('activeRecsCount');
        const refreshBtn = document.getElementById('refreshBtn');
        
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div> Analiz Ediliyor...';
        
        grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>YÃ¼kleniyor...</div>';
        
        try {
            // Simulate API call
            await new Promise(r => setTimeout(r, 1500));
            
            const minConfidence = document.getElementById('confidenceRange').value;
            const exchange = document.getElementById('exchangeSelect').value;
            const req = await fetch(`/api/public/ai-recommendations?min_confidence=${minConfidence}&exchange=${exchange}`);
            const data = await req.json();
            const recs = data.recommendations || [];
            
            countSpan.textContent = recs.length;
            
            if (recs.length === 0) {
                 grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Kriterlere uygun Ã¶neri bulunamadÄ±.</div>';
                 return;
            }
            
            grid.innerHTML = recs.map(rec => `
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6 hover:border-blue-500/50 transition-all">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center font-bold text-orange-500">
                                ${rec.symbol.substring(0,1)}
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg">${rec.symbol}</h3>
                                <span class="text-xs px-2 py-0.5 rounded bg-[#242424] text-gray-400">${rec.exchange}</span>
                            </div>
                        </div>
                        <div class="text-right">
                             <div class="text-2xl font-bold ${rec.signal_type === 'BUY' ? 'text-green-400' : 'text-red-400'}">${rec.signal_type}</div>
                             <div class="text-xs text-gray-400">GiriÅŸ: $${rec.entry_price}</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">GÃ¼ven Skoru</span>
                            <span class="text-white font-bold">${rec.confidence}%</span>
                        </div>
                        <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full" style="width: ${rec.confidence}%"></div>
                        </div>
                         <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Hedef Kar</span>
                            <span class="text-green-400">+${rec.profit_target_percent}%</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Stop Loss</span>
                            <span class="text-red-400">-${rec.stop_loss_percent}%</span>
                        </div>
                    </div>
                    
                    <button onclick="openTradeModal('${rec.symbol}')" class="w-full py-2 rounded-lg bg-blue-600/10 text-blue-400 border border-blue-600/20 hover:bg-blue-600 hover:text-white transition-colors font-medium">
                        Ä°ÅŸlem Yap
                    </button>
                </div>
            `).join('');
            
        } catch (e) {
            console.error(e);
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-red-500">Hata oluÅŸtu. LÃ¼tfen tekrar deneyin.</div>';
        } finally {
             refreshBtn.disabled = false;
             refreshBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Ã–nerileri Yenile';
        }
    }
    
    // Modal Functions
    function openTradeModal(symbol) {
        document.getElementById('modalSymbol').textContent = symbol;
        document.getElementById('tradeModal').showModal();
    }
    
    function closeTradeModal() {
        document.getElementById('tradeModal').close();
    }
    
    function confirmTrade() {
        closeTradeModal();
        alert('Ä°ÅŸlem baÅŸarÄ±yla iletildi (u)');
    }
    
    // Init
    document.addEventListener('DOMContentLoaded', fetchRecommendations);

</script>
{% endblock %}
"""


EDUCATION_HUB_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    {{ sidebar | safe }}

    <!-- Main Content -->
     <div class="lg:ml-64 p-4 md:p-8 pt-16 lg:pt-8">
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-white">EÄŸitim Merkezi</h1>
                    <p class="text-sm text-gray-400">Video kurslarÄ± ve canlÄ± webinarlar</p>
                </div>
                <div class="flex items-center gap-2 px-4 py-2 rounded-lg bg-[#1a1a1a] border border-white/10">
                    <span class="text-yellow-500">ğŸ†</span>
                    <span class="text-sm text-gray-300">3 Sertifika</span>
                </div>
            </div>

            <!-- Genel Ä°lerleme Section -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-white">Genel Ä°lerleme</h3>
                        <p class="text-xs text-gray-400">TÃ¼m kurslarÄ±n toplam tamamlanma oranÄ±</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-white">16%</div>
                        <div class="text-xs text-gray-400">11/71 ders</div>
                    </div>
                </div>
                <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full rounded-full" style="width: 16%; background: linear-gradient(90deg, #06b6d4, #3b82f6, #8b5cf6);"></div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center"><span class="text-green-400">âœ“</span></div>
                        <div>
                            <div class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">Tamamlanan Kurs</div>
                        </div>
                    </div>
                </div>
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center"><span class="text-cyan-400">â—‹</span></div>
                        <div>
                            <div class="text-2xl font-bold text-white">2</div>
                            <div class="text-xs text-gray-400">Devam Eden Kurs</div>
                        </div>
                    </div>
                </div>
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center"><span class="text-purple-400">ğŸ†</span></div>
                        <div>
                            <div class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">KazanÄ±lan Sertifika</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kurs DetaylarÄ± -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <h3 class="text-lg font-semibold text-white mb-4">Kurs DetaylarÄ±</h3>
                <div class="space-y-4">
                    <!-- Trading Temelleri -->
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-white font-medium">Trading Temelleri</div>
                            <div class="text-xs text-gray-400">8/12 ders tamamlandÄ±</div>
                        </div>
                        <div class="text-cyan-400 font-bold">67%</div>
                    </div>
                    <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-cyan-500 rounded-full" style="width: 67%;"></div></div>
                    
                    <!-- Teknik Analiz UstalÄ±ÄŸÄ± -->
                    <div class="flex items-center justify-between mt-4">
                        <div>
                            <div class="text-white font-medium">Teknik Analiz UstalÄ±ÄŸÄ±</div>
                            <div class="text-xs text-gray-400">3/18 ders tamamlandÄ±</div>
                        </div>
                        <div class="text-blue-400 font-bold">17%</div>
                    </div>
                    <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width: 17%;"></div></div>
                    
                    <!-- Risk YÃ¶netimi Stratejileri -->
                    <div class="flex items-center justify-between mt-4">
                        <div>
                            <div class="text-white font-medium">Risk YÃ¶netimi Stratejileri</div>
                            <div class="text-xs text-gray-400">0/15 ders tamamlandÄ±</div>
                        </div>
                        <div class="text-gray-400 font-bold">0%</div>
                    </div>
                    <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-gray-500 rounded-full" style="width: 0%;"></div></div>
                    
                    <!-- Otomatik Bot YapÄ±landÄ±rmasÄ± -->
                    <div class="flex items-center justify-between mt-4">
                        <div>
                            <div class="text-white font-medium">Otomatik Bot YapÄ±landÄ±rmasÄ±</div>
                            <div class="text-xs text-gray-400">0/22 ders tamamlandÄ±</div>
                        </div>
                        <div class="text-gray-400 font-bold">0%</div>
                    </div>
                    <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-gray-500 rounded-full" style="width: 0%;"></div></div>
                </div>
            </div>

            <!-- Ã–nerilen Sonraki AdÄ±m -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-cyan-500/30 mb-6">
                <div class="flex items-center gap-2 text-cyan-400 font-semibold mb-2">
                    <span>ğŸ’¡</span> Ã–nerilen Sonraki AdÄ±m
                </div>
                <p class="text-gray-400 text-sm mb-4">PerformansÄ±nÄ±za gÃ¶re "Risk YÃ¶netimi Stratejileri" kursuna devam etmenizi Ã¶neriyoruz.</p>
                <button class="px-4 py-2 rounded-lg bg-cyan-500 text-white text-sm hover:bg-cyan-600 transition-colors">Kursa BaÅŸla</button>
            </div>

            <!-- Courses Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <!-- Course Card 1: Trading Temelleri -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden group hover:border-blue-500/50 transition-all">
                    <div class="h-40 bg-gradient-to-br from-blue-900 to-cyan-900 relative flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ“Š</div>
                            <div class="text-white/50 text-sm">24/7 GLOBAL MARKET</div>
                        </div>
                        <div class="absolute top-2 left-2 px-2 py-1 rounded bg-green-500/80 text-white text-xs">BaÅŸlangÄ±Ã§</div>
                        <div class="absolute top-2 right-2 text-xs text-gray-300">â±ï¸ 2 saat 30 dakika</div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-white mb-1">Trading Temelleri</h3>
                        <p class="text-xs text-gray-400 mb-3">Kripto para ticaretine giriÅŸ, temel kavramlar ve piyasa mekaniÄŸi</p>
                        <div class="flex items-center gap-4 text-xs text-gray-500 mb-3">
                            <span>ğŸ“š 12 ders</span>
                            <span>ğŸ‘¥ 8 kullanÄ±cÄ±da</span>
                        </div>
                        <div class="flex items-center justify-between text-xs mb-3">
                            <span class="text-gray-400">Ä°lerleme</span>
                            <span class="text-cyan-400 font-bold">67%</span>
                        </div>
                        <div class="w-full h-1.5 bg-gray-700 rounded-full mb-4"><div class="h-full bg-cyan-500 rounded-full" style="width: 67%;"></div></div>
                        <button class="w-full py-2 rounded-lg bg-cyan-500 text-white hover:bg-cyan-600 transition-colors text-sm flex items-center justify-center gap-2">â–¶ Devam Et</button>
                    </div>
                </div>

                <!-- Course Card 2: Teknik Analiz UstalÄ±ÄŸÄ± -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden group hover:border-blue-500/50 transition-all">
                    <div class="h-40 bg-gradient-to-br from-green-900 to-teal-900 relative flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ“ˆ</div>
                            <div class="text-white/50 text-sm">CHART ANALYSIS</div>
                        </div>
                        <div class="absolute top-2 left-2 px-2 py-1 rounded bg-yellow-500/80 text-white text-xs">Orta</div>
                        <div class="absolute top-2 right-2 text-xs text-gray-300">â±ï¸ 4 saat 15 dakika</div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-white mb-1">Teknik Analiz UstalÄ±ÄŸÄ±</h3>
                        <p class="text-xs text-gray-400 mb-3">Grafik okuma, indikatÃ¶rler, destek-direnÃ§ seviyeleri ve trend analizi</p>
                        <div class="flex items-center gap-4 text-xs text-gray-500 mb-3">
                            <span>ğŸ“š 18 ders</span>
                            <span>ğŸ‘¥ 3 kullanÄ±cÄ±da</span>
                        </div>
                        <div class="flex items-center justify-between text-xs mb-3">
                            <span class="text-gray-400">Ä°lerleme</span>
                            <span class="text-blue-400 font-bold">17%</span>
                        </div>
                        <div class="w-full h-1.5 bg-gray-700 rounded-full mb-4"><div class="h-full bg-blue-500 rounded-full" style="width: 17%;"></div></div>
                        <button class="w-full py-2 rounded-lg bg-cyan-500 text-white hover:bg-cyan-600 transition-colors text-sm flex items-center justify-center gap-2">â–¶ Devam Et</button>
                    </div>
                </div>

                <!-- Course Card 3: Risk YÃ¶netimi Stratejileri -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden group hover:border-blue-500/50 transition-all">
                    <div class="h-40 bg-gradient-to-br from-purple-900 to-indigo-900 relative flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ›¡ï¸</div>
                            <div class="text-white/50 text-sm">RISK MANAGEMENT</div>
                        </div>
                        <div class="absolute top-2 left-2 px-2 py-1 rounded bg-yellow-500/80 text-white text-xs">Orta</div>
                        <div class="absolute top-2 right-2 text-xs text-gray-300">â±ï¸ 3 saat 45 dakika</div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-white mb-1">Risk YÃ¶netimi Stratejileri</h3>
                        <p class="text-xs text-gray-400 mb-3">PortfÃ¶y yÃ¶netimi, pozisyon bÃ¼yÃ¼klÃ¼ÄŸÃ¼ hesaplama ve stop-loss stratejileri</p>
                        <div class="flex items-center gap-4 text-xs text-gray-500 mb-3">
                            <span>ğŸ“š 15 ders</span>
                            <span>ğŸ‘¥ 0 kullanÄ±cÄ±da</span>
                        </div>
                        <div class="flex items-center justify-between text-xs mb-3">
                            <span class="text-gray-400">Ä°lerleme</span>
                            <span class="text-gray-400 font-bold">0%</span>
                        </div>
                        <div class="w-full h-1.5 bg-gray-700 rounded-full mb-4"><div class="h-full bg-gray-500 rounded-full" style="width: 0%;"></div></div>
                        <button class="w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm flex items-center justify-center gap-2">â–¶ BaÅŸla</button>
                    </div>
                </div>
            </div>

            <!-- Otomatik Bot Course Card (full width) -->
            <div class="bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden mb-6">
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-1/3 h-48 md:h-auto bg-gradient-to-br from-cyan-900 to-blue-900 relative flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-5xl mb-2">ğŸ¤–</div>
                            <div class="text-white/50 text-sm">TRADING BOTS</div>
                        </div>
                        <div class="absolute top-2 left-2 px-2 py-1 rounded bg-red-500/80 text-white text-xs">Ä°leri</div>
                        <div class="absolute top-2 right-2 text-xs text-gray-300">â±ï¸ 5 saat 20 dakika</div>
                    </div>
                    <div class="md:w-2/3 p-6">
                        <h3 class="text-xl font-bold text-white mb-2">Otomatik Bot YapÄ±landÄ±rmasÄ±</h3>
                        <p class="text-sm text-gray-400 mb-4">Trading botlarÄ±nÄ± kurma, strateji oluÅŸturma ve optimizasyon teknikleri</p>
                        <div class="flex items-center gap-4 text-xs text-gray-500 mb-4">
                            <span>ğŸ“š 17 ders</span>
                            <span>ğŸ‘¥ 0 Ä°lerleme</span>
                        </div>
                        <div class="flex items-center justify-between text-xs mb-2">
                            <span class="text-gray-400">Ä°lerleme</span>
                            <span class="text-gray-400 font-bold">0%</span>
                        </div>
                        <div class="w-full h-1.5 bg-gray-700 rounded-full mb-4"><div class="h-full bg-gray-500 rounded-full" style="width: 0%;"></div></div>
                        <button class="w-full md:w-auto px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm flex items-center justify-center gap-2">â–¶ BaÅŸla</button>
                    </div>
                </div>
            </div>

            <!-- CanlÄ± Webinarlar Section -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <h2 class="text-xl font-semibold text-white mb-4">CanlÄ± Webinarlar</h2>
                <div class="flex items-center gap-2 px-4 py-3 rounded-lg bg-[#242424] border border-white/10 mb-4">
                    <span class="text-green-400">ğŸ“º</span>
                    <div>
                        <div class="text-white font-medium">CanlÄ± Webinarlar</div>
                        <div class="text-xs text-gray-400">Uzmanlardan canlÄ± eÄŸitimler, soru-cevap oturumlarÄ± ve piyasa analizleri</div>
                    </div>
                </div>
                
                <div class="text-white font-semibold mb-4">YaklaÅŸan Webinarlar</div>
                
                <!-- Webinar 1 -->
                <div class="flex flex-col md:flex-row gap-4 items-start p-4 rounded-lg bg-[#242424] border border-white/5 mb-4">
                    <div class="w-full md:w-64 h-40 bg-gradient-to-br from-yellow-900 to-orange-900 rounded-lg relative flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-3xl mb-1">â‚¿</div>
                            <div class="text-white text-sm font-bold">APRIL 2024</div>
                            <div class="text-xs text-white/70">HALVING EVENT</div>
                        </div>
                        <div class="absolute top-2 left-2 px-2 py-1 rounded bg-green-500 text-white text-xs">KayÄ±tlÄ±</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white mb-2">Bitcoin Halving 2024: Ne Beklemeli?</h3>
                        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-400 mb-4">
                            <span class="flex items-center gap-1">ğŸ‘¤ Ahmet YÄ±lmaz</span>
                            <span class="flex items-center gap-1">ğŸ“… 20 Ocak 2026</span>
                            <span class="flex items-center gap-1">â±ï¸ 19:00 â€¢ 90 dakika</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="px-4 py-2 rounded-lg bg-[#333] text-white text-sm hover:bg-[#444] transition-colors">KaydÄ± Ä°ptal Et</button>
                            <button class="px-4 py-2 rounded-lg bg-green-600 text-white text-sm hover:bg-green-700 transition-colors flex items-center gap-2">ğŸ“… Takvime Ekle</button>
                        </div>
                    </div>
                </div>

                <!-- Webinar 2 -->
                <div class="flex flex-col md:flex-row gap-4 items-start p-4 rounded-lg bg-[#242424] border border-white/5">
                    <div class="w-full md:w-64 h-40 bg-gradient-to-br from-purple-900 to-pink-900 rounded-lg relative flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-2xl mb-1 text-white font-bold">ALTSEASON IMMINENT</div>
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white mb-2">Alt Coin Sezonuna HazÄ±rlÄ±k</h3>
                        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-400 mb-4">
                            <span class="flex items-center gap-1">ğŸ‘¤ Mehmet Demir</span>
                            <span class="flex items-center gap-1">ğŸ“… 25 Ocak 2026</span>
                            <span class="flex items-center gap-1">â±ï¸ 20:00 â€¢ 60 dakika</span>
                        </div>
                        <button class="px-4 py-2 rounded-lg bg-cyan-500 text-white text-sm hover:bg-cyan-600 transition-colors">KayÄ±t Ol</button>
                    </div>
                </div>
            </div>
</div>
{% endblock %}
"""








PAYMENT_MANAGEMENT_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    <!-- Main Content -->
    <div class="p-4 md:p-8 pt-16 lg:pt-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
             <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <h1 class="text-2xl font-bold text-white mb-1">â° Ã–deme YÃ¶netimi</h1>
                <p class="text-sm text-gray-400">Abonelik ve Ã–deme Ä°ÅŸlemleri</p>
            </div>
            
            <!-- Plan & Balance Info -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div>
                        <div class="text-xs text-gray-400 mb-1">Mevcut Paket</div>
                        <div class="text-lg font-bold text-white">7 GÃ¼nlÃ¼k Ãœcretsiz Deneme</div>
                    </div>
                     <div class="text-right">
                        <div class="text-xs text-gray-400 mb-1">Bakiye</div>
                        <div class="text-lg font-bold text-green-500">10020.42 TL</div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex items-center bg-[#1a1a1a] rounded-lg p-1 border border-white/10 mb-6">
                <button onclick="switchTab('packages')" id="tab-btn-packages" class="flex-1 py-2 rounded-md text-sm font-medium text-white bg-blue-600 transition-all flex items-center justify-center gap-2">
                    <span>ğŸ“¦</span> Paketler
                </button>
                <button onclick="switchTab('payment')" id="tab-btn-payment" class="flex-1 py-2 rounded-md text-sm font-medium text-gray-400 hover:text-white transition-all flex items-center justify-center gap-2">
                    <span>ğŸ’³</span> Ã–deme Yap
                </button>
                <button onclick="switchTab('history')" id="tab-btn-history" class="flex-1 py-2 rounded-md text-sm font-medium text-gray-400 hover:text-white transition-all flex items-center justify-center gap-2">
                    <span>ğŸ•’</span> Ä°ÅŸlem GeÃ§miÅŸi
                </button>
            </div>

            <!-- Tab Content: Packages -->
            <div id="tab-content-packages" class="block">
                <div class="mb-4">
                    <h2 class="text-lg font-bold text-white mb-2">Abonelik Paketleri</h2>
                    <p class="text-sm text-gray-400">Size uygun paketi seÃ§in ve otomatik trading'e baÅŸlayÄ±n</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Free Plan -->
                    <div class="bg-[#1e1e1e] rounded-xl p-6 border border-blue-600 relative overflow-hidden flex flex-col h-full">
                        <div class="absolute top-2 right-2 px-2 py-1 bg-blue-600 text-white text-xs rounded">Aktif Paket</div>
                        <div class="w-12 h-12 rounded-lg bg-blue-600/20 flex items-center justify-center mb-4 text-2xl">ğŸ</div>
                        <h3 class="text-lg font-bold text-white mb-2">1 GÃ¼nlÃ¼k Ãœcretsiz Deneme</h3>
                        <div class="text-3xl font-bold text-white mb-4">0 <span class="text-sm font-normal text-gray-400">TL/ay</span></div>
                        
                        <ul class="space-y-3 mb-6 flex-1">
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> 1 gÃ¼n Ã¼cretsiz kullanÄ±m</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> 100 TL test bakiyesi</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> TÃ¼m borsalar</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> Temel Ã¶zellikler</li>
                        </ul>
                        
                        <button class="w-full py-2 rounded-lg bg-white/5 text-gray-400 text-sm cursor-not-allowed border border-white/5" disabled>Mevcut Paket</button>
                    </div>

                    <!-- Basic Plan -->
                     <div class="bg-[#1e1e1e] rounded-xl p-6 border border-white/10 hover:border-green-500/50 transition-all flex flex-col h-full">
                        <div class="w-12 h-12 rounded-lg bg-green-600/20 flex items-center justify-center mb-4 text-2xl">ğŸ“¦</div>
                        <h3 class="text-lg font-bold text-white mb-2">Temel Paket</h3>
                        <div class="text-3xl font-bold text-white mb-4">7500 <span class="text-sm font-normal text-gray-400">TL/ay</span></div>
                        
                        <ul class="space-y-3 mb-6 flex-1">
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> AylÄ±k 100 Ä°ÅŸlem hakkÄ±</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> Auto Ä°ÅŸlemlerde 2 coin aÃ§abilme</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> 7/24 Destek</li>
                             <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> Temel analiz araÃ§larÄ±</li>
                        </ul>
                        
                        <button onclick="selectPackage('basic')" class="w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm">Paketi SeÃ§</button>
                    </div>

                     <!-- Premium Plan -->
                     <div class="bg-[#1e1e1e] rounded-xl p-6 border border-white/10 hover:border-purple-500/50 transition-all flex flex-col h-full">
                        <div class="w-12 h-12 rounded-lg bg-purple-600/20 flex items-center justify-center mb-4 text-2xl">â­</div>
                        <h3 class="text-lg font-bold text-white mb-2">Premium Paket</h3>
                        <div class="text-3xl font-bold text-white mb-4">12500 <span class="text-sm font-normal text-gray-400">TL/ay</span></div>
                        
                        <ul class="space-y-3 mb-6 flex-1">
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> AylÄ±k 500 Ä°ÅŸlem hakkÄ±</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> Auto Ä°ÅŸlemlerde 3 coin aÃ§abilme</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> Ã–ncelikli destek</li>
                             <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> GeliÅŸmiÅŸ analiz araÃ§larÄ±</li>
                             <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> Ã–zel stratejiler</li>
                        </ul>
                        
                        <button onclick="selectPackage('premium')" class="w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm">Paketi SeÃ§</button>
                    </div>

                    <!-- Elit Plan -->
                     <div class="bg-[#1e1e1e] rounded-xl p-6 border border-white/10 hover:border-yellow-500/50 transition-all flex flex-col h-full">
                        <div class="w-12 h-12 rounded-lg bg-yellow-600/20 flex items-center justify-center mb-4 text-2xl">ğŸ‘‘</div>
                        <h3 class="text-lg font-bold text-white mb-2">Elit Paket</h3>
                        <div class="text-3xl font-bold text-white mb-4">20000 <span class="text-sm font-normal text-gray-400">TL/ay</span></div>
                        
                        <ul class="space-y-3 mb-6 flex-1">
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> SÄ±nÄ±rsÄ±z Ä°ÅŸlem hakkÄ±</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> Auto Ä°ÅŸlemlerde 5 coin aÃ§abilme</li>
                            <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> VIP destek</li>
                             <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> TÃ¼m premium Ã¶zellikler</li>
                             <li class="flex items-center gap-2 text-sm text-gray-300"><span class="text-green-500">âœ“</span> Ã–zel danÄ±ÅŸmanlÄ±k</li>
                        </ul>
                        
                        <button onclick="selectPackage('elit')" class="w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm">Paketi SeÃ§</button>
                    </div>
                </div>
                
                 <div class="mt-6 p-4 rounded-lg bg-blue-900/20 border border-blue-900/50 flex items-start gap-3">
                    <span class="text-blue-400 mt-0.5">â„¹ï¸</span>
                    <div>
                        <div class="text-sm font-semibold text-white mb-1">Paket YÃ¼kseltme:</div>
                        <div class="text-xs text-blue-200">Paket deÄŸiÅŸtirmek iÃ§in "Ã–deme Yap" sekmesinden Ã¶deme yapabilir veya admin ile iletiÅŸime geÃ§ebilirsiniz.</div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Payment Form -->
            <div id="tab-content-payment" class="hidden">
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
                <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                    <h2 class="text-lg font-bold text-white mb-2">Ã–deme YÃ¶ntemi SeÃ§in</h2>
                    <p class="text-sm text-gray-400 mb-6">Banka transferi ile abonelik satÄ±n alÄ±n</p>
                    
                    <div class="space-y-6">
                         <!-- Package Selection -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-2">Paket SeÃ§imi</label>
                            <select id="package-select" class="w-full bg-[#0f0f0f] border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors">
                                <option value="basic">Temel Paket - 7500 TL/ay</option>
                                <option value="premium">Premium Paket - 12500 TL/ay</option>
                                <option value="elit">Elit Paket - 20000 TL/ay</option>
                            </select>
                        </div>

                         <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-2">Ã–denecek Tutar (TL)</label>
                            <input type="text" id="amount-input" value="7500" readonly class="w-full bg-[#2a2a2a] border border-white/10 rounded-lg px-4 py-3 text-gray-300 focus:outline-none cursor-not-allowed">
                        </div>

                        <!-- Admin Bank Info Box -->
                        <div class="bg-green-900/10 border border-green-500/30 rounded-lg p-5">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="text-green-400 text-lg">ğŸ¦</span>
                                <span class="text-white font-bold">Ã–deme YapÄ±lacak Hesap Bilgileri</span>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                                    <span class="text-gray-400 w-32">IBAN:</span>
                                    <span class="text-white font-mono bg-black/30 px-3 py-1.5 rounded">TR44 0015 7000 0000 0160 2151 39</span>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                                    <span class="text-gray-400 w-32">Banka:</span>
                                    <span class="text-white">EnPara (QNB Finansbank)</span>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                                    <span class="text-gray-400 w-32">Hesap Sahibi:</span>
                                    <span class="text-white font-semibold">Atalay Ulusoy Safran</span>
                                </div>
                            </div>
                            
                            <!-- Important Note -->
                            <div class="mt-4 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <span class="text-yellow-400">âš ï¸</span>
                                    <div class="text-xs">
                                        <p class="text-yellow-300 font-bold mb-1">Ã–NEMLÄ°!</p>
                                        <p class="text-yellow-200/80">Havale/EFT yaparken aÃ§Ä±klama kÄ±smÄ±na <strong>kullanÄ±cÄ± adÄ±nÄ±zÄ±</strong> yazmayÄ± unutmayÄ±n.</p>
                                        <p class="text-yellow-200/60 mt-1">Ã–rn: "testuser" veya "atalay123"</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button onclick="sendPaymentRequest()" class="w-full py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-600/20">ğŸ“¤ Ã–deme Talebini GÃ¶nder</button>

                    </div>
                </div>
            </div>

            <!-- Tab Content: Transaction History -->
            <div id="tab-content-history" class="hidden">
                 <div class="bg-[#1a1a1a] rounded-xl p-8 border border-white/10 flex flex-col items-center justify-center min-h-[400px]">
                    <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center mb-4 text-2xl text-gray-600">
                        ğŸ’²
                    </div>
                    <h3 class="text-white font-medium mb-1">Ä°ÅŸlem GeÃ§miÅŸi</h3>
                     <p class="text-sm text-gray-500">TÃ¼m Ã¶deme iÅŸlemlerinizi gÃ¶rÃ¼ntÃ¼leyin</p>
                     
                     <div class="mt-8 text-sm text-gray-500">HenÃ¼z Ã¶deme iÅŸlemi bulunmuyor</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    function switchTab(tabName) {
        // Build IDs
        const tabBtnId = `tab-btn-${tabName}`;
        const tabContentId = `tab-content-${tabName}`;

        // Reset all buttons
        ['packages', 'payment', 'history'].forEach(t => {
            const btn = document.getElementById(`tab-btn-${t}`);
            const content = document.getElementById(`tab-content-${t}`);
            
            // Allow null checks just in case
            if(btn && content) {
                if(t === tabName) {
                    // Activate
                    btn.classList.remove('text-gray-400', 'hover:text-white');
                    btn.classList.add('bg-blue-600', 'text-white');
                    content.classList.remove('hidden');
                    content.classList.add('block');
                } else {
                    // Deactivate
                    btn.classList.add('text-gray-400', 'hover:text-white');
                    btn.classList.remove('bg-blue-600', 'text-white');
                    content.classList.add('hidden');
                    content.classList.remove('block');
                }
            }
        });
    }

    function selectPackage(pkg) {
        // Switch to payment tab
        switchTab('payment');
        
        // Update selection
        const select = document.getElementById('package-select');
        if(select) {
            select.value = pkg;
            updateAmount(); // Trigger amount update
        }
    }

    // Amount update logic
    const pkgPrices = {
        'basic': 7500,
        'premium': 12500,
        'elit': 20000
    };

    const select = document.getElementById('package-select');
    const amountInput = document.getElementById('amount-input');

    if(select && amountInput) {
        select.addEventListener('change', updateAmount);
    }

    function updateAmount() {
        const val = select.value;
        if(pkgPrices[val]) {
            amountInput.value = pkgPrices[val];
        }
    }
    
    // Send payment request
    async function sendPaymentRequest() {
        const pkg = document.getElementById('package-select').value;
        const amount = document.getElementById('amount-input').value;
        const pkgNames = {'basic': 'Temel', 'premium': 'Premium', 'elit': 'Elit'};
        
        try {
            const res = await fetch('/api/payment/request', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    package: pkgNames[pkg] || pkg,
                    amount: amount + ' TL',
                    payment_method: 'Havale/EFT'
                })
            });
            const data = await res.json();
            
            if (data.ok) {
                alert('âœ… Ã–deme talebiniz baÅŸarÄ±yla gÃ¶nderildi!\\n\\nÃ–demeyi yaptÄ±ktan sonra hesabÄ±nÄ±z aktif edilecektir.');
            } else {
                alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
            }
        } catch (e) {
            alert('âŒ Hata: ' + e.message);
        }
    }
</script>
{% endblock %}
"""











def db_conn():
    return db()

# =========================
# Config
# =========================
APP_BRAND = "Atalay Ulusoy Auto Trade"
TAB_TITLE = f"{E_TAB} AU Auto Trade"
trial_banner_html = ""  # safe default (defined later per-user on dashboard)

HOST = os.getenv("HOST", "0.0.0.0")
PORT = int(os.getenv("PORT", "8080"))
SESSION_SECRET = os.getenv("SESSION_SECRET", os.getenv("FLASK_SECRET", "change_me_session_secret"))
DB_PATH = os.getenv("DB_PATH", "/root/backend/data.db")  # AU_DB_FORCE_FAST

WEBHOOK_SECRET = os.getenv("WEBHOOK_SECRET", "").strip()
DRY_RUN_DEFAULT = os.getenv("DRY_RUN", "1").strip().lower() in ("1", "true", "yes", "on")
TP_PCT_DEFAULT = float(os.getenv("TP_PCT", "0.005").strip() or "0.005")  # 0.50%
TP_CHECK_SEC = float(os.getenv("TP_CHECK_SEC", "5").strip() or "5")

DEFAULT_EXCHANGE = os.getenv("DEFAULT_EXCHANGE", "OKX").strip().upper()
DEFAULT_SYMBOL = os.getenv("DEFAULT_SYMBOL", "BTC/USDT").strip().upper()
DEFAULT_USDT = float(os.getenv("DEFAULT_USDT", "10").strip() or "10")

# SELL debounce (aynÄ± saniye BUY->SELL gelirse OKX bakiye/pozisyon senkronu iÃ§in kÄ±sa bekleme)
SELL_DEBOUNCE_SEC = float(os.getenv("SELL_DEBOUNCE_SEC", "2.0").strip() or "2.0")
_LAST_BUY_TS: Dict[str, float] = {}

# =========================
# AUTO SELL DEFER (server-side)
# =========================
# Trend gÃ¼Ã§lÃ¼ ise: Gate ON + SELL DEFER
# Trend zayÄ±f / yatay ise: SELL INSTANT
#
# Notlar:
# - UI/CSS/HTML'e dokunmaz.
# - Webhook yanÄ±tÄ±nÄ± geciktirmemek iÃ§in SELL bekletme iÅŸi arka planda thread ile yÃ¼rÃ¼r.
AUTO_SELL_DEFER_ENABLED = (os.getenv("AUTO_SELL_DEFER_ENABLED", "1").strip().lower() in ("1", "true", "yes", "on"))
AUTO_SELL_DEFER_CHECK_SEC = float(os.getenv("AUTO_SELL_DEFER_CHECK_SEC", "10").strip() or "10")

# Maksimum bekleme sÃ¼releri (saniye)
AUTO_SELL_DEFER_MAX_SEC_NORMAL = int(os.getenv("AUTO_SELL_DEFER_MAX_SEC_NORMAL", "300").strip() or "300")   # 5 dk
AUTO_SELL_DEFER_MAX_SEC_AGGR   = int(os.getenv("AUTO_SELL_DEFER_MAX_SEC_AGGR", "180").strip() or "180")     # 3 dk
AUTO_SELL_DEFER_MAX_SEC_HARD   = int(os.getenv("AUTO_SELL_DEFER_MAX_SEC_HARD", "120").strip() or "120")     # 2 dk

_DEFERRED_SELLS_LOCK = threading.Lock()
_DEFERRED_SELLS: Dict[str, Dict[str, Any]] = {}

USDT_TRY_RATE = float(os.getenv("USDT_TRY_RATE", "33.0").strip() or "33.0")
TZ_OFFSET_HOURS = int(os.getenv("TZ_OFFSET_HOURS", "3").strip() or "3")

# =========================
# Contract (SÃ¶zleÅŸme)
# =========================
# Not: UI/CSS'e dokunmadan sadece iÃ§erik ve admin yÃ¶netimi eklendi.
CONTRACT_VERSION = "2026-01-08"
CONTRACT_TITLE = "SÃ¶zleÅŸme OnayÄ±"

CONTRACT_BODY_TEMPLATE = """A. Taraflar

Hizmet SaÄŸlayÄ±cÄ±:
Atalay Ulusoy
(\"Hizmet SaÄŸlayÄ±cÄ±\" olarak anÄ±lacaktÄ±r.)

Hizmet Alan (KullanÄ±cÄ±):
Ad Soyad: {full_name}
KullanÄ±cÄ± AdÄ±: {username}
Kimlik No: {tc}

B. Hizmet KapsamÄ±

1) Sunulan hizmet bir yazÄ±lÄ±m hizmetidir. YatÄ±rÄ±m danÄ±ÅŸmanlÄ±ÄŸÄ± deÄŸildir.
2) Sistem; otomatik alÄ±mâ€“satÄ±m iÅŸlemleri, manuel onaylÄ± iÅŸlemler ve teknik iÅŸlem otomasyonu saÄŸlayabilir.
3) Borsa, aÄŸ, internet ve Ã¼Ã§Ã¼ncÃ¼ taraf servislerdeki kesinti veya gecikmeler hizmeti etkileyebilir.

C. Risk Bildirimi

1) Kripto ve benzeri piyasalarda iÅŸlem yapmak yÃ¼ksek risk iÃ§erir.
2) KullanÄ±cÄ±, sermayesinin tamamÄ±nÄ± kaybedebileceÄŸini kabul eder.
3) AÃ§Ä±lan tÃ¼m iÅŸlemler KullanÄ±cÄ± sorumluluÄŸundadÄ±r.

D. Sorumluluk Reddi ve SÄ±nÄ±rlar

1) Hizmet SaÄŸlayÄ±cÄ±; zarar, kayÄ±p, komisyon, slipaj, borsa kaynaklÄ± gecikme ve hatalardan sorumlu tutulamaz.
2) Sistem hiÃ§bir koÅŸulda kesin kazanÃ§, kÃ¢r veya gelir garantisi vermez.
3) KullanÄ±cÄ±; API anahtarlarÄ±nÄ± gizli tutmaktan ve hesabÄ±nÄ±n gÃ¼venliÄŸinden sorumludur.
4) KullanÄ±cÄ±, emirlerin borsa kurallarÄ± ve minimum miktarlar nedeniyle kÄ±smen veya tamamen gerÃ§ekleÅŸmeyebileceÄŸini kabul eder.
5) Hizmet SaÄŸlayÄ±cÄ±, dolaylÄ± zararlar ve mahrum kalÄ±nan kÃ¢r gibi taleplerden sorumlu tutulamaz.

E. Veri GizliliÄŸi ve GÃ¼venlik

1) SÃ¶zleÅŸme kayÄ±tlarÄ±; kullanÄ±cÄ± adÄ±, ad soyad, kimlik no (opsiyonel), tarih ve IP bilgisiyle sunucuda saklanÄ±r.
2) KullanÄ±cÄ± bilgileri Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle paylaÅŸÄ±lmaz; yasal zorunluluklar saklÄ±dÄ±r.
3) EriÅŸim ve iÅŸlem kayÄ±tlarÄ± gÃ¼venlik amaÃ§lÄ± loglanabilir.

F. Hizmet KullanÄ±mÄ± ve KullanÄ±cÄ± YÃ¼kÃ¼mlÃ¼lÃ¼kleri

1) KullanÄ±cÄ±, kendi borsa hesabÄ±nÄ±n ve internet baÄŸlantÄ±sÄ±nÄ±n Ã§alÄ±ÅŸÄ±r durumda olmasÄ±ndan sorumludur.
2) KullanÄ±cÄ±, hesabÄ±na tanÄ±mladÄ±ÄŸÄ± API anahtarlarÄ±nÄ±n yetkilerini kendi tercihleriyle belirler.
3) KullanÄ±cÄ±, ÅŸifre ve eriÅŸim bilgilerini Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle paylaÅŸamaz.
4) KullanÄ±cÄ±, sistemi hukuka aykÄ±rÄ± amaÃ§la kullanamaz.

G. Ãœcretlendirme ve Paketler

1) Hizmet, seÃ§ilen pakete gÃ¶re kullanÄ±m limiti ile sunulabilir.
2) Borsa komisyonlarÄ±, fonlama, spread ve benzeri maliyetler paket Ã¼cretine dahil deÄŸildir.
3) Ã–demeler ve paket koÅŸullarÄ±, Admin Panel'de belirtilen paket tanÄ±mlarÄ±na gÃ¶re uygulanÄ±r.

H. Destek ve Ä°letiÅŸim

1) Destek, en iyi gayret esasÄ±na gÃ¶re saÄŸlanÄ±r.
2) Bildirim ve duyurular; uygulama iÃ§i bildirimler ve Telegram mesajlarÄ± ile yapÄ±labilir.

I. GÃ¼ncellemeler ve DeÄŸiÅŸiklikler

1) Hizmet SaÄŸlayÄ±cÄ±, sistemin gÃ¼venlik ve kararlÄ±lÄ±ÄŸÄ± iÃ§in gÃ¼ncelleme yapabilir.
2) GÃ¼ncellemeler; arayÃ¼z, akÄ±ÅŸ ve Ã¶zelliklerde iyileÅŸtirme iÃ§erebilir.
3) Kritik deÄŸiÅŸiklikler mÃ¼mkÃ¼n olduÄŸunda Ã¶nceden duyurulabilir.

J. Fesih

1) Hizmet SaÄŸlayÄ±cÄ±; kÃ¶tÃ¼ye kullanÄ±m, gÃ¼venlik riski veya sÃ¶zleÅŸme ihlali durumlarÄ±nda tek taraflÄ± fesih hakkÄ±nÄ± saklÄ± tutar.
2) KullanÄ±cÄ±, hesabÄ±nÄ± kapatmayÄ± talep edebilir.
3) Fesih halinde, devam eden iÅŸlemler ve borsa kaynaklÄ± sonuÃ§lar KullanÄ±cÄ± sorumluluÄŸundadÄ±r.

K. Fikri MÃ¼lkiyet

1) YazÄ±lÄ±mÄ±n tÃ¼m haklarÄ± Hizmet SaÄŸlayÄ±cÄ±'ya aittir.
2) KullanÄ±cÄ±, yazÄ±lÄ±mÄ± kopyalayamaz, Ã§oÄŸaltamaz, tersine mÃ¼hendislik yapamaz.

L. Yetkili Mahkeme ve YÃ¼rÃ¼rlÃ¼k

1) Ä°ÅŸbu sÃ¶zleÅŸmeden doÄŸabilecek uyuÅŸmazlÄ±klarda TÃ¼rkiye Cumhuriyeti Mahkemeleri ve Ä°cra Daireleri yetkilidir.
2) Bu sÃ¶zleÅŸme, KullanÄ±cÄ±'nÄ±n dijital ortamda onay vermesiyle yÃ¼rÃ¼rlÃ¼ÄŸe girer.

KullanÄ±cÄ± BeyanÄ±:
Ad Soyad: {full_name}
Tarih: {accepted_at}
IP Adresi: {ip}
Ä°mza (Dijital Onay): {sig}

Bu belge dijital ortamda onaylanmÄ±ÅŸtÄ±r.
"""

def build_contract_text(full_name: str, username: str, tc: str, accepted_at: str, ip: str) -> str:
    full_name = safe_str(full_name)
    username = safe_str(username)
    tc = safe_str(tc)
    ip = safe_str(ip)
    sig = E_OK  # dijital onay
    return CONTRACT_BODY_TEMPLATE.format(
        full_name=full_name,
        username=username,
        tc=(tc if tc else ""),
        accepted_at=accepted_at,
        ip=ip,
        sig=sig
    )

def user_contract_accepted(u: dict) -> bool:
    try:
        if not u:
            return False
        if not isinstance(u, dict):
            u = dict(u)
        return int(u.get("contract_accepted_at") or 0) > 0
    except Exception:
        return False

def contract_pdf_bytes(contract: dict) -> bytes:
    """Render a contract PDF in the exact look/style used in the sample (header, page no, title, fields, body)."""
    try:
        from io import BytesIO
        from reportlab.lib.pagesizes import A4
        from reportlab.pdfgen import canvas
        from reportlab.lib.units import mm
    except Exception:
        # reportlab missing -> fallback to plain text bytes
        return safe_str(contract.get("body") or "").encode("utf-8")

    brand = APP_BRAND
    title = f"{APP_BRAND} â€” KullanÄ±m ve Risk SÃ¶zleÅŸmesi"

    username = safe_str(contract.get("username") or "")
    full_name = safe_str(contract.get("full_name") or "")
    tc = safe_str(contract.get("tc") or "")
    ip = safe_str(contract.get("ip") or "")
    ts = int(contract.get("accepted_at") or 0)

    dt_local = (datetime.utcfromtimestamp(ts) + timedelta(hours=TZ_OFFSET_HOURS)) if ts > 0 else (datetime.utcnow() + timedelta(hours=TZ_OFFSET_HOURS))
    dt_str = dt_local.strftime("%Y-%m-%d %H:%M:%S")

    body_txt = safe_str(contract.get("body") or "").strip()

    buf = BytesIO()
    c = canvas.Canvas(buf, pagesize=A4)
    w, h = A4

    # Layout constants (close to sample)
    left = 20 * mm
    right = 20 * mm
    top = 18 * mm
    bottom = 18 * mm

    def draw_header(page_no: int):
        c.setFont("Helvetica", 10)
        c.drawString(left, h - top, brand)
        c.drawRightString(w - right, h - top, f"Sayfa {page_no}")
        c.setFont("Helvetica-Bold", 12)
        c.drawString(left, h - top - 16, title)
        c.setFont("Helvetica", 10)
        c.drawString(left, h - top - 34, brand)

    # Prepare lines: keep original line breaks but wrap long lines
    max_width = w - left - right
    font_name = "Helvetica"
    font_size = 10
    line_h = 14

    def wrap_line(text: str) -> list:
        text = safe_str(text)
        if not text:
            return [""]
        words = text.split(" ")
        out = []
        cur = ""
        for wd in words:
            trial = (cur + " " + wd).strip()
            if c.stringWidth(trial, font_name, font_size) <= max_width:
                cur = trial
            else:
                if cur:
                    out.append(cur)
                    cur = wd
                else:
                    # single very long token
                    out.append(trial)
                    cur = ""
        if cur or not out:
            out.append(cur)
        return out

    # Compose header fields block (like sample)
    fields = [
        f"KullanÄ±cÄ± AdÄ± {username}",
        f"Ad Soyad {full_name}",
        f"Kimlik No {tc}",
        f"Tarih {dt_str}",
        f"IP {ip}",
        "",
    ]

    # Body with sections
    raw_lines = body_txt.splitlines()
    lines = []
    for l in fields + raw_lines:
        if l.strip() == "":
            lines.append(" ")  # blank spacer
            continue
        lines.extend(wrap_line(l))

    page_no = 1
    draw_header(page_no)

    y = h - top - 58
    c.setFont(font_name, font_size)

    for ln in lines:
        if y <= bottom:
            c.showPage()
            page_no += 1
            draw_header(page_no)
            c.setFont(font_name, font_size)
            y = h - top - 58
        c.drawString(left, y, ln)
        y -= line_h

    c.save()
    return buf.getvalue()

TELEGRAM_TOKEN = (os.getenv("TELEGRAM_BOT_TOKEN", "") or os.getenv("TELEGRAM_TOKEN", "")).strip()
TELEGRAM_CHAT_ID_FALLBACK = os.getenv("TELEGRAM_CHAT_ID", "").strip()
TELEGRAM_GROUP_ID = os.getenv("TELEGRAM_GROUP_ID", "").strip()
TELEGRAM_GROUP_THREAD_ID = os.getenv("TELEGRAM_GROUP_THREAD_ID", "").strip()


PACKAGES = [
    {"name": "Basic", "price_try": 7500, "limit": 300},
    {"name": "Pro", "price_try": 15000, "limit": 600},
    {"name": "Ultra", "price_try": 40000, "limit": -1},  # -1 = unlimited
]

EXCHANGES = [
    ("OKX", "OKX"),
    ("BINANCE", "Binance"),
    ("BYBIT", "Bybit"),
    ("GATEIO", "Gateio"),
]


# Not Found Template (404)
NOT_FOUND_TEMPLATE = """
{% extends "base" %}

{% block content %}
<div class="min-h-screen flex flex-col items-center justify-center bg-[#0f0f0f] p-4">
  <div class="text-center max-w-md">
    <div class="flex justify-center mb-6">
      <div class="relative">
        <h1 class="text-9xl font-bold text-blue-600 opacity-20">404</h1>
        <div class="absolute inset-0 flex items-center justify-center">
            <svg class="w-20 h-20 text-blue-600/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
      </div>
    </div>

    <h2 class="text-2xl font-bold text-white mb-2">Sayfa BulunamadÄ±</h2>
    <p class="text-gray-400 mb-8">
      AradÄ±ÄŸÄ±nÄ±z sayfa mevcut deÄŸil veya taÅŸÄ±nmÄ±ÅŸ olabilir.
    </p>

    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <button onclick="history.back()" class="px-6 py-3 rounded-lg bg-[#242424] text-white hover:bg-[#2a2a2a] transition-colors border border-white/10 flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
        Geri DÃ¶n
      </button>

      <a href="/dashboard" class="px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        Ana Sayfa
      </a>
    </div>
  </div>
</div>
{% endblock %}
"""





# =========================

# Flask
# =========================
import jinja2
app = Flask(__name__)


### __AU_ENDPOINTS_V1

# AU endpoints v1 (DEMO/LIVE) â€” inserted under Flask app init
@app.post("/api/au/mode")
def au_mode_set():
    from flask import session as flask_session, request, jsonify
    m = (request.get_json(silent=True) or {}).get("mode","").strip().lower()
    if m == "real":
        m = "live"
    if m not in ("demo","live"):
        return jsonify({"ok": False, "error": "BAD_MODE", "detail": "mode demo veya live olmalÄ±"}), 400
    flask_session["mode"] = m
    flask_session["account_mode"] = m.upper()
    return jsonify({"ok": True, "mode": m}), 200

@app.get("/api/au/mode")
def au_mode_get():
    from flask import session as flask_session, jsonify
    m = (flask_session.get("mode") or flask_session.get("account_mode") or "demo").lower()
    if m == "real":
        m = "live"
    if m not in ("demo","live"):
        m = "demo"
    return jsonify({"ok": True, "mode": m}), 200

def _au_fetch_positions(cur, table, user_id):
    try:
        try:
            rows = cur.execute(f"SELECT * FROM {table} WHERE user_id=? ORDER BY id DESC LIMIT 500", (user_id,)).fetchall()
        except Exception:
            rows = cur.execute(f"SELECT * FROM {table} ORDER BY id DESC LIMIT 500").fetchall()
        return [dict(r) for r in rows]
    except Exception:
        return []

@app.get("/api/au/positions")
def au_positions():
    from flask import session as flask_session, jsonify, request
    import sqlite3

    if not flask_session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    user_id = int(flask_session.get("user_id") or 0)
    mode = (flask_session.get("mode") or flask_session.get("account_mode") or "demo").lower()
    if mode == "real":
        mode = "live"
    if mode not in ("demo","live"):
        mode = "demo"

    db_path = globals().get("DB_PATH") or globals().get("DB_FILE") or "/root/backend/data.db"
    con = sqlite3.connect(db_path)
    con.row_factory = sqlite3.Row
    cur = con.cursor()

    if mode == "live":
        pos = _au_fetch_positions(cur, "real_positions", user_id)
        try: con.close()
        except Exception: pass
        return jsonify({"ok": True, "mode": "live", "positions": pos}), 200

    pos = _au_fetch_positions(cur, "demo_positions", user_id)
    if not pos:
        pos = _au_fetch_positions(cur, "paper_test_positions", user_id)

    try: con.close()
    except Exception: pass
    return jsonify({"ok": True, "mode": "demo", "positions": pos}), 200

@app.get("/api/au/positions/demo")
def au_positions_demo():
    from flask import session as flask_session
    flask_session["mode"] = "demo"
    flask_session["account_mode"] = "DEMO"
    return au_positions()

@app.get("/api/au/positions/live")
def au_positions_live():
    from flask import session as flask_session
    flask_session["mode"] = "live"
    flask_session["account_mode"] = "LIVE"
    return au_positions()
### __END_AU_ENDPOINTS_V1



# --- DEMO_AI_AUTOSTART (auto-added) ---
# Gunicorn altÄ±nda __main__ Ã§alÄ±ÅŸmaz; demo AI loop burada baÅŸlar.
try:
    pass # start_demo_ai_loop()
except Exception as _e:
    try:
        print("[DEMO_AI_AUTOSTART] start_demo_ai_loop failed:", _e)
    except Exception:
        pass
# --- /DEMO_AI_AUTOSTART ---
app.secret_key = SESSION_SECRET
app.config['SESSION_COOKIE_PATH'] = '/'
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['PERMANENT_SESSION_LIFETIME'] = 86400 * 7  # 7 gÃ¼n
app.config['SESSION_PERMANENT'] = True
app.jinja_env.globals['footer'] = FOOTER_HTML
app.jinja_env.globals['global_css'] = GLOBAL_CSS

# Emergent Platform URL Redirect Handler
@app.before_request
def emergent_url_redirect():
    """Redirect non-api paths to /api/app/ paths for Emergent platform compatibility"""
    from flask import request
    path = request.path
    # Skip API endpoints and static files
    if path.startswith('/api/') or path.startswith('/static/'):
        return None
    # Map common paths to /api/app/ versions
    redirect_map = {
        '/login': '/api/app/login',
        '/register': '/api/app/register',
        '/logout': '/api/app/logout',
        '/forgot-password': '/api/app/forgot-password',
        '/dashboard': '/api/app/dashboard',
        '/trading-dashboard': '/api/app/dashboard',
        '/admin': '/api/app/admin',
        '/admin/dashboard': '/api/app/admin/dashboard',
        '/admin/users': '/api/app/admin/users',
        '/admin/contracts': '/api/app/admin/contracts',
        '/admin/webhooks': '/api/app/admin/webhooks',
        '/education': '/api/app/education',
        '/education-hub': '/api/app/education',
        '/portfolio': '/api/app/portfolio',
        '/portfolio-analytics': '/api/app/portfolio',
        '/payment': '/api/app/payment',
        '/payment-management': '/api/app/payment',
        '/exchange-api': '/api/app/exchange-api',
        '/history': '/api/app/history',
        '/trade-history': '/api/app/history',
        '/market': '/api/app/market',
        '/market-analysis': '/api/app/market',
        '/chat': '/api/app/chat',
        '/live-trading-chat': '/api/app/chat',
        '/pnl-reporting-center': '/api/app/pnl-reporting-center',
        '/ai-trade-recommendations': '/api/app/ai-trade-recommendations',
        '/arbitrage-monitor': '/api/app/arbitrage-monitor',
        '/getting-started': '/api/app/getting-started',
        '/getting-started-guide': '/api/app/getting-started',
        '/about': '/api/app/about',
        '/hakkimizda': '/api/app/about',
        '/faq': '/api/app/faq',
        '/support': '/api/app/support',
        '/contact': '/api/app/contact',
        '/notifications': '/api/app/notifications',
        '/system-health': '/api/app/system-health',
        '/': '/api/app/login',
    }
    if path in redirect_map:
        return redirect(redirect_map[path])
    return None

# =========================
# OKX TRADING INTEGRATION
# =========================
import hmac
import base64
import hashlib
from urllib.parse import urlencode

class OKXClient:
    """OKX API Client for real trading"""
    
    BASE_URL = "https://www.okx.com"
    
    def __init__(self, api_key: str = "", api_secret: str = "", passphrase: str = "", is_demo: bool = False):
        self.api_key = api_key
        self.api_secret = api_secret
        self.passphrase = passphrase
        self.is_demo = is_demo  # OKX has demo trading flag
        
    def _sign(self, timestamp: str, method: str, path: str, body: str = "") -> str:
        """Create OKX API signature"""
        message = timestamp + method.upper() + path + body
        mac = hmac.new(
            bytes(self.api_secret, encoding='utf8'),
            bytes(message, encoding='utf8'),
            digestmod='sha256'
        )
        return base64.b64encode(mac.digest()).decode()
    
    def _headers(self, method: str, path: str, body: str = "") -> dict:
        """Generate request headers with authentication"""
        timestamp = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%S.000Z')
        return {
            "OK-ACCESS-KEY": self.api_key,
            "OK-ACCESS-SIGN": self._sign(timestamp, method, path, body),
            "OK-ACCESS-TIMESTAMP": timestamp,
            "OK-ACCESS-PASSPHRASE": self.passphrase,
            "Content-Type": "application/json",
            "x-simulated-trading": "1" if self.is_demo else "0"
        }
    
    def get_balance(self) -> dict:
        """Get account balance"""
        try:
            path = "/api/v5/account/balance"
            headers = self._headers("GET", path)
            resp = requests.get(self.BASE_URL + path, headers=headers, timeout=10)
            data = resp.json()
            if data.get("code") == "0":
                return {"ok": True, "data": data.get("data", [])}
            return {"ok": False, "error": data.get("msg", "Unknown error")}
        except Exception as e:
            return {"ok": False, "error": str(e)}
    
    def get_usdt_balance(self) -> float:
        """Get USDT balance (spot/free). Hata olursa 0.0."""
        try:
            return float(okx_get_usdt_balance(self.api_key or "", self.api_secret or "", self.passphrase or ""))
        except Exception:
            return 0.0
    
    def place_market_order(self, symbol: str, side: str, amount_usdt: float) -> dict:
        """OKX v5 Spot market order. BUY sz=quote (USDT), SELL sz=base qty (SELL iÃ§in amount_usdt=qty)."""
        if not self.api_key or not self.api_secret or not self.passphrase:
            return {"ok": False, "error": "OKX API anahtarÄ± eksik"}
        try:
            base_url = os.getenv("OKX_BASE_URL", "https://www.okx.com").rstrip("/")
            path = "/api/v5/trade/order"
            url = base_url + path
            inst_id = safe_str(symbol).replace("/", "-").replace("_", "-").upper()
            action = "BUY" if safe_str(side).lower() in ("buy","long") else "SELL"
            body_obj = {
                "instId": inst_id,
                "tdMode": "cash",
                "side": "buy" if action == "BUY" else "sell",
                "ordType": "market",
            }
            if action == "BUY":
                body_obj["tgtCcy"] = "quote_ccy"
                body_obj["sz"] = f"{float(amount_usdt):.8f}".rstrip("0").rstrip(".")
            else:
                body_obj["sz"] = f"{float(amount_usdt):.8f}".rstrip("0").rstrip(".")
            body_json = json.dumps(body_obj, separators=(",", ":"), ensure_ascii=False)
            ts = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%S.%f")[:-3] + "Z"
            prehash = f"{ts}POST{path}{body_json}"
            sign = base64.b64encode(hmac.new(self.api_secret.encode("utf-8"), prehash.encode("utf-8"), hashlib.sha256).digest()).decode("utf-8")
            headers = {
                "OK-ACCESS-KEY": self.api_key,
                "OK-ACCESS-SIGN": sign,
                "OK-ACCESS-TIMESTAMP": ts,
                "OK-ACCESS-PASSPHRASE": self.passphrase,
                "Content-Type": "application/json",
            }
            r = requests.post(url, data=body_json.encode("utf-8"), headers=headers, timeout=15)
            try:
                j = r.json()
            except Exception:
                j = {}
            if isinstance(j, dict) and j.get("code") == "0":
                return {"ok": True, "data": j.get("data") or [], "raw": j}
            msg = safe_str(j.get("msg") or j.get("message") or "OKX emir hatasÄ±")
            return {"ok": False, "error": msg, "raw": j}
        except Exception as e:
            return {"ok": False, "error": safe_str(e)}
    
    def get_ticker_price(self, symbol: str) -> float:
        """Get current price for a symbol"""
        try:
            inst_id = symbol.replace("/", "-").upper()
            path = f"/api/v5/market/ticker?instId={inst_id}"
            resp = requests.get(self.BASE_URL + path, timeout=5)
            data = resp.json()
            if data.get("code") == "0" and data.get("data"):
                return float(data["data"][0].get("last", 0))
            return 0.0
        except:
            return 0.0
    
    def get_open_positions(self) -> list:
        """Get open positions (for margin/futures)"""
        try:
            path = "/api/v5/account/positions"
            headers = self._headers("GET", path)
            resp = requests.get(self.BASE_URL + path, headers=headers, timeout=10)
            data = resp.json()
            if data.get("code") == "0":
                return data.get("data", [])
            return []
        except:
            return []

# =========================
# MULTI-EXCHANGE SUPPORT
# =========================
# Supported exchanges: OKX, Binance, Gate.io, Bybit, BTCTurk

# Default OKX credentials for admin (Atalay)
DEFAULT_OKX_API_KEY = "52bc7929-e1ab-4f20-8084-74a7007a2ee8"
DEFAULT_OKX_API_SECRET = "28D593F40B6F34CD9C2B84D9002E6844"
DEFAULT_OKX_PASSPHRASE = "Atalay.98"

class BinanceClient:
    """Binance API Client"""
    BASE_URL = "https://api.binance.com"
    
    def __init__(self, api_key: str = "", api_secret: str = ""):
        self.api_key = api_key
        self.api_secret = api_secret
    
    def _sign(self, params: dict) -> str:
        query = urlencode(params)
        return hmac.new(
            self.api_secret.encode('utf-8'),
            query.encode('utf-8'),
            hashlib.sha256
        ).hexdigest()
    
    def _headers(self) -> dict:
        return {"X-MBX-APIKEY": self.api_key}
    
    def get_usdt_balance(self) -> float:
        try:
            params = {"timestamp": int(time.time() * 1000)}
            params["signature"] = self._sign(params)
            resp = requests.get(
                f"{self.BASE_URL}/api/v3/account",
                headers=self._headers(),
                params=params,
                timeout=10
            )
            data = resp.json()
            for b in data.get("balances", []):
                if b.get("asset") == "USDT":
                    return float(b.get("free", 0))
            return 0.0
        except:
            return 0.0
    
    def place_market_order(self, symbol: str, side: str, amount_usdt: float) -> dict:
        try:
            inst_id = symbol.replace("/", "").upper()  # BTC/USDT -> BTCUSDT
            params = {
                "symbol": inst_id,
                "side": side.upper(),
                "type": "MARKET",
                "quoteOrderQty": str(amount_usdt),
                "timestamp": int(time.time() * 1000)
            }
            params["signature"] = self._sign(params)
            resp = requests.post(
                f"{self.BASE_URL}/api/v3/order",
                headers=self._headers(),
                params=params,
                timeout=10
            )
            data = resp.json()
            if "orderId" in data:
                return {"ok": True, "order_id": str(data["orderId"]), "message": f"Order placed: {side.upper()} {inst_id}"}
            return {"ok": False, "error": data.get("msg", "Order failed")}
        except Exception as e:
            return {"ok": False, "error": str(e)}
    
    def get_ticker_price(self, symbol: str) -> float:
        try:
            inst_id = symbol.replace("/", "").upper()
            resp = requests.get(f"{self.BASE_URL}/api/v3/ticker/price?symbol={inst_id}", timeout=5)
            return float(resp.json().get("price", 0))
        except:
            return 0.0

class GateIOClient:
    """Gate.io API Client"""
    BASE_URL = "https://api.gateio.ws/api/v4"
    
    def __init__(self, api_key: str = "", api_secret: str = ""):
        self.api_key = api_key
        self.api_secret = api_secret
    
    def _sign(self, method: str, path: str, query: str = "", body: str = "") -> tuple:
        t = str(int(time.time()))
        hashed_payload = hashlib.sha512(body.encode('utf-8')).hexdigest()
        s = f"{method}\n{path}\n{query}\n{hashed_payload}\n{t}"
        sign = hmac.new(self.api_secret.encode('utf-8'), s.encode('utf-8'), hashlib.sha512).hexdigest()
        return t, sign
    
    def _headers(self, method: str, path: str, query: str = "", body: str = "") -> dict:
        t, sign = self._sign(method, path, query, body)
        return {
            "KEY": self.api_key,
            "SIGN": sign,
            "Timestamp": t,
            "Content-Type": "application/json"
        }
    
    def get_usdt_balance(self) -> float:
        try:
            path = "/spot/accounts"
            resp = requests.get(
                self.BASE_URL + path,
                headers=self._headers("GET", path),
                timeout=10
            )
            for acc in resp.json():
                if acc.get("currency") == "USDT":
                    return float(acc.get("available", 0))
            return 0.0
        except:
            return 0.0
    
    def place_market_order(self, symbol: str, side: str, amount_usdt: float) -> dict:
        try:
            inst_id = symbol.replace("/", "_").upper()  # BTC/USDT -> BTC_USDT
            path = "/spot/orders"
            body = json.dumps({
                "currency_pair": inst_id,
                "side": side.lower(),
                "type": "market",
                "amount": str(amount_usdt),
                "time_in_force": "ioc"
            })
            resp = requests.post(
                self.BASE_URL + path,
                headers=self._headers("POST", path, "", body),
                data=body,
                timeout=10
            )
            data = resp.json()
            if "id" in data:
                return {"ok": True, "order_id": str(data["id"]), "message": f"Order placed: {side.upper()} {inst_id}"}
            return {"ok": False, "error": data.get("message", "Order failed")}
        except Exception as e:
            return {"ok": False, "error": str(e)}
    
    def get_ticker_price(self, symbol: str) -> float:
        try:
            inst_id = symbol.replace("/", "_").upper()
            resp = requests.get(f"{self.BASE_URL}/spot/tickers?currency_pair={inst_id}", timeout=5)
            data = resp.json()
            if data and len(data) > 0:
                return float(data[0].get("last", 0))
            return 0.0
        except:
            return 0.0

class BybitClient:
    """Bybit API Client"""
    BASE_URL = "https://api.bybit.com"
    
    def __init__(self, api_key: str = "", api_secret: str = ""):
        self.api_key = api_key
        self.api_secret = api_secret
    
    def _sign(self, params: dict, timestamp: str) -> str:
        param_str = timestamp + self.api_key + "5000" + urlencode(sorted(params.items()))
        return hmac.new(
            self.api_secret.encode('utf-8'),
            param_str.encode('utf-8'),
            hashlib.sha256
        ).hexdigest()
    
    def _headers(self, params: dict) -> dict:
        timestamp = str(int(time.time() * 1000))
        return {
            "X-BAPI-API-KEY": self.api_key,
            "X-BAPI-SIGN": self._sign(params, timestamp),
            "X-BAPI-TIMESTAMP": timestamp,
            "X-BAPI-RECV-WINDOW": "5000",
            "Content-Type": "application/json"
        }
    
    def get_usdt_balance(self) -> float:
        try:
            params = {"accountType": "UNIFIED", "coin": "USDT"}
            resp = requests.get(
                f"{self.BASE_URL}/v5/account/wallet-balance",
                headers=self._headers(params),
                params=params,
                timeout=10
            )
            data = resp.json()
            if data.get("retCode") == 0:
                for item in data.get("result", {}).get("list", []):
                    for coin in item.get("coin", []):
                        if coin.get("coin") == "USDT":
                            return float(coin.get("availableToWithdraw", 0))
            return 0.0
        except:
            return 0.0
    
    def place_market_order(self, symbol: str, side: str, amount_usdt: float) -> dict:
        try:
            inst_id = symbol.replace("/", "").upper()
            body = {
                "category": "spot",
                "symbol": inst_id,
                "side": side.capitalize(),
                "orderType": "Market",
                "qty": str(amount_usdt),
                "marketUnit": "quoteCoin"
            }
            resp = requests.post(
                f"{self.BASE_URL}/v5/order/create",
                headers=self._headers(body),
                json=body,
                timeout=10
            )
            data = resp.json()
            if data.get("retCode") == 0:
                return {"ok": True, "order_id": data.get("result", {}).get("orderId", ""), "message": f"Order placed: {side.upper()} {inst_id}"}
            return {"ok": False, "error": data.get("retMsg", "Order failed")}
        except Exception as e:
            return {"ok": False, "error": str(e)}
    
    def get_ticker_price(self, symbol: str) -> float:
        try:
            inst_id = symbol.replace("/", "").upper()
            resp = requests.get(f"{self.BASE_URL}/v5/market/tickers?category=spot&symbol={inst_id}", timeout=5)
            data = resp.json()
            if data.get("retCode") == 0 and data.get("result", {}).get("list"):
                return float(data["result"]["list"][0].get("lastPrice", 0))
            return 0.0
        except:
            return 0.0

class BTCTurkClient:
    """BTCTurk API Client"""
    BASE_URL = "https://api.btcturk.com/api/v2"
    
    def __init__(self, api_key: str = "", api_secret: str = ""):
        self.api_key = api_key
        self.api_secret = api_secret
    
    def _sign(self, timestamp: str) -> str:
        message = self.api_key + timestamp
        return base64.b64encode(
            hmac.new(
                base64.b64decode(self.api_secret),
                message.encode('utf-8'),
                hashlib.sha256
            ).digest()
        ).decode()
    
    def _headers(self) -> dict:
        timestamp = str(int(time.time() * 1000))
        return {
            "X-PCK": self.api_key,
            "X-Stamp": timestamp,
            "X-Signature": self._sign(timestamp),
            "Content-Type": "application/json"
        }
    
    def get_usdt_balance(self) -> float:
        try:
            resp = requests.get(f"{self.BASE_URL}/balance", headers=self._headers(), timeout=10)
            for b in resp.json().get("data", []):
                if b.get("asset") == "USDT":
                    return float(b.get("free", 0))
            return 0.0
        except:
            return 0.0
    
    def place_market_order(self, symbol: str, side: str, amount_usdt: float) -> dict:
        try:
            # BTCTurk uses pairs like BTCUSDT, ETHUSDT
            inst_id = symbol.replace("/", "").upper()
            body = {
                "pairSymbol": inst_id,
                "orderType": side.lower(),
                "orderMethod": "market",
                "total": str(amount_usdt)
            }
            resp = requests.post(
                f"{self.BASE_URL}/order",
                headers=self._headers(),
                json=body,
                timeout=10
            )
            data = resp.json()
            if data.get("success"):
                return {"ok": True, "order_id": str(data.get("data", {}).get("id", "")), "message": f"Order placed: {side.upper()} {inst_id}"}
            return {"ok": False, "error": data.get("message", "Order failed")}
        except Exception as e:
            return {"ok": False, "error": str(e)}
    
    def get_ticker_price(self, symbol: str) -> float:
        try:
            inst_id = symbol.replace("/", "").upper()
            resp = requests.get(f"{self.BASE_URL}/ticker?pairSymbol={inst_id}", timeout=5)
            data = resp.json()
            if data.get("data"):
                return float(data["data"][0].get("last", 0))
            return 0.0
        except:
            return 0.0

# Exchange Factory
SUPPORTED_EXCHANGES = {
    "okx": OKXClient,
    "binance": BinanceClient,
    "gate": GateIOClient,
    "gateio": GateIOClient,
    "gate.io": GateIOClient,
    "bybit": BybitClient,
    "btcturk": BTCTurkClient
}

# Global exchange client cache per user {user_id: {exchange: client}}
_EXCHANGE_CLIENTS: Dict[int, Dict[str, Any]] = {}

def get_exchange_client(user_id: int, exchange: str = "okx"):
    """Get or create exchange client for a user"""
    exchange = exchange.lower().strip()
    
    if user_id not in _EXCHANGE_CLIENTS:
        _EXCHANGE_CLIENTS[user_id] = {}
    
    if exchange in _EXCHANGE_CLIENTS[user_id]:
        return _EXCHANGE_CLIENTS[user_id][exchange]
    
    # Load credentials from database - try exchange_api_keys first, then user_exchanges
    try:
        conn = db()
        
        # Try exchange_api_keys table first (new table)
        row = conn.execute(
            "SELECT api_key, api_secret, passphrase FROM exchange_api_keys WHERE (user_id=? OR user_id=?) AND exchange=?",
            (str(user_id), user_id, exchange)
        ).fetchone()
        
        if row and row[0]:
            # Decrypt if needed
            api_key = decrypt_data(row[0]) if row[0] else ""
            api_secret = decrypt_data(row[1]) if row[1] else ""
            passphrase = decrypt_data(row[2]) if row[2] else ""
            
            client_class = SUPPORTED_EXCHANGES.get(exchange)
            if client_class:
                if exchange == "okx":
                    client = client_class(api_key=api_key, api_secret=api_secret, passphrase=passphrase)
                else:
                    client = client_class(api_key=api_key, api_secret=api_secret)
                _EXCHANGE_CLIENTS[user_id][exchange] = client
                conn.close()
                return client
        
        # Fallback to user_exchanges table (legacy)
        row = conn.execute(
            "SELECT exchange_type, api_key, api_secret, api_passphrase FROM user_exchanges WHERE user_id=? AND exchange_type=?",
            (user_id, exchange)
        ).fetchone()
        conn.close()
        
        if row:
            client_class = SUPPORTED_EXCHANGES.get(exchange)
            if client_class:
                if exchange == "okx":
                    client = client_class(api_key=row[1] or "", api_secret=row[2] or "", passphrase=row[3] or "")
                else:
                    client = client_class(api_key=row[1] or "", api_secret=row[2] or "")
                _EXCHANGE_CLIENTS[user_id][exchange] = client
                return client
    except Exception as e:
        print(f"[GET_EXCHANGE_CLIENT] Error: {e}")
    
    # Return default OKX client for admin user (user_id=1)
    if user_id == 1 and exchange == "okx":
        client = OKXClient(
            api_key=DEFAULT_OKX_API_KEY,
            api_secret=DEFAULT_OKX_API_SECRET,
            passphrase=DEFAULT_OKX_PASSPHRASE
        )
        _EXCHANGE_CLIENTS[user_id]["okx"] = client
        return client
    
    # Return empty client
    client_class = SUPPORTED_EXCHANGES.get(exchange, OKXClient)
    return client_class()

# Backward compatible alias
def get_okx_client(user_id: int) -> OKXClient:
    return get_exchange_client(user_id, "okx")

def execute_real_trade(user_id: int, coin: str, side: str, amount_usdt: float, exchange: str = "okx") -> dict:
    """Execute a real trade on the specified exchange"""
    client = get_exchange_client(user_id, exchange)
    
    if not client.api_key:
        return {"ok": False, "error": f"{exchange.upper()} API anahtarlarÄ± ayarlanmamÄ±ÅŸ. Ayarlardan baÄŸlayÄ±n."}
    
    # Place the order
    result = client.place_market_order(coin, side, amount_usdt)
    
    if result.get("ok"):
        # Log the trade
        try:
            conn = db()
            conn.execute("""
                INSERT INTO real_trades (user_id, coin, side, amount_usdt, order_id, exchange, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            """, (user_id, coin, side.upper(), amount_usdt, result.get("order_id"), exchange, int(time.time())))
            conn.commit()
            conn.close()
        except:
            pass
    
    return result

# Ensure exchange tables exist
def ensure_exchange_tables():
    try:
        conn = db()
        
        # User exchanges table (stores API keys for each exchange)
        conn.execute("""
            CREATE TABLE IF NOT EXISTS user_exchanges (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                exchange_type TEXT NOT NULL,
                api_key TEXT,
                api_secret TEXT,
                api_passphrase TEXT,
                is_active INTEGER DEFAULT 1,
                created_at INTEGER,
                UNIQUE(user_id, exchange_type)
            )
        """)
        
        # Add exchange column to real_trades if not exists
        try:
            conn.execute("ALTER TABLE real_trades ADD COLUMN exchange TEXT DEFAULT 'okx'")
        except:
            pass
        
        # For backward compatibility, also add OKX columns to users table
        for col in ["okx_api_key", "okx_api_secret", "okx_passphrase"]:
            try:
                conn.execute(f"ALTER TABLE users ADD COLUMN {col} TEXT DEFAULT ''")
            except:
                pass
        
        # Create real_trades table
        conn.execute("""
            CREATE TABLE IF NOT EXISTS real_trades (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                coin TEXT NOT NULL,
                side TEXT NOT NULL,
                amount_usdt REAL,
                order_id TEXT,
                exchange TEXT DEFAULT 'okx',
                entry_price REAL,
                exit_price REAL,
                pnl REAL DEFAULT 0,
                status TEXT DEFAULT 'open',
                created_at INTEGER,
                closed_at INTEGER
            )
        """)
        
        # Create real_positions table
        conn.execute("""
            CREATE TABLE IF NOT EXISTS real_positions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                coin TEXT NOT NULL,
                side TEXT NOT NULL,
                amount_usdt REAL,
                exchange TEXT DEFAULT 'okx',
                entry_price REAL,
                current_price REAL,
                pnl REAL DEFAULT 0,
                status TEXT DEFAULT 'open',
                order_id TEXT,
                created_at INTEGER,
                closed_at INTEGER
            )
        """)
        
        # Insert default OKX credentials for admin (user_id=1) if not exists
        try:
            conn.execute("""
                INSERT OR IGNORE INTO user_exchanges (user_id, exchange_type, api_key, api_secret, api_passphrase, created_at)
                VALUES (1, 'okx', ?, ?, ?, ?)
            """, (DEFAULT_OKX_API_KEY, DEFAULT_OKX_API_SECRET, DEFAULT_OKX_PASSPHRASE, int(time.time())))
        except:
            pass
        
        conn.commit()
        conn.close()
    except:
        pass

# Alias for backward compatibility
ensure_okx_columns = ensure_exchange_tables


CORS_ORIGINS = [
    origin.strip()
    for origin in os.getenv("CORS_ORIGINS", "http://localhost:5173,http://127.0.0.1:5173").split(",")
    if origin.strip()
]

def _cors_origin():
    origin = request.headers.get("Origin")
    if not origin:
        return None
    if "*" in CORS_ORIGINS:
        return origin
    if origin in CORS_ORIGINS:
        return origin
    return None

@app.before_request
def _cors_preflight():
    if request.method != "OPTIONS":
        return None
    resp = app.make_response(("", 204))
    origin = _cors_origin()
    if origin:
        resp.headers["Access-Control-Allow-Origin"] = origin
        resp.headers["Access-Control-Allow-Credentials"] = "true"
        resp.headers["Access-Control-Allow-Headers"] = request.headers.get(
            "Access-Control-Request-Headers",
            "Content-Type, Authorization",
        )
        resp.headers["Access-Control-Allow-Methods"] = request.headers.get(
            "Access-Control-Request-Method",
            "GET, POST, PUT, PATCH, DELETE, OPTIONS",
        )
        resp.headers["Vary"] = "Origin"
    return resp

@app.after_request
def _cors_headers(resp):
    origin = _cors_origin()
    if origin:
        resp.headers["Access-Control-Allow-Origin"] = origin
        resp.headers["Access-Control-Allow-Credentials"] = "true"
        resp.headers["Access-Control-Expose-Headers"] = "Content-Disposition"
        resp.headers["Vary"] = "Origin"
    return resp

# =========================
# UI Routes (Replacement for React)
# =========================

def _init_users_table_check():
    """Ensure users table exists for login."""
    try:
        with app.app_context():
            conn = db()
            try:
                # Basic user table if not exists
                conn.execute("""
                    CREATE TABLE IF NOT EXISTS users (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        username TEXT UNIQUE NOT NULL,
                        password TEXT,
                        full_name TEXT,
                        email TEXT,
                        role TEXT DEFAULT 'user',
                        created_at INTEGER
                    )
                """)
                # Real Trades Table
                conn.execute("""
                    CREATE TABLE IF NOT EXISTS real_trades (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id TEXT,
                        symbol TEXT,
                        side TEXT,
                        amount REAL,
                        price REAL,
                        order_id TEXT,
                        status TEXT DEFAULT 'OPEN',
                        created_at TEXT,
                        closed_at TEXT,
                        pnl REAL
                    )
                """)
                # Migration: Ensure email column exists (if table existed before)
                try:
                    conn.execute("ALTER TABLE users ADD COLUMN email TEXT")
                except Exception:
                    # Column likely exists
                    pass
                conn.commit()
            finally:
                conn.close()
    except Exception as e:
        print(f"DB Init Error: {e}")

# Run once

# API-based page routes for Emergent platform compatibility
@app.route("/api/page/")
@app.route("/api/page/index")
def api_page_index():
    if session.get("logged_in"):
        return redirect("/api/page/dashboard")
    return redirect("/api/page/login")

@app.route("/")
def index_route():
    if session.get("logged_in"):
        return redirect("/dashboard")
    return redirect("/api/app/login")

@app.route("/login", methods=["GET", "POST"])
@app.route("/api/app/login", methods=["GET", "POST"])
def login_route():
    if request.method == "POST":
        username = request.form.get("username")
        password = request.form.get("password")
        remember = request.form.get("remember")
        
        if not username or not password:
            return render_template_string(LOGIN_TEMPLATE, title="GiriÅŸ Yap", global_css=GLOBAL_CSS, error="LÃ¼tfen tÃ¼m alanlarÄ± doldurun.")
        
        # Check DB
        user = None
        conn = db()
        try:
            # Check by username only (email column not in schema)
            # Include rowid explicitly for user isolation
            row = conn.execute("SELECT rowid, * FROM users WHERE username=?", (username,)).fetchone()
            if row:
                # Manually create dict with rowid
                cols = ["rowid"] + [desc[0] for desc in conn.execute("SELECT * FROM users WHERE 1=0").description]
                user = dict(zip(cols, row))
        finally:
            conn.close()
            salt = user.get("salt", "")
            stored_hash = user.get("password_hash", "")
            
            # Use proper password verification with salt
            verified = False
            if salt and stored_hash:
                verified = verify_password(password, salt, stored_hash)
            
            if verified:
                session["logged_in"] = True
                session["username"] = user.get("username")
                session["full_name"] = user.get("display_name") or user.get("username")
                
                # CRITICAL: Set user_id for data isolation
                session["user_id"] = user.get("rowid") or user.get("id") or 0
                
                # Standardize admin session variables
                is_admin = bool(user.get("is_admin"))
                session["is_admin"] = is_admin
                session["role"] = "admin" if is_admin else "user"
                
                # Restore manual trade prefs (persisted)
                try:
                    mex = safe_str(user.get("manual_exchange") or user.get("exchange_id") or "OKX").strip().upper()
                    if mex not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
                        mex = "OKX"
                    mdry = 1 if str(user.get("manual_dry_run") or "0").strip().lower() in ("1","true","on","yes") else 0
                    session["manual_exchange"] = mex
                    session["manual_dry_run"] = "1" if mdry == 1 else "0"
                except Exception:
                    session["manual_exchange"] = "OKX"
                    session["manual_dry_run"] = "0"

                # Session'Ä± kalÄ±cÄ± yap (7 gÃ¼n)
                session.permanent = True
                
                if is_admin:
                    return redirect("/api/app/admin/dashboard")
                return redirect("/api/app/dashboard")
        
        # Fallback: Admin token check (if username matches admin token logic? No, keep separate)
        
        # If we are here, login failed
        return render_template_string(LOGIN_TEMPLATE, title="GiriÅŸ Yap", global_css=GLOBAL_CSS, error="KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±.")

    return render_template_string(LOGIN_TEMPLATE, title="GiriÅŸ Yap", global_css=GLOBAL_CSS)

# Redundant dashboard_route removed. page_dashboard consolidated at end of file.

@app.route("/register", methods=["GET", "POST"])
def register_route():
    if request.method == "POST":
        email = request.form.get("email", "").strip()
        password = request.form.get("password", "").strip()
        confirm_password = request.form.get("confirm_password", "").strip()
        full_name = request.form.get("full_name", "").strip()
        phone = request.form.get("phone", "").strip()
        experience = request.form.get("experience", "").strip()
        exchanges = request.form.getlist("exchanges")
        
        # Validation
        if not email or not password or not full_name:
            return render_template_string(REGISTER_TEMPLATE, title="Hesap OluÅŸtur", global_css=GLOBAL_CSS, error="LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.")
        
        if password != confirm_password:
            return render_template_string(REGISTER_TEMPLATE, title="Hesap OluÅŸtur", global_css=GLOBAL_CSS, error="Åifreler eÅŸleÅŸmiyor.")
        
        if len(password) < 8:
            return render_template_string(REGISTER_TEMPLATE, title="Hesap OluÅŸtur", global_css=GLOBAL_CSS, error="Åifre en az 8 karakter olmalÄ±dÄ±r.")
        
        # Check if user exists
        conn = db()
        try:
            existing = conn.execute("SELECT username FROM users WHERE username=?", (email,)).fetchone()
            if existing:
                return render_template_string(REGISTER_TEMPLATE, title="Hesap OluÅŸtur", global_css=GLOBAL_CSS, error="Bu e-posta adresi zaten kayÄ±tlÄ±.")
            
            # Hash password with salt
            import secrets
            salt = secrets.token_hex(16)
            pw_hash = hash_password(password, salt)
            
            # Insert user with correct schema
            conn.execute(
                """INSERT INTO users (username, display_name, salt, password_hash, is_admin, trade_enabled, 
                   disable_on_limit, exchange_id, webhook_secret, package_name, package_limit, package_months, 
                   expires_at, total_pnl, created_at, email)
                   VALUES (?, ?, ?, ?, 0, 1, 1, 'OKX', '', 'Basic', 300, 1, 0, 0, ?, ?)""",
                (email, full_name, salt, pw_hash, now_ts(), email)
            )
            conn.commit()
            
            return render_template_string(REGISTER_TEMPLATE, title="Hesap OluÅŸtur", global_css=GLOBAL_CSS, 
                success="KayÄ±t baÅŸarÄ±lÄ±! 1 gÃ¼nlÃ¼k Ã¼cretsiz deneme ve test bakiyesi hesabÄ±nÄ±za tanÄ±mlandÄ±. Åimdi giriÅŸ yapabilirsiniz.")
        except Exception as e:
            import traceback
            traceback.print_exc()
            # Also write to file for debugging
            with open("register_error.log", "w") as f:
                traceback.print_exc(file=f)
            return render_template_string(REGISTER_TEMPLATE, title="Hesap OluÅŸtur", global_css=GLOBAL_CSS, error=f"KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu: {str(e)}")
        finally:
            conn.close()
    
    return render_template_string(REGISTER_TEMPLATE, title="Hesap OluÅŸtur", global_css=GLOBAL_CSS)

@app.route("/forgot-password", methods=["GET", "POST"])
def forgot_password_route():
    if request.method == "POST":
        email = request.form.get("email", "").strip()
        if not email:
            return render_template_string(FORGOT_PASSWORD_TEMPLATE, title="Åifremi Unuttum", global_css=GLOBAL_CSS, error="LÃ¼tfen e-posta adresinizi girin.")
        
        # Check if user exists
        conn = db()
        try:
            user = conn.execute("SELECT username, email FROM users WHERE email=? OR username=?", (email, email)).fetchone()
            if user:
                # In production, send actual password reset email here
                # For now, just show success message
                return render_template_string(FORGOT_PASSWORD_TEMPLATE, title="Åifremi Unuttum", global_css=GLOBAL_CSS, success=True, email=email)
            else:
                # Still show success to prevent email enumeration
                return render_template_string(FORGOT_PASSWORD_TEMPLATE, title="Åifremi Unuttum", global_css=GLOBAL_CSS, success=True, email=email)
        except Exception as e:
            return render_template_string(FORGOT_PASSWORD_TEMPLATE, title="Åifremi Unuttum", global_css=GLOBAL_CSS, error=f"Bir hata oluÅŸtu: {str(e)}")
        finally:
            conn.close()
    
    return render_template_string(FORGOT_PASSWORD_TEMPLATE, title="Åifremi Unuttum", global_css=GLOBAL_CSS)

@app.route("/logout")
def logout_route():
    session.clear()
    return redirect("/api/app/login")

@app.route("/admin")
def admin_redirect_route():
    if not session.get("logged_in"):
        return redirect("/api/app/login")
    
    # Admin usernames/emails list
    ADMIN_USERS = ["atalayulusoyyy@gmail.com", "atalayulusoyy@gmail.com", "admin@autotrade.com", "atalay"]
    username = session.get("username", "")
    
    if session.get("role") == "admin" or session.get("is_admin") or username.lower() in [u.lower() for u in ADMIN_USERS]:
        return redirect("/admin/dashboard")
    return redirect("/dashboard")

@app.route("/admin-dashboard")
def admin_dashboard_route():
    return redirect("/admin/dashboard")

@app.route("/notifications")
def notifications_route():
    if not session.get("logged_in"):
        return redirect("/api/app/login")
    return render_template_string(NOTIFICATION_TEMPLATE, title="Bildirim Tercihleri", global_css=GLOBAL_CSS, sidebar=get_sidebar_html("notifications"))

@app.route("/system-health")
def system_health_route():
    if not session.get("logged_in"):
        return redirect("/api/app/login")
    from datetime import datetime
    current_time = datetime.now().strftime("%H:%M:%S")
    return render_template_string(SYSTEM_HEALTH_TEMPLATE, title="Sistem SaÄŸlÄ±ÄŸÄ±", global_css=GLOBAL_CSS, current_time=current_time, sidebar=get_sidebar_html("health"))

# Duplicate /exchange-api route removed

# Redundant about_us_route removed. Consolidated at end.

# Redundant contact_route removed. Consolidated at end.


# Redirected to consolidated routes at the end.


# UI routes moved to the end of file for consolidation.

# Global cache for real prices
_REAL_PRICE_CACHE = {"prices": {}, "ts": 0}

@app.route("/api/public/ticker")
def api_public_ticker_route():
    import time
    global _REAL_PRICE_CACHE
    
    # Cache TTL 30 seconds
    now = int(time.time())
    if _REAL_PRICE_CACHE["prices"] and (now - _REAL_PRICE_CACHE["ts"]) < 30:
        return jsonify({
            "ok": True,
            "usdt_try": 34.50,
            "prices": _REAL_PRICE_CACHE["prices"],
            "cached": True
        })
    
    # Fetch real prices from Binance
    symbols = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "BNBUSDT", "XRPUSDT", "ADAUSDT", "DOGEUSDT", "AVAXUSDT", "TRXUSDT", "TONUSDT"]
    current_prices = {}
    
    try:
        import requests
        # Single API call to get all prices
        resp = requests.get("https://api.binance.com/api/v3/ticker/price", timeout=5)
        if resp.status_code == 200:
            all_prices = resp.json()
            price_map = {p["symbol"]: float(p["price"]) for p in all_prices}
            
            for sym in symbols:
                if sym in price_map:
                    coin = sym.replace("USDT", "")
                    current_prices[f"{coin}/USDT"] = round(price_map[sym], 6 if price_map[sym] < 1 else 2)
            
            _REAL_PRICE_CACHE["prices"] = current_prices
            _REAL_PRICE_CACHE["ts"] = now
    except Exception as e:
        print(f"[TICKER] Binance API error: {e}")
    
    # Fallback to cached or mock if API fails
    if not current_prices:
        if _REAL_PRICE_CACHE["prices"]:
            current_prices = _REAL_PRICE_CACHE["prices"]
        else:
            # Last resort mock data
            current_prices = {
                "BTC/USDT": 98450.00, "ETH/USDT": 3560.00, "SOL/USDT": 145.50,
                "BNB/USDT": 590.20, "XRP/USDT": 1.12, "ADA/USDT": 0.78,
                "DOGE/USDT": 0.12, "AVAX/USDT": 35.40
            }
    
    return jsonify({
        "ok": True,
        "usdt_try": 34.50,
        "prices": current_prices,
        "cached": False
    })




@app.route("/api/ticker", methods=["GET"])
def api_ticker_alias():
    """
    UI uyumluluk alias.
    Login zorunlu olmadan /api/public/ticker dÃ¶ner.
    """
    return api_public_ticker_route()


@app.route("/api/notifications/test", methods=["POST"])
@require_login
def api_notifications_test():
    user = get_user(session["user_id"])
    success = False
    error = None
    
    try:
        msg = "ğŸ”” *Test Notification*\n\nThis is a test notification from your AutoTrade bot.\nTime: " + iso_now_local()
        
        if user.get("telegram_chat_id"):
             log_line(f"Sending test telegram to {user['email']} (Chat ID: {user['telegram_chat_id']})")
             telegram_send_to(safe_str(user['telegram_chat_id']), msg)
             success = True
        else:
             log_line(f"User {user['email']} has no telegram_chat_id. Please configure in settings.")
             success = False
             error = "Telegram Chat ID tanÄ±mlÄ± deÄŸil. LÃ¼tfen ayarlardan ekleyin."

        return jsonify({"success": True, "message": "Test notification sent (checked logs/telegram)"})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500


@app.route("/api/notifications/settings", methods=["GET", "POST"])
def api_notifications_settings():
    """Get/Save notification settings for user"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id")
    
    if request.method == "GET":
        try:
            conn = db()
            row = conn.execute("SELECT notification_settings FROM users WHERE id=?", (user_id,)).fetchone()
            conn.close()
            
            if row and row[0]:
                import json
                settings = json.loads(row[0])
            else:
                settings = {
                    "trade_alerts": True,
                    "price_alerts": True,
                    "system_alerts": True,
                    "sound_enabled": True,
                    "vibration_enabled": True,
                    "email_enabled": False
                }
            return jsonify({"ok": True, "settings": settings})
        except Exception as e:
            return jsonify({"ok": False, "error": str(e)})
    
    else:  # POST
        try:
            data = request.get_json() or {}
            import json
            settings_json = json.dumps(data)
            
            conn = db()
            # Add column if not exists
            try:
                conn.execute("ALTER TABLE users ADD COLUMN notification_settings TEXT")
            except:
                pass
            
            conn.execute("UPDATE users SET notification_settings=? WHERE id=?", (settings_json, user_id))
            conn.commit()
            conn.close()
            
            return jsonify({"ok": True, "message": "Bildirim ayarlarÄ± kaydedildi"})
        except Exception as e:
            return jsonify({"ok": False, "error": str(e)})


# UI routes moved to the end of file for consolidation.

@app.get("/api/signals/pending")
def api_signals_pending_list():
    # UI bekliyor, demo icin bos donuyoruz
    return jsonify([])
@app.get("/api/signals/history")
def api_signals_history():
    # UI bu endpointi istiyor, ÅŸimdilik boÅŸ liste dÃ¶nelim
    return jsonify({"signals": []})

@app.get("/api/positions/open")
def api_positions_open_list():
    """Return open positions (from demo_positions table + demo simulator memory + trades table)"""
    global _demo_positions
    
    positions = []
    
    # Get current user
    username = session.get("username")
    user_id = session.get("user_id", 0)
    if not username and not user_id:
        return jsonify([])
    
    try:
        conn = db()
        
        # 1. Get from demo_positions table (MANUAL demo trades)
        try:
            # Check if source column exists
            cols = [row[1] for row in conn.execute("PRAGMA table_info(demo_positions)").fetchall()]
            has_source = "source" in cols
            
            if has_source:
                manual_rows = conn.execute("""
                    SELECT id, coin, side, amount_usdt, entry_price, pnl, created_at, source
                    FROM demo_positions
                    WHERE user_id = ? AND status = 'open'
                    ORDER BY created_at DESC LIMIT 20
                """, (user_id,)).fetchall()
            else:
                manual_rows = conn.execute("""
                    SELECT id, coin, side, amount_usdt, entry_price, pnl, created_at
                    FROM demo_positions
                    WHERE user_id = ? AND status = 'open'
                    ORDER BY created_at DESC LIMIT 20
                """, (user_id,)).fetchall()
            
            for row in manual_rows:
                pos_data = {
                    "id": f"manual_{row['id']}",
                    "symbol": row["coin"],
                    "side": row["side"],
                    "amount": float(row["amount_usdt"] or 0),
                    "entryPrice": float(row["entry_price"] or 0),
                    "unrealizedPnl": float(row["pnl"] or 0),
                    "mode": "DEMO",
                    "source": "manual",
                    "timestamp": row["created_at"]
                }
                if has_source and len(row) > 7:
                    pos_data["source"] = row["source"] or "manual"
                positions.append(pos_data)
        except Exception as e:
            print(f"[POSITIONS] demo_positions table error: {e}")
        
        # 2. Get from _demo_positions memory (AUTO demo simulator positions)
        for key, pos in _demo_positions.items():
            if key.startswith("demo_"):
                # Check not already added
                symbol = pos.get("coin", "BTC/USDT")
                existing = any(p["symbol"] == symbol for p in positions)
                if not existing:
                    positions.append({
                        "id": key,
                        "symbol": symbol,
                        "side": "BUY",
                        "amount": pos.get("amount", 0),
                        "entryPrice": pos.get("buy_price", 0),
                        "unrealizedPnl": 0,
                        "mode": "DEMO",
                        "source": "auto",
                        "timestamp": pos.get("buy_time", 0)
                    })
        
        # 3. Get from trades table (BUY without matching SELL - older trades)
        try:
            if username:
                trade_rows = conn.execute("""
                    SELECT t.id, t.symbol, t.real_usdt, t.created_at
                    FROM trades t
                    WHERE t.username = ? AND t.action = 'BUY' AND t.dry_run = 1
                    AND NOT EXISTS (
                        SELECT 1 FROM trades t2 
                        WHERE t2.username = t.username 
                        AND t2.symbol = t.symbol 
                        AND t2.action = 'SELL'
                        AND t2.created_at > t.created_at
                    )
                    ORDER BY t.created_at DESC LIMIT 10
                """, (username,)).fetchall()
                
                for row in trade_rows:
                    symbol = row["symbol"]
                    existing = any(p["symbol"] == symbol for p in positions)
                    if not existing:
                        positions.append({
                            "id": f"trade_{row['id']}",
                            "symbol": symbol,
                            "side": "BUY",
                            "amount": float(row["real_usdt"] or 0),
                            "entryPrice": 0,
                            "unrealizedPnl": 0,
                            "mode": "DEMO",
                            "source": "auto",
                            "timestamp": row["created_at"]
                        })
        except Exception as e:
            print(f"[POSITIONS] trades table error: {e}")
        
        conn.close()
    except Exception as e:
        print(f"[POSITIONS] Error: {e}")
    
    return jsonify(positions)

# --- QUICK HEALTH + ALIAS ENDPOINTS (UI compatibility) ---

@app.get("/api/health")
def api_health():
    return jsonify({"ok": True})


@app.get("/api/coins")
@app.route("/api/symbols", methods=["GET"])
def api_coins_alias():
    # Multi-exchange USDT spot coin listesi (OKX+Binance+Bybit+Gateio) + cache
    import time
    import threading
    try:
        import ccxt
    except Exception:
        return jsonify({"ok": False, "error": "CCXT_MISSING"}), 500

    global _UI_COINS_CACHE, _UI_COINS_LOCK
    try:
        _UI_COINS_CACHE
    except Exception:
        _UI_COINS_CACHE = {"ts": 0, "data": [], "count": 0}
    try:
        _UI_COINS_LOCK
    except Exception:
        _UI_COINS_LOCK = threading.Lock()

    TTL = 300  # saniye
    now = int(time.time())

    # refresh cache (ops)
    try:
        if request.args.get("refresh") == "1":
            with _UI_COINS_LOCK:
                _UI_COINS_CACHE["ts"] = 0
                _UI_COINS_CACHE["data"] = []
                _UI_COINS_CACHE["count"] = 0
    except Exception:
        pass

    with _UI_COINS_LOCK:
        if _UI_COINS_CACHE.get("data") and (now - int(_UI_COINS_CACHE.get("ts") or 0) < TTL):
            coins_ui = _UI_COINS_CACHE["data"]
            return jsonify({
                "ok": True,
                "cached": True,
                "source": "ccxt_multi",
                "exchange": "okx,binance,bybit,gateio",
                "coins": coins_ui,
                "count": len(coins_ui)
            })

    def norm(sym):
        if not sym:
            return None
        s = sym.replace("-", "/")
        if ":" in s:
            s = s.split(":")[0]
        return s

    def load_usdt_spot(ex):
        out = set()
        try:
            mk = ex.load_markets()
            for v in mk.values():
                if not v:
                    continue
                if v.get("spot") is True and v.get("quote") == "USDT":
                    sym = norm(v.get("symbol"))
                    if sym and sym.endswith("/USDT"):
                        base = sym.split("/")[0]
                        if (not base) or (len(base) < 2) or (len(base) > 20) or (not base.isalnum()):
                            continue
                        out.add(sym)
        except Exception:
            pass
        return out

    exchanges = []
    for ctor in ("okx", "binance", "bybit", "gateio"):
        try:
            ex = getattr(ccxt, ctor)({"enableRateLimit": True})
            exchanges.append(ex)
        except Exception:
            continue

    allc = set()
    for ex in exchanges:
        allc.update(load_usdt_spot(ex))

    coins = sorted(allc)
    coins_ui = [{"label": c, "symbol": c, "value": c} for c in coins]

    with _UI_COINS_LOCK:
        _UI_COINS_CACHE["ts"] = int(time.time())
        _UI_COINS_CACHE["data"] = coins_ui
        _UI_COINS_CACHE["count"] = len(coins_ui)

    return jsonify({
        "ok": True,
        "cached": False,
        "source": "ccxt_multi",
        "exchange": "okx,binance,bybit,gateio",
        "coins": coins_ui,
        "count": len(coins_ui)
    })
def api_ohlc_alias():
    # UI /api/ohlc Ã§aÄŸÄ±rÄ±yor
    try:
        return api_public_ohlc()
    except Exception:
        return jsonify({"symbol": (request.args.get("symbol") or "").strip(), "tf": (request.args.get("tf") or "1m").strip().lower(), "candles": []})


@app.get("/api/public/positions")
def api_public_positions_alias():
    # UI login varsa pozisyonlarÄ± ister. Login yoksa boÅŸ dÃ¶ner.
    try:
        username = safe_str(session.get("username") or "").strip()
    except Exception:
        username = ""

    if not username:
        return jsonify({"ok": True, "positions": []})

    try:
        raw = list_positions(username) or []
    except Exception:
        raw = []

    # /api/positions ile aynÄ± Ã§Ä±ktÄ± formatÄ±nÄ± verelim
    try:
        with app.test_request_context():
            pass
    except Exception:
        pass

    # Reuse grouping logic from /api/positions (copy minimal)
    groups = {}
    for p in raw:
        if p is not None and not isinstance(p, dict):
            try:
                p = dict(p)
            except Exception:
                continue
        if not p:
            continue

        ex = safe_str(p.get("exchange_id") or DEFAULT_EXCHANGE).strip().upper() or "OKX"
        sym = safe_str(p.get("symbol") or "").strip().upper()
        if not sym:
            continue
        sym = sym.replace("-", "/").replace("_", "/")
        if "USDT" in sym and "/" not in sym and sym.endswith("USDT") and len(sym) > 4:
            sym = sym[:-4] + "/USDT"

        gid = sym
        qty = _to_float(p.get("qty"), 0.0)
        entry_price = _to_float(p.get("entry_price"), 0.0)
        entry_usdt = _to_float(p.get("entry_usdt"), 0.0)

        g = groups.get(gid)
        if not g:
            g = {
                "id": int(p.get("id") or 0),
                "group_ids": [],
                "exchange_id": ex,
                "symbol": sym,
                "dry_run": int(_to_int(p.get("dry_run"), 0)),
                "qty": 0.0,
                "entry_price": 0.0,
                "entry_usdt": 0.0,
                "created_at": int(p.get("created_at") or 0),
            }
            groups[gid] = g

        pid = int(p.get("id") or 0)
        g["group_ids"].append(pid)
        g["qty"] += qty
        g["entry_usdt"] += entry_usdt

        if qty > 0 and entry_price > 0:
            prev_qty = max(_to_float(g.get("qty"), 0.0) - qty, 0.0)
            prev_avg = _to_float(g.get("entry_price"), 0.0)
            if prev_qty <= 0:
                g["entry_price"] = entry_price
            else:
                g["entry_price"] = (prev_avg * prev_qty + entry_price * qty) / (prev_qty + qty)

        try:
            g["created_at"] = min(int(g.get("created_at") or 0), int(p.get("created_at") or 0))
        except Exception:
            pass
        try:
            g["id"] = min(int(g.get("id") or 0), pid)
        except Exception:
            pass
        try:
            if int(_to_int(p.get("dry_run"), 0)) == 0:
                g["dry_run"] = 0
        except Exception:
            pass

    out = list(groups.values())

    for g in out:
        ex = safe_str(g.get("exchange_id") or DEFAULT_EXCHANGE).strip().upper()
        sym = safe_str(g.get("symbol") or "").strip().upper()
        qty = _to_float(g.get("qty"), 0.0)
        entry_price = _to_float(g.get("entry_price"), 0.0)

        cur_px = 0.0
        try:
            cur_px = float(public_price(ex, sym) or 0.0)
        except Exception:
            cur_px = 0.0

        if cur_px <= 0:
            g["current_price"] = None
            g["pnl_usdt"] = None
        else:
            g["current_price"] = cur_px
            if qty > 0 and entry_price > 0:
                g["pnl_usdt"] = (cur_px - entry_price) * qty
            else:
                g["pnl_usdt"] = 0.0

    out.sort(key=lambda x: int(x.get("created_at") or 0), reverse=True)
    return jsonify({"ok": True, "positions": out})


def list_trades(username: str, limit: int = 200) -> List[Dict[str, Any]]:
    username = safe_str(username).strip()
    if limit < 1:
        limit = 1
    if limit > 500:
        limit = 500
    conn = db()
    try:
        rows = conn.execute(
            "SELECT id, exchange_id, action, symbol, real_usdt, pnl_usdt, dry_run, created_at FROM trades WHERE username=? ORDER BY id DESC LIMIT ?",
            (username, int(limit)),
        ).fetchall()
        return [dict(r) for r in rows]
    except Exception:
        return []
    finally:
        try:
            conn.close()
        except Exception:
            pass




# --- UI compatibility: Bot settings / controls ---

@app.route("/api/positions/<mode>", methods=["GET"])
def api_positions_mode(mode):
    """
    UI uyumluluk endpointi.
    mode: demo | live
    Login yoksa 401 vermek yerine ok:true ve boÅŸ liste dÃ¶ner.
    """
    mode = (mode or "").lower().strip()
    if mode not in ("demo", "live"):
        return jsonify({"ok": False, "error": "BAD_MODE", "detail": "mode demo veya live olmalÄ±"}), 400

    # Login yoksa bile demo ekranÄ± kÄ±rÄ±lmasÄ±n
    try:
        # mevcut yardÄ±mcÄ± fonksiyonlar varsa kullan
        mode = "real" # Forced Real
        if False: # Demo Disabled
            # demo positions: varsa test_positions / demo_positions getterlarÄ±
            if "get_demo_positions" in globals():
                positions = get_demo_positions()  # type: ignore
                return jsonify({"ok": True, "mode": "demo", "positions": positions})
            if "demo_positions" in globals():
                return jsonify({"ok": True, "mode": "demo", "positions": demo_positions})  # type: ignore
        else:
            if "get_live_positions" in globals():
                positions = get_live_positions()  # type: ignore
                return jsonify({"ok": True, "mode": "live", "positions": positions})
    except Exception as e:
        return jsonify({"ok": False, "error": "POSITIONS_FAILED", "detail": str(e)}), 500

    return jsonify({"ok": True, "mode": mode, "positions": []})


@app.get("/api/bot/settings")
def api_bot_settings_get():
    """UI Bot Ayarlari paneli icin.

    UI sadece bu endpoint var diye butonu aktif edebilir.
    """
    try:
        username = safe_str(session.get("username") or "").strip()
    except Exception:
        username = ""

    # demo defaults
    settings = {
        "ok": True,
        "enabled": True,
        "mode": "DEMO",
        "exchange": safe_str(request.args.get("exchange") or "OKX").upper(),
        "max_positions": 10,
        "risk_level": "medium",
    }
    if username:
        settings["username"] = username
    return jsonify(settings)

@app.post("/api/bot/settings")
def api_bot_settings_post():
    # Kaydetme icin basit kabul
    j = request.get_json(silent=True) or {}
    return jsonify({"ok": True, "saved": True, "settings": j})

@app.post("/api/bot/start")
def api_bot_start():
    return jsonify({"ok": True, "status": "started"})

@app.post("/api/bot/stop")
def api_bot_stop():
    return jsonify({"ok": True, "status": "stopped"})

@app.get("/api/bot/status")
def api_bot_status():
    return jsonify({"ok": True, "running": True, "ts": now_ts()})

# --- UI compatibility: Market sentiment / AI hooks ---

@app.get("/api/market/sentiment")
def api_market_sentiment():
    # Frontend hc.getMarketSentiment icin
    symbols_raw = (request.args.get("symbols") or "").strip()
    symbols = [s.strip().upper() for s in symbols_raw.split(",") if s.strip()]
    if not symbols:
        symbols = ["BTC/USDT", "ETH/USDT"]
    out = []
    for s1 in symbols:
        out.append({"symbol": s1, "sentiment": "neutral", "score": 0})
    return jsonify({"ok": True, "items": out})

@app.get("/api/ai/recommendations")
def api_ai_recommendations_alias():
    # UI bazen public yerine bu yolu kullanir
    try:
        return api_public_ai_recommendations()
    except Exception:
        return jsonify({"ok": True, "recommendations": []})

@app.get("/api/ai/market-sentiment")
def api_ai_market_sentiment_alias():
    return api_market_sentiment()


# AI execute: UI "Ä°ÅŸlem Yap" popup'Ä± bunu Ã§aÄŸÄ±rÄ±r
# -------------------------
# TELEGRAM NOTIFICATION HELPER
# -------------------------
def send_telegram_message(text, chat_id=None):
    """Send notification to Telegram bot."""
    try:
        token = os.getenv("TELEGRAM_BOT_TOKEN", "")
        target_chat_id = chat_id or os.getenv("TELEGRAM_ADMIN_CHAT_ID", "")
        
        if not token:
            print("[TELEGRAM] Bot token not configured")
            return False
        
        if not target_chat_id:
            # Try to get admin chat ID from database
            try:
                conn = db()
                row = conn.execute("SELECT telegram_chat_id FROM users WHERE is_admin=1 AND telegram_chat_id IS NOT NULL AND telegram_chat_id != '' LIMIT 1").fetchone()
                conn.close()
                if row:
                    target_chat_id = row[0]
            except:
                pass
        
        if not target_chat_id:
            print("[TELEGRAM] No admin chat ID configured. User should send /start to @AtalayUlusoyTraderBot and enter their chat ID in admin settings.")
            return False
            
        url = f"https://api.telegram.org/bot{token}/sendMessage"
        resp = requests.post(url, json={"chat_id": target_chat_id, "text": text, "parse_mode": "HTML"}, timeout=10)
        if resp.status_code == 200:
            print(f"[TELEGRAM] Message sent to {target_chat_id}")
            return True
        else:
            print(f"[TELEGRAM] Failed: {resp.text}")
            return False
    except Exception as e:
        print(f"[TELEGRAM] Error: {e}")
        return False

# -------------------------
# REAL TRADING LOGIC (CCXT)
# -------------------------

def _get_ccxt_exchange(user: dict):
    """Initialize CCXT exchange instance for user."""
    import ccxt
    
    ex_name = safe_str(user.get("exchange_id") or "OKX").upper()
    api_key = user.get("api_key") or user.get(f"{ex_name.lower()}_api_key")
    secret = user.get("api_secret") or user.get(f"{ex_name.lower()}_api_secret")
    passphrase = user.get("api_passphrase")
    
    if not api_key or not secret:
        raise Exception(f"API Keys missing for Real Trading ({ex_name})")
        
    config = {
        'apiKey': api_key,
        'secret': secret,
        'enableRateLimit': True,
        'options': {'defaultType': 'spot'}
    }
    if passphrase:
        config['password'] = passphrase
        
    cls = getattr(ccxt, ex_name.lower(), None)
    if not cls:
        raise Exception(f"Exchange {ex_name} not supported")
        
    return cls(config)

def place_order(exchange_id: str, action: str, symbol: str, usdt_amount: float, dry_run: bool,
                api_key: str, api_secret: str, api_passphrase: str = "") -> dict:
    """
    Execute market buy/sell order on specified exchange.
    
    Args:
        exchange_id: Exchange name (OKX, BINANCE, BYBIT, GATEIO)
        action: "BUY" or "SELL"
        symbol: Trading pair (e.g., "BTC/USDT")
        usdt_amount: Amount in USDT to trade
        dry_run: If True, skip actual order (for demo mode)
        api_key: Exchange API key
        api_secret: Exchange API secret
        api_passphrase: Exchange API passphrase (OKX, GATEIO)
    
    Returns:
        dict with ok, fill_price, fill_qty, real_usdt, fee_usdt, fee_coin, fee_coin_ccy, ord_id, reason
    """
    try:
        import ccxt
        
        # Validate inputs
        if not api_key or not api_secret:
            return {"ok": False, "reason": "API credentials missing"}
        
        if action not in ("BUY", "SELL"):
            return {"ok": False, "reason": "Invalid action"}
        
        # Normalize exchange name
        ex_name = str(exchange_id).upper().strip()
        if ex_name not in ("OKX", "BINANCE", "BYBIT", "GATEIO"):
            return {"ok": False, "reason": f"Unsupported exchange: {ex_name}"}

        
        # Initialize exchange
        config = {
            'apiKey': api_key,
            'secret': api_secret,
            'enableRateLimit': True,
            'options': {'defaultType': 'spot'}
        }
        
        # Add passphrase for OKX and GATEIO
        if api_passphrase and ex_name in ("OKX", "GATEIO"):
            config['password'] = api_passphrase
        
        # Get CCXT class
        ex_class_name = ex_name.lower()
        if ex_name == "GATEIO":
            ex_class_name = "gateio"
        
        cls = getattr(ccxt, ex_class_name, None)
        if not cls:
            return {"ok": False, "reason": f"CCXT class not found for {ex_name}"}
        
        exchange = cls(config)
        
        # Normalize symbol (ensure it has /)
        if '/' not in symbol:
            symbol = f"{symbol}/USDT"
        
        # Get current price
        ticker = exchange.fetch_ticker(symbol)
        current_price = float(ticker.get('last') or ticker.get('close') or 0.0)
        
        if current_price <= 0:
            return {"ok": False, "reason": "Invalid market price"}
        
        # Calculate quantity
        if action == "BUY":
            # For BUY: amount = USDT / price (with 0.1% buffer for fees)
            qty = (usdt_amount / current_price) * 0.999
        else:  # SELL
            # For SELL: get balance and sell all
            base_currency = symbol.split('/')[0]
            balance = exchange.fetch_balance()
            qty = float(balance.get(base_currency, {}).get('free', 0.0))
            
            if qty <= 0:
                return {"ok": False, "reason": f"No {base_currency} balance to sell"}
        
        # Execute order
        side = 'buy' if action == "BUY" else 'sell'
        order = exchange.create_market_order(symbol, side, qty)
        
        # Parse order response
        filled = float(order.get('filled', qty))
        avg_price = float(order.get('average') or order.get('price') or current_price)
        
        # Calculate actual USDT spent/received
        actual_usdt = filled * avg_price
        
        # Parse fees
        fee_info = order.get('fee', {})
        fee_cost = float(fee_info.get('cost', 0.0))
        fee_currency = str(fee_info.get('currency', ''))
        
        # Convert fee to USDT if needed
        fee_usdt = 0.0
        fee_coin = 0.0
        if fee_currency == 'USDT':
            fee_usdt = fee_cost
        else:
            fee_coin = fee_cost
        
        return {
            "ok": True,
            "fill_price": avg_price,
            "fill_qty": filled,
            "real_usdt": actual_usdt,
            "fee_usdt": fee_usdt,
            "fee_coin": fee_coin,
            "fee_coin_ccy": fee_currency,
            "ord_id": str(order.get('id', ''))
        }
        
    except Exception as e:
        # Handle CCXT-specific errors
        error_msg = str(e)
        if 'InsufficientFunds' in error_msg or 'insufficient' in error_msg.lower():
            return {"ok": False, "reason": f"Insufficient funds: {error_msg}"}
        elif 'InvalidOrder' in error_msg or 'invalid' in error_msg.lower():
            return {"ok": False, "reason": f"Invalid order: {error_msg}"}
        elif 'Authentication' in error_msg or 'auth' in error_msg.lower():
            return {"ok": False, "reason": f"Authentication failed: {error_msg}"}
        elif 'Network' in error_msg or 'network' in error_msg.lower():
            return {"ok": False, "reason": f"Network error: {error_msg}"}
        else:
            return {"ok": False, "reason": f"Order failed: {error_msg}"}


def _get_start_admin_user_id():
    # Helper to find a fallback admin for logging if needed
    with sqlite3.connect(os.getenv("DB_PATH", "/root/backend/data.db")) as conn:
        c = conn.cursor()
        c.execute("SELECT username FROM users WHERE is_admin=1 LIMIT 1")
        r = c.fetchone()
        return r[0] if r else "admin"

def _real_buy(user_id: str, symbol: str, usdt_amount: float, plan: str = "") -> dict:
    """Execute REAL market buy order."""
    try:
        # Get user from DB
        with sqlite3.connect(os.getenv("DB_PATH", "/root/backend/data.db")) as conn:
            conn.row_factory = sqlite3.Row
            c = conn.cursor()
            c.execute("SELECT * FROM users WHERE username = ?", (user_id,))
            row = c.fetchone()
            if not row: return {"ok": False, "error": "User not found"}
            user = dict(row)
        
        # Safety checks
        if int(user.get("force_dry_run") or 0) == 1:
            return {"ok": False, "error": "Force Dry Run active"}

        exchange = _get_ccxt_exchange(user)
        
        # Calculate amount
        ticker = exchange.fetch_ticker(symbol)
        price = ticker['last']
        if price <= 0: return {"ok": False, "error": "Invalid price"}
        
        amount = (usdt_amount / price) * 0.999 # 0.1% buffer
        
        # Execute Order
        print(f"[REAL_TRADE] Buying {amount} {symbol} for {user_id} on {exchange.id}")
        order = exchange.create_order(symbol, 'market', 'buy', amount)
        
        # Log to DB
        try:
            with sqlite3.connect(os.getenv("DB_PATH", "/root/backend/data.db")) as conn:
                conn.execute(
                    "INSERT INTO real_trades (user_id, symbol, side, amount, price, order_id, status, created_at) VALUES (?, ?, ?, ?, ?, ?, 'OPEN', ?)",
                    (user_id, symbol, 'BUY', amount, price, str(order['id']), datetime.utcnow().isoformat())
                )
                conn.commit()
        except Exception as db_err:
            print(f"[DB_LOG_ERROR] {db_err}")

        print(f"[REAL_TRADE_SUCCESS] Order: {order['id']}")
        
        # Send Telegram notification for BUY
        try:
            send_telegram_message(f"ğŸŸ¢ BUY {symbol} {usdt_amount:.2f} USDT (User: {user_id})")
        except Exception as tg_err:
            print(f"[TELEGRAM_ERROR] {tg_err}")
        
        return {"ok": True, "price": price, "qty": amount, "order_id": order['id'], "real": True}
        
    except Exception as e:
        print(f"[REAL_BUY_ERROR] {e}")
        return {"ok": False, "error": str(e)}

def _real_sell(user_id: str, symbol: str) -> dict:
    """Execute REAL sell all for symbol."""
    try:
        with sqlite3.connect(os.getenv("DB_PATH", "/root/backend/data.db")) as conn:
            conn.row_factory = sqlite3.Row
            c = conn.cursor()
            c.execute("SELECT * FROM users WHERE username = ?", (user_id,))
            row = c.fetchone()
            if not row: return {"ok": False, "error": "User not found"}
            user = dict(row)

        exchange = _get_ccxt_exchange(user)
        
        # Get Balance
        base = symbol.split('/')[0]
        balance = exchange.fetch_balance()
        qty = float(balance.get('total', {}).get(base, 0))
        
        # Dust check
        if qty <= 0.00001: 
             return {"ok": False, "error": "No balance to sell"}

        # Execute Sell
        print(f"[REAL_TRADE] Selling {qty} {symbol} for {user_id} on {exchange.id}")
        order = exchange.create_order(symbol, 'market', 'sell', qty)

        # Update DB to CLOSED
        try:
            with sqlite3.connect(os.getenv("DB_PATH", "/root/backend/data.db")) as conn:
                conn.execute(
                    "UPDATE real_trades SET status='CLOSED', closed_at=? WHERE user_id=? AND symbol=? AND status='OPEN'",
                    (datetime.utcnow().isoformat(), user_id, symbol)
                )
                conn.commit()
        except: pass
        
        # Send Telegram notification for SELL
        try:
            send_telegram_message(f"ğŸ”´ SELL {symbol} Qty: {qty:.6f} (User: {user_id})")
        except Exception as tg_err:
            print(f"[TELEGRAM_ERROR] {tg_err}")
        
        return {"ok": True, "qty": qty, "order_id": order['id'], "real": True}

    except Exception as e:
        print(f"[REAL_SELL_ERROR] {e}")
        return {"ok": False, "error": str(e)}

# -------------------------
# END REAL TRADING LOGIC
# -------------------------

# AI execute: UI "Ä°ÅŸlem Yap" popup'Ä± bunu Ã§aÄŸÄ±rÄ±r
@app.post("/api/ai/execute")
def api_ai_execute():
    """Execute a trade (Demo or Real automatically detected)."""
    j = request.get_json(silent=True) or {}
    
    # Detect User & Mode
    if session.get("logged_in"):
        uid = session.get("username")
        # Check if user enabled real trading (trial_real_enabled=1 or just assume if keys exist?)
        # Let's check DB "trial_real_enabled"
        is_real_mode = False
        try:
            with sqlite3.connect(os.getenv("DB_PATH", "/root/backend/data.db")) as conn:
                c = conn.cursor()
                c.execute("SELECT trial_real_enabled, force_dry_run FROM users WHERE username=?", (uid,))
                row = c.fetchone()
                if row and row[0] == 1 and row[1] == 0:
                     is_real_mode = True
        except: pass
        
        # Force demo if requested explicitly (e.g. testing)
        if "demo" in safe_str(j.get("user_id") or "").lower():
            is_real_mode = False
            uid = safe_str(j.get("user_id") or _demo_get_user_id() or "demo").strip()
    else:
        uid = safe_str(j.get("user_id") or _demo_get_user_id() or "demo").strip() or "demo"
        is_real_mode = False

    symbol = safe_str(j.get("symbol") or "").strip().upper()
    side = safe_str(j.get("side") or "BUY").strip().upper()
    usdt_amount = j.get("usdt_amount", 0)
    plan = safe_str(j.get("plan") or "").strip()

    if not symbol:
        return jsonify({"ok": False, "error": "Symbol boÅŸ"}), 400
    if side not in ("BUY", "SELL"):
        return jsonify({"ok": False, "error": "Side geÃ§ersiz"}), 400

    # --- REAL MODE ---
    if is_real_mode:
        if side == "BUY":
            try: usdt_amount = float(usdt_amount)
            except: usdt_amount = 0
            if usdt_amount <= 0: return jsonify({"ok": False, "error": "Amount invalid"}), 400
            
            r = _real_buy(uid, symbol, usdt_amount, plan)
        else:
            r = _real_sell(uid, symbol)
            
        if not r.get("ok"):
             return jsonify(r), 400
        return jsonify({"ok": True, "result": r, "mode": "REAL"})

@app.post("/api/auto/start")
@require_login
def api_auto_start_route():
    username = session.get("username")
    if not username:
        return jsonify({"ok": False, "error": "KullanÄ±cÄ± bulunamadÄ±"}), 401
    user = get_user(username)
    if not user:
        return jsonify({"ok": False, "error": "KullanÄ±cÄ± bulunamadÄ±"}), 401
    with db() as conn:
        conn.execute("UPDATE users SET trial_real_enabled=1, trade_enabled=1 WHERE username=?", (user['username'],))
        conn.commit()
    return jsonify({"ok": True, "status": "started"})

@app.post("/api/auto/stop")
@require_login
def api_auto_stop_route():
    username = session.get("username")
    if not username:
        return jsonify({"ok": False, "error": "KullanÄ±cÄ± bulunamadÄ±"}), 401
    user = get_user(username)
    if not user:
        return jsonify({"ok": False, "error": "KullanÄ±cÄ± bulunamadÄ±"}), 401
    with db() as conn:
        conn.execute("UPDATE users SET trial_real_enabled=0 WHERE username=?", (user['username'],))
        conn.commit()
    return jsonify({"ok": True, "status": "stopped"})

    # --- DEMO MODE ---
    if side == "BUY":
        try:
            usdt_amount = float(usdt_amount)
        except Exception:
            usdt_amount = 0
        r = _demo_buy(uid, symbol, usdt_amount, plan=plan)
        if not r.get("ok"):
            return jsonify(r), 400
        return jsonify({"ok": True, "result": r, "mode": "DEMO"})

    # SELL 
    user = _demo_ensure_user(uid)
    open_positions = _demo_find_open_positions(user, symbol)
    if not open_positions:
        return jsonify({"ok": False, "error": "AÃ§Ä±k pozisyon yok"}), 400
    sold = []
    for pos in list(open_positions):
        try:
            price = _demo_fetch_price(symbol)
            qty = float(pos.get("qty") or 0)
            if price <= 0 or qty <= 0:
                continue
            proceeds = qty * price
            entry_amount = float(pos.get("amount_usdt") or 0)
            pnl = proceeds - entry_amount
            with DEMO_LOCK:
                user["balance_usdt"] = float(user.get("balance_usdt") or 0) + proceeds
                pos["status"] = "CLOSED"
                pos["closed_at"] = _demo_now_iso()
                pos["exit_price"] = price
                pos["pnl_usdt"] = pnl
            sold.append(pos)
        except Exception:
            continue
    if not sold:
        return jsonify({"ok": False, "error": "SatÄ±ÅŸ yapÄ±lamadÄ±"}), 400
    return jsonify({"ok": True, "sold": sold, "mode": "DEMO"})

# --- UI compatibility: Chat room helpers ---

@app.get("/api/chat/rooms")
def api_chat_rooms():
    # UI iÃ§in sabit odalar (lowercase id)
    rooms = [
        {"id": "genel", "title": "Genel"},
        {"id": "sinyaller", "title": "Sinyaller"},
        {"id": "analiz", "title": "Analiz"},
        {"id": "vip", "title": "VIP"},
    ]
    return jsonify({"ok": True, "rooms": rooms})

@app.post("/api/chat/join")
def api_chat_join():
    # UI join room icin auth istemesin
    j = request.get_json(silent=True) or {}
    room = safe_str(j.get("room") or j.get("roomId") or "GENERAL").strip() or "GENERAL"
    return jsonify({"ok": True, "room": room})
@app.get("/api/trades")
def api_trades():
    # GUEST_FALLBACK_TRADES
    try:
        if not (session.get("user_id") or session.get("username") or session.get("user") or session.get("email") or session.get("logged_in")):
            return jsonify({"ok": True, "guest": True, "mode": "DEMO", "trades": []})
    except Exception:
        return jsonify({"ok": True, "guest": True, "mode": "DEMO", "trades": []})

    # AUTH JSON (API endpoints redirect yerine JSON donsun)
    try:
        if not (session.get("user_id") or session.get("username") or session.get("user") or session.get("email") or session.get("logged_in")):
            return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    except Exception:
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401

    # UI trade history
    try:
        username = safe_str(session.get("username") or "").strip()
    except Exception:
        username = ""

    if not username:
        return jsonify({"ok": True, "trades": []})

    try:
        limit = int(request.args.get("limit") or 200)
    except Exception:
        limit = 200

    rows = list_trades(username, limit=limit) or []
    return jsonify({"ok": True, "trades": rows})


@app.get("/api/chat_poll")
def api_chat_poll():
    # Chat GET: UI polling (room + since_id)
    try:
        since_id = int(request.args.get("since_id") or request.args.get("since") or 0)
    except Exception:
        since_id = 0

    room_id = normalize_room(request.args.get("room") or request.args.get("room_id") or "general")

    conn = db()
    try:
        room_expr = "COALESCE(c.room, c.room_id, 'general')"

        if since_id <= 0:
            # ilk yÃ¼kleme: SON 200
            if room_id == "general":
                rows = conn.execute(f"""
                    SELECT c.id,
                           COALESCE(u.display_name, c.username) as username,
                           c.message,
                           c.created_at,
                           {room_expr} as room
                    FROM chat_messages c
                    LEFT JOIN users u ON c.username = u.username
                    ORDER BY c.id DESC
                    LIMIT 200
                """).fetchall()
            else:
                rows = conn.execute(f"""
                    SELECT c.id,
                           COALESCE(u.display_name, c.username) as username,
                           c.message,
                           c.created_at,
                           {room_expr} as room
                    FROM chat_messages c
                    LEFT JOIN users u ON c.username = u.username
                    WHERE lower({room_expr}) = lower(?)
                    ORDER BY c.id DESC
                    LIMIT 200
                """, (room_id,)).fetchall()

            msgs = [dict(r) for r in rows][::-1]
        else:
            # normal polling
            if room_id == "general":
                rows = conn.execute(f"""
                    SELECT c.id,
                           COALESCE(u.display_name, c.username) as username,
                           c.message,
                           c.created_at,
                           {room_expr} as room
                    FROM chat_messages c
                    LEFT JOIN users u ON c.username = u.username
                    WHERE c.id > ?
                    ORDER BY c.id ASC
                    LIMIT 200
                """, (since_id,)).fetchall()
            else:
                rows = conn.execute(f"""
                    SELECT c.id,
                           COALESCE(u.display_name, c.username) as username,
                           c.message,
                           c.created_at,
                           {room_expr} as room
                    FROM chat_messages c
                    LEFT JOIN users u ON c.username = u.username
                    WHERE c.id > ?
                      AND lower({room_expr}) = lower(?)
                    ORDER BY c.id ASC
                    LIMIT 200
                """, (since_id, room_id)).fetchall()

            msgs = [dict(r) for r in rows]

    except Exception as e:
        print(f"Chat Load Error: {e}")
        msgs = []
    finally:
        try:
            conn.close()
        except Exception:
            pass

    return jsonify({"ok": True, "messages": msgs})


@app.post("/api/chat_poll")
def api_chat_post():
    # display name
    fullname = safe_str(session.get("full_name") or "").strip()
    j = request.get_json(silent=True) or {}
    is_anonymous = bool(j.get("anonymous", False))

    if is_anonymous:
        display_name = "Anonim"
    elif fullname:
        display_name = fullname
    else:
        display_name = safe_str(session.get("username") or j.get("username") or "Misafir").strip() or "Misafir"

    msg = safe_str(j.get("message") or "").strip()
    room_id = normalize_room(j.get("room_id") or j.get("room") or "general")
    if not msg:
        return jsonify({"ok": False, "error": "Mesaj boÅŸ"}), 400
    if len(msg) > 500:
        msg = msg[:500]


    try:
        add_chat_message(room_id, display_name, msg, is_signal=False)
        return jsonify({"ok": True})
    except Exception as e:
        print(f"[CHAT POST] Error: {e}")
        return jsonify({"ok": False, "error": "Mesaj kaydedilemedi"}), 500


@app.get("/api/public/coins")
def api_public_coins():
    """Public coin list used by the React UI.

    Response shape:
      {"coins": [{"symbol":"BTC/USDT"}, ...], "source": "okx", "cached": true/false}

    Notes:
    - Always returns JSON
    - Uses in-memory cache to avoid frequent exchange calls
    """
    try:
        return jsonify(_public_coins_cached())
    except Exception:
        # absolute fallback (UI never empty)
        fallback = ["BTC/USDT", "ETH/USDT", "SOL/USDT", "XRP/USDT", "BNB/USDT", "DOGE/USDT", "ADA/USDT", "AVAX/USDT", "DOT/USDT", "MATIC/USDT", "LTC/USDT", "LINK/USDT", "UNI/USDT", "ATOM/USDT", "SHIB/USDT", "TRX/USDT", "ETC/USDT", "FIL/USDT", "ARB/USDT", "OP/USDT"]
        return jsonify({"coins": [{"symbol": s} for s in fallback], "source": "fallback", "cached": False})





# ----- Public coins cache (OKX spot USDT) -----
MOCK_CHAT_USERS_POOL = [
    "crypto_whale23", "btc_hodler99", "eth_master42", "moon_hunter77", "degen_trader", 
    "altcoin_sniper", "pump_detective", "whale_watcher", "diamond_hands", "paper_hands_lol", 
    "satoshi_fan", "gas_fee_hater", "rug_survivor", "lambo_dreamer", "chart_wizard",
    "fomo_king", "dip_buyer", "swing_trader", "scalp_master", "long_term_bull",
    "bear_hunter", "crypto_newbie", "defi_farmer", "nft_flipper", "yield_chaser"
]

def get_active_chat_users():
    import time
    import random
    # Rotate every 3 minutes (180 seconds)
    seed = int(time.time() / 180) 
    random.seed(seed)
    
    # Select 10-18 users
    count = random.randint(10, 18)
    active = random.sample(MOCK_CHAT_USERS_POOL, count)
    return active

@app.get("/api/chat/users")
def api_chat_users_list():
    # Return independent from login for public feel, or require login
    # users = get_active_chat_users()
    return jsonify({"ok": True, "users": get_active_chat_users()})

_PUBLIC_COINS_CACHE = {"ts": 0, "data": None}


def okx_public_usdt_instruments(timeout: int = 12) -> list:
    """OKX public instruments list for SPOT USDT pairs. Returns symbols like BTC/USDT."""
    try:
        url = "https://www.okx.com/api/v5/public/instruments"
        r = requests.get(url, params={"instType":"SPOT"}, timeout=timeout)
        j = r.json() if r is not None else {}
        data = (j.get("data") or []) if isinstance(j, dict) else []
        out=[]
        for it in data:
            inst = safe_str(it.get("instId") or "")
            if not inst or "-" not in inst:
                continue
            base_ccy, quote_ccy = inst.split("-",1)
            if quote_ccy.upper() != "USDT":
                continue
            out.append(f"{base_ccy.upper()}/USDT")
        return sorted(set(out))
    except Exception:
        return []

def _public_coins_cached(ttl_seconds: int = 600):
    now = int(time.time())
    ts = int(_PUBLIC_COINS_CACHE.get("ts") or 0)
    data = _PUBLIC_COINS_CACHE.get("data")

    if data and (now - ts) < int(ttl_seconds):
        return {**data, "cached": True}

    coins = []
    source = "okx"
    try:
        import ccxt
        ex = ccxt.okx({"enableRateLimit": True, "timeout": 15000})
        markets = ex.load_markets()
        for sym, m in (markets or {}).items():
            try:
                if not m.get("active", True):

                    continue
                if not m.get("spot"):
                    continue
                if m.get("quote") != "USDT":
                    continue
                if isinstance(sym, str) and "/" in sym:
                    coins.append(sym)
            except Exception:
                continue
        coins = sorted(set(coins))
    except Exception:
        source = "fallback"

    if not coins:
        coins = okx_public_usdt_instruments() or ["BTC/USDT", "ETH/USDT", "SOL/USDT", "XRP/USDT", "BNB/USDT", "DOGE/USDT", "ADA/USDT", "AVAX/USDT", "DOT/USDT", "MATIC/USDT", "LTC/USDT", "LINK/USDT", "UNI/USDT", "ATOM/USDT", "SHIB/USDT", "TRX/USDT", "ETC/USDT", "FIL/USDT", "ARB/USDT", "OP/USDT"]

    payload = {"coins": [{"symbol": s} for s in coins], "source": source, "cached": False}
    _PUBLIC_COINS_CACHE["ts"] = now
    _PUBLIC_COINS_CACHE["data"] = payload
    return payload


# ----- Public coins cache by exchange -----
_PUBLIC_COINS_CACHE_EX = {}

def _public_coins_cached_by_exchange(exchange_id: str, ttl_seconds: int = 600):
    """Return spot USDT symbols for given exchange.

    exchange_id: OKX|BINANCE|BYBIT|GATEIO
    """
    exid = safe_str(exchange_id or '').strip().upper() or 'OKX'
    now = int(time.time())
    cache = _PUBLIC_COINS_CACHE_EX.get(exid) or {"ts": 0, "data": None}
    ts = int(cache.get("ts") or 0)
    data = cache.get("data")
    if data and (now - ts) < int(ttl_seconds):
        return {**data, "cached": True}

    coins = []
    source = exid.lower()
    try:
        import ccxt
        cls = {
            'OKX': ccxt.okx,
            'BINANCE': ccxt.binance,
            'BYBIT': ccxt.bybit,
            'GATEIO': ccxt.gateio,
            'GATE': ccxt.gateio,
        }.get(exid)
        if cls is None:
            raise Exception('unsupported_exchange')
        ex = cls({"enableRateLimit": True, "timeout": 15000})
        markets = ex.load_markets()
        for sym, m in (markets or {}).items():
            try:
                if not m.get('active', True):
                    continue
                if not m.get('spot'):
                    continue
                if m.get('quote') != 'USDT':
                    continue
                if isinstance(sym, str) and '/' in sym:
                    coins.append(sym)
            except Exception:
                continue
        coins = sorted(set(coins))
    except Exception:
        source = 'fallback'

    if not coins:
        coins = ["BTC/USDT", "ETH/USDT", "SOL/USDT", "XRP/USDT", "BNB/USDT", "DOGE/USDT", "ADA/USDT", "AVAX/USDT", "DOT/USDT", "MATIC/USDT", "LTC/USDT", "LINK/USDT", "UNI/USDT", "ATOM/USDT", "SHIB/USDT", "TRX/USDT", "ETC/USDT", "FIL/USDT", "ARB/USDT", "OP/USDT"]

    payload = {"coins": [{"symbol": s} for s in coins], "source": source, "cached": False}
    _PUBLIC_COINS_CACHE_EX[exid] = {"ts": now, "data": payload}
    return payload


@app.get("/api/public/ohlc")
def api_public_ohlc():
    """Public OHLC endpoint for charts.

    Query:
      symbol=BTC/USDT
      tf=1m|5m|15m|30m|1h|4h|1d
      limit=1..300

    Response:
      {"symbol":"BTC/USDT", "tf":"5m", "candles": [[ts_ms, o,h,l,c,v], ...]}
    """
    symbol = (request.args.get("symbol") or "").strip()
    tf = (request.args.get("tf") or "1m").strip().lower()
    try:
        limit = int(request.args.get("limit") or 300)
    except Exception:
        limit = 300

    if not symbol:
        return jsonify({"error": "symbol missing"}), 400

    # normalize limit
    limit = max(1, min(300, limit))

    try:
        data = fetch_ohlc(symbol, tf, limit)
        # safety: always include candles
        candles = data.get("candles") if isinstance(data, dict) else None
        if not isinstance(candles, list):
            data = {"symbol": symbol, "tf": tf, "candles": []}
        return jsonify(data)
    except Exception as e:
        return jsonify({"symbol": symbol, "tf": tf, "candles": [], "error": "ohlc_fetch_failed"}), 500


# --- UI compatibility: some pages call /api/public/ohlc/<SYMBOL>/<TF> style ---

def _fetch_public_ohlc(symbol: str, tf: str, limit: int):
    symbol = (symbol or '').strip()
    tf = (tf or '1m').strip().lower()
    limit = int(limit or 300)
    if limit < 1:
        limit = 1
    if limit > 300:
        limit = 300

    # normalize symbol
    symbol = symbol.replace('-', '/').replace('_', '/')
    if 'USDT' in symbol and '/' not in symbol and symbol.endswith('USDT') and len(symbol) > 4:
        symbol = symbol[:-4] + '/USDT'

    candles = []
    source = 'okx'
    try:
        import ccxt
        ex = ccxt.okx({"enableRateLimit": True, "timeout": 15000})
        ohlc = ex.fetch_ohlcv(symbol, timeframe=tf, limit=limit)
        # ensure [ts_ms,o,h,l,c,v]
        for row in (ohlc or []):
            try:
                if isinstance(row, (list, tuple)) and len(row) >= 6:
                    candles.append([int(row[0]), float(row[1]), float(row[2]), float(row[3]), float(row[4]), float(row[5])])
            except Exception:
                continue
        candles = candles[-limit:]
    except Exception:
        source = 'fallback'

    return {"symbol": symbol, "tf": tf, "candles": candles, "source": source}


@app.get('/api/public/ohlc/<path:symbol>/<tf>')
def api_public_ohlc_path(symbol, tf):
    # Frontend bazen limit'i ?200 gibi anahtarsiz gonderiyor
    qs = (request.query_string or b'').decode('utf-8', 'ignore').strip()
    limit = None
    if qs.isdigit():
        try:
            limit = int(qs)
        except Exception:
            limit = None
    if limit is None:
        try:
            limit = int(request.args.get('limit') or 300)
        except Exception:
            limit = 300

    payload = _fetch_public_ohlc(symbol, tf, limit)
    return jsonify(payload)


@app.get('/api/public/ohlc/<path:symbol>/<tf>/<int:limit>')
def api_public_ohlc_path2(symbol, tf, limit):
    payload = _fetch_public_ohlc(symbol, tf, int(limit or 300))
    return jsonify(payload)

# --- Helper for Ticker and AI ---
import time
import random

_TICKER_CACHE = {"ts": 0, "data": {}}

def get_coingecko_ticker_cached():
    global _TICKER_CACHE
    now = time.time()
    if now - _TICKER_CACHE["ts"] < 1.0:  # 10 sn cache
        return _TICKER_CACHE["data"]

    # Mock prices for demo
    base_prices = {
        "BTC": 98450.00,
        "ETH": 3560.00,
        "SOL": 145.50,
        "BNB": 590.20,
        "XRP": 1.12,
        "ADA": 0.78,
        "DOGE": 0.12,
        "AVAX": 35.40,
        "DOT": 7.50,
        "MATIC": 0.85
    }
    
    prices = {}
    for sym, price in base_prices.items():
        change = price * (random.uniform(-0.005, 0.005)) 
        final_price = round(price + change, 4)
        # Add both formats: BTC and BTC/USDT
        prices[sym] = final_price
        prices[f"{sym}/USDT"] = final_price
        prices[f"{sym}USDT"] = final_price

    data = {
        "prices": prices,
        "usdt_try": 34.50,
        "ts": now
    }
    _TICKER_CACHE = {"ts": now, "data": data}
    return data

_LAST_BROADCAST_TS = 0

def _broadcast_high_confidence_signal(rec):
    global _LAST_BROADCAST_TS
    now = time.time()
    # Spam korumasi: En az 60 sn bekle
    if now - _LAST_BROADCAST_TS < 60:
        return

    # Sadece %85+ guven varsa
    if rec['confidence'] < 85:
        return
        
    symbol = rec['symbol']
    action = "YÃœKSELÄ°Å ğŸŸ¢" if rec['signal_type'] == "BUY" else "DÃœÅÃœÅ ğŸ”´"
    msg = f"ğŸ¤– **AI SÄ°NYAL**: {symbol} iÃ§in {rec['confidence']}% gÃ¼venle {action} beklentisi.\nHedef: +{rec['profit_target_percent']}%\n(Bu bir yatÄ±rÄ±m tavsiyesi deÄŸildir)"
    
    conn = db()
    try:
        # Check room_id col exists or add it (should exist by now)
        try:
             conn.execute("SELECT room_id FROM chat_messages LIMIT 1")
        except:
             try:
                 conn.execute("ALTER TABLE chat_messages ADD COLUMN room_id TEXT DEFAULT 'general'")
             except: pass

        # Embed into 'AI_Signals' room or 'general' if preferred. User asked for "CanlÄ± sohbette Bi bÃ¶lÃ¼m".
        # Let's put it in 'general' but with a special username 'AutoTrade AI'
        conn.execute(
            "INSERT INTO chat_messages(room, user_id, username, message, is_signal, created_at) VALUES (?,?,?,?,?,?)",
            ("general", 0, "AutoTrade AI ğŸ¤–", safe_str(msg), 1, now_ts()),
        )
        conn.commit()

        # Also post to VIP room
        conn.execute(
            "INSERT INTO chat_messages(room, user_id, username, message, is_signal, created_at) VALUES (?,?,?,?,?,?)",
            ("vip", 0, "AutoTrade AI ğŸ¤–", safe_str(msg), 1, now_ts()),
        )
        conn.commit()
        _LAST_BROADCAST_TS = now
    except Exception as e:
        print(f"Broadcast Error: {e}")
    finally:
        conn.close()

@app.get("/api/public/ticker")
def api_public_ticker():
    """Public ticker snapshot for UI price updates."""
    symbols_raw = (request.args.get("symbols") or "").strip()
    symbols = [s.strip().upper() for s in symbols_raw.split(",") if s.strip()]

    cached = get_coingecko_ticker_cached()
    prices = cached.get("prices") or {}
    usdt_try = float(cached.get("usdt_try") or 0.0)

    if symbols:
        filtered = {s: prices.get(s) for s in symbols if prices.get(s)}
    else:
        filtered = prices

    return jsonify({
        "ok": True,
        "usdt_try": usdt_try,
        "prices": filtered,
        "ts": cached.get("ts"),
    })

def _get_ai_signals_internal(symbols=None, min_confidence=50, exchange_filter="all"):
    """Internal function to generate AI signals - NOT a route"""
    cached = get_coingecko_ticker_cached()
    prices = cached.get("prices") or {}
    usdt_try = float(cached.get("usdt_try") or 0.0)

    if not symbols:
        symbols = list(prices.keys())[:15]

    exchange_map = {
        "BTC": "Binance", "ETH": "Binance", "BNB": "Binance",
        "SOL": "OKX", "XRP": "OKX", "ADA": "OKX",
        "AVAX": "Bybit", "DOT": "Bybit", "MATIC": "Bybit",
        "LINK": "Binance", "UNI": "OKX", "ATOM": "Bybit"
    }

    recs = []
    for sym in symbols:
        px = float(prices.get(sym) or 0.0)
        if px <= 0: continue
        
        sym_exchange = exchange_map.get(sym.split('/')[0].upper(), "Binance")
        if exchange_filter != "all" and sym_exchange != exchange_filter:
            continue
        
        base_hash = sum(ord(c) for c in sym)
        confidence = 50 + (base_hash % 49)
        signal = "BUY" if base_hash % 2 == 0 else "SELL"
        profit_target = 2.0 + ((base_hash % 5) * 0.5)
        stop_loss = 1.5 + ((base_hash % 4) * 0.5)
        
        if confidence < min_confidence:
            continue

        recs.append({
            "symbol": sym,
            "signal_type": signal,
            "entry_price": px,
            "confidence": confidence,
            "profit_target_percent": profit_target,
            "stop_loss_percent": stop_loss,
            "analysis_summary": "Piyasa momentumu ve likidite skorlarÄ± baz alÄ±narak oluÅŸturuldu.",
            "risk_level": "DÃ¼ÅŸÃ¼k" if confidence >= 80 else "Orta",
            "usdt_try": usdt_try,
            "exchange": sym_exchange,
        })

    recs.sort(key=lambda x: x['confidence'], reverse=True)
    
    # Broadcast top signal if high confidence
    if recs:
        _broadcast_high_confidence_signal(recs[0])
        
    return recs

@app.get("/api/public/ai-recommendations")
def api_public_ai_recommendations():
    """Rule-based mock AI recommendations (no external AI dependency)."""
    symbols_raw = (request.args.get("symbols") or "").strip()
    symbols = [s.strip().upper() for s in symbols_raw.split(",") if s.strip()]
    
    try: min_confidence = int(request.args.get("min_confidence") or 50)
    except: min_confidence = 50
    
    exchange_filter = (request.args.get("exchange") or "all").strip()

    recs = _get_ai_signals_internal(symbols if symbols else None, min_confidence, exchange_filter)
    return jsonify({"ok": True, "recommendations": recs})

@app.get("/api/ai/advice")
def api_ai_advice():
    """Check against AI signals before trade execution."""
    symbol = safe_str(request.args.get("symbol")).strip().upper()
    side = safe_str(request.args.get("side")).strip().upper()
    
    if not symbol: return jsonify({"approval": "APPROVE", "message": ""})

    # Get signal for this symbol
    recs = _get_ai_signals_internal([symbol])
    rec = recs[0] if recs else None
    
    approval = "APPROVE"
    message = "Ä°ÅŸlem gÃ¼venli gÃ¶rÃ¼nÃ¼yor."
    
    if rec:
        signal = rec['signal_type'] # BUY or SELL
        conf = rec['confidence']
        
        # Logic: Warn if trading AGAINST the signal with high confidence
        if side == 'SELL' and signal == 'BUY' and conf >= 60:
            approval = "WARN"
            message = f"{symbol} paritesinde gÃ¼Ã§lÃ¼ YÃœKSELÄ°Å sinyali (GÃ¼ven: %{conf}) mevcut. Åu an satÄ±ÅŸ yapmanÄ±z kÃ¢r kaÃ§Ä±rmanÄ±za neden olabilir."
            
        elif side == 'BUY' and signal == 'SELL' and conf >= 60:
            approval = "WARN"
            message = f"{symbol} paritesinde DÃœÅÃœÅ sinyali (GÃ¼ven: %{conf}) mevcut. Åu an alÄ±m yapmanÄ±z riskli olabilir."
            
    return jsonify({"approval": approval, "message": message})

# =========================
# DEMO (Paper Trading) Engine - Supabase yok
# =========================
import threading
import time
from datetime import datetime

DEMO_LOCK = threading.Lock()
DEMO_STARTED = False

# user_id -> {"balance_usdt": float, "positions": [..], "auto_configs":[..]}
DEMO_STATE = {}

def _demo_get_user_id():
    # login yoksa bile demo Ã§alÄ±ÅŸsÄ±n diye fallback
    try:
        if "user_id" in request.args:
            return str(request.args.get("user_id") or "demo")
        j = request.get_json(silent=True) or {}
        if "user_id" in j:
            return str(j.get("user_id") or "demo")
    except Exception:
        pass
    return "demo"

def _demo_ensure_user(uid: str):
    with DEMO_LOCK:
        if uid not in DEMO_STATE:
            DEMO_STATE[uid] = {
                "balance_usdt": 1000.0,
                "positions": [],
                "auto_configs": []
            }
        return DEMO_STATE[uid]

def _demo_fetch_price(symbol: str) -> float:
    # CCXT OKX public ticker
    import ccxt
    ex = ccxt.okx({"enableRateLimit": True, "timeout": 15000})
    t = ex.fetch_ticker(symbol)
    p = t.get("last") or t.get("close") or 0
    try:
        return float(p)
    except Exception:
        return 0.0

def _demo_now_iso():
    try:
        return datetime.utcnow().isoformat() + "Z"
    except Exception:
        return ""

def _plan_limits(plan: str):
    """Return (trade_limit, coin_limit) based on subscription plan.

    Accepted plan values (case-insensitive):
    - "temel", "basic", "starter"  -> 300 trades, 2 coins
    - "premium", "pro"             -> 600 trades, 3 coins
    - "elit", "elite", "enterprise"-> unlimited trades, 5 coins
    """
    p = safe_str(plan or "").strip().lower()
    if p in ("temel", "basic", "starter", "starter paket", "temel paket"):
        return (300, 2)
    if p in ("premium", "pro", "premium paket"):
        return (600, 3)
    # default: elit
    return (None, 5)

def _demo_buy(uid: str, symbol: str, amount_usdt: float, plan: str = ""):
    amount_usdt = float(amount_usdt or 0)
    if amount_usdt <= 0:
        return {"ok": False, "error": "GeÃ§ersiz miktar"}

    user = _demo_ensure_user(uid)
    trade_limit, coin_limit = _plan_limits(plan)
    price = _demo_fetch_price(symbol)
    if price <= 0:
        return {"ok": False, "error": "Fiyat alÄ±namadÄ±"}

    qty = amount_usdt / price
    if qty <= 0:
        return {"ok": False, "error": "Miktar Ã§ok kÃ¼Ã§Ã¼k"}

    with DEMO_LOCK:
        # Paket limitleri
        try:
            trade_count = int(user.get("trade_count") or 0)
        except Exception:
            trade_count = 0

        if trade_limit is not None and trade_count >= int(trade_limit):
            return {"ok": False, "error": "Paket iÅŸlem limiti doldu"}

        # Coin limiti: aÃ§Ä±k pozisyonlarda kaÃ§ farklÄ± symbol var
        open_syms = set()
        for p in list(user.get("positions") or []):
            if p.get("status") == "OPEN" and p.get("symbol"):
                open_syms.add(str(p.get("symbol")))
        if symbol not in open_syms and len(open_syms) >= int(coin_limit):
            return {"ok": False, "error": "Paket coin limiti doldu"}
        bal = float(user.get("balance_usdt") or 0)
        if amount_usdt > bal:
            return {"ok": False, "error": "Bakiye yetersiz"}

        old_balance = bal
        new_balance = bal - amount_usdt
        user["balance_usdt"] = new_balance
        user["trade_count"] = trade_count + 1

        pos = {
            "id": f"demo_{int(time.time()*1000)}",
            "symbol": symbol,
            "side": "BUY",
            "amount_usdt": amount_usdt,
            "qty": qty,
            "entry_price": price,
            "target_price": price * 1.005,  # %0.50 hedef
            "status": "OPEN",
            "opened_at": _demo_now_iso(),
            "closed_at": None,
            "exit_price": None,
            "pnl_usdt": None
        }
        user["positions"].insert(0, pos)

    # âœ… CRITICAL: Write BUY transaction to history
    try:
        conn = db()
        username = uid
        
        # Log BUY transaction
        conn.execute("""
            INSERT INTO transaction_history (
                username, type, symbol, amount, price, total,
                profit, timestamp, is_simulated, mode
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            username,
            "BUY",
            symbol,
            qty,
            price,
            amount_usdt,
            0.0,  # No profit yet on BUY
            int(time.time()),
            1,  # is_simulated = 1 for demo
            "demo"
        ))
        
        # Update user demo balance in database
        conn.execute("""
            UPDATE users 
            SET demo_balance = ?
            WHERE username = ?
        """, (new_balance, username))
        
        conn.commit()
        conn.close()
        
        print(f"[DEMO_BUY] âœ… {username}: {symbol} BOUGHT @ {price:.2f} | Amount: {amount_usdt} USDT | Balance: {old_balance:.2f} â†’ {new_balance:.2f}")
    except Exception as e:
        print(f"[DEMO_BUY] âŒ Transaction log error: {e}")

    return {"ok": True, "position": pos}

def _demo_try_sell(uid: str, pos: dict):
    """Auto-sell demo position when target price reached"""
    symbol = pos.get("symbol")
    price = _demo_fetch_price(symbol)
    if price <= 0:
        return False

    target = float(pos.get("target_price") or 0)
    if target > 0 and price < target:
        return False

    qty = float(pos.get("qty") or 0)
    if qty <= 0:
        return False

    proceeds = qty * price
    entry_amount = float(pos.get("amount_usdt") or 0)
    pnl = proceeds - entry_amount

    with DEMO_LOCK:
        user = _demo_ensure_user(uid)
        old_balance = float(user.get("balance_usdt") or 0)
        new_balance = old_balance + proceeds
        user["balance_usdt"] = new_balance

        pos["status"] = "CLOSED"
        pos["closed_at"] = _demo_now_iso()
        pos["exit_price"] = price
        pos["pnl_usdt"] = pnl

    # âœ… CRITICAL: Write to transaction_history database
    try:
        conn = db()
        username = uid  # uid is username for demo
        
        # Log SELL transaction
        conn.execute("""
            INSERT INTO transaction_history (
                username, type, symbol, amount, price, total,
                profit, timestamp, is_simulated, mode
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            username,
            "SELL",
            symbol,
            qty,
            price,
            proceeds,
            pnl,
            int(time.time()),
            1,  # is_simulated = 1 for demo
            "demo"
        ))
        
        # Update user stats: increment total trades, update balance
        conn.execute("""
            UPDATE users 
            SET total_trades = COALESCE(total_trades, 0) + 1,
                demo_balance = ?
            WHERE username = ?
        """, (new_balance, username))
        
        conn.commit()
        conn.close()
        
        print(f"[DEMO_SELL] âœ… {username}: {symbol} SOLD @ {price:.2f} | PNL: {pnl:.2f} USDT | Balance: {old_balance:.2f} â†’ {new_balance:.2f}")
    except Exception as e:
        print(f"[DEMO_SELL] âŒ Transaction log error: {e}")

    return True

def _demo_worker_loop():
    while True:
        try:
            time.sleep(3)
            with DEMO_LOCK:
                snapshot = [(uid, list(DEMO_STATE.get(uid, {}).get("positions", []))) for uid in DEMO_STATE.keys()]
            for uid, positions in snapshot:
                for pos in positions:
                    if pos.get("status") != "OPEN":
                        continue
                    _demo_try_sell(uid, pos)
        except Exception:
            time.sleep(2)

def _real_worker_loop():
    # REAL_LOCK_ACQUIRED: prevent duplicate real bot loops across gunicorn workers
    try:
        import os, fcntl
        _lfd = os.open("/tmp/atalay_realbot.lock", os.O_CREAT | os.O_RDWR, 0o644)
        try:
            fcntl.flock(_lfd, fcntl.LOCK_EX | fcntl.LOCK_NB)
            os.ftruncate(_lfd, 0)
            os.write(_lfd, str(os.getpid()).encode("utf-8"))
            print("[REAL_BOT] REAL_LOCK_ACQUIRED âœ…")
        except BlockingIOError:
            print("[REAL_BOT] REAL_LOCK_HELD â›” skip duplicate loop")
            return
    except Exception as _e:
        print(f"[REAL_BOT] REAL_LOCK_ERROR: {_e}")

    """Background loop for REAL trading: Auto-Buy (AI) & Auto-Sell (Target)."""
    print("[REAL_BOT] Global AI Bot Loop Started")
    while True:
        try:
            time.sleep(15)
            # --- 1. Auto-Sell Logic (Take Profit 0.5%) ---
            with sqlite3.connect(os.getenv("DB_PATH", "/root/backend/data.db")) as conn:
                conn.row_factory = sqlite3.Row
                c = conn.cursor()
                
                # Fetch Real Users
                c.execute("SELECT * FROM users WHERE trial_real_enabled=1 AND force_dry_run=0")
                users = [dict(r) for r in c.fetchall()]
                
                # Fetch Open Trades
                c.execute("SELECT * FROM real_trades WHERE status='OPEN'")
                open_trades = [dict(r) for r in c.fetchall()]

            if not users: 
                time.sleep(5)
                continue

            # Check Profits
            for trade in open_trades:
                # Find user
                user = next((u for u in users if u['username'] == trade['user_id']), None)
                if not user: continue
                
                symbol = trade['symbol']
                entry_price = float(trade['price'] or 0)
                if entry_price <= 0: continue
                
                # Get Current Price
                # Try cache first (fast)
                cached = get_coingecko_ticker_cached().get("prices", {})
                curr_price = float(cached.get(symbol) or 0)
                
                # If cache miss or old, fetch fresh (slower but accurate)
                if curr_price <= 0:
                   # Simplification: use Demo fetcher which calls CCXT OKX public
                   curr_price = _demo_fetch_price(symbol)
                
                if curr_price <= 0: continue
                
                # Calc PnL
                pnl_pct = ((curr_price - entry_price) / entry_price) * 100
                
                # Target: 0.50%
                if pnl_pct >= 0.50:
                    print(f"[REAL_BOT] Take Profit triggered for {user['username']} on {symbol} (PnL: {pnl_pct:.2f}%)")
                    _real_sell(user['username'], symbol)
            
            # --- 2. Auto-Buy Logic (AI Signals / Mock TV) ---
            signals = _get_ai_signals_internal(min_confidence=92) 
            buys = [s for s in signals if s['signal_type'] == 'BUY']
            
            if not buys: continue
            
            for u in users:
                for signal in buys[:1]: # Top 1
                     uid = u['username']
                     sym = signal['symbol']
                     
                     # Check if we already have open trade for this symbol
                     has_open = any(t['user_id'] == uid and t['symbol'] == sym for t in open_trades)
                     if has_open: continue 
                     
                     print(f"[REAL_BOT] Auto-Buying {sym} for {uid}")
                     _real_buy(uid, sym, 20.0)
                     
        except Exception as e:
             print(f"[REAL_BOT_ERROR] {e}")
             time.sleep(5)

DEMO_STARTED = False

@app.before_request
def _demo_start_once():
    global DEMO_STARTED
    if DEMO_STARTED:
        return
    DEMO_STARTED = True
    t = threading.Thread(target=_demo_worker_loop, daemon=True)
    t.start()
    
    # Start Real Bot too
    t2 = threading.Thread(target=_real_worker_loop, daemon=True)
    t2.start()

# =========================
# EXCHANGE SETTINGS API (Multi-Exchange)
# =========================
@app.get("/api/exchange/list")
def api_exchange_list():
    """Get list of supported exchanges with user's connection status"""
    exchanges = [
        {"id": "okx", "name": "OKX", "needs_passphrase": True},
        {"id": "binance", "name": "Binance", "needs_passphrase": False},
        {"id": "gateio", "name": "Gate.io", "needs_passphrase": False},
        {"id": "bybit", "name": "Bybit", "needs_passphrase": False},
        {"id": "btcturk", "name": "BTCTurk", "needs_passphrase": False}
    ]
    
    show_full = request.args.get('show_full') == '1'
    
    # Build configs object for sidebar (connected status per exchange)
    configs = {}
    for ex in exchanges:
        configs[ex["id"]] = {"connected": False, "mode": "test"}
    
    # If user is logged in, get their exchange_api_keys
    if session.get("logged_in"):
        user_id = session.get("user_id") or session.get("username") or session.get("email") or "global"
        
        try:
            conn = db()
            # Check exchange_api_keys table for this user (try both string and int)
            rows = conn.execute("""
                SELECT exchange, api_key, api_secret, mode FROM exchange_api_keys 
                WHERE user_id=? OR user_id=?
            """, (str(user_id), user_id)).fetchall()
            conn.close()
            
            for row in rows:
                ex_name = (row[0] or "").lower()
                api_key_enc = row[1] or ""
                api_secret_enc = row[2] or ""
                mode = (row[3] or "test").lower()
                
                
                # Decrypt API key
                try:
                    api_key = decrypt_data(api_key_enc) if api_key_enc else ""
                    api_secret = decrypt_data(api_secret_enc) if api_secret_enc else ""
                except Exception as dec_err:
                    api_key = api_key_enc
                    api_secret = api_secret_enc
                
                # If api_key exists, mark as connected and add masked key
                if api_key and ex_name in configs:
                    configs[ex_name]["connected"] = True
                    configs[ex_name]["mode"] = mode
                    configs[ex_name]["api_key_masked"] = (api_key[:4] + '...' + api_key[-4:]) if len(api_key) > 8 else '****'
                    
                    # Return full key if requested (for eye icon)
                    if show_full:
                        configs[ex_name]["api_key_full"] = api_key
        except Exception as e:
            print(f"api_exchange_list error: {e}", file=sys.stderr)
    
    return jsonify({
        "ok": True,
        "success": True,  # For sidebar JS compatibility
        "exchanges": exchanges,
        "configs": configs
    })

@app.get("/api/exchange/settings")
def api_exchange_settings():
    """Get user's connected exchanges"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    try:
        ensure_exchange_tables()
        conn = db()
        rows = conn.execute(
            "SELECT exchange_type, api_key, is_active FROM user_exchanges WHERE user_id=?",
            (user_id,)
        ).fetchall()
        conn.close()
        
        exchanges = []
        for r in rows:
            api_key = r[1] or ""
            exchanges.append({
                "exchange": r[0],
                "has_api_key": bool(api_key),
                "api_key_masked": api_key[:6] + "****" + api_key[-4:] if len(api_key) > 10 else "",
                "is_active": bool(r[2])
            })
        
        return jsonify({"ok": True, "exchanges": exchanges})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

@app.post("/api/exchange/connect")
def api_exchange_connect():
    """Connect a new exchange"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    exchange = j.get("exchange", "").lower().strip()
    api_key = j.get("api_key", "").strip()
    api_secret = j.get("api_secret", "").strip()
    passphrase = j.get("passphrase", "").strip()
    
    if exchange not in SUPPORTED_EXCHANGES:
        return jsonify({"ok": False, "error": f"Desteklenmeyen borsa: {exchange}"}), 400
    
    if not api_key or not api_secret:
        return jsonify({"ok": False, "error": "API Key ve Secret zorunlu"}), 400
    
    if exchange == "okx" and not passphrase:
        return jsonify({"ok": False, "error": "OKX iÃ§in passphrase zorunlu"}), 400
    
    try:
        ensure_exchange_tables()
        
        conn = db()
        conn.execute("""
            INSERT OR REPLACE INTO user_exchanges (user_id, exchange_type, api_key, api_secret, api_passphrase, is_active, created_at)
            VALUES (?, ?, ?, ?, ?, 1, ?)
        """, (user_id, exchange, api_key, api_secret, passphrase, int(time.time())))
        conn.commit()
        conn.close()
        
        # Clear cached client
        if user_id in _EXCHANGE_CLIENTS and exchange in _EXCHANGE_CLIENTS[user_id]:
            del _EXCHANGE_CLIENTS[user_id][exchange]
        
        # Test connection
        client = get_exchange_client(user_id, exchange)
        balance = client.get_usdt_balance()
        
        return jsonify({
            "ok": True,
            "message": f"{exchange.upper()} baÄŸlandÄ±! USDT Bakiye: ${balance:.2f}",
            "balance": balance
        })
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

@app.post("/api/exchange/disconnect")
def api_exchange_disconnect():
    """Disconnect an exchange"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    exchange = j.get("exchange", "").lower().strip()
    
    try:
        conn = db()
        conn.execute("DELETE FROM user_exchanges WHERE user_id=? AND exchange_type=?", (user_id, exchange))
        conn.commit()
        conn.close()
        
        # Clear cached client
        if user_id in _EXCHANGE_CLIENTS and exchange in _EXCHANGE_CLIENTS[user_id]:
            del _EXCHANGE_CLIENTS[user_id][exchange]
        
        return jsonify({"ok": True, "message": f"{exchange.upper()} baÄŸlantÄ±sÄ± kaldÄ±rÄ±ldÄ±"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

@app.get("/api/exchange/balance")
def api_exchange_balance():
    """Get balance from a specific exchange"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    exchange = request.args.get("exchange", "okx").lower().strip()
    
    client = get_exchange_client(user_id, exchange)
    if not client.api_key:
        return jsonify({"ok": False, "error": f"{exchange.upper()} baÄŸlÄ± deÄŸil", "balance": 0})
    
    balance = client.get_usdt_balance()
    return jsonify({"ok": True, "exchange": exchange, "balance": balance})

@app.get("/api/exchange/balances")
def api_exchange_balances():
    """Get balances from all connected exchanges"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    try:
        ensure_exchange_tables()
        conn = db()
        rows = conn.execute(
            "SELECT exchange_type FROM user_exchanges WHERE user_id=? AND is_active=1",
            (user_id,)
        ).fetchall()
        conn.close()
        
        balances = []
        total = 0.0
        for r in rows:
            exchange = r[0]
            client = get_exchange_client(user_id, exchange)
            if client.api_key:
                balance = client.get_usdt_balance()
                total += balance
                balances.append({"exchange": exchange, "balance": balance})
        
        return jsonify({"ok": True, "balances": balances, "total": total})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

# Legacy OKX endpoints for backward compatibility
@app.get("/api/okx/settings")
def api_okx_settings():
    """Get user's OKX API settings (masked) - Legacy endpoint"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    try:
        ensure_exchange_tables()
        conn = db()
        row = conn.execute(
            "SELECT api_key, api_passphrase FROM user_exchanges WHERE user_id=? AND exchange_type='okx'",
            (user_id,)
        ).fetchone()
        conn.close()
        
        if row:
            api_key = row[0] or ""
            passphrase = row[1] or ""
            return jsonify({
                "ok": True,
                "has_api_key": bool(api_key),
                "api_key_masked": api_key[:6] + "****" + api_key[-4:] if len(api_key) > 10 else "",
                "has_passphrase": bool(passphrase)
            })
        return jsonify({"ok": True, "has_api_key": False})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

@app.post("/api/okx/settings")
def api_okx_settings_save():
    """Save user's OKX API settings - Legacy endpoint"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    api_key = j.get("api_key", "").strip()
    api_secret = j.get("api_secret", "").strip()
    passphrase = j.get("passphrase", "").strip()
    
    if not api_key or not api_secret or not passphrase:
        return jsonify({"ok": False, "error": "TÃ¼m alanlarÄ± doldurun"}), 400
    
    try:
        ensure_exchange_tables()
        
        conn = db()
        conn.execute("""
            INSERT OR REPLACE INTO user_exchanges (user_id, exchange_type, api_key, api_secret, api_passphrase, is_active, created_at)
            VALUES (?, 'okx', ?, ?, ?, 1, ?)
        """, (user_id, api_key, api_secret, passphrase, int(time.time())))
        conn.commit()
        conn.close()
        
        # Clear cached client
        if user_id in _EXCHANGE_CLIENTS and "okx" in _EXCHANGE_CLIENTS[user_id]:
            del _EXCHANGE_CLIENTS[user_id]["okx"]
        
        # Test connection
        client = get_exchange_client(user_id, "okx")
        balance = client.get_usdt_balance()
        
        return jsonify({
            "ok": True,
            "message": f"OKX baÄŸlandÄ±! USDT Bakiye: ${balance:.2f}",
            "balance": balance
        })
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

@app.get("/api/okx/balance")
def api_okx_balance():
    """Get real OKX balance - Legacy endpoint"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    client = get_exchange_client(user_id, "okx")
    if not client.api_key:
        return jsonify({"ok": False, "error": "OKX baÄŸlÄ± deÄŸil", "balance": 0})
    
    balance = client.get_usdt_balance()
    return jsonify({"ok": True, "balance": balance})


@app.post("/api/mode/switch")
def api_mode_switch():
    """Switch between DEMO and REAL mode - iÅŸlemler mod'a gÃ¶re ayrÄ± tutulur"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    username = session.get("username")
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    new_mode = j.get("mode", "demo").lower()
    exchange = j.get("exchange", "okx").lower().strip()
    
    if new_mode not in ["demo", "real"]:
        return jsonify({"ok": False, "error": "Invalid mode"}), 400
    
    try:
        # Update session mode
        session["trading_mode"] = new_mode
        session["ui_mode"] = new_mode
        session["active_exchange"] = exchange
        
        if new_mode == "real":
            # Check if exchange is connected
            client = get_exchange_client(user_id, exchange)
            if not client.api_key:
                return jsonify({
                    "ok": False,
                    "error": f"{exchange.upper()} API baÄŸlÄ± deÄŸil. Ã–nce ayarlardan {exchange.upper()} hesabÄ±nÄ±zÄ± baÄŸlayÄ±n."
                }), 400
            
            # Get real balance from exchange
            balance = client.get_usdt_balance()
            
            # Get real positions count
            with db() as conn:
                real_pos_count = conn.execute(
                    "SELECT COUNT(*) FROM real_positions WHERE user_id=? AND status='open'", 
                    (user_id,)
                ).fetchone()[0]
                auto_pos_count = conn.execute(
                    "SELECT COUNT(*) FROM auto_positions WHERE username=? AND mode='real' AND status IN ('waiting', 'open')", 
                    (username,)
                ).fetchone()[0]
            
            return jsonify({
                "ok": True,
                "mode": "real",
                "exchange": exchange,
                "message": f"REAL moda geÃ§ildi! {exchange.upper()} Bakiye: ${balance:.2f}",
                "balance": balance,
                "open_positions": real_pos_count,
                "auto_positions": auto_pos_count
            })
        else:
            # Switch to demo mode
            with db() as conn:
                # Get demo balance
                demo_balance = conn.execute(
                    "SELECT demo_balance FROM users WHERE username=?", 
                    (username,)
                ).fetchone()[0] or 10000
                
                # Get demo positions count
                demo_pos_count = conn.execute(
                    "SELECT COUNT(*) FROM demo_positions WHERE user_id=? AND status='open'", 
                    (user_id,)
                ).fetchone()[0]
                auto_pos_count = conn.execute(
                    "SELECT COUNT(*) FROM auto_positions WHERE username=? AND mode='demo' AND status IN ('waiting', 'open')", 
                    (username,)
                ).fetchone()[0]
            
            return jsonify({
                "ok": True,
                "mode": "demo",
                "message": "DEMO moda geÃ§ildi",
                "balance": demo_balance,
                "open_positions": demo_pos_count,
                "auto_positions": auto_pos_count
            })
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500


@app.get("/api/real/positions")
def api_real_positions():
    """Get real positions from database"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    try:
        conn = db()
        rows = conn.execute("""
            SELECT id, coin, side, amount_usdt, entry_price, current_price, pnl, status, created_at
            FROM real_positions WHERE user_id=? AND status='open'
            ORDER BY created_at DESC
        """, (user_id,)).fetchall()
        conn.close()
        
        positions = []
        for r in rows:
            positions.append({
                "id": r[0],
                "coin": r[1],
                "side": r[2],
                "amount_usdt": r[3],
                "entry_price": r[4],
                "current_price": r[5],
                "pnl": r[6],
                "status": r[7],
                "created_at": r[8]
            })
        
        return jsonify({"ok": True, "positions": positions})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e), "positions": []}), 500

# @app.get("/api/real/balance-legacy")
def api_demo_balance_legacy():
    uid = safe_str(request.args.get("user_id") or _demo_get_user_id() or "demo").strip() or "demo"
    user = _demo_ensure_user(uid)
    with DEMO_LOCK:
        return jsonify({"user_id": uid, "balance_usdt": float(user.get("balance_usdt") or 0)})


# @app.post("/api/demo/reset")
def api_demo_reset():
    j = request.get_json(silent=True) or {}
    uid = safe_str(j.get("user_id") or _demo_get_user_id() or "demo").strip() or "demo"
    new_bal = j.get("balance_usdt", 1000.0)
    try:
        new_bal = float(new_bal)
    except Exception:
        new_bal = 1000.0

    user = _demo_ensure_user(uid)
    with DEMO_LOCK:
        user["balance_usdt"] = max(0.0, new_bal)
        user["positions"] = []
        user["auto_configs"] = []
    return jsonify({"ok": True, "user_id": uid, "balance_usdt": float(user.get("balance_usdt") or 0)})

# @app.get("/api/demo/positions")
def api_demo_positions():
    uid = safe_str(request.args.get("user_id") or _demo_get_user_id() or "demo").strip() or "demo"
    user = _demo_ensure_user(uid)
    with DEMO_LOCK:
        return jsonify({"user_id": uid, "positions": user.get("positions", [])})

# @app.post("/api/demo/auto")
def api_demo_auto_add():
    j = request.get_json(silent=True) or {}
    uid = safe_str(j.get("user_id") or _demo_get_user_id() or "demo").strip() or "demo"
    symbol = str(j.get("symbol") or "").strip()
    amount_usdt = j.get("amount_usdt", 0)
    plan = safe_str(j.get("plan") or "").strip()

    if not symbol:
        return jsonify({"ok": False, "error": "Symbol boÅŸ"}), 400

    try:
        amount_usdt = float(amount_usdt)
    except Exception:
        amount_usdt = 0

    r = _demo_buy(uid, symbol, amount_usdt, plan=plan)
    if not r.get("ok"):
        return jsonify(r), 400

    return jsonify(r)


# -------------------------
# DEMO: Manual trade + Auto Rules CRUD (UI kontrol paneli)
# -------------------------

def _demo_find_open_positions(user: dict, symbol: str = ""):
    out = []
    for pos in (user.get("positions") or []):
        if pos.get("status") != "OPEN":
            continue
        if symbol and pos.get("symbol") != symbol:
            continue
        out.append(pos)
    return out

# @app.post("/api/demo/trade-legacy")
def api_demo_trade_legacy():
    """Demo manual trade.

    BUY: opens a position using amount_usdt
    SELL: sells ALL open positions for symbol (project rule: sell all base)

    Body:
      {"user_id":"...","symbol":"BTC/USDT","side":"BUY|SELL","amount_usdt":123}
    """
    j = request.get_json(silent=True) or {}
    uid = safe_str(j.get("user_id") or _demo_get_user_id() or "demo").strip() or "demo"
    symbol = str(j.get("symbol") or "").strip()
    side = str(j.get("side") or "").strip().upper()
    amount_usdt = j.get("amount_usdt", 0)
    plan = safe_str(j.get("plan") or "").strip()

    if not symbol:
        return jsonify({"ok": False, "error": "Symbol boÅŸ"}), 400
    if side not in ("BUY", "SELL"):
        return jsonify({"ok": False, "error": "Side geÃ§ersiz"}), 400

    if side == "BUY":
        try:
            amount_usdt = float(amount_usdt)
        except Exception:
            amount_usdt = 0
        r = _demo_buy(uid, symbol, amount_usdt, plan=plan)
        if not r.get("ok"):
            return jsonify(r), 400
        return jsonify(r)

    # SELL: close all open positions for symbol immediately
    user = _demo_ensure_user(uid)
    open_positions = _demo_find_open_positions(user, symbol)
    if not open_positions:
        return jsonify({"ok": False, "error": "AÃ§Ä±k pozisyon yok"}), 400

    sold = []
    for pos in list(open_positions):
        try:
            price = _demo_fetch_price(symbol)
            qty = float(pos.get("qty") or 0)
            if price <= 0 or qty <= 0:
                continue
            proceeds = qty * price
            entry_amount = float(pos.get("amount_usdt") or 0)
            pnl = proceeds - entry_amount
            with DEMO_LOCK:
                user["balance_usdt"] = float(user.get("balance_usdt") or 0) + proceeds
                pos["status"] = "CLOSED"
                pos["closed_at"] = _demo_now_iso()
                pos["exit_price"] = price
                pos["pnl_usdt"] = pnl
            sold.append(pos)
        except Exception:
            continue

    if not sold:
        return jsonify({"ok": False, "error": "SatÄ±ÅŸ yapÄ±lamadÄ±"}), 400

    return jsonify({"ok": True, "sold": sold})


# @app.get("/api/demo/auto_rules")
def api_demo_auto_rules_list():
    uid = _demo_get_user_id()
    user = _demo_ensure_user(uid)
    with DEMO_LOCK:
        return jsonify({"ok": True, "user_id": uid, "rules": list(user.get("auto_configs") or [])})

# @app.post("/api/demo/auto_rules")
def api_demo_auto_rules_add():
    uid = _demo_get_user_id()
    j = request.get_json(silent=True) or {}
    symbol = str(j.get("symbol") or "").strip()
    try:
        amount_usdt = float(j.get("amount_usdt") or 0)
    except Exception:
        amount_usdt = 0
    enabled = bool(j.get("enabled", True))

    if not symbol:
        return jsonify({"ok": False, "error": "Symbol boÅŸ"}), 400
    if amount_usdt <= 0:
        return jsonify({"ok": False, "error": "GeÃ§ersiz miktar"}), 400

    user = _demo_ensure_user(uid)
    rule = {
        "id": f"rule_{int(time.time()*1000)}",
        "symbol": symbol,
        "amount_usdt": amount_usdt,
        "enabled": enabled,
        "created_at": _demo_now_iso(),
        "updated_at": _demo_now_iso(),
    }
    with DEMO_LOCK:
        user.setdefault("auto_configs", []).insert(0, rule)

    return jsonify({"ok": True, "rule": rule})

# @app.patch("/api/demo/auto_rules/<rule_id>")
def api_demo_auto_rules_update(rule_id: str):
    uid = _demo_get_user_id()
    j = request.get_json(silent=True) or {}
    user = _demo_ensure_user(uid)

    with DEMO_LOCK:
        rules = user.get("auto_configs") or []
        for r in rules:
            if str(r.get("id")) == str(rule_id):
                if "symbol" in j:
                    r["symbol"] = str(j.get("symbol") or r.get("symbol") or "").strip()
                if "amount_usdt" in j:
                    try:
                        r["amount_usdt"] = float(j.get("amount_usdt") or r.get("amount_usdt") or 0)
                    except Exception:
                        pass
                if "enabled" in j:
                    r["enabled"] = bool(j.get("enabled"))
                r["updated_at"] = _demo_now_iso()
                return jsonify({"ok": True, "rule": r})

    return jsonify({"ok": False, "error": "Rule bulunamadÄ±"}), 404

# @app.delete("/api/demo/auto_rules/<rule_id>")
def api_demo_auto_rules_delete(rule_id: str):
    uid = _demo_get_user_id()
    user = _demo_ensure_user(uid)
    with DEMO_LOCK:
        rules = list(user.get("auto_configs") or [])
        new_rules = [r for r in rules if str(r.get("id")) != str(rule_id)]
        user["auto_configs"] = new_rules
    return jsonify({"ok": True})

# =========================
# EXCHANGE STATUS API
# =========================
@app.get("/api/exchanges/status")
def api_exchanges_status():
    """Return exchange connection status for current user"""
    # Guest check
    if not session.get("logged_in"):
        return jsonify({
            "ok": True,
            "guest": True,
            "exchanges": {
                "okx": {"connected": False, "name": "OKX"},
                "binance": {"connected": False, "name": "Binance"},
                "gate": {"connected": False, "name": "Gate.io"},
                "bybit": {"connected": False, "name": "Bybit"}
            }
        })
    
    user_id = session.get("user_id") or session.get("username") or 'global'
    
    # Default status - all disconnected
    status = {
        "okx": {"connected": False, "name": "OKX"},
        "binance": {"connected": False, "name": "Binance"},
        "gate": {"connected": False, "name": "Gate.io"},
        "bybit": {"connected": False, "name": "Bybit"},
        "btcturk": {"connected": False, "name": "BTCTURK"}
    }
    
    try:
        # Check exchange_api_keys table (where API keys are stored)
        init_exchange_table()
        conn = get_exchange_db()
        rows = conn.execute(
            "SELECT exchange, api_key FROM exchange_api_keys WHERE user_id=?",
            (user_id,)
        ).fetchall()
        conn.close()
        
        for row in rows:
            ex_name = (row[0] or '').lower()
            api_key_enc = row[1]
            if ex_name in status and api_key_enc:
                # Decrypt and check if valid
                api_key = decrypt_data(api_key_enc) if api_key_enc else ''
                if api_key and len(api_key) > 5:
                    status[ex_name]["connected"] = True
    except Exception as e:
        print(f"[EXCHANGE STATUS] Error: {e}")
    
    return jsonify({"ok": True, "exchanges": status})

# =========================
# DEMO Engine END
# =========================

def fetch_ohlc(symbol: str, tf: str, limit: int):
    import ccxt

    ex = ccxt.okx({"enableRateLimit": True, "timeout": 15000})

    tf_map = {
        "1m": "1m", "3m": "3m", "5m": "5m", "15m": "15m", "30m": "30m",
        "1h": "1h", "2h": "2h", "4h": "4h", "6h": "6h", "12h": "12h",
        "1d": "1d",
    }
    ccxt_tf = tf_map.get(tf, "1m")

    if limit < 1:
        limit = 1
    if limit > 300:
        limit = 300

    ohlcv = ex.fetch_ohlcv(symbol, timeframe=ccxt_tf, limit=limit)
    return {"symbol": symbol, "tf": tf, "candles": ohlcv}

import traceback
from flask import Response


@app.post("/admin/users/<username>/extend")
def admin_extend_user(username: str):
    rr = require_admin()
    if rr:
        return rr
    username = safe_str(username)

    try:
        days = int(safe_str(request.form.get("days") or "0"))
    except Exception:
        days = 0
    days = max(0, min(365, days))
    if days <= 0:
        return redirect(f"/admin/users/{username}")

    conn = db()
    try:
        row = conn.execute("SELECT expires_at FROM users WHERE username=?", (username,)).fetchone()
        if not row:
            return redirect("/admin")
        old_exp = int(row["expires_at"] or 0)
        base = old_exp if old_exp > now_ts() else now_ts()
        new_exp = base + int(days * 24 * 3600)
        conn.execute("UPDATE users SET expires_at=? WHERE username=?", (new_exp, username))
        conn.commit()
    finally:
        conn.close()

    try:
        log_line("admin", "INFO", f"EXTEND: {username} +{days} gÃ¼n")
    except Exception:
        pass
    return redirect(f"/admin/users/{username}")

    from werkzeug.exceptions import HTTPException

from werkzeug.exceptions import HTTPException
import traceback

@app.errorhandler(Exception)
def handle_error(e):
    # HTTP hatalarÄ± (404, 401 vs) gerÃ§ek koduyla dÃ¶nsÃ¼n
    if isinstance(e, HTTPException):
        return jsonify({"error": e.description}), e.code

    # DiÄŸer hatalarÄ± log'a bas (traceback)
    app.logger.error("Unhandled exception: %s\n%s", str(e), traceback.format_exc())

    # KullanÄ±cÄ±ya sade 500 dÃ¶n
    return jsonify({"error": "internal server error"}), 500

# =========================
# Helpers
# =========================
def http_get_json(url: str, headers: dict) -> dict:
    req = urllib.request.Request(url, headers=headers, method="GET")
    with urllib.request.urlopen(req, timeout=15) as resp:
        raw = resp.read().decode("utf-8", errors="ignore")
    try:
        return json.loads(raw)
    except Exception:
        return {"_raw": raw}

def _to_float(x, default=0.0) -> float:
    try:
        if x is None:
            return float(default)
        return float(x)
    except Exception:
        return float(default)


def normalize_room(x: str) -> str:
    r = safe_str(x or "").strip().lower()
    if not r:
        return "general"
    aliases = {
        "genel": "general",
        "general": "general",
        "sinyal": "sinyaller",
        "sinyaller": "sinyaller",
        "signals": "sinyaller",
        "vip": "vip",
    }
    return aliases.get(r, r)

def safe_str(s: Any) -> str:
    return ("" if s is None else str(s)).strip()

def normalize_symbol(sym: str) -> str:
    s = safe_str(sym).strip().upper().replace(" ", "")
    if not s:
        return s
    if s in COMMODITY_ALIASES:
        return COMMODITY_ALIASES[s]
    return s


def fmt_ts(ts: Any) -> str:
    """Unix timestamp (seconds or ms) -> 'YYYY-MM-DD HH:MM:SS' in TR (+03:00)."""
    try:
        if ts is None:
            return "-"
        ts_int = int(float(ts))
    except Exception:
        return "-"
    if ts_int <= 0:
        return "-"
    # ms -> seconds
    if ts_int > 10**12:
        ts_int = int(ts_int / 1000)
    try:
        dt = datetime.fromtimestamp(ts_int, tz=timezone.utc).astimezone(timezone(timedelta(hours=3)))
        return dt.strftime("%Y-%m-%d %H:%M:%S")
    except Exception:
        return "-"


def html_escape(s: str) -> str:
    s = "" if s is None else str(s)
    return (s.replace("&", "&amp;")
              .replace("<", "&lt;")
              .replace(">", "&gt;")
              .replace('"', "&quot;")
              .replace("'", "&#39;"))

# =========================
# App settings (global)
# =========================
def get_app_setting(key: str, default: str = "") -> str:
    k = safe_str(key)
    if not k:
        return safe_str(default)
    conn = db()
    try:
        row = conn.execute("SELECT value FROM app_settings WHERE key=?", (k,)).fetchone()
        if not row:
            return safe_str(default)
        try:
            return safe_str(row["value"])
        except Exception:
            return safe_str(row[0])
    except Exception:
        return safe_str(default)
    finally:
        try:
            conn.close()
        except Exception:
            pass

def set_app_setting(key: str, value: str) -> None:
    k = safe_str(key)
    if not k:
        return
    v = safe_str(value)
    conn = db()
    try:
        conn.execute(
            "INSERT INTO app_settings(key,value,updated_at) VALUES (?,?,?) "
            "ON CONFLICT(key) DO UPDATE SET value=excluded.value, updated_at=excluded.updated_at",
            (k, v, now_ts()),
        )
        conn.commit()
    finally:
        try:
            conn.close()
        except Exception:
            pass

def get_global_auto_mode() -> str:
    mode = get_app_setting("AUTO_MODE", os.getenv("AUTO_MODE", "NORMAL"))
    mode = safe_str(mode).upper() or "NORMAL"
    if mode not in ("NORMAL", "AGGRESSIVE", "HARD"):
        mode = "NORMAL"
    return mode



def normalize_symbol(sym: str) -> str:
    """Normalize symbols to the canonical form used throughout the app: e.g. BTC/USDT.
    Accepts forms like 'OKX:BTCUSDT', 'BTCUSDT', 'BTC-USDT', 'btc/usdt'.
    """
    s = safe_str(sym).upper()
    if not s:
        return ""
    # Handle 'OKX:BTCUSDT' style
    if ":" in s:
        s = s.split(":", 1)[1].strip()
    s = s.replace("-", "/").replace(" ", "")
    if "/" in s:
        base, quote = s.split("/", 1)
        if quote == "":
            return s
        return f"{base}/{quote}"
    # No slash: try to infer USDT quote
    if s.endswith("USDT") and len(s) > 4:
        return f"{s[:-4]}/USDT"
    return s


def is_trial_user(u: Dict[str, Any]) -> bool:
    """Trial/deneme paketlerini gÃ¼venli ÅŸekilde yakala."""
    try:
        pkg = safe_str(u.get("package_name", "")).strip().lower()
    except Exception:
        pkg = ""
    # YaygÄ±n isimler: trial, deneme, demo
    if pkg in ("trial", "deneme", "demo"):
        return True
    if "trial" in pkg or "deneme" in pkg or "demo" in pkg:
        return True
    # BazÄ± kurulumlarda ayrÄ± alan kullanÄ±labiliyor
    try:
        if int(u.get("is_trial") or 0) == 1:
            return True
    except Exception:
        pass
    return False


def is_real_trial_user(u: Dict[str, Any]) -> bool:
    """1 GÃ¼n LIVE Trial aktif mi?"""
    if not is_trial_user(u):
        return False
    try:
        if int((u.get("trial_real_enabled") or 0)) != 1:
            return False
    except Exception:
        return False
    try:
        exp = int(u.get("trial_expires_at") or 0)
    except Exception:
        exp = 0
    if exp <= 0:
        return False
    return now_ts() < exp

def enforce_trial_expiry(username: str, u: Dict[str, Any]) -> Dict[str, Any]:
    """1 gÃ¼nlÃ¼k LIVE trial bittiyse otomatik trade kapat."""
    try:
        tre = int((u.get("trial_real_enabled") or 0))
        exp = int(u.get("trial_expires_at") or 0)
    except Exception:
        tre, exp = 0, 0
    if tre == 1 and exp > 0 and now_ts() >= exp:
        conn = db()
        try:
            conn.execute(
                "UPDATE users SET trade_enabled=0, force_dry_run=1, trial_real_enabled=0 WHERE username=?",
                (username,),
            )
            conn.commit()
        finally:
            conn.close()
        try:
            u["trade_enabled"] = 0
            u["force_dry_run"] = 1
            u["trial_real_enabled"] = 0
        except Exception:
            pass
        set_last_msg(username, f"{E_STOP} Trial sÃ¼resi bitti â€¢ Trade kapandÄ±")
    return u


def canon_symbol(sym: str) -> str:
    """
    Canonicalize symbols to 'BASE/QUOTE' (e.g., BTC/USDT).
    Accepts BTCUSDT, BTC-USDT, btc/usdt, etc.
    """
    s = safe_str(sym).strip().upper()
    if not s:
        return s
    s = s.replace(" ", "")
    s = s.replace("-", "/")
    if "/" not in s and s.endswith("USDT") and len(s) > 4:
        s = s[:-4] + "/USDT"
    return s

# =========================
# Balance APIs (Binance/Bybit/Gate/OKX)
# =========================
def binance_get_usdt_balance(api_key: str, api_secret: str) -> float:
    if not api_key or not api_secret:
        return 0.0
    base = "https://api.binance.com"
    ts = int(time.time() * 1000)
    qs = f"recvWindow=5000&timestamp={ts}"
    sig = hmac.new(api_secret.encode(), qs.encode(), hashlib.sha256).hexdigest()
    url = f"{base}/api/v3/account?{qs}&signature={sig}"
    j = http_get_json(url, {"X-MBX-APIKEY": api_key})
    bals = j.get("balances") or []
    for b in bals:
        if (b.get("asset") or "").upper() == "USDT":
            return _to_float(b.get("free"), 0) + _to_float(b.get("locked"), 0)
    return 0.0

def bybit_get_usdt_balance(api_key: str, api_secret: str) -> float:
    if not api_key or not api_secret:
        return 0.0
    base = "https://api.bybit.com"
    path = "/v5/account/wallet-balance"
    recv = "5000"
    ts = str(int(time.time() * 1000))
    qs = "accountType=UNIFIED"
    prehash = ts + api_key + recv + qs
    sign = hmac.new(api_secret.encode(), prehash.encode(), hashlib.sha256).hexdigest()
    url = f"{base}{path}?{qs}"
    headers = {
        "X-BAPI-API-KEY": api_key,
        "X-BAPI-TIMESTAMP": ts,
        "X-BAPI-RECV-WINDOW": recv,
        "X-BAPI-SIGN": sign,
    }
    j = http_get_json(url, headers)
    result = (j.get("result") or {})
    lst = result.get("list") or []
    for acc in lst:
        coins = acc.get("coin") or []
        for c in coins:
            if (c.get("coin") or "").upper() == "USDT":
                v = c.get("walletBalance")
                if v is None:
                    v = c.get("availableToWithdraw")
                if v is None:
                    v = c.get("equity")
                return _to_float(v, 0.0)
    return 0.0

def gateio_get_usdt_balance(api_key: str, api_secret: str) -> float:
    if not api_key or not api_secret:
        return 0.0
    base = "https://api.gateio.ws"
    path = "/api/v4/spot/accounts"
    method = "GET"
    query = ""
    body = ""
    ts = str(int(time.time()))
    body_hash = hashlib.sha512(body.encode()).hexdigest()
    prehash = method + "\n" + path + "\n" + query + "\n" + body_hash + "\n" + ts
    sign = hmac.new(api_secret.encode(), prehash.encode(), hashlib.sha512).hexdigest()
    url = f"{base}{path}"
    headers = {"KEY": api_key, "Timestamp": ts, "SIGN": sign}
    j = http_get_json(url, headers)
    if isinstance(j, list):
        for row in j:
            if (row.get("currency") or "").upper() == "USDT":
                return _to_float(row.get("available"), 0) + _to_float(row.get("locked"), 0)
    return 0.0

def okx_get_usdt_balance(api_key: str, api_secret: str, api_passphrase: str) -> float:
    """
    OKX v5 account balance (USDT).
    Hata olursa 0.0 dÃ¶ner, UI asla Ã§Ã¶kmez.
    """
    if not api_key or not api_secret or not api_passphrase:
        return 0.0
    try:
        import requests
        base = "https://www.okx.com"
        path = "/api/v5/account/balance"
        query = "ccy=USDT"
        url = f"{base}{path}?{query}"
        ts = datetime.utcnow().isoformat(timespec="milliseconds") + "Z"
        method = "GET"
        body = ""
        prehash = ts + method + path + "?" + query + body
        sign = base64.b64encode(hmac.new(api_secret.encode(), prehash.encode(), hashlib.sha256).digest()).decode()
        headers = {
            "OK-ACCESS-KEY": api_key,
            "OK-ACCESS-SIGN": sign,
            "OK-ACCESS-TIMESTAMP": ts,
            "OK-ACCESS-PASSPHRASE": api_passphrase,
        }
        r = requests.get(url, headers=headers, timeout=15)
        j = r.json() if r is not None else {}
        data = j.get("data") or []
        if not data:
            return 0.0
        details = (data[0].get("details") or [])
        if not details:
            return 0.0
        d0 = details[0] or {}
        # cashBal genelde USDT spot/free'yi verir, yoksa availEq/eq fallback
        v = d0.get("cashBal")
        if v is None:
            v = d0.get("availEq")
        if v is None:
            v = d0.get("eq")
        return _to_float(v, 0.0)
    except Exception:
        return 0.0


def okx_get_asset_balance(ccy: str, api_key: str, api_secret: str, api_passphrase: str) -> float:
    """
    OKX v5 account balance for given asset (spot/free).
    Hata olursa 0.0 dÃ¶ner.
    """
    ccy = safe_str(ccy).strip().upper()
    if not ccy:
        return 0.0
    if not api_key or not api_secret or not api_passphrase:
        return 0.0
    try:
        import requests
        base = "https://www.okx.com"
        path = "/api/v5/account/balance"
        query = f"ccy={urllib.parse.quote(ccy)}"
        url = f"{base}{path}?{query}"
        ts = datetime.utcnow().isoformat(timespec="milliseconds") + "Z"
        method = "GET"
        body = ""
        prehash = f"{ts}{method}{path}?{query}{body}"
        sign = base64.b64encode(hmac.new(api_secret.encode("utf-8"), prehash.encode("utf-8"), hashlib.sha256).digest()).decode("utf-8")
        headers = {
            "OK-ACCESS-KEY": api_key,
            "OK-ACCESS-SIGN": sign,
            "OK-ACCESS-TIMESTAMP": ts,
            "OK-ACCESS-PASSPHRASE": api_passphrase,
        }
        r = requests.get(url, headers=headers, timeout=15)
        j = r.json() if r is not None else {}
        data = j.get("data") or []
        if not data:
            return 0.0
        details = (data[0].get("details") or [])
        if not details:
            return 0.0
        d0 = details[0] or {}
        v = d0.get("cashBal")
        if v is None:
            v = d0.get("availEq")
        if v is None:
            v = d0.get("eq")
        return _to_float(v, 0.0)
    except Exception:
        return 0.0


def _base_ccy_from_symbol(symbol: str) -> str:
    s = safe_str(symbol).strip().upper()
    if "/" in s:
        return safe_str(s.split("/", 1)[0]).strip().upper()
    return s


# =========================
# Fee helpers (USDT conversion)
# =========================
def _fee_ccy_to_usdt(exchange_id: str, fee_amt: float, fee_ccy: str, symbol: str, symbol_price: float) -> float:
    """Converts a fee amount in fee_ccy to USDT. Uses symbol_price if fee_ccy is base of symbol, otherwise tries fee_ccy/USDT."""
    try:
        fee_amt = abs(_to_float(fee_amt, 0.0))
        fee_ccy = safe_str(fee_ccy or '').upper()
        exchange_id = safe_str(exchange_id or '').upper()
        if fee_amt <= 0 or not fee_ccy:
            return 0.0
        if fee_ccy in ('USDT','USD'):
            return fee_amt
        base = _base_ccy_from_symbol(symbol)
        if base and fee_ccy == base and symbol_price > 0:
            return fee_amt * float(symbol_price)
        # Try direct price
        try:
            px = _to_float(get_public_price(exchange_id, f"{fee_ccy}/USDT"), 0.0)
            if px > 0:
                return fee_amt * px
        except Exception:
            pass
        # If fee_ccy equals quote USDT already handled; fallback 0
        return 0.0
    except Exception:
        return 0.0


def _sum_buy_fees_usdt(exchange_id: str, symbol: str, rows: List[dict]) -> float:
    """Sums BUY fees (usdt + coin fees converted) across stacked open_positions rows."""
    total = 0.0
    try:
        for r in (rows or []):
            try:
                entry_price = _to_float(r.get('entry_price'), 0.0)
                total += abs(_to_float(r.get('buy_fee_usdt'), 0.0))
                fee_coin = abs(_to_float(r.get('buy_fee_coin'), 0.0))
                fee_ccy = safe_str(r.get('buy_fee_coin_ccy') or '').upper()
                if fee_coin > 0 and fee_ccy:
                    total += _fee_ccy_to_usdt(exchange_id, fee_coin, fee_ccy, symbol, entry_price)
            except Exception:
                continue
    except Exception:
        pass
    return float(total)


def _sum_sell_fees_usdt(exchange_id: str, symbol: str, fill_price: float, res: Dict[str, Any]) -> float:
    """Sums SELL fees from place_order result (fee_usdt + fee_coin converted)."""
    try:
        fee_usdt = abs(_to_float((res or {}).get('fee_usdt'), 0.0))
        fee_coin = abs(_to_float((res or {}).get('fee_coin'), 0.0))
        fee_ccy = safe_str((res or {}).get('fee_coin_ccy') or '').upper()
        total = fee_usdt
        if fee_coin > 0 and fee_ccy:
            total += _fee_ccy_to_usdt(exchange_id, fee_coin, fee_ccy, symbol, fill_price)
        return float(total)
    except Exception:
        return 0.0
def get_user_exchange_usdt_balances(user: dict) -> dict:
    """
    UI iÃ§in: 4 borsanÄ±n USDT bakiyesini aynÄ± anda dÃ¶ner.
    API yoksa / hata varsa 0.0 dÃ¶ner.
    """
    out = {"OKX": 0.0, "BINANCE": 0.0, "BYBIT": 0.0, "GATE": 0.0}
    if user and not isinstance(user, dict):
        user = dict(user)

    try:
        out["OKX"] = okx_get_usdt_balance(
            safe_str(user.get("api_key")),
            safe_str(user.get("api_secret")),
            safe_str(user.get("api_passphrase")),
        )
    except Exception:
        out["OKX"] = 0.0

    try:
        k = safe_str(user.get("binance_api_key"))
        s = safe_str(user.get("binance_api_secret"))
        out["BINANCE"] = binance_get_usdt_balance(k, s) if (k and s) else 0.0
    except Exception:
        out["BINANCE"] = 0.0

    try:
        k = safe_str(user.get("bybit_api_key"))
        s = safe_str(user.get("bybit_api_secret"))
        out["BYBIT"] = bybit_get_usdt_balance(k, s) if (k and s) else 0.0
    except Exception:
        out["BYBIT"] = 0.0

    try:
        k = safe_str(user.get("gate_api_key"))
        s = safe_str(user.get("gate_api_secret"))
        out["GATE"] = gateio_get_usdt_balance(k, s) if (k and s) else 0.0
    except Exception:
        out["GATE"] = 0.0

    return out

def format_balances_line(bals: dict) -> str:
    return (
        f"OKX: {float(bals.get('OKX',0.0)):.2f} USDT  â€¢  "
        f"Binance: {float(bals.get('BINANCE',0.0)):.2f} USDT  â€¢  "
        f"Bybit: {float(bals.get('BYBIT',0.0)):.2f} USDT  â€¢  "
        f"Gate: {float(bals.get('GATE',0.0)):.2f} USDT"
    )


def set_last_msg(username: str, msg: str) -> None:
    """
    Panelde 'son mesaj' gÃ¶stermek iÃ§in.
    Trade akÄ±ÅŸÄ±nÄ± ASLA bozmasÄ±n diye try/except ile gÃ¼venli.
    """
    try:
        uname = (username or "").strip()
        if not uname:
            return
        m = (msg or "").strip()
        if not m:
            return

        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cur = conn.cursor()

        # users tablosunda last_msg kolonu yoksa ekle
        cur.execute("PRAGMA table_info(users)")
        cols = [r[1] for r in cur.fetchall()]  # name
        if "last_msg" not in cols:
            cur.execute("ALTER TABLE users ADD COLUMN last_msg TEXT")

        cur.execute("UPDATE users SET last_msg=? WHERE username=?", (m, uname))
        conn.commit()
        conn.close()
    except Exception as e:
        try:
            log_line("WARN", "system", f"set_last_msg failed: {e}")
        except Exception:
            pass


# =========================
# Public price helpers (UI)
# =========================

_PRICE_CACHE: Dict[str, Dict[str, Any]] = {}

def _cache_get(key: str, ttl: int = 8) -> Optional[float]:
    v = _PRICE_CACHE.get(key)
    if not v:
        return None
    if int(time.time()) - int(v.get("ts", 0)) > ttl:
        return None
    return v.get("price")

def _cache_set(key: str, price: float) -> None:
    _PRICE_CACHE[key] = {"ts": int(time.time()), "price": float(price)}

def _sym_norm_for_price(ex: str, symbol: str) -> str:
    s = (symbol or "").strip().upper()
    s = s.replace("-", "/")
    return s

def _public_price_okx(symbol: str) -> Optional[float]:
    # OKX uses instId like BTC-USDT
    import requests
    s = _sym_norm_for_price("OKX", symbol).replace("/", "-")
    url = f"https://www.okx.com/api/v5/market/ticker?instId={s}"
    r = requests.get(url, timeout=6)
    j = r.json()
    data = (j or {}).get("data") or []
    if not data:
        return None
    last = data[0].get("last")
    return float(last) if last is not None else None

def _public_price_binance(symbol: str) -> Optional[float]:
    import requests
    s = _sym_norm_for_price("BINANCE", symbol).replace("/", "")
    url = f"https://api.binance.com/api/v3/ticker/price?symbol={s}"
    r = requests.get(url, timeout=6)
    j = r.json()
    p = (j or {}).get("price")
    return float(p) if p is not None else None

def _public_price_bybit(symbol: str) -> Optional[float]:
    import requests
    # Bybit v5: category=spot, symbol=BTCUSDT
    s = _sym_norm_for_price("BYBIT", symbol).replace("/", "")
    url = f"https://api.bybit.com/v5/market/tickers?category=spot&symbol={s}"
    r = requests.get(url, timeout=6)
    j = r.json()
    lst = (((j or {}).get("result") or {}).get("list") or [])
    if not lst:
        return None
    last = lst[0].get("lastPrice")
    return float(last) if last is not None else None

def _public_price_gate(symbol: str) -> Optional[float]:
    import requests
    # Gate spot: currency_pair=BTC_USDT
    s = _sym_norm_for_price("GATE", symbol).replace("/", "_")
    url = f"https://api.gateio.ws/api/v4/spot/tickers?currency_pair={s}"
    r = requests.get(url, timeout=6)
    j = r.json()
    if isinstance(j, list) and j:
        last = j[0].get("last")
        return float(last) if last is not None else None
    return None

def get_public_price(exchange_id: str, symbol: str) -> Optional[float]:
    ex = (exchange_id or "").strip().upper()
    key = f"{ex}:{_sym_norm_for_price(ex, symbol)}"
    cached = _cache_get(key)
    if cached is not None:
        return cached
    try:
        if ex == "OKX":
            p = _public_price_okx(symbol)
        elif ex == "BINANCE":
            p = _public_price_binance(symbol)
        elif ex == "BYBIT":
            p = _public_price_bybit(symbol)
        elif ex in ("GATE", "GATEIO", "GATE.IO"):
            p = _public_price_gate(symbol)
        else:
            p = None
        if p is None:
            return None
        _cache_set(key, float(p))
        return float(p)
    except Exception:
        return None


# Backward compatible alias
def public_price(exchange_id: str, symbol: str) -> Optional[float]:
    return get_public_price(exchange_id, symbol)


# =========================
# Open positions (manual BUY stays visible)
# =========================

def positions_for_user(username: str) -> List[Dict[str, Any]]:
    """DB'den kullanÄ±cÄ±nÄ±n aÃ§Ä±k pozisyonlarÄ±nÄ± listeler (dict dÃ¶ner)."""
    conn = db()
    cur = conn.cursor()
    cur.execute("""
        SELECT username, exchange_id, symbol, qty, entry_price, created_at
        FROM open_positions
        WHERE username = ?
        ORDER BY created_at DESC
        LIMIT 50
    """, (username,))
    rows = cur.fetchall() or []
    conn.close()
    # sqlite3.Row -> dict; UI tarafÄ±nda p.get(...) kullanÄ±yoruz
    out: List[Dict[str, Any]] = []
    for r in rows:
        try:
            out.append(dict(r))
        except Exception:
            # fallback (Ã§ok nadir)
            out.append({
                "username": r[0] if len(r) > 0 else username,
                "exchange_id": r[1] if len(r) > 1 else "",
                "symbol": r[2] if len(r) > 2 else "",
                "qty": r[3] if len(r) > 3 else 0.0,
                "entry_price": r[4] if len(r) > 4 else 0.0,
                "created_at": r[5] if len(r) > 5 else None,
            })
    return out



def position_add(username: str, exchange_id: str, symbol: str, qty: float, entry_price: float, entry_usdt: float, dry_run: bool, buy_fee_usdt: float = 0.0, buy_fee_coin: float = 0.0, buy_fee_coin_ccy: str = '', buy_ord_id: str = '') -> int:
    """Always INSERT a new open position (each BUY becomes a new row). Returns position id."""
    conn = db()
    cur = conn.cursor()
    cur.execute(
        """
        INSERT INTO open_positions(username, exchange_id, symbol, qty, entry_price, entry_usdt, buy_fee_usdt, buy_fee_coin, buy_fee_coin_ccy, buy_ord_id, dry_run, created_at)
        VALUES(?,?,?,?,?,?,?,?,?,?,?,?)
        """,
        (
            username,
            str(exchange_id).upper(),
            str(symbol).upper(),
            float(qty or 0.0),
            float(entry_price or 0.0),
            float(entry_usdt or 0.0),
            float(buy_fee_usdt or 0.0),
            float(buy_fee_coin or 0.0),
            str(buy_fee_coin_ccy or ''),
            str(buy_ord_id or ''),
            1 if dry_run else 0,
            now_ts(),
        ),
    )
    pid = int(cur.lastrowid)
    # users tablosuna AUTO regime kolonlarÄ± ekle (yoksa)
    try:
        cur.execute("PRAGMA table_info(users)")
        cols = [r[1] for r in cur.fetchall()]
        if "auto_gate" not in cols:
            cur.execute("ALTER TABLE users ADD COLUMN auto_gate INTEGER NOT NULL DEFAULT 1")
        if "auto_mode" not in cols:
            cur.execute("ALTER TABLE users ADD COLUMN auto_mode TEXT NOT NULL DEFAULT 'NORMAL'")
        if "auto_gate_reason" not in cols:
            cur.execute("ALTER TABLE users ADD COLUMN auto_gate_reason TEXT NOT NULL DEFAULT ''")
    except Exception:
        pass


    conn.commit()
    conn.close()
    return pid

def get_position(pid: int, username: str | None = None) -> dict | None:
    # Backward compatible: allow get_position(username, pid)
    if username is not None and isinstance(pid, str) and isinstance(username, (int, float)):
        pid, username = username, pid
    if username is None:
        username = session.get('username')

    """Fetch a single open position by id. If username provided, also filters by username."""
    conn = db()
    cur = conn.cursor()
    if username is None:
        cur.execute("SELECT * FROM open_positions WHERE id=?", (int(pid),))
    else:
        cur.execute("SELECT * FROM open_positions WHERE id=? AND username=?", (int(pid), username))
    r = cur.fetchone()
    conn.close()
    return dict(r) if r else None

def delete_position(pid: int, username: str | None = None) -> bool:
    conn = db()
    cur = conn.cursor()
    if username is None:
        cur.execute("DELETE FROM open_positions WHERE id=?", (int(pid),))
    else:
        cur.execute("DELETE FROM open_positions WHERE id=? AND username=?", (int(pid), username))
    ok = cur.rowcount > 0
    conn.commit()
    conn.close()
    return ok

def now_ts() -> int:
    return int(time.time())

def iso_now_local() -> str:
    dt = datetime.utcnow() + timedelta(hours=TZ_OFFSET_HOURS)
    return dt.strftime("%Y-%m-%d %H:%M:%S")

def sha256_hex(s: str) -> str:
    return hashlib.sha256(s.encode("utf-8")).hexdigest()

def hash_password(pw: str, salt: str) -> str:
    return sha256_hex(f"{salt}:{pw}")

def verify_password(pw: str, salt: str, pw_hash: str) -> bool:
    return hash_password(pw, salt) == pw_hash

# ===============================================
# TELEGRAM HELPER
# ===============================================

def send_telegram_message(chat_id: str, text: str) -> bool:
    """Send message via Telegram Bot API
    
    Args:
        chat_id: Telegram chat ID (user's chat ID)
        text: Message text (supports HTML formatting)
    
    Returns:
        True if message sent successfully, False otherwise
    """
    import os
    try:
        import requests
    except ImportError:
        print("[TELEGRAM] requests module not available")
        return False
    
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        print("[TELEGRAM] âš ï¸ TELEGRAM_BOT_TOKEN not set in environment")
        return False
    
    if not chat_id:
        print("[TELEGRAM] âš ï¸ No chat_id provided")
        return False
    
    try:
        url = f"https://api.telegram.org/bot{token}/sendMessage"
        payload = {
            "chat_id": chat_id,
            "text": text,
            "parse_mode": "HTML"
        }
        res = requests.post(url, json=payload, timeout=10)
        
        if res.status_code == 200:
            print(f"[TELEGRAM] âœ… Message sent to {chat_id}")
            return True
        else:
            print(f"[TELEGRAM] âŒ Failed: {res.status_code} - {res.text}")
            return False
    except Exception as e:
        print(f"[TELEGRAM] âŒ Error sending message: {e}")
        return False

def db() -> sqlite3.Connection:
    conn = sqlite3.connect(DB_PATH, timeout=60, check_same_thread=False, isolation_level=None)
    conn.row_factory = sqlite3.Row
    # Enable WAL mode for better concurrent access
    try:
        conn.execute("PRAGMA journal_mode=WAL")
        conn.execute("PRAGMA busy_timeout=60000")
        conn.execute("PRAGMA synchronous=NORMAL")
        conn.execute("PRAGMA cache_size=10000")
    except:
        pass
    return conn

def db_execute_with_retry(query, params=(), max_retries=5):
    """Execute a query with retry on database lock"""
    import time
    for attempt in range(max_retries):
        try:
            conn = db()
            cursor = conn.execute(query, params)
            conn.commit()
            result = cursor.fetchall() if cursor.description else None
            conn.close()
            return result
        except sqlite3.OperationalError as e:
            if "database is locked" in str(e) and attempt < max_retries - 1:
                time.sleep(0.1 * (2 ** attempt))  # Exponential backoff
                continue
            raise
        except Exception as e:
            try:
                conn.close()
            except:
                pass
            raise


# Backward compatible alias (some older parts called db_connect)
def db_connect() -> sqlite3.Connection:
    return db()


def package_limit_for(name: str) -> int:
    """Get transaction limit for a package (legacy function)"""
    config = get_package_config(name)
    limit = config.get("transaction_limit", 300)
    return limit if limit >= 0 else 999999

def get_package_config(package_name: str) -> dict:
    """Get complete package configuration including all limits and features
    
    This is the central package configuration function.
    All package info should be retrieved through this function.
    
    Returns dict with: name, monthly_price, transaction_limit, auto_coin_limit, features
    """
    package_configs = {
        "deneme": {
            "name": "1 GÃ¼nlÃ¼k Ãœcretsiz Deneme",
            "display_name": "ğŸ Deneme Paketi",
            "monthly_price": 0,
            "transaction_limit": -1,  # unlimited
            "auto_coin_limit": 1,
            "features": [
                "1 gÃ¼n Ã¼cretsiz kullanÄ±m",
                "100 TL test bakiyesi",
                "TÃ¼m borsalar",
                "Temel Ã¶zellikler"
            ]
        },
        "temel": {
            "name": "Temel Paket",
            "display_name": "ğŸ“¦ Temel Paket",
            "monthly_price": 7500,
            "transaction_limit": 100,
            "auto_coin_limit": 2,
            "features": [
                "AylÄ±k 100 Ä°ÅŸlem hakkÄ±",
                "Auto Ä°ÅŸlemlerde 2 coin aÃ§abilme",
                "7/24 Destek",
                "Temel analiz araÃ§larÄ±"
            ]
        },
        "premium": {
            "name": "Premium Paket",
            "display_name": "â­ Premium Paket",
            "monthly_price": 12500,
            "transaction_limit": 500,
            "auto_coin_limit": 3,
            "features": [
                "AylÄ±k 500 Ä°ÅŸlem hakkÄ±",
                "Auto Ä°ÅŸlemlerde 3 coin aÃ§abilme",
                "Ã–ncelikli destek",
                "GeliÅŸmiÅŸ analiz araÃ§larÄ±",
                "Ã–zel stratejiler"
            ]
        },
        "elit": {
            "name": "Elit Paket",
            "display_name": "ğŸ‘‘ Elit Paket",
            "monthly_price": 20000,
            "transaction_limit": -1,  # unlimited
            "auto_coin_limit": 5,
            "features": [
                "SÄ±nÄ±rsÄ±z Ä°ÅŸlem hakkÄ±",
                "Auto Ä°ÅŸlemlerde 5 coin aÃ§abilme",
                "VIP destek",
                "TÃ¼m premium Ã¶zellikler",
                "Ã–zel danÄ±ÅŸmanlÄ±k"
            ]
        },
    }
    
    pkg_key = safe_str(package_name).lower().strip()
    # Try exact match first
    if pkg_key in package_configs:
        return package_configs[pkg_key]
    
    # Try partial matches for flexibility
    for key, config in package_configs.items():
        if key in pkg_key or pkg_key in key:
            return package_configs[key]
    
    # Default to temel if not found
    return package_configs["temel"]

def get_auto_coin_limit(package_name: str) -> int:
    """Get auto-trade coin limit for a package
    
    Returns:
        int: Number of coins allowed in auto-trading mode
        - Deneme: 1 coin
        - Temel: 2 coins  
        - Premium: 3 coins
        - Elit: 5 coins
    """
    return get_package_config(package_name).get("auto_coin_limit", 2)

def get_package_display_name(package_name: str) -> str:
    """Get display name for a package (with emoji)"""
    return get_package_config(package_name).get("display_name", "ğŸ“¦ Temel Paket")

def count_user_auto_trades(username: str, mode: str = "all") -> int:
    """Count active auto trades for a user
    
    Args:
        username: User's username
        mode: 'demo', 'real', or 'all' to count trades in specific mode
    
    Returns:
        int: Number of active auto trades
    """
    conn = db()
    try:
        if mode == "all":
            query = "SELECT COUNT(*) FROM pending_auto_trades WHERE username=?"
            params = (username,)
        else:
            # Check if mode column exists
            try:
                conn.execute("SELECT mode FROM pending_auto_trades LIMIT 1")
                query = "SELECT COUNT(*) FROM pending_auto_trades WHERE username=? AND mode=?"
                params = (username, mode)
            except:
                # Mode column doesn't exist, fall back to all
                query = "SELECT COUNT(*) FROM pending_auto_trades WHERE username=?"
                params = (username,)
        
        result = conn.execute(query, params).fetchone()
        return int(result[0] if result else 0)
    except Exception as e:
        print(f"Error counting auto trades: {e}")
        return 0
    finally:
        conn.close()

def check_auto_coin_limit(username: str, package_name: str, mode: str = "demo") -> dict:
    """Check if user can add more auto-trade coins
    
    Args:
        username: User's username
        package_name: User's package name
        mode: 'demo' or 'real'
    
    Returns:
        dict with 'ok' (bool), 'current' (int), 'limit' (int), 'message' (str)
    """
    limit = get_auto_coin_limit(package_name)
    current = count_user_auto_trades(username, mode)
    
    if current >= limit:
        return {
            "ok": False,
            "current": current,
            "limit": limit,
            "message": f"Auto trade coin limiti doldu! {get_package_display_name(package_name)} ile {mode.upper()} modda en fazla {limit} coin aÃ§abilirsiniz. Åu anda: {current}/{limit}"
        }
    
    return {
        "ok": True,
        "current": current,
        "limit": limit,
        "message": f"Coin ekleyebilirsiniz ({current}/{limit})"
    }

def user_display_name(u: Any) -> str:
    try:
        if u is None:
            return ""
        if isinstance(u, dict):
            dn = safe_str(u.get("display_name", ""))
            return dn if dn else safe_str(u.get("username", ""))
        dn = safe_str(u["display_name"])
        return dn if dn else safe_str(u["username"])
    except Exception:
        return ""

def is_expired(u) -> bool:
    exp = int((u["expires_at"] if not isinstance(u, dict) else u.get("expires_at")) or 0)
    if exp <= 0:
        return False
    return now_ts() > exp

def get_usage(username: str) -> Dict[str, Any]:
    conn = db()
    try:
        row = conn.execute("SELECT * FROM usage WHERE username=?", (username,)).fetchone()
        if not row:
            conn.execute("INSERT OR IGNORE INTO usage (username, used_count, updated_at) VALUES (?,0,?)", (username, now_ts()))
            conn.commit()
            return {"used_count": 0, "updated_at": now_ts()}
        return dict(row)
    finally:
        conn.close()

def set_usage(username: str, used_count: int) -> None:
    conn = db()
    try:
        conn.execute("""
            INSERT INTO usage (username, used_count, updated_at)
            VALUES (?,?,?)
            ON CONFLICT(username) DO UPDATE SET used_count=excluded.used_count, updated_at=excluded.updated_at
        """, (username, used_count, now_ts()))
        conn.commit()
    finally:
        conn.close()

def inc_usage(username: str) -> int:
    u = get_usage(username)
    new_used = int(u["used_count"]) + 1
    set_usage(username, new_used)
    return new_used

def usage_blocked(u) -> bool:
    limit_v = int((u["package_limit"] if not isinstance(u, dict) else u.get("package_limit")) or 300)
    if limit_v < 0:
        return False
    used = int(get_usage((u["username"] if not isinstance(u, dict) else u.get("username")) or "")["used_count"])
    return used >= limit_v

def format_usage_badge(u) -> str:
    limit_v = int((u["package_limit"] if not isinstance(u, dict) else u.get("package_limit")) or 300)
    used = int(get_usage((u["username"] if not isinstance(u, dict) else u.get("username")) or "")["used_count"])
    if limit_v < 0:
        return f"{used} / âˆ"
    return f"{used} / {limit_v}"


def get_daily_loss_limit(u) -> float:
    try:
        if not u:
            return 0.0
        if not isinstance(u, dict):
            u = dict(u)
        return float(u.get("daily_loss_limit_usdt") or 0.0)
    except Exception:
        return 0.0

def set_daily_loss_limit(username: str, limit_usdt: float) -> None:
    conn = db()
    try:
        conn.execute("UPDATE users SET daily_loss_limit_usdt=? WHERE username=?", (float(limit_usdt or 0.0), username))
        conn.commit()
    finally:
        conn.close()


# ===============================================
# DEMO BALANCE MANAGEMENT + MODE ISOLATION MIGRATIONS
# ===============================================

def _init_demo_balance_table():
    """Initialize demo_balance table if not exists"""
    conn = db()
    try:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS demo_balance (
                user_id INTEGER PRIMARY KEY,
                balance REAL DEFAULT 10000.0,
                updated_at INTEGER
            )
        """)
        conn.commit()
        
        # Create transaction_history table for trade logging
        conn.execute("""
            CREATE TABLE IF NOT EXISTS transaction_history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT,
                type TEXT,
                symbol TEXT,
                amount REAL,
                price REAL,
                total REAL,
                profit REAL DEFAULT 0,
                timestamp INTEGER,
                is_simulated INTEGER DEFAULT 1,
                mode TEXT DEFAULT 'demo'
            )
        """)
        conn.commit()
        print("[MIGRATION] âœ“ transaction_history table ready")
        
    except Exception as e:
        print(f"[MIGRATION] transaction_history error: {e}")
    finally:
        try:
            conn.close()
        except:
            pass

def _migrate_demo_real_isolation():
    """Add mode column to support separate demo/real tracking
    
    This migration adds a 'mode' column to:
    - open_positions: to track if position is demo or real
    - pending_auto_trades: to track if auto-trade is demo or real
    
    This allows users to open the same coin in both demo and real mode simultaneously.
    """
    conn = db()
    try:
        # Add mode to open_positions if not exists
        try:
            conn.execute("SELECT mode FROM open_positions LIMIT 1")
        except:
            try:
                print("[MIGRATION] Adding mode column to open_positions...")
                conn.execute("ALTER TABLE open_positions ADD COLUMN mode TEXT DEFAULT 'real'")
                # Set all existing positions to 'real' for backward compatibility
                conn.execute("UPDATE open_positions SET mode='real' WHERE mode IS NULL OR mode=''")
                # Create index for better query performance
                conn.execute("CREATE INDEX IF NOT EXISTS idx_positions_username_mode ON open_positions(username, mode)")
                conn.commit()
                print("[MIGRATION] âœ“ Added mode column to open_positions")
            except Exception as e:
                print(f"[MIGRATION] Note: mode column may already exist: {e}")
        
        # Add mode to pending_auto_trades if table exists
        try:
            conn.execute("SELECT COUNT(*) FROM pending_auto_trades LIMIT 1")
            # Table exists, check for mode column
            try:
                conn.execute("SELECT mode FROM pending_auto_trades LIMIT 1")
            except:
                try:
                    print("[MIGRATION] Adding mode column to pending_auto_trades...")
                    conn.execute("ALTER TABLE pending_auto_trades ADD COLUMN mode TEXT DEFAULT 'real'")
                    conn.execute("UPDATE pending_auto_trades SET mode='real' WHERE mode IS NULL OR mode=''")
                    conn.execute("CREATE INDEX IF NOT EXISTS idx_pending_username_mode ON pending_auto_trades(username, mode)")
                    conn.commit()
                    print("[MIGRATION] âœ“ Added mode column to pending_auto_trades")
                except Exception as e:
                    print(f"[MIGRATION] Note: mode column may already exist: {e}")
        except:
            print("[MIGRATION] Note: pending_auto_trades table doesn't exist yet")
        
        # Add is_simulated to transaction_history if table exists
        try:
            conn.execute("SELECT COUNT(*) FROM transaction_history LIMIT 1")
            # Table exists, check for is_simulated column
            try:
                conn.execute("SELECT is_simulated FROM transaction_history LIMIT 1")
            except:
                try:
                    print("[MIGRATION] Adding is_simulated column to transaction_history...")
                    conn.execute("ALTER TABLE transaction_history ADD COLUMN is_simulated INTEGER DEFAULT 0")
                    conn.execute("CREATE INDEX IF NOT EXISTS idx_transactions_simulated ON transaction_history(username, is_simulated)")
                    conn.commit()
                    print("[MIGRATION] âœ“ Added is_simulated column to transaction_history")
                except Exception as e:
                    print(f"[MIGRATION] Note: is_simulated column may already exist: {e}")
        except:
            print("[MIGRATION] Note: transaction_history table doesn't exist yet")
            
        conn.commit()
    except Exception as e:
        print(f"[MIGRATION] Error during migration: {e}")
    finally:
        try:
            conn.close()
        except:
            pass

# Run migrations on module load
try:
    _init_demo_balance_table()
    _migrate_demo_real_isolation()
except Exception as e:
    print(f"[STARTUP] Migration error (non-fatal): {e}")

def get_demo_balance(user_id: int) -> float:
    """Get demo balance for user from users table"""
    try:
        conn = db()
        # Read from users.demo_balance column (single source of truth)
        row = conn.execute("SELECT demo_balance FROM users WHERE id=?", (user_id,)).fetchone()
        conn.close()
        if row and row[0] is not None:
            return float(row[0])
        # Return default if not found
        return 10000.0
    except Exception as e:
        print(f"[GET_DEMO_BALANCE] Error: {e}")
        return 10000.0

def update_demo_balance(user_id: int, amount: float) -> float:
    """Update demo balance by amount (positive or negative) in users table"""
    current = get_demo_balance(user_id)
    new_balance = max(0.0, current + amount)  # Can't go below 0
    try:
        conn = db()
        conn.execute("UPDATE users SET demo_balance=?, updated_at=? WHERE id=?",
                    (new_balance, int(time.time()), user_id))
        conn.commit()
        conn.close()
        return new_balance
    except Exception as e:
        print(f"[UPDATE_DEMO_BALANCE] Error: {e}")
        return current

def set_demo_balance(user_id: int, balance: float) -> None:
    """Set demo balance to specific amount in users table"""
    try:
        conn = db()
        conn.execute("UPDATE users SET demo_balance=?, updated_at=? WHERE id=?",
                    (float(balance), int(time.time()), user_id))
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"[SET_DEMO_BALANCE] Error: {e}")


# ===============================================
# YAHOO FINANCE NEWS FETCHING
# ===============================================

_YAHOO_NEWS_CACHE = {"data": [], "ts": 0}
_YAHOO_NEWS_TTL = 300  # 5 minutes cache

def fetch_yahoo_finance_news() -> list:
    """Fetch news from multiple sources (cached)"""
    global _YAHOO_NEWS_CACHE
    
    now = int(time.time())
    if now - _YAHOO_NEWS_CACHE["ts"] < _YAHOO_NEWS_TTL and _YAHOO_NEWS_CACHE["data"]:
        return _YAHOO_NEWS_CACHE["data"]
    
    news_items = []
    
    # Try to fetch from multiple RSS sources
    try:
        import urllib.request
        import xml.etree.ElementTree as ET
        
        # Multiple RSS feeds for crypto news
        rss_sources = [
            ("https://cointelegraph.com/rss", "CoinTelegraph"),
            ("https://www.coindesk.com/arc/outboundfeeds/rss/", "CoinDesk"),
            ("https://cryptonews.com/news/feed/", "CryptoNews"),
            ("https://decrypt.co/feed", "Decrypt"),
            ("https://finance.yahoo.com/rss/headline?s=BTC-USD", "Yahoo Finance"),
        ]
        
        for rss_url, source_name in rss_sources:
            try:
                req = urllib.request.Request(rss_url, headers={"User-Agent": "Mozilla/5.0"})
                with urllib.request.urlopen(req, timeout=3) as resp:
                    xml_data = resp.read().decode("utf-8", errors="ignore")
                    root = ET.fromstring(xml_data)
                    
                    for item in root.findall(".//item")[:3]:  # 3 news per source
                        title = item.find("title")
                        pub_date = item.find("pubDate")
                        link = item.find("link")
                        
                        if title is not None and title.text:
                            news_items.append({
                                "title": title.text[:100],
                                "source": source_name,
                                "time": "Yeni",
                                "category": "Kripto",
                                "url": link.text if link is not None else ""
                            })
            except Exception as e:
                print(f"[NEWS] {source_name} RSS error: {e}")
                continue
    except Exception as e:
        print(f"[NEWS] Import error: {e}")
    
    # If RSS failed or got few items, add mock news
    if len(news_items) < 5:
        import random
        
        mock_news = [
            {"title": "Bitcoin $106,000 Seviyesini AÅŸtÄ± - Yeni Rekor", "source": "Yahoo Finance", "time": "5 dk Ã¶nce", "category": "ğŸ”¥ Acil"},
            {"title": "Ethereum ETF OnayÄ± SonrasÄ± Fiyatlar YÃ¼kseliyor", "source": "Bloomberg", "time": "12 dk Ã¶nce", "category": "ETF"},
            {"title": "Fed Faiz KararÄ±: Piyasalar Beklemede", "source": "Reuters", "time": "28 dk Ã¶nce", "category": "Makro"},
            {"title": "Altcoin Sezonu BaÅŸlÄ±yor mu? Uzman GÃ¶rÃ¼ÅŸleri", "source": "CoinDesk", "time": "45 dk Ã¶nce", "category": "Analiz"},
            {"title": "Dolar/TL GÃ¼ncel Durum ve Beklentiler", "source": "Yahoo Finance TR", "time": "1 saat Ã¶nce", "category": "Forex"},
            {"title": "Kripto PiyasasÄ± Toplam DeÄŸeri $3.5 Trilyon", "source": "CoinMarketCap", "time": "1 saat Ã¶nce", "category": "Piyasa"},
            {"title": "XRP SEC DavasÄ±nda Son GeliÅŸmeler", "source": "The Block", "time": "2 saat Ã¶nce", "category": "Hukuk"},
            {"title": "Solana DeFi Ekosistemi BÃ¼yÃ¼meye Devam Ediyor", "source": "Decrypt", "time": "2 saat Ã¶nce", "category": "DeFi"},
            {"title": "BNB Chain Yeni GÃ¼ncelleme Duyurdu", "source": "Binance Blog", "time": "3 saat Ã¶nce", "category": "GÃ¼ncelleme"},
            {"title": "Cardano (ADA) Staking Ã–dÃ¼lleri ArtÄ±yor", "source": "CoinTelegraph", "time": "3 saat Ã¶nce", "category": "Staking"},
            {"title": "AVAX Subnet Teknolojisi ve Kurumsal KullanÄ±m", "source": "Avalanche", "time": "4 saat Ã¶nce", "category": "Teknoloji"},
            {"title": "Polygon (MATIC) zkEVM GÃ¼ncellemesi", "source": "CryptoNews", "time": "4 saat Ã¶nce", "category": "L2"},
        ]
        
        random.shuffle(mock_news)
        needed = 10 - len(news_items)
        news_items.extend(mock_news[:needed])
    
    _YAHOO_NEWS_CACHE["data"] = news_items[:12]  # Max 12 news
    _YAHOO_NEWS_CACHE["ts"] = now
    
    return _YAHOO_NEWS_CACHE["data"]


# ===============================================
# LIVE PRICE FETCHING (TradingView style)
# ===============================================

_LIVE_PRICES_CACHE = {"data": {}, "ts": 0}
_LIVE_PRICES_TTL = 10  # 10 seconds cache

def get_live_crypto_prices() -> dict:
    """Get live crypto prices from CoinGecko (cached)"""
    global _LIVE_PRICES_CACHE
    
    now = int(time.time())
    if now - _LIVE_PRICES_CACHE["ts"] < _LIVE_PRICES_TTL and _LIVE_PRICES_CACHE["data"]:
        return _LIVE_PRICES_CACHE["data"]
    
    try:
        cached = get_coingecko_ticker_cached()
        prices = cached.get("prices") or {}
        
        # Format prices
        result = {}
        for sym, price in prices.items():
            result[sym] = float(price)
            # Also add with /USDT suffix for lookups
            if "/" not in sym:
                result[f"{sym}/USDT"] = float(price)
        
        _LIVE_PRICES_CACHE["data"] = result
        _LIVE_PRICES_CACHE["ts"] = now
        return result
    except Exception as e:
        print(f"[PRICES] Error: {e}")
        return _LIVE_PRICES_CACHE.get("data", {})


def daily_loss_block_msg(u) -> str:
    """
    GÃ¼nlÃ¼k zarar limiti dolduysa popup mesajÄ± dÃ¶ner, deÄŸilse "".
    (trade_enabled kapalÄ± olsa bile bugÃ¼nkÃ¼ PnL'e gÃ¶re kontrol eder)
    """
    try:
        if not u:
            return ""
        if not isinstance(u, dict):
            u = dict(u)
        uname = safe_str(u.get("username") or "")
        limit_dl = float(u.get("daily_loss_limit_usdt") or 0.0)
        if limit_dl <= 0:
            return ""
        sday = stats_for_user(uname, "day") if "stats_for_user" in globals() else {"pnl_usdt": 0.0}
        pnl_day = float((sday or {}).get("pnl_usdt") or 0.0)
        if pnl_day <= -abs(limit_dl):
            return (
                f"{E_STOP} GÃ¼nlÃ¼k zarar limitiniz dolmuÅŸtur.\n\n"
                f"Limitinizi yÃ¼kseltip tekrar deneyin.\n\n"
                f"{E_UP} BugÃ¼n: {pnl_day:.2f} USDT\n"
                f"{E_BOX} Limit: {abs(limit_dl):.2f} USDT"
            )
        return ""
    except Exception:
        return ""

def may_trade(u) -> bool:
    if int((u["trade_enabled"] if not isinstance(u, dict) else u.get("trade_enabled")) or 0) != 1:
        return False
    if is_expired(u):
        return False
    if usage_blocked(u):
        return False
    # Daily loss limit (MANUEL). AUTO bypasses may_trade elsewhere.
    try:
        limit_dl = float(get_daily_loss_limit(u) or 0.0)
        if limit_dl > 0:
            uname = (u.get("username") if isinstance(u, dict) else dict(u).get("username")) or ""
            sday = stats_for_user(uname, "day") if "stats_for_user" in globals() else {"pnl_usdt": 0.0}
            pnl_day = float((sday or {}).get("pnl_usdt") or 0.0)
            if pnl_day <= -abs(limit_dl):
                conn = db()
                try:
                    conn.execute("UPDATE users SET trade_enabled=0 WHERE username=?", (uname,))
                    conn.commit()
                finally:
                    conn.close()
                return False
    except Exception:
        pass

    return True

def log_line(username: str, level: str, message: str) -> None:
    conn = db()
    try:
        conn.execute("INSERT INTO logs (username, level, message, created_at) VALUES (?,?,?,?)",
                     (username, level, message, now_ts()))
        conn.commit()
    finally:
        conn.close()

def get_user(username: str) -> Optional[Dict[str, Any]]:
    conn = db()
    try:
        row = conn.execute("SELECT rowid, * FROM users WHERE username=?", (username,)).fetchone()
        if row:
            # Convert tuple to dict with column names
            cols = [desc[0] for desc in conn.execute("SELECT rowid, * FROM users WHERE 1=0").description]
            return dict(zip(cols, row))
        return None
    finally:
        conn.close()

def require_login():
    if not session.get("username"):
        return redirect("/api/app/login")
    return None


def require_admin_check():
    # Backward-compatible admin gate (returns a Flask Response or None)
    if not session.get("username"):
        return redirect("/api/app/login")
    if not session.get("is_admin"):
        return redirect("/")
    return None

def require_admin(func=None, *dargs, **dkwargs):
    """
    Admin-only decorator.
    Supports both @require_admin and @require_admin().
    Also tolerates accidental extra decorator args (ignored).
    """
    def _decorator(f):
        @wraps(f)
        def _wrapped(*args, **kwargs):
            gate = require_admin_gate()
            if gate is not None:
                return gate
            return f(*args, **kwargs)
        return _wrapped

    # Used as @require_admin without parentheses
    if callable(func):
        return _decorator(func)

    # Used as @require_admin() (or with stray args)
    return _decorator

def _now():
    return int(time.time())

def get_okx_usdt_symbols():
    import requests
    r = requests.get(
        "https://www.okx.com/api/v5/public/instruments",
        params={"instType": "SPOT"},
        timeout=10
    )
    data = r.json().get("data", [])
    return sorted([
        i["instId"].replace("-", "/")
        for i in data
        if i.get("instId", "").endswith("-USDT")
    ])

def get_binance_usdt_symbols():
    import requests
    r = requests.get("https://api.binance.com/api/v3/exchangeInfo", timeout=10)
    out = []
    for s in r.json().get("symbols", []):
        if s.get("status") == "TRADING" and s.get("quoteAsset") == "USDT":
            out.append(f'{s.get("baseAsset")}/USDT')
    return sorted(out)

def get_gateio_usdt_symbols():
    import requests
    r = requests.get("https://api.gateio.ws/api/v4/spot/currency_pairs", timeout=10)
    out = []
    for p in r.json():
        if p.get("quote") == "USDT" and p.get("trade_status") == "tradable":
            out.append(f'{p.get("base")}/USDT')
    return sorted(out)

def get_bybit_usdt_symbols():
    import requests
    r = requests.get(
        "https://api.bybit.com/v5/market/instruments-info",
        params={"category": "spot"},
        timeout=10
    )
    out = []
    for s in r.json().get("result", {}).get("list", []):
        if s.get("quoteCoin") == "USDT" and s.get("status") == "Trading":
            out.append(f'{s.get("baseCoin")}/USDT')
    return sorted(out)

def get_symbols_for_exchange(ex: str):
    ex = (ex or "OKX").strip().upper()
    if ex not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
        ex = "OKX"

    ts = _SYMBOLS_CACHE.get("ts", 0)
    data = _SYMBOLS_CACHE.get("data", {})
    if isinstance(data, dict) and data and (_now() - ts) < _SYMBOLS_TTL_SEC and ex in data:
        return data[ex]

    try:
        if ex == "OKX":
            syms = get_okx_usdt_symbols()
        elif ex == "BINANCE":
            syms = get_binance_usdt_symbols()
        elif ex == "GATEIO":
            syms = get_gateio_usdt_symbols()
        else:
            syms = get_bybit_usdt_symbols()

        # Custom instruments requested by user (may not exist on every exchange).
        # They will still appear in AUTO/MANUEL selectors; if exchange does not
        # support, order will fail with a clear reason (logged + Telegram DM).
        # Add major coins + commodities (requested by user)
        extra = [
            # Major Cryptocurrencies
            "BTC/USDT", "ETH/USDT", "BNB/USDT", "SOL/USDT", "XRP/USDT",
            "ADA/USDT", "DOGE/USDT", "MATIC/USDT", "DOT/USDT", "AVAX/USDT",
            "SHIB/USDT", "LTC/USDT", "UNI/USDT", "LINK/USDT", "ATOM/USDT",
            "XLM/USDT", "ALGO/USDT", "VET/USDT", "ICP/USDT", "FIL/USDT",
            # Commodities
            "XAU/USDT",  # Gold (AltÄ±n)
            "XAG/USDT",  # Silver (GÃ¼mÃ¼ÅŸ)
            "XCU/USDT",  # Copper (BakÄ±r)
            "XPD/USDT"   # Palladium (Paladyum)
        ]
        try:
            base_list = [safe_str(s).strip().upper().replace("-", "/").replace("_", "/") for s in (syms or [])]
            seen = set(base_list)
            for s in extra:
                if s not in seen:
                    base_list.append(s)
                    seen.add(s)
            syms = base_list
        except Exception:
            pass

        data = dict(data) if isinstance(data, dict) else {}
        data[ex] = syms
        _SYMBOLS_CACHE["data"] = data
        _SYMBOLS_CACHE["ts"] = _now()
        return syms
    except Exception:
        if isinstance(data, dict) and ex in data and data[ex]:
            return data[ex]
        return POPULAR_USDT

# =========================
# Symbols API (AUTO & MANUAL)
# =========================

# =========================
# Open Positions helpers (FIX: Pozisyonlar yÃ¼klenemedi)
# =========================

def list_positions(username: str) -> List[Dict[str, Any]]:
    """AÃ§Ä±k pozisyonlarÄ± DB'den getirir. Hata olursa [] dÃ¶ner (UI Ã§Ã¶kmesin)."""
    conn = db()
    try:
        cur = conn.execute(
            "SELECT id, exchange_id, symbol, qty, entry_price, entry_usdt, buy_fee_usdt, dry_run, created_at "
            "FROM open_positions WHERE username=? ORDER BY id DESC LIMIT 50",
            (username,),
        )
        out: List[Dict[str, Any]] = []
        for r in cur.fetchall():
            out.append(
                {
                    "id": int(r[0]),
                    "exchange_id": safe_str(r[1]),
                    "symbol": safe_str(r[2]),
                    "qty": float(r[3] or 0.0),
                    "entry_price": float(r[4] or 0.0),
                    "entry_usdt": float(r[5] or 0.0),
                    "buy_fee_usdt": float(r[6] or 0.0),
                    "dry_run": int(r[7] or 0),
                    "created_at": safe_str(r[8]),
                }
            )
        return out
    except Exception:
        return []

def get_market_price(exchange: str, symbol: str) -> float:
    """
    AnlÄ±k fiyat. UI Ã§Ã¶kmesin diye her ÅŸey try/except.
    Tercihen sendeki public fiyat fonksiyonunu kullanÄ±r.
    """
    try:
        ex = (exchange or "").strip().upper()
        sym = (symbol or "").strip().upper()

        # Sende varsa bunu kullan (en doÄŸru yer)
        if "get_public_price" in globals():
            p = get_public_price(ex, sym)
            return float(p or 0.0)

        # Alternatif isimler (varsa)
        if "public_price" in globals():
            p = public_price(ex, sym)
            return float(p or 0.0)

        return 0.0
    except Exception:
        return 0.0



@app.get("/api/positions")
def api_positions():
    rr = require_login()
    if rr:
        return rr

    username = session.get("username") or ""
    raw = list_positions(username) or []

    # AynÄ± coin'den birden fazla satÄ±rÄ± TEK satÄ±rda gÃ¶ster (stack)
    # Not: KullanÄ±cÄ± isteÄŸi gereÄŸi aynÄ± symbol farklÄ± dry/ex olsa bile tekleÅŸtiriyoruz.
    groups: Dict[str, Dict[str, Any]] = {}

    for p in raw:
        if p is not None and not isinstance(p, dict):
            try:
                p = dict(p)
            except Exception:
                continue
        if not p:
            continue

        ex = safe_str(p.get("exchange_id") or DEFAULT_EXCHANGE).strip().upper() or "OKX"
        sym = safe_str(p.get("symbol") or "").strip().upper()
        if not sym:
            continue
        # normalize
        sym = sym.replace("-", "/").replace("_", "/")
        if "USDT" in sym and "/" not in sym and sym.endswith("USDT") and len(sym) > 4:
            sym = sym[:-4] + "/USDT"

        # tekleme anahtarÄ±: symbol
        gid = sym

        qty = _to_float(p.get("qty"), 0.0)
        entry_price = _to_float(p.get("entry_price"), 0.0)
        entry_usdt = _to_float(p.get("entry_usdt"), 0.0)

        g = groups.get(gid)
        if not g:
            g = {
                # UI SELL butonu iÃ§in temsilci id (en kÃ¼Ã§Ã¼k id)
                "id": int(p.get("id") or 0),
                # aynÄ± sembol altÄ±nda toplanan id'ler
                "group_ids": [],
                "exchange_id": ex,
                "symbol": sym,
                # bilgisel: grupta LIVE ve DRY karÄ±ÅŸÄ±rsa LIVE gÃ¶rÃ¼nÃ¼r (server tarafÄ±nda iÅŸlem zaten doÄŸru modda)
                "dry_run": int(_to_int(p.get("dry_run"), 0)),
                "qty": 0.0,
                "entry_price": 0.0,
                "entry_usdt": 0.0,
                "created_at": int(p.get("created_at") or 0),
            }
            groups[gid] = g

        pid = int(p.get("id") or 0)
        g["group_ids"].append(pid)

        # qty + yatÄ±rÄ±m topla
        g["qty"] += qty
        g["entry_usdt"] += entry_usdt

        # weighted avg entry price (qty aÄŸÄ±rlÄ±klÄ±)
        if qty > 0 and entry_price > 0:
            prev_qty = max(_to_float(g.get("qty"), 0.0) - qty, 0.0)
            prev_avg = _to_float(g.get("entry_price"), 0.0)
            if prev_qty <= 0:
                g["entry_price"] = entry_price
            else:
                g["entry_price"] = (prev_avg * prev_qty + entry_price * qty) / (prev_qty + qty)

        # temsilci kayÄ±t: en kÃ¼Ã§Ã¼k id + en eski created_at
        try:
            g["created_at"] = min(int(g.get("created_at") or 0), int(p.get("created_at") or 0))
        except Exception:
            pass
        try:
            g["id"] = min(int(g.get("id") or 0), pid)
        except Exception:
            pass

        # dry_run karÄ±ÅŸÄ±rsa LIVE Ã¶ncelikli gÃ¶ster
        try:
            if int(_to_int(p.get("dry_run"), 0)) == 0:
                g["dry_run"] = 0
        except Exception:
            pass

    out = list(groups.values())

    # canlÄ± fiyat + pnl: API her refresh'te "â€”" gÃ¶stermesin diye server tarafÄ±nda dolduruyoruz
    for g in out:
        ex = safe_str(g.get("exchange_id") or DEFAULT_EXCHANGE).strip().upper()
        sym = safe_str(g.get("symbol") or "").strip().upper()
        qty = _to_float(g.get("qty"), 0.0)
        entry_price = _to_float(g.get("entry_price"), 0.0)

        cur = 0.0
        try:
            cur = float(public_price(ex, sym) or 0.0)
        except Exception:
            cur = 0.0

        if cur <= 0:
            g["current_price"] = None
            g["pnl_usdt"] = None
        else:
            g["current_price"] = cur
            if qty > 0 and entry_price > 0:
                g["pnl_usdt"] = (cur - entry_price) * qty
            else:
                g["pnl_usdt"] = 0.0

    # newest first
    out.sort(key=lambda x: int(x.get("created_at") or 0), reverse=True)
    return jsonify({"ok": True, "positions": out})

@app.get("/api/symbols")
def api_symbols():
    rr = require_login()
    if rr:
        return rr

    ex = safe_str(request.args.get("exchange", "")).strip().upper()
    if ex not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
        ex = "OKX"

    try:
        syms = get_symbols_for_exchange(ex) or []
    except Exception:
        syms = []

    syms = [safe_str(s).strip().upper() for s in syms if s]
    return jsonify({"ok": True, "exchange": ex, "symbols": syms})

# =========================
# AUTO RULES DB HELPERS
# =========================
def auto_list(username: str) -> List[Dict[str, Any]]:
    username = safe_str(username).strip()
    conn = db()
    try:
        rows = conn.execute("""
            SELECT id, username, exchange_id, symbol, usdt, enabled, created_at
            FROM auto_rules
            WHERE username=?
            ORDER BY id DESC
        """, (username,)).fetchall()
        return [dict(r) for r in rows]
    finally:
        conn.close()

def auto_upsert_rule(username: str, exchange_id: str, symbol: str, usdt: float, enabled: int) -> None:
    username = safe_str(username).strip()
    exchange_id = safe_str(exchange_id).strip().upper()
    symbol = safe_str(symbol).strip().upper()
    usdt = float(usdt or 0.0)
    enabled = 1 if int(enabled) == 1 else 0

    conn = db()
    try:
        row = conn.execute("""
            SELECT id FROM auto_rules
            WHERE username=? AND exchange_id=? AND UPPER(symbol)=?
            LIMIT 1
        """, (username, exchange_id, symbol)).fetchone()

        if row:
            conn.execute("""
                UPDATE auto_rules
                SET usdt=?, enabled=?, created_at=?
                WHERE id=?
            """, (usdt, enabled, now_ts(), int(row["id"])))
        else:
            conn.execute("""
                INSERT INTO auto_rules (username, exchange_id, symbol, usdt, enabled, created_at)
                VALUES (?,?,?,?,?,?)
            """, (username, exchange_id, symbol, usdt, enabled, now_ts()))

        conn.commit()
    finally:
        conn.close()

def auto_toggle_id(username: str, rid: int, enabled: int) -> None:
    conn = db()
    try:
        conn.execute("UPDATE auto_rules SET enabled=? WHERE id=? AND username=?", (enabled, rid, username))
        conn.commit()
    finally:
        conn.close()

def auto_delete_id(username: str, rid: int) -> None:
    conn = db()
    try:
        conn.execute("DELETE FROM auto_rules WHERE id=? AND username=?", (rid, username))
        conn.commit()
    finally:
        conn.close()


def auto_update_id(username: str, rid: int, usdt: float) -> None:
    conn = db()
    try:
        conn.execute("UPDATE auto_rules SET usdt=? WHERE id=? AND username=?", (float(usdt), rid, username))
        conn.commit()
    finally:
        conn.close()

def auto_get_enabled_match(username: str, exchange_id: str, symbol: str) -> Optional[Dict[str, Any]]:
    username = safe_str(username).strip()
    exchange_id = safe_str(exchange_id).strip().upper()
    sym_can = canon_symbol(symbol)

    # Variants so BTCUSDT / BTC-USDT / BTC/USDT all match the same rule
    sym_slashless = sym_can.replace("/", "")
    sym_dash = sym_can.replace("/", "-")

    conn = db()
    try:
        row = conn.execute("""
            SELECT * FROM auto_rules
            WHERE username=? AND exchange_id=? AND enabled=1
              AND (UPPER(symbol)=? OR UPPER(symbol)=? OR UPPER(symbol)=?)
            ORDER BY id DESC
            LIMIT 1
        """, (username, exchange_id, sym_can, sym_slashless, sym_dash)).fetchone()
        if not row:
            return None
        return dict(row)
    finally:
        conn.close()


    conn = db()
    try:
        row = conn.execute("""
            SELECT * FROM auto_rules
            WHERE username=? AND exchange_id=? AND UPPER(symbol)=? AND enabled=1
            ORDER BY id DESC
            LIMIT 1
        """, (username, exchange_id, symbol)).fetchone()
        return dict(row) if row else None
    finally:
        conn.close()

# =========================
# Telegram
# =========================
def telegram_send_to(chat_id: str, text: str) -> None:
    if not TELEGRAM_TOKEN:
        return
    cid = safe_str(chat_id)
    if not cid:
        return
    if not safe_str(text):
        # boÅŸ text yollamayÄ± deneme
        return
    
    # Grup mesajÄ± tamamen kapalÄ±
    try:
        if TELEGRAM_GROUP_ID and cid == safe_str(TELEGRAM_GROUP_ID):
            try:
                log_line("telegram", "INFO", f"Group messaging disabled, blocked chat_id={cid}")
            except Exception:
                pass
            return
    except Exception:
        pass

    try:
        import requests
        url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        payload = {"chat_id": cid, "text": text}

        # EÄŸer hedef grup ise ve topic/thread id varsa ekle
        try:
            group_id = safe_str(globals().get("TELEGRAM_GROUP_ID", "") or "")
            thread_id = safe_str(globals().get("TELEGRAM_GROUP_THREAD_ID", "") or "")
            if group_id and thread_id and cid == group_id:
                payload["message_thread_id"] = int(thread_id)
        except Exception:
            pass

        r = requests.post(url, json=payload, timeout=20)

        # Telegram hata dÃ¶nerse loga yaz (en kritik kÄ±sÄ±m)
        try:
            if not r.ok:
                log_line("telegram", "WARN", f"Telegram send failed chat_id={cid} status={r.status_code} resp={r.text[:200]}")
        except Exception:
            pass

    except Exception as e:
        try:
            log_line("telegram", "WARN", f"Telegram exception chat_id={cid} err={e}")
        except Exception:
            pass
        return





def telegram_send_for_user(u, text: str) -> None:
    """
    BUY/SELL bildirimleri SADECE kullanÄ±cÄ± DM.
    Gruba ASLA gÃ¶ndermez.
    KullanÄ±cÄ± chat id yoksa fallback'e (admin'e) BUY/SELL gÃ¶ndermez; sadece log yazar.
    """
    # token yoksa net log
    if not TELEGRAM_TOKEN:
        try:
            uname = safe_str(u.get("username")) if isinstance(u, dict) else safe_str(getattr(u, "username", ""))
            log_line(uname or "telegram", "WARN", "Telegram token yok (TELEGRAM_BOT_TOKEN boÅŸ)")
        except Exception:
            pass
        return

    # kullanÄ±cÄ± chat id
    try:
        user_chat = safe_str(u.get("telegram_chat_id") if isinstance(u, dict) else getattr(u, "telegram_chat_id", ""))
    except Exception:
        user_chat = ""

    uname = ""
    try:
        uname = safe_str(u.get("username")) if isinstance(u, dict) else safe_str(getattr(u, "username", ""))
    except Exception:
        uname = ""

    if not user_chat:
        # kullanÄ±cÄ± botu baÅŸlatmamÄ±ÅŸ / chat id kayÄ±tlÄ± deÄŸil -> BUY/SELL DM YOK
        # ama sebebi log'a net yaz
        try:
            log_line(uname or "telegram", "WARN", f"{E_WARN} Telegram DM gÃ¶nderilemedi: kullanÄ±cÄ± telegram_chat_id boÅŸ (bot /start gerekli)")
        except Exception:
            pass
        return

    # SADECE kullanÄ±cÄ±ya DM
    telegram_send_to(user_chat, safe_str(text))





def build_telegram_text(action: str, u, symbol: str, requested_usdt: float, dry_run: bool,
                        extra: Dict[str, Any]) -> str:
    # Titles: EXACT
    title = f"{E_ON} BUY ALERT" if action.upper() == "BUY" else f"{E_OFF} SELL ALERT"
    ex_name = safe_str(u.get("exchange_id") if isinstance(u, dict) else u["exchange_id"]).upper() or DEFAULT_EXCHANGE
    parts: List[str] = [
        title,
        f"{E_USER} {user_display_name(u)}",
        f"{E_BANK} Borsa: {ex_name}",
        f"{E_CHART} {symbol}",
        f"{E_TST} Mod: {'DRY RUN' if dry_run else 'LIVE'}",
        f"{E_MNY} Ä°stek: {requested_usdt:.2f} USDT",
        f"{E_TIME} Zaman: {iso_now_local()}",
    ]
    if action.upper() == "SELL":
    # NET PnL Ã¶ncelikli (fee dahil)
        net_pnl = float(extra.get("net_pnl_usdt", extra.get("pnl_usdt", 0.0)) or 0.0)

    # Fee satÄ±rÄ± (toplam fee USDT) â€“ yoksa 0 yazar
        fee_total = float(extra.get("fee_usdt_total", extra.get("fee_usdt", 0.0)) or 0.0)

    # TL dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (net pnl Ã¼zerinden)
        net_try = float(extra.get("net_pnl_try", extra.get("pnl_try", (net_pnl * USDT_TRY_RATE))) or 0.0)

    # PnL (Net)
        if abs(net_pnl) < 0.01:
            parts.append(f"{E_UP} PnL (Net): {net_pnl:.6f} USDT")
        else:
            parts.append(f"{E_UP} PnL (Net): {net_pnl:.4f} USDT")

    # Fee ayrÄ± satÄ±r
        if abs(fee_total) < 0.01:
            parts.append(f"{E_MNY} Fee: {fee_total:.6f} USDT")
        else:
            parts.append(f"{E_MNY} Fee: {fee_total:.4f} USDT")

    # TL net
        parts.append(f"{E_MNY} {net_try:+.2f} TL".replace(",", "."))


    status = safe_str(extra.get("status"))
    if status:
        parts.append(status)
    return "\n".join(parts)

def build_fail_text(action: str, u, symbol: str, requested_usdt: float, dry_run: bool, reason: str) -> str:
    title = f"{E_ON} BUY ALERT" if action.upper() == "BUY" else f"{E_OFF} SELL ALERT"
    ex_name = safe_str(u.get("exchange_id") if isinstance(u, dict) else u["exchange_id"]).upper() or DEFAULT_EXCHANGE
    parts = [
        title,
        f"{E_USER} {user_display_name(u)}",
        f"{E_BANK} Borsa: {ex_name}",
        f"{E_CHART} {symbol}",
        f"{E_TST} Mod: {'DRY RUN' if dry_run else 'LIVE'}",
        f"{E_MNY} Ä°stek: {requested_usdt:.2f} USDT",
        f"{E_TIME} Zaman: {iso_now_local()}",
        f"{E_STOP} Emir baÅŸarÄ±sÄ±z: {safe_str(reason) or 'Bilinmeyen hata'}",
    ]
    return "\n".join(parts)

# =========================
# DB init and migrations
# =========================
def _ensure_column(conn: sqlite3.Connection, table: str, col: str, ddl_fragment: str) -> None:
    cols = [r["name"] for r in conn.execute(f"PRAGMA table_info({table})").fetchall()]
    if col in cols:
        return
    conn.execute(f"ALTER TABLE {table} ADD COLUMN {col} {ddl_fragment}")


def ensure_paper_test_schema(conn):
    # Safe to call repeatedly.
    cur = conn.cursor()

    cur.execute("""
        CREATE TABLE IF NOT EXISTS paper_test_state (
            username TEXT PRIMARY KEY,
            start_usdt REAL NOT NULL DEFAULT 0.0,
            usdt REAL NOT NULL DEFAULT 0.0,
            last_reset_ts TEXT,
            created_ts TEXT,
            updated_ts TEXT
        )
    """)
    _ensure_column(cur, "paper_test_state", "start_usdt", "REAL NOT NULL DEFAULT 0.0")
    _ensure_column(cur, "paper_test_state", "usdt", "REAL NOT NULL DEFAULT 0.0")
    _ensure_column(cur, "paper_test_state", "last_reset_ts", "TEXT")
    _ensure_column(cur, "paper_test_state", "created_ts", "TEXT")
    _ensure_column(cur, "paper_test_state", "updated_ts", "TEXT")

    cur.execute("""
        CREATE TABLE IF NOT EXISTS paper_test_positions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT NOT NULL,
            exchange TEXT NOT NULL,
            symbol TEXT NOT NULL,
            qty REAL NOT NULL DEFAULT 0.0,
            entry_px REAL NOT NULL DEFAULT 0.0,
            entry_ts TEXT,
            invested_usdt REAL NOT NULL DEFAULT 0.0,
            fee_buy REAL NOT NULL DEFAULT 0.0,
            fee_sell REAL NOT NULL DEFAULT 0.0,
            status TEXT NOT NULL DEFAULT 'OPEN'
        )
    """)
    _ensure_column(cur, "paper_test_positions", "username", "TEXT NOT NULL")
    _ensure_column(cur, "paper_test_positions", "exchange", "TEXT NOT NULL")
    _ensure_column(cur, "paper_test_positions", "symbol", "TEXT NOT NULL")
    _ensure_column(cur, "paper_test_positions", "qty", "REAL NOT NULL DEFAULT 0.0")
    _ensure_column(cur, "paper_test_positions", "entry_px", "REAL NOT NULL DEFAULT 0.0")
    _ensure_column(cur, "paper_test_positions", "entry_ts", "TEXT")
    _ensure_column(cur, "paper_test_positions", "invested_usdt", "REAL NOT NULL DEFAULT 0.0")
    _ensure_column(cur, "paper_test_positions", "fee_buy", "REAL NOT NULL DEFAULT 0.0")
    _ensure_column(cur, "paper_test_positions", "fee_sell", "REAL NOT NULL DEFAULT 0.0")
    _ensure_column(cur, "paper_test_positions", "status", "TEXT NOT NULL DEFAULT 'OPEN'")

    cur.execute("""
        CREATE TABLE IF NOT EXISTS paper_test_trades (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT NOT NULL,
            exchange TEXT NOT NULL,
            symbol TEXT NOT NULL,
            entry_px REAL NOT NULL DEFAULT 0.0,
            exit_px REAL NOT NULL DEFAULT 0.0,
            qty REAL NOT NULL DEFAULT 0.0,
            invested_usdt REAL NOT NULL DEFAULT 0.0,
            received_usdt REAL NOT NULL DEFAULT 0.0,
            fee_buy REAL NOT NULL DEFAULT 0.0,
            fee_sell REAL NOT NULL DEFAULT 0.0,
            pnl_net_usdt REAL NOT NULL DEFAULT 0.0,
            pnl_pct REAL NOT NULL DEFAULT 0.0,
            ts_open TEXT,
            ts_close TEXT
        )
    """)
    for col, spec in [
        ("username", "TEXT NOT NULL"),
        ("exchange", "TEXT NOT NULL"),
        ("symbol", "TEXT NOT NULL"),
        ("entry_px", "REAL NOT NULL DEFAULT 0.0"),
        ("exit_px", "REAL NOT NULL DEFAULT 0.0"),
        ("qty", "REAL NOT NULL DEFAULT 0.0"),
        ("invested_usdt", "REAL NOT NULL DEFAULT 0.0"),
        ("received_usdt", "REAL NOT NULL DEFAULT 0.0"),
        ("fee_buy", "REAL NOT NULL DEFAULT 0.0"),
        ("fee_sell", "REAL NOT NULL DEFAULT 0.0"),
        ("pnl_net_usdt", "REAL NOT NULL DEFAULT 0.0"),
        ("pnl_pct", "REAL NOT NULL DEFAULT 0.0"),
        ("opened_at", "INTEGER"),
        ("closed_at", "INTEGER"),
        ("ts_open", "TEXT"),
        ("ts_close", "TEXT"),
    ]:
        _ensure_column(cur, "paper_test_trades", col, spec)

    try:
        cur.execute("CREATE INDEX IF NOT EXISTS idx_paper_pos_user ON paper_test_positions(username)")
        cur.execute("CREATE INDEX IF NOT EXISTS idx_paper_pos_user_sym ON paper_test_positions(username, symbol)")
        cur.execute("CREATE INDEX IF NOT EXISTS idx_paper_tr_user ON paper_test_trades(username)")
        cur.execute("CREATE INDEX IF NOT EXISTS idx_paper_tr_user_ts ON paper_test_trades(username, ts_close)")
    except Exception:
        pass

def _table_columns(conn, table: str):
    try:
        cur = conn.execute(f"PRAGMA table_info({table})")
        return [r[1] for r in cur.fetchall()]
    except Exception:
        return []

def _ensure_column(conn, table: str, col: str, ddl: str, fill_from_rowid: bool = False):
    cols = _table_columns(conn, table)
    if col in cols:
        return
    try:
        conn.execute(f"ALTER TABLE {table} ADD COLUMN {ddl}")
        conn.commit()
        if fill_from_rowid and col == "id":
            try:
                conn.execute(f"UPDATE {table} SET id = rowid WHERE id IS NULL")
                conn.commit()
            except Exception:
                pass
    except Exception:
        # table might not exist yet, or sqlite might reject certain alters
        pass

def migrate_db(conn):
    """
    Best-effort migrations to keep older DBs working.
    We never drop columns/tables. We only add missing columns and backfill ids.
    """
    # Ensure common tables exist (if init_db didn't create due to early return)
    try:
        conn.execute("CREATE TABLE IF NOT EXISTS settings (key TEXT PRIMARY KEY, value TEXT)")
        conn.commit()
    except Exception:
        pass

    # Users: older DBs might miss id or plan columns
    _ensure_column(conn, "users", "id", "id INTEGER", fill_from_rowid=True)
    _ensure_column(conn, "users", "subscription_plan", "subscription_plan TEXT DEFAULT 'Temel'")
    _ensure_column(conn, "users", "usage_count", "usage_count INTEGER DEFAULT 0")
    _ensure_column(conn, "users", "usage_limit", "usage_limit INTEGER DEFAULT 300")
    _ensure_column(conn, "users", "account_mode", "account_mode TEXT DEFAULT 'demo'")
    _ensure_column(conn, "users", "webhook_secret", "webhook_secret TEXT")
    _ensure_column(conn, "users", "is_vip", "is_vip INTEGER DEFAULT 0")

    # Auto trades
    _ensure_column(conn, "auto_trades", "id", "id INTEGER", fill_from_rowid=True)
    _ensure_column(conn, "auto_trades", "enabled", "enabled INTEGER DEFAULT 1")

    # Trades (history)
    _ensure_column(conn, "trades", "id", "id INTEGER", fill_from_rowid=True)
    _ensure_column(conn, "trades", "mode", "mode TEXT DEFAULT 'demo'")

    # Chat messages schema
    _ensure_column(conn, "chat_messages", "id", "id INTEGER", fill_from_rowid=True)
    _ensure_column(conn, "chat_messages", "room", "room TEXT")
    _ensure_column(conn, "chat_messages", "user_id", "user_id TEXT")
    _ensure_column(conn, "chat_messages", "username", "username TEXT")
    _ensure_column(conn, "chat_messages", "message", "message TEXT")
    _ensure_column(conn, "chat_messages", "created_at", "created_at TEXT")
    _ensure_column(conn, "chat_messages", "is_signal", "is_signal INTEGER DEFAULT 0")
    _ensure_column(conn, "chat_messages", "message_type", "message_type TEXT DEFAULT 'text'")

    # Exchange API config
    try:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS exchange_api (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id TEXT,
                exchange TEXT,
                api_key TEXT,
                api_secret TEXT,
                passphrase TEXT,
                mode TEXT DEFAULT 'test',
                created_at TEXT
            )
        """)
        conn.commit()
    except Exception:
        pass

    # One-time reset of sample/demo data if requested and not done yet
    try:
        cur = conn.execute("SELECT value FROM settings WHERE key='reset_done'")
        row = cur.fetchone()
        reset_done = (row and row[0] == "1")
    except Exception:
        reset_done = False

    if not reset_done and os.environ.get("AUTO_RESET_ONCE", "1") == "1":
        # Reset once after deploy so UI starts clean
        try:
            for t in ["trades", "demo_trades", "portfolio_snapshots", "pnl_reports"]:
                conn.execute(f"DELETE FROM {t}")
            conn.execute("DELETE FROM chat_messages")
            conn.execute("INSERT OR REPLACE INTO settings(key,value) VALUES('reset_done','1')")
            conn.commit()
        except Exception:
            pass


def init_db() -> None:
    conn = db()
    cur = conn.cursor()

    # Global settings (admin-only)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS app_settings (
        key TEXT PRIMARY KEY,
        value TEXT NOT NULL DEFAULT '',
        updated_at INTEGER NOT NULL DEFAULT 0
    )
    """)
    try:
        cur.execute(
            "INSERT OR IGNORE INTO app_settings(key,value,updated_at) VALUES (?,?,?)",
            ("AUTO_MODE", safe_str(os.getenv("AUTO_MODE", "NORMAL")).upper() or "NORMAL", now_ts()),
        )
    except Exception:
        pass


    cur.execute("""
    CREATE TABLE IF NOT EXISTS users (
        username TEXT PRIMARY KEY,
        display_name TEXT NOT NULL DEFAULT '',
        salt TEXT NOT NULL,
        password_hash TEXT NOT NULL,
        is_admin INTEGER NOT NULL DEFAULT 0,

        trade_enabled INTEGER NOT NULL DEFAULT 1,
        disable_on_limit INTEGER NOT NULL DEFAULT 1,

        exchange_id TEXT NOT NULL DEFAULT 'OKX',
        webhook_secret TEXT NOT NULL DEFAULT '',

        package_name TEXT NOT NULL DEFAULT 'Basic',
        package_limit INTEGER NOT NULL DEFAULT 300,
        package_months INTEGER NOT NULL DEFAULT 1,
        expires_at INTEGER NOT NULL DEFAULT 0,

        total_pnl REAL NOT NULL DEFAULT 0.0,
        created_at INTEGER NOT NULL DEFAULT 0,
        
        -- API keys for OKX (ana borsa)
        api_key TEXT NOT NULL DEFAULT '',
        api_secret TEXT NOT NULL DEFAULT '',
        api_passphrase TEXT NOT NULL DEFAULT '',
        
        -- Telegram
        telegram_chat_id TEXT NOT NULL DEFAULT '',
        
        -- Risk limits
        daily_loss_limit_usdt REAL NOT NULL DEFAULT 0.0,
        force_dry_run INTEGER NOT NULL DEFAULT 0,
        trial_real_enabled INTEGER NOT NULL DEFAULT 0,
        trial_expires_at INTEGER NOT NULL DEFAULT 0,
        
        -- Multi-exchange API keys
        binance_api_key TEXT NOT NULL DEFAULT '',
        binance_api_secret TEXT NOT NULL DEFAULT '',
        bybit_api_key TEXT NOT NULL DEFAULT '',
        bybit_api_secret TEXT NOT NULL DEFAULT '',
        gate_api_key TEXT NOT NULL DEFAULT '',
        gate_api_secret TEXT NOT NULL DEFAULT '',
        
        -- Demo/Real balances
        demo_balance REAL NOT NULL DEFAULT 10000.0,
        real_balance REAL NOT NULL DEFAULT 0.0
    )
    """)

    # ---- Contract columns (safe ALTER) ----
    try:
        cur.execute("ALTER TABLE users ADD COLUMN contract_accepted_at INTEGER NOT NULL DEFAULT 0")
    except Exception:
        pass
    try:
        cur.execute("ALTER TABLE users ADD COLUMN contract_full_name TEXT NOT NULL DEFAULT ''")
    except Exception:
        pass
    try:
        cur.execute("ALTER TABLE users ADD COLUMN contract_tc TEXT NOT NULL DEFAULT ''")
    except Exception:
        pass
    try:
        cur.execute("ALTER TABLE users ADD COLUMN contract_ip TEXT NOT NULL DEFAULT ''")
    except Exception:
        pass

    # ---- API Key columns (safe ALTER for existing DBs) ----
    for col, typedef in [
        ("api_key", "TEXT NOT NULL DEFAULT ''"),
        ("api_secret", "TEXT NOT NULL DEFAULT ''"),
        ("api_passphrase", "TEXT NOT NULL DEFAULT ''"),
        ("telegram_chat_id", "TEXT NOT NULL DEFAULT ''"),
        ("daily_loss_limit_usdt", "REAL NOT NULL DEFAULT 0.0"),
        ("force_dry_run", "INTEGER NOT NULL DEFAULT 0"),
        ("trial_real_enabled", "INTEGER NOT NULL DEFAULT 0"),
        ("trial_expires_at", "INTEGER NOT NULL DEFAULT 0"),
        ("binance_api_key", "TEXT NOT NULL DEFAULT ''"),
        ("binance_api_secret", "TEXT NOT NULL DEFAULT ''"),
        ("bybit_api_key", "TEXT NOT NULL DEFAULT ''"),
        ("bybit_api_secret", "TEXT NOT NULL DEFAULT ''"),
        ("gate_api_key", "TEXT NOT NULL DEFAULT ''"),
        ("gate_api_secret", "TEXT NOT NULL DEFAULT ''"),
        ("demo_balance", "REAL NOT NULL DEFAULT 10000.0"),
        ("real_balance", "REAL NOT NULL DEFAULT 0.0"),
    ]:
        try:
            cur.execute(f"ALTER TABLE users ADD COLUMN {col} {typedef}")
        except Exception:
            pass

    # ---- Take Profit (safe ALTER) ----
    try:
        cur.execute("ALTER TABLE users ADD COLUMN tp_pct REAL NOT NULL DEFAULT 0.005")
    except Exception:
        pass

    # Contract records (admin list + download + delete)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS contracts (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        full_name TEXT NOT NULL DEFAULT '',
        tc TEXT NOT NULL DEFAULT '',
        ip TEXT NOT NULL DEFAULT '',
        accepted_at INTEGER NOT NULL DEFAULT 0,
        version TEXT NOT NULL DEFAULT '',
        body TEXT NOT NULL DEFAULT ''
    )
    """)

    # Chat messages (simple polling) with room support
    cur.execute("""
    CREATE TABLE IF NOT EXISTS chat_messages (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        message TEXT NOT NULL,
        created_at INTEGER NOT NULL DEFAULT 0
    )
    """)
    # Add room column for chat rooms
    try:
        cur.execute("ALTER TABLE chat_messages ADD COLUMN room TEXT NOT NULL DEFAULT 'genel'")
    except Exception:
        pass

    # Real trades table (for REAL BOT)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS real_trades (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        exchange_id TEXT NOT NULL DEFAULT 'OKX',
        action TEXT NOT NULL,
        symbol TEXT NOT NULL,
        qty REAL NOT NULL DEFAULT 0.0,
        price REAL NOT NULL DEFAULT 0.0,
        usdt REAL NOT NULL DEFAULT 0.0,
        pnl REAL NOT NULL DEFAULT 0.0,
        fee REAL NOT NULL DEFAULT 0.0,
        order_id TEXT NOT NULL DEFAULT '',
        created_at INTEGER NOT NULL DEFAULT 0
    )
    """)

    # Education modules (admin editable)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS education_modules (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        slug TEXT NOT NULL UNIQUE,
        content TEXT NOT NULL DEFAULT '',
        category TEXT NOT NULL DEFAULT 'temel',
        sort_order INTEGER NOT NULL DEFAULT 0,
        is_active INTEGER NOT NULL DEFAULT 1,
        created_at INTEGER NOT NULL DEFAULT 0,
        updated_at INTEGER NOT NULL DEFAULT 0
    )
    """)

    # Webhooks table (for external integrations)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS webhooks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        url TEXT NOT NULL,
        event_type TEXT NOT NULL DEFAULT 'trade',
        is_active INTEGER NOT NULL DEFAULT 1,
        created_at INTEGER NOT NULL DEFAULT 0,
        updated_at INTEGER NOT NULL DEFAULT 0
    )
    """)


    cur.execute("""
    CREATE TABLE IF NOT EXISTS usage (
        username TEXT PRIMARY KEY,
        used_count INTEGER NOT NULL DEFAULT 0,
        updated_at INTEGER NOT NULL DEFAULT 0
    )
    """)

    cur.execute("""
    CREATE TABLE IF NOT EXISTS pending_signals (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        action TEXT NOT NULL,
        symbol TEXT NOT NULL,
        requested_usdt REAL NOT NULL DEFAULT 0.0,
        payload_json TEXT NOT NULL DEFAULT '{}',
        dry_run INTEGER NOT NULL DEFAULT 1,
        created_at INTEGER NOT NULL DEFAULT 0,
        status TEXT NOT NULL DEFAULT 'PENDING'
    )
    """)

    cur.execute("""
    CREATE TABLE IF NOT EXISTS logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        level TEXT NOT NULL,
        message TEXT NOT NULL,
        created_at INTEGER NOT NULL DEFAULT 0
    )
    """)

    cur.execute("""
    CREATE TABLE IF NOT EXISTS trades (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        exchange_id TEXT NOT NULL,
        action TEXT NOT NULL,
        symbol TEXT NOT NULL,
        real_usdt REAL NOT NULL DEFAULT 0.0,
        pnl_usdt REAL NOT NULL DEFAULT 0.0,
        dry_run INTEGER NOT NULL DEFAULT 1,
        created_at INTEGER NOT NULL DEFAULT 0
    )
    """)

    # AÃ§Ä±k pozisyonlar (Manuel/Auto BUY sonrasÄ± burada kalÄ±r; panelden SELL'e alÄ±rsÄ±n)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS open_positions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        exchange_id TEXT NOT NULL,
        symbol TEXT NOT NULL,
        qty REAL NOT NULL DEFAULT 0.0,
        entry_price REAL NOT NULL DEFAULT 0.0,
        entry_usdt REAL NOT NULL DEFAULT 0.0,
        dry_run INTEGER NOT NULL DEFAULT 1,
        created_at INTEGER NOT NULL DEFAULT 0
    )
    """)

    
    # ---- open_positions fee/order columns (safe ALTER) ----
    # Eski DB'lerde bu kolonlar yoksa otomatik ekler (PNL ve Telegram fee iÃ§in)
    for _sql in [
        "ALTER TABLE open_positions ADD COLUMN buy_fee_usdt REAL NOT NULL DEFAULT 0.0",
        "ALTER TABLE open_positions ADD COLUMN buy_fee_coin REAL NOT NULL DEFAULT 0.0",
        "ALTER TABLE open_positions ADD COLUMN buy_fee_coin_ccy TEXT NOT NULL DEFAULT ''",
        "ALTER TABLE open_positions ADD COLUMN buy_ord_id TEXT NOT NULL DEFAULT ''",
        "ALTER TABLE open_positions ADD COLUMN sell_fee_usdt REAL NOT NULL DEFAULT 0.0",
        "ALTER TABLE open_positions ADD COLUMN sell_fee_coin REAL NOT NULL DEFAULT 0.0",
        "ALTER TABLE open_positions ADD COLUMN sell_fee_coin_ccy TEXT NOT NULL DEFAULT ''",
        "ALTER TABLE open_positions ADD COLUMN sell_ord_id TEXT NOT NULL DEFAULT ''",
    ]:
        try:
            cur.execute(_sql)
        except Exception:
            pass

    cur.execute("""
    CREATE TABLE IF NOT EXISTS auto_rules (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        exchange_id TEXT NOT NULL,
        symbol TEXT NOT NULL,
        usdt REAL NOT NULL DEFAULT 0.0,
        enabled INTEGER NOT NULL DEFAULT 1,
        created_at INTEGER NOT NULL DEFAULT 0
    )
    """)
    
    # Auto positions table (TradingView webhook + AI trading)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS auto_positions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        username TEXT NOT NULL DEFAULT '',
        coin TEXT NOT NULL DEFAULT '',
        amount_usdt REAL DEFAULT 10,
        target_pct REAL DEFAULT 0.0,
        status TEXT DEFAULT 'waiting',
        mode TEXT DEFAULT 'demo',
        created_at TEXT,
        entry_price REAL DEFAULT 0.0,
        current_price REAL DEFAULT 0.0,
        pnl REAL DEFAULT 0.0,
        entry_at TEXT DEFAULT '',
        exit_at TEXT DEFAULT '',
        exchange_id TEXT NOT NULL DEFAULT 'OKX'
    )
    """)
    # Auto positions safe ALTER for existing columns
    for _auto_col_sql in [
        "ALTER TABLE auto_positions ADD COLUMN target_pct REAL DEFAULT 0.0",
        "ALTER TABLE auto_positions ADD COLUMN entry_price REAL DEFAULT 0.0",
        "ALTER TABLE auto_positions ADD COLUMN current_price REAL DEFAULT 0.0",
        "ALTER TABLE auto_positions ADD COLUMN pnl REAL DEFAULT 0.0",
        "ALTER TABLE auto_positions ADD COLUMN entry_at TEXT DEFAULT ''",
        "ALTER TABLE auto_positions ADD COLUMN exit_at TEXT DEFAULT ''",
        "ALTER TABLE auto_positions ADD COLUMN username TEXT NOT NULL DEFAULT ''",
        "ALTER TABLE auto_positions ADD COLUMN exchange_id TEXT NOT NULL DEFAULT 'OKX'",
    ]:
        try:
            cur.execute(_auto_col_sql)
        except Exception:
            pass

    
    ensure_paper_test_schema(conn)
    conn.commit()

    # OKX (zorunlu) alanlarÄ±: mevcut kolonlar
    _ensure_column(conn, "users", "api_key", "TEXT NOT NULL DEFAULT ''")
    _ensure_column(conn, "users", "api_secret", "TEXT NOT NULL DEFAULT ''")
    _ensure_column(conn, "users", "api_passphrase", "TEXT NOT NULL DEFAULT ''")

    # Telegram
    _ensure_column(conn, "users", "telegram_chat_id", "TEXT NOT NULL DEFAULT ''")

    # Daily loss limit (user-defined, USDT). 0 = kapalÄ±
    _ensure_column(conn, "users", "daily_loss_limit_usdt", "REAL NOT NULL DEFAULT 0.0")
    _ensure_column(conn, "users", "force_dry_run", "INTEGER NOT NULL DEFAULT 0")
    _ensure_column(conn, "users", "trial_real_enabled", "INTEGER NOT NULL DEFAULT 0")
    _ensure_column(conn, "users", "trial_expires_at", "INTEGER NOT NULL DEFAULT 0")



    # 3 borsa ayrÄ± alanlar (opsiyonel)
    _ensure_column(conn, "users", "binance_api_key", "TEXT NOT NULL DEFAULT ''")
    _ensure_column(conn, "users", "binance_api_secret", "TEXT NOT NULL DEFAULT ''")
    _ensure_column(conn, "users", "bybit_api_key", "TEXT NOT NULL DEFAULT ''")
    _ensure_column(conn, "users", "bybit_api_secret", "TEXT NOT NULL DEFAULT ''")
    _ensure_column(conn, "users", "gate_api_key", "TEXT NOT NULL DEFAULT ''")
    _ensure_column(conn, "users", "gate_api_secret", "TEXT NOT NULL DEFAULT ''")

    conn.commit()

    row = conn.execute("SELECT username FROM users WHERE username='admin'").fetchone()
    if not row:
        salt = secrets.token_hex(16)
        pw = "admin"
        conn.execute("""
            INSERT INTO users
            (username, display_name, salt, password_hash, is_admin,
             trade_enabled, disable_on_limit, exchange_id, webhook_secret,
             package_name, package_limit, package_months, expires_at,
             api_key, api_secret, api_passphrase, telegram_chat_id,
             binance_api_key, binance_api_secret,
             bybit_api_key, bybit_api_secret,
             gate_api_key, gate_api_secret,
             total_pnl, created_at)
            VALUES (?,?,?,?,1, 1,1, ?,?, ?,?,?, ?, '', '', '', '', '', '', '', '', '', '', 0.0, ?)
        """, (
            "admin", "Admin", salt, hash_password(pw, salt),
            DEFAULT_EXCHANGE, "",
            "Ultra", -1, 12, now_ts() + 3650 * 24 * 3600,
            now_ts()
        ))
        conn.execute(
            "INSERT OR IGNORE INTO usage (username, used_count, updated_at) VALUES (?,0,?)",
            ("admin", now_ts())
        )
        conn.commit()


    # =========================
    # Paper Test (SimÃ¼lasyon) tablolarÄ±
    # =========================
    cur.execute("""
    CREATE TABLE IF NOT EXISTS paper_test_state (
        username TEXT PRIMARY KEY,
        usdt REAL NOT NULL DEFAULT 0.0,
        pnl REAL NOT NULL DEFAULT 0.0,
        fee REAL NOT NULL DEFAULT 0.0,
        last_px REAL NOT NULL DEFAULT 0.0,
        updated_at INTEGER NOT NULL DEFAULT 0
    )
    """)

    # Åema migrasyonu: Eski kurulumlarda paper_test_state farklÄ± kolonlarla oluÅŸmuÅŸ olabilir.
    # Bu blok eksik kolonlarÄ± idempotent ÅŸekilde ekler (CREATE TABLE mevcut tabloyu deÄŸiÅŸtirmez).
    try:
        curx = conn.cursor()
        cols = {r[1] for r in curx.execute("PRAGMA table_info(paper_test_state)").fetchall()}
        need = {
            "usdt": "REAL NOT NULL DEFAULT 0.0",
            "pnl": "REAL NOT NULL DEFAULT 0.0",
            "fee": "REAL NOT NULL DEFAULT 0.0",
            "last_px": "REAL NOT NULL DEFAULT 0.0",
            "updated_at": "INTEGER NOT NULL DEFAULT 0",
        }
        for c, ddl in need.items():
            if c not in cols:
                curx.execute(f"ALTER TABLE paper_test_state ADD COLUMN {c} {ddl}")
        conn.commit()
    except Exception:
        # Migrasyon baÅŸarÄ±sÄ±z olsa bile test sayfasÄ± Ã§Ã¶kmesin (sonraki Ã§aÄŸrÄ±da tekrar dener)
        pass
    cur.execute("""
    CREATE TABLE IF NOT EXISTS paper_test_positions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        exchange_id TEXT NOT NULL,
        symbol TEXT NOT NULL,
        qty REAL NOT NULL DEFAULT 0.0,
        entry_price REAL NOT NULL DEFAULT 0.0,
        entry_usdt REAL NOT NULL DEFAULT 0.0,
        buy_fee_usdt REAL NOT NULL DEFAULT 0.0,
        opened_at INTEGER NOT NULL DEFAULT 0
    )
    """)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS paper_test_trades (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        exchange_id TEXT NOT NULL,
        symbol TEXT NOT NULL,
        entry_price REAL NOT NULL,
        exit_price REAL NOT NULL,
        qty REAL NOT NULL,
        invested_usdt REAL NOT NULL,
        received_usdt REAL NOT NULL,
        fee_total_usdt REAL NOT NULL,
        pnl_net_usdt REAL NOT NULL,
        opened_at INTEGER NOT NULL,
        closed_at INTEGER NOT NULL
    )
    """)

    # paper_test_trades kolon migrasyonu (eski DB'lerde eksik kolon olabilir)
    try:
        curx.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='paper_test_trades'").fetchone()
        cols = [r[1] for r in curx.execute("PRAGMA table_info(paper_test_trades)").fetchall()]
        def _add_col(col_sql):
            try:
                curx.execute(col_sql)
            except Exception:
                pass
        if "opened_at" not in cols:
            _add_col("ALTER TABLE paper_test_trades ADD COLUMN opened_at INTEGER NOT NULL DEFAULT 0")
        if "closed_at" not in cols:
            _add_col("ALTER TABLE paper_test_trades ADD COLUMN closed_at INTEGER NOT NULL DEFAULT 0")
        if "invested_usdt" not in cols:
            _add_col("ALTER TABLE paper_test_trades ADD COLUMN invested_usdt REAL NOT NULL DEFAULT 0.0")
        if "received_usdt" not in cols:
            _add_col("ALTER TABLE paper_test_trades ADD COLUMN received_usdt REAL NOT NULL DEFAULT 0.0")
        if "fee_total_usdt" not in cols:
            _add_col("ALTER TABLE paper_test_trades ADD COLUMN fee_total_usdt REAL NOT NULL DEFAULT 0.0")
        if "pnl_net_usdt" not in cols:
            _add_col("ALTER TABLE paper_test_trades ADD COLUMN pnl_net_usdt REAL NOT NULL DEFAULT 0.0")
    except Exception:
        pass

    cur.execute("""
    CREATE TABLE IF NOT EXISTS paper_test_autorules (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        exchange_id TEXT NOT NULL,
        symbol TEXT NOT NULL,
        usdt_amount REAL NOT NULL DEFAULT 0.0,
        use_all_balance INTEGER NOT NULL DEFAULT 0,
        enabled INTEGER NOT NULL DEFAULT 1,
        created_at INTEGER NOT NULL DEFAULT 0
    )
    """)
    conn.commit()
    migrate_db(conn)
    conn.close()


# =========================
# Paper Test helpers
# =========================
def _get_usdt_try_rate() -> float:
    try:
        r = requests.get("https://api.binance.com/api/v3/ticker/price", params={"symbol":"USDTTRY"}, timeout=4)
        j = r.json()
        return float(j.get("price") or 0.0)
    except Exception:
        return 0.0

def paper_test_ensure_state(username: str) -> dict:
    """Ensure paper test state exists; default balance = 100.000 TL / USDTTRY.
    Defensive: accept dict/user row and coerce to string username.
    """
    # username bazen yanlÄ±ÅŸlÄ±kla dict gelebiliyor (Ã¶rn: get_user sonucu). GÃ¼venli hale getir.
    if isinstance(username, dict):
        username = safe_str(username.get("username") or "")
    else:
        username = safe_str(username or "")
    conn = db()

    # Åema migrasyonu: Eski kurulumlarda paper_test_state farklÄ± kolonlarla oluÅŸmuÅŸ olabilir.
    # Bu blok eksik kolonlarÄ± idempotent ÅŸekilde ekler (CREATE TABLE mevcut tabloyu deÄŸiÅŸtirmez).
    try:
        curx = conn.cursor()
        cols = {r[1] for r in curx.execute("PRAGMA table_info(paper_test_state)").fetchall()}
        need = {
            "usdt": "REAL NOT NULL DEFAULT 0.0",
            "pnl": "REAL NOT NULL DEFAULT 0.0",
            "fee": "REAL NOT NULL DEFAULT 0.0",
            "last_px": "REAL NOT NULL DEFAULT 0.0",
            "updated_at": "INTEGER NOT NULL DEFAULT 0",
        }
        for c, ddl in need.items():
            if c not in cols:
                curx.execute(f"ALTER TABLE paper_test_state ADD COLUMN {c} {ddl}")
        conn.commit()
    except Exception:
        # Migrasyon baÅŸarÄ±sÄ±z olsa bile test sayfasÄ± Ã§Ã¶kmesin (sonraki Ã§aÄŸrÄ±da tekrar dener)
        pass
    try:
        row = conn.execute("SELECT * FROM paper_test_state WHERE username=? LIMIT 1", (username,)).fetchone()
        if row:
            return dict(row)
        usdt_try = _get_usdt_try_rate() or 40.0
        start_usdt = round(100000.0 / max(usdt_try, 0.0001), 2)
        conn.execute(
            "INSERT INTO paper_test_state(username, usdt, pnl, fee, last_px, updated_at) VALUES (?,?,?,?,?,?)",
            (username, start_usdt, 0.0, 0.0, 0.0, now_ts()),
        )
        conn.commit()
        return dict(conn.execute("SELECT * FROM paper_test_state WHERE username=? LIMIT 1", (username,)).fetchone())
    finally:
        conn.close()

def paper_test_reset(username: str) -> dict:
    conn = db()
    try:
        conn.execute("DELETE FROM paper_test_positions WHERE username=?", (username,))
        conn.execute("DELETE FROM paper_test_trades WHERE username=?", (username,))
        conn.execute("DELETE FROM paper_test_autorules WHERE username=?", (username,))
        usdt_try = _get_usdt_try_rate() or 40.0
        start_usdt = round(100000.0 / max(usdt_try, 0.0001), 2)
        conn.execute(
            "INSERT INTO paper_test_state(username, usdt, pnl, fee, last_px, updated_at) VALUES (?,?,?,?,?,?) "
            "ON CONFLICT(username) DO UPDATE SET usdt=excluded.usdt, pnl=0.0, fee=0.0, last_px=0.0, updated_at=excluded.updated_at",
            (username, start_usdt, 0.0, 0.0, 0.0, now_ts()),
        )
        conn.commit()
        return dict(conn.execute("SELECT * FROM paper_test_state WHERE username=? LIMIT 1", (username,)).fetchone())
    finally:
        conn.close()

def paper_test_list_positions(username: str) -> List[dict]:
    conn = db()
    try:
        rows = conn.execute(
            "SELECT * FROM paper_test_positions WHERE username=? ORDER BY opened_at DESC, id DESC",
            (username,),
        ).fetchall()
        return [dict(r) for r in rows]
    finally:
        conn.close()

def paper_test_list_trades(username: str, limit: int = 50) -> List[dict]:
    conn = db()
    try:
        rows = conn.execute(
            "SELECT * FROM paper_test_trades WHERE username=? ORDER BY closed_at DESC, id DESC LIMIT ?",
            (username, int(limit)),
        ).fetchall()
        return [dict(r) for r in rows]
    finally:
        conn.close()

def paper_test_list_autorules(username: str) -> List[dict]:
    conn = db()
    try:
        rows = conn.execute(
            "SELECT * FROM paper_test_autorules WHERE username=? ORDER BY id DESC",
            (username,),
        ).fetchall()
        return [dict(r) for r in rows]
    finally:
        conn.close()

# =========================
# Execution stubs per exchange
# =========================
def _require_keys_for_exchange(exchange_id: str, api_key: str, api_secret: str, api_passphrase: str) -> Optional[str]:
    ex = exchange_id.upper()

    # ---- Safety: strip API credentials (trailing spaces cause OKX Invalid Sign) ----
    api_key = safe_str(api_key).strip()
    api_secret = safe_str(api_secret).strip()
    api_passphrase = safe_str(api_passphrase).strip()
    if ex == "OKX":
        if not api_key or not api_secret or not api_passphrase:
            return "OKX API bilgileri eksik"
        return None
    if ex in ("BINANCE", "BYBIT", "GATEIO"):
        if not api_key or not api_secret:
            return f"{ex} API bilgileri eksik"
        return None
    return "Borsa seÃ§imi geÃ§ersiz"

def place_order(exchange_id: str, action: str, symbol: str, usdt_amount: float, dry_run: bool,
                api_key: str, api_secret: str, api_passphrase: str) -> Dict[str, Any]:
    """
    Unified spot MARKET order wrapper.
    Returns:
      ok, fill_price, fill_qty, real_usdt, fee_usdt, fee_coin, fee_coin_ccy, ord_id
    Notes:
      - BUY: usdt_amount is QUOTE amount (USDT)
      - SELL: usdt_amount is BASE qty (sell all)
    """
    import requests

    # ---- Safety: normalize numeric inputs ----
    usdt_amount = _to_float(usdt_amount, 0.0)
    action = (action or "").upper().strip()
    symbol = (symbol or "").upper().strip()
    ex = (exchange_id or "").upper().strip()

    # ---- Safety: strip API credentials ----
    api_key = safe_str(api_key).strip()
    api_secret = safe_str(api_secret).strip()
    api_passphrase = safe_str(api_passphrase).strip()

    # Global PANIC: block any order placement
    try:
        if is_global_panic():
            return {"ok": False, "reason": "PANIC aktif"}
    except Exception:
        pass

    if usdt_amount <= 0:
        return {"ok": False, "reason": "Miktar sÄ±fÄ±r"}

    def _fee_to_usdt(ccy: str, amt: float, px_hint: float = 0.0) -> float:
        c = safe_str(ccy).upper()
        a = abs(_to_float(amt, 0.0))
        if a <= 0:
            return 0.0
        if c in ("USDT", "USD"):
            return a
        # if fee coin is base coin, convert with fill price hint
        try:
            base_ccy = _base_ccy_from_symbol(symbol).upper()
            if base_ccy and c == base_ccy and px_hint > 0:
                return a * float(px_hint)
        except Exception:
            pass
        # try public price for fee coin
        try:
            px = _to_float(get_public_price(ex, f"{c}/USDT"), 0.0)
            if px > 0:
                return a * px
        except Exception:
            pass
        return 0.0

    # =========================
    # DRY RUN
    # =========================
    if dry_run:
        fill_price = _to_float(get_public_price(ex, symbol), 0.0)
        if fill_price <= 0:
            fill_price = 100.0
        if action == "BUY":
            fill_qty = usdt_amount / fill_price if fill_price > 0 else 0.0
            return {
                "ok": True,
                "fill_price": fill_price,
                "fill_qty": fill_qty,
                "real_usdt": usdt_amount,
                "fee_usdt": 0.0,
                "fee_coin": 0.0,
                "fee_coin_ccy": "",
                "ord_id": "",
            }
        else:
            fill_qty = usdt_amount
            real_usdt = fill_qty * fill_price if (fill_qty > 0 and fill_price > 0) else 0.0
            return {
                "ok": True,
                "fill_price": fill_price,
                "fill_qty": fill_qty,
                "real_usdt": real_usdt,
                "fee_usdt": 0.0,
                "fee_coin": 0.0,
                "fee_coin_ccy": "",
                "ord_id": "",
            }

    # =========================
    # LIVE ORDERS
    # =========================
    try:
        if ex == "OKX":
            inst_id = symbol.replace("/", "-").replace("_", "-").upper()

            base_url = os.getenv("OKX_BASE_URL", "https://www.okx.com")
            path = "/api/v5/trade/order"
            url = base_url.rstrip("/") + path

            body_obj: Dict[str, Any] = {
                "instId": inst_id,
                "tdMode": "cash",
                "side": "buy" if action == "BUY" else "sell",
                "ordType": "market",
            }

            if action == "BUY":
                body_obj["tgtCcy"] = "quote_ccy"
                body_obj["sz"] = f"{usdt_amount:.8f}".rstrip("0").rstrip(".")
            else:
                body_obj["sz"] = f"{usdt_amount:.8f}".rstrip("0").rstrip(".")

            body_json = json.dumps(body_obj, separators=(",", ":"), ensure_ascii=False)

            from datetime import datetime as dt_cls
            ts = dt_cls.now(timezone.utc).isoformat(timespec="milliseconds").replace("+00:00", "Z")
            prehash = ts + "POST" + path + body_json
            sign = base64.b64encode(hmac.new(api_secret.encode(), prehash.encode(), hashlib.sha256).digest()).decode()

            headers = {
                "OK-ACCESS-KEY": api_key,
                "OK-ACCESS-SIGN": sign,
                "OK-ACCESS-TIMESTAMP": ts,
                "OK-ACCESS-PASSPHRASE": api_passphrase,
                "Content-Type": "application/json",
            }


            # --- Balance snapshot (OKX) ---
            base_ccy = ""
            try:
                if "/" in symbol:
                    base_ccy = symbol.split("/")[0].strip().upper()
                elif "-" in inst_id:
                    base_ccy = inst_id.split("-")[0].strip().upper()
            except Exception:
                base_ccy = ""
            bal_before_usdt = okx_get_asset_balance("USDT", api_key, api_secret, api_passphrase)
            bal_before_base = okx_get_asset_balance(base_ccy, api_key, api_secret, api_passphrase) if base_ccy else 0.0

            r = requests.post(url, headers=headers, data=body_json.encode("utf-8"), timeout=15)
            j = r.json() if r is not None else {}
            if safe_str((j or {}).get("code")) != "0":
                return {"ok": False, "reason": safe_str((j or {}).get("msg") or "OKX emir hatasÄ±"), "raw": j}

            ord_id = ""
            try:
                ord_id = safe_str(((j or {}).get("data") or [{}])[0].get("ordId") or "")
            except Exception:
                ord_id = ""

            # Fill + fee
            fill_price = 0.0
            fill_qty = 0.0
            real_usdt = 0.0
            fee_usdt = 0.0
            fee_coin = 0.0
            fee_coin_ccy = ""

            if ord_id:
                try:
                    fills_url = base_url.rstrip("/") + "/api/v5/trade/fills"
                    params = {"ordId": ord_id, "instId": inst_id, "limit": "1"}
                    qs = "&".join([f"{k}={v}" for k, v in params.items()])
                    path2 = "/api/v5/trade/fills"
                    ts2 = dt_cls.now(timezone.utc).isoformat(timespec="milliseconds").replace("+00:00", "Z")
                    prehash2 = ts2 + "GET" + path2 + "?" + qs
                    sign2 = base64.b64encode(hmac.new(api_secret.encode(), prehash2.encode(), hashlib.sha256).digest()).decode()
                    headers2 = dict(headers)
                    headers2["OK-ACCESS-SIGN"] = sign2
                    headers2["OK-ACCESS-TIMESTAMP"] = ts2

                    rr = requests.get(fills_url + "?" + qs, headers=headers2, timeout=15)
                    fj = rr.json() if rr is not None else {}
                    if safe_str((fj or {}).get("code")) == "0":
                        d = (fj or {}).get("data") or []
                        if d:
                            last = d[0]
                            fill_price = _to_float(last.get("fillPx"), 0.0)
                            fill_qty = _to_float(last.get("fillSz"), 0.0)
                            real_usdt = _to_float(last.get("fillNotional"), 0.0)

                            _fee = abs(_to_float(last.get("fee"), 0.0))
                            _fee_ccy = safe_str(last.get("feeCcy") or "").upper()
                            if _fee > 0 and _fee_ccy:
                                if _fee_ccy in ("USDT", "USD"):
                                    fee_usdt = _fee
                                else:
                                    fee_coin = _fee
                                    fee_coin_ccy = _fee_ccy
                except Exception:
                    pass

            if fill_price <= 0:
                fill_price = _to_float(get_public_price(ex, symbol), 0.0)
            if fill_price <= 0:
                fill_price = 100.0

            if action == "BUY":
                if fill_qty <= 0:
                    fill_qty = usdt_amount / fill_price if fill_price > 0 else 0.0
                if real_usdt <= 0:
                    real_usdt = usdt_amount
            else:
                if fill_qty <= 0:
                    fill_qty = usdt_amount
                if real_usdt <= 0:
                    real_usdt = fill_qty * fill_price

            # If fee is coin, keep it; Telegram will convert using fill_price/px

            # --- Balance-delta fee fix (OKX) ---
            try:
                bal_after_usdt = okx_get_asset_balance("USDT", api_key, api_secret, api_passphrase)
                bal_after_base = okx_get_asset_balance(base_ccy, api_key, api_secret, api_passphrase) if base_ccy else 0.0

                if action == "BUY":
                    # Notional spent (excludes fee)
                    notional = _to_float(real_usdt, 0.0)
                    usdt_delta = max(0.0, _to_float(bal_before_usdt, 0.0) - _to_float(bal_after_usdt, 0.0))
                    fee_usdt_delta = max(0.0, usdt_delta - notional)

                    base_delta = max(0.0, _to_float(bal_after_base, 0.0) - _to_float(bal_before_base, 0.0))
                    fee_coin_delta = max(0.0, _to_float(fill_qty, 0.0) - base_delta)

                    # If API returns 0 fee, use delta-derived values
                    if fee_usdt_delta > 0 and _to_float(fee_usdt, 0.0) <= 0:
                        fee_usdt = fee_usdt_delta
                    if fee_coin_delta > 0 and _to_float(fee_coin, 0.0) <= 0 and base_ccy:
                        fee_coin = fee_coin_delta
                        fee_coin_ccy = base_ccy

                else:  # SELL
                    gross = _to_float(real_usdt, 0.0)  # fill_qty * fill_price
                    net_usdt_gain = max(0.0, _to_float(bal_after_usdt, 0.0) - _to_float(bal_before_usdt, 0.0))
                    fee_usdt_delta = max(0.0, gross - net_usdt_gain)

                    base_spent = max(0.0, _to_float(bal_before_base, 0.0) - _to_float(bal_after_base, 0.0))
                    fee_coin_delta = max(0.0, base_spent - _to_float(fill_qty, 0.0))

                    if fee_usdt_delta > 0 and _to_float(fee_usdt, 0.0) <= 0:
                        fee_usdt = fee_usdt_delta
                    if fee_coin_delta > 0 and _to_float(fee_coin, 0.0) <= 0 and base_ccy:
                        fee_coin = fee_coin_delta
                        fee_coin_ccy = base_ccy
            except Exception:
                pass
            return {
                "ok": True,
                "fill_price": fill_price,
                "fill_qty": fill_qty,
                "real_usdt": real_usdt,
                "fee_usdt": fee_usdt,
                "fee_coin": fee_coin,
                "fee_coin_ccy": fee_coin_ccy,
                "ord_id": ord_id,
                "raw": j,
            }

        # -------------------------
        # BINANCE
        # -------------------------
        elif ex == "BINANCE":
            import urllib.parse
            base = "https://api.binance.com"
            sym = _sym_norm_for_price("BINANCE", symbol).replace("/", "")
            ts = int(time.time() * 1000)
            recv = 5000

            if action == "BUY":
                params = {
                    "symbol": sym,
                    "side": "BUY",
                    "type": "MARKET",
                    "quoteOrderQty": f"{usdt_amount:.8f}".rstrip("0").rstrip("."),
                    "recvWindow": str(recv),
                    "timestamp": str(ts),
                }
            else:
                params = {
                    "symbol": sym,
                    "side": "SELL",
                    "type": "MARKET",
                    "quantity": f"{usdt_amount:.8f}".rstrip("0").rstrip("."),
                    "recvWindow": str(recv),
                    "timestamp": str(ts),
                }

            qs = urllib.parse.urlencode(params)
            sig = hmac.new(api_secret.encode(), qs.encode(), hashlib.sha256).hexdigest()
            url = f"{base}/api/v3/order?{qs}&signature={sig}"
            headers = {"X-MBX-APIKEY": api_key}
            r = requests.post(url, headers=headers, timeout=15)
            j = r.json() if r is not None else {}

            if "code" in j and int(j.get("code") or 0) != 0:
                return {"ok": False, "reason": safe_str(j.get("msg") or "Binance emir hatasÄ±"), "raw": j}

            ord_id = safe_str(j.get("orderId") or "")

            executed_qty = _to_float(j.get("executedQty"), 0.0)
            cquote = _to_float(j.get("cummulativeQuoteQty"), 0.0)
            fill_price = (cquote / executed_qty) if executed_qty > 0 and cquote > 0 else _to_float(get_public_price(ex, symbol), 0.0)

            # Fee from fills (commission + commissionAsset)
            fee_usdt = 0.0
            fee_coin = 0.0
            fee_coin_ccy = ""
            fills = j.get("fills") or []
            fee_total_usdt = 0.0
            fee_coin_amt = 0.0
            fee_coin_asset = ""
            for f in fills:
                com = abs(_to_float(f.get("commission"), 0.0))
                asset = safe_str(f.get("commissionAsset") or "").upper()
                if com <= 0 or not asset:
                    continue
                # try convert to USDT
                usd = _fee_to_usdt(asset, com, fill_price)
                if usd > 0:
                    fee_total_usdt += usd
                else:
                    # keep last non-usdt fee as coin
                    fee_coin_amt += com
                    fee_coin_asset = asset

            if fee_total_usdt > 0:
                fee_usdt = fee_total_usdt
            elif fee_coin_amt > 0:
                fee_coin = fee_coin_amt
                fee_coin_ccy = fee_coin_asset

            real_usdt = cquote if cquote > 0 else (executed_qty * fill_price if fill_price > 0 else 0.0)
            return {
                "ok": True,
                "fill_price": fill_price,
                "fill_qty": executed_qty if executed_qty > 0 else (usdt_amount / fill_price if action == "BUY" and fill_price > 0 else usdt_amount),
                "real_usdt": real_usdt if real_usdt > 0 else usdt_amount,
                "fee_usdt": fee_usdt,
                "fee_coin": fee_coin,
                "fee_coin_ccy": fee_coin_ccy,
                "ord_id": ord_id,
                "raw": j,
            }

        # -------------------------
        # BYBIT (v5 spot)
        # -------------------------
        elif ex == "BYBIT":
            base = "https://api.bybit.com"
            recv = "5000"
            ts = str(int(time.time() * 1000))
            sym = _sym_norm_for_price("BYBIT", symbol).replace("/", "")

            path = "/v5/order/create"
            url = f"{base}{path}"

            if action == "BUY":
                body_obj = {
                    "category": "spot",
                    "symbol": sym,
                    "side": "Buy",
                    "orderType": "Market",
                    "qty": str(usdt_amount),
                    "marketUnit": "quoteCoin",
                }
            else:
                body_obj = {
                    "category": "spot",
                    "symbol": sym,
                    "side": "Sell",
                    "orderType": "Market",
                    "qty": str(usdt_amount),
                    "marketUnit": "baseCoin",
                }

            body = json.dumps(body_obj, separators=(",", ":"), ensure_ascii=False)
            prehash = ts + api_key + recv + body
            sign = hmac.new(api_secret.encode(), prehash.encode(), hashlib.sha256).hexdigest()
            headers = {
                "Content-Type": "application/json",
                "X-BAPI-API-KEY": api_key,
                "X-BAPI-TIMESTAMP": ts,
                "X-BAPI-RECV-WINDOW": recv,
                "X-BAPI-SIGN": sign,
            }
            r = requests.post(url, headers=headers, data=body.encode("utf-8"), timeout=15)
            j = r.json() if r is not None else {}

            if int(_to_float(j.get("retCode"), 0.0)) != 0:
                return {"ok": False, "reason": safe_str(j.get("retMsg") or "Bybit emir hatasÄ±"), "raw": j}

            ord_id = safe_str(((j.get("result") or {}).get("orderId")) or "")
            # Fetch executions to get avg/fees
            fill_price = 0.0
            fill_qty = 0.0
            real_usdt = 0.0
            fee_usdt = 0.0
            fee_coin = 0.0
            fee_coin_ccy = ""

            try:
                time.sleep(0.25)
                path2 = "/v5/execution/list"
                qs = f"category=spot&orderId={ord_id}&symbol={sym}&limit=50"
                ts2 = str(int(time.time() * 1000))
                prehash2 = ts2 + api_key + recv + qs
                sign2 = hmac.new(api_secret.encode(), prehash2.encode(), hashlib.sha256).hexdigest()
                url2 = f"{base}{path2}?{qs}"
                headers2 = {
                    "X-BAPI-API-KEY": api_key,
                    "X-BAPI-TIMESTAMP": ts2,
                    "X-BAPI-RECV-WINDOW": recv,
                    "X-BAPI-SIGN": sign2,
                }
                rr = requests.get(url2, headers=headers2, timeout=15)
                ej = rr.json() if rr is not None else {}
                if int(_to_float(ej.get("retCode"), 0.0)) == 0:
                    lst = (((ej.get("result") or {}).get("list")) or [])
                    notional = 0.0
                    qty_sum = 0.0
                    fee_sum_usdt = 0.0
                    fee_coin_sum = 0.0
                    fee_coin_asset = ""
                    for e in lst:
                        px = _to_float(e.get("execPrice"), 0.0)
                        q = _to_float(e.get("execQty"), 0.0)
                        v = _to_float(e.get("execValue"), 0.0)
                        notional += v
                        qty_sum += q
                        f = abs(_to_float(e.get("execFee"), 0.0))
                        fc = safe_str(e.get("feeCurrency") or "").upper()
                        if f > 0 and fc:
                            usd = _fee_to_usdt(fc, f, px)
                            if usd > 0:
                                fee_sum_usdt += usd
                            else:
                                fee_coin_sum += f
                                fee_coin_asset = fc
                    fill_qty = qty_sum
                    real_usdt = notional if notional > 0 else 0.0
                    fill_price = (notional / qty_sum) if qty_sum > 0 and notional > 0 else 0.0
                    if fee_sum_usdt > 0:
                        fee_usdt = fee_sum_usdt
                    elif fee_coin_sum > 0:
                        fee_coin = fee_coin_sum
                        fee_coin_ccy = fee_coin_asset
            except Exception:
                pass

            if fill_price <= 0:
                fill_price = _to_float(get_public_price(ex, symbol), 0.0)
            if fill_price <= 0:
                fill_price = 100.0

            if action == "BUY":
                if fill_qty <= 0:
                    fill_qty = usdt_amount / fill_price if fill_price > 0 else 0.0
                if real_usdt <= 0:
                    real_usdt = usdt_amount
            else:
                if fill_qty <= 0:
                    fill_qty = usdt_amount
                if real_usdt <= 0:
                    real_usdt = fill_qty * fill_price

            return {
                "ok": True,
                "fill_price": fill_price,
                "fill_qty": fill_qty,
                "real_usdt": real_usdt,
                "fee_usdt": fee_usdt,
                "fee_coin": fee_coin,
                "fee_coin_ccy": fee_coin_ccy,
                "ord_id": ord_id,
                "raw": j,
            }

        # -------------------------
        # GATE.IO (v4 spot)
        # -------------------------
        elif ex in ("GATE", "GATEIO", "GATE.IO"):
            base = "https://api.gateio.ws"
            path = "/api/v4/spot/orders"
            url = f"{base}{path}"

            # Gate spot market: amount is quote for buy, base for sell
            pair = _sym_norm_for_price("GATE", symbol).replace("/", "_")
            body_obj = {
                "currency_pair": pair,
                "side": "buy" if action == "BUY" else "sell",
                "type": "market",
                "amount": f"{usdt_amount:.8f}".rstrip("0").rstrip("."),
            }
            body = json.dumps(body_obj, separators=(",", ":"), ensure_ascii=False)

            ts = str(int(time.time()))
            body_hash = hashlib.sha512(body.encode()).hexdigest()
            prehash = "POST" + "\n" + path + "\n" + "" + "\n" + body_hash + "\n" + ts
            sign = hmac.new(api_secret.encode(), prehash.encode(), hashlib.sha512).hexdigest()
            headers = {"KEY": api_key, "Timestamp": ts, "SIGN": sign, "Content-Type": "application/json"}

            r = requests.post(url, headers=headers, data=body.encode("utf-8"), timeout=15)
            j = r.json() if r is not None else {}

            if isinstance(j, dict) and j.get("message") and j.get("label"):
                return {"ok": False, "reason": safe_str(j.get("message")), "raw": j}

            ord_id = safe_str(j.get("id") or "")

            fill_qty = _to_float(j.get("amount"), 0.0)
            # Gate returns filled_total for total quote (USDT)
            real_usdt = _to_float(j.get("filled_total"), 0.0)
            fill_price = (real_usdt / fill_qty) if fill_qty > 0 and real_usdt > 0 else _to_float(get_public_price(ex, symbol), 0.0)

            fee_amt = abs(_to_float(j.get("fee"), 0.0))
            fee_ccy = safe_str(j.get("fee_currency") or "").upper()
            fee_usdt = 0.0
            fee_coin = 0.0
            fee_coin_ccy = ""

            if fee_amt > 0 and fee_ccy:
                usd = _fee_to_usdt(fee_ccy, fee_amt, fill_price)
                if usd > 0:
                    fee_usdt = usd
                else:
                    fee_coin = fee_amt
                    fee_coin_ccy = fee_ccy

            # If Gate didn't include fee in create response, fetch order detail
            if fee_amt <= 0 and ord_id:
                try:
                    time.sleep(0.2)
                    path2 = f"/api/v4/spot/orders/{ord_id}"
                    url2 = f"{base}{path2}"
                    ts2 = str(int(time.time()))
                    prehash2 = "GET" + "\n" + path2 + "\n" + "" + "\n" + hashlib.sha512("".encode()).hexdigest() + "\n" + ts2
                    sign2 = hmac.new(api_secret.encode(), prehash2.encode(), hashlib.sha512).hexdigest()
                    headers2 = {"KEY": api_key, "Timestamp": ts2, "SIGN": sign2}
                    rr = requests.get(url2, headers=headers2, timeout=15)
                    oj = rr.json() if rr is not None else {}
                    fee_amt2 = abs(_to_float(oj.get("fee"), 0.0))
                    fee_ccy2 = safe_str(oj.get("fee_currency") or "").upper()
                    if fee_amt2 > 0 and fee_ccy2:
                        usd = _fee_to_usdt(fee_ccy2, fee_amt2, fill_price)
                        if usd > 0:
                            fee_usdt = usd
                            fee_coin = 0.0
                            fee_coin_ccy = ""
                        else:
                            fee_coin = fee_amt2
                            fee_coin_ccy = fee_ccy2
                except Exception:
                    pass

            return {
                "ok": True,
                "fill_price": fill_price,
                "fill_qty": fill_qty if fill_qty > 0 else (usdt_amount / fill_price if action == "BUY" and fill_price > 0 else usdt_amount),
                "real_usdt": real_usdt if real_usdt > 0 else usdt_amount,
                "fee_usdt": fee_usdt,
                "fee_coin": fee_coin,
                "fee_coin_ccy": fee_coin_ccy,
                "ord_id": ord_id,
                "raw": j,
            }

        return {"ok": False, "reason": f"Desteklenmeyen borsa: {ex}"}

    except Exception as e:
        return {"ok": False, "reason": f"Emir hatasÄ±: {e}"}

def record_trade(username: str, exchange_id: str, action: str, symbol: str,
                 real_usdt: float, pnl_usdt: float, dry_run: bool) -> None:
    conn = db()
    try:
        conn.execute("""
            INSERT INTO trades (username, exchange_id, action, symbol, real_usdt, pnl_usdt, dry_run, created_at)
            VALUES (?,?,?,?,?,?,?,?)
        """, (username, exchange_id.upper(), action.upper(), symbol.upper(),
              float(real_usdt), float(pnl_usdt), 1 if dry_run else 0, now_ts()))
        conn.commit()
    finally:
        conn.close()

def add_user_pnl(username: str, pnl: float) -> None:
    conn = db()
    try:
        conn.execute("UPDATE users SET total_pnl = total_pnl + ? WHERE username=?",
                     (float(pnl), username))
        conn.commit()
    finally:
        conn.close()

# =========================
# Stats
# =========================
def _window_start_ts(kind: str) -> int:
    now_local = datetime.utcnow() + timedelta(hours=TZ_OFFSET_HOURS)
    if kind == "day":
        start = now_local.replace(hour=0, minute=0, second=0, microsecond=0)
    elif kind == "week":
        start = (now_local - timedelta(days=now_local.weekday())).replace(hour=0, minute=0, second=0, microsecond=0)
    else:
        start = now_local.replace(day=1, hour=0, minute=0, second=0, microsecond=0)
    start_utc = start - timedelta(hours=TZ_OFFSET_HOURS)
    return int(start_utc.timestamp())

def stats_for_user(username: str, kind: str) -> Dict[str, Any]:
    start_ts = _window_start_ts(kind)
    conn = db()
    try:
        rows = conn.execute("""
            SELECT COUNT(1) AS c,
                   COALESCE(SUM(pnl_usdt), 0.0) AS pnl,
                   COALESCE(SUM(ABS(real_usdt)), 0.0) AS vol
            FROM trades
            WHERE username=? AND created_at>=? AND dry_run=0
        """, (username, start_ts)).fetchone()
        c = int(rows["c"] or 0)
        pnl_usdt = float(rows["pnl"] or 0.0)
        vol_usdt = float(rows["vol"] or 0.0)
    finally:
        conn.close()

    pnl_try = pnl_usdt * USDT_TRY_RATE
    pct = (pnl_usdt / vol_usdt * 100.0) if vol_usdt > 0 else 0.0
    return {"count": c, "pnl_usdt": pnl_usdt, "pnl_try": pnl_try, "pct": pct}

# =========================
# UI (CSS ASLA DEÄÄ°ÅTÄ°RÄ°LMEDÄ°)
# =========================
BASE_CSS = """
:root{
  --bg:#0b1220;
  --text:#e9eefb;
  --muted:#9fb0d3;
  --line:rgba(255,255,255,.10);

    # Chat schema migrations
    try:
        _cols = {r[1] for r in conn.execute("PRAGMA table_info(chat_messages)").fetchall()}
        if "room" not in _cols and "room_id" not in _cols:
            conn.execute("ALTER TABLE chat_messages ADD COLUMN room TEXT DEFAULT 'genel'")
        if "room_id" not in _cols:
            try:
                conn.execute("ALTER TABLE chat_messages ADD COLUMN room_id TEXT DEFAULT 'genel'")
            except Exception:
                pass
        if "message_type" not in _cols:
            conn.execute("ALTER TABLE chat_messages ADD COLUMN message_type TEXT DEFAULT 'text'")
        if "is_signal" not in _cols:
            conn.execute("ALTER TABLE chat_messages ADD COLUMN is_signal INTEGER DEFAULT 0")
    except Exception:
        pass
  --shadow:0 12px 30px rgba(0,0,0,.45);
  --r:22px;
  --r2:16px;
  --pad:18px;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(1200px 700px at 20% 0%, rgba(31,94,255,.25), transparent 55%),
    radial-gradient(1000px 800px at 90% 10%, rgba(32,208,138,.14), transparent 60%),
    var(--bg);
  background-repeat:no-repeat;
  background-attachment:fixed;
  overflow-x:hidden;
  color:var(--text);
  font-family:var(--font);
  font-size:16px;
}
a{color:inherit;text-decoration:none}
.container{max-width:1120px;margin:0 auto;padding:22px}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.brand{display:flex;flex-direction:column;gap:4px}
.brand .title{font-size:24px;font-weight:800;letter-spacing:.2px}
.brand .sub{color:var(--muted);font-size:14px}
.nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pill{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  padding:10px 14px;
  border-radius:999px;
  color:var(--text);
  font-weight:700;
  font-size:14px;
}
.pill:hover{background:rgba(255,255,255,.10)}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:var(--pad);
}
.card h2{margin:0 0 12px 0;font-size:18px}
.muted{color:var(--muted)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.row{grid-template-columns:1fr}}
.input, select{
  width:100%;
  padding:14px 16px;
  border-radius:999px;
  border:1px solid var(--line);
  outline:none;
  background:rgba(0,0,0,.18);
  color:var(--text);
  font-size:16px;
}
select{appearance:auto}
select option{
  background:#0f1a2f;
  color:#e9eefb;
  font-size:16px;
}
label{display:block;margin:10px 0 8px 4px;color:var(--muted);font-weight:700}
.btn{
  display:inline-flex;align-items:center;justify-content:center;
  gap:8px;
  padding:12px 16px;
  border-radius:999px;
  border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(31,94,255,.95), rgba(31,94,255,.70));
  color:white;
  font-weight:900;
  cursor:pointer;
  font-size:15px;
}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:rgba(255,255,255,.06)}
.btn.danger{background:linear-gradient(180deg, rgba(255,77,109,.95), rgba(255,77,109,.70))}
.btn.good{background:linear-gradient(180deg, rgba(32,208,138,.95), rgba(32,208,138,.70))}
.hr{height:1px;background:var(--line);margin:14px 0}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media(max-width:900px){.kpi{grid-template-columns:1fr}}
.kpi .box{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  border-radius:var(--r2);
  padding:12px 14px;
}
.kpi .box .k{font-size:12px;color:var(--muted);font-weight:800}
.kpi .box .v{font-size:20px;font-weight:900;margin-top:4px}

/* Balance bubbles */
.balance-bubbles{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;margin-bottom:6px}
@media(max-width:900px){.balance-bubbles{grid-template-columns:repeat(2,1fr)}}
.bb{border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:10px 12px;background:rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(0,0,0,0.18)}
.bb.off{opacity:0.55}
.bb .t{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.2px}
.bb .b{display:flex;align-items:center;justify-content:space-between;margin-top:6px}
.bb .amt{font-size:16px;font-weight:900}
.bb .st{font-size:12px;color:var(--muted);font-weight:900}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table th{text-align:left;color:var(--muted);font-size:12px;padding:0 10px}
.tr{background:rgba(255,255,255,.06);border:1px solid var(--line)}
.table td{padding:12px 10px;font-size:15px}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:999px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  font-weight:900;
}
.badge.good{border-color:rgba(32,208,138,.35)}
.badge.bad{border-color:rgba(255,77,109,.35)}
.logline{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:12px;
  background:rgba(0,0,0,.18);
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.small{font-size:13px}
.bigtitle{font-size:30px;font-weight:1000;margin:0 0 6px 0}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
.login-card{width:100%;max-width:520px;padding:22px}
.center{text-align:center}
.switch{position:relative;width:52px;height:28px;display:inline-block}
.switch input{display:none}
.slider{
  position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
  background:rgba(255,255,255,.15);
  border:1px solid var(--line);
  transition:.18s;
  border-radius:999px;
}
.slider:before{
  position:absolute;content:"";
  height:22px;width:22px;left:3px;top:2px;
  background:white;
  transition:.18s;
  border-radius:999px;
}
.switch input:checked + .slider{
  background:rgba(32,208,138,.28);
  border-color:rgba(32,208,138,.45);
}
.switch input:checked + .slider:before{transform:translateX(24px)}
.inline{display:flex;align-items:center;gap:12px;flex-wrap:wrap}


/* ===== Bottom Ticker (Fixed) ===== */
#au_ticker_bar{
  position:fixed;
  left:0; right:0; bottom:0;
  z-index:9997;
  background: rgba(9,15,30,.72);
  border-top: 1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
  overflow:hidden;
  padding:10px 0;
  font-size:15px;      /* bÃ¼yÃ¼ttÃ¼m */
  font-weight:700;
}
#au_ticker_track{
  display:inline-block;
  white-space:nowrap;
  padding-left:100%;
  animation: au_marquee 85s linear infinite;
}
@keyframes au_marquee{
  0%{ transform: translateX(0); }
  100%{ transform: translateX(-100%); }
}
/* Altta bar var, iÃ§erik Ã¼stÃ¼ne binmesin */
body{ padding-bottom:60px; }




"""
BOTTOM_TICKER_HTML = """
<div id="au_ticker_bar">
  <div id="au_ticker_track">Loading...</div>
</div>
"""

BOTTOM_TICKER_JS = r"""
<script>
(function(){
  const track = document.getElementById("au_ticker_track");
  if(!track) return;

  function fmtTL(n){
    n = Number(n || 0);
    if(!isFinite(n) || n <= 0) return "â€”";
    return n.toFixed(2);          // âœ… TL daima 2 hane
  }

  function fmtTLPretty(n){
  n = Number(n || 0);
  if(!isFinite(n) || n <= 0) return "â€”";
  return n.toLocaleString("tr-TR", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}


  function fmtUSDT(n){
    n = Number(n || 0);
    if(!isFinite(n) || n <= 0) return "â€”";
    return n.toLocaleString("tr-TR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  async function load(){
    try{
      const r = await fetch("/api/ticker", { credentials: "same-origin" });
      const j = await r.json();
      if(!j || !j.ok) return;

      const usdtTry = Number(j.usdt_try || 0);
      const prices  = j.prices || {};

      // âœ… En baÅŸa: 1 USDT â‰ˆ XX.XX TL
      let parts = [];
      parts.push("ğŸ’µ 1 USDT â‰ˆ " + fmtTLPretty(usdtTry) + " TL");

      // âœ… Coinleri ekle: "AVAX/USDT: 13.56 USDT â€¢ 582.67 TL"
      Object.keys(prices).forEach((k)=>{
        const p = Number(prices[k] || 0);
        if(!p) return;
        const tl = p * usdtTry;
        parts.push("ğŸ“ˆ " + k + ": " + fmtUSDT(p) + " USDT â€¢ " + fmtTLPretty(tl) + " TL");
      });

      const line = parts.join(' <span class="au_sep">â€¢</span> ');
track.innerHTML = line + ' <span class="au_sep">â€¢</span> ' + line;

    }catch(e){}
  }

  load();
  setInterval(load, 1000); // âœ… saniye saniye
})();
</script>

"""



def base_html(title: str, body: str, nav: str = "") -> str:
    # Login ekranÄ±nda Ã¼st baÅŸlÄ±ÄŸÄ± gizle (Atalay Ulusoy Auto Trade / Login yazÄ±sÄ± gÃ¶rÃ¼nmesin)
    show_topbar = not (((title or "").strip().lower() == "login") and not (nav or "").strip())

    topbar_html = f"""<div class="topbar">
        <div>
          <div class="brand">{APP_BRAND}</div>
          <div class="sub">{safe_str(title)}</div>
        </div>
        <div class="nav">{nav}</div>
      </div>""" if show_topbar else ""

    # Popup (tek sefer): session['popup_msg']
    _popup = safe_str(session.pop('popup_msg', '')).strip()
    popup_msg_js = _popup.replace('\\', '\\\\').replace('\n', '\\n').replace('"', '\\"')

    return f"""<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{safe_str(title) if title else APP_BRAND}</title>
  <style>{BASE_CSS}</style>
</head>
<body>
  <div class="bg"></div>
  <div class="container">
    {topbar_html}
    {body}
  </div>

  <!-- âœ… AU Modal (CSS'e dokunmadan inline) -->
  <div id="au_modal_backdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9998;"></div>
  <div id="au_modal" style="display:none; position:fixed; left:50%; top:18%; transform:translateX(-50%);
       width:min(520px, calc(100vw - 24px)); z-index:9999;">
    <div style="background:#0b1220; border:1px solid rgba(255,255,255,.10); border-radius:18px; padding:18px; box-shadow:0 18px 45px rgba(0,0,0,.55);">
      <div id="au_modal_title" style="font-weight:800; font-size:16px; margin-bottom:10px;"></div>
      <div id="au_modal_text" style="color:#cbd5e1; line-height:1.35; margin-bottom:14px; white-space:pre-line;"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="au_modal_cancel" class="btn secondary" type="button">â†© VazgeÃ§</button>
        <button id="au_modal_ok" class="btn good" type="button">âœ… Evet</button>
      </div>
    </div>
  </div>

  <script>
  (function(){{
    // âœ… Modal API
    window.AUConfirm = function(opts){{
      try{{
        var bd = document.getElementById("au_modal_backdrop");
        var m  = document.getElementById("au_modal");
        var t  = document.getElementById("au_modal_title");
        var tx = document.getElementById("au_modal_text");
        var ok = document.getElementById("au_modal_ok");
        var no = document.getElementById("au_modal_cancel");
        if(!bd || !m || !t || !tx || !ok || !no) return false;

        t.textContent  = (opts && opts.title) ? opts.title : "âš  Onay";
        tx.textContent = (opts && opts.text) ? opts.text : "";
        ok.textContent = (opts && opts.okText) ? opts.okText : "âœ… Onayla";
        no.textContent = (opts && opts.noText) ? opts.noText : "â†© VazgeÃ§";

        function close() {{
          bd.style.display = "none";
          m.style.display  = "none";
          ok.onclick = null;
          no.onclick = null;
          bd.onclick = null;
        }}

        ok.onclick = async function(){{ try{{ var r = (opts && opts.onOk) ? opts.onOk() : true; if(r && typeof r.then==="function") r = await r; if(r === false) return; close(); }}catch(e){{ try{{ console.error(e); }}catch(e2){{}} }} }};
        no.onclick = function(){{ close(); if(opts && opts.onCancel) opts.onCancel(); }};
        bd.onclick = function(){{ close(); if(opts && opts.onCancel) opts.onCancel(); }};

        bd.style.display = "block";
        m.style.display  = "block";
        return true;
      }}catch(e){{ return false; }}
    }};

    // âœ… Auto delete popup
    function bindAutoDeleteConfirms(){{
      document.querySelectorAll("form.js-auto-del").forEach(function(f){{
        if (f.__bound) return;
        f.__bound = true;
        f.addEventListener("submit", function(e){{
          e.preventDefault();
          e.stopPropagation();

          AUConfirm({{
            title: "âš  Auto iÅŸlem silme",
            text: "Auto kuralÄ± silinsin mi?\\n\\nOnaylarsan kalÄ±cÄ± olarak silinir.",
            okText: "âœ… Evet, Sil",
            noText: "â†© VazgeÃ§",
            onOk: function(){{ f.submit(); }},
            onCancel: function(){{}}
          }});
          return false;
        }});
      }});
    }}

    document.addEventListener("DOMContentLoaded", bindAutoDeleteConfirms);
    setTimeout(bindAutoDeleteConfirms, 500);
  }})();
  </script>

  <!-- âœ… SADECE TEK ticker: alttaki iki satÄ±r -->
  {BOTTOM_TICKER_HTML}
  {BOTTOM_TICKER_JS}

  <script>
  (function(){{
    /* AU_POPUP_ONCE */
    try{{
      var msg = "{popup_msg_js}";
      if(msg && msg.trim()){{
        if(window.AUConfirm){{
          window.AUConfirm({{
            title: "âš  UyarÄ±",
            text: msg,
            okText: "âœ… Tamam",
            noText: "â†© Kapat",
            onOk: function(){{}},
            onCancel: function(){{}}
          }});
        }}else{{
          alert(msg);
        }}
      }}
    }}catch(e){{}}
  }})();
  </script>
</body>
</html>"""







def nav_html(is_admin: bool) -> str:
    items = [f'<a class="pill" href="/">{E_HOME} Panel</a>', f'<a class="pill" href="/test">{E_TST} Test</a>']
    if not is_admin:
        items.append(f'<a class="pill" href="/account">{E_LOCK} Åifre</a>')
    if is_admin:
        items.append(f'<a class="pill" href="/admin">{E_SHLD} Admin</a>')
        items.append(f'<a class="pill" href="/admin/contracts">{E_NOTE} SÃ¶zleÅŸmeler</a>')
        items.append(f'<a class="pill" href="/admin/logs">{E_LOGS} Logs</a>')
        items.append(f'<a class="pill" href="/admin/new-user">{E_PLUS} Yeni KullanÄ±cÄ±</a>')
    items.append(f'<a class="pill" href="/logout">{E_EXIT} Ã‡Ä±kÄ±ÅŸ</a>')
    return "\n".join(items)

def get_sidebar_html(active_item: str = "") -> str:
    from flask import session
    is_admin = session.get('is_admin') or session.get('role') == 'admin'
    username = session.get('username') or session.get('display_name') or 'KullanÄ±cÄ±'
    display_name = session.get('display_name') or username
    
    # Sidebar items - Emergent platform iÃ§in /api/app/ prefix kullanÄ±lÄ±yor
    items = [
        ("dashboard", "/api/app/dashboard", "ğŸ“Š", "Dashboard"),
        ("profile", "/api/app/profile", "ğŸ‘¤", "Profil"),
        ("chat", "/api/app/chat", "ğŸ’¬", "CanlÄ± Sohbet"),
        ("pnl", "/api/app/pnl-reporting-center", "ğŸ“„", "Kar/Zarar Raporu"),
        ("education", "/api/app/education", "ğŸ“", "EÄŸitim Merkezi"),
        ("market", "/api/app/market", "ğŸ“ˆ", "Piyasa Analizi"),
        ("history", "/api/app/history", "ğŸ•’", "Ä°ÅŸlem GeÃ§miÅŸi"),
        ("portfolio", "/api/app/portfolio", "ğŸ“Š", "PortfÃ¶y Analizi"),
        ("payment", "/api/app/payment", "ğŸ’³", "Ã–deme YÃ¶netimi"),
        ("exchange-api", "/api/app/exchange-api", "âš™ï¸", "Borsa API"),
        ("health", "/api/app/system-health", "â¤ï¸", "Sistem SaÄŸlÄ±ÄŸÄ±"),
    ]
    
    links_html = ""
    
    # Admin Panel link - SADECE admin kullanÄ±cÄ±lara gÃ¶ster
    if is_admin:
        admin_active = (active_item == "admin")
        admin_cls = "bg-red-600 text-white" if admin_active else "text-red-400 hover:bg-gray-800 hover:text-red-300"
        links_html += f"""
            <a href="/api/app/admin" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg transition-colors {admin_cls}">
                <span class="text-lg">âš™ï¸</span><span class="text-sm">Admin Panel</span>
            </a>
        """

    for tag, url, icon, label in items:
        is_active = (active_item == tag)
        cls = "bg-blue-600 text-white font-medium" if is_active else "text-gray-400 hover:bg-gray-800 hover:text-white"
        links_html += f"""
            <a href="{url}" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-lg transition-colors {cls}">
                <span class="text-lg">{icon}</span> <span class="text-sm font-medium">{label}</span>
            </a>
        """

    return f"""
    <!-- Mobile Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-[99] hidden lg:hidden" onclick="toggleSidebar()"></div>
    
    <!-- Mobile Toggle -->
    <button id="sidebar-toggle" onclick="toggleSidebar()" class="fixed top-4 left-4 z-[9999] lg:hidden w-10 h-10 rounded-lg bg-[#1a1a1a] border border-white/10 flex items-center justify-center text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>

    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-[#1a1a1a] border-r border-white/10 z-[100] transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-4 border-b border-white/10">
            <a href="/api/app/dashboard" class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-900/20"><span class="text-white text-lg font-bold">â‚¿</span></div>
                <span class="text-white font-bold tracking-tight">{display_name}</span>
            </a>
        </div>
        
        <nav class="flex-1 p-3 space-y-1 overflow-y-auto custom-scrollbar">
            {links_html}
        </nav>
        
        <div class="p-3 border-t border-white/10 bg-[#161616]">
            <div class="mb-3 px-2">
                <div class="flex items-center justify-between mb-1.5"><span class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Borsa Durumu</span><span id="sidebar-exchange-count" class="text-[10px] text-green-500 font-bold">0/4 Aktif</span></div>
                <div class="space-y-1" id="sidebar-exchange-list">
                    <div class="flex items-center justify-between"><span class="text-[11px] text-gray-400">OKX</span><span id="ex-okx-dot" class="w-1.5 h-1.5 rounded-full bg-red-500"></span></div>
                    <div class="flex items-center justify-between"><span class="text-[11px] text-gray-400">Binance</span><span id="ex-binance-dot" class="w-1.5 h-1.5 rounded-full bg-red-500"></span></div>
                    <div class="flex items-center justify-between"><span class="text-[11px] text-gray-400">Bybit</span><span id="ex-bybit-dot" class="w-1.5 h-1.5 rounded-full bg-red-500"></span></div>
                    <div class="flex items-center justify-between"><span class="text-[11px] text-gray-400">Gate.io</span><span id="ex-gate-dot" class="w-1.5 h-1.5 rounded-full bg-red-500"></span></div>
                </div>
            </div>
            <a href="/api/app/logout" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-red-900/20 hover:text-red-400 transition-all border border-transparent hover:border-red-900/30">
                <span class="text-lg">ğŸšª</span> <span class="text-sm font-medium">GÃ¼venli Ã‡Ä±kÄ±ÅŸ</span>
            </a>
        </div>
    </div>

    <script>
    function toggleSidebar() {{
        const s = document.getElementById('sidebar');
        const o = document.getElementById('sidebar-overlay');
        if (s.classList.contains('-translate-x-full')) {{
            s.classList.replace('-translate-x-full', 'translate-x-0');
            o.classList.remove('hidden');
        }} else {{
            s.classList.replace('translate-x-0', '-translate-x-full');
            o.classList.add('hidden');
        }}
    }}
    
    // Update sidebar exchange status
    async function updateSidebarExchangeStatus() {{
        try {{
            const res = await fetch('/api/exchange/list', {{credentials: 'same-origin'}});
            if (!res.ok) return;
            const data = await res.json();
            if (!data.success || !data.configs) return;
            
            const configs = data.configs;
            let activeCount = 0;
            const exchanges = ['okx', 'binance', 'bybit', 'gate'];
            
            exchanges.forEach(ex => {{
                const dot = document.getElementById('ex-' + ex + '-dot');
                if (dot) {{
                    const cfg = configs[ex];
                    if (cfg && cfg.connected) {{
                        dot.classList.remove('bg-red-500');
                        dot.classList.add('bg-green-500');
                        activeCount++;
                    }} else {{
                        dot.classList.remove('bg-green-500');
                        dot.classList.add('bg-red-500');
                    }}
                }}
            }});
            
            const countEl = document.getElementById('sidebar-exchange-count');
            if (countEl) {{
                countEl.textContent = activeCount + '/4 Aktif';
            }}
        }} catch(e) {{}}
    }}
    
    // Run on page load and every 30 seconds
    document.addEventListener('DOMContentLoaded', updateSidebarExchangeStatus);
    setInterval(updateSidebarExchangeStatus, 30000);
    </script>
    """


# ============================================
# USER HEADER - Displays on all authenticated pages
# ============================================
def get_user_header_html(username, usage=0, limit=100, package="Deneme"):
    """Generate user header HTML with username, usage, and package info"""
    # Handle unlimited (-1) limit
    if limit < 0:
        limit_display = "âˆ"
        usage_pct = 0
    else:
        limit_display = str(limit)
        usage_pct = min(100, int((usage / max(limit, 1)) * 100))
    
    return f"""
    <div class="fixed top-0 left-0 right-0 lg:left-64 z-40 bg-[#0f0f0f]/95 backdrop-blur-md border-b border-white/5">
        <div class="flex items-center justify-between px-4 py-2">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-sm">{username[0].upper() if username else 'U'}</div>
                <div>
                    <p class="text-white font-medium text-sm">{username}</p>
                    <p class="text-xs text-gray-500">{package} Paketi</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-xs text-gray-400">KullanÄ±m</p>
                    <p class="text-sm text-white font-medium">{usage}/{limit_display}</p>
                </div>
                <div class="w-24 h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500 rounded-full" style="width: {usage_pct}%"></div>
                </div>
            </div>
        </div>
    </div>
    """


def exchange_select_options(selected: str) -> str:
    sel = safe_str(selected).upper()
    out = []
    for val, label in EXCHANGES:
        s = "selected" if val == sel else ""
        out.append(f'<option value="{val}" {s}>{label}</option>')
    return "\n".join(out)

# =========================
# GLOBAL JS (KESÄ°NLÄ°KLE DOSYA SEVÄ°YESÄ°NDE)
# =========================
AUTO_JS = r"""
<script>
(function () {
  function log(msg){
    try { console.log("[AUTO_SYMBOLS]", msg); } catch(e){}
  }

  // âœ… Searchable select (no CSS changes)
  function makeSelectSearchable(selectEl, placeholder){
    try{
      if(!selectEl || selectEl.__auSearchBound) return;
      selectEl.__auSearchBound = true;

      const wrap = document.createElement("div");
      wrap.style.margin = "8px 0 10px 0";

      const inp = document.createElement("input");
      inp.className = "input";
      inp.type = "text";
      inp.autocomplete = "off";
      inp.placeholder = placeholder || "Ara...";

      // Keep original options list (value/text)
      function snapshotOptions(){
        const opts = [];
        for(const o of Array.from(selectEl.options||[])){
          opts.push({value:o.value, text:o.textContent||""});
        }
        selectEl.__auAllOptions = opts;
      }

      function applyFilter(q){
        q = String(q||"").toLowerCase().trim();
        const all = selectEl.__auAllOptions || [];
        const curVal = selectEl.value;

        // rebuild options
        selectEl.innerHTML = "";
        for(const it of all){
          if(!q || (it.text.toLowerCase().includes(q) || it.value.toLowerCase().includes(q))){
            const o = document.createElement("option");
            o.value = it.value;
            o.textContent = it.text;
            selectEl.appendChild(o);
          }
        }

        // restore selection if still present
        if(curVal){
          const found = Array.from(selectEl.options).some(o => o.value === curVal);
          if(found) selectEl.value = curVal;
        }
      }

      snapshotOptions();

      inp.addEventListener("input", function(){
        applyFilter(inp.value);
      });

      // If options change dynamically (AUTO), caller can call refreshSnapshot()
      selectEl.__auRefreshSnapshot = function(){
        snapshotOptions();
        applyFilter(inp.value);
      };

      // Insert input right before select
      selectEl.parentNode.insertBefore(wrap, selectEl);
      wrap.appendChild(inp);

      // Small UX: focus search when select focused
      selectEl.addEventListener("focus", function(){
        try{ inp.focus(); }catch(e){}
      });

    }catch(e){}
  }

  function popup(msg){
    try{
      if (window.AUConfirm){
        window.AUConfirm({
          title: "âš  UyarÄ±",
          text: String(msg||""),
          okText: "âœ… Tamam",
          noText: "â†© Kapat",
          onOk: function(){},
          onCancel: function(){}
        });
        return;
      }
    }catch(e){}
    alert(String(msg||""));
  }

  async function loadAutoSymbols(){
    const exSel = document.getElementById("auto_exchange");
    const symSel = document.getElementById("auto_symbol");
    if(!exSel || !symSel) return false;

    const ex = (exSel.value || "").trim();
    symSel.innerHTML = '<option value="">COÄ°N seÃ§</option>';
    if(!ex) return true;

    try{
      const r = await fetch("/api/symbols?exchange=" + encodeURIComponent(ex), { credentials:"same-origin" });
      const j = await r.json().catch(()=>null);
      if(!j || !j.ok || !Array.isArray(j.symbols)){
        log("bad response: " + (j ? JSON.stringify(j) : "null"));
        return false;
      }

      for (let i=0; i<j.symbols.length; i++){
        const s = j.symbols[i];
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        symSel.appendChild(opt);
      }

      log("loaded " + j.symbols.length + " symbols for " + ex);
      try{ if(symSel && symSel.__auRefreshSnapshot) symSel.__auRefreshSnapshot(); }catch(e){}

      return true;
    }catch(e){
      log("fetch error: " + (e && e.message ? e.message : e));
      return false;
    }
  }

  function bindAuto(){
    const exSel = document.getElementById("auto_exchange");
    const symSel = document.getElementById("auto_symbol");
    const btn = document.getElementById("auto_save_btn");
    const allInCb = document.getElementById("auto_all_in");
    const usdtInp = document.getElementById("auto_usdt");
    makeSelectSearchable(symSel, "COÄ°N ara (AUTO)");

    if(allInCb && usdtInp){
      function syncAllIn(){
        if(allInCb.checked){
          usdtInp.disabled = true;
          usdtInp.value = "";
          usdtInp.placeholder = "TÃ¼m bakiye";
        }else{
          usdtInp.disabled = false;
          if(!usdtInp.placeholder) usdtInp.placeholder = "Ã–rn: 20";
        }
      }
      allInCb.addEventListener("change", syncAllIn);
      syncAllIn();
    }

    if(!exSel || !symSel) return false;

    exSel.addEventListener("change", ()=>{ loadAutoSymbols(); });
    symSel.addEventListener("focus", ()=>{ loadAutoSymbols(); });

    // Kaydet butonu (HTML deÄŸiÅŸmeden)
    if(btn){
      btn.addEventListener("click", async function(){
        const ex = (exSel.value || "").trim();
        const sym = (symSel.value || "").trim();
        const allIn = (document.getElementById("auto_all_in")?.checked) ? "1" : "0";
        let usdt = (document.getElementById("auto_usdt")?.value || "").trim();

        if(!ex || !sym){
          popup("Borsa ve COÄ°N zorunlu");
          return;
        }
        if(allIn !== "1" && !usdt){
          popup("USDT zorunlu (veya 'TÃ¼m bakiye' seÃ§)");
          return;
        }
        if(allIn === "1" && !usdt){
          usdt = "0";
        }
        try{
          const r = await fetch("/auto/create", {
            method: "POST",
            headers: {"Content-Type":"application/x-www-form-urlencoded"},
            body: new URLSearchParams({ exchange_id: ex, symbol: sym, usdt: usdt, all_in: allIn }),
            credentials: "same-origin"
          });
          if(!r.ok){
            const t = await r.text();
            popup("Kaydet baÅŸarÄ±sÄ±z: " + t);
            return;
          }
          location.reload();
        }catch(e){
          popup("Kaydet hata");
        }
      });
    }

    return true;
  }

  // âœ… Manual coin select search
  function bindManualSearch(){
    try{
      const ms = document.getElementById("manualSymbol");
      if(ms) makeSelectSearchable(ms, "COÄ°N ara (MANUEL)");
    }catch(e){}
  }
  try{
    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", bindManualSearch);
    }else{
      bindManualSearch();
    }
  }catch(e){}

  let tries = 0;
  const t = setInterval(async function(){
    tries++;
    bindAuto();
    const ok = await loadAutoSymbols();
    if(ok || tries >= 20){
      clearInterval(t);
      if(tries >= 20) log("giving up after 20 tries");
    }
  }, 300);

  async function pollPositions(){

    // __AU_BAL_LOCK_GUARD_pollPositions

    try{ if (window.__AU_BALANCE_LOCK_UNTIL && Date.now() < window.__AU_BALANCE_LOCK_UNTIL) return; }catch(e){}

    try{
      const r = await fetch("/api/positions", { credentials: "same-origin" });
      const j = await r.json().catch(()=>null);
      const arr = (j && j.positions) ? j.positions : [];
      for(const p of arr){
        const id = p.id;
        const curEl = document.getElementById("pos_cur_" + id);
        if(curEl){
          if(p.current_price === null || p.current_price === undefined){
            curEl.textContent = "â€”";
          }else{
            const v = Number(p.current_price);
            curEl.textContent = isFinite(v) ? v.toFixed(6) : "â€”";
          }
        }
        const pnlEl = document.getElementById("pos_pnl_" + id);
        if(pnlEl){
          const pnl = Number(p.pnl_usdt || 0);
          const ok = pnl >= 0;
          pnlEl.className = ok ? "badge good" : "badge bad";
          pnlEl.textContent = (ok ? "ğŸŸ¢ " : "ğŸ”´ ") + pnl.toFixed(4) + " USDT";
        }
      }
    }catch(e){}
  }

  pollPositions();
  setInterval(pollPositions, 1500);


// âœ… Edit (USDT) modal
function openEditModal(btn){
  try{
    var rid = btn.getAttribute("data-rid") || "";
    var ex  = btn.getAttribute("data-ex")  || "";
    var sym = btn.getAttribute("data-sym") || "";
    var usdt= btn.getAttribute("data-usdt")|| "";
    var allin = btn.getAttribute("data-allin")||"0";

    var html = ""
      + '<div style="margin:6px 0 10px 0;color:#cbd5e1"><b>' + sym + '</b> <span style="opacity:.7">(' + ex + ')</span></div>'
      + '<label style="display:flex;align-items:center;gap:10px;margin:10px 0 10px 0">'
      + '  <input type="checkbox" id="au_edit_allin" value="1"' + (allin==="1"?' checked':'') + '>'
      + '  <span>TÃ¼m USDT bakiye ile al</span>'
      + '</label>'
      + '<div style="margin-top:10px">'
      + '  <div style="font-size:12px;opacity:.8;margin-bottom:6px">USDT</div>'
      + '  <input id="au_edit_usdt" class="input" inputmode="decimal" placeholder="Ã–rn: 20" value="' + (allin==="1" ? '' : (String(usdt||"").trim())) + '">'
      + '</div>'
      + '<div style="margin-top:10px;color:#94a3b8;font-size:12px">Not: TÃ¼m bakiye seÃ§ilirse USDT alanÄ± boÅŸ kalabilir</div>';

    window.AUConfirm({
      title: "âœï¸ Auto kuralÄ± dÃ¼zenle",
      text: "",
      okText: "ğŸ’¾ Kaydet",
      noText: "â†© VazgeÃ§",
      onOk: async function(){
        try{
          var ck = document.getElementById("au_edit_allin");
          var allIn = ck && ck.checked ? "1" : "0";
          var inp = document.getElementById("au_edit_usdt");
          var val = inp ? String(inp.value||"").trim() : "";

          if(allIn !== "1"){
            if(!val){
              try{ popup("USDT zorunlu"); }catch(e){}
              return false;
            }
          }

          var body = new URLSearchParams({ usdt: val || "0", all_in: allIn });
          var r = await fetch("/auto/" + encodeURIComponent(rid) + "/update", {
            method:"POST",
            headers: {"Content-Type":"application/x-www-form-urlencoded"},
            body: body,
            credentials:"same-origin"
          });
          if(!r.ok){
            try{ popup("GÃ¼ncelleme baÅŸarÄ±sÄ±z"); }catch(e){}
            return false;
          }
          location.reload();
          return true;
        }catch(e){
          try{ popup("GÃ¼ncelleme hatasÄ±"); }catch(e2){}
          return false;
        }
      }
    });

    try{
      var t = document.getElementById("au_modal_text");
      if(t) t.innerHTML = html;
    }catch(e){}
  }catch(e){}
}

document.addEventListener("click", function(ev){
  var t = ev.target;
  if(!t) return;
  if(t.classList && t.classList.contains("js-auto-edit")){
    ev.preventDefault();
    openEditModal(t);
  }
}, true);

})();
</script>
"""

MANUAL_JS = r"""
<script>
(function(){
  function qs(id){ return document.getElementById(id); }

  async function postPrefs(){
    const ex = qs("manualExchange")?.value || "";
    const dry = qs("manualDryRun")?.value || "0";
    try{
      await fetch("/manual/prefs", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: new URLSearchParams({ exchange_id: ex, dry_run: dry }),
        credentials: "same-origin"
      });
    }catch(e){}
  }

  async function loadManualSymbols(){
    const exSel = qs("manualExchange");
    const symSel = qs("manualSymbol");
    if(!exSel || !symSel) return;

    const ex = (exSel.value || "").trim();
    const prev = symSel.value || "";
    symSel.innerHTML = '<option value="">COÄ°N seÃ§</option>';
    if(!ex) return;

    try{
      const r = await fetch("/api/symbols?exchange=" + encodeURIComponent(ex), { credentials:"same-origin" });
      const j = await r.json();
      if(!j || !j.ok || !Array.isArray(j.symbols)) return;

      j.symbols.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        symSel.appendChild(opt);
      });

      if(prev) symSel.value = prev;
    }catch(e){}
  }

  function bindLiveConfirm(){
    const form = qs("manualForm");
    const drySel = qs("manualDryRun");
    if(!form || !drySel) return;

    const modal = qs("liveModal");
    const cancel = qs("liveCancel");
    const ok = qs("liveOk");

    form.addEventListener("submit", function(ev){
      // GERÃ‡EK mod -> onaysÄ±z submit YOK
      if(drySel.value === "0"){
        ev.preventDefault();

        if(modal){
          qs("mEx").textContent  = qs("manualExchange")?.value || "-";
          qs("mSym").textContent = qs("manualSymbol")?.value || "-";
          qs("mAct").textContent = qs("manualAction")?.value || "-";
          qs("mAmt").textContent = qs("manualUsdt")?.value || "-";
          modal.style.display = "flex";
        }else{
          if(confirm("GERÃ‡EK para ile iÅŸlem aÃ§Ä±lacak. Emin misin")) form.submit();
        }
      }
    });

    // HÄ±zlÄ± Miktar butonlarÄ± (5 / 10 / 25 USDT)
    try{
      document.querySelectorAll('[data-qamt]').forEach(function(b){
        b.addEventListener('click', function(e){
          e.preventDefault();
          var v = (b.getAttribute('data-qamt') || '').trim();
          var inp = qs("manualUsdt");
          if(inp){ inp.value = v; inp.dispatchEvent(new Event('input')); inp.focus(); }
        });
      });
    }catch(e){}


    if(cancel && modal) cancel.addEventListener("click", ()=> modal.style.display="none");
    if(ok && modal) ok.addEventListener("click", ()=>{ modal.style.display="none"; form.submit(); });
  }

  document.addEventListener("DOMContentLoaded", function(){
    const exSel  = qs("manualExchange");
    const drySel = qs("manualDryRun");

    loadManualSymbols();
    bindLiveConfirm();

    if(exSel)  exSel.addEventListener("change", async ()=>{ await postPrefs(); await loadManualSymbols(); });
    if(drySel) drySel.addEventListener("change", async ()=>{ await postPrefs(); });
  });
})();
</script>
"""


POS_JS = r"""
<script>
(function(){
  async function refreshPositions(){
    // __AU_BAL_LOCK_GUARD_refreshPositions
    try{ if (window.__AU_BALANCE_LOCK_UNTIL && Date.now() < window.__AU_BALANCE_LOCK_UNTIL) return; }catch(e){}

    try{
      const r = await fetch("/api/positions", {credentials:"same-origin"});
      if(!r.ok) return;
      const j = await r.json().catch(()=>null);
      if(!j || !Array.isArray(j.positions)) return;
      j.positions.forEach(p=>{
        const pid = p.id;
        const curEl = document.getElementById("pos_cur_" + pid);
        if(curEl) curEl.textContent = (p.current_price!=null) ? Number(p.current_price).toFixed(6) : "â€”";
        const pnlEl = document.getElementById("pos_pnl_" + pid);
        if(pnlEl){
          const pnl = Number(p.pnl_usdt||0);
          pnlEl.textContent = (p.pnl_usdt!=null) ? ((p.pnl_usdt>=0? "ğŸŸ¢ ":"ğŸ”´ ") + pnl.toFixed(4) + " USDT") : "â€”";
          if(p.pnl_usdt>=0){ pnlEl.classList.remove("bad"); pnlEl.classList.add("good"); }
          else { pnlEl.classList.remove("good"); pnlEl.classList.add("bad"); }
        }
      });
    }catch(e){}
  }
  setInterval(refreshPositions, 5000);
  window.addEventListener("load", refreshPositions);
})();
</script>
"""
# =========================
# CoinGecko Ticker Cache
# =========================
CG_MAP = {
    "BTC/USDT": "bitcoin",
    "ETH/USDT": "ethereum",
    "SOL/USDT": "solana",
    "BNB/USDT": "binancecoin",
    "XRP/USDT": "ripple",
    "ADA/USDT": "cardano",
    "DOGE/USDT": "dogecoin",
    "AVAX/USDT": "avalanche-2",
    "MATIC/USDT": "matic-network",
    "LINK/USDT": "chainlink",
    "DOT/USDT": "polkadot",
    "TRX/USDT": "tron",
    "SHIB/USDT": "shiba-inu",
    "LTC/USDT": "litecoin",
    "ATOM/USDT": "cosmos",
    "NEAR/USDT": "near",
    "ARB/USDT": "arbitrum",
    "OP/USDT": "optimism",
}

_ticker_cache = {"ts": 0.0, "usdt_try": 0.0, "prices": {}}

def _http_get_json(url: str, timeout: int = 8) -> dict:
    try:
        req = urllib.request.Request(url, headers={"User-Agent": "AU-AutoTrade/1.0"})
        with urllib.request.urlopen(req, timeout=timeout) as r:
            raw = r.read().decode("utf-8", "ignore")
        return json.loads(raw) if raw else {}
    except Exception:
        return {}

def get_coingecko_ticker_cached(min_interval_sec: float = 3.0) -> dict:
    """
    CoinGecko'dan fiyatlarÄ± Ã§eker ama min_interval_sec iÃ§inde cache dÃ¶ndÃ¼rÃ¼r.
    Rate-limit yememek iÃ§in ÅŸart.
    """
    now = time.time()
    if (now - float(_ticker_cache.get("ts") or 0.0)) < float(min_interval_sec):
        return _ticker_cache

    ids = ",".join(sorted(set(CG_MAP.values())))
    ids_q = urllib.parse.quote(ids)

    # Coin fiyatlarÄ± (USD)
    url_prices = f"https://api.coingecko.com/api/v3/simple/price?ids={ids_q}&vs_currencies=usd"
    j = _http_get_json(url_prices) or {}

    # USDTRY (USDT ~ USD kabul edip TRY kuruna Ã§arparÄ±z)
    url_fx = "https://api.coingecko.com/api/v3/simple/price?ids=usd&vs_currencies=try"
    fx = _http_get_json(url_fx) or {}
    usdt_try = 0.0
    try:
        usdt_try = float(((fx.get("usd") or {}).get("try")) or 0.0)
    except Exception:
        usdt_try = 0.0

    out = {}
    for sym, cid in CG_MAP.items():
        try:
            px = float(((j.get(cid) or {}).get("usd")) or 0.0)
        except Exception:
            px = 0.0
        if px > 0:
            out[sym] = px

    _ticker_cache["ts"] = now
    _ticker_cache["usdt_try"] = usdt_try
    _ticker_cache["prices"] = out
    return _ticker_cache



@app.get("/symbols/<ex>")
def symbols_compat(ex: str):
    """
    Compatibility endpoint used by some older UI/JS: /symbols/OKX
    Returns: {"ok": true, "symbols": [...]}
    """
    rr = require_login()
    if rr:
        return rr

    exu = safe_str(ex).strip().upper()
    if exu not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
        exu = "OKX"
    try:
        syms = get_symbols_for_exchange(exu) or []
    except Exception:
        syms = []
    syms = [safe_str(s).strip().upper() for s in syms if safe_str(s).strip()]
    # normalize some common formats
    out = []
    for s in syms:
        s2 = s.replace("-", "/").replace("_", "/")
        if "USDT" in s2 and "/" not in s2 and s2.endswith("USDT") and len(s2) > 4:
            base = s2[:-4]
            s2 = base + "/USDT"
        out.append(s2)
    return jsonify({"ok": True, "symbols": out})

@app.get("/api/ticker")
def api_ticker():
    rr = require_login()
    if rr:
        return rr

    # symbols query: BTC/USDT,ETH/USDT... (opsiyonel)
    q = safe_str(request.args.get("symbols") or "").strip()
    req_syms = [s.strip().upper() for s in q.split(",") if s.strip()] if q else []

    # coin list
    try:
        coins_payload = _public_coins_cached()
        all_syms = [safe_str(c.get("symbol") or c.get("value") or c.get("label") or "").strip() for c in (coins_payload.get("coins") or [])]
        all_syms = [s for s in all_syms if s]
    except Exception:
        all_syms = []
    symbols = req_syms or all_syms[:250] or ["BTC/USDT","ETH/USDT"]

    # USDTâ†’TRY (binance)
    def _bn_price(sym: str) -> float:
        try:
            r = requests.get("https://api.binance.com/api/v3/ticker/price", params={"symbol": sym}, timeout=4)
            j = r.json()
            return float(j.get("price") or 0.0)
        except Exception:
            return 0.0

    usdt_try = _bn_price("USDTTRY") or 0.0

    # OKX bulk tickers
    prices = {}
    try:
        r = requests.get("https://www.okx.com/api/v5/market/tickers", params={"instType":"SPOT"}, timeout=8)
        j = r.json() if r is not None else {}
        data = j.get("data") or []
        # map instId -> last
        mp = {}
        for it in data:
            inst = safe_str(it.get("instId") or "")
            last = safe_str(it.get("last") or "")
            if inst and last:
                mp[inst.upper()] = float(last)
        for s in symbols:
            if s in ("XAU/USD","XAG/USD","XPD/USD","XCU/USD"):
                # metals: placeholder 0, UI handles as N/A
                prices[s] = 0.0
                continue
            inst = s.replace("/","-").upper()
            v = mp.get(inst)
            prices[s] = float(v) if v is not None else 0.0
    except Exception:
        for s in symbols:
            prices[s] = 0.0

    return jsonify({"ok": True, "usdt_try": usdt_try, "prices": prices, "count": len(prices)})


@app.get("/forgot")
def forgot_get():
    body = f"""
<div class="login-wrap">
  <div class="card login-card">
    <div class="center">
      <div class="bigtitle">{E_MAIL} Åifremi Unuttum</div>
      <div class="muted">KullanÄ±cÄ± adÄ±nÄ± yaz. Talep admin'e iletilir</div>
    </div>
    <div class="hr"></div>

    <form method="post" action="/forgot">
      <label>KullanÄ±cÄ± adÄ±</label>
      <input class="input" name="username" autocomplete="username" required>
      <div style="margin-top:14px;display:flex;gap:10px;justify-content:center">
        <button class="btn" type="submit">{E_MAIL} Talep GÃ¶nder</button>
        <a class="btn secondary" href="/login">{E_BACK} Geri</a>
      </div>
    </form>
  </div>
</div>
"""
    return base_html("Åifre Talebi", body, "")

@app.post("/forgot")
def forgot_post():
    username = safe_str(request.form.get("username")).strip()
    ip = ""
    try:
        ip = _client_ip()
    except Exception:
        ip = ""

    # rate limit: aynÄ± IP 60 sn
    now = time.time()
    last = float(_PW_REQ_LAST.get(ip, 0.0) or 0.0)
    if now - last < 60:
        # sessizce login'e dÃ¶n
        session["popup_msg"] = f"{E_OK} Talep alÄ±ndÄ±"
        return redirect("/api/app/login")
    _PW_REQ_LAST[ip] = now

    u = get_user(username) if username else None
    display = user_display_name(u) if (u and isinstance(u, dict)) else (username or "Bilinmiyor")

    msg = "\n".join([
        f"{E_LOCK} Åifre SÄ±fÄ±rlama Talebi",
        f"{E_USER} KullanÄ±cÄ±: {display}",
        f"{E_PIN} Username: {username}",
        f"{E_TIME} Zaman: {iso_now_local()}",
        f"{E_HOME} IP: {ip}",
        f"{E_NOTE} Admin panelden ÅŸifreyi deÄŸiÅŸtir",
    ])

    # Sadece admin DM
    telegram_send_admin_dm(msg)

    session["popup_msg"] = f"{E_OK} Talebin admin'e iletildi"
    return redirect("/api/app/login")


@app.get("/account")
def account_get():
    rr = require_login()
    if rr:
        return rr

    if bool(session.get("is_admin")):
        return redirect("/admin")

    body = f"""
<div class="grid">
  <div class="card">
    <h2>{E_LOCK} Åifre DeÄŸiÅŸtir</h2>
    <div class="muted">Eski ÅŸifreni doÄŸrula, yeni ÅŸifreyi kaydet</div>
    <div class="hr"></div>

    <form method="post" action="/account/password">
      <label>Mevcut ÅŸifre</label>
      <input class="input" type="password" name="current_password" autocomplete="current-password" required>

      <label>Yeni ÅŸifre</label>
      <input class="input" type="password" name="new_password" autocomplete="new-password" required>

      <label>Yeni ÅŸifre tekrar</label>
      <input class="input" type="password" name="new_password2" autocomplete="new-password" required>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn good" type="submit">{E_SAVE} Kaydet</button>
        <a class="btn secondary" href="/">{E_BACK} Panele dÃ¶n</a>
      </div>
    </form>
  </div>
</div>
"""
    return base_html("HesabÄ±m", body, nav_html(bool(session.get("is_admin"))))

@app.post("/account/password")
def account_password_post():
    rr = require_login()
    if rr:
        return rr

    if bool(session.get("is_admin")):
        return redirect("/admin")

    username = session.get("username") or ""
    u = get_user(username)
    if u and not isinstance(u, dict):
        u = dict(u)
    if not u:
        session.clear()
        return redirect("/api/app/login")

    cur_pw = safe_str(request.form.get("current_password"))
    new_pw = safe_str(request.form.get("new_password"))
    new_pw2 = safe_str(request.form.get("new_password2"))

    if not verify_password(cur_pw, u["salt"], u["password_hash"]):
        session["popup_msg"] = f"{E_X} Mevcut ÅŸifre yanlÄ±ÅŸ"
        return redirect("/account")

    if not new_pw or len(new_pw) < 8:
        session["popup_msg"] = f"{E_WARN} Yeni ÅŸifre en az 8 karakter olmalÄ±"
        return redirect("/account")

    if new_pw != new_pw2:
        session["popup_msg"] = f"{E_X} Yeni ÅŸifreler eÅŸleÅŸmiyor"
        return redirect("/account")

    salt = secrets.token_hex(8)
    pw_hash = hash_password(new_pw, salt)

    try:
        conn = db()
        conn.execute("UPDATE users SET salt=?, password_hash=? WHERE username=?",
                     (salt, pw_hash, username))
        conn.commit()
        conn.close()
    except Exception:
        try:
            conn.close()
        except Exception:
            pass
        session["popup_msg"] = f"{E_X} Åifre gÃ¼ncellenemedi"
        return redirect("/account")

    # Admin'e bilgi (DM only), spam yok
    try:
        msg = "\n".join([
            f"{E_LOCK} Åifre deÄŸiÅŸtirildi",
            f"{E_USER} {user_display_name(u)}",
            f"{E_TIME} {iso_now_local()}",
        ])
        telegram_send_admin_dm(msg)
    except Exception:
        pass

    # gÃ¼venlik: yeniden login
    session.clear()
    session["popup_msg"] = f"{E_OK} Åifre gÃ¼ncellendi. Tekrar giriÅŸ yap"
    return redirect("/api/app/login")


@app.get("/logout")
def logout():
    session.clear()
    return redirect("/api/app/login")

# =========================
# Manual prefs (F5 kalÄ±cÄ±lÄ±k)
# =========================


# =========================
# Contract (SÃ¶zleÅŸme) UI + accept
# =========================
@app.get("/contract")
def contract_view():
    rr = require_login()
    if rr:
        return rr

    username = session["username"]
    u = get_user(username)
    if u and not isinstance(u, dict):
        u = dict(u)
    if not u:
        session.clear()
        return redirect("/api/app/login")

    # already accepted -> home
    if user_contract_accepted(u):
        return redirect("/")

    # Prefill
    full_name_pref = safe_str(u.get("contract_full_name") or safe_str(u.get("display_name") or ""))
    tc_pref = safe_str(u.get("contract_tc") or "")

    # Build "preview" body with placeholders (signature empty)
    ip = _client_ip()
    now_local = datetime.utcnow() + timedelta(hours=TZ_OFFSET_HOURS)
    dt_str = now_local.strftime("%Y-%m-%d %H:%M:%S")
    preview_text = build_contract_text(full_name_pref, username, tc_pref, dt_str, ip)

    body = f"""
<div style="position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.65);display:flex;align-items:flex-start;justify-content:center;padding:24px;overflow:auto">
  <div class="card" style="width:min(980px,100%);margin:auto">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <h2>{E_NOTE} {CONTRACT_TITLE}</h2>
    <div class="muted small">Zorunlu â€¢ 1 kez</div>
  </div>
  <div class="hr"></div>

  <form method="post" action="/contract/accept">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label>Ad</label>
        <input class="input" name="first_name" placeholder="Ad" value="{safe_str((full_name_pref.split(' ')[0] if full_name_pref else ''))}">
      </div>
      <div>
        <label>Soyad</label>
        <input class="input" name="last_name" placeholder="Soyad" value="{safe_str((' '.join(full_name_pref.split(' ')[1:]) if full_name_pref and len(full_name_pref.split(' '))>1 else ''))}">
      </div>
    </div>

    <div style="margin-top:10px">
      <label>T.C. Kimlik No <span class="muted small">(opsiyonel)</span></label>
      <input class="input" name="tc" placeholder="T.C. Kimlik No" value="{tc_pref}">
    </div>

    <div class="hr"></div>

    <div style="max-height:420px;overflow:auto;padding:14px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,0.03)">
      <div class="muted small" style="white-space:pre-wrap;line-height:1.55">{html_escape(preview_text)}</div>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:12px">
      <label style="display:flex;align-items:center;gap:10px;margin:0">
        <input type="checkbox" name="agree" value="1">
        <span>Okudum, kabul ediyorum</span>
      </label>
      <button class="btn good" type="submit">Onayla</button>
    </div>
  </form>
</div>
  </div>
</div>
"""
    return base_html(CONTRACT_TITLE, body, nav_html(False))

@app.post("/contract/accept")
def contract_accept():
    rr = require_login()
    if rr:
        return rr

    username = session["username"]
    u = get_user(username)
    if u and not isinstance(u, dict):
        u = dict(u)
    if not u:
        session.clear()
        return redirect("/api/app/login")

    if user_contract_accepted(u):
        return redirect("/")

    agree = safe_str(request.form.get("agree") or "")
    if agree != "1":
        # same UI, quick message
        body = f"""
<div class="card">
  <h2>{E_X} Onay Gerekli</h2>
  <div class="muted">Devam etmek iÃ§in sÃ¶zleÅŸmeyi kabul etmelisin.</div>
  <div class="hr"></div>
  <a class="btn" href="/contract">{E_BACK} Geri</a>
</div>
"""
        return base_html(CONTRACT_TITLE, body, nav_html(False))

    first = safe_str(request.form.get("first_name") or "")
    last = safe_str(request.form.get("last_name") or "")
    full_name = (first + " " + last).strip()
    tc = safe_str(request.form.get("tc") or "")
    ip = _client_ip()

    now_local = datetime.utcnow() + timedelta(hours=TZ_OFFSET_HOURS)
    dt_str = now_local.strftime("%Y-%m-%d %H:%M:%S")
    body_txt = build_contract_text(full_name, username, tc, dt_str, ip)
    accepted_ts = now_ts()

    conn = db()
    try:
        conn.execute(
            "INSERT INTO contracts(username, full_name, tc, ip, accepted_at, version, body) VALUES(?,?,?,?,?,?,?)",
            (username, full_name, tc, ip, int(accepted_ts), CONTRACT_VERSION, body_txt)
        )
        conn.execute(
            "UPDATE users SET contract_accepted_at=?, contract_full_name=?, contract_tc=?, contract_ip=? WHERE username=?",
            (int(accepted_ts), full_name, tc, ip, username)
        )
        conn.commit()
    finally:
        conn.close()

    try:
        log_line(username, "INFO", f"CONTRACT accepted v={CONTRACT_VERSION} ip={ip}")
    except Exception:
        pass

    # Telegram admin DM notify (IP dahil) - grup yok
    try:
        if safe_str(globals().get("TG_ADMIN_DM_ID", "")):
            # GÃ¶rseldeki stile yakÄ±n: baÅŸlÄ±k + kullanÄ±cÄ± + ad soyad + zaman + IP
            msg = "\\n".join([
                f"{E_NOTE} SÃ¶zleÅŸme onayÄ± alÄ±ndÄ±",
                f"{E_USER} {username}",
                f"{full_name if full_name else '-'}",
                f"{dt_str}",
                f"IP: {ip}",
            ])
            telegram_send_to(TG_ADMIN_DM_ID, msg)
    except Exception:
        pass


    return redirect("/")

@app.before_request
def _contract_guard_before_request():
    # Logged-in kullanÄ±cÄ± sÃ¶zleÅŸmeyi 1 kere kabul etmeden ana UI'ye girmesin.
    try:
        pth = safe_str(request.path or "")
        if not session.get("username"):
            return None

        # allow these paths
        if pth.startswith("/contract") or pth.startswith("/logout") or pth.startswith("/login") or pth.startswith("/forgot"):
            return None
        if pth.startswith("/admin"):
            return None
        if pth.startswith("/webhook"):
            return None
        if pth.startswith("/api/") or pth.startswith("/api"):
            return None
        if pth.startswith("/static"):
            return None

        username = safe_str(session.get("username") or "")
        if not username:
            return None
        u = get_user(username)
        if u and not isinstance(u, dict):
            u = dict(u)
        if not u:
            return None

        # Admin bypass (optional)
        if int(u.get("is_admin") or 0) == 1:
            return None

        if not user_contract_accepted(u):
            return redirect("/contract")
    except Exception:
        return None
    return None

@app.post("/manual/prefs")
def manual_prefs():
    rr = require_login()
    if rr:
        return rr

    username = session.get("username") or ""
    if not username:
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401

    # default: LIVE (dry_run=0)
    mode_raw = safe_str(request.form.get("dry_run") or session.get("manual_dry_run") or "0").strip().lower()
    ex = safe_str(request.form.get("exchange_id") or session.get("manual_exchange") or "OKX").strip().upper()

    if ex not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
        ex = "OKX"

    session["manual_dry_run"] = "1" if dry == 1 else "0"
    session["manual_exchange"] = ex

    conn = db()
    try:
        conn.execute("UPDATE users SET manual_exchange=?, manual_dry_run=? WHERE username=?", (ex, int(dry), username))
        conn.commit()
    finally:
        conn.close()

    return jsonify({"ok": True})


@app.post("/settings/daily-loss")
def user_set_daily_loss():
    rr = require_login()
    if rr:
        return rr
    username = session.get("username") or ""
    raw = (request.form.get("daily_loss_limit_usdt") or "").strip().replace(",", ".")
    try:
        v = float(raw) if raw else 0.0
    except Exception:
        v = 0.0
    if v < 0:
        v = 0.0
    if v > 1000000:
        v = 1000000.0
    set_daily_loss_limit(username, v)
    return redirect("/")

@app.post("/trade/toggle")
def trade_toggle():
    rr = require_login()
    if rr:
        return rr

    username = session["username"]
    u = get_user(username)
    if not u:
        session.clear()
        return redirect("/api/app/login")

    cur = 1 if int(u.get("trade_enabled") or 0) == 1 else 0
    newv = 0 if cur == 1 else 1

    conn = db()
    try:
        conn.execute("UPDATE users SET trade_enabled=? WHERE username=?", (newv, username))
        conn.commit()
    finally:
        conn.close()

    log_line(username, "INFO", f"Trade toggled -> {newv}")
    return redirect("/")

# =========================
# User Contracts (SÃ¶zleÅŸmeler): view + PDF download (user-side)
# =========================
@app.get("/contracts")
def user_contracts():
    rr = require_login()
    if rr:
        return rr

    # Admin panelde sÃ¶zleÅŸmeler kaldÄ±rÄ±ldÄ±; admin bu sayfaya yÃ¶nlenmesin
    if session.get("is_admin"):
        return redirect("/admin")

    username = session["username"]
    u = get_user(username)
    if u and not isinstance(u, dict):
        u = dict(u)
    if not u:
        session.clear()
        return redirect("/api/app/login")

    # KullanÄ±cÄ± sÃ¶zleÅŸme onaylamadÄ±ysa direkt onay ekranÄ±na
    if not user_contract_accepted(u):
        return redirect("/contract")

    rows = []
    try:
        conn = db()
        try:
            rows = conn.execute(
                "SELECT id, accepted_at, ip, version FROM contracts WHERE username=? ORDER BY accepted_at DESC LIMIT 25",
                (username,)
            ).fetchall()
        finally:
            conn.close()
    except Exception:
        rows = []

    def _fmt_ts(ts: int) -> str:
        try:
            ts = int(ts or 0)
        except Exception:
            ts = 0
        if ts <= 0:
            return "-"
        try:
            dt = datetime.fromtimestamp(ts, tz=timezone.utc) + timedelta(hours=TZ_OFFSET_HOURS)
            return dt.strftime("%Y-%m-%d %H:%M:%S")
        except Exception:
            return safe_str(ts)

    trs = []
    for r in rows:
        # sqlite row
        rid = r["id"] if isinstance(r, dict) else r[0]
        accepted_at = r["accepted_at"] if isinstance(r, dict) else r[1]
        ip = r["ip"] if isinstance(r, dict) else r[2]
        ver = r["version"] if isinstance(r, dict) else r[3]
        trs.append(
            f"""<tr>
<td style='font-weight:800'>#{rid}</td>
<td>{html_escape(_fmt_ts(accepted_at))}</td>
<td>{html_escape(safe_str(ip))}</td>
<td>{html_escape(safe_str(ver) or "-")}</td>
<td><a class="pill" href="/contracts/{rid}.pdf" target="_blank">{E_NOTE} PDF</a></td>
</tr>"""
        )

    body = f"""
<div class="card" style="margin-top:14px">
  <div style="font-size:18px;font-weight:900;display:flex;align-items:center;gap:10px">
    {E_NOTE} SÃ¶zleÅŸmeler
  </div>
  <div class="muted" style="margin-top:6px">Kendi sÃ¶zleÅŸme kayÄ±tlarÄ±n â€¢ PDF indir</div>
  <div style="margin-top:12px;overflow:auto">
    <table class="table" style="min-width:700px">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tarih</th>
          <th>IP</th>
          <th>Versiyon</th>
          <th>Ä°ndir</th>
        </tr>
      </thead>
      <tbody>
        {''.join(trs) if trs else '<tr><td colspan="5" class="muted">KayÄ±t bulunamadÄ±</td></tr>'}
      </tbody>
    </table>
  </div>
</div>
"""
    return render_page("SÃ¶zleÅŸmeler", nav_html(False), body)

@app.get("/contracts/<int:cid>.pdf")
def user_contract_pdf(cid: int):
    rr = require_login()
    if rr:
        return rr
    if session.get("is_admin"):
        return redirect("/admin")

    username = session["username"]
    row = None
    try:
        conn = db()
        try:
            row = conn.execute("SELECT * FROM contracts WHERE id=? AND username=? LIMIT 1", (cid, username)).fetchone()
        finally:
            conn.close()
    except Exception:
        row = None

    if not row:
        return ("Not found", 404)
    if row and not isinstance(row, dict):
        row = dict(row)

    pdf_bytes = _contract_pdf_bytes(row)
    fn = f"sozlesme_{safe_str(username)}_{cid}.pdf"
    return _send_bytes(pdf_bytes, fn, "application/pdf")

# =========================
# User dashboard
# =========================
@app.get("/")
def user_dashboard():
    return _render_user_dashboard(False)

@app.get("/test")
def user_test():
    return _render_user_dashboard(True)

@app.post("/test/reset")
def test_reset():
    rr = require_login()
    if rr:
        return rr
    # Test verilerini sÄ±fÄ±rla: varsa paper test tablolarÄ±nÄ± temizle, yoksa sessiz geÃ§
    try:
        with sqlite3.connect(DB_PATH) as con:
            cur = con.cursor()
            for t in ["paper_test_trades", "paper_test_positions", "paper_test_state"]:
                try:
                    cur.execute(f"DELETE FROM {t}")
                except Exception:
                    pass
            # baÅŸlangÄ±Ã§ state
            try:
                cur.execute("INSERT INTO paper_test_state(id, usdt, pnl, fee, last_px) VALUES(1, ?, 0.0, 0.0, 0.0) ON CONFLICT(id) DO UPDATE SET usdt=excluded.usdt, pnl=0.0, fee=0.0, last_px=0.0", (100000.0,))
            except Exception:
                pass
            con.commit()
    except Exception:
        pass
    return redirect("/test")

def _render_user_dashboard(test_view: bool = False):
    rr = require_login()
    if rr:
        return rr

    username = session["username"]
    u = get_user(username)
    if u and not isinstance(u, dict):
        u = dict(u)
    if not u:
        session.clear()
        return redirect("/api/app/login")


    # SÃ¶zleÅŸme: kullanÄ±cÄ± ilk giriÅŸte onaylamadan panele giremez (admin hariÃ§)
    if (not session.get("is_admin")) and (not user_contract_accepted(u)):
        return redirect("/contract")

    # 4 borsa bakiyesi (API yoksa 0.0)
    if test_view:
        st = paper_test_ensure_state(username)
        # Test: yalnÄ±zca seÃ§ili borsada sanal USDT gÃ¶ster, diÄŸerleri 0
        bals = {
            "OKX": float(st.get("usdt") or 0.0),
            "BINANCE": 0.0,
            "BYBIT": 0.0,
            "GATE": 0.0,
        }
    else:
        bals = get_user_exchange_usdt_balances(u)
    balances_txt = format_balances_line(bals)

    # Balance bubbles (hangi borsaya API girdiyse sadece onda 'API âœ”' gÃ¶rÃ¼nsÃ¼n)
    def _bb(slug: str, name: str, val: float, has_api: bool) -> str:
        cls = "bb" if has_api else "bb off"
        st = "API âœ”" if has_api else "API YOK"
        return (
            f'<div class="{cls}">'
            f'  <div class="t">{name}</div>'
            f'  <div class="b">'
            f'    <div class="amt">{val:.2f} USDT</div>'
            f'    <div class="st">{st}</div>'
            f'  </div>'
            f'</div>'
    )


    def _has_api_for(ex_id: str) -> bool:
        try:
            kk = _keys_for_exchange(u, ex_id)
            if not isinstance(kk, dict):
                return False
            k = safe_str(kk.get("api_key") or "").strip()
            s = safe_str(kk.get("api_secret") or "").strip()
            p = safe_str(kk.get("api_passphrase") or kk.get("api_password") or "").strip()
            if ex_id.upper() == "OKX":
                return bool(k and s and p)
            return bool(k and s)
        except Exception:
            return False

    okx_has  = _has_api_for("OKX")
    bin_has  = _has_api_for("BINANCE")
    byb_has  = _has_api_for("BYBIT")
    gate_has = _has_api_for("GATE")

    balances_bubbles = (
        '<div class="balance-bubbles">'
        + _bb('okx', 'OKX', float(bals.get('OKX', 0.0) or 0.0), okx_has)
        + _bb('binance', 'Binance', float(bals.get('BINANCE', 0.0) or 0.0), bin_has)
        + _bb('bybit', 'Bybit', float(bals.get('BYBIT', 0.0) or 0.0), byb_has)
        + _bb('gate', 'Gate.io', float(bals.get('GATE', 0.0) or 0.0), gate_has)
        + '</div>'
    )

    usage_badge = format_usage_badge(u)
    trade_ok = may_trade(u)

    trade_is_on = (int(u.get("trade_enabled") or 0) == 1)

    trade_toggle_btn = f"""
     <form method="post" action="/trade/toggle" style="display:inline">
      <button class="btn {'good' if trade_is_on else 'danger'}" type="submit">
      {E_ON if trade_is_on else E_OFF} {'ON' if trade_is_on else 'OFF'}
     </button>
     </form>
     """

    trade_badge = trade_toggle_btn
    status_badge = (f'<span class="badge good">{E_OK} Aktif</span>' if trade_ok else f'<span class="badge bad">{E_STOP} KÄ±sÄ±tlÄ±</span>')

    if test_view:
        # Paper test istatistikleri (kapanan iÅŸlemler)
        usdt_try = _get_usdt_try_rate() or 40.0
        nowi = now_ts()
        def _paper_period_stats(sec: int):
            conn = db_connect()
            try:
                cur = conn.cursor()
                # Determine which timestamp and pnl column exists (schema may vary)
                cur.execute("PRAGMA table_info(paper_test_trades)")
                cols = {r[1] for r in cur.fetchall()}
                ts_col = "ts_close" if "ts_close" in cols else ("closed_at" if "closed_at" in cols else ("closed_ts" if "closed_ts" in cols else ("close_ts" if "close_ts" in cols else None)))
                if not ts_col:
                    return {"count": 0, "pnl": 0.0, "ratio": 0.0}

                pnl_col = None
                for cand in ["pnl_net_usdt", "pnl_net", "pnl_usdt", "pnl"]:
                    if cand in cols:
                        pnl_col = cand
                        break
                if not pnl_col:
                    pnl_col = "pnl_net_usdt"  # will be added by migrations, but keep fallback

                since = int(time.time()) - int(sec)

                if ts_col in ("closed_at",):
                    q = f"SELECT COUNT(1), COALESCE(SUM({pnl_col}),0) FROM paper_test_trades WHERE username=? AND {ts_col}>=?"
                    row = cur.execute(q, (username, since)).fetchone()
                else:
                    # text timestamp fallback (ISO). approximate by filtering in python
                    q = f"SELECT {pnl_col}, {ts_col} FROM paper_test_trades WHERE username=?"
                    rows = cur.execute(q, (username,)).fetchall()
                    cnt = 0
                    pnl = 0.0
                    for r in rows:
                        try:
                            ts = r[1] or ""
                            # if stored as int in string
                            if ts.isdigit():
                                tsv = int(ts)
                            else:
                                tsv = 0
                            if tsv >= since:
                                cnt += 1
                                pnl += float(r[0] or 0.0)
                        except Exception:
                            pass
                    row = (cnt, pnl)

                cnt = int(row[0] or 0)
                pnl_usdt = float(row[1] or 0.0)

                # USDT->TL (approx). Use app cache if exists, else fallback.
                usdtry = float(getattr(app, "USDTRY_RATE", 43.0) or 43.0)
                pnl_tl = pnl_usdt * usdtry
                ratio = 0.0
                # ratio against start balance if exists
                try:
                    st = paper_test_get_state(username)
                    base = float(st.get("start_usdt") or st.get("usdt") or 0.0)
                    if base > 0:
                        ratio = (pnl_usdt / base) * 100.0
                except Exception:
                    pass

                return {"count": cnt, "pnl": pnl_tl, "ratio": ratio}
            finally:
                conn.close()
        day = _paper_period_stats(86400)
        week = _paper_period_stats(7*86400)
        month = _paper_period_stats(30*86400)
    else:
        day = stats_for_user(username, "day")
        week = stats_for_user(username, "week")
        month = stats_for_user(username, "month")

    sel_dry = "selected" if manual_dry_run == "1" else ""
    sel_live = "selected" if manual_dry_run == "0" else ""

    u_exchange = safe_str(u.get("exchange_id", "")).strip().upper()
    default_ex = safe_str(session.get("manual_exchange") or u_exchange or DEFAULT_EXCHANGE).strip().upper()
    if default_ex not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
        default_ex = "OKX"

    ex_okx = "selected" if default_ex == "OKX" else ""
    ex_bin = "selected" if default_ex == "BINANCE" else ""
    ex_gate = "selected" if default_ex == "GATEIO" else ""
    ex_byb = "selected" if default_ex == "BYBIT" else ""

    symbols = get_symbols_for_exchange(default_ex)
    symbol_options = "".join([f'<option value="{s}">{s}</option>' for s in symbols])

    script = AUTO_JS + MANUAL_JS + POS_JS

    def stat_box(title: str, s: Dict[str, Any]) -> str:
        pnl_try = float(s["pnl_try"])
        pct = float(s["pct"])
        sign = E_ON if pnl_try >= 0 else E_OFF
        return f"""
        <div class="box">
          <div class="k">{title}</div>
          <div class="v">{sign} {int(s["count"])} iÅŸlem</div>
          <div class="muted" style="margin-top:6px;font-weight:900">Kar Zarar: {pnl_try:,.2f} TL</div>
          <div class="muted" style="font-weight:900">Oran: {pct:.2f} %</div>
        </div>
        """

    # pending signals
    conn = db()
    pending = conn.execute("""
        SELECT * FROM pending_signals
        WHERE username=? AND status='PENDING'
        ORDER BY id DESC
        LIMIT 50
    """, (username,)).fetchall()
    conn.close()

    pending_rows = ""
    if pending:
        for p in pending:
            pid = int(p["id"] or 0)
            action = safe_str(p["action"]).upper()
            symbol = safe_str(p["symbol"]).upper()
            req_usdt = float(p["requested_usdt"] or 0.0)
            dry_run = int(p["dry_run"]) == 1

            # âœ… FIX: ex tanÄ±mlÄ± olsun (pending_signals iÃ§inden Ã§ek)
            ex_name = safe_str((p["exchange_id"] if "exchange_id" in p.keys() else "") or "").strip().upper()
            if not ex_name:
                ex_name = safe_str(u.get("exchange_id") or DEFAULT_EXCHANGE).strip().upper()

            created = datetime.utcfromtimestamp(int(p["created_at"] or 0) or 0) + timedelta(hours=TZ_OFFSET_HOURS)
            created_s = created.strftime("%Y-%m-%d %H:%M:%S")

            badge = f'<span class="badge {"good" if action=="BUY" else "bad"}">{(E_ON + " BUY") if action=="BUY" else (E_OFF + " SELL")}</span>'
            pending_rows += f"""
    <tr class="tr">
      <td>{badge}</td>
      <td><b>{symbol}</b><div class="muted small">{created_s}</div></td>
      <td>{req_usdt:.2f} USDT</td>
      <td style="display:flex;gap:8px;flex-wrap:wrap">
    <form method="post" action="/signal/{pid}/approve" style="display:inline"
          data-ex="{ex_name}" data-sym="{symbol}" data-usdt="{req_usdt:.2f}" data-action="{action}">
      <button class="btn good" type="submit">{E_OK} Onayla</button>
    </form>

    <form method="post" action="/signal/{pid}/deny" style="display:inline">
      <button class="btn secondary" type="submit">{E_BROOM} Reddet</button>
    </form>
      </td>
    </tr>
    """
    else:
        pending_rows = '<tr class="tr"><td colspan="5"><div class="muted">Bekleyen sinyal yok</div></td></tr>'


    # open positions (manual buys stay here; you can enqueue SELL)
    pos_rows = ""
    try:
        positions = paper_test_list_positions(username) if test_view else list_positions(username)
        if positions:
            for p in positions:
                pid = int(p.get("id") or 0)
                ex_name = safe_str(p.get("exchange_id") or "").upper()
                sym = safe_str(p.get("symbol") or "").upper()
                qty = float(p.get("qty") or 0.0)
                entry = float(p.get("entry_price") or 0.0)
                entry_usdt = float(p.get("entry_usdt") or 0.0)

                # qty bazen yanlÄ±ÅŸ kaydedilmiÅŸ olabilir; gÃ¼venli hesap
                qty_eff = qty
                if entry > 0 and entry_usdt > 0:
                    q_calc = entry_usdt / entry
                    if q_calc > 0 and (qty_eff <= 0 or qty_eff > q_calc * 5):
                        qty_eff = q_calc

                # Ä°lk render iÃ§in (sonrasÄ±nda JS /api/positions ile gÃ¼ncellenecek)
                try:
                    cur = float(get_market_price(ex_name, sym) or 0.0) if (ex_name and sym) else 0.0
                except Exception:
                    cur = 0.0
                cur_txt = f"<span id='pos_cur_{pid}'>{cur:.6f}</span>" if cur else f"<span id='pos_cur_{pid}'>â€”</span>"

                pnl = (cur - entry) * qty if (cur > 0 and entry > 0 and qty > 0) else 0.0
                pnl_txt = f"<span id='pos_pnl_{pid}' class='badge {'good' if pnl>=0 else 'bad'}'>{(E_ON if pnl>=0 else E_OFF)} {pnl:.2f} USDT</span>"

                pos_rows += f"""
    <tr class="tr">
      <td><b>{sym}</b><div class="muted small">{ex_name}</div></td>
      <td>{entry:.2f}</td>
      <td>{cur_txt}</td>
      <td>{entry_usdt:.2f} USDT</td>
      <td>{pnl_txt}</td>
      <td style="display:flex;gap:8px;flex-wrap:wrap">
    {sell_btn}
      </td>
    </tr>
    """
        else:
            pos_rows = '<tr class="tr"><td colspan="6"><div class="muted">AÃ§Ä±k pozisyon yok</div></td></tr>'
    except Exception:
        pos_rows = '<tr class="tr"><td colspan="6"><div class="muted">Pozisyonlar yÃ¼klenemedi</div></td></tr>'


    # auto rows
    auto_rows_html = ""
    try:
        rules = auto_list(username)
        if rules:
            for r in rules:
                ex_name = ""
                rid = int(r.get("id") or 0)
                ex_name = safe_str(r.get("exchange_id") or "").upper()
                sym = safe_str(r.get("symbol") or "").upper()
                usdt = float(r.get("usdt") or 0.0)

                enabled = int(r.get("enabled") or 0) == 1

                badge = f'<span class="badge good">{E_ON} AÃ§Ä±k</span>' if enabled else f'<span class="badge bad">{E_OFF} KapalÄ±</span>'
                btn_txt = f"{E_PAUS} Durdur" if enabled else f"{E_PLAY} BaÅŸlat"
                btn_val = "0" if enabled else "1"

                auto_rows_html += f"""
    <tr class="tr">
      <td><b>{sym}</b><div class="muted small">{ex_name}</div></td>
      <td>{('TÃ¼m Bakiye' if usdt < 0 else f'{usdt:.2f} USDT')}</td>
      <td>{badge}</td>
      <td style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn secondary js-auto-edit" type="button"
      data-rid="{rid}" data-ex="{ex_name}" data-sym="{sym}" data-usdt="{usdt}" data-allin="{('1' if usdt < 0 else '0')}">âœï¸ DÃ¼zenle</button>
    <form method="post" action="/auto/{rid}/toggle" style="display:inline">
      <input type="hidden" name="enabled" value="{btn_val}">
      <button class="btn secondary" type="submit">{btn_txt}</button>
    </form>
    <form method="post" action="/auto/{rid}/delete" class="inline js-auto-del">
      <button class="btn secondary" type="submit">{E_TRASH} Sil</button>
    </form>
      </td>
    </tr>
    """
        else:
            auto_rows_html = '<tr class="tr"><td colspan="4"><div class="muted">Auto iÅŸlem yok</div></td></tr>'
    except Exception:
        auto_rows_html = '<tr class="tr"><td colspan="4"><div class="muted">Auto tablo hazÄ±r deÄŸil</div></td></tr>'

    
    is_trial = is_trial_user(u)

    trial_banner_html = ""
    test_banner_html = ""
    if test_view:
        test_banner_html = f"""
        <div class="card" style="margin-bottom:16px;border:1px solid rgba(255,255,255,.12)">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <div>
              <div class="muted" style="margin-top:6px">Bu sayfa gerÃ§ek emir gÃ¶ndermez â€¢ Sanal bakiye ile senaryo testi</div>
            </div>
            <form method="post" action="/test/reset" style="margin:0">
              <button class="btn secondary" type="submit">ğŸ”„ Test Bakiyeyi SÄ±fÄ±rla</button>
            </form>
          </div>
        </div>
        """

    if is_trial:
        trial_banner_html = f"""
        <div class="card" style="margin-bottom:16px;border:1px solid rgba(255,255,255,.12)">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <div>
              <div style="font-weight:900;font-size:16px">ğŸ§ª Deneme Modu Aktif</div>
              <div class="muted" style="margin-top:6px">Ãœcretli pakete geÃ§mek iÃ§in butona bas. Talep bana DM olarak gelir</div>
            </div>
            <form method="post" action="/trial/upgrade" style="margin:0">
              <button class="btn good" type="submit">ğŸ’³ Ãœcretli Pakete GeÃ§</button>
            </form>
          </div>
        </div>
        """

    
    # Global AUTO mod bilgisi (user deÄŸiÅŸtiremez)
    g = get_auto_gate(username) if AUTO_REGIME_ENABLED else {"gate": 1, "mode": get_global_auto_mode(), "reason": ""}
    gate_v = int((g or {}).get("gate") or 0)
    mode_v = safe_str((g or {}).get("mode") or get_global_auto_mode()).upper() or get_global_auto_mode()
    reason_v = safe_str((g or {}).get("reason") or "")

    mode_label = "âœ… NORMAL"
    if mode_v == "AGGRESSIVE":
        mode_label = "ğŸ”¥ AGRESÄ°F"
    elif mode_v == "HARD":
        mode_label = "ğŸ§Š HARD"

    # User panel: teknik detay gizli, sadece Ã¶zet gÃ¶ster
    user_reason = "Piyasa uygun â€¢ Otomatik trade aktif" if gate_v==1 else "Piyasa uygun deÄŸil â€¢ Sinyaller beklemede"

    auto_mode_box = f"""<div class="box">
        <div class="k">ğŸ”¥ Auto Mod</div>
        <div class="v">
          <span class="badge">{mode_label}</span>
          <span class="badge {'good' if gate_v==1 else 'bad'}">{E_ON if gate_v==1 else E_OFF} Gate {'ON' if gate_v==1 else 'OFF'}</span>
        </div>
        <div class="muted small" style="margin-top:6px">{user_reason}</div>
      </div>"""

    # Get current mode from session (default to demo for safety)
    current_mode = session.get("trade_mode", "demo")
    demo_balance = get_demo_balance(user_id)
    
    # Get real balance (if API keys configured)
    real_balance = 0.0
    try:
        # Try to get real USDT balance from primary exchange
        from okx_client import OKXClient
        client = OKXClient(user_id=user_id)
        if client.api_key:
            real_balance = client.get_usdt_balance()
    except Exception:
        pass
    
    # Mode toggle buttons
    demo_active = "background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(59,130,246,.70)); color:white; font-weight:900;" if current_mode == "demo" else "background: rgba(255,255,255,.05); color: rgba(255,255,255,.60);"
    real_active = "background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(34,197,94,.70)); color:white; font-weight:900;" if current_mode == "real" else "background: rgba(255,255,255,.05); color: rgba(255,255,255,.60);"
    
    mode_toggle_html = f"""
    <div class="box">
        <div class="muted small" style="margin-top:6px;">Aktif mod: <b>{"DEMO (Sanal)" if current_mode == "demo" else "REAL (GerÃ§ek)"}</b></div>
    </div>
    """

    body = f"""
    {test_banner_html}{trial_banner_html}
    <div class="kpi">
      <div class="box"><div class="k">KullanÄ±cÄ±</div><div class="v">{E_USER} {user_display_name(u)}</div></div>
      <div class="box"><div class="k">KullanÄ±m</div><div class="v">{E_BOX} {usage_badge}</div></div>
      <div class="box">
    <div class="k">ğŸ›‘ GÃ¼nlÃ¼k Zarar Limiti</div>
    <div class="v">
      <form method="post" action="/settings/daily-loss" style="display:flex; gap:10px; align-items:center; margin:0;">
        <input class="input" name="daily_loss_limit_usdt" type="number" step="0.01" min="0"
               value="{get_daily_loss_limit(u):.2f}" placeholder="0 = kapalÄ±" style="max-width:140px;">
        <button class="btn" type="submit">{E_SAVE} Kaydet</button>
      </form>
      <div class="muted small" style="margin-top:6px;">Limit aÅŸÄ±lÄ±rsa trade otomatik kapanÄ±r</div>
    </div>
      </div>

      {mode_toggle_html}
      {auto_mode_box}
      <div class="box"><div class="k">Durum</div><div class="v">{trade_badge} {status_badge}</div></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>{E_CHART} Ä°statistik</h2>
      {balances_bubbles}
      <div class="hr"></div>
      <div class="kpi">
    {stat_box("GÃ¼nlÃ¼k", day)}
    {stat_box("HaftalÄ±k", week)}
    {stat_box("AylÄ±k", month)}
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
    <h2>{E_MAIL} Bekleyen Sinyaller</h2>
    <div class="muted">Webhook ile gelen sinyaller burada bekler, onayla ve Ã§alÄ±ÅŸtÄ±r</div>
    <div class="hr"></div>
    <table class="table">
      <thead>
        <tr>
          <th>Ä°ÅŸlem</th><th>Sembol</th><th>Ä°stek</th><th>Mod</th><th>Kontrol</th>
        </tr>
      </thead>
      <tbody>{pending_rows}</tbody>
    </table>

    <div class="hr"></div>
    <h2 style="margin:0 0 8px 0">{E_BOX} AÃ§Ä±k Pozisyonlar</h2>
    <div class="muted">Manuel BUY sonrasÄ± burada kalÄ±r; buradan SELL beklemeye alabilirsin</div>
    <div class="hr"></div>
    <table class="table">
      <thead>
        <tr>
          <th>Sembol</th><th>GiriÅŸ</th><th>AnlÄ±k</th><th>YatÄ±rÄ±lan</th><th>PnL (USDT)</th><th>Kontrol</th>
        </tr>
      </thead>
      <tbody>{pos_rows}</tbody>
    </table>
      </div>

      <div class="card">
    <h2>{E_MOUSE} Manuel Ä°ÅŸlem</h2>
    <div class="muted">Borsa seÃ§, COÄ°N seÃ§, beklemeye al, sonra onayla</div>
    <div class="hr"></div>

    <form id="manualForm" method="post" action="/manual/enqueue">
      <label>Borsa SeÃ§</label>
      <select id="manualExchange" name="exchange_id">
        <option value="OKX" {ex_okx}>{E_BANK} OKX</option>
        <option value="BINANCE" {ex_bin}>{E_BANK} Binance</option>
        <option value="GATEIO" {ex_gate}>{E_BANK} Gate.io</option>
        <option value="BYBIT" {ex_byb}>{E_BANK} Bybit</option>
      </select>

      <label>COÄ°N SeÃ§</label>
      <select id="manualSymbol" name="symbol">{symbol_options}</select>

      <label>USDT</label>
      <input id="manualUsdt" class="input" name="usdt" value="{DEFAULT_USDT:.2f}" inputmode="decimal">

      <div class="row" style="margin-top:8px;gap:8px;justify-content:flex-start;flex-wrap:wrap">
        <button class="pill" type="button" data-qamt="5">5 USDT</button>
        <button class="pill" type="button" data-qamt="1">1 USDT</button>
        <button class="pill" type="button" data-qamt="25">25 USDT</button>
      </div>


      <div class="row" style="margin-top:6px">
        <div>
          <label>Ä°ÅŸlem</label>
          <select id="manualAction" name="action">
            <option value="BUY">{E_ON} BUY</option>
            <option value="SELL">{E_OFF} SELL</option>
          </select>
        </div>
        <div>
          <label>Mod</label>
          <select id="manualDryRun" name="dry_run">
            <option value="0" {sel_live}>{E_BOOM} GERÃ‡EK</option>
          </select>
        </div>
      </div>

      <div style="margin-top:14px">
        <button class="btn good" type="submit">{E_OK} Emir GÃ¶nder</button>
        <form method="post" action="/panic" style="display:inline-block;margin-left:10px">
          <button class="btn danger" type="submit">{E_STOP} PANIC</button>
        </form>

      </div>

      <div style="margin-top:12px;display:flex;justify-content:center">
        <a class="pill" href="/forgot">{E_MAIL} Åifremi unuttum</a>
      </div>
    </form>

    <div id="liveModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;align-items:center;justify-content:center;padding:18px">
      <div style="max-width:520px;width:100%;background:#0f172a;border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:18px;box-shadow:0 16px 50px rgba(0,0,0,.45)">
        <div style="font-size:18px;font-weight:900">{E_WARN} GERÃ‡EK iÅŸlem onayÄ±</div>
        <div class="muted" style="margin-top:8px;line-height:1.5">
          {E_BOOM} GERÃ‡EK mod seÃ§ili. Onaylarsan gerÃ§ek para ile emir oluÅŸturulabilir.<br>
          Borsa: <b id="mEx">-</b> - COÄ°N: <b id="mSym">-</b> - Ä°ÅŸlem: <b id="mAct">-</b> - Tutar: <b id="mAmt">-</b> USDT
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap">
          <button id="liveCancel" class="btn secondary" type="button">{E_BACK} VazgeÃ§</button>
          <button id="liveOk" class="btn good" type="button">{E_OK} Evet, GERÃ‡EK</button>
        </div>
      </div>
    </div>

    {script}
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
    <h2>{E_BOT} AUTO Ä°ÅLEMLER</h2>
    <div class="muted">TradingView sinyali gelince, burada aÃ§Ä±k olan kurala gÃ¶re otomatik iÅŸlem aÃ§Ä±lÄ±r</div>
    <div class="hr"></div>

    <form method="post" action="/auto/create">
      <label>Borsa</label>
      <select name="exchange_id" id="auto_exchange">
        <option value="OKX">{E_BANK} OKX</option>
        <option value="BINANCE">{E_BANK} Binance</option>
        <option value="GATEIO">{E_BANK} Gate.io</option>
        <option value="BYBIT">{E_BANK} Bybit</option>
      </select>

      <label>COÄ°N</label>
      <select class="input" name="symbol" id="auto_symbol">
       <option value="">COÄ°N seÃ§</option>
      </select>

      <label>USDT</label>
      <input class="input" name="usdt" id="auto_usdt" inputmode="decimal" placeholder="Ã–rn: 20">

      <label style="display:flex;align-items:center;gap:10px;margin-top:10px">
        <input type="checkbox" name="all_in" id="auto_all_in" value="1">
        <span>TÃ¼m USDT bakiye ile al</span>
      </label>

      <div style="margin-top:14px">
        <button class="btn" type="button" id="auto_save_btn">{E_SAVE} Kaydet</button>
      </div>

      <div style="margin-top:12px;display:flex;justify-content:center">
        <a class="pill" href="/forgot">{E_MAIL} Åifremi unuttum</a>
      </div>
    </form>
      </div>

      <div class="card">
    <h2>{E_PLUS} Auto Ä°ÅŸlemlerim</h2>
    <div class="muted">AÃ§Ä±k olanlar sinyal gelince otomatik Ã§alÄ±ÅŸÄ±r</div>
    <div class="hr"></div>

    <table class="table">
      <thead>
        <tr>
          <th>COÄ°N / Borsa</th><th>Tutar</th><th>Durum</th><th>Kontrol</th>
        </tr>
      </thead>
      <tbody id="auto_rules_tbody">{auto_rows_html}</tbody>
    </table>
      </div>
    </div>
    """
    page_title = "Test" if test_view else "User Panel"
    return base_html(page_title, body, nav_html(bool(session.get("is_admin"))))


# =========================
# Set Trade Mode (DEMO/REAL)
# =========================
@app.post("/api/set-trade-mode")
def set_trade_mode():
    """Set user's preferred trading mode (demo or real) in session"""
    rr = require_login()
    if rr:
        return rr
    
    mode = str(request.form.get("mode", "demo")).lower().strip()
    if mode not in ("demo", "real"):
        mode = "demo"
    
    session["trade_mode"] = mode
    print(f"[MODE_SWITCH] User {session.get('user_id')} switched to {mode.upper()} mode")
    
    return redirect("/api/app/dashboard")


# =========================
# Manual enqueue
# =========================
@app.post("/manual/enqueue")
def manual_enqueue():
    rr = require_login()
    if rr:
        return rr

    username = session["username"]
    u = get_user(username)
    if not u:
        session.clear()
        return redirect("/api/app/login")
    if u and not isinstance(u, dict):
        u = dict(u)

    exchange_id = safe_str(request.form.get("exchange_id") or "").strip().upper()
    if exchange_id not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
        exchange_id = safe_str(u.get("exchange_id") or DEFAULT_EXCHANGE).strip().upper()
        if exchange_id not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
            exchange_id = DEFAULT_EXCHANGE

    symbol = normalize_symbol(safe_str(request.form.get("symbol") or DEFAULT_SYMBOL)).strip().upper()
    action = safe_str(request.form.get("action") or "BUY").strip().upper()
    if action not in ("BUY", "SELL"):
        action = "BUY"

    # DRY/LIVE seÃ§imi
    dry_run_raw = safe_str(request.form.get("dry_run") or "1").strip().lower()
    dry_run = dry_run_raw in ("1", "true", "on", "yes")
    session["manual_dry_run"] = "1" if dry_run else "0"

    # Trial / force_dry_run: GERÃ‡EK mod engellenir
    try:
        if int((u.get("force_dry_run") or 0)) == 1:
            dry_run = True
            session["manual_dry_run"] = "1"
    except Exception:
        pass

    try:
        usdt = float(safe_str(request.form.get("usdt") or DEFAULT_USDT))
    except Exception:
        usdt = float(DEFAULT_USDT)
    if usdt <= 0:
        usdt = float(DEFAULT_USDT)

    # kullanÄ±cÄ± default exchange gÃ¼ncelle (UI tutarlÄ±lÄ±ÄŸÄ±)
    try:
        conn = db()
        conn.execute("UPDATE users SET exchange_id=? WHERE username=?", (exchange_id, username))
        conn.commit()
        conn.close()
    except Exception:
        pass

    # PANIC / Trade OFF: BUY engelle (SELL serbest kalsÄ±n)
    if action == "BUY" and (not dry_run) and (not may_trade(u)):
        try:
            set_last_msg(username, f"{E_STOP} Trade kapalÄ± veya limit dolu")
        except Exception:
            pass
        telegram_send_for_user(u, f"{E_STOP} Trade kapalÄ± veya limit dolu")
        return redirect("/")

    # =========================
    # MANUEL SELL: direkt kapat
    # =========================
    if action == "SELL":
        try:
            res = _auto_sell_execute_now(username, u, exchange_id, symbol)
        except Exception as e:
            res = {"ok": False, "error": safe_str(e)}
        if not (res or {}).get("ok"):
            err = safe_str((res or {}).get("error") or "SELL baÅŸarÄ±sÄ±z")
            try:
                set_last_msg(username, f"{E_X} SELL baÅŸarÄ±sÄ±z: {err}")
            except Exception:
                pass
            return redirect("/")
        try:
            set_last_msg(username, f"{E_OK} SELL gÃ¶nderildi {symbol}")
        except Exception:
            pass
        return redirect("/")

    # =========================
    # MANUEL BUY: direkt Ã§alÄ±ÅŸtÄ±r
    # =========================
    if dry_run:
        # DRY RUN BUY: public price ile pozisyon aÃ§
        entry_price = 0.0
        try:
            entry_price = float(get_public_price(exchange_id, symbol) or 0.0)
        except Exception:
            entry_price = 0.0
        if entry_price <= 0:
            entry_price = 100.0

        qty = (usdt / entry_price) if entry_price > 0 else 0.0
        try:
            position_add(username, exchange_id, symbol, qty, entry_price, usdt, True, 0.0, 0.0, "", "")
        except Exception:
            try:
                conn = db()
                conn.execute(
                    "INSERT INTO open_positions(username, exchange_id, symbol, qty, entry_price, entry_usdt, dry_run, created_at) "
                    "VALUES (?,?,?,?,?,?,?,?)",
                    (username, exchange_id, symbol, float(qty), float(entry_price), float(usdt), 1, now_ts()),
                )
                conn.commit()
                conn.close()
            except Exception:
                pass

        try:
            telegram_send_for_user(u, build_telegram_text("BUY", u, symbol, usdt, True, {"mode": "MANUEL"}))
        except Exception:
            pass
        try:
            pass
        except Exception:
            pass
        return redirect("/")

    # LIVE BUY
    keys = _keys_for_exchange(u, exchange_id)
    res = place_order(
        exchange_id, "BUY", symbol, usdt, False,
        safe_str(keys.get("api_key")), safe_str(keys.get("api_secret")), safe_str(keys.get("api_passphrase"))
    )

    if not (res or {}).get("ok"):
        reason = safe_str((res or {}).get("reason") or "Bilinmeyen hata")
        try:
            set_last_msg(username, f"{E_X} BUY baÅŸarÄ±sÄ±z: {reason}")
        except Exception:
            pass
        log_line(username, "WARN", f"{E_X} BUY baÅŸarÄ±sÄ±z: {reason}")
        telegram_send_for_user(u, f"{E_X} BUY baÅŸarÄ±sÄ±z: {reason}")
        return redirect("/")

    fill_price = _to_float((res or {}).get("fill_price"), 0.0)
    fill_qty = _to_float((res or {}).get("fill_qty"), 0.0)
    real_usdt = _to_float((res or {}).get("real_usdt"), usdt)
    if real_usdt <= 0:
        real_usdt = usdt

    buy_fee_usdt = _to_float((res or {}).get("fee_usdt"), 0.0)
    buy_fee_coin = _to_float((res or {}).get("fee_coin"), 0.0)
    buy_fee_coin_ccy = safe_str((res or {}).get("fee_coin_ccy") or "")
    buy_ord_id = safe_str((res or {}).get("ord_id") or "")

    try:
        position_add(username, exchange_id, symbol, fill_qty, fill_price, real_usdt, False,
                     buy_fee_usdt, buy_fee_coin, buy_fee_coin_ccy, buy_ord_id)
    except Exception:
        try:
            conn = db()
            conn.execute(
                "INSERT INTO open_positions(username, exchange_id, symbol, qty, entry_price, entry_usdt, dry_run, created_at) "
                "VALUES (?,?,?,?,?,?,?,?)",
                (username, exchange_id, symbol, float(fill_qty), float(fill_price), float(real_usdt), 0, now_ts()),
            )
            conn.commit()
            conn.close()
        except Exception:
            pass

    try:
        conn = db()
        conn.execute(
            "INSERT INTO trades(username, exchange_id, action, symbol, real_usdt, pnl_usdt, dry_run, created_at) "
            "VALUES (?,?,?,?,?,?,?,?)",
            (username, exchange_id, "BUY", symbol, float(real_usdt), 0.0, 0, now_ts()),
        )
        conn.commit()
        conn.close()
    except Exception:
        pass

    try:
        inc_usage(username)
    except Exception:
        pass

    log_line(username, "INFO", f"MANUEL BUY LIVE {exchange_id} {symbol} usdt={real_usdt:.2f}")
    try:
        telegram_send_for_user(u, build_telegram_text("BUY", u, symbol, real_usdt, False, {"mode": "MANUEL"}))
    except Exception:
        pass
    try:
        set_last_msg(username, f"{E_OK} BUY gÃ¶nderildi (GERÃ‡EK) {symbol}")
    except Exception:
        pass
    return redirect("/")



def get_position_row(pid: int, username: str) -> dict:
    conn = db_conn()
    cur = conn.cursor()
    cur.execute(
        "SELECT id, username, exchange_id, symbol, qty, entry_price, dry_run, created_at FROM open_positions WHERE id=? AND username=?",
        (int(pid), username),
    )
    r = cur.fetchone()
    conn.close()
    if not r:
        return {}
    keys = ["id", "username", "exchange_id", "symbol", "qty", "entry_price", "dry_run", "created_at"]
    return dict(zip(keys, r))



# =========================
# PANIC BUTTON (User)
# =========================
@app.post("/panic")
def panic_button():
    rr = require_login()
    if rr:
        return rr

    username = session.get("username") or ""
    if not username:
        return redirect("/api/app/login")

    conn = db()
    try:
        conn.execute("UPDATE users SET trade_enabled=0 WHERE username=?", (username,))
        try:
            conn.execute("UPDATE auto_rules SET enabled=0 WHERE username=?", (username,))
        except Exception:
            pass
        conn.commit()
    finally:
        conn.close()

    try:
        log_line(username, "WARN", "PANIC: trade kapatÄ±ldÄ±, auto kurallar kapandÄ±")
    except Exception:
        pass

    try:
        telegram_send_for_user(get_user(username), f"{E_STOP} PANIC: Trade kapatÄ±ldÄ± (AUTO kurallar kapandÄ±)")
    except Exception:
        pass

    session["popup_msg"] = f"{E_STOP} PANIC aktif: Trade kapatÄ±ldÄ±"
    return redirect("/")

@app.post("/position/<int:pid>/enqueue_sell")
def enqueue_sell(pid: int):
    """
    UI'daki SELL butonu: aynÄ± coin'den (stack) aÃ§Ä±k olan tÃ¼m pozisyonu kapatÄ±r.
    """
    rr = require_login()
    if rr:
        return rr

    username = session.get("username")
    if not username:
        return redirect("/api/app/login")

    u = get_user(username)
    if u and not isinstance(u, dict):
        u = dict(u)
    if not u:
        return redirect("/api/app/login")

    # temsilci pozisyonu bul
    p = get_position(pid, username=username)
    if p and not isinstance(p, dict):
        p = dict(p)
    if not p:
        return redirect("/")

    ex = safe_str(p.get("exchange_id") or DEFAULT_EXCHANGE).upper()
    symbol = normalize_symbol(safe_str(p.get("symbol") or DEFAULT_SYMBOL))

    dry_run = bool(int(p.get("dry_run") or 0))

    # aynÄ± symbol+exchange+diy_run olan tÃ¼m pozisyonlarÄ± topla
    all_pos = list_positions(username) or []
    stack: List[Dict[str, Any]] = []
    for row in all_pos:
        if row is not None and not isinstance(row, dict):
            try:
                row = dict(row)
            except Exception:
                continue
        if not row:
            continue
        if safe_str(row.get("exchange_id") or "").upper() != ex:
            continue
        if normalize_symbol(safe_str(row.get("symbol") or "")) != symbol:
            continue
        if bool(int(row.get("dry_run") or 0)) != dry_run:
            continue
        stack.append(row)

    if not stack:
        return redirect("/")

    total_entry_usdt = sum(_to_float(r.get("entry_usdt"), 0.0) + _to_float(r.get("buy_fee_usdt"), 0.0) for r in stack)
    total_qty_db = sum(_to_float(r.get("qty"), 0.0) for r in stack)

    # OKX keys
    keys = _keys_for_exchange(u, ex)
    api_key = safe_str(keys.get("api_key"))
    api_secret = safe_str(keys.get("api_secret"))
    api_pass = safe_str(keys.get("api_passphrase"))

    # SELL miktarÄ±: LIVE'da her zaman eldeki tÃ¼m base coin
    base_ccy = symbol.split("/")[0].strip().upper()
    qty_to_sell = total_qty_db

    if not dry_run and ex == "OKX":
        try:
            bal_qty = okx_get_asset_balance(base_ccy, api_key, api_secret, api_pass)
            if bal_qty > 0:
                qty_to_sell = bal_qty
        except Exception:
            pass

    if qty_to_sell <= 0:
        set_last_msg(username, f"{E_X} SELL iptal â€¢ {symbol} â€¢ qty sÄ±fÄ±r")
        return redirect("/")

    # emri gÃ¶nder
    res = place_order(ex, "SELL", symbol, qty_to_sell, dry_run, api_key, api_secret, api_pass)
    ok = bool((res or {}).get("ok"))
    err = safe_str((res or {}).get("reason") or "")

    if not ok:
        # hata bildir
        telegram_send_for_user(u, build_telegram_text("SELL", u, symbol, 0.0, dry_run, {"reason": err}))
        set_last_msg(username, f"{E_X} SELL baÅŸarÄ±sÄ±z â€¢ {symbol} â€¢ {err}")
        return redirect("/")

    
    fill_price = _to_float((res or {}).get("fill_price"), 0.0)
    fill_qty = _to_float((res or {}).get("fill_qty"), qty_to_sell)
    real_usdt = _to_float((res or {}).get("real_usdt"), 0.0)  # SELL gross proceeds (OKX fillNotional)
    # Fee (TOTAL) = BUY fee (stack) + SELL fee (order)
    buy_fee_total_usdt = _sum_buy_fees_usdt(ex, symbol, stack)
    sell_fee_total_usdt = _sum_sell_fees_usdt(ex, symbol, fill_price, res)
    fee_total_usdt = buy_fee_total_usdt + sell_fee_total_usdt

    # NET proceeds & NET PnL
    proceeds_net = real_usdt - sell_fee_total_usdt
    pnl_usdt = proceeds_net - float(total_entry_usdt) - buy_fee_total_usdt

    # tÃ¼m stack satÄ±ldÄ± say â†’ DB temizle
    for r in stack:
        try:
            delete_position(int(r.get("id") or 0), username=username)
        except Exception:
            pass

    record_trade(username, ex, "SELL", symbol, total_entry_usdt, pnl_usdt, dry_run)
    if not dry_run:
        inc_usage(username)

    telegram_send_for_user(
        u,
        build_telegram_text(
            "SELL",
            u,
            symbol,
            total_entry_usdt,
            dry_run,
            {
                "net_pnl_usdt": pnl_usdt,
                "net_pnl_try": (pnl_usdt * USDT_TRY_RATE),
                "fee_usdt_total": fee_total_usdt,
                "pnl_usdt": pnl_usdt,
                "pnl_try": (pnl_usdt * USDT_TRY_RATE),
                "fill_price": fill_price,
                "fill_qty": fill_qty,
            },
        ),
    )

    set_last_msg(username, f"{E_OK} SELL baÅŸarÄ±lÄ± â€¢ {symbol} â€¢ NET PnL {pnl_usdt:.6f} USDT")
    return redirect("/")

@app.post("/auto/create")
def auto_create_form():
    rr = require_login()
    if rr:
        return rr
    username = session["username"]

    exchange_id = safe_str(request.form.get("exchange_id") or "").strip().upper()
    symbol = safe_str(request.form.get("symbol") or "").strip().upper()
    all_in = safe_str(request.form.get("all_in") or "").strip().lower() in ("1", "true", "on", "yes")

    try:
        usdt = float(safe_str(request.form.get("usdt") or "0"))
    except Exception:
        usdt = 0.0

    if exchange_id not in ("OKX", "BINANCE", "GATEIO", "BYBIT") or not symbol:
        return Response("BAD_INPUT", status=400)

    # 'TÃ¼m bakiye' seÃ§ilirse usdt=-1 olarak kaydediyoruz (DB ÅŸemasÄ± deÄŸiÅŸmeden)
    if all_in:
        usdt = -1.0
    else:
        if usdt <= 0:
            return Response("BAD_INPUT", status=400)

    auto_upsert_rule(username, exchange_id, symbol, usdt, 1)
    if usdt < 0:
        log_line(username, "INFO", f"AUTO rule saved {exchange_id} {symbol} ALL_IN")
    else:
        log_line(username, "INFO", f"AUTO rule saved {exchange_id} {symbol} {usdt:.2f}")
    return ("OK", 200)

@app.post("/auto/<int:rid>/toggle")
def auto_toggle_form(rid: int):
    rr = require_login()
    if rr:
        return rr
    username = session["username"]
    enabled = 1 if safe_str(request.form.get("enabled") or "0") in ("1","true","on","yes") else 0
    auto_toggle_id(username, rid, enabled)
    return redirect("/")

@app.post("/auto/<int:rid>/delete")
def auto_delete_form(rid: int):
    rr = require_login()
    if rr:
        return rr
    username = session["username"]
    auto_delete_id(username, rid)
    return redirect("/")


@app.post("/auto/<int:rid>/update")
def auto_update_form(rid: int):
    rr = require_login()
    if rr:
        return rr
    username = session["username"]

    data = {}
    if request.is_json:
        try:
            data = request.get_json(silent=True) or {}
        except Exception:
            data = {}
    else:
        data = request.form or {}

    all_in = safe_str(data.get("all_in") or "").strip().lower() in ("1", "true", "on", "yes")
    try:
        usdt = float(safe_str(data.get("usdt") or "0"))
    except Exception:
        usdt = 0.0

    if all_in:
        usdt = -1.0
    else:
        if usdt <= 0:
            return Response("BAD_INPUT", status=400)

    auto_update_id(username, rid, usdt)
    if usdt < 0:
        log_line(username, "INFO", f"AUTO rule updated id {rid} ALL_IN")
    else:
        log_line(username, "INFO", f"AUTO rule updated id {rid} {usdt:.2f}")
    return ("OK", 200)

# =========================
# Pending approve/deny helpers
# =========================
def _set_signal_status(sid: int, status: str) -> None:
    conn = db()
    try:
        conn.execute("UPDATE pending_signals SET status=? WHERE id=?", (status, sid))
        conn.commit()
    finally:
        conn.close()

def _set_trade_enabled(username: str, enabled: bool) -> None:
    conn = db()
    try:
        conn.execute("UPDATE users SET trade_enabled=? WHERE username=?", (1 if enabled else 0, username))
        conn.commit()
    finally:
        conn.close()

@app.post("/signal/<int:sid>/deny")
def deny_signal(sid: int):
    rr = require_login()
    if rr:
        return rr
    username = session["username"]

    conn = db()
    try:
        row = conn.execute("SELECT * FROM pending_signals WHERE id=?", (sid,)).fetchone()
        if not row or row["username"] != username:
            return redirect("/")
        conn.execute("UPDATE pending_signals SET status='DENIED' WHERE id=?", (sid,))
        conn.commit()
    finally:
        conn.close()

    log_line(username, "INFO", f"Signal denied id {sid}")
    return redirect("/")

def _keys_for_exchange(u: dict, exchange_id: str) -> Dict[str, str]:
    """Get API keys for a specific exchange - checks both users table and exchange_api_keys table"""
    ex = (exchange_id or "").upper()
    username = safe_str(u.get("username") or "")
    
    # First try exchange_api_keys table (new system)
    try:
        conn = db()
        row = conn.execute("""
            SELECT api_key, api_secret, api_passphrase FROM exchange_api_keys 
            WHERE (user_id=? OR user_id=?) AND UPPER(exchange)=?
        """, (username, "global", ex)).fetchone()
        conn.close()
        
        if row and row[0]:
            return {
                "api_key": safe_str(row[0] or ""),
                "api_secret": safe_str(row[1] or ""),
                "api_passphrase": safe_str(row[2] or ""),
            }
    except Exception:
        pass
    
    # Fallback to users table columns (legacy system)
    if ex == "OKX":
        return {
            "api_key": safe_str(u.get("api_key")),
            "api_secret": safe_str(u.get("api_secret")),
            "api_passphrase": safe_str(u.get("api_passphrase")),
        }
    if ex == "BINANCE":
        return {"api_key": safe_str(u.get("binance_api_key")), "api_secret": safe_str(u.get("binance_api_secret")), "api_passphrase": ""}
    if ex == "BYBIT":
        return {"api_key": safe_str(u.get("bybit_api_key")), "api_secret": safe_str(u.get("bybit_api_secret")), "api_passphrase": ""}
    if ex in ("GATEIO", "GATE"):
        return {"api_key": safe_str(u.get("gate_api_key")), "api_secret": safe_str(u.get("gate_api_secret")), "api_passphrase": ""}
    return {"api_key": "", "api_secret": "", "api_passphrase": ""}


@app.post("/signal/<int:sid>/approve")
def approve_signal(sid: int):
    rr = require_login()
    if rr:
        return rr

    username = session.get("username")
    if not username:
        return redirect("/api/app/login")

    # Pending sinyali yÃ¼kle (sadece bu kullanÄ±cÄ±ya ait ve PENDING olmalÄ±)
    conn = db()
    try:
        row = conn.execute(
            "SELECT * FROM pending_signals WHERE id=? AND username=? AND status='PENDING'",
            (int(sid), username),
        ).fetchone()
    finally:
        conn.close()

    if not row:
        try:
            set_last_msg(username, f"{E_X} Onaylanacak sinyal bulunamadÄ±")
        except Exception:
            pass
        return redirect("/")

    sig = dict(row)
    action = safe_str(sig.get("action")).strip().upper()
    symbol = safe_str(sig.get("symbol") or DEFAULT_SYMBOL).strip().upper()
    requested_usdt = _to_float(sig.get("requested_usdt"), 0.0)
    dry_run = int(sig.get("dry_run") or 0) == 1

    # payload_json iÃ§inden borsa bilgisi gelebilir (yoksa kullanÄ±cÄ± default)
    payload = {}
    try:
        payload = json.loads(safe_str(sig.get("payload_json") or "{}")) or {}
    except Exception:
        payload = {}

    u = get_user(username) or {}
    if u and not isinstance(u, dict):
        u = dict(u)
    # Trial / force_dry_run: GERÃ‡EK mod engellenir
    try:
        if int((u.get("force_dry_run") or 0)) == 1:
            dry_run = True
    except Exception:
        pass

    # Daily loss limit: Onayla'ya basÄ±nca popup gÃ¶ster
    dl_msg = daily_loss_block_msg(u)
    if dl_msg:
        session['popup_msg'] = dl_msg
        return redirect('/')


    exchange_id = safe_str(payload.get("exchange_id") or u.get("exchange_id") or DEFAULT_EXCHANGE).strip().upper()
    if not exchange_id:
        exchange_id = DEFAULT_EXCHANGE

    if action != "BUY":
        # Bu panel akÄ±ÅŸÄ±nda sadece BUY'Ä± pozisyona Ã§eviriyoruz.
        # (SELL sinyalleri panelde ayrÄ± flow ile yÃ¶netiliyor.)
        conn = db()
        try:
            conn.execute("UPDATE pending_signals SET status='APPROVED' WHERE id=? AND username=?", (int(sid), username))
            conn.commit()
        finally:
            conn.close()
        log_line(username, "INFO", f"Signal approved (non-BUY) id {sid} {action} {exchange_id} {symbol}")
        return redirect("/")

    if requested_usdt <= 0:
        try:
            set_last_msg(username, f"{E_X} BUY baÅŸarÄ±sÄ±z: Ä°stek miktarÄ± geÃ§ersiz")
        except Exception:
            pass
        return redirect("/")

    # DRY RUN'da gerÃ§ek emir yok: public fiyatla hesapla
    if dry_run:
        entry_price = 0.0
        try:
            entry_price = float(get_public_price(exchange_id, symbol) or 0.0)
        except Exception:
            entry_price = 0.0

        if entry_price <= 0:
            # fallback (UI patlamasÄ±n)
            entry_price = 100.0

        qty = (requested_usdt / entry_price) if entry_price > 0 else 0.0
        try:
            position_add(username, exchange_id, symbol, qty, entry_price, requested_usdt, True)
        except Exception:
            # eÄŸer position_add yoksa, DB insert fallback
            conn = db()
            try:
                conn.execute(
                    "INSERT INTO open_positions(username, exchange_id, symbol, qty, entry_price, entry_usdt, dry_run, created_at) "
                    "VALUES (?,?,?,?,?,?,?,?)",
                    (username, exchange_id, symbol, float(qty), float(entry_price), float(requested_usdt), 1, now_ts()),
                )
                conn.commit()
            finally:
                conn.close()

        conn = db()
        try:
            conn.execute("UPDATE pending_signals SET status='APPROVED' WHERE id=? AND username=?", (int(sid), username))
            conn.commit()
        finally:
            conn.close()

        log_line(username, "INFO", f"BUY approved DRY_RUN {exchange_id} {symbol} usdt={requested_usdt:.2f}")
        telegram_send_for_user(u, build_telegram_text("BUY", u, symbol, requested_usdt, True, {"mode": "MANUEL"}))
        try:
            pass
        except Exception:
            pass
        return redirect("/")

    # LIVE BUY: trade check + keys + place_order stub/real
    if not may_trade(u):
        try:
            set_last_msg(username, f"{E_STOP} Trade kapalÄ± veya limit dolu")
        except Exception:
            pass
        telegram_send_for_user(u, f"{E_STOP} Trade kapalÄ± veya limit dolu")
        return redirect("/")

    keys = _keys_for_exchange(u, exchange_id)
    res = place_order(exchange_id, "BUY", symbol, requested_usdt, False,
                      safe_str(keys.get("api_key")), safe_str(keys.get("api_secret")), safe_str(keys.get("api_passphrase")))

    if not (res or {}).get("ok"):
        reason = safe_str((res or {}).get("reason") or "Bilinmeyen hata")
        try:
            set_last_msg(username, f"{E_X} BUY baÅŸarÄ±sÄ±z: {reason}")
        except Exception:
            pass
        log_line(username, "WARN", f"{E_X} BUY baÅŸarÄ±sÄ±z: {reason}")
        telegram_send_for_user(u, f"{E_X} BUY baÅŸarÄ±sÄ±z: {reason}")
        return redirect("/")

    fill_price = _to_float((res or {}).get("fill_price"), 0.0)
    fill_qty = _to_float((res or {}).get("fill_qty"), 0.0)
    real_usdt = _to_float((res or {}).get("real_usdt"), requested_usdt)
    if real_usdt <= 0:
        real_usdt = requested_usdt

    buy_fee_usdt = _to_float((res or {}).get("fee_usdt"), 0.0)
    buy_fee_coin = _to_float((res or {}).get("fee_coin"), 0.0)
    buy_fee_coin_ccy = safe_str((res or {}).get("fee_coin_ccy") or "")
    buy_ord_id = safe_str((res or {}).get("ord_id") or "")

    # yeni pozisyon EKLE (overwrite yok)
    try:
        position_add(username, exchange_id, symbol, fill_qty, fill_price, real_usdt, False, buy_fee_usdt, buy_fee_coin, buy_fee_coin_ccy, buy_ord_id)
    except Exception:
        conn = db()
        try:
            conn.execute(
                "INSERT INTO open_positions(username, exchange_id, symbol, qty, entry_price, entry_usdt, dry_run, created_at) "
                "VALUES (?,?,?,?,?,?,?,?)",
                (username, exchange_id, symbol, float(fill_qty), float(fill_price), float(real_usdt), 0, now_ts()),
            )
            conn.commit()
        finally:
            conn.close()

    # pending'i approved yap
    conn = db()
    try:
        conn.execute("UPDATE pending_signals SET status='APPROVED' WHERE id=? AND username=?", (int(sid), username))
        conn.commit()
    finally:
        conn.close()

    # kullanÄ±m + trade log (LIVE'da artar)
    try:
        inc_usage(username)
    except Exception:
        pass

    try:
        conn = db()
        conn.execute(
            "INSERT INTO trades(username, exchange_id, action, symbol, real_usdt, pnl_usdt, dry_run, created_at) "
            "VALUES (?,?,?,?,?,?,?,?)",
            (username, exchange_id, "BUY", symbol, float(real_usdt), 0.0, 0, now_ts()),
        )
        conn.commit()
        conn.close()
    except Exception:
        pass

    log_line(username, "INFO", f"BUY approved LIVE {exchange_id} {symbol} usdt={real_usdt:.2f}")
    telegram_send_for_user(u, build_telegram_text("BUY", u, symbol, real_usdt, False, {"mode": "MANUEL"}))
    try:
        set_last_msg(username, f"{E_OK} BUY onaylandÄ± (GERÃ‡EK) {symbol}")
    except Exception:
        pass
    return redirect("/")


@app.route("/webhook", methods=["POST"], strict_slashes=False)
def webhook():
    data: Dict[str, Any] = {}
    if request.is_json:
        try:
            data = request.get_json(force=True) or {}
        except Exception:
            data = {}
    else:
        data = dict(request.form or {})

    # TradingView bazen payload'u 'alert_message' alanÄ±na string olarak yollar
    if isinstance(data, dict):
        am = data.get("alert_message") or data.get("message")
        if isinstance(am, str) and am.strip():
            s = am.strip()
            try:
                j = json.loads(s)
                if isinstance(j, dict):
                    data = j
            except Exception:
                pass

    username = safe_str(data.get("username") or data.get("user")).strip()
    action = safe_str(data.get("action") or data.get("side")).strip().upper()
    symbol = safe_str(data.get("symbol") or data.get("pair") or DEFAULT_SYMBOL).strip().upper()

    exchange_id = safe_str(data.get("exchange") or data.get("exchange_id") or "").strip().upper()
    if exchange_id not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
        exchange_id = ""

    provided_secret = safe_str(data.get("secret") or data.get("webhook_secret")).strip()

    if not username or action not in ("BUY", "SELL"):
        return jsonify({"ok": False, "error": "Bad payload"}), 400

    u = get_user(username)
    if not u:
        return jsonify({"ok": False, "error": "Unknown user"}), 404

    if not exchange_id:
        exchange_id = safe_str(u.get("exchange_id") or DEFAULT_EXCHANGE).strip().upper()
        if exchange_id not in ("OKX", "BINANCE", "GATEIO", "BYBIT"):
            exchange_id = "OKX"


        # Trial expiry enforcement
    u = enforce_trial_expiry(username, u)

# AUTO regime gate (AUTO sinyallerini filtreler)
    flow = safe_str(data.get("flow") or data.get("mode") or data.get("trade_mode") or data.get("auto") or "")
    is_manual = safe_str(data.get("manual") or "").strip().lower() in ("1", "true", "on", "yes")
    is_auto = (not is_manual) and (flow.strip().upper() in ("AUTO", "1", "TRUE", "ON", "") )

    # AUTO regime gate sadece BUY iÃ§in geÃ§erli, SELL her zaman serbest
    if AUTO_REGIME_ENABLED and is_auto and action != "SELL":
        gg = get_auto_gate(username)
        if int((gg or {}).get("gate") or 0) != 1:
            reason = safe_str((gg or {}).get("reason") or "AUTO gate kapalÄ±")
            set_last_msg(username, f"{E_STOP} AUTO kapalÄ± â€¢ {reason}")
            return jsonify({"ok": False, "blocked": True, "reason": reason}), 200


    user_secret = safe_str(u.get("webhook_secret") or "").strip()
    secret_ok = False
    if user_secret and provided_secret and provided_secret == user_secret:
        secret_ok = True
    elif WEBHOOK_SECRET and provided_secret and provided_secret == WEBHOOK_SECRET:
        secret_ok = True
    else:
        if not user_secret and not WEBHOOK_SECRET:
            secret_ok = True

    if not secret_ok:
        try:
            ip = request.headers.get("X-Real-IP") or request.remote_addr or ""
            _log("WEBHOOK UNAUTHORIZED | user=%s | ip=%s | provided_len=%s", username, ip, len(provided_secret or ""))
        except Exception:
            pass
        return jsonify({"ok": False, "error": "Unauthorized secret mismatch"}), 401

    # AynÄ± saniyede BUYâ†’SELL gelirse (TV alarm/strategy), OKX senkronu iÃ§in kÄ±sa debounce uygula
    k = f"{username}|{exchange_id}|{symbol}"
    now_ts = time.time()
    if action == "SELL":
        last_buy = _LAST_BUY_TS.get(k)
        if last_buy and (now_ts - last_buy) < SELL_DEBOUNCE_SEC:
            wait_s = max(0.0, SELL_DEBOUNCE_SEC - (now_ts - last_buy))
            if wait_s > 0:
                try:
                    log_line(username, "INFO", f"SELL debounce bekleme {wait_s:.2f}s {exchange_id} {symbol}")
                except Exception:
                    pass
                time.sleep(wait_s)
    else:
        # BUY geldiÄŸinde timestamp kaydet
        _LAST_BUY_TS[k] = now_ts

    # - Global DRY_RUN=1 ise her zaman dry_run
    # - Payload iÃ§inde test flag varsa dry_run zorla
    p_mode = (payload.get("mode") or payload.get("Mod") or "").strip().upper()
    p_test = bool(payload.get("test") or payload.get("test_mode") or payload.get("dry_run"))

    symbol = canon_symbol(symbol)

    auto_row = auto_get_enabled_match(username, exchange_id, symbol)
    # HOTFIX: REAL AUTO uses auto_trades amount (UI Bekleyen Auto Ä°ÅŸlemlerim)
    try:
        mode_s = "real" if str((u.get("account_mode") or u.get("mode") or "")).upper() in ("REAL","LIVE") else "demo"
        if (not auto_row) or float((auto_row or {}).get("usdt") or 0.0) <= 0:
            conn2 = db()
            try:
                row2 = conn2.execute(
                    "SELECT id, amount FROM auto_trades "
                    "WHERE user_id=? AND COALESCE(symbol,coin)=? AND (deleted=0 OR deleted IS NULL) "
                    "AND lower(COALESCE(mode,'demo'))=? "
                    "ORDER BY id DESC LIMIT 1",
                    (int(u.get("id") or 0), symbol, mode_s),
                ).fetchone()
                if row2:
                    if isinstance(row2, tuple):
                        trade_id = int(row2[0] or 0)
                        amt = float(row2[1] or 0.0)
                    else:
                        drow = dict(row2)
                        trade_id = int(drow.get("id") or 0)
                        amt = float(drow.get("amount") or 0.0)

                    auto_row = {"usdt": float(amt)}

                    # bu bekleyen auto isteÄŸini tÃ¼ket (tekrar kullanÄ±lmasÄ±n)
                    try:
                        if trade_id:
                            conn2.execute("UPDATE auto_trades SET active=0, status='used', deleted=1 WHERE id=?", (trade_id,))
                            conn2.commit()
                    except Exception:
                        pass
            finally:
                try: conn2.close()
                except Exception: pass
    except Exception:
        pass

    if not auto_row:
        log_line(username, "WARN", f"{E_BOT} AUTO kapalÄ±: {exchange_id} {symbol}")
        return jsonify({"ok": False, "error": "AUTO kapalÄ±"}), 200

    try:
        requested_usdt = float(auto_row.get("usdt") or 0.0)
    except Exception:
        requested_usdt = 0.0

    # TÃ¼m bakiye modu (usdt=-1): OKX'te anlÄ±k USDT serbest bakiye ile al
    if requested_usdt < 0:
        if exchange_id == "OKX":
            keys = _keys_for_exchange(u, exchange_id)
            bal = 0.0
            try:
                bal = float(okx_get_asset_balance("USDT",
                                                  safe_str(keys.get("api_key")),
                                                  safe_str(keys.get("api_secret")),
                                                  safe_str(keys.get("api_passphrase"))))
            except Exception:
                bal = 0.0
            # kÃ¼Ã§Ã¼k buffer bÄ±rak (komisyon / yuvarlama)
            requested_usdt = max(0.0, bal - 1.0)
        else:
            requested_usdt = float(DEFAULT_USDT)

    if requested_usdt <= 0:
        requested_usdt = float(DEFAULT_USDT)

    payload = dict(data)
    payload["received_at"] = iso_now_local()
    payload["exchange_id"] = exchange_id
    payload["auto_usdt"] = requested_usdt
    # AUTO sinyali: beklemeye alma YOK â€” direkt Ã§alÄ±ÅŸtÄ±r
    if action == "BUY":
        # LIVE modda yetki kontrolÃ¼
        if not may_trade(u):
            log_line(username, "WARN", f"{E_STOP} AUTO BUY engellendi: trade kapalÄ±/limit dolu")
            return jsonify({"ok": False, "error": "Trade kapalÄ±/limit dolu"}), 200

        keys = _keys_for_exchange(u, exchange_id)
        res = place_order(exchange_id, "BUY", symbol, requested_usdt, False,
                          safe_str(keys.get("api_key")), safe_str(keys.get("api_secret")), safe_str(keys.get("api_passphrase")))

        if not (res or {}).get("ok"):
            reason = safe_str((res or {}).get("reason") or "Bilinmeyen hata")
            log_line(username, "WARN", f"{E_X} AUTO BUY baÅŸarÄ±sÄ±z: {reason}")
            return jsonify({"ok": False, "error": reason}), 200

        fill_price = _to_float((res or {}).get("fill_price"), 0.0)
        fill_qty = _to_float((res or {}).get("fill_qty"), 0.0)
        real_usdt = _to_float((res or {}).get("real_usdt"), requested_usdt)

        buy_fee_usdt = _to_float((res or {}).get("fee_usdt"), 0.0)
        buy_fee_coin = _to_float((res or {}).get("fee_coin"), 0.0)
        buy_fee_coin_ccy = safe_str((res or {}).get("fee_coin_ccy") or "")
        buy_ord_id = safe_str((res or {}).get("ord_id") or "")

        if fill_price <= 0:
            try:
                fill_price = float(get_public_price(exchange_id, symbol) or 0.0)
            except Exception:
                fill_price = 0.0
            if fill_price <= 0:
                fill_price = 100.0
        if fill_qty <= 0 and fill_price > 0:
            fill_qty = real_usdt / fill_price

        # her BUY ayrÄ± pozisyon
        try:
            position_add(username, exchange_id, symbol, float(fill_qty), float(fill_price), float(real_usdt), False, buy_fee_usdt, buy_fee_coin, buy_fee_coin_ccy, buy_ord_id)
        except Exception:
            conn = db()
            try:
                conn.execute(
                    "INSERT INTO open_positions(username, exchange_id, symbol, qty, entry_price, entry_usdt, dry_run, created_at) "
                    "VALUES (?,?,?,?,?,?,?,?)",
                    (username, exchange_id, symbol, float(fill_qty), float(fill_price), float(real_usdt), 0, now_ts()),
                )
                conn.commit()
            finally:
                conn.close()

        # kullanÄ±m + trades (AUTO da GERÃ‡EK sayÄ±lÄ±r)
        try:
            inc_usage(username)
        except Exception:
            pass

        try:
            conn = db()
            conn.execute(
                "INSERT INTO trades(username, exchange_id, action, symbol, real_usdt, pnl_usdt, dry_run, created_at) "
                "VALUES (?,?,?,?,?,?,?,?)",
                (username, exchange_id, "BUY", symbol, float(real_usdt), 0.0, 0, now_ts()),
            )
            conn.commit()
            conn.close()
        except Exception:
            pass

        log_line(username, "INFO", f"{E_BOT} AUTO BUY Ã§alÄ±ÅŸtÄ±: {exchange_id} {symbol} usdt={real_usdt:.2f} ord={safe_str((res or {}).get('ord_id') or '')}")
        telegram_send_for_user(u, build_telegram_text("BUY", u, symbol, real_usdt, False, {"mode": "AUTO"}))
        return jsonify({"ok": True, "executed": True})

    # AUTO SELL: stack pozisyonu kapatÄ±r. Trend gÃ¼Ã§lÃ¼ ise SELL DEFER'e alÄ±r.
    if action == "SELL":
        dec = _auto_sell_defer_should_queue(username, exchange_id, symbol)
        if bool((dec or {}).get("defer")):
            reason = safe_str((dec or {}).get("reason") or "Trend gÃ¼Ã§lÃ¼")
            queued = _auto_sell_defer_enqueue(username, exchange_id, symbol, reason)
            try:
                if queued:
                    log_line(username, "INFO", f"AUTO SELL DEFER kuyruÄŸa alÄ±ndÄ±: {exchange_id} {symbol} â€¢ {reason}")
                else:
                    log_line(username, "INFO", f"AUTO SELL DEFER zaten kuyrukta: {exchange_id} {symbol}")
            except Exception:
                pass
            return jsonify({"ok": True, "queued": True, "reason": reason}), 200

        # Trend zayÄ±f/yatay: SELL INSTANT
        res = _auto_sell_execute_now(username, u, exchange_id, symbol)
        if not bool((res or {}).get("ok")):
            err = safe_str((res or {}).get("error") or "SELL baÅŸarÄ±sÄ±z")
            try:
                log_line(username, "WARN", f"{E_X} AUTO SELL baÅŸarÄ±sÄ±z: {exchange_id} {symbol} {err}")
            except Exception:
                pass
            return jsonify({"ok": False, "error": err}), 200
        return jsonify({"ok": True, "executed": True}), 200

    return jsonify({"ok": False, "error": "Bad action"}), 400


@app.post("/admin/users/<username>/toggle-trade")
def admin_user_toggle_trade(username: str):
    rr = require_admin()
    if rr:
        return rr

    u = get_user(username)
    if not u:
        return redirect("/admin")

    cur = 1 if int(u.get("trade_enabled") or 0) == 1 else 0
    newv = 0 if cur == 1 else 1

    conn = db()
    try:
        conn.execute(
            "UPDATE users SET trade_enabled=? WHERE username=?",
            (newv, username)
        )
        conn.commit()
    finally:
        conn.close()

    log_line("admin", "INFO", f"Trade toggled for {username} -> {newv}")
    return redirect("/admin")

@app.get("/admin/new-user")
def admin_new_user_get():
    rr = require_admin()
    if rr:
        return rr

    pkg_opts = ""
    for p in PACKAGES:
        lim = int(p["limit"])
        lim_txt = "âˆ" if lim < 0 else str(lim)
        price = int(p.get("price_try", 0) or 0)
        pkg_opts += f'<option value="{p["name"]}">{p["name"]}  {price:,} TL  /  {lim_txt} kullanÄ±m</option>'

    months_opts = "".join([f'<option value="{m}">{m} ay</option>' for m in range(1, 13)])

    body = f"""
<div class="card">
  <h2>{E_PLUS} Yeni KullanÄ±cÄ±</h2>
  <div class="muted">Borsa, API ve Telegram Chat ID alanlarÄ± hazÄ±r</div>
  <div class="hr"></div>

  <form method="post" action="/admin/new-user">
    <div class="row">
      <div>
        <label>KullanÄ±cÄ± adÄ±</label>
        <input class="input" name="username" required>
      </div>
      <div>
        <label>GÃ¶rÃ¼nen ad</label>
        <input class="input" name="display_name" placeholder="Atalay">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Åifre</label>
        <input class="input" type="password" name="password" required>
      </div>
      <div>
        <label>Borsa</label>
        <select name="exchange_id">
          {exchange_select_options("OKX")}
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Paket</label>
        <select name="package_name">{pkg_opts}</select>
      <div style="margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <div style="font-weight:800">ğŸ§ª Deneme</div>
        </div>
        <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap">
          <label class="chk"><input type="radio" name="trial_mode" value="none" checked> <span>KapalÄ±</span></label>
          <label class="chk"><input type="radio" name="trial_mode" value="paid1d"> <span>Ãœcretli (LIVE 1 GÃ¼n)</span></label>
        </div>

      </div>
      </div>
      <div>
        <label>Paket sÃ¼resi</label>
        <select name="package_months">{months_opts}</select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Webhook secret</label>
        <input class="input" name="webhook_secret" placeholder="secret">
      </div>
      <div>
        <label>Telegram Chat ID</label>
        <input class="input" name="telegram_chat_id" placeholder="2057615710">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Kontroller</label>
        <div class="inline">
          <span class="muted">Trade</span>
          <label class="switch"><input type="checkbox" name="trade_enabled" checked><span class="slider"></span></label>
          <span class="muted">Limit dolunca kapat</span>
          <label class="switch"><input type="checkbox" name="disable_on_limit" checked><span class="slider"></span></label>
        </div>
      </div>
      <div>
        <label>Not</label>
        <input class="input" value="Telegram Chat ID boÅŸsa global chat id kullanÄ±lÄ±r" disabled>
      </div>
    </div>

    <div class="hr"></div>
    <h2>{E_LOCK} API Bilgileri</h2>
    <div class="muted">OKX alanlarÄ± zorunlu, diÄŸerleri opsiyonel</div>

    <div class="row">
      <div>
        <label>OKX API Key</label>
        <input class="input" name="api_key" placeholder="okx api key">
      </div>
      <div>
        <label>OKX API Secret</label>
        <input class="input" name="api_secret" placeholder="okx api secret">
      </div>
    </div>

    <div class="row">
      <div>
        <label>OKX API Åifre</label>
        <input class="input" name="api_passphrase" placeholder="okx passphrase">
      </div>
      <div>
        <label>Bilgi</label>
        <input class="input" value="OKX zorunlu, diÄŸerleri istersen ekle" disabled>
      </div>
    </div>

    <div class="hr"></div>
    <div class="muted" style="font-weight:900">Binance</div>
    <div class="row">
      <div>
        <label>Binance API Key</label>
        <input class="input" name="binance_api_key" value="">
      </div>
      <div>
        <label>Binance API Secret</label>
        <input class="input" name="binance_api_secret" value="">
      </div>
    </div>

    <div class="muted" style="font-weight:900">Bybit</div>
    <div class="row">
      <div>
        <label>Bybit API Key</label>
        <input class="input" name="bybit_api_key" value="">
      </div>
      <div>
        <label>Bybit API Secret</label>
        <input class="input" name="bybit_api_secret" value="">
      </div>
    </div>

    <div class="muted" style="font-weight:900">Gate.io</div>
    <div class="row">
      <div>
        <label>Gate API Key</label>
        <input class="input" name="gate_api_key" value="">
      </div>
      <div>
        <label>Gate API Secret</label>
        <input class="input" name="gate_api_secret" value="">
      </div>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" type="submit">{E_OK} OluÅŸtur</button>
      <a class="btn secondary" href="/admin">{E_BACK} Geri</a>
    </div>
  </form>
</div>
"""
    return base_html("Yeni KullanÄ±cÄ±", body, nav_html(True))


@app.post("/admin/new-user")
def admin_new_user_post():
    rr = require_admin()
    if rr:
        return rr

    username = safe_str(request.form.get("username"))
    display_name = safe_str(request.form.get("display_name"))
    password = safe_str(request.form.get("password"))

    exchange_id = safe_str(request.form.get("exchange_id") or DEFAULT_EXCHANGE).upper()
    webhook_secret = safe_str(request.form.get("webhook_secret"))
    telegram_chat_id = safe_str(request.form.get("telegram_chat_id"))

    package_name = safe_str(request.form.get("package_name") or "Basic")
    try:
        months = int(safe_str(request.form.get("package_months") or "1"))
    except Exception:
        months = 1
    months = max(1, min(12, months))

    trial_mode = safe_str(request.form.get("trial_mode") or "none").strip().lower()
    is_trial = (trial_mode in ("free","paid1d"))
    trial_real_1d = (trial_mode == "paid1d")

    trade_enabled = 1 if request.form.get("trade_enabled") == "on" else 0
    disable_on_limit = 1 if request.form.get("disable_on_limit") == "on" else 0

    # OKX (zorunlu)
    api_key = safe_str(request.form.get("api_key"))
    api_secret = safe_str(request.form.get("api_secret"))
    api_passphrase = safe_str(request.form.get("api_passphrase"))

    # opsiyonel
    binance_api_key = safe_str(request.form.get("binance_api_key"))
    binance_api_secret = safe_str(request.form.get("binance_api_secret"))
    bybit_api_key = safe_str(request.form.get("bybit_api_key"))
    bybit_api_secret = safe_str(request.form.get("bybit_api_secret"))
    gate_api_key = safe_str(request.form.get("gate_api_key"))
    gate_api_secret = safe_str(request.form.get("gate_api_secret"))

    if not username or not password:
        return redirect("/admin/new-user")

    if exchange_id not in [x[0] for x in EXCHANGES]:
        return redirect("/admin/new-user")

    if get_user(username):
        return redirect("/admin/new-user")

    salt = secrets.token_hex(16)
    pw_hash = hash_password(password, salt)

    force_dry_run = 0
    trial_real_enabled = 0
    trial_expires_at = 0
    
    if is_trial or trial_real_1d:
        package_name = "Trial"
        trial_limit = int(os.getenv("TRIAL_LIMIT", "30") or "30")
        pkg_limit = trial_limit
        # Normal Trial: DRY RUN. LIVE Trial: 1 gÃ¼n gerÃ§ek iÅŸlem.
        if trial_real_1d:
            expires_at = now_ts() + int(1 * 24 * 3600)
            force_dry_run = 0
            trial_real_enabled = 1
            trial_expires_at = expires_at
        else:
            trial_days = int(os.getenv("TRIAL_DAYS", "3") or "3")
            expires_at = now_ts() + int(trial_days * 24 * 3600)
            force_dry_run = 1
        trade_enabled = 1
        disable_on_limit = 1

    else:
        pkg_limit = package_limit_for(package_name)
        expires_at = now_ts() + int(months * 30 * 24 * 3600)

    conn = db()
    try:
        conn.execute("""
            INSERT INTO users
            (username, display_name, salt, password_hash, is_admin,
             trade_enabled, disable_on_limit, exchange_id, webhook_secret,
             package_name, package_limit, package_months, expires_at, force_dry_run, trial_real_enabled, trial_expires_at,
             api_key, api_secret, api_passphrase, telegram_chat_id,
             binance_api_key, binance_api_secret,
             bybit_api_key, bybit_api_secret,
             gate_api_key, gate_api_secret,
             total_pnl, created_at)
            VALUES (?,?,?,?,0,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,0.0,?)
        """, (
            username, display_name, salt, pw_hash,
            trade_enabled, disable_on_limit, exchange_id, webhook_secret,
            package_name, pkg_limit, months, expires_at, force_dry_run, trial_real_enabled, trial_expires_at,
            api_key, api_secret, api_passphrase, telegram_chat_id,
            binance_api_key, binance_api_secret,
            bybit_api_key, bybit_api_secret,
            gate_api_key, gate_api_secret,
            now_ts()
        ))

        conn.execute(
            "INSERT OR IGNORE INTO usage (username, used_count, updated_at) VALUES (?,0,?)",
            (username, now_ts())
        )

        conn.commit()
    finally:
        conn.close()

    log_line("admin", "INFO", f"User created {username}")
    return redirect("/admin")

@app.get("/admin/users/<username>")
def admin_user_edit_get(username: str):
    rr = require_admin()
    if rr:
        return rr

    u = get_user(username)
    if not u:
        return redirect("/admin")

    pkg_opts = ""
    for p in PACKAGES:
        lim = p["limit"]
        lim_txt = "âˆ" if lim < 0 else str(lim)
        sel = "selected" if safe_str(u["package_name"]) == p["name"] else ""
        pkg_opts += f'<option value="{p["name"]}" {sel}>{p["name"]}  {lim_txt} kullanÄ±m</option>'

    months_opts = ""
    for m in range(1, 13):
        sel = "selected" if int(u["package_months"]) == m else ""
        months_opts += f'<option value="{m}" {sel}>{m} ay</option>'

    trade_checked = "checked" if int(u["trade_enabled"]) == 1 else ""
    dolunca_checked = "checked" if int(u["disable_on_limit"]) == 1 else ""

    expires_s = (datetime.utcfromtimestamp(int(u["expires_at"] or 0)) + timedelta(hours=TZ_OFFSET_HOURS)).strftime("%Y-%m-%d")

    def esc(v: str) -> str:
        return safe_str(v).replace('"', "").replace("<", "").replace(">", "")

    body = f"""
<div class="card">
  <h2>{E_EDIT} KullanÄ±cÄ± DÃ¼zenle</h2>
  <div class="muted">Borsa seÃ§enekleri OKX Binance Bybit Gateio</div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
      <form method="post" action="/admin/users/{u['username']}/extend" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <label>SÃ¼re uzat (gÃ¼n)</label>
          <input class="input" name="days" inputmode="numeric" placeholder="Ã–rn: 30" style="max-width:160px">
        </div>
        <button class="btn" type="submit">{E_TIME} Uzat</button>
      </form>
    </div>

  <div class="hr"></div>

  <form method="post" action="/admin/users/{u['username']}/update">
    <div class="row">
      <div>
        <label>KullanÄ±cÄ± adÄ±</label>
        <input class="input" value="{u['username']}" disabled>
      </div>
      <div>
        <label>GÃ¶rÃ¼nen ad</label>
        <input class="input" name="display_name" value="{esc(u['display_name'])}">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Yeni ÅŸifre</label>
        <input class="input" name="new_password" type="password" placeholder="BoÅŸ bÄ±rakÄ±lÄ±rsa deÄŸiÅŸmez">
      </div>
      <div>
        <label>Borsa</label>
        <select name="exchange_id">
          {exchange_select_options(safe_str(u["exchange_id"]))}
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Paket</label>
        <select name="package_name">{pkg_opts}</select>
      </div>
      <div>
        <label>Paket sÃ¼resi</label>
        <select name="package_months">{months_opts}</select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Webhook secret</label>
        <input class="input" name="webhook_secret" value="{esc(u['webhook_secret'])}">
      </div>
      <div>
        <label>Telegram Chat ID</label>
        <input class="input" name="telegram_chat_id" value="{esc(u['telegram_chat_id'])}">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Kontroller</label>
        <div class="inline">
          <span class="muted">Trade</span>
          <label class="switch"><input type="checkbox" name="trade_enabled" {trade_checked}><span class="slider"></span></label>
          <span class="muted">Limit dolunca kapat</span>
          <label class="switch"><input type="checkbox" name="disable_on_limit" {dolunca_checked}><span class="slider"></span></label>
        </div>
      </div>
      <div>
        <label>Durum</label>
        <input class="input" value="KullanÄ±m {format_usage_badge(u)}   BitiÅŸ {expires_s}   KÃ¢r {float(u['total_pnl'] or 0.0):.4f} USDT" disabled>
      </div>
    </div>

    <div class="hr"></div>
    <h2>{E_LOCK} API Bilgileri</h2>
    <div class="muted">OKX zorunlu, diÄŸerleri opsiyonel</div>

    <div class="row">
      <div>
        <label>OKX API Key</label>
        <input class="input" name="api_key" value="{esc(u.get('api_key',''))}">
      </div>
      <div>
        <label>OKX API Secret</label>
        <input class="input" name="api_secret" value="{esc(u.get('api_secret',''))}">
      </div>
    </div>

    <div class="row">
      <div>
        <label>OKX API Åifre</label>
        <input class="input" name="api_passphrase" value="{esc(u.get('api_passphrase',''))}">
      </div>
      <div>
        <label>Bilgi</label>
        <input class="input" value="OKX alanlarÄ± dolu olmalÄ±" disabled>
      </div>
    </div>

    <div class="hr"></div>
    <div class="muted" style="font-weight:900">Binance</div>
    <div class="row">
      <div>
        <label>Binance API Key</label>
        <input class="input" name="binance_api_key" value="{esc(u.get('binance_api_key',''))}">
      </div>
      <div>
        <label>Binance API Secret</label>
        <input class="input" name="binance_api_secret" value="{esc(u.get('binance_api_secret',''))}">
      </div>
    </div>

    <div class="muted" style="font-weight:900">Bybit</div>
    <div class="row">
      <div>
        <label>Bybit API Key</label>
        <input class="input" name="bybit_api_key" value="{esc(u.get('bybit_api_key',''))}">
      </div>
      <div>
        <label>Bybit API Secret</label>
        <input class="input" name="bybit_api_secret" value="{esc(u.get('bybit_api_secret',''))}">
      </div>
    </div>

    <div class="muted" style="font-weight:900">Gate.io</div>
    <div class="row">
      <div>
        <label>Gate API Key</label>
        <input class="input" name="gate_api_key" value="{esc(u.get('gate_api_key',''))}">
      </div>
      <div>
        <label>Gate API Secret</label>
        <input class="input" name="gate_api_secret" value="{esc(u.get('gate_api_secret',''))}">
      </div>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" type="submit">{E_SAVE} Kaydet</button>
      <a class="btn secondary" href="/admin">{E_BACK} Geri</a>
    </div>
  </form>

  <div class="hr"></div>
  <form method="post" action="/admin/users/{u['username']}/delete" onsubmit="return confirm('KullanÄ±cÄ± silinsin')">
    <button class="btn danger" type="submit">{E_TRASH} KullanÄ±cÄ±yÄ± Sil</button>
  </form>
</div>
"""
    return base_html("KullanÄ±cÄ± DÃ¼zenle", body, nav_html(True))


@app.post("/admin/users/<username>/update")
def admin_user_update(username: str):
    rr = require_admin()
    if rr:
        return rr

    u = get_user(username)
    if not u:
        return redirect("/admin")
    old_tg = ""
    try:
        c2 = db()
        r2 = c2.execute("SELECT telegram_chat_id FROM users WHERE username=?", (username,)).fetchone()
        if r2:
            try:
                old_tg = safe_str(r2["telegram_chat_id"])
            except Exception:
                old_tg = safe_str(r2[0])
        c2.close()
    except Exception:
        try:
            c2.close()
        except Exception:
            pass
        old_tg = ""


    display_name = safe_str(request.form.get("display_name"))
    exchange_id = safe_str(request.form.get("exchange_id") or DEFAULT_EXCHANGE).upper()
    webhook_secret = safe_str(request.form.get("webhook_secret"))
    telegram_chat_id = safe_str(request.form.get("telegram_chat_id"))

    package_name = safe_str(request.form.get("package_name") or safe_str(u["package_name"]) or "Basic")
    try:
        months = int(safe_str(request.form.get("package_months") or u["package_months"]))
    except Exception:
        months = int(u["package_months"] or 1)
    months = max(1, min(12, months))

    trade_enabled = 1 if request.form.get("trade_enabled") == "on" else 0
    disable_on_limit = 1 if request.form.get("disable_on_limit") == "on" else 0

    # OKX
    api_key = safe_str(request.form.get("api_key"))
    api_secret = safe_str(request.form.get("api_secret"))
    api_passphrase = safe_str(request.form.get("api_passphrase"))

    # DiÄŸer 3 borsa
    binance_api_key = safe_str(request.form.get("binance_api_key"))
    binance_api_secret = safe_str(request.form.get("binance_api_secret"))
    bybit_api_key = safe_str(request.form.get("bybit_api_key"))
    bybit_api_secret = safe_str(request.form.get("bybit_api_secret"))
    gate_api_key = safe_str(request.form.get("gate_api_key"))
    gate_api_secret = safe_str(request.form.get("gate_api_secret"))

    new_password = safe_str(request.form.get("new_password"))

    if exchange_id not in [x[0] for x in EXCHANGES]:
        exchange_id = safe_str(u["exchange_id"]).upper() or DEFAULT_EXCHANGE

    pkg_limit = package_limit_for(package_name)
    expires_at = now_ts() + int(months * 30 * 24 * 3600)

    conn = db()
    try:
        conn.execute("""
            UPDATE users SET
              display_name=?,
              exchange_id=?,
              webhook_secret=?,
              telegram_chat_id=?,
              package_name=?,
              package_limit=?,
              package_months=?,
              expires_at=?,
              trade_enabled=?,
              disable_on_limit=?,
              api_key=?,
              api_secret=?,
              api_passphrase=?,
              binance_api_key=?,
              binance_api_secret=?,
              bybit_api_key=?,
              bybit_api_secret=?,
              gate_api_key=?,
              gate_api_secret=?
            WHERE username=?
        """, (
            display_name, exchange_id, webhook_secret, telegram_chat_id,
            package_name, pkg_limit, months, expires_at,
            trade_enabled, disable_on_limit,
            api_key, api_secret, api_passphrase,
            binance_api_key, binance_api_secret,
            bybit_api_key, bybit_api_secret,
            gate_api_key, gate_api_secret,
            username
        ))

        if new_password:
            salt = secrets.token_hex(16)
            pw_hash = hash_password(new_password, salt)
            conn.execute("UPDATE users SET salt=?, password_hash=? WHERE username=?",
                         (salt, pw_hash, username))

        conn.commit()
    finally:
        conn.close()
            # Telegram baÄŸlantÄ± testi (SADECE kullanÄ±cÄ± DM)
    try:
        new_tg = safe_str(telegram_chat_id)
        if new_tg and new_tg != safe_str(old_tg):
            test_msg = "\n".join([
                f"{E_OK} Telegram baÄŸlantÄ±sÄ± test edildi",
                f"{E_USER} {safe_str(display_name) or safe_str(username)}",
                f"{E_TIME} {iso_now_local()}",
            ])
            telegram_send_to(new_tg, test_msg)
            log_line("admin", "INFO", f"Telegram test DM sent user={username} chat_id={new_tg}")
    except Exception as e:
        try:
            log_line("admin", "WARN", f"Telegram test DM failed user={username} err={e}")
        except Exception:
            pass


    log_line("admin", "INFO", f"User updated {username}")
    return redirect(f"/admin/users/{username}")


@app.post("/admin/users/<username>/delete")
def admin_user_delete(username: str):
    rr = require_admin()
    if rr:
        return rr

    if username.strip().lower() == "admin":
        return redirect("/admin")

    conn = db()
    try:
        for tbl in ("pending_signals", "usage", "logs", "trades", "auto_rules"):
            try:
                conn.execute(f"DELETE FROM {tbl} WHERE username=?", (username,))
            except Exception:
                pass
        conn.execute("DELETE FROM users WHERE username=?", (username,))
        conn.commit()
    finally:
        conn.close()

    log_line("admin", "INFO", f"User deleted {username}")
    return redirect("/admin")


# Old admin route - redirect to new admin dashboard
@app.get("/admin-old")
def admin_home():
    rr = require_admin()
    if rr:
        return rr

    conn = db()
    users = conn.execute("SELECT * FROM users ORDER BY created_at DESC").fetchall()
    total_pnl = conn.execute("SELECT COALESCE(SUM(total_pnl),0.0) AS s FROM users").fetchone()["s"]
    pending_count = conn.execute("SELECT COUNT(1) AS c FROM pending_signals WHERE status='PENDING'").fetchone()["c"]
    conn.close()

    current_mode = get_global_auto_mode()
    g = get_auto_gate(session.get("username") or "") if AUTO_REGIME_ENABLED else {"gate": 1, "mode": current_mode, "reason": ""}
    gate_v = int((g or {}).get("gate") or 0)
    gate_reason = safe_str((g or {}).get("reason") or "")

    body = f"""
<div class="kpi">
  <div class="box"><div class="k">Toplam KullanÄ±cÄ±</div><div class="v">{E_PPL} {len(users)}</div></div>
  <div class="box"><div class="k">Bekleyen Sinyal</div><div class="v">{E_MAIL} {int(pending_count)}</div></div>
  <div class="box"><div class="k">Toplam KÃ¢r</div><div class="v">{E_UP} {float(total_pnl):.4f} USDT</div></div>
</div>
<div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
  <a class="btn" href="/admin/new-user">{E_PLUS} Yeni KullanÄ±cÄ±</a>
  <a class="btn secondary" href="/admin/logs">{E_LOGS} Logs</a>
</div>
<div class="card" style="margin-top:16px">
  <h2>ğŸ”¥ Global AUTO Mod</h2>
  <div class="muted">Sadece admin deÄŸiÅŸtirir. KullanÄ±cÄ±lar sadece gÃ¶rÃ¼r.</div>
  <div class="hr"></div>
  <form method="post" action="/admin/settings/auto-mode" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0">
    <select name="auto_mode" class="input" style="max-width:240px">
      <option value="HARD" {'selected' if current_mode=='HARD' else ''}>ğŸ§Š HARD (daha seÃ§ici)</option>
      <option value="NORMAL" {'selected' if current_mode=='NORMAL' else ''}>âœ… NORMAL</option>
      <option value="AGGRESSIVE" {'selected' if current_mode=='AGGRESSIVE' else ''}>ğŸ”¥ AGRESÄ°F (daha sÄ±k)</option>
    </select>
    <button class="btn" type="submit">{E_SAVE} Kaydet</button>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span class="badge {'good' if gate_v==1 else 'bad'}">{E_ON if gate_v==1 else E_OFF} Gate {'ON' if gate_v==1 else 'OFF'}</span>
      <span class="badge">{E_TIME} {current_mode}</span>
    </div>
  </form>
  <div class="muted small" style="margin-top:10px">{safe_str(gate_reason) if gate_reason else ''}</div>
</div>

<div class="hr"></div>


<div class="card" style="margin-top:16px">
  <h2>{E_PPL} KullanÄ±cÄ±lar</h2>
  <div class="muted">Trade, paket, borsa, API, Telegram yÃ¶netimi</div>
  <div class="hr"></div>
  <table class="table">
    <thead>
      <tr>
        <th>KullanÄ±cÄ±</th><th>Borsa</th><th>Paket</th><th>KullanÄ±m</th><th>Trade</th><th>KÃ¢r</th><th>Ä°ÅŸlem</th>
      </tr>
    </thead>
    <tbody>
"""
    rows = ""
    for u in users:
        badge = format_usage_badge(u)
        trade = int(u["trade_enabled"] or 0) == 1

        trade_btn = f"""
<form method="post" action="/admin/users/{u["username"]}/toggle-trade" style="display:inline">
  <button class="btn {'good' if trade else 'danger'}" type="submit">
    {E_ON if trade else E_OFF} {'ON' if trade else 'OFF'}
  </button>
</form>
"""

        rows += f"""
<tr class="tr">
  <td><b>{u["username"]}</b><div class="muted small">{safe_str(u["display_name"])}</div></td>
  <td>{safe_str(u["exchange_id"]).upper()}</td>
  <td>{safe_str(u["package_name"])}<div class="muted small">{int(u["package_months"])} ay</div></td>
  <td>{badge}</td>
  <td>{trade_btn}</td>
  <td>{float(u["total_pnl"] or 0.0):.4f}</td>
  <td style="display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn secondary" href="/admin/users/{u["username"]}">{E_EDIT} DÃ¼zenle</a>
  </td>
</tr>
"""

    body += rows or '<tr class="tr"><td colspan="7"><div class="muted">KullanÄ±cÄ± yok</div></td></tr>'
    body += "</tbody></table></div>"
    # ---- Contracts section ----
    try:
        conn = db()
        try:
            cs = conn.execute("SELECT * FROM contracts ORDER BY accepted_at DESC LIMIT 200").fetchall()
        finally:
            conn.close()
    except Exception:
        cs = []

    return base_html("Admin Panel", body, nav_html(True))

@app.post("/admin/settings/auto-mode")
def admin_set_auto_mode():
    rr = require_admin()
    if rr:
        return rr

    mode = safe_str(request.form.get("auto_mode") or "").upper()
    if mode not in ("NORMAL", "AGGRESSIVE", "HARD"):
        mode = "NORMAL"
    set_app_setting("AUTO_MODE", mode)

    # Hemen gate/reason gÃ¼ncelle (beklemesin)
    try:
        ev = _auto_regime_evaluate(mode) if AUTO_REGIME_ENABLED else {"ok": True, "gate": 1, "reason": ""}
        gate = int((ev or {}).get("gate") or 0) if (ev or {}).get("ok") else 0
        reason = safe_str((ev or {}).get("reason") or "Regime eval fail")
        _set_auto_gate_for_all(gate, mode, reason)
    except Exception:
        pass

    return redirect("/admin")



@app.get("/admin/logs")
def admin_logs():
    rr = require_admin()
    if rr:
        return rr

    conn = db()
    rows = conn.execute("SELECT * FROM logs ORDER BY id DESC LIMIT 200").fetchall()
    conn.close()

    lines = ""
    for x in rows:
        t = datetime.utcfromtimestamp(int(x["created_at"] or 0)) + timedelta(hours=TZ_OFFSET_HOURS)
        ts = t.strftime("%Y-%m-%d %H:%M:%S")
        lines += f'<div class="logline">{ts}  {x["level"]}  {x["username"]}  {x["message"]}</div>'

    body = f"""
<div class="card">
  <h2>{E_LOGS} Logs</h2>
  <div class="muted">Tek satÄ±r gÃ¶rÃ¼nÃ¼m</div>
  <div class="hr"></div>
  <div style="display:flex;flex-direction:column;gap:10px">
    {lines if lines else '<div class="muted">Log yok</div>'}
  </div>
</div>
"""
    return base_html("Logs", body, nav_html(True))



# =========================
# Admin: Contracts (SÃ¶zleÅŸmeler)
# =========================
# =========================
# AUTO REGIME (server-side gate + mode)
# =========================
AUTO_REGIME_ENABLED = os.getenv("AUTO_REGIME_ENABLED", "1").strip().lower() in ("1", "true", "yes", "on")
AUTO_REGIME_SYMBOL = safe_str(os.getenv("AUTO_REGIME_SYMBOL", "BTC/USDT")).upper() or "BTC/USDT"
AUTO_REGIME_BAR = safe_str(os.getenv("AUTO_REGIME_BAR", "1H")).upper() or "1H"
AUTO_REGIME_CHECK_SEC = int(float(os.getenv("AUTO_REGIME_CHECK_SEC", "60") or 60))  # saniye (varsayÄ±lan 60)

def get_auto_gate(username: str) -> Dict[str, Any]:
    try:
        conn = db()
        try:
            row = conn.execute(
                "SELECT auto_gate, auto_mode, auto_gate_reason FROM users WHERE username=?",
                (safe_str(username),),
            ).fetchone()
        finally:
            conn.close()
        if not row:
            return {"gate": 1, "mode": get_global_auto_mode(), "reason": ""}
        d = dict(row)
        return {
            "gate": int(d.get("auto_gate") or 0),
            "mode": safe_str(d.get("auto_mode") or get_global_auto_mode()).upper() or get_global_auto_mode(),
            "reason": safe_str(d.get("auto_gate_reason") or ""),
        }
    except Exception:
        return {"gate": 1, "mode": get_global_auto_mode(), "reason": ""}

def _set_auto_gate_for_all(gate: int, mode: str, reason: str) -> None:
    # GLOBAL auto gate updater (tÃ¼m kullanÄ±cÄ±lar)
    try:
        gate = int(gate or 0)
    except Exception:
        gate = 0

    mode = safe_str(mode).upper() or "NORMAL"
    if mode not in ("NORMAL", "AGGRESSIVE", "HARD"):
        mode = "NORMAL"

    reason = safe_str(reason)
    now = int(time.time())

    # DEBUG: loop Ã§alÄ±ÅŸÄ±yor mu kanÄ±t
    try:
        print("GATE LOOP TICK", gate, mode, now)
    except Exception:
        pass

    conn = db()
    try:
        conn.execute(
            """
            UPDATE users
            SET auto_gate = ?,
                auto_mode = ?,
                auto_gate_reason = ?,
                updated_at = ?
            """,
            (gate, mode, reason, now)
        )
        conn.commit()
    finally:
        try:
            conn.close()
        except Exception:
            pass


def _okx_fetch_candles(symbol: str, bar: str = "1H", limit: int = 260) -> List[Dict[str, Any]]:
    try:
        import requests
        inst = safe_str(symbol).upper().replace("/", "-")
        url = "https://www.okx.com/api/v5/market/candles"
        r = requests.get(url, params={"instId": inst, "bar": bar, "limit": int(limit)}, timeout=10)
        j = r.json() if r is not None else {}
        data = (j or {}).get("data") or []
        out: List[Dict[str, Any]] = []
        for row in data:
            try:
                out.append({"ts": int(float(row[0]) / 1000.0), "o": float(row[1]), "h": float(row[2]), "l": float(row[3]), "c": float(row[4])})
            except Exception:
                continue
        out.sort(key=lambda x: int(x.get("ts") or 0))
        return out
    except Exception:
        return []

def _ema(series: List[float], length: int) -> float:
    if not series or length <= 1 or len(series) < length:
        return 0.0
    k = 2.0 / (length + 1.0)
    ema = float(series[0])
    for v in series[1:]:
        ema = (float(v) * k) + (ema * (1.0 - k))
    return float(ema)

def _rsi(series: List[float], length: int) -> float:
    if not series or length <= 1 or len(series) < (length + 1):
        return 0.0
    gains = 0.0
    losses = 0.0
    for i in range(1, length + 1):
        ch = float(series[i] - series[i - 1])
        if ch >= 0:
            gains += ch
        else:
            losses += abs(ch)
    avg_gain = gains / float(length)
    avg_loss = losses / float(length)
    for i in range(length + 1, len(series)):
        ch = float(series[i] - series[i - 1])
        g = ch if ch > 0 else 0.0
        l = abs(ch) if ch < 0 else 0.0
        avg_gain = (avg_gain * (length - 1) + g) / float(length)
        avg_loss = (avg_loss * (length - 1) + l) / float(length)
    if avg_loss == 0:
        return 100.0
    rs = avg_gain / avg_loss
    return float(100.0 - (100.0 / (1.0 + rs)))

def _pct_range_last_n(candles: List[Dict[str, Any]], n: int = 3) -> float:
    if not candles or len(candles) < n:
        return 0.0
    sub = candles[-n:]
    hh = max([float(x.get("h") or 0.0) for x in sub] or [0.0])
    ll = min([float(x.get("l") or 0.0) for x in sub] or [0.0])
    if ll <= 0:
        return 0.0
    return float((hh - ll) / ll * 100.0)

def _auto_regime_thresholds(mode: str) -> Dict[str, float]:
    mode = safe_str(mode).upper() or "NORMAL"
    if mode == "AGGRESSIVE":
        return {"rsi_on": 52.0, "rsi_off": 48.0, "min_move": 0.25}
    if mode == "HARD":
        return {"rsi_on": 58.0, "rsi_off": 42.0, "min_move": 0.45}
    return {"rsi_on": 55.0, "rsi_off": 45.0, "min_move": 0.35}

def _auto_regime_evaluate(mode: str) -> Dict[str, Any]:
    th = _auto_regime_thresholds(mode)
    candles = _okx_fetch_candles(AUTO_REGIME_SYMBOL, AUTO_REGIME_BAR, 260)
    if not candles or len(candles) < 210:
        return {"ok": False, "gate": 0, "reason": "Candle yok"}
    closes = [float(x["c"]) for x in candles]
    ema200_now = _ema(closes[-220:], 200)
    ema200_prev = _ema(closes[-221:-1], 200) if len(closes) >= 221 else ema200_now
    slope_up = ema200_now >= ema200_prev
    last_close = float(closes[-1])
    above_ema = last_close >= ema200_now if ema200_now > 0 else False
    rsi14 = _rsi(closes[-200:], 14)
    move3 = _pct_range_last_n(candles, 3)

    # --- Gate gevÅŸetilmiÅŸ karar mantÄ±ÄŸÄ± ---
    RSI_MIN = 28.0          # RSI alt limiti (gevÅŸetildi)
    MOMO_ON = 0.35            # 3 bar toplam hareket %0.90 Ã¼stÃ¼yse momentum gÃ¼Ã§lÃ¼
    ALLOW_DOWN_IF_MOMO = True

    # varsayÄ±lan kapalÄ±
    ok = False

    # RSI filtresi
    if rsi14 >= RSI_MIN:
        ok = True

    # EMA200 trend filtresi
    if not slope_up:
        if ALLOW_DOWN_IF_MOMO and move3 >= MOMO_ON:
            ok = True
        else:
            ok = False

    # EMA altÄ±nda ise momentum yoksa kapat
    if not above_ema and move3 < MOMO_ON:
        ok = False

    reason = f"EMA200 {'UP' if slope_up else 'DOWN'} â€¢ Close {'>=EMA' if above_ema else '<EMA'} â€¢ RSI {rsi14:.1f} â€¢ 3bar {move3:.2f}% â€¢ mode {mode}"
    return {"ok": True, "gate": 1 if ok else 0, "reason": reason}


def _auto_regime_eval_symbol(symbol: str, mode: str) -> Dict[str, Any]:
    """
    AUTO regime deÄŸerlendirmesini, hedef sembol bazÄ±nda dÃ¶ndÃ¼rÃ¼r.
    - gate: BUY filtresi iÃ§in (1/0)
    - strong: SELL DEFER iÃ§in "trend gÃ¼Ã§lÃ¼" sinyali (True/False)
    """
    try:
        ex = "OKX"  # Auto-Regime ÅŸu an sadece OKX mumlarÄ±na gÃ¶re Ã§alÄ±ÅŸÄ±r
        sym = normalize_symbol(symbol)
        candles = _auto_regime_fetch_okx_candles(sym)
        if not candles:
            return {"ok": False, "gate": 0, "strong": False, "reason": "Candle yok"}

        closes = [float(x["c"]) for x in candles]
        ema200_now = _ema(closes[-220:], 200)
        ema200_prev = _ema(closes[-221:-1], 200) if len(closes) >= 221 else ema200_now
        slope_up = ema200_now >= ema200_prev
        last_close = float(closes[-1])
        above_ema = last_close >= ema200_now if ema200_now > 0 else False
        rsi14 = _rsi(closes[-200:], 14)
        move3 = _pct_range_last_n(candles, 3)

        RSI_MIN = 28.0
        MOMO_ON = 0.35
        ALLOW_DOWN_IF_MOMO = True

        ok_gate = False
        if rsi14 >= RSI_MIN:
            ok_gate = True
        if not slope_up:
            if ALLOW_DOWN_IF_MOMO and move3 >= MOMO_ON:
                ok_gate = True
            else:
                ok_gate = False
        if not above_ema and move3 < MOMO_ON:
            ok_gate = False

        # "trend gÃ¼Ã§lÃ¼" tanÄ±mÄ±: yukarÄ± eÄŸim + EMA Ã¼stÃ¼ + momentum
        strong = bool(slope_up and above_ema and (move3 >= MOMO_ON))

        reason = f"{ex} {sym} â€¢ EMA200 {'UP' if slope_up else 'DOWN'} â€¢ Close {'>=EMA' if above_ema else '<EMA'} â€¢ RSI {rsi14:.1f} â€¢ 3bar {move3:.2f}% â€¢ mode {mode}"
        return {"ok": True, "gate": 1 if ok_gate else 0, "strong": strong, "reason": reason}
    except Exception as e:
        return {"ok": False, "gate": 0, "strong": False, "reason": f"Eval hata: {safe_str(e)}"}


def _auto_sell_defer_should_queue(username: str, exchange_id: str, symbol: str) -> Dict[str, Any]:
    """B: Trend gÃ¼Ã§lÃ¼ ise Gate ON + SELL DEFER; zayÄ±fsa SELL INSTANT."""
    try:
        if not AUTO_SELL_DEFER_ENABLED:
            return {"defer": False, "reason": "SELL DEFER kapalÄ±"}

        # Gate OFF ise (manuel), BUY kapalÄ± / SELL aÃ§Ä±k. Defer yapma.
        if AUTO_REGIME_ENABLED:
            gg = get_auto_gate(username) or {}
            if int(gg.get("gate") or 0) != 1:
                return {"defer": False, "reason": "Gate OFF"}

        mode = get_global_auto_mode()
        ev = _auto_regime_eval_symbol(symbol, mode)
        if not (ev or {}).get("ok"):
            return {"defer": False, "reason": safe_str((ev or {}).get("reason") or "Eval fail")}

        if bool((ev or {}).get("strong")):
            return {"defer": True, "reason": safe_str((ev or {}).get("reason") or "Trend gÃ¼Ã§lÃ¼")}

        return {"defer": False, "reason": safe_str((ev or {}).get("reason") or "Trend zayÄ±f")}
    except Exception as e:
        return {"defer": False, "reason": f"Defer karar hatasÄ±: {safe_str(e)}"}


def _auto_sell_defer_max_sec_for_mode(mode: str) -> int:
    m = safe_str(mode).upper()
    if m in ("HARD", "EASY", "SAFE"):
        return int(AUTO_SELL_DEFER_MAX_SEC_HARD)
    if m in ("AGGRESSIVE", "AGGR", "FAST"):
        return int(AUTO_SELL_DEFER_MAX_SEC_AGGR)
    return int(AUTO_SELL_DEFER_MAX_SEC_NORMAL)


def _auto_sell_defer_key(username: str, exchange_id: str, symbol: str) -> str:
    return f"{safe_str(username)}|{safe_str(exchange_id).upper()}|{normalize_symbol(symbol)}"


def _auto_sell_defer_enqueue(username: str, exchange_id: str, symbol: str, reason: str) -> bool:
    k = _auto_sell_defer_key(username, exchange_id, symbol)
    nowi = now_ts()
    with _DEFERRED_SELLS_LOCK:
        if k in _DEFERRED_SELLS:
            return False
        mode = get_global_auto_mode()
        _DEFERRED_SELLS[k] = {
            "username": safe_str(username),
            "exchange_id": safe_str(exchange_id).upper(),
            "symbol": normalize_symbol(symbol),
            "created_at": nowi,
            "last_check": 0,
            "max_sec": _auto_sell_defer_max_sec_for_mode(mode),
            "mode": safe_str(mode),
            "reason": safe_str(reason),
        }
    return True


def _auto_sell_execute_now(username: str, u: dict, exchange_id: str, symbol: str) -> Dict[str, Any]:
    """Webhook AUTO SELL'in mevcut davranÄ±ÅŸÄ±: aynÄ± semboldeki tÃ¼m pozisyonlarÄ± kapat."""
    # aÃ§Ä±k pozisyon(lar) bul (stack destekli)
    conn = db()
    try:
        prows = conn.execute(
            "SELECT * FROM open_positions WHERE username=? AND exchange_id=? AND symbol=? ORDER BY id ASC",
            (username, exchange_id, symbol),
        ).fetchall()
    finally:
        conn.close()

    if not prows:
        return {"ok": False, "error": "AÃ§Ä±k pozisyon yok"}

    positions = [dict(r) for r in prows]
    dry_run_pos = bool(int(positions[0].get("dry_run") or 0) == 1)

    total_qty = 0.0
    total_entry_usdt = 0.0
    total_entry_qty_price = 0.0
    for p in positions:
        q = float(p.get("qty") or 0.0)
        ep = float(p.get("entry_price") or 0.0)
        eu = float(p.get("entry_usdt") or 0.0)
        if q > 0:
            total_qty += q
            total_entry_qty_price += (ep * q) if ep > 0 else 0.0
        if eu > 0:
            total_entry_usdt += eu

    avg_entry_price = (total_entry_qty_price / total_qty) if (total_qty > 0 and total_entry_qty_price > 0) else 0.0

    # LIVE modda yetki kontrolÃ¼
    if (not dry_run_pos) and (not may_trade(u)):
        return {"ok": False, "error": "Trade kapalÄ±/limit dolu"}

    ok = True
    err = ""
    pnl_usdt = 0.0
    proceeds = 0.0
    fee_total_usdt = 0.0

    if dry_run_pos:
        try:
            last_price = float(get_public_price(exchange_id, symbol) or 0.0)
        except Exception:
            last_price = 0.0
        sell_qty = total_qty
        proceeds = (last_price * sell_qty) if (last_price > 0 and sell_qty > 0) else 0.0
        cost_basis = total_entry_usdt if total_entry_usdt > 0 else ((avg_entry_price * sell_qty) if (avg_entry_price > 0 and sell_qty > 0) else 0.0)
        pnl_usdt = (proceeds - cost_basis) if (proceeds > 0 and cost_basis >= 0) else 0.0
    else:
        keys = _keys_for_exchange(u, exchange_id)
        api_key = safe_str(keys.get("api_key"))
        api_secret = safe_str(keys.get("api_secret"))
        api_pass = safe_str(keys.get("api_passphrase"))

        qty_to_sell = float(total_qty or 0.0)
        if exchange_id == "OKX":
            try:
                base_ccy = _base_ccy_from_symbol(symbol)
                bal_qty = okx_get_asset_balance(base_ccy, api_key, api_secret, api_pass)
                if bal_qty > 0:
                    qty_to_sell = bal_qty
            except Exception:
                pass

        res = place_order(exchange_id, "SELL", symbol, qty_to_sell, False, api_key, api_secret, api_pass)
        ok = bool((res or {}).get("ok"))
        err = safe_str((res or {}).get("reason") or "")
        if ok:
            # proceeds (gross)
            proceeds = _to_float((res or {}).get("real_usdt"), 0.0)
            if proceeds <= 0:
                fp = _to_float((res or {}).get("fill_price"), 0.0)
                fq = _to_float((res or {}).get("fill_qty"), 0.0)
                proceeds = fp * fq if (fp > 0 and fq > 0) else 0.0

            fill_price = _to_float((res or {}).get("fill_price"), 0.0)

            # cost basis (stack'li pozisyonlardan oransal)
            ratio = 1.0
            cost_basis = 0.0
            if total_entry_usdt > 0 and total_qty > 0 and qty_to_sell > 0:
                ratio = min(1.0, float(qty_to_sell) / float(total_qty))
                cost_basis = float(total_entry_usdt) * ratio
            else:
                buy_spent = get_last_buy_spent(username, exchange_id, symbol, False)
                if buy_spent > 0:
                    cost_basis = buy_spent

            # Fees: BUY (stack) + SELL (order)
            buy_fee_total_usdt = _sum_buy_fees_usdt(exchange_id, symbol, positions) * ratio
            sell_fee_total_usdt = _sum_sell_fees_usdt(exchange_id, symbol, fill_price, res)
            fee_total_usdt = buy_fee_total_usdt + sell_fee_total_usdt

            # NET proceeds & NET PnL
            proceeds_net = proceeds - sell_fee_total_usdt
            pnl_usdt = proceeds_net - cost_basis - buy_fee_total_usdt


    if not ok:
        return {"ok": False, "error": err or "SELL baÅŸarÄ±sÄ±z"}

    # pozisyon(lar)Ä± kapat
    try:
        conn = db()
        try:
            conn.execute(
                "DELETE FROM open_positions WHERE username=? AND exchange_id=? AND symbol=? AND dry_run=?",
                (username, exchange_id, symbol, 1 if dry_run_pos else 0),
            )
            conn.commit()
        finally:
            conn.close()
    except Exception:
        pass

    try:
        record_trade(username, exchange_id, "SELL", symbol, proceeds, pnl_usdt, False if not dry_run_pos else True)
    except Exception:
        pass

    try:
        inc_usage(username)
    except Exception:
        pass

    try:
        telegram_send_for_user(
            u,
            build_telegram_text(
                "SELL",
                u,
                symbol,
                (total_entry_usdt if total_entry_usdt > 0 else proceeds),
                dry_run_pos,
                {"net_pnl_usdt": pnl_usdt, "net_pnl_try": (pnl_usdt * USDT_TRY_RATE), "fee_usdt_total": fee_total_usdt, "pnl_usdt": pnl_usdt, "pnl_try": (pnl_usdt * USDT_TRY_RATE), "mode": "AUTO"},
            ),
        )
    except Exception:
        pass

    try:
        log_line(username, "INFO", f"{E_BOT} AUTO SELL Ã§alÄ±ÅŸtÄ±: {exchange_id} {symbol} pnl={pnl_usdt:.6f}")
    except Exception:
        pass

    return {"ok": True, "pnl_usdt": pnl_usdt, "fee_usdt_total": fee_total_usdt, "proceeds": proceeds}


def _auto_sell_defer_loop():
    if not AUTO_SELL_DEFER_ENABLED:
        return
    while True:
        try:
            time.sleep(max(3.0, float(AUTO_SELL_DEFER_CHECK_SEC)))
        except Exception:
            time.sleep(10.0)

        # snapshot keys
        with _DEFERRED_SELLS_LOCK:
            items = list(_DEFERRED_SELLS.items())

        if not items:
            continue

        for k, it in items:
            try:
                username = safe_str(it.get("username"))
                exchange_id = safe_str(it.get("exchange_id")).upper()
                symbol = normalize_symbol(safe_str(it.get("symbol")))
                created_at = int(it.get("created_at") or 0)
                max_sec = int(it.get("max_sec") or 0)
                age = max(0, now_ts() - created_at)

                u = get_user(username)
                if not u:
                    with _DEFERRED_SELLS_LOCK:
                        _DEFERRED_SELLS.pop(k, None)
                    continue

                # time limit dolduysa: zorla sat
                if max_sec > 0 and age >= max_sec:
                    _auto_sell_execute_now(username, u, exchange_id, symbol)
                    with _DEFERRED_SELLS_LOCK:
                        _DEFERRED_SELLS.pop(k, None)
                    continue

                # trend hala gÃ¼Ã§lÃ¼ mÃ¼?
                dec = _auto_sell_defer_should_queue(username, exchange_id, symbol)
                if bool(dec.get("defer")):
                    # hala gÃ¼Ã§lÃ¼: bekle
                    continue

                # trend zayÄ±fladÄ±: sat
                _auto_sell_execute_now(username, u, exchange_id, symbol)
                with _DEFERRED_SELLS_LOCK:
                    _DEFERRED_SELLS.pop(k, None)
            except Exception:
                # bu item'da hata olursa en azÄ±ndan kuyrukta kalÄ±p bir sonraki turda tekrar denensin
                continue


def start_auto_sell_defer_thread():
    if not AUTO_SELL_DEFER_ENABLED:
        return
    try:
        th = threading.Thread(target=_auto_sell_defer_loop, daemon=True)
        th.start()
    except Exception:
        pass

def _auto_regime_loop():
    if not AUTO_REGIME_ENABLED:
        return
    while True:
        try:
            mode = get_global_auto_mode()
            ev = _auto_regime_evaluate(mode)
            if (ev or {}).get("ok"):
                gate = int((ev or {}).get("gate") or 0)
                reason = safe_str((ev or {}).get("reason") or "")
                _set_auto_gate_for_all(gate, mode, reason)
            else:
                # Eval baÅŸarÄ±sÄ±zsa gate'i zorla OFF yapma: mevcut durumu koru, sadece logla
                try:
                    log_line("auto", "WARN", f"Regime eval fail mode={mode} reason={safe_str((ev or {}).get('reason') or '')}")
                except Exception:
                    pass
        except Exception:
            pass
        try:
            time.sleep(max(5, int(AUTO_REGIME_CHECK_SEC)))
        except Exception:
            time.sleep(120)  # Every 2 minutes

def start_auto_regime_thread():
    if not AUTO_REGIME_ENABLED:
        return
    try:
        th = threading.Thread(target=_auto_regime_loop, daemon=True)
        th.start()
    except Exception:
        pass



# =========================
# TP Manager (net hedef kÃ¢r)
# =========================
TP_MANAGER_ENABLED = bool(int(os.getenv("TP_MANAGER_ENABLED", "1")))  # 1=aktif

# Net hedef: %0.50 = 0.005
TP_NET_TARGET_PCT = float(os.getenv("TP_NET_TARGET_PCT", "0.005"))

# Tahmini satÄ±ÅŸ fee oranÄ± (OKX spot iÃ§in deÄŸiÅŸebilir)
# 0.001 = %0.10, 0.002 = %0.20 gibi dÃ¼ÅŸÃ¼n
TP_SELL_FEE_RATE = float(os.getenv("TP_SELL_FEE_RATE", "0.001"))

# Kontrol aralÄ±ÄŸÄ± (saniye)
TP_CHECK_SEC = float(os.getenv("TP_CHECK_SEC", "6"))

# Min bekleme (BUY sonrasÄ± hemen satmasÄ±n)
TP_MIN_HOLD_SEC = int(os.getenv("TP_MIN_HOLD_SEC", "60"))

# Max bekleme (hedefe gelmezse zorla kapatmak istersen)
TP_MAX_HOLD_SEC = int(os.getenv("TP_MAX_HOLD_SEC", "0"))  # 0=kapalÄ±

# Opsiyonel net stop (negatif deÄŸer): Ã¶rn -0.006 = -%0.60
TP_NET_STOP_PCT = float(os.getenv("TP_NET_STOP_PCT", "0.0"))


def _tp_manager_loop():
    """
    AÃ§Ä±k pozisyonlarÄ± dÃ¼zenli kontrol eder.
    NET PnL >= TP_NET_TARGET_PCT olduÄŸunda server kendi SELL atar.
    """
    if not TP_MANAGER_ENABLED:
        return

    while True:
        try:
            time.sleep(max(2.0, float(TP_CHECK_SEC)))
        except Exception:
            time.sleep(10.0)

        # PozisyonlarÄ± oku
        try:
            conn = db()
            rows = conn.execute("""
                SELECT id, username, exchange_id, symbol, qty, entry_usdt, buy_fee_usdt, buy_fee_coin, buy_fee_coin_ccy, created_at, dry_run
                FROM open_positions
                ORDER BY id ASC
            """).fetchall()
            conn.close()
        except Exception:
            continue

        for r in (rows or []):
            try:
                p = dict(r) if r is not None else {}
                pid = int(p.get("id") or 0)
                username = safe_str(p.get("username") or "")
                exchange_id = safe_str(p.get("exchange_id") or "").upper()
                symbol = normalize_symbol(safe_str(p.get("symbol") or ""))
                qty = _to_float(p.get("qty"), 0.0)
                entry_usdt = _to_float(p.get("entry_usdt"), 0.0)
                buy_fee_usdt = _to_float(p.get("buy_fee_usdt"), 0.0)
                buy_fee_coin = _to_float(p.get("buy_fee_coin"), 0.0)
                buy_fee_coin_ccy = safe_str(p.get("buy_fee_coin_ccy") or "").upper()
                created_at = int(p.get("created_at") or 0)
                age = max(0, now_ts() - created_at)

                if qty <= 0 or entry_usdt <= 0:
                    continue
                if age < TP_MIN_HOLD_SEC:
                    continue

                u = get_user(username)
                if not u:
                    continue
                if u and not isinstance(u, dict):
                    u = dict(u)

                # GÃ¼nlÃ¼k zarar limiti vb. blok varsa trade etme
                try:
                    if daily_loss_block_msg(u):
                        continue
                except Exception:
                    pass

                # AnlÄ±k fiyat
                cur_px = _to_float(get_public_price(exchange_id, symbol), 0.0)
                if cur_px <= 0:
                    continue

                proceeds = qty * cur_px

                # buy fee coin -> USDT (mÃ¼mkÃ¼nse)
                buy_fee_coin_usdt = 0.0
                if buy_fee_coin > 0 and buy_fee_coin_ccy and buy_fee_coin_ccy not in ("USDT", "USD"):
                    try:
                        fee_sym = f"{buy_fee_coin_ccy}/USDT"
                        fee_px = _to_float(get_public_price(exchange_id, fee_sym), 0.0)
                        if fee_px > 0:
                            buy_fee_coin_usdt = buy_fee_coin * fee_px
                    except Exception:
                        pass

                cost = entry_usdt + buy_fee_usdt + buy_fee_coin_usdt

                # Tahmini sell fee
                sell_fee_est = proceeds * float(TP_SELL_FEE_RATE)

                net_pnl = proceeds - sell_fee_est - cost
                net_pnl_pct = (net_pnl / cost) if cost > 0 else 0.0

                # Zorla Ã§Ä±k (max hold)
                if TP_MAX_HOLD_SEC > 0 and age >= TP_MAX_HOLD_SEC:
                    _auto_sell_execute_now(username, u, exchange_id, symbol)
                    continue

                # Stop loss (opsiyonel)
                if TP_NET_STOP_PCT < 0 and net_pnl_pct <= TP_NET_STOP_PCT:
                    _auto_sell_execute_now(username, u, exchange_id, symbol)
                    continue

                # Take profit
                if net_pnl_pct >= float(TP_NET_TARGET_PCT):
                    _auto_sell_execute_now(username, u, exchange_id, symbol)
                    continue

            except Exception:
                continue


def start_tp_manager_thread():
    if not TP_MANAGER_ENABLED:
        return
    try:
        th = threading.Thread(target=_tp_manager_loop, daemon=True)
        th.start()
    except Exception:
        pass


# =========================
# Startup
# =========================
init_db()
start_auto_regime_thread()
start_auto_sell_defer_thread()
start_tp_manager_thread()


def telegram_send_admin_dm(text: str) -> None:
    """
    Sadece admin DM (TELEGRAM_ADMIN_DM_ID Ã¶ncelikli). Gruba ASLA atmaz.
    """
    try:
        admin_id = safe_str(os.getenv("TELEGRAM_ADMIN_DM_ID", "") or os.getenv("TELEGRAM_CHAT_ID", "") or "").strip()
        if not admin_id:
            return
        telegram_send_to(admin_id, safe_str(text))
    except Exception:
        pass


@app.post("/trial/upgrade")
def trial_upgrade_request():
    rr = require_login()
    if rr:
        return rr

    username = session.get("username") or ""
    u = get_user(username)
    if u and not isinstance(u, dict):
        u = dict(u)
    if not u:
        return redirect("/api/app/login")

    if not is_trial_user(u):
        session["popup_msg"] = f"{E_X} Bu iÅŸlem sadece Trial kullanÄ±cÄ±lar iÃ§indir"
        return redirect("/")

    ex_name = safe_str(u.get("exchange_id") or DEFAULT_EXCHANGE).upper()
    msg = "\n".join([
        "ğŸ§ª Trial â†’ Ãœcretli GeÃ§iÅŸ Talebi",
        f"{E_USER} {user_display_name(u)}",
        f"{E_BANK} Borsa: {ex_name}",
        f"{E_TIME} Zaman: {iso_now_local()}",
        f"{E_MAIL} Panelden butona basÄ±ldÄ±",
    ])

    if not TELEGRAM_CHAT_ID_FALLBACK:
        session["popup_msg"] = f"{E_WARN} TELEGRAM_CHAT_ID tanÄ±mlÄ± deÄŸil"
        return redirect("/")

    telegram_send_admin_dm(msg)
    session["popup_msg"] = f"{E_OK} Talebin alÄ±ndÄ±. Sana DM atÄ±ldÄ±"
    return redirect("/")


# =========================
# Telegram Admin Commands (DM only)
# =========================
TG_ADMIN_DM_ID = safe_str(os.getenv("TELEGRAM_ADMIN_DM_ID", "") or os.getenv("TELEGRAM_CHAT_ID", "") or "").strip()
TG_ADMIN_PIN = safe_str(os.getenv("TELEGRAM_ADMIN_PIN", "") or "").strip()
TG_ADMIN_AUTH_TTL = int(os.getenv("TELEGRAM_ADMIN_AUTH_TTL", "900") or "900")  # seconds
TG_ADMIN_CONFIRM_TTL = int(os.getenv("TELEGRAM_ADMIN_CONFIRM_TTL", "90") or "90")  # seconds

# In-memory state (safe for single-process systemd)
_tg_admin_state = {
    "authed_until": 0,
    "pending": {},   # code -> {"cmd": str, "args": str, "expires": int}
    "last_update_id": 0,
}

def _db_init_security() -> None:
    conn = db()
    try:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS ip_bans (
                ip TEXT PRIMARY KEY,
                banned_until INTEGER,
                reason TEXT,
                created_at INTEGER
            )
        """)
        conn.execute("""
            CREATE TABLE IF NOT EXISTS login_fails (
                ip TEXT PRIMARY KEY,
                fails INTEGER,
                first_ts INTEGER,
                last_ts INTEGER
            )
        """)
        conn.execute("""
            CREATE TABLE IF NOT EXISTS admin_flags (
                k TEXT PRIMARY KEY,
                v TEXT,
                updated_at INTEGER
            )
        """)
        conn.commit()
    finally:
        conn.close()

def get_admin_flag(k: str, default: str = "") -> str:
    try:
        conn = db()
        try:
            r = conn.execute("SELECT v FROM admin_flags WHERE k=?", (safe_str(k),)).fetchone()
            return safe_str(r[0]) if r and r[0] is not None else safe_str(default)
        finally:
            conn.close()
    except Exception:
        return safe_str(default)

def set_admin_flag(k: str, v: str) -> None:
    conn = db()
    try:
        conn.execute(
            "INSERT INTO admin_flags(k,v,updated_at) VALUES(?,?,?) "
            "ON CONFLICT(k) DO UPDATE SET v=excluded.v, updated_at=excluded.updated_at",
            (safe_str(k), safe_str(v), now_ts())
        )
        conn.commit()
    finally:
        conn.close()

def is_global_panic() -> bool:
    return safe_str(get_admin_flag("panic", "0")) == "1"

def _client_ip() -> str:
    # if behind nginx, prefer X-Forwarded-For first value
    try:
        xff = safe_str(request.headers.get("X-Forwarded-For") or "")
        if xff:
            return safe_str(xff.split(",")[0]).strip()
    except Exception:
        pass
    try:
        return safe_str(request.remote_addr or "").strip()
    except Exception:
        return ""

def is_ip_banned(ip: str) -> bool:
    ip = safe_str(ip).strip()
    if not ip:
        return False
    conn = db()
    try:
        r = conn.execute("SELECT banned_until FROM ip_bans WHERE ip=?", (ip,)).fetchone()
        if not r:
            return False
        until = int(r[0] or 0)
        if until <= now_ts():
            try:
                conn.execute("DELETE FROM ip_bans WHERE ip=?", (ip,))
                conn.commit()
            except Exception:
                pass
            return False
        return True
    finally:
        conn.close()

def ban_ip(ip: str, seconds: int, reason: str) -> None:
    ip = safe_str(ip).strip()
    if not ip:
        return
    until = now_ts() + int(max(60, seconds))
    conn = db()
    try:
        conn.execute(
            "INSERT INTO ip_bans(ip,banned_until,reason,created_at) VALUES(?,?,?,?) "
            "ON CONFLICT(ip) DO UPDATE SET banned_until=excluded.banned_until, reason=excluded.reason",
            (ip, until, safe_str(reason), now_ts())
        )
        conn.commit()
    finally:
        conn.close()

# Brute-force thresholds
BF_MAX_FAILS = int(os.getenv("BF_MAX_FAILS", "8") or "8")          # fails
BF_WINDOW_SEC = int(os.getenv("BF_WINDOW_SEC", "900") or "900")    # 15m
BF_BAN_SEC = int(os.getenv("BF_BAN_SEC", "3600") or "3600")        # 1h

def record_login_fail(ip: str) -> None:
    ip = safe_str(ip).strip()
    if not ip:
        return
    now = now_ts()
    conn = db()
    try:
        r = conn.execute("SELECT fails, first_ts FROM login_fails WHERE ip=?", (ip,)).fetchone()
        if not r:
            conn.execute("INSERT INTO login_fails(ip,fails,first_ts,last_ts) VALUES(?,?,?,?)", (ip, 1, now, now))
            conn.commit()
            return
        fails = int(r[0] or 0)
        first_ts = int(r[1] or now)
        if now - first_ts > BF_WINDOW_SEC:
            fails = 0
            first_ts = now
        fails += 1
        conn.execute("UPDATE login_fails SET fails=?, first_ts=?, last_ts=? WHERE ip=?", (fails, first_ts, now, ip))
        conn.commit()
        if fails >= BF_MAX_FAILS:
            ban_ip(ip, BF_BAN_SEC, f"bruteforce {fails}/{BF_MAX_FAILS}")
            try:
                conn.execute("DELETE FROM login_fails WHERE ip=?", (ip,))
                conn.commit()
            except Exception:
                pass
    finally:
        conn.close()

def clear_login_fail(ip: str) -> None:
    ip = safe_str(ip).strip()
    if not ip:
        return
    conn = db()
    try:
        conn.execute("DELETE FROM login_fails WHERE ip=?", (ip,))
        conn.commit()
    finally:
        conn.close()

# Global guard (admin/login paths)
@app.before_request
def _security_guard_before_request():
    try:
        _db_init_security()
    except Exception:
        pass
# ===============================
# HTTPS redirect FIX (WEBHOOK)
# ===============================
@app.before_request
def _disable_https_redirect_for_webhook():
    # ğŸ”´ TradingView webhook ASLA redirect yemesin
    if request.path == "/webhook":
        return None

    ip = _client_ip()
    if ip and is_ip_banned(ip):
        return ("IP yasaklÄ±", 403)

    # If global panic, block trade endpoints (but allow login/admin)
    try:
        if is_global_panic():
            pth = safe_str(request.path or "")
            if pth.startswith("/webhook") or pth.startswith("/manual/") or "/enqueue" in pth or pth.startswith("/position/") or pth.startswith("/api/execute"):
                return ("PANIC aktif", 503)
    except Exception:
        pass
    return None

def _tg_is_private_chat(update: dict) -> bool:
    try:
        chat = ((update.get("message") or {}).get("chat") or {})
        return safe_str(chat.get("type") or "") == "private"
    except Exception:
        return False

def _tg_chat_id(update: dict) -> str:
    try:
        return safe_str(((update.get("message") or {}).get("chat") or {}).get("id") or "")
    except Exception:
        return ""

def _tg_text(update: dict) -> str:
    try:
        return safe_str((update.get("message") or {}).get("text") or "")
    except Exception:
        return ""

def tg_admin_send(text: str) -> None:
    # DM only to admin chat id
    if not TG_ADMIN_DM_ID:
        return
    telegram_send_to(TG_ADMIN_DM_ID, safe_str(text))

def tg_admin_authed() -> bool:
    return int(_tg_admin_state.get("authed_until") or 0) >= now_ts()

def tg_admin_set_authed():
    _tg_admin_state["authed_until"] = now_ts() + TG_ADMIN_AUTH_TTL

def tg_admin_clear_auth():
    _tg_admin_state["authed_until"] = 0
    _tg_admin_state["pending"] = {}

def _tg_new_code() -> str:
    # 6 digit confirmation code (no ?)
    return f"{secrets.randbelow(900000)+100000}"

def tg_admin_queue_confirm(cmd: str, args: str) -> str:
    code = _tg_new_code()
    _tg_admin_state["pending"][code] = {"cmd": safe_str(cmd), "args": safe_str(args), "expires": now_ts() + TG_ADMIN_CONFIRM_TTL}
    return code

def tg_admin_pop_confirm(code: str) -> Optional[dict]:
    code = safe_str(code).strip()
    d = _tg_admin_state.get("pending", {}).get(code)
    if not d:
        return None
    if int(d.get("expires") or 0) < now_ts():
        try:
            del _tg_admin_state["pending"][code]
        except Exception:
            pass
        return None
    try:
        del _tg_admin_state["pending"][code]
    except Exception:
        pass
    return d

def _run_db_backup_now() -> str:
    # returns path or ""
    try:
        db_path = DB_PATH
        if not db_path:
            return ""
        src = os.path.abspath(db_path)
        if not os.path.exists(src):
            return ""
        bdir = os.path.join(os.path.dirname(src), "backups")
        os.makedirs(bdir, exist_ok=True)
        ts = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
        dst = os.path.join(bdir, f"data_{ts}.db")
        shutil.copy2(src, dst)
        return dst
    except Exception:
        return ""

def _backup_scheduler_loop():
    # daily backup at 04:05 server local time
    while True:
        try:
            now = datetime.now()
            target = now.replace(hour=4, minute=5, second=0, microsecond=0)
            if target <= now:
                target = target + timedelta(days=1)
            sleep_s = int((target - now).total_seconds())
            time.sleep(max(30, sleep_s))
            _ = _run_db_backup_now()
        except Exception:
            time.sleep(60)

def _tg_handle_admin_command(text: str) -> None:
    t = safe_str(text).strip()
    if not t:
        return

    # HELP
    # HELP
    if t.startswith("/help") or t == "/start":
        tg_admin_send(
            f"{E_BOT} Admin KomutlarÄ±\n"
            f"{E_PIN} /pin 123456\n"
            f"{E_STOP} /panic on  ,  /panic off\n"
            f"{E_TAB} /ipban 1.2.3.4\n"
            f"{E_SAVE} /backup now\n"
            f"{E_X} /logout\n"
            f"{E_OK} Onay: /confirm 123456   Iptal: /cancel 123456"
        )
        return

        return

    # PIN
    if t.startswith("/pin"):
        parts = t.split()
        pin = parts[1] if len(parts) >= 2 else ""
        if not TG_ADMIN_PIN or len(TG_ADMIN_PIN) != 6:
            tg_admin_send(f"{E_X} TELEGRAM_ADMIN_PIN ayarlÄ± deÄŸil")
            return
        if safe_str(pin).strip() == TG_ADMIN_PIN:
            tg_admin_set_authed()
            tg_admin_send(f"{E_OK} PIN doÄŸru. Yetki aktif ({TG_ADMIN_AUTH_TTL} sn)")
        else:
            tg_admin_send(f"{E_X} PIN hatalÄ±")
        return

    if t.startswith("/logout"):
        tg_admin_clear_auth()
        tg_admin_send(f"{E_OK} Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±")
        return

    if t.startswith("/confirm") or t.startswith("/cancel"):
        parts = t.split()
        code = parts[1] if len(parts) >= 2 else ""
        if t.startswith("/cancel"):
            try:
                if code and code in _tg_admin_state.get("pending", {}):
                    del _tg_admin_state["pending"][code]
                    tg_admin_send(f"{E_OK} Ä°ptal edildi")
                else:
                    tg_admin_send(f"{E_X} Kod bulunamadÄ±")
            except Exception:
                tg_admin_send(f"{E_X} Kod bulunamadÄ±")
            return

        # confirm
        if not tg_admin_authed():
            tg_admin_send(f"{E_X} Ã–nce /pin gir")
            return
        d = tg_admin_pop_confirm(code)
        if not d:
            tg_admin_send(f"{E_X} Kod yok veya sÃ¼resi doldu")
            return
        cmd = safe_str(d.get("cmd"))
        args = safe_str(d.get("args"))
        tg_admin_send(f"{E_OK} OnaylandÄ±: {cmd} {args}".strip())
        # execute
        try:
            if cmd == "panic":
                if args.lower().strip() == "on":
                    set_admin_flag("panic", "1")
                    tg_admin_send(f"{E_STOP} PANIC aktif")
                else:
                    set_admin_flag("panic", "0")
                    tg_admin_send(f"{E_OK} PANIC kapandÄ±")
            elif cmd == "ipban":
                ip = args.strip()
                try:
                    ipaddress.ip_address(ip)
                except Exception:
                    tg_admin_send(f"{E_X} IP format hatalÄ±")
                    return
                ban_ip(ip, 24*3600, "manual")
                tg_admin_send(f"{E_OK} IP ban eklendi: {ip}")
            elif cmd == "backup":
                path = _run_db_backup_now()
                if path:
                    tg_admin_send(f"{E_OK} Backup hazÄ±r: {path}")
                else:
                    tg_admin_send(f"{E_X} Backup alÄ±namadÄ±")
            else:
                tg_admin_send(f"{E_X} Bilinmeyen komut")
        except Exception:
            tg_admin_send(f"{E_X} Ä°ÅŸlem hatasÄ±")
        return

    # other commands require auth and DM match
    if not tg_admin_authed():
        tg_admin_send(f"{E_X} Ã–nce /pin gir")
        return

    # /panic on|off
    if t.startswith("/panic"):
        parts = t.split()
        mode = (parts[1] if len(parts) >= 2 else "").strip().lower()
        if mode not in ("on", "off"):
            tg_admin_send(f"{E_X} KullanÄ±m: /panic on  veya  /panic off")
            return
        code = tg_admin_queue_confirm("panic", mode)
        tg_admin_send(f"{E_WARN} Onay gerekiyor ({TG_ADMIN_CONFIRM_TTL} sn)\n{E_OK} /confirm {code}\n{E_X} /cancel {code}")
        return

    # /ipban 1.2.3.4
    if t.startswith("/ipban"):
        parts = t.split()
        ip = parts[1] if len(parts) >= 2 else ""
        if not ip:
            tg_admin_send(f"{E_X} KullanÄ±m: /ipban 1.2.3.4")
            return
        code = tg_admin_queue_confirm("ipban", ip)
        tg_admin_send(f"{E_WARN} Onay gerekiyor ({TG_ADMIN_CONFIRM_TTL} sn)\n{E_OK} /confirm {code}\n{E_X} /cancel {code}")
        return

    # /backup now
    if t.startswith("/backup"):
        parts = t.split()
        sub = parts[1] if len(parts) >= 2 else ""
        if sub != "now":
            tg_admin_send(f"{E_X} KullanÄ±m: /backup now")
            return
        code = tg_admin_queue_confirm("backup", "now")
        tg_admin_send(f"{E_WARN} Onay gerekiyor ({TG_ADMIN_CONFIRM_TTL} sn)\n{E_OK} /confirm {code}\n{E_X} /cancel {code}")
        return


    # unknown command
    tg_admin_send(f"{E_X} Bilinmeyen komut. /help")
    return

def _tg_poll_loop():
    if not TELEGRAM_TOKEN:
        return
    if not TG_ADMIN_DM_ID:
        return
    # Not: webhook yok, long-polling. Domain gerektirmez.
    offset = int(_tg_admin_state.get("last_update_id") or 0)
    while True:
        try:
            url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/getUpdates"
            params = {"timeout": 25, "offset": offset + 1, "allowed_updates": json.dumps(["message"])}
            r = requests.get(url, params=params, timeout=40)
            j = r.json() if r.ok else {}
            if not (j.get("ok") is True):
                time.sleep(3)
                continue
            for upd in (j.get("result") or []):
                try:
                    uid = int(upd.get("update_id") or 0)
                    if uid > offset:
                        offset = uid
                    # DM only + admin chat only
                    if not _tg_is_private_chat(upd):
                        continue
                    if _tg_chat_id(upd) != TG_ADMIN_DM_ID:
                        continue
                    msg = _tg_text(upd)
                    _tg_handle_admin_command(msg)
                except Exception:
                    continue
            _tg_admin_state["last_update_id"] = offset
        except Exception:
            time.sleep(5)



# -------------------------
# Admin: Contracts (SÃ¶zleÅŸmeler)
# -------------------------
@app.get("/admin/contracts")
def admin_contracts():
    rr = require_admin()
    if rr:
        return rr

    rows = []
    try:
        conn = db()
        try:
            rows = conn.execute(
                "SELECT id, username, tc, ip, accepted_at FROM contracts ORDER BY id DESC"
            ).fetchall()

        finally:
            conn.close()
    except Exception:
        rows = []

    trs = ""
    if rows:
        for r in rows:
            if r and not isinstance(r, dict):
                r = dict(r)
            cid = int(r.get("id") or 0)
            uname = safe_str(r.get("username"))
            fn = safe_str(r.get("full_name"))
            tc = safe_str(r.get("tc"))
            ip = safe_str(r.get("ip"))
            dt = fmt_ts(int(r.get("accepted_at") or 0)) if int(r.get("accepted_at") or 0) else '<span class="muted">â€”</span>'
            tc_cell = tc if tc else '<span class="muted">â€”</span>'

            trs += f"""
<tr class="tr">
  <td><b>{uname}</b><div class="muted small">{fn if fn else 'â€”'}</div></td>
  <td>{tc_cell}</td>
  <td>{dt}</td>
  <td class="muted small" style="max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{ip if ip else 'â€”'}</td>
  <td style="padding:12px 14px;">
  <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:nowrap;">
    <a class="btn secondary" style="min-width:140px; text-align:center;"
       href="/admin/contracts/{cid}/download">{E_NOTE} Download</a>

    <form method="post" action="/admin/contracts/{cid}/delete"
          style="display:inline; margin:0;"
          onsubmit="return confirm('Silinsin mi?')">
      <button class="btn danger" style="min-width:110px;" type="submit">{E_X} Sil</button>
    </form>
  </div>
</td>

</tr>
"""
    else:
        trs = f"""
<tr class="tr">
  <td colspan="5"><span class="muted">KayÄ±t yok</span></td>
</tr>
"""

    total = len(rows) if rows else 0
    body = f"""
<div class="card">
  <div class="card-h" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
    <div style="display:flex;align-items:center;gap:10px">{E_NOTE} <b>SÃ–ZLEÅMELER</b></div>
    <div class="muted small">Toplam: <b>{total}</b></div>
  </div>
  <div class="muted" style="margin-top:6px">KullanÄ±cÄ± onay kayÄ±tlarÄ± â€¢ PDF indir â€¢ Sil</div>

  <div style="margin-top:14px;overflow:auto">
    <table class="tbl">
      <thead>
        <tr>
          <th style="min-width:180px">KullanÄ±cÄ±</th>
          <th style="min-width:110px">Kimlik No</th>
          <th style="min-width:170px">Kabul Tarihi</th>
          <th style="min-width:160px">IP</th>
          <th style="min-width:180px">Ä°ÅŸlem</th>
        </tr>
      </thead>
      <tbody>
        {trs}
      </tbody>
    </table>
  </div>
</div>
"""
    return base_html("Admin â€¢ SÃ¶zleÅŸmeler", body, nav_html(True))

@app.get("/admin/contracts/<int:cid>/download")
def admin_contract_download(cid: int):
    rr = require_admin()
    if rr:
        return rr

    row = None
    try:
        conn = db()
        try:
            row = conn.execute("SELECT * FROM contracts WHERE id=? LIMIT 1", (cid,)).fetchone()
        finally:
            conn.close()
    except Exception:
        row = None

    if not row:
        return ("Not found", 404)

    if row and not isinstance(row, dict):
        row = dict(row)

    pdf_bytes = _contract_pdf_bytes(row)
    uname = safe_str(row.get("username") or "user")
    ts = int(row.get("accepted_at") or 0)
    stamp = datetime.fromtimestamp(ts, tz=timezone.utc).astimezone(
        timezone(timedelta(hours=3))
    ).strftime("%Y%m%d_%H%M%S") if ts else "na"
    fn = f"sozlesme_{uname}_{stamp}_{cid}.pdf"
    return _send_bytes(pdf_bytes, fn, "application/pdf")


@app.post("/admin/contracts/<int:cid>/delete")
def admin_contract_delete(cid: int):
    rr = require_admin()
    if rr:
        return rr

    try:
        conn = db()
        try:
            conn.execute("DELETE FROM contracts WHERE id=?", (cid,))
            conn.commit()
        finally:
            conn.close()
    except Exception:
        pass

    return redirect("/admin/contracts")
print("TELEGRAM ENV CHECK",
      bool(os.getenv("TELEGRAM_BOT_TOKEN")),
      os.getenv("TELEGRAM_ADMIN_DM_ID"))




# =============================
# Admin Panel (Backend-only UI)
# =============================

def _admin_panel_allowed():
    """Allow access to /admin with either a token or localhost. No UI changes required."""
    try:
        token = os.getenv('ADMIN_PANEL_TOKEN', '').strip()
    except Exception:
        token = ''

    # Localhost access is allowed by default
    remote = (request.headers.get('X-Forwarded-For') or request.remote_addr or '').split(',')[0].strip()
    if remote in ('127.0.0.1', '::1'):
        return True

    # If a token is set, require it for non-local access
    if token:
        supplied = (request.headers.get('X-Admin-Token') or request.args.get('token') or '').strip()
        return supplied == token

    # No token set and not localhost
    return False


@app.route('/admin', methods=['GET'])
def admin_panel():
    if not _admin_panel_allowed():
        return jsonify({'error': 'Not authorized'}), 401

    html = r"""
<!doctype html>
<html lang=\"tr\">
<head>
  <meta charset=\"utf-8\"/>
  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>
  <title>AU Admin Panel</title>
  <style>
    :root{--bg:#0b0f14;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--line:#1f2937;--ok:#22c55e;--bad:#ef4444;}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .brand{font-weight:800;letter-spacing:.2px}
    .pill{font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;}
    .card h3{margin:0 0 10px 0;font-size:14px;color:var(--text)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,select{background:#0b1220;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;outline:none;}
    button{background:#2563eb;border:0;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    button.secondary{background:#374151}
    pre{background:#0b1220;border:1px solid var(--line);padding:10px;border-radius:12px;overflow:auto;max-height:340px;}
    .muted{color:var(--muted);font-size:12px}
    .ok{color:var(--ok);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .span6{grid-column:span 6}
    .span12{grid-column:span 12}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .k{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class=\"wrap\">
    <div class=\"top\">
      <div>
        <div class=\"brand\">Atalay Ulusoy Auto Trade â€¢ Admin</div>
        <div class=\"muted\">Backend panel â€¢ UI dosyalarina dokunmadan debug ve kontrol</div>
      </div>
      <div class=\"pill\">/admin</div>
    </div>

    <div class=\"grid\">
      <div class=\"card span6\">
        <h3>Saglik</h3>
        <div class=\"row\">
          <button onclick=\"loadHealth()\">Yenile</button>
          <span id=\"healthBadge\" class=\"muted\">bekleniyor</span>
        </div>
        <div class=\"sep\"></div>
        <pre id=\"healthOut\">\n</pre>
      </div>

      <div class=\"card span6\">
        <h3>Coins</h3>
        <div class=\"row\">
          <select id=\"ex\">
            <option value=\"OKX\">OKX</option>
            <option value=\"BINANCE\">BINANCE</option>
            <option value=\"BYBIT\">BYBIT</option>
            <option value=\"GATE\">GATE</option>
          </select>
          <button onclick=\"loadCoins()\">Listele</button>
          <span class=\"muted\">endpoint: /api/coins</span>
        </div>
        <div class=\"sep\"></div>
        <pre id=\"coinsOut\">\n</pre>
      </div>

      <div class=\"card span6\">
        <h3>OHLC</h3>
        <div class=\"row\">
          <input id=\"sym\" value=\"BTC/USDT\" style=\"min-width:160px\"/>
          <select id=\"tf\">
            <option value=\"1m\">1m</option>
            <option value=\"5m\" selected>5m</option>
            <option value=\"15m\">15m</option>
            <option value=\"1h\">1h</option>
            <option value=\"4h\">4h</option>
            <option value=\"1d\">1d</option>
          </select>
          <input id=\"lim\" value=\"200\" style=\"width:90px\"/>
          <button onclick=\"loadOhlc()\">Cek</button>
        </div>
        <div class=\"muted\">Uyumlu path: /api/public/ohlc/&lt;symbol&gt;/&lt;tf&gt; veya /api/ohlc</div>
        <div class=\"sep\"></div>
        <pre id=\"ohlcOut\">\n</pre>
      </div>

      <div class=\"card span6\">
        <h3>Positions ve Trades</h3>
        <div class=\"row\">
          <button onclick=\"loadPositions()\" class=\"secondary\">Positions</button>
          <button onclick=\"loadTrades()\" class=\"secondary\">Trades</button>
          <span class=\"muted\">/api/public/positions â€¢ /api/trades</span>
        </div>
        <div class=\"sep\"></div>
        <pre id=\"ptOut\">\n</pre>
      </div>

      <div class=\"card span12\">
        <h3>Chat</h3>
        <div class=\"row\">
          <input id=\"chatMsg\" placeholder=\"Mesaj\" style=\"flex:1;min-width:240px\"/>
          <button onclick=\"sendChat()\">Gonder</button>
          <button onclick=\"loadChat()\" class=\"secondary\">Yenile</button>
          <span class=\"muted\">/api/chat</span>
        </div>
        <div class=\"sep\"></div>
        <pre id=\"chatOut\">\n</pre>
      </div>
    </div>
  </div>

<script>
  function j(v){return JSON.stringify(v,null,2)}

  async function loadHealth(){
    const out=document.getElementById('healthOut')
    const badge=document.getElementById('healthBadge')
    out.textContent='loading'
    badge.textContent='loading'
    try{
      const r=await fetch('/api/health',{credentials:'include'})
      const data=await r.json().catch(()=>({raw:'no json'}))
      out.textContent=j(data)
      badge.textContent=r.ok ? 'OK' : 'ERR'
      badge.className=r.ok ? 'ok' : 'bad'
    }catch(e){
      out.textContent=String(e)
      badge.textContent='ERR'
      badge.className='bad'
    }
  }

  async function loadCoins(){
    const ex=document.getElementById('ex').value
    const out=document.getElementById('coinsOut')
    out.textContent='loading'
    try{
      const r=await fetch('/api/coins?exchange='+encodeURIComponent(ex),{credentials:'include'})
      const data=await r.json().catch(()=>({raw:'no json'}))
      out.textContent=j(data)
    }catch(e){out.textContent=String(e)}
  }

  async function loadOhlc(){
    const sym=document.getElementById('sym').value
    const tf=document.getElementById('tf').value
    const lim=document.getElementById('lim').value
    const out=document.getElementById('ohlcOut')
    out.textContent='loading'
    try{
      const url='/api/public/ohlc/'+encodeURIComponent(sym)+'/'+encodeURIComponent(tf)+'?'+encodeURIComponent(lim)
      const r=await fetch(url,{credentials:'include'})
      const data=await r.json().catch(()=>({raw:'no json'}))
      out.textContent=j({url,status:r.status,data})
    }catch(e){out.textContent=String(e)}
  }

  async function loadPositions(){

    // __AU_BAL_LOCK_GUARD_loadPositions

    try{ if (window.__AU_BALANCE_LOCK_UNTIL && Date.now() < window.__AU_BALANCE_LOCK_UNTIL) return; }catch(e){}

        if (window.__AU_BALANCE_LOCK) { return; }
    const out=document.getElementById('ptOut')
    out.textContent='loading'
    try{
      const r=await fetch('/api/public/positions',{credentials:'include'})
      const data=await r.json().catch(()=>({raw:'no json'}))
      out.textContent=j(data)
    }catch(e){out.textContent=String(e)}
  }

  async function loadTrades(){
    const out=document.getElementById('ptOut')
    out.textContent='loading'
    try{
      const r=await fetch('/api/trades',{credentials:'include'})
      const data=await r.json().catch(()=>({raw:'no json'}))
      out.textContent=j(data)
    }catch(e){out.textContent=String(e)}
  }

  async function loadChat(){
    const out=document.getElementById('chatOut')
    out.textContent='loading'
    try{
      const r=await fetch('/api/chat_poll',{credentials:'include'})
      const data=await r.json().catch(()=>({raw:'no json'}))
      out.textContent=j(data)
    }catch(e){out.textContent=String(e)}
  }

  async function sendChat(){
    const msg=document.getElementById('chatMsg').value
    const out=document.getElementById('chatOut')
    if(!msg){return}
    out.textContent='sending'
    try{
      const r=await fetch('/api/chat_poll',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({message:msg})})
      const data=await r.json().catch(()=>({raw:'no json'}))
      document.getElementById('chatMsg').value=''
      out.textContent=j(data)
      await loadChat()
    }catch(e){out.textContent=String(e)}
  }

  loadHealth()
  loadCoins()
</script>
</body>
</html>
"""

    return render_template_string(html)


@app.errorhandler(404)
def not_found_page(e):
    return render_template_string(NOT_FOUND_TEMPLATE, title="404 - Sayfa BulunamadÄ±", global_css=GLOBAL_CSS), 404








# ==========================================
# EXCHANGE API BACKEND IMPLEMENTATION
# ==========================================
try:
    from cryptography.fernet import Fernet
except ImportError:
    Fernet = None
    print("Warning: 'cryptography' module not found. Encryption disabled.")

def get_exchange_db():
    return sqlite3.connect(os.getenv("DB_PATH", "/root/backend/data.db"))

def get_enc_key():
    # Derive key from SESSION_SECRET to ensure persistence across restarts key
    secret = os.getenv("SESSION_SECRET", "default-secret-key-change-me")
    import base64
    return base64.urlsafe_b64encode(hashlib.sha256(secret.encode()).digest())

def encrypt_val(txt):
    if not txt: return ""
    if Fernet is None: return txt
    try:
        f = Fernet(get_enc_key())
        return f.encrypt(txt.encode()).decode()
    except Exception as e:
        print(f"Encrypt error: {e}")
        return ""

def decrypt_val(txt):
    if not txt: return ""
    if Fernet is None: return txt
    try:
        f = Fernet(get_enc_key())
        return f.decrypt(txt.encode()).decode()
    except:
        return ""


def init_exchange_table():
    """Ensure exchange API storage exists and is backward compatible."""
    try:
        conn = get_exchange_db()
        c = conn.cursor()
        # New schema (per-user)
        c.execute("""
            CREATE TABLE IF NOT EXISTS exchange_api_keys (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id TEXT,
                exchange TEXT,
                api_key TEXT,
                api_secret TEXT,
                passphrase TEXT,
                mode TEXT DEFAULT 'test',
                updated_at TEXT,
                UNIQUE(user_id, exchange)
            )
        """)
        conn.commit()

        # Backward compat: if old table exists without user_id / mode
        cols = [r[1] for r in c.execute("PRAGMA table_info(exchange_api_keys)").fetchall()]
        if "user_id" not in cols:
            try:
                c.execute("ALTER TABLE exchange_api_keys ADD COLUMN user_id TEXT")
                conn.commit()
            except Exception:
                pass
        if "mode" not in cols:
            try:
                c.execute("ALTER TABLE exchange_api_keys ADD COLUMN mode TEXT DEFAULT 'test'")
                conn.commit()
            except Exception:
                pass
        if "updated_at" not in cols:
            try:
                c.execute("ALTER TABLE exchange_api_keys ADD COLUMN updated_at TEXT")
                conn.commit()
            except Exception:
                pass

        # Backfill user_id for older rows
        try:
            c.execute("UPDATE exchange_api_keys SET user_id='global' WHERE user_id IS NULL OR user_id=''")
            conn.commit()
        except Exception:
            pass

        conn.close()
    except Exception as e:
        print(f"[EXCHANGE] init table error: {e}")



# === Encryption helpers for API keys (AES-256 GCM) ===
try:
    from cryptography.hazmat.primitives.ciphers.aead import AESGCM
except Exception:
    AESGCM = None

def _enc_key_bytes():
    """Derive 32-byte key from environment variable AU_ENCRYPTION_KEY or SECRET_KEY."""
    raw = (os.environ.get("AU_ENCRYPTION_KEY") or os.environ.get("SECRET_KEY") or "au-autotrade-default-key").encode("utf-8")
    return hashlib.sha256(raw).digest()

def encrypt_data(plaintext: str) -> str:
    if plaintext is None:
        return ""
    if AESGCM is None:
        # fallback (still reversible) - base64; better than crash
        return base64.urlsafe_b64encode(plaintext.encode("utf-8")).decode("utf-8")
    key = _enc_key_bytes()
    aes = AESGCM(key)
    nonce = os.urandom(12)
    ct = aes.encrypt(nonce, plaintext.encode("utf-8"), None)
    blob = nonce + ct
    return base64.urlsafe_b64encode(blob).decode("utf-8")

def decrypt_data(token: str) -> str:
    if not token:
        return ""
    try:
        # Try Fernet first (gAAAAA... format)
        if token.startswith('gAAAAA') and Fernet is not None:
            try:
                secret = os.getenv("SESSION_SECRET", "default-secret-key-change-me")
                key = base64.urlsafe_b64encode(hashlib.sha256(secret.encode()).digest())
                f = Fernet(key)
                return f.decrypt(token.encode()).decode()
            except Exception:
                pass
        
        # Try AESGCM
        if AESGCM is None:
            return base64.urlsafe_b64decode(token.encode("utf-8")).decode("utf-8")
        blob = base64.urlsafe_b64decode(token.encode("utf-8"))
        nonce, ct = blob[:12], blob[12:]
        aes = AESGCM(_enc_key_bytes())
        pt = aes.decrypt(nonce, ct, None)
        return pt.decode("utf-8")
    except Exception:
        # Return original if decryption fails (unencrypted data)
        return token

def _ensure_exchange_api_keys_table(conn):
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS exchange_api_keys (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            exchange TEXT NOT NULL,
            mode TEXT NOT NULL,
            api_key_enc TEXT,
            api_secret_enc TEXT,
            passphrase_enc TEXT,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
            UNIQUE(user_id, exchange, mode)
        )
    """)
    conn.commit()

@app.route('/api/exchange/save', methods=['POST'])

def save_exchange_config():
    """Persist API keys; UI expects it to stay saved and show as connected."""
    try:
        data = request.get_json(force=True, silent=True) or {}
        exchange = (data.get('exchange') or data.get('provider') or 'okx').lower()
        mode = (data.get('mode') or data.get('account_mode') or 'test').lower()
        api_key = data.get('api_key') or ''
        api_secret = data.get('api_secret') or ''
        passphrase = data.get('passphrase') or ''

        user_id = session.get('user_id') or 'global'
        # Ensure user_id is stored consistently as string
        user_id = str(user_id)

        conn = get_exchange_db()
        c = conn.cursor()
        init_exchange_table()

        # Use INSERT OR REPLACE to handle existing entries
        try:
            # First try to delete any existing entry with same user_id, exchange, mode
            c.execute("DELETE FROM exchange_api_keys WHERE user_id=? AND exchange=? AND mode=?", (user_id, exchange, mode))
        except Exception:
            pass
        
        try:
            from datetime import datetime as dt_now
            c.execute("""
                INSERT INTO exchange_api_keys (user_id, exchange, api_key, api_secret, passphrase, mode, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            """, (user_id, exchange, encrypt_data(api_key), encrypt_data(api_secret), encrypt_data(passphrase), mode, dt_now.now(timezone.utc).isoformat()))
        except Exception:
            # If INSERT fails, try UPDATE
            from datetime import datetime as dt_now
            c.execute("""
                UPDATE exchange_api_keys 
                SET api_key=?, api_secret=?, passphrase=?, updated_at=?
                WHERE user_id=? AND exchange=? AND mode=?
            """, (encrypt_data(api_key), encrypt_data(api_secret), encrypt_data(passphrase), dt_now.now(timezone.utc).isoformat(), user_id, exchange, mode))
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': 'API keys saved successfully'})
    except Exception as e:
        print(f"[EXCHANGE] save error: {e}")
        return jsonify({'success': False, 'message': str(e)}), 500


@app.route('/api/exchange/delete', methods=['POST'])
def delete_exchange_config():
    """Delete API keys for an exchange"""
    if not session.get("logged_in"):
        return jsonify({'success': False, 'message': 'Login required'}), 401
    
    try:
        data = request.get_json(force=True, silent=True) or {}
        exchange = (data.get('exchange') or '').lower()
        
        if not exchange:
            return jsonify({'success': False, 'message': 'Exchange belirtilmedi'}), 400
        
        user_id = session.get('user_id') or 'global'
        # Ensure user_id is stored consistently as string
        user_id = str(user_id)
        
        conn = get_exchange_db()
        c = conn.cursor()
        c.execute("DELETE FROM exchange_api_keys WHERE user_id=? AND exchange=?", (user_id, exchange))
        deleted = c.rowcount
        conn.commit()
        conn.close()
        
        if deleted > 0:
            return jsonify({'success': True, 'message': f'{exchange.upper()} API anahtarÄ± silindi'})
        else:
            return jsonify({'success': False, 'message': 'API anahtarÄ± bulunamadÄ±'}), 404
    except Exception as e:
        print(f"[EXCHANGE] delete error: {e}")
        return jsonify({'success': False, 'message': str(e)}), 500


@app.route('/api/exchange/list')

def list_exchange_config():
    if 'user' not in session and 'username' not in session and 'user_id' not in session:
        return jsonify({'success': False}), 401
    user_id = str(session.get('user_id') or 'global')
    show_full = request.args.get('show_full') == '1'  # Add parameter to show full keys
    
    try:
        init_exchange_table()
        conn = get_exchange_db()
        c = conn.cursor()
        cols = [r[1] for r in c.execute("PRAGMA table_info(exchange_api_keys)").fetchall()]
        sel = "SELECT exchange, mode, api_key, api_secret, passphrase FROM exchange_api_keys WHERE user_id=?"
        c.execute(sel, (user_id,))
        rows = c.fetchall()
        conn.close()
        result = {}
        for exchange, mode, api_key_enc, api_secret_enc, passphrase_enc in rows:
            api_key_plain = decrypt_data(api_key_enc) if api_key_enc else ''
            api_secret_plain = decrypt_data(api_secret_enc) if api_secret_enc else ''
            
            result[exchange] = {
                'mode': mode or 'test',
                'api_key_masked': (api_key_plain[:4] + '...' + api_key_plain[-4:]) if api_key_plain and len(api_key_plain) > 8 else ('***' if api_key_plain else ''),
                'connected': bool(api_key_plain and api_secret_plain),
                'has_keys': bool(api_key_plain)
            }
            
            # Only return full keys if explicitly requested (for eye icon reveal)
            if show_full and api_key_plain:
                result[exchange]['api_key_full'] = api_key_plain
                result[exchange]['api_secret_masked'] = (api_secret_plain[:4] + '...' + api_secret_plain[-4:]) if api_secret_plain and len(api_secret_plain) > 8 else '***'
        
        return jsonify({'success': True, 'configs': result})
    except Exception as e:
        print(f"[EXCHANGE] list error: {e}")
        return jsonify({'success': False, 'message': str(e)}), 500


# Note: page_about, page_contact, page_faq, page_support routes defined at end of file (line ~25660)

@app.route('/education')
@app.route('/education-hub')
@app.route('/api/app/education')
def page_education():
    return render_template_string(EDUCATION_TEMPLATE)

@app.route('/portfolio')
@app.route('/portfolio-analytics')
def page_portfolio():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(PORTFOLIO_ANALYTICS_TEMPLATE, sidebar=get_sidebar_html("portfolio"))

@app.route('/payment')
@app.route('/payment-management')
def page_payment():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(PAYMENT_MANAGEMENT_TEMPLATE, sidebar=get_sidebar_html("payment"))

@app.route('/exchange-api')
def page_exchange_api():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(EXCHANGE_API_TEMPLATE, sidebar=get_sidebar_html("exchange-api"))

# OLD DASHBOARD ROUTE - DISABLED, using new FULL_DASHBOARD_TEMPLATE at end of file
# @app.route('/dashboard')
# @app.route('/trading-dashboard')
# def page_dashboard():
#     if not session.get("logged_in"): return redirect("/api/app/login")
#     return render_template_string(DASHBOARD_TEMPLATE, title="Dashboard", sidebar=get_sidebar_html("dashboard"))


@app.route('/history')
@app.route('/trade-history')
def page_history():
    if not session.get("logged_in"):
        return redirect("/api/app/login")
    
    user_id = session.get("user_id", 0)
    # Use ui_mode which is set by mode toggle
    current_mode = "real" # Forced Real Mode
    if current_mode in ("live", "real"):
        current_mode = "real"
    
    print(f"[HISTORY] user_id={user_id}, current_mode={current_mode}")
    
    # Get trades from database
    all_trades = []
    try:
        conn = db()
        
        print(f"[HISTORY DEBUG] user_id={user_id}, mode={current_mode}")
        
        if current_mode == "demo":
            # Get from demo_positions, auto_positions AND demo_trades tables
            rows = []
            
            # From demo_positions (closed)
            try:
                demo_rows = conn.execute("""
                    SELECT id, coin, side, amount_usdt, entry_price, current_price, pnl, status, created_at, closed_at
                    FROM demo_positions 
                    WHERE user_id=? AND status='closed'
                    ORDER BY closed_at DESC
                    LIMIT 100
                """, (user_id,)).fetchall()
                rows.extend(demo_rows)
            except Exception:
                pass
            
            # From auto_positions (closed)
            try:
                auto_rows = conn.execute("""
                    SELECT id, coin, 'BUY' as side, amount_usdt, entry_price, entry_price as current_price, pnl, status, created_at, exit_at as closed_at
                    FROM auto_positions 
                    WHERE user_id=? AND status='closed' AND mode='demo'
                    ORDER BY exit_at DESC
                    LIMIT 100
                """, (user_id,)).fetchall()
                print(f"[HISTORY DEBUG] auto_positions rows: {len(auto_rows)}")
                rows.extend(auto_rows)
            except Exception as e:
                print(f"[HISTORY DEBUG] auto_positions error: {e}")
                pass
            
            # From demo_trades table
            try:
                trade_rows = conn.execute("""
                    SELECT id, coin, side, amount_usdt, price as entry_price, price as current_price, pnl, 'closed' as status, created_at, created_at as closed_at
                    FROM demo_trades 
                    WHERE user_id=?
                    ORDER BY created_at DESC
                    LIMIT 100
                """, (user_id,)).fetchall()
                rows.extend(trade_rows)
            except Exception:
                pass
            
            # From transaction_history table (where BUY/SELL are actually logged)
            try:
                username = session.get("username", "")
                hist_rows = conn.execute("""
                    SELECT id, symbol, type, amount, price, total, profit, timestamp, mode
                    FROM transaction_history 
                    WHERE username=? AND mode='demo'
                    ORDER BY timestamp DESC
                    LIMIT 100
                """, (username,)).fetchall()
                print(f"[HISTORY DEBUG] transaction_history rows: {len(hist_rows)}")
                
                for hr in hist_rows:
                    # Convert timestamp to datetime
                    try:
                        ts = int(hr[7]) if hr[7] else 0
                        dt = datetime.utcfromtimestamp(ts) + timedelta(hours=3) if ts > 0 else datetime.utcnow() + timedelta(hours=3)
                    except:
                        dt = datetime.utcnow() + timedelta(hours=3)
                    
                    all_trades.append({
                        "id": f"TXN-{hr[0]:06d}",
                        "timestamp": dt.strftime('%d/%m/%Y %H:%M:%S'),
                        "pair": hr[1] or "BTC/USDT",
                        "type": str(hr[2] or "BUY").lower(),
                        "amount": float(hr[3] or 0),
                        "price": float(hr[4] or 0),
                        "total": float(hr[5] or 0),  # This is USDT amount
                        "fee": 0.0,
                        "profit": float(hr[6] or 0),
                        "exchange": "Demo",
                        "mode": "DEMO"
                    })
            except Exception as e:
                print(f"[HISTORY DEBUG] transaction_history error: {e}")
                pass
            
            for r in rows:
                # Convert tuple to dict
                if hasattr(r, 'keys'):
                    row = dict(r)
                else:
                    row = {"id": r[0], "coin": r[1], "side": r[2], "amount_usdt": r[3], 
                           "entry_price": r[4], "current_price": r[5], "pnl": r[6], 
                           "status": r[7], "created_at": r[8], "closed_at": r[9]}
                
                closed_ts = row.get("closed_at", 0) or row.get("created_at", 0) or 0
                
                # Parse timestamp - handle both ISO strings and integers
                try:
                    if isinstance(closed_ts, str):
                        if 'T' in closed_ts:
                            # ISO format string - parse manually
                            # Example: 2026-02-01T00:13:35.707221+00:00
                            date_part = closed_ts.split('T')[0]  # 2026-02-01
                            parts = date_part.split('-')
                            dt = datetime(int(parts[0]), int(parts[1]), int(parts[2])) + timedelta(hours=3)
                        else:
                            # Numeric string
                            dt = datetime.utcfromtimestamp(int(float(closed_ts))) + timedelta(hours=3)
                    elif isinstance(closed_ts, (int, float)) and closed_ts > 0:
                        dt = datetime.utcfromtimestamp(int(closed_ts)) + timedelta(hours=3)
                    else:
                        dt = datetime.utcnow() + timedelta(hours=3)
                except Exception:
                    dt = datetime.utcnow() + timedelta(hours=3)
                
                all_trades.append({
                    "id": f"DEMO-{row.get('id', 0):06d}",
                    "timestamp": dt.strftime('%d/%m/%Y %H:%M:%S'),
                    "pair": row.get("coin", "BTC/USDT"),
                    "type": str(row.get("side", "BUY")).lower(),
                    "amount": float(row.get("amount_usdt", 0) or 0) / max(float(row.get("entry_price", 1) or 1), 0.01),
                    "price": float(row.get("entry_price", 0) or 0),
                    "total": float(row.get("amount_usdt", 0) or 0),
                    "fee": 0.0,
                    "profit": float(row.get("pnl", 0) or 0),
                    "exchange": "Demo",
                    "mode": "DEMO"
                })
        else:
            # Get from real_trades table
            rows = conn.execute("""
                SELECT id, symbol, side, amount, price, order_id, status, created_at, closed_at, exchange
                FROM real_trades 
                WHERE user_id=? AND status='CLOSED'
                ORDER BY closed_at DESC
                LIMIT 200
            """, (user_id,)).fetchall()
            
            for r in rows:
                if hasattr(r, 'keys'):
                    row = dict(r)
                else:
                    row = {"id": r[0], "symbol": r[1], "side": r[2], "amount": r[3],
                           "price": r[4], "order_id": r[5], "status": r[6],
                           "created_at": r[7], "closed_at": r[8], "exchange": r[9]}
                
                closed_ts = row.get("closed_at", 0) or row.get("created_at", 0) or 0
                try:
                    closed_ts = int(float(str(closed_ts).replace('+00:00', '').replace('T', ' ').split('.')[0] if 'T' in str(closed_ts) else closed_ts))
                except:
                    closed_ts = 0
                if closed_ts > 0:
                    dt = datetime.utcfromtimestamp(closed_ts) + timedelta(hours=3)
                else:
                    dt = datetime.utcnow() + timedelta(hours=3)
                
                all_trades.append({
                    "id": f"REAL-{row.get('id', 0):06d}",
                    "timestamp": dt.strftime('%d/%m/%Y %H:%M:%S'),
                    "pair": row.get("symbol", "BTC/USDT"),
                    "type": row.get("side", "BUY").lower(),
                    "amount": float(row.get("amount", 0)),
                    "price": float(row.get("price", 0)),
                    "total": float(row.get("amount", 0)) * float(row.get("price", 0)),
                    "fee": 0.0,
                    "profit": 0.0,  # Real trades don't have pnl stored yet
                    "exchange": row.get("exchange", "OKX").upper(),
                    "mode": "REAL"
                })
        
        conn.close()
    except Exception as e:
        print(f"Trade history DB error: {e}")
        all_trades = []

    # Filters
    start_date = request.args.get('start_date', '')
    end_date = request.args.get('end_date', '')
    exchange = request.args.get('exchange', 'all')
    trade_type = request.args.get('trade_type', 'all')

    filtered_trades = all_trades
    from datetime import datetime as dt_cls

    if start_date:
        try: sd = dt_cls.strptime(start_date, '%Y-%m-%d')
        except: sd = None
        if sd: filtered_trades = [t for t in filtered_trades if dt_cls.strptime(t['timestamp'].split(' ')[0], '%d/%m/%Y') >= sd]
    
    if end_date:
        try: ed = dt_cls.strptime(end_date, '%Y-%m-%d')
        except: ed = None
        if ed: filtered_trades = [t for t in filtered_trades if dt_cls.strptime(t['timestamp'].split(' ')[0], '%d/%m/%Y') <= ed]

    if exchange != 'all':
        filtered_trades = [t for t in filtered_trades if t['exchange'].lower() == exchange.lower()]

    if trade_type != 'all':
        filtered_trades = [t for t in filtered_trades if t['type'] == trade_type]

    # Stats
    total_trades_count = len(filtered_trades)
    success_trades = len([t for t in filtered_trades if t['profit'] > 0])
    success_rate = round((success_trades / total_trades_count * 100) if total_trades_count > 0 else 0, 2)
    total_profit = round(sum(t['profit'] for t in filtered_trades), 2)
    total_volume_val = sum(t['total'] for t in filtered_trades)
    avg_volume = round((total_volume_val / total_trades_count) if total_trades_count > 0 else 0, 2)

    # Pagination
    page = int(request.args.get('page', 1))
    per_page = 20
    total_pages = (total_trades_count + per_page - 1) // per_page
    start_idx = (page - 1) * per_page
    end_idx = start_idx + per_page
    paginated_trades = filtered_trades[start_idx:end_idx]

    return render_template_string(
        TRADE_HISTORY_TEMPLATE,
        trades=paginated_trades,
        total_trades=total_trades_count,
        success_rate=success_rate,
        total_profit=total_profit,
        total_pnl=total_profit,
        avg_volume=avg_volume,
        page=page,
        total_pages=total_pages,
        per_page=per_page,
        start_date=start_date,
        end_date=end_date,
        exchange=exchange,
        trade_type=trade_type,
        current_mode=current_mode.upper(),
        sidebar=get_sidebar_html("history")
    )

@app.route("/market")
@app.route("/market-analysis")
def page_market():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(MARKET_ANALYSIS_TEMPLATE, sidebar=get_sidebar_html("market"))

@app.route("/chat")
@app.route("/live-trading-chat")
def page_chat():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(LIVE_TRADING_CHAT_TEMPLATE, sidebar=get_sidebar_html("chat"))

@app.route('/pnl-reporting-center')
def page_pnl_report():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(PNL_REPORTING_CENTER_TEMPLATE, sidebar=get_sidebar_html("pnl"))

@app.route('/ai-trade-recommendations')
def page_ai_recommendations():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(AI_TRADE_RECOMMENDATIONS_TEMPLATE, sidebar=get_sidebar_html("ai"))

@app.route('/arbitrage-monitor')
def page_arbitrage():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(ARBITRAGE_MONITOR_TEMPLATE, sidebar=get_sidebar_html("arbitrage"))

@app.route('/getting-started')
@app.route('/getting-started-guide')
def page_getting_started():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(GETTING_STARTED_GUIDE_TEMPLATE, sidebar=get_sidebar_html("guide"))

@app.route('/api/trades/export')
def api_trades_export():
    """Export trade history as PDF"""
    if not session.get("logged_in"):
        return jsonify({"error": "GiriÅŸ yapmanÄ±z gerekiyor"}), 401
    
    from io import BytesIO
    from datetime import datetime
    
    # Get mock trade data
    trades = [
        {"id": 'TRD-2026-001234', "timestamp": '14/01/2026 16:45:23', "pair": 'BTC/TRY', "type": 'buy', "amount": 0.05234567, "price": 2845678.50, "total": 148956.32, "profit": 4567.89, "exchange": 'Binance'},
        {"id": 'TRD-2026-001233', "timestamp": '14/01/2026 15:32:11', "pair": 'ETH/TRY', "type": 'sell', "amount": 1.23456789, "price": 98765.43, "total": 121923.45, "profit": -2345.67, "exchange": 'OKX'},
        {"id": 'TRD-2026-001232', "timestamp": '14/01/2026 14:18:45', "pair": 'XRP/TRY', "type": 'buy', "amount": 5678.90123456, "price": 23.45, "total": 133190.24, "profit": 1234.56, "exchange": 'BTCTURK'},
    ]
    
    # Generate simple text-based PDF content
    content = "Ä°ÅLEM GEÃ‡MÄ°ÅÄ° RAPORU\\n"
    content += f"OluÅŸturulma Tarihi: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\\n"
    content += "=" * 60 + "\\n\\n"
    
    total_profit = 0
    for t in trades:
        content += f"Ä°ÅŸlem ID: {t['id']}\\n"
        content += f"Tarih: {t['timestamp']}\\n"
        content += f"Ã‡ift: {t['pair']} | Tip: {t['type'].upper()} | Borsa: {t['exchange']}\\n"
        content += f"Miktar: {t['amount']:.8f} | Fiyat: {t['price']:,.2f} TRY\\n"
        content += f"Toplam: {t['total']:,.2f} TRY | Kar/Zarar: {t['profit']:+,.2f} TRY\\n"
        content += "-" * 40 + "\\n"
        total_profit += t['profit']
    
    content += f"\\nToplam Kar/Zarar: {total_profit:+,.2f} TRY\\n"
    
    buf = BytesIO(content.encode('utf-8'))
    buf.seek(0)
    
    return send_file(
        buf,
        mimetype='text/plain',
        as_attachment=True,
        download_name=f'islem_gecmisi_{datetime.now().strftime("%Y%m%d_%H%M%S")}.txt'
    )

@app.route('/api/portfolio/export')
def api_portfolio_export():
    """Export portfolio report as PDF"""
    if not session.get("logged_in"):
        return jsonify({"error": "GiriÅŸ yapmanÄ±z gerekiyor"}), 401
    
    from io import BytesIO
    from datetime import datetime
    
    # Generate portfolio report content
    content = "PORTFÃ–Y ANALÄ°Z RAPORU\\n"
    content += f"OluÅŸturulma Tarihi: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\\n"
    content += "=" * 60 + "\\n\\n"
    
    content += "VARLIK DAÄILIMI\\n"
    content += "-" * 40 + "\\n"
    content += "BTC: 45.2% (â‚¿0.5234)\\n"
    content += "ETH: 28.5% (Î3.456)\\n"
    content += "USDT: 15.3% ($12,450)\\n"
    content += "DiÄŸer: 11.0%\\n\\n"
    
    content += "PERFORMANS\\n"
    content += "-" * 40 + "\\n"
    content += "Toplam DeÄŸer: $45,678.90\\n"
    content += "24s DeÄŸiÅŸim: +2.34%\\n"
    content += "7g DeÄŸiÅŸim: +8.56%\\n"
    content += "30g DeÄŸiÅŸim: +15.23%\\n"
    
    buf = BytesIO(content.encode('utf-8'))
    buf.seek(0)
    
    return send_file(
        buf,
        mimetype='text/plain',
        as_attachment=True,
        download_name=f'portfoy_raporu_{datetime.now().strftime("%Y%m%d_%H%M%S")}.txt'
    )


# Configure Jinja to load templates from strings (for Single File support)

TRADE_HISTORY_TEMPLATE = r"""
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f]">
    <div class="p-4 md:p-8 pt-16 lg:pt-8">
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- Header -->
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h1 class="text-3xl font-bold text-white">Ä°ÅŸlem GeÃ§miÅŸi</h1>
                        {{ total_profit|round(2) }} â‚º
                    </div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-blue-400">{{ avg_volume|round(2) }} â‚º</div>
                </div>
            </div>

            <!-- Filters -->
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                <form action="/trade-history" method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-2">Borsa</label>
                        <select name="exchange" class="w-full bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                            <option value="all" {% if exchange == 'all' %}selected{% endif %}>TÃ¼m Borsalar</option>
                            <option value="binance" {% if exchange == 'binance' %}selected{% endif %}>Binance</option>
                            <option value="okx" {% if exchange == 'okx' %}selected{% endif %}>OKX</option>
                            <option value="bybit" {% if exchange == 'bybit' %}selected{% endif %}>Bybit</option>
                            <option value="gate.io" {% if exchange == 'gate.io' %}selected{% endif %}>Gate.io</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-2">Tip</label>
                        <select name="trade_type" class="w-full bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                            <option value="all" {% if trade_type == 'all' %}selected{% endif %}>TÃ¼m Tipler</option>
                            <option value="buy" {% if trade_type == 'buy' %}selected{% endif %}>AlÄ±m</option>
                            <option value="sell" {% if trade_type == 'sell' %}selected{% endif %}>SatÄ±m</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-2">BaÅŸlangÄ±Ã§</label>
                        <input type="date" name="start_date" value="{{ start_date }}" class="w-full bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-2">BitiÅŸ</label>
                        <input type="date" name="end_date" value="{{ end_date }}" class="w-full bg-[#242424] border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 text-sm font-bold transition-colors">Filtrele</button>
                </form>
            </div>

            <!-- Table -->
            <div class="bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-white/5 text-gray-400 text-xs font-bold uppercase tracking-wider">
                                <th class="px-6 py-4">Ä°ÅŸlem No</th>
                                <th class="px-6 py-4">Tarih</th>
                                <th class="px-6 py-4">Ã‡ift</th>
                                <th class="px-6 py-4">Tip</th>
                                <th class="px-6 py-4">Miktar</th>
                                <th class="px-6 py-4">Fiyat</th>
                                <th class="px-6 py-4">Toplam</th>
                                <th class="px-6 py-4">Kar/Zarar</th>
                                <th class="px-6 py-4">Mod</th>
                                <th class="px-6 py-4">Borsa</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            {% for trade in trades %}
                            <tr class="hover:bg-white/5 transition-colors group">
                                <td class="px-6 py-4 text-xs font-mono text-gray-500 group-hover:text-blue-400">{{ trade.id }}</td>
                                <td class="px-6 py-4 text-sm text-gray-300">{{ trade.timestamp }}</td>
                                <td class="px-6 py-4 font-bold text-white">{{ trade.pair }}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase {% if trade.type == 'buy' %}bg-green-500/10 text-green-500{% else %}bg-red-500/10 text-red-500{% endif %}">
                                        {{ 'ALIM' if trade.type == 'buy' else 'SATIM' }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-300">{{ trade.amount }}</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-300">{{ trade.price|round(2) }}</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-300 font-bold text-white">{{ trade.total|round(2) }}</td>
                                <td class="px-6 py-4 text-sm font-mono font-bold {% if trade.profit >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                                    {{ trade.profit|round(2) }} â‚º
                                </td>
                                <td class="px-6 py-4">
                                        {{ trade.mode }}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="text-xs text-gray-400">{{ trade.exchange }}</span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="10" class="px-6 py-12 text-center text-gray-500 italic">KayÄ±tlÄ± iÅŸlem bulunamadÄ±.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if total_pages > 1 %}
                <div class="px-6 py-4 border-t border-white/5 flex items-center justify-between">
                    <div class="text-xs text-gray-500">
                        GÃ¶sterilen: {{ (page-1)*per_page + 1 }} - {{ [page*per_page, total_trades]|min }} / {{ total_trades }}
                    </div>
                    <div class="flex gap-2">
                        {% if page > 1 %}
                        <a href="?page={{ page-1 }}&exchange={{ exchange }}&trade_type={{ trade_type }}&start_date={{ start_date }}&end_date={{ end_date }}" class="px-3 py-1 rounded bg-[#242424] text-xs font-medium text-gray-300 hover:text-white transition-colors border border-white/10">&lt; Geri</a>
                        {% endif %}
                        
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                            <span class="px-3 py-1 rounded bg-blue-600 text-xs font-bold text-white border border-blue-600">{{ p }}</span>
                            {% elif p <= 3 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                            <a href="?page={{ p }}&exchange={{ exchange }}&trade_type={{ trade_type }}&start_date={{ start_date }}&end_date={{ end_date }}" class="px-3 py-1 rounded bg-[#242424] text-xs font-medium text-gray-300 hover:text-white transition-colors border border-white/10">{{ p }}</a>
                            {% elif p == 4 or p == total_pages - 2 %}
                            <span class="px-1 text-gray-600">...</span>
                            {% endif %}
                        {% endfor %}

                        {% if page < total_pages %}
                        <a href="?page={{ page+1 }}&exchange={{ exchange }}&trade_type={{ trade_type }}&start_date={{ start_date }}&end_date={{ end_date }}" class="px-3 py-1 rounded bg-[#242424] text-xs font-medium text-gray-300 hover:text-white transition-colors border border-white/10">Ä°leri &gt;</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
"""


NOTIFICATION_TEMPLATE = r"""
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-[#0f0f0f] text-gray-100 pb-20">
    {{ sidebar | safe }}

    <main class="lg:ml-64 p-4 md:p-8 pt-16 lg:pt-8">
        <div class="max-w-4xl mx-auto space-y-8">
            <!-- Header -->
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-extrabold text-white">Bildirim Tercihleri</h1>
                    <p class="text-sm text-gray-400 mt-1">Bildirim ayarlarÄ±nÄ±zÄ± yÃ¶netin</p>
                </div>
                <div class="bg-blue-500/10 p-2 rounded-lg text-blue-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Push Notifications -->
                <div class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 shadow-xl">
                    <h3 class="text-lg font-bold text-white mb-6">Push Notifications</h3>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold text-gray-200">Trading Signals</p>
                                <p class="text-[10px] text-gray-500">Get notified of new signals</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold text-gray-200">Price Alerts</p>
                                <p class="text-[10px] text-gray-500">Price target reached notifications</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold text-gray-200">Order Updates</p>
                                <p class="text-[10px] text-gray-500">Order fill notifications</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Email Notifications -->
                <div class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 shadow-xl">
                    <h3 class="text-lg font-bold text-white mb-6">Email Notifications</h3>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold text-gray-200">Daily Summary</p>
                                <p class="text-[10px] text-gray-500">Daily performance report</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold text-gray-200">Weekly Report</p>
                                <p class="text-[10px] text-gray-500">Monthly analysis email</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile App Settings -->
            <div class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 shadow-xl">
                <h3 class="text-lg font-bold text-white mb-6">Mobile App Settings</h3>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-200">Vibration</p>
                            <p class="text-[10px] text-gray-500">Vibrate on notifications</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-200">Sound</p>
                            <p class="text-[10px] text-gray-500">Play sound on alerts</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-200">Badge Count</p>
                            <p class="text-[10px] text-gray-500">Show unread count on app icon</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="flex justify-end">
                <button id="saveNotificationBtn" onclick="saveNotificationSettings()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-600/20">
                    ğŸ’¾ AyarlarÄ± Kaydet
                </button>
            </div>
        </div>
    </main>
</div>

<script>
    // Load notification settings on page load
    async function loadNotificationSettings() {
        try {
            const res = await fetch('/api/notifications/settings', { credentials: 'include' });
            const data = await res.json();
            
            if (data.ok && data.settings) {
                const settings = data.settings;
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                
                // Map settings to checkboxes by index (simplified mapping)
                const settingKeys = ['trade_alerts', 'price_alerts', 'order_updates', 'daily_summary', 'weekly_report', 'vibration_enabled', 'sound_enabled', 'badge_count'];
                
                checkboxes.forEach((cb, idx) => {
                    const key = settingKeys[idx];
                    if (key && settings[key] !== undefined) {
                        cb.checked = settings[key];
                    }
                });
            }
        } catch (e) {
            console.error('Failed to load notification settings:', e);
        }
    }
    
    // Save notification settings
    async function saveNotificationSettings() {
        const btn = document.getElementById('saveNotificationBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'â³ Kaydediliyor...';
        btn.disabled = true;
        
        try {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const settingKeys = ['trade_alerts', 'price_alerts', 'order_updates', 'daily_summary', 'weekly_report', 'vibration_enabled', 'sound_enabled', 'badge_count'];
            
            const settings = {};
            checkboxes.forEach((cb, idx) => {
                const key = settingKeys[idx];
                if (key) {
                    settings[key] = cb.checked;
                }
            });
            
            const res = await fetch('/api/notifications/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(settings)
            });
            
            const data = await res.json();
            
            if (data.ok) {
                btn.innerHTML = 'âœ… Kaydedildi!';
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                    btn.classList.add('bg-blue-600');
                    btn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (e) {
            alert('âŒ Kaydetme hatasÄ±: ' + e.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    // Load settings when page loads
    document.addEventListener('DOMContentLoaded', loadNotificationSettings);
</script>
{% endblock %}
"""

SYSTEM_HEALTH_TEMPLATE = r"""
{% extends "base" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-[#0a1628] via-[#0d1f3c] to-[#0a1628] pb-20">
    {{ sidebar | safe }}

    <main class="lg:ml-64 p-4 md:p-6 pt-16 lg:pt-6 min-h-screen">
        <div class="max-w-[1600px] mx-auto space-y-6">
            <!-- Header -->
            <div class="flex items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-white">Sistem SaÄŸlÄ±k Ä°zleyici</h1>
                    <p class="text-sm text-gray-400">GerÃ§ek zamanlÄ± baÄŸlantÄ± durumu, sunucu performansÄ± ve sistem bilgileri</p>
                </div>
                <div class="flex items-center gap-3">
                    <span class="px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-xs font-bold flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                        CanlÄ±
                    </span>
                    <span class="px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 text-xs flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        08:33:19
                    </span>
                    <button class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    </button>
                </div>
            </div>

            <!-- BaÄŸlantÄ± Durumu Section -->
            <div class="bg-[#0d1f3c]/80 rounded-2xl p-6 border border-white/5">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/></svg>
                        BaÄŸlantÄ± Durumu
                    </h2>
                    <div class="text-right">
                        <span class="text-3xl font-bold text-green-400">80%</span>
                        <p class="text-xs text-gray-400">BaÅŸarÄ± OranÄ±</p>
                    </div>
                </div>
                
                <!-- Exchange Cards Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- OKX Card -->
                    <div class="bg-gradient-to-br from-green-500/10 to-green-600/5 rounded-xl p-4 border border-green-500/20">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-bold text-white">OKX</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">aktif</span>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between text-gray-400">
                                <span>WebSocket</span>
                                <span class="text-green-400">â— baÄŸlÄ±</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>API YanÄ±tlarÄ±</span>
                                <span class="text-green-400">â— baÄŸlÄ±</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Ã‡alÄ±ÅŸma SÃ¼resi</span>
                                <span class="text-white">99.9%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Binance Card -->
                    <div class="bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 rounded-xl p-4 border border-yellow-500/20">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-bold text-white">Binance</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold bg-yellow-500/20 text-yellow-400 rounded">93.1%</span>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between text-gray-400">
                                <span>WebSocket</span>
                                <span class="text-green-400">â— aktif</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>API Durumu</span>
                                <span class="text-green-400">â— baÄŸlÄ±</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Ã‡alÄ±ÅŸma SÃ¼resi</span>
                                <span class="text-white">93.1%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bybit Card -->
                    <div class="bg-gradient-to-br from-green-500/10 to-green-600/5 rounded-xl p-4 border border-green-500/20">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-bold text-white">Bybit</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">aktif</span>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between text-gray-400">
                                <span>WebSocket</span>
                                <span class="text-green-400">â— baÄŸlÄ±</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>API Durumu</span>
                                <span class="text-green-400">â— baÄŸlÄ±</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Ã‡alÄ±ÅŸma SÃ¼resi</span>
                                <span class="text-white">97.2%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gate.io Card -->
                    <div class="bg-gradient-to-br from-green-500/10 to-green-600/5 rounded-xl p-4 border border-green-500/20">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-bold text-white">Gate.io</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">baÄŸlÄ±</span>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between text-gray-400">
                                <span>WebSocket</span>
                                <span class="text-green-400">â— aktif</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>API Durumu</span>
                                <span class="text-green-400">â— baÄŸlÄ±</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Ã‡alÄ±ÅŸma SÃ¼resi</span>
                                <span class="text-white">99.7%</span>
                            </div>
                        </div>
                        <button class="w-full mt-3 px-3 py-1.5 text-xs bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition-colors flex items-center justify-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Yeniden BaÄŸlanÄ±yor
                        </button>
                    </div>

                    <!-- BTCTURK Card -->
                    <div class="bg-gradient-to-br from-green-500/10 to-green-600/5 rounded-xl p-4 border border-green-500/20">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-bold text-white">BTCTURK</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">baÄŸlÄ±</span>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between text-gray-400">
                                <span>WebSocket</span>
                                <span class="text-green-400">â— aktif</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>API Durumu</span>
                                <span class="text-green-400">â— baÄŸlÄ±</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Ã‡alÄ±ÅŸma SÃ¼resi</span>
                                <span class="text-white">99.9%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout: Metrics and Auto-Refresh -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Ã–zellikler Metrikleri (Feature Metrics) -->
                <div class="bg-[#0d1f3c]/80 rounded-2xl p-6 border border-white/5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            Ã–zellikler Metrikleri
                        </h2>
                        <span class="text-xs text-gray-400">Piyasa veri akÄ±ÅŸÄ± gecikme istatistikleri</span>
                    </div>
                    <div class="flex items-center gap-2 mb-4">
                        <button class="px-3 py-1.5 text-xs bg-blue-500/20 text-blue-400 rounded-lg">Son Saatler</button>
                    </div>
                    
                    <!-- Stats Row -->
                    <div class="grid grid-cols-5 gap-3 mb-6">
                        <div class="text-center">
                            <p class="text-xs text-gray-400">Git</p>
                            <p class="text-lg font-bold text-blue-400">21.8ms</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400">Ortalama</p>
                            <p class="text-lg font-bold text-green-400">37.4ms</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400">Spreader</p>
                            <p class="text-lg font-bold text-purple-400">64.2ms</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400">Sorunlu</p>
                            <p class="text-lg font-bold text-yellow-400">120.1ms</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400">Kritik</p>
                            <p class="text-lg font-bold text-red-400">33.7ms</p>
                        </div>
                    </div>
                    
                    <!-- Chart Placeholder -->
                    <div class="h-40 bg-[#0a1628] rounded-xl p-4 relative overflow-hidden">
                        <canvas id="metricsChart"></canvas>
                        <!-- SVG Line Chart Fallback -->
                        <svg class="w-full h-full" viewBox="0 0 400 100" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="blueGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
                                </linearGradient>
                            </defs>
                            <!-- BTC Line -->
                            <polyline fill="none" stroke="#f59e0b" stroke-width="2" points="0,60 40,55 80,50 120,58 160,45 200,40 240,48 280,35 320,42 360,38 400,30"/>
                            <!-- Binance Line -->
                            <polyline fill="none" stroke="#22c55e" stroke-width="2" points="0,70 40,68 80,65 120,70 160,62 200,58 240,65 280,55 320,60 360,52 400,48"/>
                            <!-- Bybit Line -->
                            <polyline fill="none" stroke="#a855f7" stroke-width="2" points="0,80 40,75 80,78 120,72 160,70 200,75 240,68 280,72 320,65 360,68 400,62"/>
                            <!-- Gate Line -->
                            <polyline fill="none" stroke="#3b82f6" stroke-width="2" points="0,50 40,52 80,48 120,55 160,50 200,45 240,52 280,48 320,50 360,45 400,42"/>
                            <!-- Solana Line -->
                            <polyline fill="none" stroke="#ef4444" stroke-width="2" points="0,40 40,45 80,42 120,48 160,38 200,35 240,40 280,32 320,38 360,30 400,25"/>
                        </svg>
                    </div>
                    
                    <!-- Legend -->
                    <div class="flex flex-wrap items-center gap-4 mt-4 text-xs">
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-0.5 bg-yellow-500"></span>
                            <span class="text-gray-400">BTC</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-0.5 bg-green-500"></span>
                            <span class="text-gray-400">Binance</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-0.5 bg-purple-500"></span>
                            <span class="text-gray-400">Bybit</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-0.5 bg-blue-500"></span>
                            <span class="text-gray-400">Gate</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-0.5 bg-red-500"></span>
                            <span class="text-gray-400">Solana</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-0.5 bg-cyan-500"></span>
                            <span class="text-gray-400">BTCTURK</span>
                        </div>
                    </div>
                </div>

                <!-- Otomatik Yenileme Durumu (Auto-Refresh Status) -->
                <div class="bg-[#0d1f3c]/80 rounded-2xl p-6 border border-white/5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Otomatik Yenileme Durumu
                        </h2>
                        <span class="px-3 py-1.5 text-xs bg-blue-500/20 text-blue-400 rounded-lg cursor-pointer hover:bg-blue-500/30 transition-colors">Manuel Kontrol</span>
                    </div>
                    
                    <!-- Status Table -->
                    <div class="space-y-3">
                        <!-- Binance Row -->
                        <div class="flex items-center justify-between p-3 rounded-xl bg-[#0a1628] border border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="font-medium text-white">Binance</span>
                                <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">aktif</span>
                                <span class="px-2 py-0.5 text-[10px] font-bold bg-blue-500/20 text-blue-400 rounded">otomatik</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-gray-400">Son Sync: 1 dakika Ã¶nce</span>
                                <span class="text-xs text-gray-400">3 BaÄŸlantÄ± durumu</span>
                                <button class="px-3 py-1.5 text-xs bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">Mesafe API</button>
                            </div>
                        </div>

                        <!-- OKX Row -->
                        <div class="flex items-center justify-between p-3 rounded-xl bg-[#0a1628] border border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="font-medium text-white">OKX</span>
                                <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">Bybit</span>
                                <span class="px-2 py-0.5 text-[10px] font-bold bg-yellow-500/20 text-yellow-400 rounded">Bekliyor</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-gray-400">Son API: 2 dakika Ã¶nce</span>
                                <span class="text-xs text-gray-400">3 BaÄŸlantÄ± durumu</span>
                                <button class="px-3 py-1.5 text-xs bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">Mesafe API</button>
                            </div>
                        </div>

                        <!-- Balybit Row -->
                        <div class="flex items-center justify-between p-3 rounded-xl bg-[#0a1628] border border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="font-medium text-white">Balybit</span>
                                <span class="px-2 py-0.5 text-[10px] font-bold bg-blue-500/20 text-blue-400 rounded">BTCTURK</span>
                                <span class="px-2 py-0.5 text-[10px] font-bold bg-blue-500/20 text-blue-400 rounded">aktif</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-gray-400">Son Sync: 5 dakika Ã¶nce</span>
                                <span class="text-xs text-gray-400">5 BaÄŸlantÄ± durumu</span>
                                <button class="px-3 py-1.5 text-xs bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">Mesafe API</button>
                            </div>
                        </div>

                        <!-- Solana Row -->
                        <div class="flex items-center justify-between p-3 rounded-xl bg-[#0a1628] border border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="font-medium text-white">Solana</span>
                                <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">Binance</span>
                                <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">aktif</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-gray-400">Son API: 2 Saniye Ã¶nce</span>
                                <span class="text-xs text-gray-400">2 BaÄŸlantÄ± durumu</span>
                                <button class="px-3 py-1.5 text-xs bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">Mesafe API</button>
                            </div>
                        </div>
                    </div>

                    <!-- GÃ¼venlik Yenileme KaydÄ± Section -->
                    <div class="mt-6 p-4 rounded-xl bg-[#0a1628] border border-white/5">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <div>
                                <h4 class="text-sm font-bold text-white mb-1">GÃ¼venlik Yenileme KaydÄ±nda</h4>
                                <p class="text-xs text-gray-400">Sistem borsalar arasÄ± baÄŸlantÄ±larÄ± sÃ¼rekli olarak izlenmekte ve gerekli zamana otomatik olarak yeniden baÄŸlantÄ± kurulmaktadÄ±r. Manuel kontrol ile tÃ¼m borsa baÄŸlantÄ±larÄ±nÄ± test edebilirsiniz.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tensions BaÄŸlantÄ±sÄ± KayÄ±tlarÄ± (Connection Logs) -->
            <div class="bg-[#0d1f3c]/80 rounded-2xl p-6 border border-white/5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Tensions BaÄŸlantÄ±sÄ± KayÄ±tlarÄ±
                    </h2>
                    <div class="flex items-center gap-2">
                        <button class="px-3 py-1.5 text-xs bg-white/5 text-gray-400 rounded-lg hover:bg-white/10 transition-colors">Son Saatler</button>
                        <button class="px-3 py-1.5 text-xs bg-blue-500/20 text-blue-400 rounded-lg">Son 1 Saat</button>
                    </div>
                </div>
                
                <!-- Log Entries -->
                <div class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- OKX Log Entry -->
                    <div class="p-3 rounded-lg bg-[#0a1628] border border-white/5">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="font-medium text-white">OKX</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold bg-green-500/20 text-green-400 rounded">Yeniden baÄŸlandÄ±</span>
                            <span class="text-xs text-gray-500">12 dakika Ã¶nce</span>
                        </div>
                        <div class="text-xs text-gray-400">
                            <p>Web BaÄŸlantÄ±sÄ± durumu: TamamlandÄ±</p>
                            <p>Process: âœ“ | SÃ¼re: 0.5s</p>
                        </div>
                    </div>

                    <!-- Bybit Log Entry -->
                    <div class="p-3 rounded-lg bg-[#0a1628] border border-white/5">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="font-medium text-white">Bybit</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold bg-yellow-500/20 text-yellow-400 rounded">Aktif baÄŸlandÄ± kuruldu</span>
                            <span class="text-xs text-gray-500">25 dakika Ã¶nce</span>
                        </div>
                        <div class="text-xs text-gray-400">
                            <p>API baÄŸlantÄ± yapÄ±lÄ±yor</p>
                            <p>Timeout: 24 | SÃ¼re: 24s</p>
                        </div>
                    </div>

                    <!-- OKX Log Entry 2 -->
                    <div class="p-3 rounded-lg bg-[#0a1628] border border-white/5">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="font-medium text-white">OKX</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold bg-blue-500/20 text-blue-400 rounded">BaÄŸlantÄ±landÄ±</span>
                            <span class="text-xs text-gray-500">35 dakika Ã¶nce</span>
                        </div>
                        <div class="text-xs text-gray-400">
                            <p>API baÄŸlantÄ± yapÄ±lÄ±yor</p>
                            <p>Timeout: 2 | SÃ¼re: 20s</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
// Real-time system health updates
async function updateSystemHealth() {
    try {
        const res = await fetch('/api/system/health', {credentials: 'include'});
        const data = await res.json();
        
        if (data.ok) {
            // Update CPU
            const cpuEl = document.getElementById('cpuUsage');
            if (cpuEl) cpuEl.textContent = data.cpu.percent.toFixed(1) + '%';
            
            // Update Memory
            const memEl = document.getElementById('memUsage');
            if (memEl) memEl.textContent = data.memory.percent.toFixed(1) + '%';
            
            // Update Disk
            const diskEl = document.getElementById('diskUsage');
            if (diskEl) diskEl.textContent = data.disk.percent.toFixed(1) + '%';
            
            // Update uptime
            const uptimeEl = document.getElementById('uptime');
            if (uptimeEl) uptimeEl.textContent = data.uptime;
            
            // Update service statuses
            if (data.services) {
                Object.keys(data.services).forEach(svc => {
                    const el = document.getElementById('status-' + svc);
                    if (el) {
                        const isOnline = data.services[svc] === 'online';
                        el.textContent = isOnline ? 'â— Aktif' : 'â—‹ Devre DÄ±ÅŸÄ±';
                        el.className = isOnline ? 'text-green-400' : 'text-red-400';
                    }
                });
            }
            
            // Update timestamp
            const timeEl = document.querySelector('[data-time]');
            if (timeEl) {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('tr-TR');
            }
        }
    } catch (e) {
        console.error('Health update error:', e);
    }
}

// Update every 2 seconds
document.addEventListener('DOMContentLoaded', function() {
    updateSystemHealth();
    setInterval(updateSystemHealth, 2000);
});
</script>
{% endblock %}
"""

# MOVED TO END OF FILE TO SUPPORT FULL_DASHBOARD_TEMPLATE
# app.jinja_loader = jinja2.DictLoader({
#     "base": BASE_TEMPLATE,
#     "login": LOGIN_TEMPLATE,
#     "dashboard": DASHBOARD_TEMPLATE,
#     "about_us": ABOUT_US_TEMPLATE,
#     "contact": CONTACT_TEMPLATE,
#     "faq": FAQ_TEMPLATE,
#     "support": SUPPORT_TEMPLATE,
#     "education": EDUCATION_HUB_TEMPLATE,
#     "portfolio": PORTFOLIO_ANALYTICS_TEMPLATE,
#     "payment": PAYMENT_MANAGEMENT_TEMPLATE,
#     "exchange_api": EXCHANGE_API_TEMPLATE,
#     "market_analysis": MARKET_ANALYSIS_TEMPLATE,
#     "trade_history": TRADE_HISTORY_TEMPLATE,
#     "live_chat": LIVE_TRADING_CHAT_TEMPLATE,
#     "pnl_reporting": PNL_REPORTING_CENTER_TEMPLATE,
#     "admin_dashboard": ADMIN_DASHBOARD_TEMPLATE,
#     "notifications": NOTIFICATION_TEMPLATE,
#     "system_health": SYSTEM_HEALTH_TEMPLATE,
#     "ai_recommendations": AI_TRADE_RECOMMENDATIONS_TEMPLATE,
#     "arbitrage": ARBITRAGE_MONITOR_TEMPLATE,
#     "getting_started": GETTING_STARTED_GUIDE_TEMPLATE,
# })



@app.route("/api/admin/download-contract/<int:user_id>")
def download_contract_api(user_id):
    if not session.get("logged_in") or not (session.get("role") == "admin" or session.get("is_admin")):
        return redirect("/api/app/login")
    
    # Contract text as requested by user
    contract_text = """ATLAY ULUSOY AUTO TRADE
KULLANIM KOÅULLARI VE RÄ°SK BÄ°LDÄ°RÄ°MÄ° SÃ–ZLEÅMESÄ°

Bu "KullanÄ±m KoÅŸullarÄ± ve Risk Bildirimi SÃ¶zleÅŸmesi" ("SÃ¶zleÅŸme"); aÅŸaÄŸÄ±da bilgileri yer alan Hizmet SaÄŸlayÄ±cÄ± ile Hizmet Alan (KullanÄ±cÄ±) arasÄ±nda, KullanÄ±cÄ±'nÄ±n platformu kullanmasÄ± ve dijital ortamda onay vermesiyle yÃ¼rÃ¼rlÃ¼ÄŸe girmek Ã¼zere dÃ¼zenlenmiÅŸtir.

1. TARAFLAR

1.1. Hizmet SaÄŸlayÄ±cÄ±:
Atalay Ulusoy
(Bundan bÃ¶yle "Hizmet SaÄŸlayÄ±cÄ±" olarak anÄ±lacaktÄ±r.)

1.2. Hizmet Alan (KullanÄ±cÄ±):
Ad Soyad: [KullanÄ±cÄ± AdÄ±]
KullanÄ±cÄ± AdÄ±: [KullanÄ±cÄ±]
Kimlik No (opsiyonel): [ID]

2. SÃ–ZLEÅMENÄ°N KONUSU VE HÄ°ZMET KAPSAMI

2.1. Ä°ÅŸbu SÃ¶zleÅŸme; Atalay Ulusoy Auto Trade platformu ("Platform") Ã¼zerinden sunulan yazÄ±lÄ±m hizmetinin kullanÄ±m koÅŸullarÄ±nÄ±, risk bildirimini ve taraflarÄ±n hak ve yÃ¼kÃ¼mlÃ¼lÃ¼klerini dÃ¼zenler.

2.2. Platform kapsamÄ±nda;
a) Otomatik alÄ±m-satÄ±m iÅŸlemleri,
b) KullanÄ±cÄ± onayÄ± ile gerÃ§ekleÅŸtirilen manuel iÅŸlemler,
c) Teknik iÅŸlem otomasyonu ve bildirim sistemleri (Ã¶r. Telegram)
sunulabilir.

2.3. Sunulan hizmet yatÄ±rÄ±m danÄ±ÅŸmanlÄ±ÄŸÄ± niteliÄŸinde deÄŸildir. Platform, KullanÄ±cÄ±'ya herhangi bir ÅŸekilde kesin kazanÃ§, kÃ¢r veya gelir vaadinde bulunmaz.

2.4. Borsa, aÄŸ, internet altyapÄ±sÄ± ve Ã¼Ã§Ã¼ncÃ¼ taraf servis saÄŸlayÄ±cÄ±lar (borsa API'leri, TradingView, Telegram vb.) kaynaklÄ± kesinti, gecikme, hata ve eriÅŸim problemleri hizmetin sÃ¼rekliliÄŸini ve performansÄ±nÄ± etkileyebilir.

3. RÄ°SK BÄ°LDÄ°RÄ°MÄ°

3.1. Kripto varlÄ±k piyasalarÄ± yÃ¼ksek volatilite ve yÃ¼ksek risk iÃ§erir. KullanÄ±cÄ±, bu riskleri bildiÄŸini ve kabul ettiÄŸini beyan eder.

3.2. KullanÄ±cÄ±; sermayesinin bir kÄ±smÄ±nÄ± veya tamamÄ±nÄ± kaybedebileceÄŸini, beklenmedik piyasa hareketlerinin hÄ±zlÄ± zararlara yol aÃ§abileceÄŸini kabul eder.

3.3. Platform Ã¼zerinden gerÃ§ekleÅŸtirilen tÃ¼m iÅŸlemler, nihai olarak KullanÄ±cÄ±'nÄ±n sorumluluÄŸundadÄ±r. KullanÄ±cÄ±, Platform'un iÅŸlem kararlarÄ±na iliÅŸkin herhangi bir garanti vermediÄŸini kabul eder.

4. SORUMLULUK REDDÄ° VE SINIRLARI

4.1. Hizmet SaÄŸlayÄ±cÄ±; doÄŸrudan veya dolaylÄ± ÅŸekilde oluÅŸabilecek zarar, kayÄ±p, komisyon, fonlama, spread, slipaj, emir gecikmesi, kÄ±smi/eksik gerÃ§ekleÅŸme, borsa kaynaklÄ± hatalar ve benzeri sonuÃ§lardan sorumlu tutulamaz.

4.2. Platform hiÃ§bir koÅŸulda kesin kÃ¢r, gelir veya kazanÃ§ garantisi vermez. KullanÄ±cÄ± bu durumu kabul eder.

4.3. KullanÄ±cÄ±; API anahtarlarÄ±nÄ± ve hesap eriÅŸim bilgilerini gizli tutmakla, kendi hesabÄ±nÄ±n gÃ¼venliÄŸi iÃ§in gerekli tedbirleri almakla yÃ¼kÃ¼mlÃ¼dÃ¼r. API anahtarlarÄ±nÄ±n ele geÃ§irilmesi, kÃ¶tÃ¼ye kullanÄ±mÄ± veya yetkisiz eriÅŸimden doÄŸan sonuÃ§lar KullanÄ±cÄ±'nÄ±n sorumluluÄŸundadÄ±r.

4.4. KullanÄ±cÄ±, emirlerin borsa kurallarÄ±, minimum miktarlar, likidite, teknik sÄ±nÄ±rlamalar veya borsa risk kontrolleri nedeniyle kÄ±smen veya tamamen gerÃ§ekleÅŸmeyebileceÄŸini kabul eder.

4.5. Hizmet SaÄŸlayÄ±cÄ±; dolaylÄ± zararlar, mahrum kalÄ±nan kÃ¢r, itibar kaybÄ±, fÄ±rsat kaybÄ± gibi taleplerden hiÃ§bir ÅŸekilde sorumlu tutulamaz.

5. VERÄ° GÄ°ZLÄ°LÄ°ÄÄ° VE GÃœVENLÄ°K

5.1. SÃ¶zleÅŸme onayÄ± ve kayÄ±tlarÄ±; KullanÄ±cÄ± adÄ±, ad-soyad, kimlik no (opsiyonel), tarih ve IP bilgisi ile sunucuda saklanabilir.

5.2. KullanÄ±cÄ± bilgileri Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle paylaÅŸÄ±lmaz. Ancak yasal zorunluluklar ve yetkili mercilerin talepleri saklÄ±dÄ±r.

5.3. EriÅŸim ve iÅŸlem kayÄ±tlarÄ± gÃ¼venlik, denetim ve hata analizi amaÃ§larÄ±yla loglanabilir.

6. KULLANIM ÅARTLARI VE KULLANICI YÃœKÃœMLÃœLÃœKLERÄ°

6.1. KullanÄ±cÄ±; kendi borsa hesabÄ±nÄ±n, API baÄŸlantÄ±larÄ±nÄ±n ve internet altyapÄ±sÄ±nÄ±n Ã§alÄ±ÅŸÄ±r durumda olmasÄ±ndan sorumludur.

6.2. KullanÄ±cÄ±, borsa API anahtarlarÄ±nda verilecek yetkileri kendi tercihiyle belirler. KullanÄ±cÄ±'nÄ±n, gÃ¼venlik amacÄ±yla "para Ã§ekme (withdrawal)" yetkisi vermemesi Ã¶nerilir.

6.3. KullanÄ±cÄ±; ÅŸifre, PIN, eriÅŸim bilgileri ve API anahtarlarÄ±nÄ± Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle paylaÅŸamaz.

6.4. KullanÄ±cÄ±, Platform'u hukuka aykÄ±rÄ± amaÃ§larla kullanamaz. Bu kapsamdaki ihlallerde Hizmet SaÄŸlayÄ±cÄ±'nÄ±n eriÅŸimi kÄ±sÄ±tlama ve/veya hesabÄ± sonlandÄ±rma hakkÄ± saklÄ±dÄ±r.

7. ÃœCRETLENDÄ°RME VE PAKETLER

7.1. Hizmet; seÃ§ilen pakete gÃ¶re kullanÄ±m limiti, dÃ¶nem ve/veya Ã¶zellik kÄ±sÄ±tlarÄ± ile sunulabilir.

7.2. Borsa komisyonlarÄ±, fonlama, spread, slipaj ve benzeri piyasa/bor-sa kaynaklÄ± maliyetler paket Ã¼cretine dahil deÄŸildir.

7.3. Ã–demeler ve paket koÅŸullarÄ±, Admin Panel'de belirtilen paket tanÄ±mlarÄ±na gÃ¶re uygulanÄ±r.

8. DESTEK VE Ä°LETÄ°ÅÄ°M

8.1. Destek hizmeti "en iyi gayret" esasÄ±na gÃ¶re saÄŸlanÄ±r. Hizmet SaÄŸlayÄ±cÄ±, her talebe anÄ±nda yanÄ±t verileceÄŸini taahhÃ¼t etmez.

8.2. Bildirim ve duyurular; uygulama iÃ§i bildirimler ve/veya Telegram mesajlarÄ± ile yapÄ±labilir.

9. GÃœNCELLEMELER VE DEÄÄ°ÅÄ°KLÄ°KLER

9.1. Hizmet SaÄŸlayÄ±cÄ±; gÃ¼venlik, performans ve kararlÄ±lÄ±k amacÄ±yla gÃ¼ncelleme yapabilir.

9.2. GÃ¼ncellemeler; arayÃ¼z, akÄ±ÅŸ ve Ã¶zelliklerde deÄŸiÅŸiklikler/iyileÅŸtirmeler iÃ§erebilir.

9.3. Kritik deÄŸiÅŸiklikler mÃ¼mkÃ¼n olduÄŸunda Ã¶nceden duyurulabilir; ancak acil gÃ¼venlik gÃ¼ncellemeleri derhal uygulanabilir.

10. FESÄ°H

10.1. Hizmet SaÄŸlayÄ±cÄ±; kÃ¶tÃ¼ye kullanÄ±m, gÃ¼venlik riski, yasal zorunluluk veya SÃ¶zleÅŸme ihlali hÃ¢llerinde hizmeti tek taraflÄ± olarak durdurma veya SÃ¶zleÅŸme'yi feshetme hakkÄ±nÄ± saklÄ± tutar.

10.2. KullanÄ±cÄ±, hesabÄ±nÄ± kapatma talebinde bulunabilir.

10.3. Fesih halinde; devam eden iÅŸlemler, aÃ§Ä±k emirler ve borsa kaynaklÄ± sonuÃ§lar KullanÄ±cÄ± sorumluluÄŸundadÄ±r.

11. FÄ°KRÄ° MÃœLKÄ°YET

11.1. Platform yazÄ±lÄ±mÄ±nÄ±n, arayÃ¼zÃ¼n, kodlarÄ±n ve tÃ¼m bileÅŸenlerin fikrÃ® ve sÄ±nai mÃ¼lkiyet haklarÄ± Hizmet SaÄŸlayÄ±cÄ±'ya aittir.

11.2. KullanÄ±cÄ±; Platform'u kopyalayamaz, Ã§oÄŸaltamaz, kaynak kodunu elde etmeye Ã§alÄ±ÅŸamaz, tersine mÃ¼hendislik yapamaz.

12. YETKÄ°LÄ° MAHKEME VE YÃœRÃœRLÃœK

12.1. Ä°ÅŸbu SÃ¶zleÅŸme'den doÄŸabilecek uyuÅŸmazlÄ±klarda TÃ¼rkiye Cumhuriyeti Mahkemeleri ve Ä°cra Daireleri yetkilidir.

12.2. Bu SÃ¶zleÅŸme, KullanÄ±cÄ±'nÄ±n dijital ortamda onay vermesiyle yÃ¼rÃ¼rlÃ¼ÄŸe girer.

13. KULLANICI BEYANI VE DÄ°JÄ°TAL ONAY

KullanÄ±cÄ±; iÅŸbu SÃ¶zleÅŸme'nin tamamÄ±nÄ± okuduÄŸunu, anladÄ±ÄŸÄ±nÄ±, riskleri kabul ettiÄŸini ve dijital ortamda onayladÄ±ÄŸÄ±nÄ± beyan eder.

Ä°mza (Dijital Onay): Bu belge dijital ortamda onaylanmÄ±ÅŸtÄ±r."""
    
    # As FPDF is not available, we return it as a text file download for now
    from flask import Response
    return Response(
        contract_text,
        mimetype="text/plain",
        headers={"Content-disposition": f"attachment; filename=sozlesme_user_{user_id}.txt"}
    )




# ============================================
# ADMIN PANEL TEMPLATE
# ============================================





# ============================================
# ADMIN PANEL TEMPLATES - Based on Designs
# ============================================

ADMIN_SIDEBAR_HTML = """
<aside class="fixed left-0 top-0 h-full w-64 bg-[#0a0a0a] border-r border-white/5 z-50 flex flex-col">
    <div class="p-4 border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center font-bold text-white text-lg">A</div>
            <div>
                <span class="font-bold text-white">Atalay Ulusoy</span>
                <p class="text-xs text-gray-500">Admin</p>
            </div>
        </div>
    </div>
    <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
        <!-- Admin Panel -->
        <a href="/admin" class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-orange-600/20 text-orange-400 transition text-sm font-medium">
            <span>ğŸ”§</span> Admin Panel
        </a>
        
        <!-- Dashboard -->
        <a href="/dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ“Š</span> Dashboard
        </a>
        
        <!-- CanlÄ± Sohbet -->
        <a href="/dashboard#chat" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ’¬</span> CanlÄ± Sohbet
        </a>
        
        <!-- AI Ã–nerileri -->
        <a href="/ai-suggestions" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ¤–</span> AI Ã–nerileri
        </a>
        
        <!-- Arbitraj Takibi -->
        <a href="/arbitrage" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
        </a>
        
        <!-- Kar/Zarar Raporu -->
        <a href="/reports" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ“ˆ</span> Kar/Zarar Raporu
        </a>
        
        <!-- EÄŸitim Merkezi -->
        <a href="/education" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ“š</span> EÄŸitim Merkezi
        </a>
        
        <!-- Market Analysis -->
        <a href="/market-analysis" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ“‰</span> Market Analysis
        </a>
        
        <!-- Trade History -->
        <a href="/trade-history" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ“‹</span> Trade History
        </a>
        
        <!-- Portfolio Analytics -->
        <a href="/portfolio-analytics" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ’¼</span> Portfolio Analytics
        </a>
        
        <!-- Ã–deme YÃ¶netimi -->
        <a href="/admin#payment-view" onclick="showTab('payment-view')" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ’³</span> Ã–deme YÃ¶netimi
        </a>
        
        <!-- BaÅŸlangÄ±Ã§ KÄ±lavuzu -->
        <a href="/getting-started" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ“–</span> BaÅŸlangÄ±Ã§ KÄ±lavuzu
        </a>
        
        <!-- API DoÄŸrulama -->
        <a href="/admin#api-validation" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ”</span> API DoÄŸrulama
        </a>
        
        <!-- Sistem SaÄŸlÄ±ÄŸÄ± -->
        <a href="/admin#system-view" onclick="showTab('system-view')" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ–¥ï¸</span> Sistem SaÄŸlÄ±ÄŸÄ±
        </a>
        
        <!-- Exchange API -->
        <a href="/exchange-api" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ”—</span> Exchange API
        </a>
        
        <!-- Bildirimler -->
        <a href="/notifications" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ””</span> Bildirimler
        </a>
    </nav>
    
    <!-- Exchange Status Footer -->
    <div class="p-4 border-t border-white/5 bg-black/30">
        <div class="flex items-center justify-between mb-3">
            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Exchange Status</span>
            <span class="text-[10px] text-gray-500">2/3</span>
        </div>
        <div class="space-y-2">
            <div class="flex items-center justify-between">
                <span class="text-xs text-gray-400">Binance</span>
                <span class="text-[10px] text-green-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-400"></span> connected</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs text-gray-400">Coinbase</span>
                <span class="text-[10px] text-green-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-400"></span> connected</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs text-gray-400">Kraken</span>
                <span class="text-[10px] text-red-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> disconnected</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs text-gray-400">Bitstamp</span>
                <span class="text-[10px] text-red-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> disconnected</span>
            </div>
        </div>
    </div>
</aside>
"""


ADMIN_DASHBOARD_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Atalay Ulusoy Auto Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f0f0f] text-white">
    """ + ADMIN_SIDEBAR_HTML.replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'dashboard' else 'text-gray-400 hover:bg-white/5' }}", "bg-orange-600/20 text-orange-400").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'users' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'contracts' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'webhooks' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'ai' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5") + """
    
    <main class="ml-64 p-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold flex items-center gap-3">
                    <span class="text-orange-500">ğŸ“Š</span> Admin Dashboard
                </h1>
                <p class="text-gray-400 text-sm mt-1">Sistem durumu ve genel bakÄ±ÅŸ</p>
            </div>
            <button class="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-xl font-medium transition flex items-center gap-2">
                <span>ğŸ”„</span> Yenile
            </button>
        </div>
        
        <!-- Sistem Metrikleri -->
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 mb-6">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="text-orange-400">ğŸ“ˆ</span> Sistem Metrikleri</h2>
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-black/30 rounded-xl p-4">
                    <p class="text-gray-400 text-xs mb-1">Aktif KullanÄ±cÄ±</p>
                    <p class="text-2xl font-bold text-white">{{ stats.active_users }}</p>
                    <p class="text-xs text-green-400">â†‘ 12 bu hafta</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4">
                    <p class="text-gray-400 text-xs mb-1">Bot SayÄ±sÄ±</p>
                    <p class="text-2xl font-bold text-green-400">{{ stats.active_bots }}</p>
                    <p class="text-xs text-gray-500">Ã‡alÄ±ÅŸan</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4">
                    <p class="text-gray-400 text-xs mb-1">Ä°ÅŸlem Hacmi</p>
                    <p class="text-2xl font-bold text-blue-400">{{ stats.volume }}</p>
                    <p class="text-xs text-gray-500">Bu ay</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4">
                    <p class="text-gray-400 text-xs mb-1">Toplam Gelir</p>
                    <p class="text-2xl font-bold text-yellow-400">${{ stats.revenue }}</p>
                    <p class="text-xs text-green-400">â†‘ %15</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-6">
                <!-- Sistem SaÄŸlÄ±ÄŸÄ± -->
                <div>
                    <h3 class="text-sm font-medium text-gray-400 mb-3">Sistem SaÄŸlÄ±ÄŸÄ±</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">Sunucu</span>
                            <span class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> 99.9%</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">VeritabanÄ±</span>
                            <span class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> 100%</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">API YanÄ±t</span>
                            <span class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> 45ms</span>
                        </div>
                    </div>
                </div>
                
                <!-- Servis Durumu -->
                <div>
                    <h3 class="text-sm font-medium text-gray-400 mb-3">Servis Durumu</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">âœ“ Binance</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">Aktif</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">âœ“ API Gateway</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">Aktif</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">âœ“ Trading Engine</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">Aktif</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">âœ“ Webhook Service</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">Aktif</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Management Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <!-- KullanÄ±cÄ± YÃ¶netimi -->
            <div onclick="window.location='/admin/users'" class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 hover:border-blue-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-blue-600/10 p-4 rounded-2xl text-blue-500 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-inner">ğŸ‘¤</div>
                    <h3 class="text-xl font-bold text-white">KullanÄ±cÄ± YÃ¶netimi</h3>
                </div>
                <p class="text-sm text-gray-400">KullanÄ±cÄ± yÃ¶net, abonelik sÃ¼resi ve satÄ±ÅŸÄ± kontrol</p>
            </div>
            
            <!-- API DoÄŸrulama -->
            <div onclick="window.location='/admin#api-validation'" class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 hover:border-green-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-green-600/10 p-4 rounded-2xl text-green-500 group-hover:bg-green-600 group-hover:text-white transition-all shadow-inner">ğŸ”</div>
                    <h3 class="text-xl font-bold text-white">API DoÄŸrulama</h3>
                </div>
                <p class="text-sm text-gray-400">API anahtarlarÄ± gÃ¼venliÄŸini kontrol et</p>
            </div>
            
            <!-- Ä°ÅŸlem Ä°zleme -->
            <div onclick="window.location='/admin#trading-view'" class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 hover:border-purple-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-purple-600/10 p-4 rounded-2xl text-purple-500 group-hover:bg-purple-600 group-hover:text-white transition-all shadow-inner">ğŸ“ˆ</div>
                    <h3 class="text-xl font-bold text-white">Ä°ÅŸlem Ä°zleme</h3>
                </div>
                <p class="text-sm text-gray-400">CanlÄ± iÅŸlemler ve performans izle</p>
            </div>
            
            <!-- Ã–deme Ä°ÅŸlemleri -->
            <div onclick="window.location='/admin#payment-view'" class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 hover:border-red-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-red-600/10 p-4 rounded-2xl text-red-500 group-hover:bg-red-600 group-hover:text-white transition-all shadow-inner">ğŸ’³</div>
                    <h3 class="text-xl font-bold text-white">Ã–deme Ä°ÅŸlemleri</h3>
                </div>
                <p class="text-sm text-gray-400">Ã–deme ve abonelik iÅŸlemlerini yÃ¶net</p>
            </div>
            
            <!-- Webhook YapÄ±landÄ±rma -->
            <div onclick="window.location='/admin/webhooks'" class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 hover:border-blue-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-cyan-600/10 p-4 rounded-2xl text-cyan-500 group-hover:bg-cyan-600 group-hover:text-white transition-all shadow-inner">ğŸ”—</div>
                    <h3 class="text-xl font-bold text-white">Webhook YapÄ±landÄ±rma</h3>
                </div>
                <p class="text-sm text-gray-400">TradingView webhook ayarlarÄ±nÄ± yÃ¶net</p>
            </div>
            
            <!-- Sistem Metrikleri -->
            <div onclick="window.location='/admin#system-view'" class="bg-[#1a1a1a] rounded-2xl p-6 border border-white/5 hover:border-orange-500/40 hover:bg-[#222] transition-all cursor-pointer group shadow-lg">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-orange-600/10 p-4 rounded-2xl text-orange-500 group-hover:bg-orange-600 group-hover:text-white transition-all shadow-inner">ğŸ“Š</div>
                    <h3 class="text-xl font-bold text-white">Sistem Metrikleri</h3>
                </div>
                <p class="text-sm text-gray-400">Sistem performansÄ± ve saÄŸlÄ±k durumu</p>
            </div>
        </div>
        
        <!-- Trading Ä°zleme -->
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 mb-6">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="text-red-400">ğŸ“ˆ</span> Trading Ä°zleme</h2>
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div class="bg-black/30 rounded-xl p-4 text-center">
                    <span class="text-2xl">ğŸ’°</span>
                    <p class="text-xl font-bold text-green-400 mt-2">$45.8K</p>
                    <p class="text-xs text-gray-400">GÃ¼nlÃ¼k Hacim</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4 text-center">
                    <span class="text-2xl">ğŸ“Š</span>
                    <p class="text-xl font-bold text-yellow-400 mt-2">$8.5K</p>
                    <p class="text-xs text-gray-400">AÃ§Ä±k Pozisyon</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4 text-center">
                    <span class="text-2xl">ğŸ“ˆ</span>
                    <p class="text-xl font-bold text-green-400 mt-2">0.00%</p>
                    <p class="text-xs text-gray-400">GÃ¼nlÃ¼k Kar</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4 text-center">
                    <p class="text-xl font-bold text-blue-400 mt-2">156</p>
                    <p class="text-xs text-gray-400">BugÃ¼nkÃ¼ Ä°ÅŸlem</p>
                </div>
            </div>
            
            <!-- Son Ä°ÅŸlemler Tablosu -->
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-gray-500 border-b border-white/5">
                        <th class="pb-2">KullanÄ±cÄ±</th>
                        <th class="pb-2">Ã‡ift</th>
                        <th class="pb-2">Miktar</th>
                        <th class="pb-2">GiriÅŸ FiyatÄ±</th>
                        <th class="pb-2">Åuanki</th>
                        <th class="pb-2">Kar</th>
                        <th class="pb-2">SÃ¼re</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-white/5">
                        <td class="py-3">Trader_One</td>
                        <td>BTC/USDT</td>
                        <td>$25.00</td>
                        <td>$103,450</td>
                        <td>$103,892</td>
                        <td class="text-green-400">+0.42%</td>
                        <td class="text-gray-400">2 saat Ã¶nce</td>
                    </tr>
                    <tr class="border-b border-white/5">
                        <td class="py-3">Trader_Two</td>
                        <td>ETH/USDT</td>
                        <td>$15.00</td>
                        <td>$3,245</td>
                        <td>$3,312</td>
                        <td class="text-green-400">+2.06%</td>
                        <td class="text-gray-400">4 saat Ã¶nce</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
</body>
</html>
"""

ADMIN_USERS_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KullanÄ±cÄ± YÃ¶netimi | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f0f0f] text-white">
    <aside class="fixed left-0 top-0 h-full w-64 bg-[#0a0a0a] border-r border-white/5 z-50 flex flex-col">
        <div class="p-4 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-orange-600 flex items-center justify-center font-bold text-white">A</div>
                <span class="font-bold text-white">Admin Panel</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="/api/app/admin" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“Š Dashboard</a>
            <a href="/api/app/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-orange-600/20 text-orange-400">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</a>
            <a href="/api/app/admin/packages" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“¦ Paket YÃ¶netimi</a>
            <a href="/api/app/admin/telegram" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“± Telegram AyarlarÄ±</a>
            <a href="/api/app/admin/webhooks" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ”— Webhook YapÄ±landÄ±rmasÄ±</a>
            <a href="/api/app/admin/education" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ EÄŸitim Merkezi</a>
            <a href="/api/app/admin/analytics" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ˆ Analitik</a>
            <a href="/api/app/admin/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">âš™ï¸ Ayarlar</a>
        </nav>
        <div class="p-4 border-t border-white/5">
            <a href="/api/app/dashboard" class="text-sm text-gray-400 hover:text-white">ğŸ  Ana Sayfaya DÃ¶n</a>
        </div>
    </aside>
    
    <main class="ml-64 p-8">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold">KullanÄ±cÄ± YÃ¶netimi</h1>
            <div class="flex gap-2">
                <input type="text" placeholder="KullanÄ±cÄ± ara..." class="bg-[#1a1a1a] border border-white/10 rounded-xl px-4 py-2 text-sm w-64">
                <button class="px-4 py-2 bg-blue-600 rounded-xl text-sm">ğŸ”</button>
            </div>
        </div>
        
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 overflow-hidden">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-gray-400 text-sm border-b border-white/5">
                        <th class="px-6 py-4">KullanÄ±cÄ±</th>
                        <th class="px-6 py-4">E-posta</th>
                        <th class="px-6 py-4">Rol</th>
                        <th class="px-6 py-4">Ãœcret Modeli</th>
                        <th class="px-6 py-4">Bakiye</th>
                        <th class="px-6 py-4">Durum</th>
                        <th class="px-6 py-4">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-sm font-bold">{{ user.username[0].upper() }}</div>
                                <span class="font-medium">{{ user.username }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-400">{{ user.email }}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded-lg text-xs {{ 'bg-red-500/20 text-red-400' if user.role == 'Admin' else 'bg-blue-500/20 text-blue-400' }}">{{ user.role }}</span></td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded-lg text-xs bg-green-500/20 text-green-400">{{ user.package }}</span></td>
                        <td class="px-6 py-4 text-green-400">{{ user.balance }} TL</td>
                        <td class="px-6 py-4">
                            <span class="flex items-center gap-1 text-green-400 text-sm"><span class="w-2 h-2 rounded-full bg-green-500"></span> Aktif</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="showUserDetails({{ user.rowid }})" class="p-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">âœï¸</button>
                                <button onclick="confirmDeleteUser({{ user.rowid }}, '{{ user.username }}')" class="p-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- User Edit Modal -->
    <div id="user-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100]">
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/10 w-full max-w-lg p-6 relative">
            <button onclick="closeModal('user-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h3 class="text-xl font-bold text-white mb-6">KullanÄ±cÄ± DÃ¼zenle</h3>
            <input type="hidden" id="editUserId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">KullanÄ±cÄ± AdÄ±</label>
                    <input type="text" id="editUsername" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white" readonly>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">E-posta</label>
                    <input type="email" id="editEmail" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Telegram Chat ID</label>
                    <input type="text" id="editTelegramId" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Paket</label>
                        <select id="editPackage" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                            <option value="trial">Deneme</option>
                            <option value="basic">Basic</option>
                            <option value="pro">Pro</option>
                            <option value="elit">Elit</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">SÃ¼re (Ay)</label>
                        <input type="number" id="editPackageMonths" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white" min="1" max="12">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Yeni Åifre (opsiyonel)</label>
                    <input type="password" id="editPassword" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white" placeholder="BoÅŸ bÄ±rakÄ±lÄ±rsa deÄŸiÅŸmez">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Webhook URL</label>
                    <input type="text" id="editWebhook" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-green-400" readonly>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveUserEdit()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold">ğŸ’¾ Kaydet</button>
                <button onclick="closeModal('user-modal')" class="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">Ä°ptal</button>
            </div>
        </div>
    </div>

    <script>
    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden'); 
        document.getElementById(id).classList.add('flex'); 
    }
    function closeModal(id) { 
        document.getElementById(id).classList.add('hidden'); 
        document.getElementById(id).classList.remove('flex'); 
    }

    async function showUserDetails(userId) {
        try {
            const res = await fetch(`/api/admin/users/${userId}`);
            const data = await res.json();
            if (data.ok) {
                const user = data.user;
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editTelegramId').value = user.telegram_id || '';
                document.getElementById('editPassword').value = '';
                document.getElementById('editPackage').value = user.package || 'trial';
                document.getElementById('editPackageMonths').value = user.package_months || 1;
                document.getElementById('editWebhook').value = user.webhook_url || `${window.location.origin}/webhook/tv/${userId}`;
                openModal('user-modal');
            } else {
                alert('KullanÄ±cÄ± bilgileri alÄ±namadÄ±: ' + (data.error || 'Bilinmeyen hata'));
            }
        } catch (e) {
            alert('Hata: ' + e.message);
        }
    }

    async function saveUserEdit() {
        const userId = document.getElementById('editUserId').value;
        const data = {
            email: document.getElementById('editEmail').value,
            telegram_id: document.getElementById('editTelegramId').value,
            password: document.getElementById('editPassword').value,
            package: document.getElementById('editPackage').value,
            package_months: parseInt(document.getElementById('editPackageMonths').value) || 1
        };
        
        try {
            const res = await fetch(`/api/admin/users/${userId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.ok) {
                alert('âœ… KullanÄ±cÄ± gÃ¼ncellendi!');
                closeModal('user-modal');
                location.reload();
            } else {
                alert('âŒ Hata: ' + (result.error || 'Bilinmeyen hata'));
            }
        } catch (e) {
            alert('âŒ Hata: ' + e.message);
        }
    }

    function confirmDeleteUser(userId, username) {
        if (confirm(`"${username}" kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinize emin misiniz?`)) {
            fetch(`/api/admin/users/${userId}/delete`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        alert('âœ… KullanÄ±cÄ± silindi!');
                        location.reload();
                    } else {
                        alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
                    }
                })
                .catch(e => alert('âŒ Hata: ' + e.message));
        }
    }
    </script>
</body>
</html>
"""

ADMIN_CONTRACTS_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¶zleÅŸme YÃ¶netimi | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f0f0f] text-white">
    <aside class="fixed left-0 top-0 h-full w-64 bg-[#0a0a0a] border-r border-white/5 z-50 flex flex-col">
        <div class="p-4 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-orange-600 flex items-center justify-center font-bold text-white">A</div>
                <span class="font-bold text-white">Admin Panel</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="/api/app/admin" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“Š Dashboard</a>
            <a href="/api/app/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</a>
            <a href="/api/app/admin/packages" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“¦ Paket YÃ¶netimi</a>
            <a href="/api/app/admin/telegram" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“± Telegram AyarlarÄ±</a>
            <a href="/api/app/admin/webhooks" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ”— Webhook YapÄ±landÄ±rmasÄ±</a>
            <a href="/api/app/admin/education" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ EÄŸitim Merkezi</a>
            <a href="/api/app/admin/analytics" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ˆ Analitik</a>
            <a href="/api/app/admin/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">âš™ï¸ Ayarlar</a>
        </nav>
        <div class="p-4 border-t border-white/5">
            <a href="/api/app/dashboard" class="text-sm text-gray-400 hover:text-white">ğŸ  Ana Sayfaya DÃ¶n</a>
        </div>
    </aside>
    
    <main class="ml-64 p-8">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold">SÃ¶zleÅŸme YÃ¶netimi</h1>
            <button class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-xl font-medium flex items-center gap-2">
                <span>â•</span> Yeni SÃ¶zleÅŸme
            </button>
        </div>
        
        <div class="space-y-4">
            {% for contract in contracts %}
            <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="font-bold text-lg">{{ contract.title }}</h3>
                        <div class="flex items-center gap-4 text-sm text-gray-400 mt-1">
                            <span>ğŸ‘¤ {{ contract.user }}</span>
                            <span>âœ‰ï¸ {{ contract.email }}</span>
                            <span>ğŸ“… {{ contract.date }}</span>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-lg text-sm {{ 'bg-green-500/20 text-green-400' if contract.status == 'OnaylandÄ±' else 'bg-yellow-500/20 text-yellow-400' }}">{{ contract.status }}</span>
                </div>
                <p class="text-gray-400 text-sm mb-4">{{ contract.description }}</p>
                <div class="flex gap-2">
                    <button class="px-4 py-2 bg-blue-600/20 text-blue-400 rounded-xl text-sm hover:bg-blue-600/30">ğŸ“¥ PDF Ä°ndir</button>
                    <button class="px-4 py-2 bg-green-600/20 text-green-400 rounded-xl text-sm hover:bg-green-600/30">âœ… Onayla ve GÃ¶nder</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>
</body>
</html>
"""

# OLD TEMPLATE - Disabled to use the fixed version at line 25382
_ADMIN_WEBHOOKS_TEMPLATE_OLD1 = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook YapÄ±landÄ±rmasÄ± | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f0f0f] text-white">
    <aside class="fixed left-0 top-0 h-full w-64 bg-[#0a0a0a] border-r border-white/5 z-50 flex flex-col">
        <div class="p-4 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-orange-600 flex items-center justify-center font-bold text-white">A</div>
                <span class="font-bold text-white">Admin Panel</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="/api/app/admin" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“Š Dashboard</a>
            <a href="/api/app/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</a>
            <a href="/api/app/admin/packages" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“¦ Paket YÃ¶netimi</a>
            <a href="/api/app/admin/telegram" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“± Telegram AyarlarÄ±</a>
            <a href="/api/app/admin/webhooks" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-orange-600/20 text-orange-400">ğŸ”— Webhook YapÄ±landÄ±rmasÄ±</a>
            <a href="/api/app/admin/education" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ EÄŸitim Merkezi</a>
            <a href="/api/app/admin/analytics" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ˆ Analitik</a>
            <a href="/api/app/admin/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">âš™ï¸ Ayarlar</a>
        </nav>
        <div class="p-4 border-t border-white/5">
            <a href="/api/app/dashboard" class="text-sm text-gray-400 hover:text-white">ğŸ  Ana Sayfaya DÃ¶n</a>
        </div>
    </aside>
    
    <main class="ml-64 p-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <span class="text-3xl">ğŸ”—</span>
                <div>
                    <h1 class="text-2xl font-bold">Webhook YapÄ±landÄ±rmasÄ±</h1>
                    <p class="text-gray-400 text-sm">Webhook URL'leri ve yapÄ±landÄ±rmasÄ±</p>
                </div>
            </div>
            <button class="px-4 py-2 bg-blue-600 rounded-xl flex items-center gap-2">
                <span>ğŸ”„</span> Yenile
            </button>
        </div>
        
        <!-- Yeni Webhook Ekle -->
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 mb-6">
            <h2 class="font-bold mb-4">Yeni Webhook Ekle</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm text-gray-400 block mb-2">KullanÄ±cÄ± SeÃ§</label>
                    <select class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3">
                        <option>TÃ¼m KullanÄ±cÄ±lar</option>
                        <option>Atalay Ulusoy</option>
                        <option>Trader One</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-400 block mb-2">Webhook URL</label>
                    <input type="text" value="https://yourserver.com/webhook" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3">
                </div>
            </div>
        </div>
        
        <!-- Mevcut Webhooklar -->
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 overflow-hidden">
            <div class="p-4 border-b border-white/5">
                <h2 class="font-bold">Mevcut Webhook'lar</h2>
            </div>
            <table class="w-full">
                <thead>
                    <tr class="text-left text-gray-400 text-sm border-b border-white/5">
                        <th class="px-6 py-3">KullanÄ±cÄ±</th>
                        <th class="px-6 py-3">Webhook URL</th>
                        <th class="px-6 py-3">Durum</th>
                        <th class="px-6 py-3">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wh in webhooks %}
                    <tr class="border-b border-white/5">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold">{{ wh.user[0] }}</div>
                                <div>
                                    <p class="font-medium">{{ wh.user }}</p>
                                    <p class="text-xs text-gray-500">{{ wh.email }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-400 text-sm font-mono">{{ wh.url[:60] }}...</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400">Aktif</span></td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="testWebhook('{{ wh.id }}', '{{ wh.url }}')" class="px-3 py-1 bg-green-500/20 text-green-400 rounded-lg text-sm">Test</button>
                                <button onclick="editWebhook('{{ wh.id }}', '{{ wh.url }}')" class="px-3 py-1 bg-blue-500/20 text-blue-400 rounded-lg text-sm">ğŸ“‹</button>
                                <button onclick="deleteWebhook('{{ wh.id }}', '{{ wh.user }}')" class="px-3 py-1 bg-red-500/20 text-red-400 rounded-lg text-sm">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

<!-- Trading Dashboard UI Script -->
<script>
function copyWebhookUrl(url) {
  try {
    navigator.clipboard.writeText(url).then(() => toast('Webhook URL kopyalandÄ± âœ…')).catch(() => fallbackCopy(url));
  } catch(e) { fallbackCopy(url); }
}
function fallbackCopy(text) {
  const ta=document.createElement('textarea');
  ta.value=text; document.body.appendChild(ta);
  ta.select(); document.execCommand('copy');
  document.body.removeChild(ta);
  toast('Webhook URL kopyalandÄ± âœ…');
}
async function testWebhook(id, url) {
  toast('ğŸ”„ Webhook test ediliyor...');
  try {
    const r = await fetch('/api/admin/webhooks/' + id + '/test', { method: 'POST' });
    const j = await r.json();
    if (j.ok) { toast('âœ… Webhook baÅŸarÄ±yla Ã§alÄ±ÅŸÄ±yor!'); }
    else { toast('âš ï¸ Webhook yanÄ±t vermedi: ' + (j.error || ''), true); }
  } catch(e) { toast('âŒ Test hatasÄ±: ' + e, true); }
}

async function editWebhook(id, currentUrl) {
  const newUrl = prompt('Webhook URL dÃ¼zenle:', currentUrl);
  if (!newUrl || newUrl === currentUrl) return;
  
  try {
    const r = await fetch('/api/admin/webhooks/' + id + '/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: newUrl })
    });
    const j = await r.json();
    if (j.ok) { toast('âœ… Webhook gÃ¼ncellendi!'); setTimeout(() => location.reload(), 500); }
    else { toast('âŒ GÃ¼ncellenemedi: ' + (j.error || ''), true); }
  } catch(e) { toast('âŒ Hata: ' + e, true); }
}

async function deleteWebhook(id, user) {
  if(!confirm('"' + user + '" kullanÄ±cÄ±sÄ±nÄ±n webhook\'unu silmek istediÄŸinize emin misiniz?')) return;
  try{
    const r = await fetch('/api/admin/webhooks/'+id+'/delete',{method:'POST'});
    const j = await r.json();
    if(j.ok){ toast('Webhook silindi âœ…'); setTimeout(()=>location.reload(),500); }
    else { toast('Silinemedi: '+(j.error||'hata'), true); }
  }catch(e){ toast('Silinemedi: '+e, true); }
}
async function rotateWebhook(id) {
  if(!confirm('Yeni webhook URL oluÅŸturulsun mu?')) return;
  try{
    const r = await fetch('/api/admin/webhooks/'+id+'/rotate',{method:'POST'});
    const j = await r.json();
    if(j.ok){ toast('Webhook gÃ¼ncellendi âœ…'); setTimeout(()=>location.reload(),500); }
    else { toast('GÃ¼ncellenemedi: '+(j.error||'hata'), true); }
  }catch(e){ toast('GÃ¼ncellenemedi: '+e, true); }
}
function toast(msg, err){
  let el=document.getElementById('toast');
  if(!el){
    el=document.createElement('div');
    el.id='toast';
    el.className='fixed bottom-6 right-6 px-4 py-3 rounded-xl text-sm shadow-lg z-[9999] border border-white/10';
    document.body.appendChild(el);
  }
  el.textContent=msg;
  el.style.background=err?'rgba(220,38,38,0.25)':'rgba(34,197,94,0.18)';
  el.style.color=err?'#fecaca':'#bbf7d0';
  el.style.display='block';
  clearTimeout(window.__toastT);
  window.__toastT=setTimeout(()=>{el.style.display='none';},2500);
}
</script>


<script>
/* HOTFIX: Webhook buttons */
window.copyWebhookUrl = window.copyWebhookUrl || function(url){
  try{
    if(!url){ return; }
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(String(url));
    } else {
      const t=document.createElement("textarea"); t.value=String(url);
      document.body.appendChild(t); t.select(); document.execCommand("copy"); t.remove();
    }
  }catch(e){}
};

window.deleteWebhook = window.deleteWebhook || async function(id){
  try{
    if(!id){ return; }
    const endpoints = ["/api/admin/webhooks/delete","/api/admin/webhook/delete","/api/webhooks/delete"];
    let ok=false, msg="";
    for(const ep of endpoints){
      try{
        const res = await fetch(ep, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({id:id})});
        const j = await res.json().catch(()=>null);
        if(j && j.ok){ ok=true; break; }
        msg = (j && (j.error||j.message)) ? (j.error||j.message) : (res.status+"");
      }catch(e2){}
    }
    if(ok) location.reload();
    else alert(msg || "Silinemedi");
  }catch(e){
    alert("Silinemedi");
  }
};
</script>

</body>
</html>
"""



# ============================================



@app.route('/admin')
@app.route('/admin/dashboard')
def page_admin_dashboard():
    if not session.get("logged_in"):
        return redirect("/api/app/login")
    
    # is_admin kontrolÃ¼
    is_admin = session.get("role") == "admin" or session.get("is_admin") == True
    if not is_admin:
        return redirect("/dashboard")
    
    # VeritabanÄ±ndan gerÃ§ek verileri al
    try:
        conn = db()
        
        # Users data
        users = conn.execute("""
            SELECT rowid, username, email, is_admin, package_name, package_months, 
                   demo_balance, trade_enabled, telegram_chat_id, webhook_secret, 
                   expires_at, created_at 
            FROM users ORDER BY created_at DESC
        """).fetchall()
        total_users = len(users)
        
        # Active users (with trade_enabled or recent login)
        active_users = conn.execute("SELECT COUNT(1) FROM users WHERE trade_enabled=1 OR demo_balance > 0").fetchone()[0] or 0
        
        # Total trades from auto_positions
        total_trades = conn.execute("SELECT COUNT(1) FROM auto_positions").fetchone()[0] or 0
        
        # Open trades
        open_trades = conn.execute("SELECT COUNT(1) FROM auto_positions WHERE status='open'").fetchone()[0] or 0
        
        # Total volume
        total_volume = conn.execute("SELECT COALESCE(SUM(amount_usdt), 0) FROM auto_positions").fetchone()[0] or 0
        
        # Today's registrations
        today_start = int(time.time()) - 86400
        today_registrations = conn.execute("SELECT COUNT(1) FROM users WHERE created_at > ?", (today_start,)).fetchone()[0] or 0
        
        # Premium users
        premium_users = conn.execute("SELECT COUNT(1) FROM users WHERE package_name IN ('premium', 'elit')").fetchone()[0] or 0
        
        conn.close()
    except Exception as e:
        print(f"Admin dashboard error: {e}")
        import traceback
        traceback.print_exc()
        users = []
        total_users = 0
        active_users = 0
        total_trades = 0
        open_trades = 0
        total_volume = 0
        today_registrations = 0
        premium_users = 0
    
    stats = {
        "active_users": active_users,
        "active_bots": open_trades,  # Active trades as "bots"
        "volume": f"${total_volume:,.0f}",
        "revenue": f"${premium_users * 100:,.0f}",  # Estimated from premium users
        "total_users": total_users,
        "today_registrations": today_registrations,
        "premium_users": premium_users,
        "total_trades": total_trades
    }
    return render_template_string(ADMIN_DASHBOARD_TEMPLATE, stats=stats, users=users, total_users=total_users, active_users=active_users, total_trades=total_trades, total_volume=f"{total_volume:,.0f}")



def _init_auto_trades_table():
    """Initialize auto_trades table if not exists"""
    try:
        conn = db()
        conn.execute("""
            CREATE TABLE IF NOT EXISTS auto_trades (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                coin TEXT NOT NULL,
                amount_usdt REAL DEFAULT 10.0,
                status TEXT DEFAULT 'active',
                mode TEXT DEFAULT 'demo',
                created_at INTEGER,
                deleted INTEGER DEFAULT 0
            )
        """)
        conn.execute("""
            CREATE TABLE IF NOT EXISTS demo_positions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                coin TEXT NOT NULL,
                side TEXT DEFAULT 'BUY',
                amount_usdt REAL,
                entry_price REAL,
                current_price REAL,
                pnl REAL DEFAULT 0,
                status TEXT DEFAULT 'open',
                created_at INTEGER,
                closed_at INTEGER
            )
        """)
        conn.commit()
        
        # Add missing columns to auto_trades if they don't exist
        try:
            conn.execute("SELECT status FROM auto_trades LIMIT 1")
        except:
            try:
                conn.execute("ALTER TABLE auto_trades ADD COLUMN status TEXT DEFAULT 'active'")
                conn.commit()
            except: pass
        try:
            conn.execute("SELECT mode FROM auto_trades LIMIT 1")
        except:
            try:
                conn.execute("ALTER TABLE auto_trades ADD COLUMN mode TEXT DEFAULT 'demo'")
                conn.commit()
            except: pass
        try:
            conn.execute("SELECT deleted FROM auto_trades LIMIT 1")
        except:
            try:
                conn.execute("ALTER TABLE auto_trades ADD COLUMN deleted INTEGER DEFAULT 0")
                conn.commit()
            except: pass
        
        # Add missing columns to demo_positions if they don't exist
        try:
            conn.execute("SELECT status FROM demo_positions LIMIT 1")
        except:
            try:
                conn.execute("ALTER TABLE demo_positions ADD COLUMN status TEXT DEFAULT 'open'")
                conn.commit()
            except: pass
        try:
            conn.execute("SELECT pnl FROM demo_positions LIMIT 1")
        except:
            try:
                conn.execute("ALTER TABLE demo_positions ADD COLUMN pnl REAL DEFAULT 0")
                conn.commit()
            except: pass
        try:
            conn.execute("SELECT closed_at FROM demo_positions LIMIT 1")
        except:
            try:
                conn.execute("ALTER TABLE demo_positions ADD COLUMN closed_at INTEGER")
                conn.commit()
            except: pass
        
        conn.close()
    except Exception as e:
        print(f"Auto trades table init error: {e}")



# ============================================
# AUTO TRADING API ENDPOINTS
# ============================================

@app.get("/api/auto/list")
def api_auto_list():
    """Returns pending auto-trades from auto_positions table"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = int(session.get("user_id") or 0)
    username = session.get("username") or ""
    
    # Get mode from query parameter first, then session
    mode = request.args.get("mode", "").lower().strip()
    if not mode:
        mode = str(session.get("ui_mode") or session.get("mode") or session.get("account_mode") or "demo").lower()
    if mode in ("live", "real"):
        mode = "real"
    if mode not in ("demo", "real"):
        mode = "demo"
    
    print(f"[AUTO LIST] user_id={user_id}, username={username}, mode={mode}")

    try:
        conn = db()
        
        # Query auto_positions table - show ALL trades (no status filter)
        # User wants to always see their trades regardless of status
        if mode == "real":
            rows = conn.execute("""
                SELECT id, coin, amount_usdt, status, created_at, target_pct
                FROM auto_positions
                WHERE user_id=? AND (mode='real' OR mode='live')
                ORDER BY id DESC
            """, (user_id,)).fetchall()
        else:
            rows = conn.execute("""
                SELECT id, coin, amount_usdt, status, created_at, target_pct
                FROM auto_positions
                WHERE user_id=? AND mode='demo'
                ORDER BY id DESC
            """, (user_id,)).fetchall()
        
        # DEBUG: Log what we found
        print(f"[AUTO LIST DEBUG] Found {len(rows)} trades for user_id={user_id}, mode={mode}", flush=True)
        for r in rows:
            print(f"  -> id={r[0]}, coin={r[1]}, status={r[3]}", flush=True)

        
        conn.close()

        trades = []
        for r in rows:
            try:
                coin = r[1] or ""
                trades.append({
                    "id": r[0],
                    "coin": coin,
                    "symbol": coin,
                    "amount_usdt": float(r[2] or 0),
                    "amount": float(r[2] or 0),
                    "exit_target": r[5],  # target_pct
                    "target_pct": r[5],
                    "status": r[3] or "waiting",
                    "mode": mode,
                    "created_at": r[4],
                })
            except Exception as ex:
                print(f"[AUTO LIST] Row parse error: {ex}")
                continue

        print(f"[AUTO LIST] Returning {len(trades)} trades")
        # Return both keys to satisfy any frontend variant
        return jsonify({"ok": True, "trades": trades, "auto_trades": trades, "items": trades, "mode": mode})
    except Exception as e:
        print(f"[AUTO LIST] Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({"ok": True, "trades": [], "auto_trades": [], "items": []})




@app.post("/api/auto/add")
def api_auto_add():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)

    j = request.get_json(silent=True) or {}
    coin = str(j.get("coin", "")).strip().upper()
    amount = j.get("amount_usdt", 10)
    mode = str(j.get("mode") or session.get("ui_mode") or session.get("mode") or session.get("account_mode") or "demo").lower()
    if mode in ("live","real"):
        mode = "real"
    if mode not in ("demo","real"):
        mode = "demo"

    exit_target = j.get("exit_target", None)

    if not coin:
        return jsonify({"ok": False, "error": "Coin gerekli"}), 400

    try:
        amount = float(amount)
        if amount <= 0:
            return jsonify({"ok": False, "error": "Miktar geÃ§ersiz"}), 400
    except Exception:
        return jsonify({"ok": False, "error": "Miktar geÃ§ersiz"}), 400

    # Package limits
    allowed, msg = check_package_limits(user_id, "add_coin")
    if not allowed:
        return jsonify({"ok": False, "error": msg}), 400

    # Normalize exit_target to float if provided (percent like 0.55 or 0.5)
    try:
        if exit_target is not None and exit_target != "":
            exit_target = float(exit_target)
        else:
            exit_target = None
    except Exception:
        exit_target = None

    try:
        conn = db()

        # Ensure auto_positions table exists with correct columns
        conn.execute("""
            CREATE TABLE IF NOT EXISTS auto_positions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                coin TEXT,
                amount_usdt REAL DEFAULT 10,
                target_pct REAL,
                status TEXT DEFAULT 'waiting',
                mode TEXT DEFAULT 'demo',
                created_at TEXT,
                entry_price REAL,
                current_price REAL,
                pnl REAL,
                entry_at TEXT,
                exit_at TEXT
            )
        """)
        for ddl in [
            "ALTER TABLE auto_positions ADD COLUMN target_pct REAL",
            "ALTER TABLE auto_positions ADD COLUMN entry_price REAL",
            "ALTER TABLE auto_positions ADD COLUMN current_price REAL",
            "ALTER TABLE auto_positions ADD COLUMN pnl REAL",
            "ALTER TABLE auto_positions ADD COLUMN entry_at TEXT",
            "ALTER TABLE auto_positions ADD COLUMN exit_at TEXT",
        ]:
            try:
                conn.execute(ddl)
            except Exception:
                pass

        # Prevent duplicate coin in waiting list
        try:
            dup = conn.execute(
                "SELECT id FROM auto_positions WHERE user_id=? AND coin=? AND status='waiting' AND mode=?",
                (user_id, coin, mode),
            ).fetchone()
            if dup:
                conn.close()
                return jsonify({"ok": False, "error": "Coin zaten ekli"}), 400
        except Exception:
            pass

        from datetime import datetime as dt_cls
        conn.execute(
            "INSERT INTO auto_positions (user_id, coin, amount_usdt, target_pct, status, mode, created_at) VALUES (?,?,?,?,?,?,?)",
            (user_id, coin, amount, exit_target, "waiting", mode, dt_cls.now(timezone.utc).isoformat())
        )
        conn.commit()

        # NOTE: Balance is NOT deducted at position creation.
        # Balance is deducted only when actual BUY happens in demo_auto_trade_processor.
        new_balance = None
        # Fetch current balance for display only
        mode = "real" # Forced Real
        if False: # Demo Disabled
            try:
                new_balance = get_demo_balance(int(user_id))
            except Exception as _e:
                print(f"[AUTO ADD] demo balance read error: {_e}")

        last_id = conn.execute("SELECT last_insert_rowid()").fetchone()[0]
        conn.close()

        return jsonify({
            "ok": True,
            "message": f"{coin} eklendi",
            "trade": {"id": last_id, "coin": coin, "amount_usdt": amount, "mode": mode, "status": "waiting", "exit_target": exit_target},
            "balance": new_balance,
        })
    except Exception as e:
        print(f"[AUTO ADD] Error: {e}")
        return jsonify({"ok": False, "error": str(e)}), 500





@app.post("/api/auto/toggle")
def api_auto_toggle():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    trade_id = int(j.get("id", 0))
    
    max_retries = 5
    for attempt in range(max_retries):
        try:
            conn = db()
            row = conn.execute("SELECT status FROM auto_trades WHERE id=? AND user_id=?", (trade_id, user_id)).fetchone()
            if not row:
                conn.close()
                return jsonify({"ok": False, "error": "Trade not found"}), 404
            
            current = row[0] if isinstance(row, tuple) else dict(row).get("status", "active")
            new_status = "paused" if current == "active" else "active"
            conn.execute("UPDATE auto_trades SET status=? WHERE id=?", (new_status, trade_id))
            conn.commit()
            conn.close()
            return jsonify({"ok": True, "status": new_status})
        except sqlite3.OperationalError as e:
            if "database is locked" in str(e) and attempt < max_retries - 1:
                import time
                time.sleep(0.1 * (2 ** attempt))
                continue
            print(f"[AUTO TOGGLE] Error: {e}")
            return jsonify({"ok": False, "error": str(e)}), 500
        except Exception as e:
            print(f"[AUTO TOGGLE] Error: {e}")
            return jsonify({"ok": False, "error": str(e)}), 500


# === AUTO TRADE CONTROL: PAUSE / RESUME / DELETE ===
@app.post("/api/auto/pause")
def api_auto_pause():
    """Pause an auto trade - stops it from executing"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    trade_id = int(j.get("id", 0))
    
    try:
        conn = db()
        # Check if trade exists and belongs to user
        row = conn.execute("SELECT status FROM auto_positions WHERE id=? AND user_id=?", (trade_id, user_id)).fetchone()
        if not row:
            conn.close()
            return jsonify({"ok": False, "error": "Trade not found"}), 404
        
        # Set status to paused
        conn.execute("UPDATE auto_positions SET status='paused' WHERE id=?", (trade_id,))
        conn.commit()
        conn.close()
        
        print(f"[AUTO_CTRL] â¸ï¸ Trade {trade_id} PAUSED by user {user_id}")
        return jsonify({"ok": True, "status": "paused", "message": "Ä°ÅŸlem durduruldu"})
    except Exception as e:
        print(f"[AUTO PAUSE] Error: {e}")
        return jsonify({"ok": False, "error": str(e)}), 500


@app.post("/api/auto/resume")
def api_auto_resume():
    """Resume a paused auto trade"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    trade_id = int(j.get("id", 0))
    
    try:
        conn = db()
        # Check if trade exists and belongs to user
        row = conn.execute("SELECT status FROM auto_positions WHERE id=? AND user_id=?", (trade_id, user_id)).fetchone()
        if not row:
            conn.close()
            return jsonify({"ok": False, "error": "Trade not found"}), 404
        
        # Set status back to waiting
        conn.execute("UPDATE auto_positions SET status='waiting' WHERE id=?", (trade_id,))
        conn.commit()
        conn.close()
        
        print(f"[AUTO_CTRL] â–¶ï¸ Trade {trade_id} RESUMED by user {user_id}")
        return jsonify({"ok": True, "status": "waiting", "message": "Ä°ÅŸlem baÅŸlatÄ±ldÄ±"})
    except Exception as e:
        print(f"[AUTO RESUME] Error: {e}")
        return jsonify({"ok": False, "error": str(e)}), 500


@app.post("/api/auto/delete")
def api_auto_delete():
    """Delete an auto trade completely"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    trade_id = int(j.get("id", 0))
    
    try:
        conn = db()
        # Check if trade exists and belongs to user
        row = conn.execute("SELECT amount_usdt, status, mode FROM auto_positions WHERE id=? AND user_id=?", (trade_id, user_id)).fetchone()
        if not row:
            conn.close()
            return jsonify({"ok": False, "error": "Trade not found"}), 404
        
        amount_usdt, status, mode = row
        
        # If trade is waiting or paused, refund the amount back to demo balance
        if status in ('waiting', 'paused') and mode == 'demo':
            try:
                update_demo_balance(int(user_id), amount_usdt)
            except:
                pass
        
        # Delete the trade
        conn.execute("DELETE FROM auto_positions WHERE id=?", (trade_id,))
        conn.commit()
        conn.close()
        
        print(f"[AUTO_CTRL] ğŸ—‘ï¸ Trade {trade_id} DELETED by user {user_id}")
        return jsonify({"ok": True, "message": "Ä°ÅŸlem silindi"})
    except Exception as e:
        print(f"[AUTO DELETE] Error: {e}")
        return jsonify({"ok": False, "error": str(e)}), 500


@app.post("/api/auto/trigger-buy")
def api_auto_trigger_buy():
    """Manually trigger a BUY for a waiting position in DEMO mode"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    position_id = int(j.get("id", 0))
    
    try:
        conn = db()
        
        # Get the waiting position
        row = conn.execute(
            "SELECT id, coin, amount_usdt, mode, status FROM auto_positions WHERE id=? AND user_id=?",
            (position_id, user_id)
        ).fetchone()
        
        if not row:
            conn.close()
            return jsonify({"ok": False, "error": "Pozisyon bulunamadÄ±"}), 404
        
        pos_id, coin, amount, mode, status = row
        
        if status != 'waiting':
            conn.close()
            return jsonify({"ok": False, "error": "Bu pozisyon zaten iÅŸleme alÄ±nmÄ±ÅŸ"}), 400
        
        # Get current price
        try:
            fake_price = _demo_fetch_price(coin) or 100.0
        except:
            fake_price = 100.0
        
        qty = float(amount) / fake_price if fake_price > 0 else 0
        current_time = int(time.time())
        
        # Update to OPEN status with entry price
        conn.execute("""
            UPDATE auto_positions 
            SET status='open', entry_price=?, qty=?, opened_at=?, updated_at=?, current_price=?
            WHERE id=?
        """, (fake_price, qty, current_time, current_time, fake_price, pos_id))
        conn.commit()
        conn.close()
        
        return jsonify({
            "ok": True,
            "message": f"{coin} alÄ±m iÅŸlemi baÅŸlatÄ±ldÄ±",
            "entry_price": fake_price,
            "qty": qty
        })
    except Exception as e:
        print(f"[AUTO TRIGGER BUY] Error: {e}")
        return jsonify({"ok": False, "error": str(e)}), 500

@app.post("/api/auto/edit")
def api_auto_edit():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    trade_id = int(j.get("id", 0))
    amount = float(j.get("amount_usdt", 10))
    
    max_retries = 5
    for attempt in range(max_retries):
        try:
            conn = db()
            conn.execute("UPDATE auto_trades SET amount=? WHERE id=? AND user_id=?", (amount, trade_id, user_id))
            conn.commit()
            conn.close()
            return jsonify({"ok": True, "message": "GÃ¼ncellendi"})
        except sqlite3.OperationalError as e:
            if "database is locked" in str(e) and attempt < max_retries - 1:
                import time
                time.sleep(0.1 * (2 ** attempt))
                continue
            return jsonify({"ok": False, "error": str(e)}), 500
        except Exception as e:
            return jsonify({"ok": False, "error": str(e)}), 500

# Note: /api/auto/delete for auto_positions is defined earlier (line ~23537)

# ============================================
# OPEN POSITIONS API
# ============================================

# (REMOVED) Duplicate /api/real/balance compat route removed.
# @app.get("/api/real/balance")

def api_demo_balance():
    # DEMO balance: V3 (identity-safe)
    # users table PK = username. So always resolve user by session.username/email first.
    import sqlite3
    from flask import session, jsonify

    db_path = globals().get("DB_PATH") or globals().get("DB_FILE") or "/root/backend/data.db"

    uname = None
    try:
        uname = session.get("username") or session.get("user") or session.get("email")
    except Exception:
        uname = None

    email = None
    try:
        email = session.get("email")
    except Exception:
        email = None

    uid = None
    try:
        uid = session.get("user_id") or session.get("uid")
    except Exception:
        uid = None

    bal = None
    source = "default(0)"

    try:
        conn = sqlite3.connect(db_path)
        conn.row_factory = sqlite3.Row
        cur = conn.cursor()

        # column existence
        cols = [r[1] for r in cur.execute("PRAGMA table_info(users)").fetchall()]
        has_demo = ("demo_balance" in cols)
        has_idcol = ("id" in cols)

        row = None

        # 1) Preferred: username match (PK)
        if uname:
            try:
                row = cur.execute("SELECT username, email, demo_balance, id FROM users WHERE username=?", (uname,)).fetchone()
            except Exception:
                row = None

        # 2) Fallback: email match
        if row is None and email:
            try:
                row = cur.execute("SELECT username, email, demo_balance, id FROM users WHERE email=?", (email,)).fetchone()
            except Exception:
                row = None

        # 3) Fallback: numeric uid -> id column (NOT PK, but exists in your schema)
        if row is None and uid is not None and has_idcol:
            try:
                row = cur.execute("SELECT username, email, demo_balance, id FROM users WHERE id=?", (uid,)).fetchone()
            except Exception:
                row = None

        # Decide balance
        if row is not None and has_demo and row["demo_balance"] is not None:
            bal = float(row["demo_balance"])
            source = "users.demo_balance"

            # Keep paper_test_state synced if possible (needs integer user_id)
            try:
                user_int_id = row["id"] if has_idcol else None
                if user_int_id is not None:
                    cur.execute("CREATE TABLE IF NOT EXISTS paper_test_state (user_id INTEGER PRIMARY KEY, usdt REAL DEFAULT 0)")
                    cur.execute(
                        "INSERT INTO paper_test_state(user_id, usdt) VALUES(?, ?) "
                        "ON CONFLICT(user_id) DO UPDATE SET usdt=excluded.usdt",
                        (int(user_int_id), float(bal))
                    )
                    conn.commit()
            except Exception:
                pass

        else:
            # last resort fallback: paper_test_state using numeric uid or users.id we can resolve from uname
            paper_uid = None

            if row is not None and has_idcol and row["id"] is not None:
                paper_uid = int(row["id"])
            elif uid is not None:
                try:
                    paper_uid = int(uid)
                except Exception:
                    paper_uid = None

            if paper_uid is not None:
                try:
                    cur.execute("CREATE TABLE IF NOT EXISTS paper_test_state (user_id INTEGER PRIMARY KEY, usdt REAL DEFAULT 0)")
                    prow = cur.execute("SELECT usdt FROM paper_test_state WHERE user_id=?", (paper_uid,)).fetchone()
                    if prow and prow["usdt"] is not None:
                        bal = float(prow["usdt"])
                        source = "paper_test_state.usdt"
                except Exception:
                    pass

        conn.close()
    except Exception:
        pass

    if bal is None:
        bal = 0.0

    return jsonify({
        "ok": True,
        "mode": "demo",
        "source": source,
        "balance": bal,
        "balance_usdt": bal
    })


@app.get("/api/positions/demo")
def api_positions_demo():
    """Returns OPEN positions for DEMO mode with real-time PnL"""
    try:
        if not session.get("logged_in"):
            return jsonify({"ok": True, "mode": "DEMO", "positions": [], "guest": True})
    except Exception:
        return jsonify({"ok": True, "mode": "DEMO", "positions": [], "guest": True})

    user_id = int(session.get("user_id") or 0)
    mode = str(session.get("ui_mode") or session.get("mode") or "demo").lower()
    
    # If REAL mode, redirect to real positions
    if mode == "real":
        try:
            return api_positions_real()
        except Exception as e:
            return jsonify({'ok': False, 'error': 'REAL_POSITIONS_FAILED', 'detail': str(e)})
    
    try:
        conn = db()
        
        # Get OPEN positions from auto_positions (Auto trades that are now active)
        auto_rows = conn.execute("""
            SELECT id, coin, amount_usdt, entry_price, qty, opened_at, status
            FROM auto_positions
            WHERE user_id=? AND mode='demo' AND status='open'
            ORDER BY opened_at DESC
        """, (user_id,)).fetchall()
        
        # Also get from demo_positions table (manual trades)
        try:
            manual_rows = conn.execute("""
                SELECT id, coin, side, amount_usdt, entry_price, pnl, created_at
                FROM demo_positions
                WHERE user_id=? AND status='open'
                ORDER BY created_at DESC
            """, (user_id,)).fetchall()
        except:
            manual_rows = []
        
        conn.close()
        
        # Get live prices
        prices = get_live_crypto_prices()
        
        positions = []
        total_pnl = 0
        total_value = 0
        
        # Process auto positions
        for r in auto_rows:
            pos_id = r[0]
            coin = r[1] or "BTC/USDT"
            amount_usdt = float(r[2] or 10)
            entry_price = float(r[3] or 1)
            qty = float(r[4] or 0)
            opened_at = r[5]
            
            # Get current price
            coin_base = coin.replace("/USDT", "").replace("USDT", "").upper()
            current_price = prices.get(coin) or prices.get(coin_base) or prices.get(f"{coin_base}/USDT") or entry_price * 1.002
            
            # Calculate PnL
            if entry_price > 0 and current_price > 0:
                pnl_percent = ((current_price - entry_price) / entry_price) * 100
                pnl_usdt = (pnl_percent / 100) * amount_usdt
            else:
                pnl_percent = 0
                pnl_usdt = 0
            
            total_pnl += pnl_usdt
            total_value += amount_usdt
            
            positions.append({
                "id": pos_id,
                "coin": coin,
                "symbol": coin,
                "side": "BUY",
                "amount_usdt": amount_usdt,
                "entry_price": entry_price,
                "current_price": current_price,
                "qty": qty,
                "pnl": round(pnl_usdt, 4),
                "pnl_percent": round(pnl_percent, 2),
                "source": "auto",
                "opened_at": opened_at
            })
        
        # Process manual positions
        for r in manual_rows:
            pos_id = r[0]
            coin = r[1] or "BTC/USDT"
            side = r[2] or "BUY"
            amount_usdt = float(r[3] or 10)
            entry_price = float(r[4] or 1)
            
            coin_base = coin.replace("/USDT", "").replace("USDT", "").upper()
            current_price = prices.get(coin) or prices.get(coin_base) or entry_price * 1.001
            
            if entry_price > 0:
                if side.upper() == "BUY":
                    pnl_percent = ((current_price - entry_price) / entry_price) * 100
                else:
                    pnl_percent = ((entry_price - current_price) / entry_price) * 100
                pnl_usdt = (pnl_percent / 100) * amount_usdt
            else:
                pnl_percent = 0
                pnl_usdt = 0
            
            total_pnl += pnl_usdt
            total_value += amount_usdt
            
            positions.append({
                "id": f"manual_{pos_id}",
                "coin": coin,
                "symbol": coin,
                "side": side,
                "amount_usdt": amount_usdt,
                "entry_price": entry_price,
                "current_price": current_price,
                "pnl": round(pnl_usdt, 4),
                "pnl_percent": round(pnl_percent, 2),
                "source": "manual"
            })
        
        return jsonify({
            "ok": True, 
            "positions": positions,
            "total_pnl": round(total_pnl, 2),
            "total_value": round(total_value, 2),
            "count": len(positions),
            "mode": "DEMO"
        })
    except Exception as e:
        print(f"[POSITIONS] Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({"ok": True, "positions": [], "total_pnl": 0})

@app.post("/api/positions/sell")
def api_positions_sell():
    from flask import session as flask_session, request, jsonify
    import time
    import sqlite3

    # login kontrolÃ¼
    if not flask_session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    # kullanÄ±cÄ±
    uname = (flask_session.get("username") or flask_session.get("user") or flask_session.get("email") or "").strip()
    user_id = int(flask_session.get("user_id") or 0)

    j = request.get_json(silent=True) or {}
    raw_id = j.get("id", "")
    
    # Handle both string IDs (like "manual_5") and integer IDs
    position_id = 0
    id_prefix = ""
    try:
        if isinstance(raw_id, str):
            if raw_id.startswith("manual_"):
                id_prefix = "manual_"
                position_id = int(raw_id.replace("manual_", ""))
            elif raw_id.startswith("auto_"):
                id_prefix = "auto_"
                position_id = int(raw_id.replace("auto_", ""))
            else:
                position_id = int(raw_id)
        else:
            position_id = int(raw_id)
    except (ValueError, TypeError):
        position_id = 0
    
    print(f"[SELL] Raw ID: {raw_id}, Parsed ID: {position_id}, Prefix: {id_prefix}, User: {user_id}")
    
    if position_id <= 0:
        return jsonify({"ok": False, "error": "GeÃ§ersiz pozisyon id"}), 400

    db_path = globals().get("DB_PATH") or globals().get("DB_FILE") or "/root/backend/data.db"

    def _get_live_price(symbol: str, entry_price: float) -> float:
        try:
            prices = get_live_crypto_prices()  # projedeki mevcut fonksiyon
            if isinstance(prices, dict):
                base = symbol.replace("/USDT", "").replace("USDT", "")
                return float(
                    prices.get(symbol)
                    or prices.get(base)
                    or prices.get(f"{base}/USDT")
                    or entry_price
                )
        except Exception:
            pass
        return float(entry_price)

    # 1) pozisyonu oku (auto_positions, demo_positions veya paper_test_positions)
    con = sqlite3.connect(db_path)
    con.row_factory = sqlite3.Row
    cur = con.cursor()

    row = None
    table_used = None
    for tbl in ("auto_positions", "demo_positions", "paper_test_positions"):
        try:
            # bazÄ± ÅŸemalarda user_id yok; Ã¶nce user_id ile dene, olmazsa idsiz dene
            try:
                row = cur.execute(f"SELECT * FROM {tbl} WHERE id=? AND user_id=?", (position_id, user_id)).fetchone()
            except Exception:
                row = cur.execute(f"SELECT * FROM {tbl} WHERE id=?", (position_id,)).fetchone()
            if row:
                table_used = tbl
                break
        except Exception:
            continue

    if not row:
        try:
            con.close()
        except Exception:
            pass
        return jsonify({"ok": False, "error": "Pozisyon bulunamadÄ±"}), 404

    d = dict(row)

    # kolon fallbackâ€™leri
    coin = d.get("coin") or d.get("symbol") or d.get("pair") or d.get("market") or "BTC/USDT"
    entry_price = float(d.get("entry_price") or d.get("buy_price") or d.get("price") or 0.0) or 0.0
    amount_usdt = float(d.get("amount_usdt") or d.get("usdt") or d.get("amount") or d.get("qty") or 0.0) or 0.0

    if entry_price <= 0 or amount_usdt <= 0:
        try:
            con.close()
        except Exception:
            pass
        return jsonify({"ok": False, "error": "Pozisyon verisi eksik"}), 500

    current_price = _get_live_price(str(coin), entry_price)

    # pnl (basit): USDT pozisyon deÄŸeri * (fiyat deÄŸiÅŸimi)
    pnl = (current_price - entry_price) / entry_price * amount_usdt

    # 2) pozisyonu sil veya closed yap (auto_positions iÃ§in status update)
    try:
        if table_used == "auto_positions":
            cur.execute(f"UPDATE {table_used} SET status='closed', exit_at=?, pnl=? WHERE id=?", 
                       (int(time.time()), pnl, position_id))
        else:
            cur.execute(f"DELETE FROM {table_used} WHERE id=?", (position_id,))
    except Exception:
        pass
    
    # 2.5) Ä°ÅŸlem geÃ§miÅŸine kayÄ±t ekle
    try:
        cur.execute("""
            INSERT INTO demo_trades (user_id, coin, side, amount_usdt, price, pnl, created_at, mode)
            VALUES (?, ?, 'SELL', ?, ?, ?, ?, 'demo')
        """, (user_id, coin, amount_usdt, current_price, pnl, int(time.time())))
    except Exception as e:
        print(f"[SELL] Trade history insert error: {e}")
        # Try creating table if it doesn't exist
        try:
            cur.execute("""
                CREATE TABLE IF NOT EXISTS demo_trades (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    coin TEXT,
                    side TEXT,
                    amount_usdt REAL,
                    price REAL,
                    pnl REAL,
                    created_at INTEGER,
                    mode TEXT DEFAULT 'demo'
                )
            """)
            cur.execute("""
                INSERT INTO demo_trades (user_id, coin, side, amount_usdt, price, pnl, created_at, mode)
                VALUES (?, ?, 'SELL', ?, ?, ?, ?, 'demo')
            """, (user_id, coin, amount_usdt, current_price, pnl, int(time.time())))
        except Exception:
            pass
    # 3) users.demo_balance gÃ¼ncelle (tek doÄŸru kaynak) â€” her zaman user_id ile garanti et
    new_balance = None
    try:
        # mevcut balance (Ã¶nce id, sonra username)
        r = None
        try:
            r = cur.execute("SELECT demo_balance FROM users WHERE id=? LIMIT 1", (user_id,)).fetchone()
        except Exception:
            r = None

        if (not r) and uname:
            try:
                r = cur.execute("SELECT demo_balance FROM users WHERE username=? LIMIT 1", (uname,)).fetchone()
            except Exception:
                r = None

        old_bal = float((r[0] if r else 0.0) or 0.0)

        # sell: amount_usdt + pnl geri eklenir
        new_balance = old_bal + float(amount_usdt) + float(pnl)

        # update â€” Ã¶nce id, olmazsa username
        updated = False
        try:
            cur.execute("UPDATE users SET demo_balance=?, updated_at=? WHERE id=?",
                        (float(new_balance), int(time.time()), int(user_id)))
            updated = (cur.rowcount or 0) > 0
        except Exception:
            updated = False

        if (not updated) and uname:
            try:
                cur.execute("UPDATE users SET demo_balance=?, updated_at=? WHERE username=?",
                            (float(new_balance), int(time.time()), uname))
                updated = (cur.rowcount or 0) > 0
            except Exception:
                pass
    except Exception:
        new_balance = None

    try:
        con.commit()
    except Exception:
        pass
    except Exception:
        pass
    try:
        con.close()
    except Exception:
        pass

    out = {
        "ok": True,
        "id": position_id,
        "coin": coin,
        "entry_price": entry_price,
        "current_price": current_price,
        "amount_usdt": amount_usdt,
        "pnl": pnl,
    }
    if new_balance is not None:
        out["new_balance"] = float(new_balance)
        out["balance"] = float(new_balance)
        out["balance_usdt"] = float(new_balance)
    return jsonify(out), 200



@app.post("/api/trade/execute")
def api_trade_execute():
    session["mode"] = "real"
    session["trade_mode"] = "real"
    if not session.get("logged_in"):
        # --- SYNC_USERS_DEMO_BALANCE (auto-added) ---
        # UI /api/real/balance => users.demo_balance okuyor. DEMO trade sonrasÄ± users.demo_balance'Ä± new_balance ile eÅŸitle.
        try:
            import sqlite3
            _uid = session.get("user_id")
            _uname = session.get("username") or session.get("email") or session.get("user")
            _nb = None
            try:
                _nb = float(new_balance)
            except Exception:
                _nb = None
            if _nb is not None:
                _con = sqlite3.connect(DB_PATH)
                _cur = _con.cursor()
                _updated = 0
                if _uid is not None:
                    _cur.execute("UPDATE users SET demo_balance=? WHERE id=? OR rowid=?", (_nb, _uid, _uid))
                    _updated = _cur.rowcount or 0
                if (not _updated) and _uname:
                    _cur.execute("UPDATE users SET demo_balance=? WHERE username=? OR email=?", (_nb, str(_uname), str(_uname)))
                _con.commit()
                _con.close()
        except Exception:
            pass
        # --- /SYNC_USERS_DEMO_BALANCE ---
        return jsonify({"ok": False, "error": "Login required"}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    coin = str(j.get("coin", "")).strip().upper()
    amount = float(j.get("amount_usdt", 10))
    side = str(j.get("side", "BUY")).upper()
    
    # âœ… ENHANCED MODE DETECTION with detailed logging
    mode_from_request = j.get("mode")
    mode_from_session_primary = session.get("trade_mode")  # NEW: Primary mode source from toggle
    mode_from_ui = session.get("ui_mode")
    mode_from_session = session.get("mode")
    mode_from_account = session.get("account_mode")
    
    print(f"[TRADE_EXECUTE] Mode Resolution Debug:")
    print(f"  Request mode: {mode_from_request}")
    print(f"  Session trade_mode (PRIMARY): {mode_from_session_primary}")
    print(f"  Session ui_mode: {mode_from_ui}")
    print(f"  Session mode: {mode_from_session}")
    print(f"  Session account_mode: {mode_from_account}")
    print(f"  User ID: {session.get('user_id')}")
    print(f"  Coin: {coin}, Amount: {amount}, Side: {side}")
    
    # Priority: request > session trade_mode > other session vars > default demo
    mode = "real" # Forced Real Mode
    if mode in ("live","real"):
        mode = "real"
    if mode not in ("demo","real"):
        mode = "demo"
    
    print(f"  FINAL MODE: {mode}")

    # --- COIN NORMALIZE FIX (auto-added) ---
    try:
        _p = request.get_json(silent=True) or {}
    except Exception:
        _p = {}

    def _norm_pair(v):
        if v is None:
            return ""
        v = str(v).strip()
        if not v:
            return ""
        if "/" not in v and v.upper().endswith("USDT") and len(v) > 4:
            v = v[:-4] + "/USDT"
        v = v.replace("-", "/").replace("_", "/")
        return v.upper()

    _raw_coin = (
        _p.get("coin")
        or _p.get("symbol")
        or _p.get("pair")
        or _p.get("market")
        or _p.get("selectedCoin")
        or _p.get("selected_coin")
    )
    coin = _norm_pair(_raw_coin)

    try:
        if (not coin) and ("symbol" in locals()) and symbol:
            coin = _norm_pair(symbol)
    except Exception:
        pass

    try:
        if ("symbol" not in locals()) or (not symbol):
            symbol = coin
    except Exception:
        symbol = coin

    if not coin:
        return jsonify({"ok": False, "error": "coin_missing", "detail": "coin/symbol gerekli"}), 400
    # --- /COIN NORMALIZE FIX ---

    # --- SYMBOL DB GUARD V4 (auto-added) ---
    # demo_positions.symbol NOT NULL -> DB'ye gitmeden Ã¶nce kesin doldur
    try:
        _p = request.get_json(silent=True) or {}
    except Exception:
        _p = {}
    
    def _norm_pair(v):
        if v is None:
            return ''
        v = str(v).strip()
        if not v:
            return ''
        if '/' not in v and v.upper().endswith('USDT') and len(v) > 4:
            v = v[:-4] + '/USDT'
        v = v.replace('-', '/').replace('_', '/')
        return v.upper()
    
    _raw = (_p.get('symbol') or _p.get('coin') or _p.get('pair') or _p.get('market') or _p.get('selectedCoin') or _p.get('selected_coin') or '')
    try:
        if (not _raw) and ('symbol' in locals()) and symbol:
            _raw = symbol
    except Exception:
        pass
    try:
        if (not _raw) and ('coin' in locals()) and coin:
            _raw = coin
    except Exception:
        pass
    
    symbol_db = _norm_pair(_raw)
    if not symbol_db:
        return jsonify({'ok': False, 'error': 'symbol_missing', 'detail': 'symbol/coin gerekli'}), 400
    
    # handler iÃ§inde kim kullanÄ±yorsa hepsini doldur (DB paramlarÄ± boÅŸ kalmasÄ±n)
    symbol = symbol_db
    coin = symbol_db
    sym = symbol_db
    pair = symbol_db
    market = symbol_db
    selected_coin = symbol_db
    selectedCoin = symbol_db
    
    # payload'Ä± da gÃ¼ncelle (bazÄ± insertler payload'dan alÄ±yor olabilir)
    try:
        _p['symbol'] = symbol_db
        _p['coin'] = symbol_db
    except Exception:
        pass
    # --- /SYMBOL DB GUARD V4 ---
    
    if amount < 1.0:
        return jsonify({"ok": False, "error": "Minimum 1 USDT"}), 400
    
    mode = "real" # Forced Real
    if False: # Demo Disabled
        current_balance = get_demo_balance(user_id)
        if current_balance < amount:
            return jsonify({"ok": False, "error": f"Yetersiz bakiye. Mevcut: ${current_balance:.2f}"}), 400
        
        # Normalize coin format
        coin_base = coin.replace("/USDT", "").replace("USDT", "").upper()
        coin_symbol = f"{coin_base}/USDT"
        
        entry_price = 0
        
        # Method 1: Try ccxt OKX for real-time price (most reliable)
        try:
            import ccxt
            ex = ccxt.okx({"enableRateLimit": True, "timeout": 5000})
            ticker = ex.fetch_ticker(coin_symbol)
            entry_price = float(ticker.get("last", 0))
            print(f"[TRADE] Got price from OKX: {coin_symbol} = ${entry_price}")
        except Exception as e:
            print(f"[TRADE] OKX price fetch failed: {e}")
        
        # Method 2: Fallback to local cache
        if entry_price <= 0:
            prices = get_live_crypto_prices()
            entry_price = (
                prices.get(coin) or 
                prices.get(coin_base) or 
                prices.get(coin_symbol) or 
                0
            )
            if entry_price > 0:
                print(f"[TRADE] Got price from cache: {coin_symbol} = ${entry_price}")
        
        # Method 3: Fallback to CoinGecko API
        if entry_price <= 0:
            try:
                coin_ids = {"BTC": "bitcoin", "ETH": "ethereum", "SOL": "solana", "XRP": "ripple", "BNB": "binancecoin", "ADA": "cardano", "DOGE": "dogecoin", "AVAX": "avalanche-2", "DOT": "polkadot", "TRX": "tron", "MATIC": "matic-network"}
                cg_id = coin_ids.get(coin_base, coin_base.lower())
                resp = requests.get(f"https://api.coingecko.com/api/v3/simple/price?ids={cg_id}&vs_currencies=usd", timeout=5)
                if resp.status_code == 200:
                    data = resp.json()
                    entry_price = data.get(cg_id, {}).get("usd", 0)
                    if entry_price > 0:
                        print(f"[TRADE] Got price from CoinGecko: {coin_symbol} = ${entry_price}")
            except Exception as e:
                print(f"[TRADE] CoinGecko price fetch error: {e}")
        
        if entry_price <= 0:
            return jsonify({"ok": False, "error": f"Fiyat alÄ±namadÄ± ({coin_symbol}). LÃ¼tfen tekrar deneyin."}), 400
        
        # *** MODE CHECK: Execute demo or real trade ***
        mode = "real" # Forced Real
        if False: # Demo Disabled
            try:
                conn = db()
                
                # Ensure demo_positions table exists with source column
                conn.execute("""
                    CREATE TABLE IF NOT EXISTS demo_positions (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id INTEGER,
                        coin TEXT,
                        side TEXT,
                        amount_usdt REAL,
                        entry_price REAL,
                        current_price REAL,
                        pnl REAL DEFAULT 0,
                        status TEXT DEFAULT 'open',
                        created_at INTEGER,
                        closed_at INTEGER,
                        source TEXT DEFAULT 'manual'
                    )
                """)
                
                # Ensure source column exists
                try:
                    conn.execute("SELECT source FROM demo_positions LIMIT 1")
                except:
                    try:
                        conn.execute("ALTER TABLE demo_positions ADD COLUMN source TEXT DEFAULT 'manual'")
                        conn.commit()
                    except:
                        pass
                
                conn.execute(
                    """INSERT INTO demo_positions 
                   (user_id, coin, side, amount_usdt, entry_price, current_price, pnl, status, created_at, source)
                   VALUES (?,?,?,?,?,?,?,?,?,?)""",
                    (user_id, coin, side, amount, entry_price, entry_price, 0, "open", int(time.time()), "manual")
                )
                conn.commit()
                
                # âœ… CRITICAL: Log BUY transaction to history
                try:
                    username = session.get("username") or session.get("email") or session.get("user") or f"user_{user_id}"
                    qty = amount / entry_price
                    
                    conn.execute("""
                        INSERT INTO transaction_history (
                            username, type, symbol, amount, price, total,
                            profit, timestamp, is_simulated, mode
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    """, (
                        username,
                        side,  # "BUY" or "SELL"
                        coin,
                        qty,
                        entry_price,
                        amount,
                        0.0,  # No profit on BUY
                        int(time.time()),
                        1,  # is_simulated = 1 for demo
                        "demo"
                    ))
                    conn.commit()
                    
                    print(f"[DEMO_{side}] âœ… {username}: {coin} {side} @ {entry_price:.2f} | Amount: {amount} USDT | Manual trade")
                except Exception as e:
                    print(f"[DEMO_{side}] âŒ Transaction log error: {e}")
                
                conn.close()

                
                # Deduct from demo balance
                new_balance = update_demo_balance(user_id, -amount)
                
                return jsonify({
                    "ok": True, 
                    "message": f"{side} {coin} baÅŸarÄ±lÄ± @ ${entry_price:,.2f}",
                    "entry_price": entry_price,
                    "new_balance": new_balance
                })
            except Exception as e:
                print(f"[TRADE] Error: {e}")
                return jsonify({"ok": False, "error": str(e)}), 500
    else:
        # REAL MODE - Trade on exchange (OKX, Binance, etc.)
        try:
            # Get selected exchange from request or default to OKX
            exchange = str(j.get("exchange") or "okx").lower().strip()
            
            # Get exchange client
            client = get_exchange_client(user_id, exchange)
            if not client or not client.api_key:
                return jsonify({"ok": False, "error": f"{exchange.upper()} API anahtarlarÄ± yapÄ±landÄ±rÄ±lmamÄ±ÅŸ. LÃ¼tfen Borsa API AyarlarÄ± sayfasÄ±ndan baÄŸlayÄ±n."}), 400
            
            # Fetch USDT balance using the correct method
            usdt_balance = client.get_usdt_balance()
            print(f"[REAL TRADE] User {user_id} {exchange.upper()} balance: ${usdt_balance:.2f}")
            
            if usdt_balance < amount:
                return jsonify({"ok": False, "error": f"Yetersiz bakiye. Mevcut: ${usdt_balance:.2f}"}), 400
            
            # Normalize coin format
            coin_base = coin.replace("/USDT", "").replace("USDT", "").upper()
            coin_symbol = f"{coin_base}/USDT"
            
            # Get current price
            current_price = client.get_ticker_price(coin_symbol)
            if current_price <= 0:
                return jsonify({"ok": False, "error": f"{coin_symbol} fiyatÄ± alÄ±namadÄ±"}), 400
            
            # Place market order using OKXClient's place_market_order
            if side.upper() == "BUY":
                order_result = client.place_market_order(coin_symbol, "buy", amount)
            else:
                # For SELL, amount should be the quantity, not USDT
                qty = amount / current_price
                order_result = client.place_market_order(coin_symbol, "sell", qty)
            
            if not order_result.get("ok"):
                return jsonify({"ok": False, "error": order_result.get("error", "Ä°ÅŸlem baÅŸarÄ±sÄ±z")}), 400
            
            # Log real trade to database
            try:
                conn = db()
                conn.execute("""
                    CREATE TABLE IF NOT EXISTS real_trades (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id INTEGER,
                        coin TEXT,
                        side TEXT,
                        amount_usdt REAL,
                        price REAL,
                        exchange TEXT,
                        order_data TEXT,
                        created_at INTEGER
                    )
                """)
                conn.execute("""
                    INSERT INTO real_trades (user_id, coin, side, amount_usdt, price, exchange, order_data, created_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                """, (user_id, coin_symbol, side.upper(), amount, current_price, exchange, json.dumps(order_result.get("data", [])), int(time.time())))
                conn.commit()
                conn.close()
            except Exception as db_err:
                print(f"[REAL TRADE] DB log error: {db_err}")
            
            # Send Telegram notification if configured
            try:
                conn = db()
                row = conn.execute("SELECT telegram_chat_id FROM users WHERE id=?", (user_id,)).fetchone()
                conn.close()
                if row and row[0]:
                    emoji = "ğŸŸ¢" if side.upper() == "BUY" else "ğŸ”´"
                    msg = f"{emoji} REAL {side.upper()} {coin_symbol}\nğŸ’° Miktar: ${amount:.2f} USDT\nğŸ“Š Fiyat: ${current_price:.4f}\nğŸ¦ Borsa: {exchange.upper()}"
                    send_telegram_message(msg, row[0])
            except Exception as tg_err:
                print(f"[REAL TRADE] Telegram error: {tg_err}")
            
            return jsonify({
                "ok": True,
                "message": f"REAL {side.upper()} {coin_symbol} baÅŸarÄ±lÄ±!",
                "order_data": order_result.get("data"),
                "price": current_price,
                "new_balance": usdt_balance - amount if side.upper() == "BUY" else usdt_balance + amount
            })
        except Exception as e:
            print(f"[REAL TRADE] Error: {e}")
            import traceback
            traceback.print_exc()
            return jsonify({"ok": False, "error": f"Ä°ÅŸlem hatasÄ±: {str(e)}"}), 500




# ===================================================
# COMPLETE TRADING DASHBOARD
# ===================================================

def get_user_header_html(username, package="Temel", usage=0, limit=300):
    """Generate user header HTML"""
    first_letter = username[0].upper() if username else 'U'
    
    # Handle unlimited (-1) limit
    if limit < 0:
        limit_display = "âˆ"
        pct = 0  # No progress bar for unlimited
    else:
        limit_display = str(limit)
        pct = int((usage / limit * 100) if limit > 0 else 0)
    
    return f"""
    <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4 flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">
                {first_letter}
            </div>
            <div>
                <p class="text-white font-medium">{username}</p>
                <p class="text-xs text-gray-500">{package} Paketi</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <p class="text-xs text-gray-400">KullanÄ±m</p>
                <p class="text-sm text-white font-medium">{usage}/{limit_display}</p>
            </div>
            <div class="w-24 h-2 bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500 rounded-full" style="width: {pct}%"></div>
            </div>
        </div>
    </div>
    """


# ============================================
# COMPREHENSIVE ADMIN PANEL TEMPLATES
# ============================================

ADMIN_SIDEBAR = """
<div class="sidebar">
    <div class="p-4 border-b border-white/10">
        <a href="/api/app/dashboard" class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-orange-600 flex items-center justify-center"><span class="text-white text-lg font-bold">âš™ï¸</span></div>
            <span class="text-white font-semibold">Admin Panel</span>
        </a>
    </div>
    <nav class="p-2 space-y-1">
        <a href="/api/app/admin" class="sidebar-link {dashboard_active}">ğŸ“Š Dashboard</a>
        <a href="/api/app/admin/users" class="sidebar-link {users_active}">ğŸ‘¥ KullanÄ±cÄ±lar</a>
        <a href="/api/app/admin/packages" class="sidebar-link {packages_active}">ğŸ“¦ Paket YÃ¶netimi</a>
        <a href="/api/app/admin/telegram" class="sidebar-link {telegram_active}">ğŸ“± Telegram AyarlarÄ±</a>
        <a href="/api/app/admin/webhooks" class="sidebar-link {webhooks_active}">ğŸ”— Webhooklar</a>
        <a href="/api/app/admin/education" class="sidebar-link {education_active}">ğŸ“ EÄŸitim Merkezi</a>
        <a href="/api/app/admin/analytics" class="sidebar-link {analytics_active}">ğŸ“ˆ Analitik</a>
        <a href="/api/app/admin/settings" class="sidebar-link {settings_active}">âš™ï¸ Ayarlar</a>
        <div class="border-t border-white/10 my-4"></div>
        <a href="/api/app/dashboard" class="sidebar-link text-gray-500 hover:text-white">ğŸ  KullanÄ±cÄ± Paneli</a>
        <a href="/api/app/logout" class="sidebar-link text-red-400 hover:bg-red-500/10">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
</div>
"""

ADMIN_DASHBOARD_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f0f0f; color: white; font-family: system-ui, -apple-system, sans-serif; }
        .sidebar { position: fixed; left: 0; top: 0; height: 100%; width: 16rem; background: #1a1a1a; border-right: 1px solid rgba(255,255,255,0.1); z-index: 50; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; color: #9ca3af; transition: all 0.2s; }
        .sidebar-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar-link.active { background: #dc2626; color: white; }
        .main { margin-left: 16rem; padding: 2rem; }
    </style>
</head>
<body class="bg-[#0f0f0f] text-white">
    <!-- Sidebar -->
    REPLACE_WITH_SIDEBAR
    
    <div class="main">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold mb-6">Admin Dashboard</h1>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-[#1a1a1a] p-6 rounded-2xl border border-white/5">
                    <div class="text-gray-400 text-sm mb-2">Toplam KullanÄ±cÄ±</div>
                    <div class="text-3xl font-bold">{{ stats.active_users }}</div>
                </div>
                <div class="bg-[#1a1a1a] p-6 rounded-2xl border border-white/5">
                    <div class="text-gray-400 text-sm mb-2">Aktif Botlar</div>
                    <div class="text-3xl font-bold text-green-400">{{ stats.active_bots }}</div>
                </div>
                <div class="bg-[#1a1a1a] p-6 rounded-2xl border border-white/5">
                    <div class="text-gray-400 text-sm mb-2">Ä°ÅŸlem Hacmi</div>
                    <div class="text-3xl font-bold text-blue-400">{{ stats.volume }}</div>
                </div>
                <div class="bg-[#1a1a1a] p-6 rounded-2xl border border-white/5">
                    <div class="text-gray-400 text-sm mb-2">Toplam Gelir</div>
                    <div class="text-3xl font-bold text-yellow-400">{{ stats.revenue }}</div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6">
                <h2 class="text-lg font-bold mb-4">Sistem Durumu</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-black/20 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span>Server Status</span>
                        </div>
                        <span class="text-green-400 text-sm">Online (Uptime: 99.9%)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
""".replace('REPLACE_WITH_SIDEBAR', """
<div class="sidebar">
    <div class="p-4 border-b border-white/10">
        <a href="/api/app/dashboard" class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-orange-600 flex items-center justify-center"><span class="text-white text-lg font-bold">âš™ï¸</span></div>
            <span class="text-white font-semibold">Admin Panel</span>
        </a>
    </div>
    <nav class="p-2 space-y-1">
        <a href="/api/app/admin" class="sidebar-link active">ğŸ“Š Dashboard</a>
        <a href="/api/app/admin/users" class="sidebar-link">ğŸ‘¥ KullanÄ±cÄ±lar</a>
        <a href="/api/app/admin/packages" class="sidebar-link">ğŸ“¦ Paket YÃ¶netimi</a>
        <a href="/api/app/admin/telegram" class="sidebar-link">ğŸ“± Telegram AyarlarÄ±</a>
        <a href="/api/app/admin/webhooks" class="sidebar-link">ğŸ”— Webhooklar</a>
        <a href="/api/app/admin/education" class="sidebar-link">ğŸ“ EÄŸitim Merkezi</a>
        <a href="/api/app/admin/analytics" class="sidebar-link">ğŸ“ˆ Analitik</a>
        <a href="/api/app/admin/settings" class="sidebar-link">âš™ï¸ Ayarlar</a>
        <div class="border-t border-white/10 my-4"></div>
        <a href="/api/app/dashboard" class="sidebar-link text-gray-500 hover:text-white">ğŸ  KullanÄ±cÄ± Paneli</a>
        <a href="/api/app/logout" class="sidebar-link text-red-400 hover:bg-red-500/10">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
</div>
""")

ADMIN_USERS_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>KullanÄ±cÄ± YÃ¶netimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background-color: #0f0f0f; color: white; font-family: sans-serif; } .sidebar { position: fixed; left: 0; top: 0; height: 100%; width: 16rem; background: #1a1a1a; border-right: 1px solid rgba(255,255,255,0.1); } .main { margin-left: 16rem; padding: 2rem; }</style>
</head>
<body class="bg-[#0f0f0f]">
    REPLACE_WITH_SIDEBAR
    
    <div class="main">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">KullanÄ±cÄ± YÃ¶netimi</h1>
            <button onclick="openModal('add')" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-sm font-medium">Any Yeni KullanÄ±cÄ±</button>
        </div>
        
        <div class="bg-[#1a1a1a] rounded-xl border border-white/5 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-black/20 text-gray-400 text-xs uppercase">
                    <tr>
                        <th class="p-4">ID</th>
                        <th class="p-4">KullanÄ±cÄ± AdÄ±</th>
                        <th class="p-4">Rol</th>
                        <th class="p-4">Paket</th>
                        <th class="p-4">Bakiye</th>
                        <th class="p-4">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for u in users %}
                    <tr class="hover:bg-white/5">
                        <td class="p-4 text-gray-400">#{{ u.rowid }}</td>
                        <td class="p-4 font-medium">{{ u.username }}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded-md bg-blue-500/10 text-blue-400 text-xs">{{ u.role }}</span></td>
                        <td class="p-4"><span class="px-2 py-1 rounded-md bg-green-500/10 text-green-400 text-xs">{{ u.package }}</span></td>
                        <td class="p-4 font-mono">{{ u.balance }} USDT</td>
                        <td class="p-4">
                            <button onclick='openModal("edit", {{ u|tojson }})' class="text-blue-400 hover:text-blue-300 mr-3">DÃ¼zenle</button>
                            <button onclick="deleteUser({{ u.rowid }})" class="text-red-400 hover:text-red-300">Sil</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- User Modal -->
    <div id="userModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-[#1a1a1a] p-8 rounded-2xl w-full max-w-md border border-white/10">
            <h2 id="modalTitle" class="text-xl font-bold mb-6">KullanÄ±cÄ± Ekle</h2>
            <input type="hidden" id="userId">
            <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 mb-4 text-white">
            <input type="password" id="password" placeholder="Åifre" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 mb-4 text-white">
            <select id="role" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 mb-4 text-white">
                <option value="user">User</option>
                <option value="admin">Admin</option>
            </select>
            <label class="text-gray-400 text-sm mb-2 block">Paket SeÃ§imi</label>
            <select id="packageName" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 mb-4 text-white">
                <option value="trial">Deneme</option>
                <option value="temel">Temel</option>
                <option value="premium">Premium</option>
                <option value="elit">Elite</option>
            </select>
            <input type="number" id="balance" placeholder="Bakiye (USDT)" value="0" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 mb-6 text-white">
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl">Ä°ptal</button>
                <button onclick="saveUser()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-3 rounded-xl">Kaydet</button>
            </div>
        </div>
    </div>
    
    <script>
        function openModal(mode, user=null) {
            document.getElementById('userModal').classList.remove('hidden');
            if (mode === 'edit' && user) {
                document.getElementById('modalTitle').textContent = 'KullanÄ±cÄ± DÃ¼zenle';
                document.getElementById('userId').value = user.rowid || user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('password').placeholder = 'Åifre (BoÅŸ bÄ±rakÄ±rsanÄ±z deÄŸiÅŸmez)';
                document.getElementById('role').value = user.role === 'Admin' ? 'admin' : 'user';
                document.getElementById('packageName').value = (user.package || 'temel').toLowerCase();
                document.getElementById('balance').value = user.balance;
            } else {
                document.getElementById('modalTitle').textContent = 'KullanÄ±cÄ± Ekle';
                document.getElementById('userId').value = '';
                document.getElementById('username').value = '';
                document.getElementById('password').placeholder = 'Åifre';
                document.getElementById('role').value = 'user';
                document.getElementById('packageName').value = 'temel';
                document.getElementById('balance').value = 0;
            }
        }
        function closeModal() { document.getElementById('userModal').classList.add('hidden'); }
        async function saveUser() {
            const id = document.getElementById('userId').value;
            const data = {
                id: id,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                package_name: document.getElementById('packageName').value,
                balance: document.getElementById('balance').value
            };
            const endpoint = id ? '/api/admin/users/edit' : '/api/admin/users/add';
            const resp = await fetch(endpoint, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)});
            const result = await resp.json();
            if (!result.ok) { alert('Hata: ' + (result.error || 'Bilinmeyen hata')); return; }
            location.reload();
        }
        async function deleteUser(id) {
            if(confirm('Silmek istediÄŸine emin misin?')) {
                await fetch('/api/admin/users/delete', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id}) });
                location.reload();
            }
        }
    </script>
</body>
</html>
""".replace('REPLACE_WITH_SIDEBAR', """
<div class="sidebar">
    <div class="p-4 border-b border-white/10">
        <a href="/api/app/dashboard" class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-orange-600 flex items-center justify-center"><span class="text-white text-lg font-bold">âš™ï¸</span></div>
            <span class="text-white font-semibold">Admin Panel</span>
        </a>
    </div>
    <nav class="p-2 space-y-1">
        <a href="/api/app/admin" class="sidebar-link">ğŸ“Š Dashboard</a>
        <a href="/api/app/admin/users" class="sidebar-link active">ğŸ‘¥ KullanÄ±cÄ±lar</a>
        <a href="/api/app/admin/packages" class="sidebar-link">ğŸ“¦ Paket YÃ¶netimi</a>
        <a href="/api/app/admin/telegram" class="sidebar-link">ğŸ“± Telegram AyarlarÄ±</a>
        <a href="/api/app/admin/webhooks" class="sidebar-link">ğŸ”— Webhooklar</a>
        <a href="/api/app/admin/education" class="sidebar-link">ğŸ“ EÄŸitim Merkezi</a>
        <a href="/api/app/admin/analytics" class="sidebar-link">ğŸ“ˆ Analitik</a>
        <a href="/api/app/admin/settings" class="sidebar-link">âš™ï¸ Ayarlar</a>
        <div class="border-t border-white/10 my-4"></div>
        <a href="/api/app/dashboard" class="sidebar-link text-gray-500 hover:text-white">ğŸ  KullanÄ±cÄ± Paneli</a>
        <a href="/api/app/logout" class="sidebar-link text-red-400 hover:bg-red-500/10">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
</div>
""")

ADMIN_CONTRACTS_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr">
<head><title>SÃ¶zleÅŸmeler</title><script src="https://cdn.tailwindcss.com"></script></head>
<body class="bg-[#0f0f0f] text-white">
    <div style="display:flex">
    <div style="width:16rem;background:#1a1a1a;height:100vh;position:fixed;border-right:1px solid #333">
        REPLACE_WITH_SIDEBAR_CONTENT
    </div>
    <div style="margin-left:16rem;padding:2rem;width:100%">
        <h1 class="text-2xl font-bold mb-6">SÃ¶zleÅŸme YÃ¶netimi</h1>
        <div class="bg-[#1a1a1a] p-8 rounded-xl text-center text-gray-400">
            <div class="text-4xl mb-4">ğŸ“„</div>
            <p>SÃ¶zleÅŸme yÃ¶netimi modÃ¼lÃ¼ yapÄ±m aÅŸamasÄ±nda.</p>
        </div>
    </div>
    </div>
</body>
</html>
""".replace('REPLACE_WITH_SIDEBAR_CONTENT', ADMIN_SIDEBAR.replace('<div class="sidebar">','').replace('</div>','').format(dashboard_active='', users_active='', contracts_active='', webhooks_active='', packages_active='', telegram_active='', education_active='', settings_active='', analytics_active=''))

_ADMIN_WEBHOOKS_TEMPLATE_OLD2 = """
<!DOCTYPE html>
<html lang="tr">
<head><title>Webhooks</title><script src="https://cdn.tailwindcss.com"></script></head>
<body class="bg-[#0f0f0f] text-white">
    <div style="display:flex">
    <div style="width:16rem;background:#1a1a1a;height:100vh;position:fixed;border-right:1px solid #333">
        REPLACE_WITH_SIDEBAR_CONTENT
    </div>
    <div style="margin-left:16rem;padding:2rem;width:100%">
        <h1 class="text-2xl font-bold mb-6">Webhook YÃ¶netimi</h1>
        <div class="bg-[#1a1a1a] p-8 rounded-xl text-center text-gray-400">
            <div class="text-4xl mb-4">ğŸ”—</div>
            <p>Webhook yapÄ±landÄ±rma modÃ¼lÃ¼ yapÄ±m aÅŸamasÄ±nda.</p>
        </div>
    </div>
    </div>
</body>
</html>
""".replace('REPLACE_WITH_SIDEBAR_CONTENT', ADMIN_SIDEBAR.replace('<div class="sidebar">','').replace('</div>','').format(dashboard_active='', users_active='', contracts_active='', webhooks_active='active', packages_active='', telegram_active='', education_active='', settings_active='', analytics_active=''))

# NOTE: get_sidebar_html is defined at line ~12570 - DO NOT redefine it here
# The correct function creates a fixed left vertical sidebar, not a horizontal navbar

# ==============================================
# STATIC PAGE TEMPLATES
# ==============================================

ABOUT_US_TEMPLATE = """<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HakkÄ±mÄ±zda - Atalay Ulusoy Kripto Ä°ÅŸlem Botu</title>
<meta name="description" content="Atalay Ulusoy otomatik kripto para iÅŸlem platformu hakkÄ±nda bilgi edinin. Misyonumuz, vizyonumuz ve gÃ¼venilir ticaret Ã§Ã¶zÃ¼mlerimiz.">
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<div class="flex min-h-screen">
{{ sidebar|safe }}
<main class="flex-1">
<div class="max-w-5xl mx-auto px-6 py-8">
<div class="flex items-center justify-between">
<a href="/login" class="text-slate-300 hover:text-white text-sm">â† Geri DÃ¶n</a>
<div class="text-xs text-slate-400">Atalay Ulusoy Auto Trade</div>
</div>

<h1 class="text-3xl font-bold mt-6">HakkÄ±mÄ±zda</h1>
<p class="text-slate-300 mt-2">Atalay Ulusoy Kripto Ä°ÅŸlem Platformu</p>

<div class="grid md:grid-cols-2 gap-6 mt-8">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6">
    <h2 class="text-xl font-semibold">Misyonumuz</h2>
    <p class="text-slate-300 mt-3 leading-relaxed">
      TÃ¼rk yatÄ±rÄ±mcÄ±lara gÃ¼venilir, otomatik ve profesyonel kripto para iÅŸlem Ã§Ã¶zÃ¼mleri sunmak.
      TradingView entegrasyonu ile 7/24 Ã§alÄ±ÅŸan botlarÄ±mÄ±z sayesinde, kullanÄ±cÄ±larÄ±mÄ±zÄ±n piyasa fÄ±rsatlarÄ±nÄ± kaÃ§Ä±rmamasÄ±nÄ±
      ve duygusal kararlar almadan sistematik ticaret yapmalarÄ±nÄ± saÄŸlÄ±yoruz.
    </p>
  </div>
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6">
    <h2 class="text-xl font-semibold">Vizyonumuz</h2>
    <p class="text-slate-300 mt-3 leading-relaxed">
      TÃ¼rkiye'nin en gÃ¼venilir ve kullanÄ±cÄ± dostu otomatik kripto iÅŸlem platformu olmak.
      GeliÅŸmiÅŸ risk yÃ¶netimi, yapay zeka destekli analiz ve Ã§oklu borsa entegrasyonu ile yatÄ±rÄ±mcÄ±larÄ±mÄ±za
      kurumsal seviyede ticaret deneyimi sunmayÄ± hedefliyoruz.
    </p>
  </div>
</div>

<div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 mt-6">
  <h2 class="text-xl font-semibold">Kurucumuz</h2>
  <p class="text-slate-300 mt-3 leading-relaxed">
    Atalay Ulusoy, 2017 yÄ±lÄ±ndan beri kripto para piyasalarÄ±nda aktif olarak iÅŸlem yapan deneyimli bir trader'dÄ±r.
    YazÄ±lÄ±m geliÅŸtirme ve finansal piyasalar konusundaki uzmanlÄ±ÄŸÄ±nÄ± birleÅŸtirerek, TÃ¼rk yatÄ±rÄ±mcÄ±larÄ±n ihtiyaÃ§larÄ±na Ã¶zel bu platformu geliÅŸtirmiÅŸtir.
  </p>
  <p class="text-slate-300 mt-3 leading-relaxed">
    Platformumuz, yÄ±llarca sÃ¼ren piyasa deneyimi ve binlerce iÅŸlem analizinin sonucunda ortaya Ã§Ä±kan stratejileri otomatikleÅŸtirerek,
    kullanÄ±cÄ±larÄ±mÄ±za profesyonel seviyede ticaret imkanÄ± sunmaktadÄ±r.
  </p>
</div>

<div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 mt-6">
  <h2 class="text-xl font-semibold">Teknolojimiz</h2>
  <div class="grid md:grid-cols-2 gap-4 mt-4">
    <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
      <div class="font-semibold">TradingView Entegrasyonu</div>
      <div class="text-slate-300 mt-2">TradingView webhook entegrasyonu sayesinde anlÄ±k sinyal alÄ±mÄ± ve otomatik iÅŸlem gerÃ§ekleÅŸtirme.</div>
    </div>
    <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
      <div class="font-semibold">Ã‡oklu Borsa DesteÄŸi</div>
      <div class="text-slate-300 mt-2">Binance, Bybit, OKX ve diÄŸer Ã¶nde gelen borsalar ile API entegrasyonu. TÃ¼m iÅŸlemlerinizi tek platformdan yÃ¶netin.</div>
    </div>
    <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
      <div class="font-semibold">GeliÅŸmiÅŸ Risk YÃ¶netimi</div>
      <div class="text-slate-300 mt-2">Trailing stop loss, gÃ¼nlÃ¼k zarar limitleri, pozisyon boyutlandÄ±rma ve acil durdurma Ã¶zellikleri ile sermayenizi koruyun.</div>
    </div>
    <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
      <div class="font-semibold">GerÃ§ek ZamanlÄ± Bildirimler</div>
      <div class="text-slate-300 mt-2">Telegram entegrasyonu ile anlÄ±k iÅŸlem bildirimleri, risk uyarÄ±larÄ± ve performans raporlarÄ±.</div>
    </div>
  </div>
  <div class="mt-6">
    <h3 class="text-lg font-semibold">GÃ¼venlik ve Uyumluluk</h3>
    <ul class="list-disc pl-5 text-slate-300 mt-3 space-y-2">
      <li>API anahtarlarÄ±nÄ±z ÅŸifreli olarak saklanÄ±r ve asla Ã¼Ã§Ã¼ncÃ¼ taraflarla paylaÅŸÄ±lmaz.</li>
      <li>TÃ¼m iÅŸlemler SSL/TLS ÅŸifrelemesi ile gÃ¼venli kanallardan gerÃ§ekleÅŸtirilir.</li>
      <li>Ä°ki faktÃ¶rlÃ¼ kimlik doÄŸrulama (2FA) desteÄŸi ile hesap gÃ¼venliÄŸi.</li>
      <li>FonlarÄ±nÄ±z kendi borsa hesabÄ±nÄ±zda kalÄ±r, biz sadece iÅŸlem sinyali gÃ¶ndeririz.</li>
    </ul>
  </div>
</div>

<div class="grid md:grid-cols-3 gap-4 mt-6">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 text-center"><div class="text-3xl font-bold">7/24</div><div class="text-slate-300 mt-1">Kesintisiz Hizmet</div></div>
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 text-center"><div class="text-3xl font-bold">5+</div><div class="text-slate-300 mt-1">Desteklenen Borsa</div></div>
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 text-center"><div class="text-3xl font-bold">99.9%</div><div class="text-slate-300 mt-1">Uptime Garantisi</div></div>
</div>

<div class="rounded-2xl border border-slate-800 bg-gradient-to-r from-slate-900/60 to-slate-950/30 p-6 mt-6">
  <h2 class="text-xl font-semibold">Otomatik Ä°ÅŸlem Botunuzu Kurmaya HazÄ±r MÄ±sÄ±nÄ±z</h2>
  <p class="text-slate-300 mt-2">Hemen Ã¼cretsiz hesap oluÅŸturun ve 7 gÃ¼n deneme sÃ¼renizden yararlanÄ±n.</p>
  <div class="flex flex-wrap gap-3 mt-4">
    <a href="/register" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold">Ãœcretsiz KayÄ±t Ol</a>
    <a href="/support" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold">Destek Al</a>
  </div>
</div>

<footer class="mt-10 pt-6 border-t border-slate-800 text-sm text-slate-400 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
  <div class="flex gap-4">
    <a class="hover:text-white" href="/about">HakkÄ±mÄ±zda</a>
    <a class="hover:text-white" href="/support">Destek</a>
    <a class="hover:text-white" href="/faq">SSS</a>
    <a class="hover:text-white" href="/contact">Ä°letiÅŸim</a>
  </div>
  <div>Â© {{ year }} Atalay Ulusoy. TÃ¼m haklarÄ± saklÄ±dÄ±r.</div>
</footer>

</div>
</main>
</div>
</body>
</html>"""

FAQ_TEMPLATE = """<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SÄ±k Sorulan Sorular (SSS) - Atalay Ulusoy Kripto Ä°ÅŸlem Botu</title>
<meta name="description" content="Atalay Ulusoy kripto iÅŸlem botu hakkÄ±nda sÄ±k sorulan sorular. Bot kullanÄ±mÄ±, API ayarlarÄ±, risk yÃ¶netimi, Ã¶deme ve gÃ¼venlik konularÄ±nda detaylÄ± yanÄ±tlar.">
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<div class="flex min-h-screen">
{{ sidebar|safe }}
<main class="flex-1">
<div class="max-w-5xl mx-auto px-6 py-8">
<div class="flex items-center justify-between">
<a href="/login" class="text-slate-300 hover:text-white text-sm">â† Geri DÃ¶n</a>
<div class="text-xs text-slate-400">Merak ettiklerinizin yanÄ±tlarÄ± burada</div>
</div>

<h1 class="text-3xl font-bold mt-6">SÄ±k Sorulan Sorular</h1>

<div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 mt-6">
  <div class="text-slate-200 font-semibold">Aranan soruyu bulamadÄ±nÄ±z mÄ±</div>
  <div class="flex flex-wrap gap-3 mt-3">
    <a href="/support" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold">Destek Merkezi</a>
    <a href="/contact" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold">Ä°letiÅŸim</a>
  </div>
</div>

{% macro qa(q,a) -%}
<details class="group rounded-2xl border border-slate-800 bg-slate-900/40 p-5">
  <summary class="cursor-pointer list-none font-semibold flex items-center justify-between">
    <span>{{ q }}</span><span class="text-slate-400 group-open:rotate-180 transition">âŒ„</span>
  </summary>
  <div class="text-slate-300 mt-3 leading-relaxed">{{ a }}</div>
</details>
{%- endmacro %}

<h2 class="text-xl font-semibold mt-8">Genel Sorular</h2>
<div class="grid gap-3 mt-3">
{{ qa("Atalay Ulusoy Trading Bot nedir",
"TradingView sinyallerine gÃ¶re otomatik olarak kripto para alÄ±m-satÄ±m iÅŸlemleri yapan profesyonel bir platformdur. 7/24 Ã§alÄ±ÅŸan bot, stratejinize gÃ¶re otomatik iÅŸlem yapar ve sistematik ticaret saÄŸlar.") }}
{{ qa("Sistem nasÄ±l Ã§alÄ±ÅŸÄ±r",
"Sistem 3 adÄ±mda Ã§alÄ±ÅŸÄ±r: 1) TradingView'dan webhook ile alÄ±m-satÄ±m sinyali gelir, 2) Bot sinyali alÄ±r ve risk kurallarÄ±nÄ± kontrol eder, 3) Onaylanan sinyaller baÄŸlÄ± borsada iÅŸleme dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼r. Telegram Ã¼zerinden anlÄ±k bildirim alÄ±rsÄ±nÄ±z.") }}
{{ qa("GerÃ§ek para ile iÅŸlem yapabilir miyim",
{{ qa("FonlarÄ±m gÃ¼vende mi",
"FonlarÄ±nÄ±z borsa hesabÄ±nÄ±zda kalÄ±r. Sadece trade yetkili API key kullanÄ±lÄ±r, withdrawal yetkisi verilmez. BÃ¶ylece bot alÄ±m-satÄ±m yapabilir, para Ã§ekemez.") }}
</div>

<h2 class="text-xl font-semibold mt-8">Hesap ve KayÄ±t</h2>
<div class="grid gap-3 mt-3">
{{ qa("NasÄ±l kayÄ±t olabilirim",
"Ana sayfada KayÄ±t Ol butonuna tÄ±klayÄ±n, bilgileri girin ve koÅŸullarÄ± onaylayÄ±n. KayÄ±t sonrasÄ± 7 gÃ¼n Ã¼cretsiz deneme sÃ¼resi baÅŸlar.") }}
{{ qa("API anahtarlarÄ±mÄ± nerede eklerim",
"Trading Dashboard iÃ§inde Borsa BaÄŸlantÄ±larÄ± bÃ¶lÃ¼mÃ¼nden borsa seÃ§ip API bilgilerini girin. OKX iÃ§in passphrase de girilmelidir. API oluÅŸtururken trade yetkisi verin, withdrawal yetkisi vermeyin.") }}
</div>

<h2 class="text-xl font-semibold mt-8">Teknik Sorunlar</h2>
<div class="grid gap-3 mt-3">
{{ qa("Bot Ã§alÄ±ÅŸmÄ±yor, ne yapmalÄ±yÄ±m",
"Sayfa yenileyin, cache temizleyin, farklÄ± tarayÄ±cÄ± deneyin, baÄŸlantÄ±yÄ± ve borsa API durumunu kontrol edin. System Status ve Webhook Logs bÃ¶lÃ¼mlerine bakÄ±n.") }}
{{ qa("Grafik gÃ¶rÃ¼nmÃ¼yor",
"Sayfa yenileyin, reklam engelleyiciyi devre dÄ±ÅŸÄ± bÄ±rakÄ±n, tarayÄ±cÄ± konsolundaki hatalarÄ± kontrol edin. Sorun sÃ¼rerse ekran gÃ¶rÃ¼ntÃ¼sÃ¼ ile destek talebi oluÅŸturun.") }}
</div>

<div class="rounded-2xl border border-slate-800 bg-gradient-to-r from-slate-900/60 to-slate-950/30 p-6 mt-8">
  <h2 class="text-xl font-semibold">Hala soru iÅŸaretleriniz mi var</h2>
  <p class="text-slate-300 mt-2">Destek ekibimiz size yardÄ±mcÄ± olmak iÃ§in hazÄ±r.</p>
  <div class="flex flex-wrap gap-3 mt-4">
    <a href="/support" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold">Destek Talebi OluÅŸtur</a>
    <a href="/contact" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold">Ä°letiÅŸim Formu</a>
  </div>
</div>

<footer class="mt-10 pt-6 border-t border-slate-800 text-sm text-slate-400 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
  <div class="flex gap-4">
    <a class="hover:text-white" href="/about">HakkÄ±mÄ±zda</a>
    <a class="hover:text-white" href="/support">Destek</a>
    <a class="hover:text-white" href="/faq">SSS</a>
    <a class="hover:text-white" href="/contact">Ä°letiÅŸim</a>
  </div>
  <div>Â© {{ year }} Atalay Ulusoy. TÃ¼m haklarÄ± saklÄ±dÄ±r.</div>
</footer>

</div>
</main>
</div>
</body>
</html>"""

SUPPORT_TEMPLATE = """<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Destek Merkezi - Atalay Ulusoy Kripto Ä°ÅŸlem Botu</title>
<meta name="description" content="Atalay Ulusoy kripto iÅŸlem botu iÃ§in destek alÄ±n. Hesap yÃ¶netimi, bot yapÄ±landÄ±rmasÄ±, borsa baÄŸlantÄ±sÄ± ve teknik sorunlar iÃ§in yardÄ±m.">
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<div class="flex min-h-screen">
{{ sidebar|safe }}
<main class="flex-1">
<div class="max-w-5xl mx-auto px-6 py-8">
<div class="flex items-center justify-between">
<a href="/login" class="text-slate-300 hover:text-white text-sm">â† Geri DÃ¶n</a>
<div class="text-xs text-slate-400">Size nasÄ±l yardÄ±mcÄ± olabiliriz</div>
</div>

<h1 class="text-3xl font-bold mt-6">Destek Merkezi</h1>

<div class="grid md:grid-cols-3 gap-4 mt-6">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-5"><div class="font-semibold">YanÄ±t SÃ¼resi</div><div class="text-slate-300 mt-2">Genellikle 24 saat iÃ§inde</div></div>
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-5"><div class="font-semibold">Telegram DesteÄŸi</div><div class="text-slate-300 mt-2">Acil durumlar iÃ§in Telegram Ã¼zerinden</div></div>
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-5"><div class="font-semibold">GÃ¼venli Ä°letiÅŸim</div><div class="text-slate-300 mt-2">Åifreli kanal</div></div>
</div>

<div class="grid md:grid-cols-3 gap-6 mt-8">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 md:col-span-1">
    <div class="font-semibold mb-3">Destek Kategorileri</div>
    <ul class="text-slate-300 space-y-2 text-sm">
      <li>Genel Sorular</li><li>Hesap YÃ¶netimi</li><li>Ä°ÅŸlem Botu</li><li>Borsa BaÄŸlantÄ±sÄ±</li><li>Ã–deme ve Abonelik</li><li>Teknik Sorun</li>
    </ul>
    <div class="mt-5 pt-5 border-t border-slate-800">
      <div class="font-semibold">HÄ±zlÄ± EriÅŸim</div>
      <div class="flex flex-col gap-2 mt-3">
        <a class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold" href="/faq">SÄ±k Sorulan Sorular</a>
        <a class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold" href="/contact">Ä°letiÅŸim</a>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 md:col-span-2">
    <h2 class="text-xl font-semibold">Destek Talebi OluÅŸtur</h2>
    <p class="text-slate-300 mt-2">Formu doldurun, en kÄ±sa sÃ¼rede size dÃ¶nÃ¼ÅŸ yapalÄ±m.</p>

    <form id="supportForm" class="mt-5 space-y-3">
      <div><label class="text-sm text-slate-300">AdÄ±nÄ±z SoyadÄ±nÄ±z</label>
        <input name="name" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 p-3 outline-none" placeholder="AdÄ±nÄ±z ve soyadÄ±nÄ±z" required></div>
      <div><label class="text-sm text-slate-300">E-posta Adresiniz</label>
        <input name="email" type="email" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 p-3 outline-none" placeholder="ornek@email.com" required></div>
      <div><label class="text-sm text-slate-300">Konu (Opsiyonel)</label>
        <input name="subject" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 p-3 outline-none" placeholder="Destek talebinizin konusu"></div>
      <div><label class="text-sm text-slate-300">MesajÄ±nÄ±z</label>
        <textarea name="message" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 p-3 outline-none min-h-[140px]" placeholder="Sorununuzu veya talebinizi detaylÄ± olarak aÃ§Ä±klayÄ±n..." required></textarea></div>
      <div class="text-xs text-slate-400">GÃ¶nderdiÄŸiniz bilgiler gÃ¼venli ÅŸekilde iletilir ve sadece destek ekibimiz tarafÄ±ndan gÃ¶rÃ¼ntÃ¼lenir.</div>
      <button id="supportSubmit" type="submit" class="px-5 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold">Destek Talebi GÃ¶nder</button>
      <div id="supportResult" class="text-sm mt-2"></div>
    </form>
  </div>
</div>

<script>
(function(){
  const f=document.getElementById('supportForm');
  const res=document.getElementById('supportResult');
  const btn=document.getElementById('supportSubmit');
  if(!f) return;
  f.addEventListener('submit', async (e)=>{
    e.preventDefault();
    res.textContent='';
    btn.disabled=true;
    const old=btn.textContent;
    btn.textContent='GÃ¶nderiliyor...';
    const payload=Object.fromEntries(new FormData(f).entries());
    try{
      const r=await fetch('/api/public/support',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json();
      if(j.ok){
        res.className='text-sm mt-2 text-emerald-400';
        res.textContent='MesajÄ±nÄ±z baÅŸarÄ±yla gÃ¶nderildi. En kÄ±sa sÃ¼rede size dÃ¶nÃ¼ÅŸ yapacaÄŸÄ±z.';
        f.reset();
      } else {
        res.className='text-sm mt-2 text-rose-400';
        res.textContent='Mesaj gÃ¶nderilirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
      }
    }catch(err){
      res.className='text-sm mt-2 text-rose-400';
      res.textContent='Mesaj gÃ¶nderilirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
    }finally{
      btn.disabled=false;
      btn.textContent=old;
    }
  });
})();
</script>

<footer class="mt-10 pt-6 border-t border-slate-800 text-sm text-slate-400 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
  <div class="flex gap-4">
    <a class="hover:text-white" href="/about">HakkÄ±mÄ±zda</a>
    <a class="hover:text-white" href="/support">Destek</a>
    <a class="hover:text-white" href="/faq">SSS</a>
    <a class="hover:text-white" href="/contact">Ä°letiÅŸim</a>
  </div>
  <div>Â© {{ year }} Atalay Ulusoy. TÃ¼m haklarÄ± saklÄ±dÄ±r.</div>
</footer>

</div>
</main>
</div>
</body>
</html>"""

CONTACT_TEMPLATE = """<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ä°letiÅŸim - Atalay Ulusoy Kripto Ä°ÅŸlem Botu</title>
<meta name="description" content="Atalay Ulusoy kripto iÅŸlem botu ile ilgili sorularÄ±nÄ±z, Ã¶nerileriniz veya iÅŸ birliÄŸi teklifleriniz iÃ§in bize ulaÅŸÄ±n.">
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<div class="flex min-h-screen">
{{ sidebar|safe }}
<main class="flex-1">
<div class="max-w-5xl mx-auto px-6 py-8">
<div class="flex items-center justify-between">
<a href="/login" class="text-slate-300 hover:text-white text-sm">â† Geri DÃ¶n</a>
<div class="text-xs text-slate-400">Bize ulaÅŸÄ±n, yardÄ±mcÄ± olmaktan mutluluk duyarÄ±z</div>
</div>

<h1 class="text-3xl font-bold mt-6">Ä°letiÅŸim</h1>

<div class="grid md:grid-cols-2 gap-6 mt-6">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6">
    <h2 class="text-xl font-semibold">Ä°letiÅŸim Bilgileri</h2>
    <div class="mt-4 space-y-3 text-slate-300">
      <div><span class="text-slate-400">E-posta</span><div class="font-semibold">support@atalayulusoy.com</div></div>
      <div><span class="text-slate-400">Ã‡alÄ±ÅŸma Saatleri</span><div class="font-semibold">Pazartesi - Cuma: 09:00 - 18:00</div><div class="text-slate-300">Hafta Sonu: KapalÄ±</div></div>
      <div><span class="text-slate-400">Konum</span><div class="font-semibold">Ä°stanbul, TÃ¼rkiye</div></div>
    </div>

    <div class="mt-6 pt-6 border-t border-slate-800">
      <h3 class="font-semibold">HÄ±zlÄ± EriÅŸim</h3>
      <div class="flex flex-col gap-2 mt-3">
        <a class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold" href="/support">Destek Merkezi</a>
        <a class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold" href="/faq">SÄ±k Sorulan Sorular</a>
        <a class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-semibold" href="/about">HakkÄ±mÄ±zda</a>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-5 mt-6">
      <div class="font-semibold">Telegram TopluluÄŸu</div>
      <div class="text-slate-300 mt-2">Telegram kanalÄ±mÄ±za katÄ±larak diÄŸer kullanÄ±cÄ±larla etkileÅŸime geÃ§in ve gÃ¼ncellemelerden haberdar olun.</div>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6">
    <h2 class="text-xl font-semibold">Bize Mesaj GÃ¶nderin</h2>
    <p class="text-slate-300 mt-2">SorularÄ±nÄ±z, Ã¶nerileriniz veya iÅŸ birliÄŸi teklifleriniz iÃ§in formu doldurun.</p>

    <form id="contactForm" class="mt-5 space-y-3">
      <div><label class="text-sm text-slate-300">AdÄ±nÄ±z SoyadÄ±nÄ±z</label>
        <input name="name" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 p-3 outline-none" placeholder="AdÄ±nÄ±z ve soyadÄ±nÄ±z" required></div>
      <div><label class="text-sm text-slate-300">E-posta Adresiniz</label>
        <input name="email" type="email" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 p-3 outline-none" placeholder="ornek@email.com" required></div>
      <div><label class="text-sm text-slate-300">Konu</label>
        <input name="subject" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 p-3 outline-none"></div>
      <div><label class="text-sm text-slate-300">MesajÄ±nÄ±z</label>
        <textarea name="message" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 p-3 outline-none min-h-[140px]" placeholder="MesajÄ±nÄ±zÄ± buraya yazÄ±n..." required></textarea></div>
      <div class="text-xs text-slate-400">GÃ¶nderdiÄŸiniz tÃ¼m bilgiler gÃ¼venli ÅŸekilde saklanÄ±r ve Ã¼Ã§Ã¼ncÃ¼ taraflarla paylaÅŸÄ±lmaz.</div>
      <button id="contactSubmit" type="submit" class="px-5 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold">Mesaj GÃ¶nder</button>
      <div id="contactResult" class="text-sm mt-2"></div>
    </form>
  </div>
</div>

<script>
(function(){
  const f=document.getElementById('contactForm');
  const res=document.getElementById('contactResult');
  const btn=document.getElementById('contactSubmit');
  if(!f) return;
  f.addEventListener('submit', async (e)=>{
    e.preventDefault();
    res.textContent='';
    btn.disabled=true;
    const old=btn.textContent;
    btn.textContent='GÃ¶nderiliyor...';
    const payload=Object.fromEntries(new FormData(f).entries());
    try{
      const r=await fetch('/api/public/contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json();
      if(j.ok){
        res.className='text-sm mt-2 text-emerald-400';
        res.textContent='MesajÄ±nÄ±z baÅŸarÄ±yla gÃ¶nderildi. En kÄ±sa sÃ¼rede size dÃ¶nÃ¼ÅŸ yapacaÄŸÄ±z.';
        f.reset();
      } else {
        res.className='text-sm mt-2 text-rose-400';
        res.textContent='Mesaj gÃ¶nderilirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
      }
    }catch(err){
      res.className='text-sm mt-2 text-rose-400';
      res.textContent='Mesaj gÃ¶nderilirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
    }finally{
      btn.disabled=false;
      btn.textContent=old;
    }
  });
})();
</script>

<footer class="mt-10 pt-6 border-t border-slate-800 text-sm text-slate-400 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
  <div class="flex gap-4">
    <a class="hover:text-white" href="/about">HakkÄ±mÄ±zda</a>
    <a class="hover:text-white" href="/support">Destek</a>
    <a class="hover:text-white" href="/faq">SSS</a>
    <a class="hover:text-white" href="/contact">Ä°letiÅŸim</a>
  </div>
  <div>Â© {{ year }} Atalay Ulusoy. TÃ¼m haklarÄ± saklÄ±dÄ±r.</div>
</footer>

</div>
</main>
</div>
</body>
</html>"""


AI_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ã–nerileri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f0f0f; color: white; font-family: system-ui, -apple-system, sans-serif; }
        .sidebar { position: fixed; left: 0; top: 0; height: 100%; width: 16rem; background: #1a1a1a; border-right: 1px solid rgba(255,255,255,0.1); z-index: 50; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; color: #9ca3af; transition: all 0.2s; }
        .sidebar-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar-link.active { background: #2563eb; color: white; }
        .main { margin-left: 16rem; padding: 2rem; }
    </style>
</head>
<body class="bg-[#0f0f0f] text-white">
    <!-- Sidebar (Same as dashboard) -->
    <div class="sidebar">
        <div class="p-4 border-b border-white/10">
            <a href="/dashboard" class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center"><span class="text-white text-lg font-bold">â‚¿</span></div>
                <span class="text-white font-semibold">AU Auto Trade</span>
            </a>
        </div>
        <nav class="p-2 space-y-1">
            <a href="/admin" class="sidebar-link text-red-400">âš™ï¸ Admin Panel</a>
            <a href="/dashboard" class="sidebar-link">ğŸ“Š Dashboard</a>
            <a href="/live-trading-chat" class="sidebar-link">ğŸ’¬ CanlÄ± Sohbet</a>
            <a href="/ai-trade-recommendations" class="sidebar-link active">ğŸ¤– AI Ã–nerileri</a>
            <a href="/arbitrage-monitor" class="sidebar-link">ğŸ“ˆ Arbitraj Takibi</a>
            <a href="/pnl-reporting-center" class="sidebar-link">ğŸ’° Kar/Zarar Raporu</a>
            <a href="/education" class="sidebar-link">ğŸ“ EÄŸitim Merkezi</a>
            <a href="/market-analysis" class="sidebar-link">ğŸ“‰ Market Analiz</a>
            <a href="/trade-history" class="sidebar-link">ğŸ“‹ Ä°ÅŸlem GeÃ§miÅŸi</a>
            <a href="/payment" class="sidebar-link">ğŸ’³ Ã–deme</a>
        </nav>
    </div>
    
    <div class="main">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold mb-2">ğŸ¤– AI Trade Recommendations</h1>
            <p class="text-gray-400 mb-8">Yapay zeka analizli alÄ±m/satÄ±m sinyalleri (Accuracy: 85%)</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                {% for signal in signals %}
                <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 hover:border-blue-500/50 transition-colors">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center text-2xl">
                                {% if 'BTC' in signal.coin %}ğŸŸ {% elif 'ETH' in signal.coin %}ğŸ”·{% else %}ğŸŸ£{% endif %}
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">{{ signal.coin }}</h3>
                                <span class="bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded">{{ signal.action }} SIGNAL</span>
                            </div>
                        </div>
                        <span class="text-gray-500 text-xs">Now</span>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">GÃ¼ven Skoru</span>
                            <span class="text-white font-bold">{{ signal.confidence }}%</span>
                        </div>
                        <div class="w-full bg-black/50 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: {{ signal.confidence }}%"></div>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Hedef Kar</span>
                            <span class="text-green-400 font-bold">{{ signal.target }}</span>
                        </div>
                    </div>
                    
                    <button onclick="window.location.href='/dashboard'" class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-medium transition-colors">
                        Ä°ÅŸlem AÃ§ ğŸš€
                    </button>
                </div>
                {% endfor %}
            </div>
            
            <!-- Past Performance -->
             <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6">
                <h2 class="text-lg font-bold mb-4">GeÃ§miÅŸ Performans</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-black/20 rounded-xl border-l-4 border-green-500">
                        <div>
                            <span class="font-bold">BTC/USDT</span>
                            <span class="text-gray-400 text-sm ml-2">DÃ¼n 14:30</span>
                        </div>
                        <span class="text-green-400 font-bold">+1.2% Kar âœ…</span>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-black/20 rounded-xl border-l-4 border-green-500">
                        <div>
                            <span class="font-bold">SOL/USDT</span>
                            <span class="text-gray-400 text-sm ml-2">DÃ¼n 09:15</span>
                        </div>
                        <span class="text-green-400 font-bold">+2.4% Kar âœ…</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
"""

FULL_DASHBOARD_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        body { background-color: #0f0f0f; color: white; font-family: system-ui, -apple-system, sans-serif; }
        .main { margin-left: 16rem; padding: 2rem; }
        @media (max-width: 900px) {
        .main { margin-left: 0; padding-top: 4rem; }
    }
    </style>
</head>
<body class="bg-[#0f0f0f] text-white">
    <!-- Dynamic Sidebar from get_sidebar_html -->
    {{ sidebar | safe }}
    
    <!-- Main Content -->
    <div class="main">
        <div class="max-w-7xl mx-auto">
            
            <!-- User Header -->
            {{ user_header | safe }}
            
            <!-- Dashboard Header with Mode Toggle -->
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-white">Trading Dashboard</h1>
                    <p class="text-gray-400 text-sm">Otomatik ve manuel iÅŸlem yÃ¶netimi</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-3 px-4 py-2 rounded-xl bg-[#1a1a1a] border border-white/10">
                         <!-- Green Dot & Balance (Unified) -->
                         <div id="unifiedWalletContainer" class="flex items-center gap-4">
                             <div class="flex items-center gap-2">
                                 <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></span>
                                 <span class="font-bold text-white text-sm" id="activeExchangeName">OKX</span>
                             </div>
                             <div class="h-4 w-px bg-white/10"></div>
                             <span class="text-white font-mono font-bold" id="unifiedBalanceDisplay">... USDT</span>
                         </div>
                    </div>
                </div>
                
                </div>
            </div>
            
            <!-- Real Mode Exchange Balances - Hidden by default -->
            <div id="realExchangeBalances" class="hidden mb-6 bg-[#1a1a1a] rounded-xl border border-green-500/30 p-4">
                <h3 class="text-sm font-semibold text-green-400 mb-3">ğŸ’° BaÄŸlÄ± Borsa Bakiyeleri (REAL MOD)</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="exchangeBalancesList">
                    <div class="bg-black/30 rounded-lg p-3 hidden" id="bal-okx">
                        <span class="text-xs text-gray-400">OKX</span>
                        <p class="text-lg font-bold text-white" id="bal-okx-amount">$0.00</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3 hidden" id="bal-binance">
                        <span class="text-xs text-gray-400">Binance</span>
                        <p class="text-lg font-bold text-white" id="bal-binance-amount">$0.00</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3 hidden" id="bal-bybit">
                        <span class="text-xs text-gray-400">Bybit</span>
                        <p class="text-lg font-bold text-white" id="bal-bybit-amount">$0.00</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3 hidden" id="bal-gate">
                        <span class="text-xs text-gray-400">Gate.io</span>
                        <p class="text-lg font-bold text-white" id="bal-gate-amount">$0.00</p>
                    </div>
                </div>
            </div>
            
            <!-- Exchange Status - shown in DEMO mode -->
            <div id="exchangeStatusRow" class="flex flex-wrap items-center gap-4 text-xs text-gray-400 mb-6 bg-[#1a1a1a] rounded-lg p-3 border border-white/5">
                <span>Borsa BaÄŸlantÄ±larÄ±:</span>
                <span id="exchange-okx" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> OKX</span>
                <span id="exchange-binance" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Binance</span>
                <span id="exchange-bybit" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> ByBit</span>
                <span id="exchange-gateio" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> GateIO</span>
            </div>
            
            <!-- Stats Summary - Analytics Widgets -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4 cursor-pointer hover:border-blue-500/30 transition-colors" onclick="loadAnalyticsDetail('trades')">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg">ğŸ“Š</span>
                        <p class="text-gray-400 text-xs">Toplam Ä°ÅŸlem</p>
                    </div>
                    <p class="text-2xl font-bold text-white" id="totalTrades">0</p>
                    <p class="text-xs text-gray-500 mt-1" id="todayTradesLabel">BugÃ¼n: 0</p>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4 cursor-pointer hover:border-green-500/30 transition-colors" onclick="loadAnalyticsDetail('volume')">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg">ğŸ’°</span>
                        <p class="text-gray-400 text-xs">Toplam Hacim</p>
                    </div>
                    <p class="text-2xl font-bold text-green-400" id="totalVolume">$0</p>
                    <p class="text-xs text-gray-500 mt-1" id="avgTradeLabel">Ort: $0</p>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4 cursor-pointer hover:border-yellow-500/30 transition-colors" onclick="loadAnalyticsDetail('active')">
                    <div class="flex items-center gap-2 mb-2">
                        <p class="text-gray-400 text-xs">Aktif Pozisyon</p>
                    </div>
                    <p class="text-2xl font-bold text-yellow-400" id="activePositions">0</p>
                    <p class="text-xs text-gray-500 mt-1" id="activeValueLabel">DeÄŸer: $0</p>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4 cursor-pointer hover:border-orange-500/30 transition-colors" onclick="loadAnalyticsDetail('pending')">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg">â³</span>
                        <p class="text-gray-400 text-xs">Bekleyen Ä°ÅŸlem</p>
                    </div>
                    <p class="text-2xl font-bold text-orange-400" id="pendingTrades">0</p>
                    <p class="text-xs text-gray-500 mt-1" id="closedTradesLabel">KapatÄ±lan: 0</p>
                </div>
            </div>
            
            <!-- Trading Panels -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                
                <!-- Auto Ä°ÅŸlem AÃ§ -->
                <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6">
                    
                    <!-- Borsa SeÃ§imi (Real Modda GÃ¶rÃ¼nÃ¼r) -->
                    <div id="autoExchangeSelect" class="hidden mb-4">
                        <label class="text-gray-400 text-sm mb-2 block">Ä°ÅŸlem YapÄ±lacak Borsa</label>
                        <select id="autoExchange" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                            <option value="okx">OKX</option>
                            <option value="binance">Binance</option>
                            <option value="bybit">Bybit</option>
                            <option value="gate">Gate.io</option>
                        </select>
                    </div>
                    
                    <div class="mb-4 relative">
                        <label class="text-gray-400 text-sm mb-2 block">Coin SeÃ§imi (Ara veya SeÃ§)</label>
                        <input type="text" id="autoCoinSearch" placeholder="BTC, ETH, SOL..." 
                               class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white"
                               oninput="filterAutoCoins(this.value)" onfocus="showAutoCoinDropdown()" list="coinDatalist">
<datalist id="coinDatalist">
{% for c in coins %}<option value="{{ c }}"></option>{% endfor %}
</datalist>

                        <div id="autoCoinDropdown" class="hidden absolute z-50 w-full mt-1 bg-[#2a2a2a] border border-white/10 rounded-xl max-h-48 overflow-y-auto">
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('BTC/USDT', 'ğŸŸ ')">ğŸŸ  BTC/USDT - Bitcoin</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('ETH/USDT', 'ğŸ”·')">ğŸ”· ETH/USDT - Ethereum</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('SOL/USDT', 'ğŸŸ£')">ğŸŸ£ SOL/USDT - Solana</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('XRP/USDT', 'âšª')">âšª XRP/USDT - Ripple</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('BNB/USDT', 'ğŸŸ¡')">ğŸŸ¡ BNB/USDT - BNB</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('DOGE/USDT', 'ğŸ•')">ğŸ• DOGE/USDT - Dogecoin</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('ADA/USDT', 'ğŸ”µ')">ğŸ”µ ADA/USDT - Cardano</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('AVAX/USDT', 'ğŸ”º')">ğŸ”º AVAX/USDT - Avalanche</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('DOT/USDT', 'âš«')">âš« DOT/USDT - Polkadot</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectAutoCoin('MATIC/USDT', 'ğŸ’œ')">ğŸ’œ MATIC/USDT - Polygon</div>
                        </div>
                        <input type="hidden" id="autoCoinSelect" value="BTC/USDT">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-gray-400 text-sm mb-2 block">Ä°ÅŸlem MiktarÄ± (USDT)</label>
                            <input type="number" id="autoAmount" value="10" min="1" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm mb-2 block">Ã‡Ä±kÄ±ÅŸ Hedefi</label>
                            <select id="autoExitTarget" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white cursor-pointer">
                                <option value="0.40">+%0.40</option>
                                <option value="0.55" selected>+%0.55</option>
                                <option value="0.75">+%0.75</option>
                                <option value="1.00">+%1.00</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-4 mb-4">
                        <p class="text-yellow-200 text-sm">âš ï¸ <strong>Bekleyen Ä°ÅŸlem:</strong> Coin listesine eklenir, TradingView sinyali gelince AI analiz yapÄ±p alÄ±m/satÄ±m kararÄ± verir.</p>
                    </div>
                    
                    <button onclick="addAutoTrade()" class="w-full bg-green-600 hover:bg-green-500 text-white font-medium py-3 rounded-xl transition-colors cursor-pointer">
                        â• Bekleyen Ä°ÅŸlemlere Ekle
                    </button>
                </div>
                
                <!-- Manuel Ä°ÅŸlem AÃ§ -->
                <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6">
                    <h2 class="text-lg font-bold text-white mb-4">âœ‹ Manuel Ä°ÅŸlem AÃ§</h2>
                    
                    <!-- Borsa SeÃ§imi (Real Modda GÃ¶rÃ¼nÃ¼r) -->
                    <div id="manualExchangeSelect" class="hidden mb-4">
                        <label class="text-gray-400 text-sm mb-2 block">Ä°ÅŸlem YapÄ±lacak Borsa</label>
                        <select id="manualExchange" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                            <option value="okx">OKX</option>
                            <option value="binance">Binance</option>
                            <option value="bybit">Bybit</option>
                            <option value="gate">Gate.io</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-gray-400 text-sm mb-2 block">Ä°ÅŸlem Tipi</label>
                        <div class="flex gap-2">
                            <button onclick="setTradeType('buy')" id="buyTypeBtn" class="flex-1 py-3 rounded-xl font-medium cursor-pointer bg-green-600 text-white">AL (BUY)</button>
                            <button onclick="setTradeType('sell')" id="sellTypeBtn" class="flex-1 py-3 rounded-xl font-medium cursor-pointer bg-[#2a2a2a] text-gray-400">SAT (SELL)</button>
                        </div>
                    </div>
                    
                    <div class="mb-4 relative">
                        <label class="text-gray-400 text-sm mb-2 block">Coin SeÃ§imi (Ara veya SeÃ§)</label>
                        <input type="text" id="manualCoinSearch" placeholder="BTC, ETH, SOL..." 
                               class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white"
                               oninput="filterManualCoins(this.value)" onfocus="showManualCoinDropdown()" list="coinDatalist">
                        <div id="manualCoinDropdown" class="hidden absolute z-50 w-full mt-1 bg-[#2a2a2a] border border-white/10 rounded-xl max-h-48 overflow-y-auto">
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('BTC/USDT', 'ğŸŸ ')">ğŸŸ  BTC/USDT - Bitcoin</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('ETH/USDT', 'ğŸ”·')">ğŸ”· ETH/USDT - Ethereum</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('SOL/USDT', 'ğŸŸ£')">ğŸŸ£ SOL/USDT - Solana</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('XRP/USDT', 'âšª')">âšª XRP/USDT - Ripple</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('BNB/USDT', 'ğŸŸ¡')">ğŸŸ¡ BNB/USDT - BNB</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('DOGE/USDT', 'ğŸ•')">ğŸ• DOGE/USDT - Dogecoin</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('ADA/USDT', 'ğŸ”µ')">ğŸ”µ ADA/USDT - Cardano</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('AVAX/USDT', 'ğŸ”º')">ğŸ”º AVAX/USDT - Avalanche</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('DOT/USDT', 'âš«')">âš« DOT/USDT - Polkadot</div>
                            <div class="coin-option p-3 hover:bg-white/10 cursor-pointer" onclick="selectManualCoin('MATIC/USDT', 'ğŸ’œ')">ğŸ’œ MATIC/USDT - Polygon</div>
                        </div>
                        <input type="hidden" id="manualCoinSelect" value="BTC/USDT">
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-gray-400 text-sm mb-2 block">Miktar (USDT)</label>
                        <div class="flex gap-2 mb-2 flex-wrap">
                            <button onclick="document.getElementById('manualAmount').value=1" class="px-3 py-2 rounded-lg bg-[#2a2a2a] text-gray-300 text-sm cursor-pointer hover:bg-gray-600">1</button>
                            <button onclick="document.getElementById('manualAmount').value=25" class="px-3 py-2 rounded-lg bg-[#2a2a2a] text-gray-300 text-sm cursor-pointer hover:bg-gray-600">25</button>
                            <button onclick="document.getElementById('manualAmount').value=50" class="px-3 py-2 rounded-lg bg-[#2a2a2a] text-gray-300 text-sm cursor-pointer hover:bg-gray-600">50</button>
                            <button onclick="document.getElementById('manualAmount').value=100" class="px-3 py-2 rounded-lg bg-[#2a2a2a] text-gray-300 text-sm cursor-pointer hover:bg-gray-600"> 100</button>
                            <button onclick="document.getElementById('manualAmount').value=500" class="px-3 py-2 rounded-lg bg-[#2a2a2a] text-gray-300 text-sm cursor-pointer hover:bg-gray-600">500</button>
                            <button onclick="setAllBalance('manualAmount')" class="px-3 py-2 rounded-lg bg-purple-600 hover:bg-purple-500 text-white text-sm cursor-pointer font-medium">ğŸ’° TÃ¼m Bakiye</button>
                        </div>
                        <input type="number" id="manualAmount" value="1" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                    </div>
                    
                    <button onclick="executeManualTrade()" id="manualTradeBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 rounded-xl transition-colors cursor-pointer">
                        ğŸš€ Aktif Coinlere Ekle - AL BTC/USDT
                    </button>
                </div>
            </div>
            <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 mb-6">
                <h2 class="text-lg font-bold text-white mb-4">â³ Bekleyen Auto Ä°ÅŸlemlerim</h2>
                <p class="text-gray-500 text-sm mb-4">TradingView sinyali bekleyen coinler. Sinyal gelince AI analiz yapÄ±p iÅŸlem aÃ§ar.</p>
                <div id="autoTradesContainer" class="min-h-[80px]">
                    <div class="text-center py-6 text-gray-500">
                        <div class="text-3xl mb-2">â³</div>
                        <p class="text-sm">HenÃ¼z bekleyen auto iÅŸleminiz yok.</p>
                    </div>
                </div>
            </div>
            
            <!-- Aktif Coinler (Manuel Ä°ÅŸlemler) -->
            <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 mb-6">
                <h2 class="text-lg font-bold text-white mb-4">ğŸ“Š Aktif Coinler</h2>
                <p class="text-gray-500 text-sm mb-4">Manuel aÃ§Ä±lan iÅŸlemler ve pozisyonlar.</p>
                <div id="positionsContainer" class="min-h-[80px]">
                    <div class="text-center py-6 text-gray-500">
                        <div class="text-3xl mb-2">ğŸ“­</div>
                        <p class="text-sm">AÃ§Ä±k pozisyon bulunmuyor</p>
                    </div>
                </div>
            </div>
            
            <!-- Grafik ve Coin Listesi -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6">
                    <h2 class="text-lg font-bold text-white mb-4">ğŸ“ˆ Grafik Analizi</h2>
                    <div class="bg-black/30 rounded-lg h-[550px] overflow-hidden border border-white/10">
                        <div id="dashboard_tv_chart" style="height:100%; width:100%">
                            <div class="flex items-center justify-center h-full text-gray-500">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">ğŸ“Š</div>
                                    <p>TradingView Grafik</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6">
                    <h3 class="text-lg font-bold text-white mb-4">ğŸ“‹ Coin Listesi</h3>
                    <input type="text" id="coinSearchInput" onkeyup="filterCoinList(this.value)" class="w-full bg-[#2a2a2a] border border-white/10 rounded-lg px-3 py-2 text-white text-sm mb-3" placeholder="ğŸ” Coin ara...">
                    <div class="flex gap-2 mb-4" id="coinSortButtons">
                        <button onclick="sortCoinList('volume')" id="sortVolume" class="flex-1 bg-blue-600 text-white rounded-lg py-2 text-sm cursor-pointer hover:bg-blue-500">Hacim</button>
                        <button onclick="sortCoinList('change')" id="sortChange" class="flex-1 bg-transparent border border-white/10 text-gray-400 rounded-lg py-2 text-sm cursor-pointer hover:bg-white/10">DeÄŸiÅŸim</button>
                        <button onclick="sortCoinList('price')" id="sortPrice" class="flex-1 bg-transparent border border-white/10 text-gray-400 rounded-lg py-2 text-sm cursor-pointer hover:bg-white/10">Fiyat</button>
                    </div>
                    <div id="coinListContainer" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center py-4 text-gray-500">
                            <div class="text-2xl mb-2">ğŸ”„</div>
                            <p class="text-sm">Fiyatlar yÃ¼kleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Styled Popup Modal -->
    <div id="popupModal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closePopup()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#1a1a1a] rounded-2xl border border-white/10 p-6 w-full max-w-md shadow-2xl">
            <div id="popupIcon" class="text-4xl text-center mb-4">â„¹ï¸</div>
            <h3 id="popupTitle" class="text-xl font-bold text-white text-center mb-2">Bilgi</h3>
            <p id="popupMessage" class="text-gray-400 text-center mb-6">Mesaj iÃ§eriÄŸi</p>
            <div id="popupInputContainer" class="hidden mb-4">
                <input type="number" id="popupInput" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white text-center text-lg" placeholder="Miktar girin">
            </div>
            <div id="popupButtons" class="flex gap-3">
                <button id="popupConfirmBtn" onclick="confirmPopupAction()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 rounded-xl cursor-pointer transition-colors">Tamam</button>
                <button id="popupCancelBtn" onclick="closePopup()" class="hidden flex-1 bg-[#2a2a2a] hover:bg-gray-700 text-gray-300 font-medium py-3 rounded-xl cursor-pointer transition-colors">Ä°ptal</button>
            </div>
        </div>
    </div>
    
    <script>
    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        if (!sb) return;
        sb.classList.toggle('open');
    }
    
    // Notification function
function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existing = document.querySelectorAll('.notification-toast');
        existing.forEach(n => n.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'notification-toast fixed top-4 right-4 z-[9999] px-6 py-4 rounded-xl shadow-2xl text-white font-medium transition-all transform translate-x-0';
        
        // Set color based on type
        const colors = {
            success: 'bg-green-600',
            error: 'bg-red-600',
            warning: 'bg-yellow-600',
            info: 'bg-blue-600'
        };
        notification.classList.add(colors[type] || colors.info);
        notification.textContent = message;
        
        // Add to DOM
        document.body.appendChild(notification);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    // Popup Modal Functions
    let popupCallback = null;
    let popupHasInput = false;
    let pendingAutoCoins = []; // Track pending auto trade coins to prevent duplicates
    
    function showPopup(options) {
        const modal = document.getElementById('popupModal');
        const icon = document.getElementById('popupIcon');
        const title = document.getElementById('popupTitle');
        const message = document.getElementById('popupMessage');
        const inputContainer = document.getElementById('popupInputContainer');
        const input = document.getElementById('popupInput');
        const confirmBtn = document.getElementById('popupConfirmBtn');
        const cancelBtn = document.getElementById('popupCancelBtn');
        
        icon.textContent = options.icon || 'â„¹ï¸';
        title.textContent = options.title || 'Bilgi';
        message.textContent = options.message || '';
        
        // Handle input
        popupHasInput = options.showInput || false;
        if (popupHasInput) {
            inputContainer.classList.remove('hidden');
            input.value = options.inputValue || '';
            input.placeholder = options.inputPlaceholder || 'Miktar girin';
        } else {
            inputContainer.classList.add('hidden');
        }
        
        // Handle buttons
        if (options.showCancel) {
            cancelBtn.classList.remove('hidden');
            confirmBtn.textContent = options.confirmText || 'Onayla';
            confirmBtn.className = confirmBtn.className.replace(/bg-\\w+-600/, options.confirmClass || 'bg-blue-600');
        } else {
            cancelBtn.classList.add('hidden');
            confirmBtn.textContent = options.confirmText || 'Tamam';
        }
        
        // Set button color based on type
        if (options.type === 'error') {
            confirmBtn.className = confirmBtn.className.replace(/bg-blue-600|bg-green-600|bg-red-600/, 'bg-red-600');
        } else if (options.type === 'success') {
            confirmBtn.className = confirmBtn.className.replace(/bg-blue-600|bg-green-600|bg-red-600/, 'bg-green-600');
        } else if (options.type === 'warning') {
            confirmBtn.className = confirmBtn.className.replace(/bg-blue-600|bg-green-600|bg-red-600/, 'bg-yellow-600');
        } else {
            confirmBtn.className = confirmBtn.className.replace(/bg-blue-600|bg-green-600|bg-red-600|bg-yellow-600/, 'bg-blue-600');
        }
        
        popupCallback = options.onConfirm || null;
        modal.classList.remove('hidden');
    }
    
    function closePopup() {
        document.getElementById('popupModal').classList.add('hidden');
        popupCallback = null;
    }
    
    function confirmPopupAction() {
        if (popupCallback) {
            const inputValue = popupHasInput ? document.getElementById('popupInput').value : null;
            popupCallback(inputValue);
        }
        closePopup();
    }
    
    // Coin list sorting
    let currentSort = 'volume';
    function sortCoinList(sortBy) {
        currentSort = sortBy;
        const buttons = ['sortVolume', 'sortChange', 'sortPrice'];
        buttons.forEach(id => {
            const btn = document.getElementById(id);
            if (id === 'sort' + sortBy.charAt(0).toUpperCase() + sortBy.slice(1)) {
                btn.className = 'flex-1 bg-blue-600 text-white rounded-lg py-2 text-sm cursor-pointer hover:bg-blue-500';
            } else {
                btn.className = 'flex-1 bg-transparent border border-white/10 text-gray-400 rounded-lg py-2 text-sm cursor-pointer hover:bg-white/10';
            }
        });
        showNotification('SÄ±ralama: ' + (sortBy === 'volume' ? 'Hacim' : sortBy === 'change' ? 'DeÄŸiÅŸim' : 'Fiyat'), 'info');
    }
    
    let currentMode = 'demo';
    let tradeType = 'buy';
    let selectedAutoCoin = 'BTC/USDT';
    let selectedManualCoin = 'BTC/USDT';
    
    // Helper function to set all balance
    async function setAllBalance(inputId) {
        try {
            const res = await fetch('/api/real/balance', { credentials: 'include' });
            const data = await res.json();
            if (data.balance) {
                document.getElementById(inputId).value = parseFloat(data.balance).toFixed(2);
            }
        } catch (e) {
            console.error('Balance fetch error:', e);
        }
    }
    
    // Coin list for search
    const coinList = [
        {% for c in coins %}{symbol: '{{ c }}', name: '{{ c }}', icon: 'ğŸª™'},
        {% endfor %}
    ];
    
    // Auto coin dropdown functions
    function showAutoCoinDropdown() {
        document.getElementById('autoCoinDropdown').classList.remove('hidden');
        filterAutoCoins('');
    }
    
    function hideAutoCoinDropdown() {
        setTimeout(() => document.getElementById('autoCoinDropdown').classList.add('hidden'), 200);
    }
    
    function filterAutoCoins(query) {
        const dropdown = document.getElementById('autoCoinDropdown');
        const filtered = coinList.filter(c => 
            c.symbol.toLowerCase().includes(query.toLowerCase()) || 
            c.name.toLowerCase().includes(query.toLowerCase())
        );
        dropdown.innerHTML = filtered.map(c => 
            `<div class="coin-option p-3 hover:bg-white/10 cursor-pointer text-white" onmousedown="selectAutoCoin('${c.symbol}', '${c.icon}')">${c.icon} ${c.symbol} - ${c.name}</div>`
        ).join('');
        dropdown.classList.remove('hidden');
    }
    
    function selectAutoCoin(symbol, icon) {
        selectedAutoCoin = symbol;
        document.getElementById('autoCoinSelect').value = symbol;
        document.getElementById('autoCoinSearch').value = icon + ' ' + symbol;
        document.getElementById('autoCoinDropdown').classList.add('hidden');
    }
    
    // Manual coin dropdown functions
    function showManualCoinDropdown() {
        document.getElementById('manualCoinDropdown').classList.remove('hidden');
        filterManualCoins('');
    }
    
    function hideManualCoinDropdown() {
        setTimeout(() => document.getElementById('manualCoinDropdown').classList.add('hidden'), 200);
    }
    
    function filterManualCoins(query) {
        const dropdown = document.getElementById('manualCoinDropdown');
        const filtered = coinList.filter(c => 
            c.symbol.toLowerCase().includes(query.toLowerCase()) || 
            c.name.toLowerCase().includes(query.toLowerCase())
        );
        dropdown.innerHTML = filtered.map(c => 
            `<div class="coin-option p-3 hover:bg-white/10 cursor-pointer text-white" onmousedown="selectManualCoin('${c.symbol}', '${c.icon}')">${c.icon} ${c.symbol} - ${c.name}</div>`
        ).join('');
        dropdown.classList.remove('hidden');
    }
    
    function selectManualCoin(symbol, icon) {
        selectedManualCoin = symbol;
        document.getElementById('manualCoinSelect').value = symbol;
        document.getElementById('manualCoinSearch').value = icon + ' ' + symbol;
        document.getElementById('manualCoinDropdown').classList.add('hidden');
        updateManualTradeButton();
    }
    
    function updateManualTradeButton() {
        const btn = document.getElementById('manualTradeBtn');
        const action = tradeType === 'buy' ? 'AL' : 'SAT';
        btn.textContent = 'ğŸš€ Aktif Coinlere Ekle - ' + action + ' ' + selectedManualCoin;
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#autoCoinSearch') && !e.target.closest('#autoCoinDropdown')) {
            document.getElementById('autoCoinDropdown').classList.add('hidden');
        }
        if (!e.target.closest('#manualCoinSearch') && !e.target.closest('#manualCoinDropdown')) {
            document.getElementById('manualCoinDropdown').classList.add('hidden');
        }
    });
    

    
    function setMode(mode) {
        currentMode = mode;
        window._currentTradeMode = mode;  // Global variable for loadPositions
        const demoBtn = document.getElementById('demoBtn');
        const realBtn = document.getElementById('realBtn');
        const modeLabel = document.getElementById('modeLabel');
        const realBalancesDiv = document.getElementById('realExchangeBalances');
        const exchangeStatusRow = document.getElementById('exchangeStatusRow');
        const autoExchangeSelect = document.getElementById('autoExchangeSelect');
        const manualExchangeSelect = document.getElementById('manualExchangeSelect');

        if (mode === 'demo') {
            demoBtn.classList.add('bg-blue-600', 'text-white');
            demoBtn.classList.remove('bg-[#2a2a2a]', 'text-gray-400');
            realBtn.classList.remove('bg-green-600', 'text-white');
            realBtn.classList.add('bg-[#2a2a2a]', 'text-gray-400');
            modeLabel.textContent = 'DEMO';
            modeLabel.className = 'px-3 py-1 rounded-lg text-xs bg-blue-500/20 text-blue-400 ml-2';
            
            // Hide real balances, show exchange status
            if (realBalancesDiv) realBalancesDiv.classList.add('hidden');
            if (exchangeStatusRow) exchangeStatusRow.classList.remove('hidden');
            if (autoExchangeSelect) autoExchangeSelect.classList.add('hidden');
            if (manualExchangeSelect) manualExchangeSelect.classList.add('hidden');
        } else {
            realBtn.classList.add('bg-green-600', 'text-white');
            realBtn.classList.remove('bg-[#2a2a2a]', 'text-gray-400');
            demoBtn.classList.remove('bg-blue-600', 'text-white');
            demoBtn.classList.add('bg-[#2a2a2a]', 'text-gray-400');
            modeLabel.textContent = 'REAL';
            modeLabel.className = 'px-3 py-1 rounded-lg text-xs bg-green-500/20 text-green-400 ml-2';
            
            // Show real balances and exchange selects, hide status row
            if (realBalancesDiv) realBalancesDiv.classList.remove('hidden');
            if (exchangeStatusRow) exchangeStatusRow.classList.add('hidden');
            if (autoExchangeSelect) autoExchangeSelect.classList.remove('hidden');
            if (manualExchangeSelect) manualExchangeSelect.classList.remove('hidden');
            
            // Fetch and display connected exchange balances
            fetchExchangeBalances();
        }

        // Backend'e bildir (UI refresh + doÄŸru bakiye)
        fetch('/api/mode/switch', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode })
        })
        .then(r => r.json())
        .then(d => {
            if (d && d.ok) {
                if (typeof d.balance === 'number') {
                    document.getElementById('balanceDisplay').textContent = d.balance.toFixed(2) + ' USDT';
                }
                showNotification('Hesap modu gÃ¼ncellendi: ' + mode.toUpperCase(), 'success');
                // Reload data for new mode
                loadPositions();
                loadAutoTrades();
            } else {
                showNotification(d.error || 'Mod deÄŸiÅŸtirilemedi', 'error');
            }
        })
        .catch(() => {
            showNotification('Hesap modu gÃ¼ncellenemedi', 'error');
        });
    }
    
    // Fetch exchange balances for real mode
    async function fetchExchangeBalances() {
        try {
            const res = await fetch('/api/exchange/list', {credentials: 'include'});
            const data = await res.json();
            if (data.success && data.configs) {
                const exchanges = ['okx', 'binance', 'bybit', 'gate'];
                let totalBalance = 0;
                
                exchanges.forEach(ex => {
                    const cfg = data.configs[ex];
                    const balDiv = document.getElementById('bal-' + ex);
                    const balAmount = document.getElementById('bal-' + ex + '-amount');
                    
                    if (cfg && cfg.connected) {
                        if (balDiv) balDiv.classList.remove('hidden');
                        // Fetch actual balance from exchange
                        fetch('/api/exchange/balance?exchange=' + ex, {credentials: 'include'})
                            .then(r => r.json())
                            .then(b => {
                                if (b.ok && balAmount) {
                                    balAmount.textContent = '$' + (b.balance || 0).toFixed(2);
                                    totalBalance += (b.balance || 0);
                                }
                            });
                    } else {
                        if (balDiv) balDiv.classList.add('hidden');
                    }
                });
            }
        } catch(e) {
            console.error('Exchange balance fetch error:', e);
        }
    }
    
    function setTradeType(type) {
        tradeType = type;
        const buyBtn = document.getElementById('buyTypeBtn');
        const sellBtn = document.getElementById('sellTypeBtn');
        
        if (type === 'buy') {
            buyBtn.className = 'flex-1 py-3 rounded-xl font-medium cursor-pointer bg-green-600 text-white';
            sellBtn.className = 'flex-1 py-3 rounded-xl font-medium cursor-pointer bg-[#2a2a2a] text-gray-400';
        } else {
            buyBtn.className = 'flex-1 py-3 rounded-xl font-medium cursor-pointer bg-[#2a2a2a] text-gray-400';
            sellBtn.className = 'flex-1 py-3 rounded-xl font-medium cursor-pointer bg-red-600 text-white';
        }
        updateManualTradeButton();
    }
    
    async function addAutoTrade() {
        const coin = selectedAutoCoin;
        const amount = parseFloat(document.getElementById('autoAmount').value);
        const exitTarget = document.getElementById('autoExitTarget').value;
        
        if (!amount || amount < 1) {
            showPopup({
                icon: 'âŒ',
                title: 'Hata',
                message: 'Minimum iÅŸlem tutarÄ± 1 USDT',
                type: 'error'
            });
            return;
        }
        
        // Check for duplicate coin
        if (pendingAutoCoins.includes(coin)) {
            showPopup({
                icon: 'âš ï¸',
                title: 'Coin Zaten Ekli',
                message: coin + ' zaten bekleyen iÅŸlemler listesinde. AynÄ± coini iki kere ekleyemezsiniz.',
                type: 'warning'
            });
            return;
        }
        
        try {
            const res = await fetch('/api/auto/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({coin: coin, amount_usdt: amount, mode: currentMode, exit_target: exitTarget})
            });
            const data = await res.json();
            if (data.ok) {
                pendingAutoCoins.push(coin);
                loadAutoTrades();
                showPopup({
                    icon: 'âœ…',
                    title: 'BaÅŸarÄ±lÄ±',
                    message: 'Bekleyen auto iÅŸlemlere eklendi: ' + coin + ' ($' + amount + ') - Ã‡Ä±kÄ±ÅŸ: %' + (parseFloat(exitTarget) * 100).toFixed(2),
                    type: 'success'
                });
            } else {
                showPopup({
                    icon: 'âŒ',
                    title: 'Hata',
                    message: data.error || 'Bilinmeyen hata',
                    type: 'error'
                });
            }
        } catch (e) {
            console.error(e);
            showPopup({
                icon: 'âŒ',
                title: 'BaÄŸlantÄ± HatasÄ±',
                message: 'Sunucuya baÄŸlanÄ±lamadÄ±',
                type: 'error'
            });
        }
    }
    
    async function executeManualTrade() {
        const coin = selectedManualCoin;
        const amount = parseFloat(document.getElementById('manualAmount').value);
        
        if (!amount || amount < 1) {
            showPopup({
                icon: 'âŒ',
                title: 'Hata',
                message: 'Minimum iÅŸlem tutarÄ± 1 USDT',
                type: 'error'
            });
            return;
        }
        
        try {
            const res = await fetch('/api/trade/execute', { credentials: "include", method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({coin: coin, amount_usdt: amount, side: tradeType.toUpperCase(), mode: currentMode})
            });
            const data = await res.json();
            if (data.ok) {
                loadPositions();
                showPopup({
                    icon: 'âœ…',
                    title: 'Ä°ÅŸlem BaÅŸarÄ±lÄ±',
                    message: 'Aktif Coinlere eklendi: ' + tradeType.toUpperCase() + ' ' + coin + ' - $' + amount,
                    type: 'success'
                });
            } else {
                showPopup({
                    icon: 'âŒ',
                    title: 'Hata',
                    message: data.error || 'Bilinmeyen hata',
                    type: 'error'
                });
            }
        } catch (e) {
            console.error(e);
            showPopup({
                icon: 'âŒ',
                title: 'BaÄŸlantÄ± HatasÄ±',
                message: 'Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen tekrar deneyin.',
                type: 'error'
            });
        }
    }
    
    async function loadAutoTrades() {
        try {
            // Send current mode to API
            const res = await fetch('/api/auto/list?mode=' + currentMode, { credentials: 'include' });
            const data = await res.json();
            const container = document.getElementById('autoTradesContainer');
            
            const pendingEl = document.getElementById('pendingTrades');
            if (pendingEl) pendingEl.textContent = (data.trades || []).length;
            
            // Sync pendingAutoCoins for duplicate prevention
            pendingAutoCoins = (data.trades || []).map(t => t.coin);
            
            if (!data.trades || data.trades.length === 0) {
                pendingAutoCoins = [];
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">âœ¨</div><p>HenÃ¼z bekleyen auto iÅŸleminiz yok.</p></div>';
                return;
            }
            
            let html = '<div class="space-y-3">';
            data.trades.forEach(t => {
                const icon = t.coin.includes('BTC') ? 'ğŸŸ ' : t.coin.includes('ETH') ? 'ğŸ”·' : 'ğŸŸ£';
                const isOpen = t.status === 'open';
                const isWaiting = t.status === 'waiting';
                const isPaused = t.status === 'paused';
                const isClosed = t.status === 'closed';
                
                // Status badge config
                let statusClass, statusText;
                if (isOpen) {
                    statusClass = 'bg-green-500/20 text-green-400';
                    statusText = 'ğŸ”„ Ä°ÅŸlemde';
                } else if (isWaiting) {
                    statusClass = 'bg-yellow-500/20 text-yellow-400';
                    statusText = 'â³ Sinyal Bekliyor';
                } else if (isClosed) {
                    statusClass = 'bg-purple-500/20 text-purple-400';
                    statusText = 'âœ… TamamlandÄ±';
                } else {
                    statusClass = 'bg-gray-500/20 text-gray-400';
                    statusText = 'â¸ï¸ DuraklatÄ±ldÄ±';
                }
                
                const targetPct = t.target_pct ? `Hedef: %${(t.target_pct * 100).toFixed(1)}` : '';
                const modeLabel = currentMode === 'real' ? '<span class="text-xs text-green-400 ml-2">REAL</span>' : '<span class="text-xs text-blue-400 ml-2"></span>';
                
                // All buttons always enabled - user can edit/delete anytime
                const toggleClass = 'cursor-pointer hover:bg-yellow-500/30';
                const editClass = 'cursor-pointer hover:bg-blue-500/30';
                const deleteClass = 'cursor-pointer hover:bg-red-500/30';
                
                html += `
                    <div class="flex items-center justify-between bg-black/30 rounded-xl p-4 border border-white/5">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${icon}</span>
                            <div>
                                <p class="text-white font-bold">${t.coin}${modeLabel}</p>
                                <p class="text-gray-500 text-xs">${t.amount_usdt} USDT ${targetPct ? 'â€¢ ' + targetPct : ''}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-3 py-1 rounded-lg text-xs ${statusClass}">${statusText}</span>
                            <button type="button" onclick="toggleAuto(${t.id}, ${isWaiting || isClosed})" class="p-2 rounded-lg bg-yellow-500/20 text-yellow-400 ${toggleClass}" title="${isWaiting ? 'Durdur' : 'BaÅŸlat'}">${isWaiting ? 'â¸ï¸' : 'â–¶ï¸'}</button>
                            <button type="button" onclick="editAuto(${t.id}, ${t.amount_usdt})" class="p-2 rounded-lg bg-blue-500/20 text-blue-400 ${editClass}" title="DÃ¼zenle">âœï¸</button>
                            <button type="button" onclick="deleteAuto(${t.id})" class="p-2 rounded-lg bg-red-500/20 text-red-400 ${deleteClass}" title="Sil">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } catch (e) {
            console.error(e);
        }
    }
    
    async function loadPositions() {
        try {
            // Get current mode from button states or session
            let currentMode = 'demo';
            const realBtn = document.getElementById('realModeBtn');
            const demoBtn = document.getElementById('demoModeBtn');
            if (realBtn && realBtn.classList.contains('bg-green-600')) {
                currentMode = 'real';
            } else if (window._currentTradeMode) {
                currentMode = window._currentTradeMode;
            }
            
            const endpoint = currentMode === 'real' ? '/api/positions/real' : '/api/positions/demo';
            
            const res = await fetch(endpoint, { credentials: 'include' });
            const data = await res.json();
            const container = document.getElementById('positionsContainer');
            
            // Active positions count
            const activeEl = document.getElementById('activePositions');
            if (activeEl) activeEl.textContent = data.count || (data.positions || []).length;
            
            // Active value display
            const activeValueEl = document.getElementById('activeValueLabel');
            if (activeValueEl && data.total_value !== undefined) {
                activeValueEl.textContent = 'DeÄŸer: $' + data.total_value.toLocaleString();
            }
            
            if (!data.positions || data.positions.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="text-3xl mb-2">ğŸ“­</div><p class="text-sm">AÃ§Ä±k pozisyon bulunmuyor</p></div>';
                return;
            }
            
            let html = '<div class="space-y-2">';
            let totalPnl = 0;
            
            data.positions.forEach(p => {
                const pnl = parseFloat(p.pnl || 0);
                totalPnl += pnl;
                const pnlClass = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const pnlBgClass = pnl >= 0 ? 'bg-green-500/10' : 'bg-red-500/10';
                const pnlSign = pnl >= 0 ? '+' : '';
                const pnlPct = p.pnl_percent ? `(${pnl >= 0 ? '+' : ''}${p.pnl_percent.toFixed(2)}%)` : '';
                const sourceIcon = p.source === 'auto' ? 'ğŸ¤–' : 'ğŸ‘¤';
                const currentPrice = parseFloat(p.current_price || p.entry_price || 0);
                const entryPrice = parseFloat(p.entry_price || 0);
                
                html += `
                    <div class="bg-black/30 rounded-xl p-3 border border-white/5 ${pnlBgClass}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${sourceIcon}</span>
                                <span class="text-white font-bold">${p.coin || p.symbol}</span>
                                <span class="text-xs px-2 py-0.5 rounded bg-blue-500/20 text-blue-400">${p.side || 'BUY'}</span>
                            </div>
                            <span class="text-gray-400 text-sm font-medium">${p.amount_usdt} USDT</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs mb-2">
                            <div>
                                <span class="text-gray-500">GiriÅŸ:</span>
                                <span class="text-white ml-1">$${entryPrice.toFixed(4)}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Åuan:</span>
                                <span class="text-yellow-400 ml-1">$${currentPrice.toFixed(4)}</span>
                            </div>
                            <div class="text-right">
                                <span class="${pnlClass} font-bold">${pnlSign}$${pnl.toFixed(4)} ${pnlPct}</span>
                            </div>
                        </div>
                        <button type="button" onclick="sellPos('${p.id}')" class="w-full py-2 rounded-lg bg-red-600 text-white text-sm font-bold cursor-pointer hover:bg-red-500 transition">ğŸ”» SELL</button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
            
            // Update PNL displays
            const totalPnlEl = document.getElementById('totalPnl');
            const dailyPnlEl = document.getElementById('dailyPnl');
            if (totalPnlEl) {
                totalPnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
                totalPnlEl.className = totalPnl >= 0 ? 'text-green-400 font-bold' : 'text-red-400 font-bold';
            }
            if (dailyPnlEl) {
                dailyPnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
            }
            
            // Update header balance based on mode
            try {
                const balEndpoint = currentMode === 'real' ? '/api/real/balance' : '/api/real/balance';
                const balRes = await fetch(balEndpoint, { credentials: 'include' });
                const balData = await balRes.json();
                const balanceEl = document.getElementById('balanceDisplay');
                const demoBtnEl = document.getElementById('demoBtnBalance');
                const balance = balData.balance_usdt ?? balData.balance ?? balData.total ?? 0;
                if (balance !== undefined) {
                    const formattedBal = Number(balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    if (balanceEl) balanceEl.textContent = formattedBal + ' USDT';
                    if (demoBtnEl) demoBtnEl.textContent = '$' + formattedBal + ' USDT';
                }
            } catch (e) { console.error('Balance fetch error:', e); }
        } catch (e) {
            console.error(e);
        }
    }
    
    async function toggleAuto(id, isWaiting) {
        try {
            // Use pause if waiting, resume if paused
            const endpoint = isWaiting ? '/api/auto/pause' : '/api/auto/resume';
            const res = await fetch(endpoint, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({id: id}) 
            });
            const data = await res.json();
            if (data.ok) {
                showNotification(data.message || (isWaiting ? 'Ä°ÅŸlem durduruldu â¸ï¸' : 'Ä°ÅŸlem baÅŸlatÄ±ldÄ± â–¶ï¸'), 'success');
            } else {
                showNotification('Hata: ' + (data.error || 'Bilinmeyen'), 'error');
            }
            loadAutoTrades();
        } catch (e) {
            console.error('Toggle error:', e);
            showNotification('BaÄŸlantÄ± hatasÄ±', 'error');
        }
    }
    
    async function editAuto(id, currentAmount) {
        console.log('editAuto called with id:', id, 'amount:', currentAmount);
        
        // Get current balance first
        let demoBalance = 0;
        try {
            const balRes = await fetch('/api/real/balance', { credentials: 'include' });
            const balData = await balRes.json();
            demoBalance = parseFloat(balData.balance || balData.demo_balance || 0);
        } catch (e) {
            console.error('Failed to get balance:', e);
        }
        
        // Create modal dialog
        const modal = document.createElement('div');
        modal.id = 'editAutoModal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm';
        modal.innerHTML = `
            <div class="bg-gray-900 rounded-2xl border border-white/10 p-6 w-[90%] max-w-md shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4">ğŸ’° Ä°ÅŸlem MiktarÄ±nÄ± DÃ¼zenle</h3>
                <p class="text-gray-400 text-sm mb-4">Mevcut: <span class="text-yellow-400 font-bold">${currentAmount} USDT</span> | Bakiye: <span class="text-green-400 font-bold">${demoBalance.toFixed(2)} USDT</span></p>
                
                <div class="mb-4">
                    <label class="text-gray-300 text-sm mb-2 block">Yeni Miktar (USDT)</label>
                    <input type="number" id="editAmountInput" value="${currentAmount}" min="1" step="0.01" 
                           class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-white text-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    <button onclick="document.getElementById('editAmountInput').value = ${(demoBalance * 0.25).toFixed(2)}" 
                            class="px-3 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 text-sm">%25</button>
                    <button onclick="document.getElementById('editAmountInput').value = ${(demoBalance * 0.50).toFixed(2)}" 
                            class="px-3 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 text-sm">%50</button>
                    <button onclick="document.getElementById('editAmountInput').value = ${(demoBalance * 0.75).toFixed(2)}" 
                            class="px-3 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 text-sm">%75</button>
                    <button onclick="document.getElementById('editAmountInput').value = ${demoBalance.toFixed(2)}" 
                            class="px-3 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 text-sm font-bold">ğŸ’¯ TÃœM BAKÄ°YE</button>
                </div>
                
                <div class="flex gap-3">
                    <button id="editCancelBtn" class="flex-1 px-4 py-3 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600">Ä°ptal</button>
                    <button id="editConfirmBtn" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-bold hover:opacity-90">âœ… Kaydet</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Focus input
        setTimeout(() => document.getElementById('editAmountInput').focus(), 100);
        
        // Handle cancel
        document.getElementById('editCancelBtn').onclick = () => {
            modal.remove();
        };
        
        // Handle click outside
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };
        
        // Handle confirm
        document.getElementById('editConfirmBtn').onclick = async () => {
            const newAmount = parseFloat(document.getElementById('editAmountInput').value);
            if (isNaN(newAmount) || newAmount < 1) {
                showNotification('GeÃ§erli bir miktar girin (minimum 1 USDT)', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/auto/edit', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({id: id, amount_usdt: newAmount}) 
                });
                const data = await res.json();
                console.log('Edit response:', data);
                
                if (data.ok) {
                    showNotification('Ä°ÅŸlem miktarÄ± gÃ¼ncellendi âœ…', 'success');
                    loadAutoTrades();
                    modal.remove();
                } else {
                    showNotification('GÃ¼ncelleme hatasÄ±: ' + (data.error || 'Bilinmeyen hata'), 'error');
                }
            } catch (e) {
                console.error('Edit error:', e);
                showNotification('GÃ¼ncelleme hatasÄ±', 'error');
            }
        };
    }
    
    async function deleteAuto(id) {
        console.log('deleteAuto called with id:', id);
        
        // Simple confirm dialog instead of broken popup modal
        if (!confirm('Bu auto iÅŸlemi silmek istediÄŸinize emin misiniz?')) {
            return;
        }
        
        try {
            const res = await fetch('/api/auto/delete', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({id: id}) 
            });
            const data = await res.json();
            console.log('Delete response:', data);
            
            if (data.ok) {
                showNotification('Ä°ÅŸlem silindi âœ…', 'success');
                loadAutoTrades();
            } else {
                showNotification('Silme hatasÄ±: ' + (data.error || 'Bilinmeyen hata'), 'error');
            }
        } catch (e) {
            console.error('Delete error:', e);
            showNotification('Silme hatasÄ±', 'error');
        }
    }
      // __AU_BAL_HELPERS_V2
      function __auFmt2(n){
        try { return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
        catch(e){ return String(n); }
      }
      function __auSetBalanceUI2(v){
        try{
          const b = Number(v);
          if (Number.isNaN(b)) return;
          const el = document.getElementById("balanceDisplay");
          if (el) el.textContent = __auFmt2(b) + " USDT";
          const demoBtn = document.getElementById("demoBtnBalance");
          if (demoBtn) demoBtn.textContent = "$" + __auFmt2(b) + " USDT";
        }catch(e){}
      }
      async function __auRefreshDemoBalance2(){
        try{
          const r = await fetch("/api/real/balance", { credentials: "include" });
          const j = await r.json();
          const bal = Number(j.balance_usdt ?? j.balance ?? 0);
          if (!Number.isNaN(bal)) __auSetBalanceUI2(bal);
        }catch(e){}
      }
      // __AU_BAL_SYNC_HELPER_V3
      function __auFmt3(n){
        try { return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
        catch(e){ return String(n); }
      }
      function __auSetBalanceUI3(v){
        try{
          const b = Number(v);
          if (Number.isNaN(b)) return;
          const el = document.getElementById("balanceDisplay");
          if (el) el.textContent = __auFmt3(b) + " USDT";
          const demoBtn = document.getElementById("demoBtnBalance");
          if (demoBtn) demoBtn.textContent = "$" + __auFmt3(b) + " USDT";
        }catch(e){}
      }
      async function __auSyncDemoBalance3(){
        try{
          const r = await fetch("/api/real/balance", { credentials: "include" });
          const j = await r.json();
          const bal = Number(j.balance_usdt ?? j.balance ?? 0);
          if (!Number.isNaN(bal)) __auSetBalanceUI3(bal);
        }catch(e){}
      }
    

async function sellPos(id) {
        window.__AU_BALANCE_LOCK_UNTIL = Date.now() + 12000;
        console.log('sellPos function called with id:', id);
        try {
            const res = await fetch('/api/positions/sell', { credentials: "include", method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({id: id}) 
            });
            console.log('sellPos response status:', res.status);
            const data = await res.json();
            

              // __AU_UI_SELLPOS_FORCE_REFRESH_V1
              try{
                  if (data && typeof data.new_balance !== "undefined" && data.new_balance !== null){
                      __auSetBalanceUI2(data.new_balance);
                  }
              }catch(e){}
              await __auRefreshDemoBalance2();
console.log('sellPos response data:', data);
            if (data.ok) {
                

                  // __AU_SELLPOS_SYNC_V3
                  try{
                      // 1) response new_balance varsa anÄ±nda bas
                      if (data && typeof data.new_balance !== "undefined" && data.new_balance !== null){
                          __auSetBalanceUI3(data.new_balance);
                      }
                      // 2) hemen sync
                      await __auSyncDemoBalance3();
                      // 3) race ihtimaline karÅŸÄ± gecikmeli 2 kez daha sync
                      setTimeout(__auSyncDemoBalance3, 200);
                      setTimeout(__auSyncDemoBalance3, 900);
                  }catch(e){}
showPopup({
                    icon: 'ğŸ’°',
                    title: 'Pozisyon KapatÄ±ldÄ±',
                    message: data.message || 'Ä°ÅŸlem baÅŸarÄ±yla kapatÄ±ldÄ±',
                    type: 'success'
                });
            } else {
                showPopup({
                    icon: 'âŒ',
                    title: 'Hata',
                    message: data.error || 'Pozisyon kapatÄ±lamadÄ±',
                    type: 'error'
                });
            }
            loadPositions();
        } catch (e) {
            console.error('Sell error:', e);
            showPopup({
                icon: 'âŒ',
                title: 'BaÄŸlantÄ± HatasÄ±',
                message: 'Sunucuya baÄŸlanÄ±lamadÄ±',
                type: 'error'
            });
        }
    }
    
    function pauseAllBots() { alert('TÃ¼m botlar duraklatÄ±ldÄ±'); }
    function stopAllBots() { alert('TÃ¼m botlar durduruldu'); }
    
    // Load Analytics Summary
    async function loadAnalyticsSummary() {
        try {
            const res = await fetch('/api/analytics/summary', {credentials: 'include'});
            const data = await res.json();
            if (data.ok) {
                // Total trades
                document.getElementById('totalTrades').textContent = data.all_time?.trades || 0;
                document.getElementById('todayTradesLabel').textContent = 'BugÃ¼n: ' + (data.today?.trades || 0);
                
                // Total volume
                const totalVol = data.all_time?.volume || 0;
                document.getElementById('totalVolume').textContent = '$' + totalVol.toLocaleString();
                const avgTrade = data.all_time?.trades > 0 ? (totalVol / data.all_time.trades).toFixed(0) : 0;
                document.getElementById('avgTradeLabel').textContent = 'Ort: $' + avgTrade;
                
                // Active positions
                document.getElementById('activePositions').textContent = data.active?.positions || 0;
                document.getElementById('activeValueLabel').textContent = 'DeÄŸer: $' + (data.active?.total_value || 0).toLocaleString();
                
                // Closed trades
                document.getElementById('closedTradesLabel').textContent = 'KapatÄ±lan: ' + (data.all_time?.closed || 0);
            }
        } catch(e) {
            console.error('Analytics load error:', e);
        }
    }
    
    function loadAnalyticsDetail(type) {
        // Future: Open modal with detailed analytics
        console.log('Analytics detail:', type);
    }
    
    // Update coin in button text
    document.getElementById('manualCoinSelect').addEventListener('change', function() {
        const coin = this.value;
        document.getElementById('manualTradeBtn').textContent = (tradeType === 'buy' ? 'AL' : 'SAT') + ' - ' + coin;
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadAutoTrades();
        loadPositions();
        loadExchangeStatus();
        loadAnalyticsSummary();
        setInterval(loadPositions, 2000);  // Update positions every 2 seconds for real-time PnL
        setInterval(loadAutoTrades, 5000); // Update auto trades every 5 seconds
        setInterval(loadExchangeStatus, 30000);
        setInterval(loadAnalyticsSummary, 10000); // Update analytics every 10 seconds
    });
    
    // Load exchange connection status
    async function loadExchangeStatus() {
        try {
            const res = await fetch('/api/exchange/list');
            const data = await res.json();
            
            if (data.success && data.configs) {
                const configs = data.configs;
                
                // Map DOM IDs to exchange keys
                const exchangeMap = {
                    'exchange-okx': 'okx',
                    'exchange-binance': 'binance',
                    'exchange-bybit': 'bybit',
                    'exchange-gateio': 'gateio'
                };
                
                for (const [elemId, exchangeKey] of Object.entries(exchangeMap)) {
                    const container = document.getElementById(elemId);
                    if (container) {
                        const dot = container.querySelector('span');
                        const info = configs[exchangeKey];
                        
                        if (info && info.connected) {
                            dot.classList.remove('bg-red-500');
                            dot.classList.add('bg-green-500');
                        } else {
                            dot.classList.remove('bg-green-500');
                            dot.classList.add('bg-red-500');
                        }
                    }
                }
            }
        } catch (e) {
            console.error('Exchange status load error:', e);
        }
    }
    

    
    // TradingView & Coin List Functions
    function selectChartCoin(symbol) {
        if (typeof TradingView !== 'undefined') {
            new TradingView.widget({
                "width": "100%",
                "height": "100%",
                "symbol": "BINANCE:" + symbol + "USDT",
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "tr",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "dashboard_tv_chart"
            });
        }
    }
    
    function filterCoinList(query) {
        query = query.toLowerCase();
        const items = document.getElementById('coinListContainer').children;
        for (let item of items) {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(query) ? 'flex' : 'none';
        }
    }
    
    // Live coin prices from Binance
    let coinPricesData = [];
    let coinSortType = 'volume';
    
    async function loadCoinPrices() {
        try {
            const res = await fetch('/api/ticker');
            const data = await res.json();
            
            if (!data.ok) return;
            
            const prices = data.prices || {};
            const container = document.getElementById('coinListContainer');
            if (!container) return;
            
            // Define coin info with colors
            const coinColors = {
                'BTC': 'bg-orange-500',
                'ETH': 'bg-blue-500',
                'SOL': 'bg-purple-500',
                'BNB': 'bg-yellow-500',
                'XRP': 'bg-gray-500',
                'ADA': 'bg-blue-400',
                'DOGE': 'bg-yellow-400',
                'AVAX': 'bg-red-500',
                'TRX': 'bg-red-400',
                'TON': 'bg-blue-600'
            };
            
            // Build coin list from prices
            coinPricesData = Object.entries(prices).map(([pair, price]) => {
                const coin = pair.replace('/USDT', '');
                return {
                    coin: coin,
                    pair: pair,
                    price: parseFloat(price),
                    change: (Math.random() * 6 - 2).toFixed(2), // Simulated change for now
                    volume: Math.random() * 1000000000 // Simulated volume
                };
            });
            
            renderCoinList();
        } catch (e) {
            console.error('Price load error:', e);
        }
    }
    
    function renderCoinList() {
        const container = document.getElementById('coinListContainer');
        if (!container || coinPricesData.length === 0) return;
        
        // Sort based on current sort type
        let sorted = [...coinPricesData];
        if (coinSortType === 'price') {
            sorted.sort((a, b) => b.price - a.price);
        } else if (coinSortType === 'change') {
            sorted.sort((a, b) => parseFloat(b.change) - parseFloat(a.change));
        } else {
            sorted.sort((a, b) => b.volume - a.volume);
        }
        
        const coinColors = {
            'BTC': 'bg-orange-500', 'ETH': 'bg-blue-500', 'SOL': 'bg-purple-500',
            'BNB': 'bg-yellow-500', 'XRP': 'bg-gray-500', 'ADA': 'bg-blue-400',
            'DOGE': 'bg-yellow-400', 'AVAX': 'bg-red-500', 'TRX': 'bg-red-400', 'TON': 'bg-blue-600'
        };
        
        let html = '';
        sorted.forEach(c => {
            const color = coinColors[c.coin] || 'bg-gray-600';
            const changeClass = parseFloat(c.change) >= 0 ? 'text-green-400' : 'text-red-400';
            const arrow = parseFloat(c.change) >= 0 ? 'â–²' : 'â–¼';
            const formattedPrice = c.price >= 1000 ? '$' + c.price.toLocaleString('en-US', {maximumFractionDigits: 0}) : 
                                   c.price >= 1 ? '$' + c.price.toFixed(2) : '$' + c.price.toFixed(4);
            
            html += `
                <div class="flex items-center justify-between p-2 hover:bg-gray-800 rounded-lg cursor-pointer" onclick="selectChartCoin('${c.coin}')">
                    <div class="flex items-center gap-2">
                        <span class="w-8 h-8 ${color} rounded-full flex items-center justify-center text-white font-bold text-xs">${c.coin[0]}</span>
                        <div><div class="text-white font-medium">${c.coin}</div><div class="text-xs text-gray-500">${c.pair}</div></div>
                    </div>
                    <div class="text-right"><div class="text-white font-mono">${formattedPrice}</div><div class="text-xs ${changeClass}">${arrow} ${Math.abs(c.change)}%</div></div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    function sortCoinList(type) {
        coinSortType = type;
        // Update button styles
        ['volume', 'change', 'price'].forEach(t => {
            const btn = document.getElementById('sort' + t.charAt(0).toUpperCase() + t.slice(1));
            if (btn) {
                if (t === type) {
                    btn.className = 'flex-1 bg-blue-600 text-white rounded-lg py-2 text-sm cursor-pointer hover:bg-blue-500';
                } else {
                    btn.className = 'flex-1 bg-transparent border border-white/10 text-gray-400 rounded-lg py-2 text-sm cursor-pointer hover:bg-white/10';
                }
            }
        });
        renderCoinList();
    }
    
    // Load prices on page load and every 10 seconds
    setTimeout(loadCoinPrices, 500);
    setInterval(loadCoinPrices, 1000);


    // Load AI Signal History
    async function loadSignalHistory() {
        try {
            const res = await fetch('/api/chat/room/sinyaller');
            const data = await res.json();
            const container = document.getElementById('signalHistoryContainer');
            
            // âœ… NULL SAFETY: Exit early if container missing
            if (!container) {
                console.warn('[SIGNAL_HISTORY] Container not found, skipping');
                return;
            }
            
            if (!data.messages) return;
            
            // Filter only signals (checking 'is_signal' flag or content pattern)
            // Added null guard for m.msg to prevent 'includes of undefined' error
            const signals = data.messages.filter(m => m.is_signal === true || (m.msg && m.msg.includes('Sinyali')));
            
            if (signals.length === 0) {
                container.innerHTML = '<div class="text-center py-6 text-gray-500"><div class="text-2xl mb-2">ğŸ“­</div>HenÃ¼z AI sinyali yok</div>';
                return;
            }
            
            let html = '';
            signals.reverse().forEach(s => { // Show newest first
                const msg = s.msg || '';
                const isBuy = msg.includes('AL') || msg.includes('BUY');
                const typeClass = isBuy ? 'text-green-400' : 'text-red-400';
                const typeBg = isBuy ? 'bg-green-500/10 border-green-500/20' : 'bg-red-500/10 border-red-500/20';
                const typeIcon = isBuy ? 'ğŸ”¼' : 'ğŸ”½';
                
                html += `
                    <div class="flex items-center justify-between p-3 rounded-lg border ${typeBg} hover:bg-white/5 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center text-xl">
                                ${typeIcon}
                            </div>
                            <div>
                                <p class="text-sm text-white font-medium">${s.user.replace('ğŸ“¢ ', '')}</p>
                                <p class="text-xs text-gray-400">${s.msg}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-500 block">${s.time}</span>
                            <button onclick="useSignal('${s.msg}')" class="mt-1 px-2 py-1 rounded bg-blue-600/20 text-blue-400 text-xs hover:bg-blue-600 hover:text-white transition-colors">Kullan</button>
                        </div>
                    </div>
                `;
            });
            
            // âœ… NULL SAFETY: Check container exists
            if (container) {
                container.innerHTML = html;
            } else {
                console.warn('[SIGNAL_HISTORY] Container not found');
            }
        } catch (e) {
            console.error("[SIGNAL_HISTORY] âŒ Signal load error:", e);
            const cont = document.getElementById('signalHistoryContainer');
            if (cont) cont.innerHTML = '<div class="text-center text-red-400 py-4 text-sm">âš ï¸ Sinyaller yÃ¼klenemedi</div>';
        }
    }
    
    function useSignal(msg) {
        // Parse signal message: "ğŸ“Š BTC/USDT AL Sinyali..."
        try {
            const parts = msg.split(' ');
            const coin = parts.find(p => p.includes('/'));
            const action = msg.includes('AL') ? 'buy' : 'sell';
            
            if (coin) {
                selectManualCoin(coin, 'ğŸª™');
                setTradeType(action);
                document.getElementById('manualAmount').focus();
                window.scrollTo({ top: document.getElementById('manualTradeBtn').offsetTop - 300, behavior: 'smooth' });
            }
        } catch (e) {
            console.error(e);
        }
    }

    // Load exchange connection status
    async function loadExchangeStatus() {
        try {
            const res = await fetch('/api/exchanges/status', {credentials: 'include'});
            const data = await res.json();
            if (data.ok && data.exchanges) {
                const exchanges = data.exchanges;
                
                // Update sidebar exchange indicators
                Object.keys(exchanges).forEach(exKey => {
                    const ex = exchanges[exKey];
                    const connected = ex.connected === true;
                    
                    // Update sidebar indicator
                    const sidebarEl = document.getElementById('exchange-' + exKey);
                    if (sidebarEl) {
                        const indicator = sidebarEl.querySelector('span');
                        if (indicator) {
                            indicator.className = connected ? 'w-2 h-2 rounded-full bg-green-500' : 'w-2 h-2 rounded-full bg-red-500';
                        }
                    }
                    
                    // Update header status row
                    const statusEl = document.getElementById('status-' + exKey);
                    if (statusEl) {
                        statusEl.className = connected ? 'flex items-center gap-1 text-green-400' : 'flex items-center gap-1 text-gray-500';
                        statusEl.innerHTML = connected 
                            ? '<span class="w-2 h-2 rounded-full bg-green-500"></span>' + (ex.name || exKey.toUpperCase())
                            : '<span class="w-2 h-2 rounded-full bg-gray-500"></span>' + (ex.name || exKey.toUpperCase());
                    }
                });
            }
        } catch (e) {
            console.error('Exchange status error:', e);
        }
    }

    // Init Chart and Signals
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => selectChartCoin('BTC'), 1000);
        loadSignalHistory();
        setInterval(loadSignalHistory, 10000); // Refresh every 10s
        loadExchangeStatus(); // Load exchange connection status
    });

</script>

<script>
/* AU_MODE_BALANCE_V2 */
(function () {
  var auMode = (localStorage.getItem("au_trade_mode") || "").toLowerCase() || "demo";
  var demoBal = 0;
  var realBal = 0;

  function fmtUSDT(x) {
    var n = Number(x || 0);
    if (!isFinite(n)) n = 0;
    return n.toFixed(2) + " USDT";
  }

  function paint() {
    var demoBtn = document.getElementById("demoBtn");
    var realBtn = document.getElementById("realBtn");
    var demoSmall = document.getElementById("demoBtnBalance");
    var realSmall = document.getElementById("realBtnBalance");
    var big = document.getElementById("balanceDisplay");
    var modeLabel = document.getElementById("modeLabel");

    if (demoSmall) demoSmall.textContent = fmtUSDT(demoBal);
    if (realSmall) realSmall.textContent = fmtUSDT(realBal);
    if (big) big.textContent = fmtUSDT(auMode === "real" ? realBal : demoBal);

    if (demoBtn && realBtn) {
      if (auMode === "demo") {
        demoBtn.className = "px-6 py-3 rounded-lg font-medium text-sm bg-blue-600 text-white cursor-pointer";
        realBtn.className = "px-6 py-3 rounded-lg font-medium text-sm bg-[#2a2a2a] text-gray-400 cursor-pointer hover:bg-gray-700";
      } else {
        realBtn.className = "px-6 py-3 rounded-lg font-medium text-sm bg-blue-600 text-white cursor-pointer";
        demoBtn.className = "px-6 py-3 rounded-lg font-medium text-sm bg-[#2a2a2a] text-gray-400 cursor-pointer hover:bg-gray-700";
      }
    }

    if (modeLabel) {
      modeLabel.textContent = (auMode === "real" ? "REAL" : "DEMO");
      modeLabel.className = "px-3 py-1 rounded-lg text-xs bg-blue-500/20 text-blue-400 ml-2";
    }
  }

  async function jget(url) {
    try {
      var r = await fetch(url, { credentials: "include" });
      return await r.json();
    } catch (e) {
      return null;
    }
  }

  async function refreshBalances() {

    // __AU_BAL_LOCK_GUARD_refreshBalances

    try{ if (window.__AU_BALANCE_LOCK_UNTIL && Date.now() < window.__AU_BALANCE_LOCK_UNTIL) return; }catch(e){}

    var d = await jget("/api/real/balance");
    if (d && d.ok) demoBal = Number(d.balance || d.demo_balance || 0) || 0;

    var rr = await jget("/api/real/balance");
    if (rr && rr.ok) realBal = Number(rr.balance || rr.usdt || rr.totalUSDT || rr.total || 0) || 0;

    paint();
  }

  window.setMode = async function (mode) {
    mode = String(mode || "").toLowerCase();
    if (mode !== "demo" && mode !== "real") return;

    auMode = mode;
    localStorage.setItem("au_trade_mode", auMode);
    paint();

    // Show/hide exchange selects based on mode
    const autoExchangeSelect = document.getElementById('autoExchangeSelect');
    const manualExchangeSelect = document.getElementById('manualExchangeSelect');
    const realBalancesDiv = document.getElementById('realExchangeBalances');
    const exchangeStatusRow = document.getElementById('exchangeStatusRow');
    const modeLabel = document.getElementById('modeLabel');
    const demoBtn = document.getElementById('demoBtn');
    const realBtn = document.getElementById('realBtn');
    
    if (mode === 'demo') {
        if (autoExchangeSelect) autoExchangeSelect.classList.add('hidden');
        if (manualExchangeSelect) manualExchangeSelect.classList.add('hidden');
        if (realBalancesDiv) realBalancesDiv.classList.add('hidden');
        if (exchangeStatusRow) exchangeStatusRow.classList.remove('hidden');
        if (modeLabel) {
            modeLabel.textContent = 'DEMO';
            modeLabel.className = 'px-3 py-1 rounded-lg text-xs bg-blue-500/20 text-blue-400 ml-2';
        }
        if (demoBtn) {
            demoBtn.classList.add('bg-blue-600', 'text-white');
            demoBtn.classList.remove('bg-[#2a2a2a]', 'text-gray-400');
        }
        if (realBtn) {
            realBtn.classList.remove('bg-green-600', 'text-white');
            realBtn.classList.add('bg-[#2a2a2a]', 'text-gray-400');
        }
    } else {
        if (autoExchangeSelect) autoExchangeSelect.classList.remove('hidden');
        if (manualExchangeSelect) manualExchangeSelect.classList.remove('hidden');
        if (realBalancesDiv) realBalancesDiv.classList.remove('hidden');
        if (exchangeStatusRow) exchangeStatusRow.classList.add('hidden');
        if (modeLabel) {
            modeLabel.textContent = 'REAL';
            modeLabel.className = 'px-3 py-1 rounded-lg text-xs bg-green-500/20 text-green-400 ml-2';
        }
        if (demoBtn) {
            demoBtn.classList.remove('bg-blue-600', 'text-white');
            demoBtn.classList.add('bg-[#2a2a2a]', 'text-gray-400');
        }
        if (realBtn) {
            realBtn.classList.add('bg-green-600', 'text-white');
            realBtn.classList.remove('bg-[#2a2a2a]', 'text-gray-400');
        }
        // Fetch exchange balances
        if (typeof fetchExchangeBalances === 'function') fetchExchangeBalances();
    }

    try {
      await fetch("/api/mode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ mode: auMode })
      });
    } catch (e) {}

    await refreshBalances();
  };

  document.addEventListener("DOMContentLoaded", async function () {
    // First sync mode with backend
    try {
      await fetch("/api/mode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ mode: auMode })
      });
    } catch (e) {}
    
    paint();
    await refreshBalances();
    setInterval(refreshBalances, 5000);
  });
})();
</script>

<!-- Dashboard Footer -->
<footer class="bg-[#0a0a0a] border-t border-white/5 py-6 mt-8">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-wrap justify-center gap-6 mb-4">
            <a href="#" onclick="openInfoPopup('about'); return false;" class="text-gray-500 hover:text-blue-400 text-sm transition-colors">HakkÄ±mÄ±zda</a>
            <a href="#" onclick="openInfoPopup('faq'); return false;" class="text-gray-500 hover:text-blue-400 text-sm transition-colors">SSS</a>
            <a href="#" onclick="openInfoPopup('support'); return false;" class="text-gray-500 hover:text-blue-400 text-sm transition-colors">Destek</a>
            <a href="#" onclick="openInfoPopup('contact'); return false;" class="text-gray-500 hover:text-blue-400 text-sm transition-colors">Ä°letiÅŸim</a>
            <a href="#" onclick="openInfoPopup('terms'); return false;" class="text-gray-500 hover:text-blue-400 text-sm transition-colors">KullanÄ±m KoÅŸullarÄ±</a>
            <a href="#" onclick="openInfoPopup('privacy'); return false;" class="text-gray-500 hover:text-blue-400 text-sm transition-colors">Gizlilik</a>
        </div>
        <p class="text-center text-gray-600 text-xs">&copy; 2026 Atalay Ulusoy. TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
    </div>
</footer>

<!-- Info Popup Modal -->
<div id="infoPopupModal" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
    <div class="bg-[#1a1a1a] rounded-2xl border border-white/10 w-full max-w-2xl max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 id="infoPopupTitle" class="text-lg font-semibold text-white">Bilgi</h3>
            <button onclick="closeInfoPopup()" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div id="infoPopupContent" class="p-6 overflow-y-auto max-h-[60vh]">
            <div class="text-center py-8 text-gray-400">YÃ¼kleniyor...</div>
        </div>
    </div>
</div>

<script>
async function openInfoPopup(page) {
    const modal = document.getElementById('infoPopupModal');
    const content = document.getElementById('infoPopupContent');
    const title = document.getElementById('infoPopupTitle');
    
    const titles = {'about': 'HakkÄ±mÄ±zda', 'faq': 'SÄ±k Sorulan Sorular', 'support': 'Destek Merkezi', 'contact': 'Ä°letiÅŸim'};
    title.textContent = titles[page] || 'Bilgi';
    content.innerHTML = '<div class="text-center py-8 text-gray-400">YÃ¼kleniyor...</div>';
    modal.classList.remove('hidden');
    
    try {
        const res = await fetch('/api/popup/content/' + page, {credentials: 'include'});
        const data = await res.json();
        content.innerHTML = data.ok ? data.html : '<div class="text-center py-8 text-red-400">Ä°Ã§erik yÃ¼klenemedi.</div>';
    } catch(e) {
        content.innerHTML = '<div class="text-center py-8 text-red-400">BaÄŸlantÄ± hatasÄ±.</div>';
    }
}

function closeInfoPopup() {
    document.getElementById('infoPopupModal').classList.add('hidden');
}

document.getElementById('infoPopupModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeInfoPopup();
});
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeInfoPopup(); });
</script>

</body>
</html>
"""

@app.route('/dashboard')
@app.route('/trading-dashboard')
def page_trading_dashboard():
    if not session.get("logged_in"):
        return redirect("/api/app/login")

    user_id = session.get("user_id", 0)
    username = session.get("username", "User")

    # Paket bilgisi - doÄŸrudan users tablosundan oku
    pkg_name = "Temel"
    limit = 300
    used = 0
    try:
        conn = db()
        row = conn.execute("""
            SELECT package_name, package_limit FROM users WHERE username=?
        """, (username,)).fetchone()
        conn.close()
        
        if row:
            pkg_name = row[0] or "Temel"
            limit = int(row[1] or 300)
            if limit < 0:
                limit = -1  # Unlimited
        
        # Get used count
        used = int(get_usage(username).get("used_count", 0)) if 'get_usage' in dir() else 0
    except Exception as e:
        print(f"Dashboard package fetch error: {e}")
        pass

    user_header = get_user_header_html(username, pkg_name, used, limit)

    # Coin listesi (varsayÄ±lan OKX)
    coins = []
    try:
        coins = get_symbols_for_exchange("OKX")
        # UI'de daha okunaklÄ± olmasÄ± iÃ§in "BTC/USDT" formatÄ±nda bÄ±rak
        coins = [c for c in coins if isinstance(c, str)]
    except Exception:
        # Expanded fallback coin list (70+ popular trading pairs)
        coins = [
            "BTC/USDT", "ETH/USDT", "SOL/USDT", "XRP/USDT", "DOGE/USDT", "ADA/USDT",
            "AVAX/USDT", "DOT/USDT", "LINK/USDT", "MATIC/USDT", "SHIB/USDT", "LTC/USDT",
            "TRX/USDT", "ATOM/USDT", "UNI/USDT", "ETC/USDT", "XLM/USDT", "BCH/USDT",
            "APT/USDT", "NEAR/USDT", "FIL/USDT", "ICP/USDT", "HBAR/USDT", "VET/USDT",
            "QNT/USDT", "ALGO/USDT", "AAVE/USDT", "GRT/USDT", "FTM/USDT", "SAND/USDT",
            "MANA/USDT", "THETA/USDT", "AXS/USDT", "EGLD/USDT", "EOS/USDT", "XTZ/USDT",
            "FLOW/USDT", "CHZ/USDT", "CRV/USDT", "CAKE/USDT", "LDO/USDT", "ENJ/USDT",
            "1INCH/USDT", "GALA/USDT", "SNX/USDT", "BAT/USDT", "ZEC/USDT", "DASH/USDT",
            "COMP/USDT", "MKR/USDT", "YFI/USDT", "SUSHI/USDT", "ZIL/USDT", "ENS/USDT",
            "ROSE/USDT", "KAVA/USDT", "WAVES/USDT", "GMT/USDT", "APE/USDT", "NEO/USDT",
            "OP/USDT", "ARB/USDT", "SUI/USDT", "SEI/USDT", "TIA/USDT", "INJ/USDT",
            "PEPE/USDT", "WIF/USDT", "BONK/USDT", "FLOKI/USDT", "ORDI/USDT", "STX/USDT",
            "XAU/USDT", "XAG/USDT", "XPD/USDT", "XCU/USDT"  # Commodities
        ]

    return render_template_string(
        FULL_DASHBOARD_TEMPLATE,
        user={"username": username, "id": user_id},
        coins=coins,
        user_header=user_header,
        sidebar=get_sidebar_html("dashboard"),
    )




# ===================================================
# ENHANCED LIVE CHAT SYSTEM
# ===================================================
import random
import time
import threading

# Room-specific chat messages
ROOM_MESSAGES = {
    "genel": [
        {"user": "btc_whale42", "msg": "BugÃ¼n piyasa nasÄ±l gidiyor?", "time": "10:15"},
        {"user": "crypto_master", "msg": "BTC gÃ¼Ã§lÃ¼ gÃ¶rÃ¼nÃ¼yor ğŸ’ª", "time": "10:17"},
        {"user": "eth_trader99", "msg": "ETH de yÃ¼kseliyor, gÃ¼zel hareket", "time": "10:20"},
        {"user": "moon_hunter", "msg": "SOL'a dikkat edin, pump gelebilir", "time": "10:25"},
        {"user": "diamond_hands", "msg": "HODL devam ğŸš€", "time": "10:30"},
    ],
    "sinyaller": [
        {"user": "ğŸ¤– AI Bot", "msg": "ğŸ“Š BTC/USDT AL Sinyali - Hedef: +0.5%", "time": "10:00", "is_signal": True},
        {"user": "signal_master", "msg": "Bu sinyal gÃ¼zel gÃ¶rÃ¼nÃ¼yor", "time": "10:02"},
        {"user": "ğŸ¤– AI Bot", "msg": "âœ… BTC/USDT Sinyal KapandÄ±: +0.48%", "time": "10:35", "is_signal": True},
        {"user": "profit_hunter", "msg": "GÃ¼zel kar, tebrikler ğŸ‰", "time": "10:37"},
    ],
    "analiz": [
        {"user": "chart_wizard", "msg": "BTC 4H grafikte bullish flag oluÅŸuyor", "time": "09:45"},
        {"user": "ta_expert", "msg": "RSI 55, henÃ¼z aÅŸÄ±rÄ± alÄ±m yok", "time": "09:50"},
        {"user": "fibonacci_king", "msg": "0.618 seviyesinden destek aldÄ±", "time": "10:00"},
        {"user": "trend_follower", "msg": "200 MA Ã¼stÃ¼nde kaldÄ±ÄŸÄ± sÃ¼rece long", "time": "10:15"},
    ],
    "yardim": [
        {"user": "newbie_trader", "msg": "Stop loss nasÄ±l ayarlanÄ±r?", "time": "09:30"},
        {"user": "helper_bot", "msg": "Ayarlar > Risk YÃ¶netimi bÃ¶lÃ¼mÃ¼nden ayarlayabilirsin", "time": "09:32"},
        {"user": "curious_crypto", "msg": "Demo hesap gerÃ§ek para kullanÄ±yor mu?", "time": "09:40"},
        {"user": "support_team", "msg": "HayÄ±r, demo hesap sanal para ile Ã§alÄ±ÅŸÄ±r ğŸ‘", "time": "09:42"},
    ],
    "vip": [
        {"user": "ğŸŒŸ VIP Trader", "msg": "Ã–zel sinyal: XRP/USDT yakÄ±nda hareket edecek", "time": "10:00"},
        {"user": "elite_member", "msg": "VIP grubu her zaman bir adÄ±m Ã¶nde ğŸ’", "time": "10:05"},
        {"user": "ğŸ¤– AI Bot", "msg": "ğŸ”¥ VIP Sinyal: ETH/USDT AL - Hedef: +0.8%", "time": "10:10", "is_signal": True},
        {"user": "premium_whale", "msg": "Bu sinyali kaÃ§Ä±rmayÄ±n!", "time": "10:12"},
    ],
}

# Fake users list with crypto-style names
FAKE_CHAT_USERS = [
    "crypto_whale23", "btc_hodler99", "eth_master42", "moon_hunter77",
    "degen_trader", "altcoin_sniper", "diamond_hands88", "lambo_dreamer",
    "chart_wizard", "pump_detective", "signal_king", "profit_maker",
    "bear_hunter", "bull_rider", "satoshi_fan", "defi_explorer"
]

# Random messages for fake users - more casual, informal trader talk
FAKE_USER_MESSAGES = {
    "genel": [
        # Selamlar ve gÃ¼nlÃ¼k sohbet
        "GÃ¼naydÄ±n trader'lar â˜€ï¸", "Ä°yi akÅŸamlar herkese ğŸŒ™", "Selam arkadaÅŸlar ğŸ‘‹",
        "Naber beyler nasÄ±lsÄ±nÄ±z", "HayÄ±rlÄ± iÅŸler diliyorum", "Bu gece uyumadÄ±m piyasadan ğŸ˜…",
        "Sabah kahvesi ve chart analizi ğŸ”¥", "Åu piyasaya bak ya", "BugÃ¼n nasÄ±l gidiyor iÅŸler",
        
        # Piyasa yorumlarÄ±
        "Piyasa bugÃ¼n Ã§ok hareketli", "Volatilite Ã§ok yÃ¼ksek dikkat", "Sakin bir gÃ¼n olacak gibi",
        "Dump gelirse fÄ±rsat olabilir", "Pump bekliyorum yakÄ±nda", "Bu sefer farklÄ± olacak ğŸš€",
        "Korku endeksi dÃ¼ÅŸÃ¼k almak lazÄ±m", "AÃ§gÃ¶zlÃ¼lÃ¼k tehlikeli", "SabÄ±r lazÄ±m bu iÅŸte",
        
        # BTC yorumlarÄ±  
        "BTC konsolidasyon yapÄ±yor", "Bitcoin 100K yakÄ±n mÄ±", "BTC dominance artÄ±yor",
        "BTC dÃ¼ÅŸerse altlar Ã§Ã¶ker", "Bitcoin kral olmaya devam", "BTC'ye gÃ¼veniyorum",
        
        # Altcoin sohbeti
        "Altcoin sezonu gelir mi acaba", "Åu altcoin'e baktÄ±nÄ±z mÄ±", "ETH mi SOL mu",
        "Meme coin'ler riskli", "Utility token'lar daha gÃ¼venli", "DeFi projeleri umut vaat ediyor",
        
        # Genel tavsiyeler
        "DYOR unutmayÄ±n", "Kendi araÅŸtÄ±rmanÄ±zÄ± yapÄ±n", "Influencer'lara kÃ¶rÃ¼ kÃ¶rÃ¼ne gÃ¼venmeyin",
        "Stop loss ÅŸart", "Risk yÃ¶netimi her ÅŸeyden Ã¶nemli", "YatÄ±racaÄŸÄ±nÄ±z parayla oynayÄ±n",
        "Uzun vadeli dÃ¼ÅŸÃ¼nÃ¼n", "KÄ±sa vadeli trade zor iÅŸ", "SabÄ±rlÄ± olan kazanÄ±r",
        
        # Motivasyon
        "Ä°yi karlar herkese ğŸ’°", "Haydi bakalÄ±m ğŸ”¥", "BugÃ¼n yeÅŸil gÃ¼n olsun",
        "KÃ¶tÃ¼ gÃ¼nler de geÃ§er", "Her dÃ¼ÅŸÃ¼ÅŸ fÄ±rsat", "HODL devam ğŸ’ğŸ™Œ",
        
        # Soru ve tartÄ±ÅŸma
        "Ne dÃ¼ÅŸÃ¼nÃ¼yorsunuz bu hareket hakkÄ±nda", "Analiz yapan var mÄ±", "Volume nasÄ±l gÃ¶rÃ¼nÃ¼yor",
        "Support seviyeleri neler", "Resistance nerede sizce", "Weekly kapanÄ±ÅŸ ne olur",
        
        # GÃ¼ncel haberler
        "FED toplantÄ±sÄ± yaklaÅŸÄ±yor", "RegÃ¼lasyon haberleri tedirgin etti", "Kurumsal alÄ±mlar artÄ±yor",
        "ETF onayÄ± etkisi devam ediyor", "Halving sonrasÄ± ne olur", "Makro veriler Ã¶nemli"
    ],
    "sinyaller": [
        # Sinyal yorumlarÄ±
        "Bu sinyal gÃ¼zel gÃ¶rÃ¼nÃ¼yor ğŸ¯", "Girdim ben hemen", "Hedef ne kadar acaba",
        "Son sinyal Ã§ok iyiydi ğŸ‘", "Kar aldÄ±m teÅŸekkÃ¼rler", "Stop loss nerede olmalÄ±",
        "Entry neresi tam olarak", "TP1 vurdu mu", "TP2 bekliyorum", "TP3'e kadar gider mi",
        
        # Sorular
        "Sinyal geÃ§ kalmÄ±ÅŸ mÄ±", "Hala girilebilir mi bu seviyeden", "Risk/Reward oranÄ± kaÃ§",
        "Leverage kaÃ§ kullanÄ±yorsunuz", "Spot mu futures mÄ± daha iyi", "Partial profit almalÄ± mÄ±yÄ±z",
        
        # SonuÃ§ paylaÅŸÄ±mlarÄ±
        "Sinyale girdim +%2 kar aldÄ±m ğŸ’°", "GÃ¼zel trade oldu", "Bu sefer kaÃ§Ä±rdÄ±m",
        "Stop yedim ama olsun", "Risk yÃ¶netimi sayesinde az zarar", "Karda Ã§Ä±ktÄ±m ÅŸÃ¼kÃ¼r",
        
        # UyarÄ±lar ve tavsiyeler
        "Dikkat riskli gÃ¶rÃ¼nÃ¼yor", "Volume dÃ¼ÅŸÃ¼k iÅŸlem yapmayÄ±n", "Hacme bakÄ±n Ã¶nce",
        "GÃ¼zel entry seviyesi", "DCA yapÄ±n garantili olsun", "TÃ¼m parayÄ± koymayÄ±n",
        "Stop olmadan girmeyin", "Risk al ama kontrollÃ¼", "Her sinyale girmeyin",
        
        # TeÅŸekkÃ¼r ve Ã¶vgÃ¼
        "MuhteÅŸem sinyal yine", "Admin'e teÅŸekkÃ¼rler", "Ekip harika Ã§alÄ±ÅŸÄ±yor",
        "Bu platform gerÃ§ekten iyi", "GÃ¼venilir sinyaller", "Win rate Ã§ok yÃ¼ksek"
    ],
    "analiz": [
        # Teknik gÃ¶stergeler
        "RSI oversold bÃ¶lgesinde", "RSI overbought dikkat", "MACD bullish kesiÅŸim yaptÄ±",
        "MACD bearish sinyali verdi", "Stochastic dip noktasÄ±nda", "Bollinger sÄ±kÄ±ÅŸtÄ±",
        
        # Destek ve direnÃ§
        "Destek seviyesi gÃ¼Ã§lÃ¼ tutuyor", "DirenÃ§ kÄ±rÄ±ldÄ± yukarÄ± gider", "Fibonacci 0.618 test ediliyor",
        "EMA200 destek olarak Ã§alÄ±ÅŸÄ±yor", "SMA50 altÄ±na dÃ¼ÅŸtÃ¼ dikkat", "Pivot point Ã¶nemli",
        
        # Formasyon analizi
        "ÃœÃ§gen formasyonu oluÅŸtu", "BaÅŸ omuz formasyonu gÃ¶rÃ¼yorum", "Double bottom oluÅŸuyor",
        "Ascending triangle bullish", "Descending triangle bearish", "Flag pattern var",
        
        # Zaman dilimleri
        "4H grafikte bullish gÃ¶rÃ¼nÃ¼m", "1D Ã§ok temiz yukarÄ± trend", "Weekly kapanÄ±ÅŸ kritik",
        "15M'de al sinyali var", "1H direnÃ§ test ediliyor", "Monthly chart gÃ¼Ã§lÃ¼",
        
        # Hacim analizi
        "Hacim artÄ±yor dikkat edin", "Volume confirmation lazÄ±m", "OI yÃ¼kseliyor",
        "Whale hareketi tespit ettim", "Order book dengesiz", "Buy pressure artÄ±yor",
        
        # UyarÄ±lar
        "AyÄ± tuzaÄŸÄ± olabilir dikkat", "BoÄŸa tuzaÄŸÄ±na dikkat", "Fake breakout riski var",
        "Liquidation seviyeleri yakÄ±n", "Funding rate yÃ¼ksek", "Short squeeze gelebilir",
        
        # SonuÃ§ ve tahmin
        "Breakout yakÄ±n gÃ¶rÃ¼nÃ¼yor", "Trend devam edecek gibi", "Konsolidasyon bitti gibi",
        "Pump gelmeden pozisyon al", "Dump riskine karÅŸÄ± hedge yap", "Range iÃ§inde kal gÃ¼venli"
    ],
    "yardim": [
        # BaÅŸlangÄ±Ã§ sorularÄ±
        "NasÄ±l baÅŸlarÄ±m trading'e", "Yeni baÅŸlayanlar iÃ§in tavsiye", "Demo hesap var mÄ± burada",
        "API nasÄ±l baÄŸlanÄ±r sisteme", "Ä°lk adÄ±m ne olmalÄ±", "Hangi borsa Ã¶nerirsiniz",
        
        # Teknik sorular
        "Stop loss nasÄ±l ekleniyor", "Otomatik iÅŸlem gÃ¼venli mi", "Leverage nasÄ±l ayarlanÄ±r",
        "Limit order nedir", "Market order ne zaman kullanÄ±lÄ±r", "OCO order nasÄ±l",
        
        # Platform sorularÄ±
        "Paket fiyatlarÄ± ne kadar", "VIP Ã¼yelik ne avantaj saÄŸlÄ±yor", "Premium farkÄ± ne",
        "Hesap aÃ§mak Ã¼cretsiz mi", "TÃ¼rkiye'den kullanÄ±lÄ±yor mu", "Mobil uygulama var mÄ±",
        
        # Hesap sorularÄ±
        "Bildirim nasÄ±l aÃ§Ä±lÄ±r", "2FA zorunlu mu", "Åifre unuttum ne yapmalÄ±yÄ±m",
        "GiriÅŸ yapamÄ±yorum yardÄ±m", "Hesap onayÄ± ne kadar sÃ¼rer", "Mail gelmiyor",
        
        # TeÅŸekkÃ¼r
        "TeÅŸekkÃ¼rler yardÄ±m iÃ§in ğŸ™", "AnladÄ±m ÅŸimdi Ã§ok saÄŸol", "Ã‡ok aÃ§Ä±klayÄ±cÄ± oldu",
        "ArtÄ±k daha iyi anlÄ±yorum", "BaÅŸarÄ±lÄ± oldum sayenizde"
    ],
    "vip": [
        # VIP Ã¶vgÃ¼leri
        "VIP kesinlikle deÄŸer ğŸ’", "Ã–zel sinyaller muhteÅŸem", "Elite grubun farkÄ± baÅŸka",
        "Premium Ã¼yelik Ã§ok mantÄ±klÄ±", "Kar oranÄ±mÄ±z Ã§ok arttÄ±", "En iyi yatÄ±rÄ±m VIP oldu",
        
        # Sinyal yorumlarÄ±
        "Bu sinyal VIP'e Ã¶zel ğŸ”¥", "Ã–zel analiz geldi bakÄ±n", "Win rate rekor kÄ±rÄ±yor",
        "Bu kalitede sinyal baÅŸka yerde yok", "Her sinyal isabetli", "Risk yÃ¶netimi mÃ¼kemmel",
        
        # KazanÃ§ paylaÅŸÄ±mlarÄ±
        "AylÄ±k kazancÄ±m %30 arttÄ±", "Bu ay Ã§ok iyi geÃ§ti", "KarlÄ± trade serisi devam",
        "ROI Ã§ok yÃ¼ksek ÅŸÃ¼kÃ¼r", "Hedeflerimi aÅŸtÄ±m", "Beklentimin Ã¼stÃ¼nde sonuÃ§lar",
        
        # Tavsiyeler
        "VIP'e geÃ§in piÅŸman olmazsÄ±nÄ±z", "Premium grubun farkÄ± bÃ¼yÃ¼k", "YatÄ±rÄ±mÄ±n karÅŸÄ±lÄ±ÄŸÄ±nÄ± alÄ±rsÄ±nÄ±z",
        "Profesyonel ekip gerÃ§ekten", "Disiplinli trading Ã¶ÄŸrendim", "Risk management ders gibi",
        
        # Topluluk
        "Bu topluluk harika", "Birlikte kazanÄ±yoruz ğŸ¤", "Ekip Ã§ok yardÄ±mcÄ±",
        "SorularÄ±ma hep cevap alÄ±yorum", "7/24 destek muhteÅŸem", "EÄŸitim iÃ§erikleri Ã§ok iyi"
    ]
}

# Extended chat messages for more variety - 300+ unique messages
EXTENDED_CHAT_MESSAGES = {
    "genel": [
        # Selamlar (50+)
        "GÃ¼naydÄ±n herkese â˜€ï¸", "Ä°yi akÅŸamlar arkadaÅŸlar ğŸŒ™", "Selam trader'lar ğŸ‘‹", "Merhaba genÃ§ler",
        "HayÄ±rlÄ± cumalar", "Ä°yi haftasonlarÄ±", "Gece mesaisi yapanlar ğŸ¦‰", "Sabah kahvesi vakti â˜•",
        "HoÅŸ geldiniz yeni katÄ±lanlar", "Ä°yi geceler trader ailesi", "BugÃ¼n nasÄ±lsÄ±nÄ±z",
        "UmarÄ±m kar ediyorsunuzdur", "Enerjiniz yÃ¼ksek olsun", "Motivasyonunuz tam olsun",
        "Herkese baÅŸarÄ±lar diliyorum", "Bol kazanÃ§lÄ± gÃ¼nler", "Haydi bakalÄ±m piyasaya",
        "Kim burada bu saatte ğŸ˜„", "Gececi ekip burada mÄ±", "Erken kalkanlar kazanÄ±r",
        
        # Piyasa yorumlarÄ± (80+)
        "Piyasa bugÃ¼n Ã§ok aktif", "Volatilite had safhada", "Sakin sakin devam edelim",
        "SabÄ±rlÄ± olan kazanÄ±r bu iÅŸte", "FÄ±rtÄ±na Ã¶ncesi sessizlik mi bu", "Hareket baÅŸladÄ± sanki",
        "Pump modu aktif gibi", "Dump riski var dikkat", "Konsolidasyon devam ediyor",
        "Range iÃ§inde hareket", "Breakout yakÄ±n olabilir", "Trend yukarÄ± gÃ¶rÃ¼nÃ¼yor",
        "DÃ¼ÅŸÃ¼ÅŸ trendi kÄ±rÄ±labilir", "Yatay seyir ne kadar sÃ¼rer", "Volume artÄ±yor gÃ¼zel iÅŸaret",
        "Hacim dÃ¼ÅŸÃ¼k riskli", "Order book dengesiz", "Whale hareketi var gibi",
        "Kurumsal alÄ±m sinyalleri", "Retail panik satÄ±ÅŸÄ±", "FUD etkisi azalÄ±yor",
        "FOMO baÅŸlamÄ±ÅŸ durumda", "Korku endeksi yÃ¼kseldi", "AÃ§gÃ¶zlÃ¼lÃ¼k tehlikeli",
        "Makro veriler Ã¶nemli bugÃ¼n", "FED kararÄ± bekleniyor", "Faiz haberleri kritik",
        "CPI verileri aÃ§Ä±klanacak", "Ekonomik takvime bakÄ±n", "RegÃ¼lasyon haberleri var",
        "ETF akÄ±ÅŸlarÄ± pozitif", "Halving etkisi devam", "Mining zorluk arttÄ±",
        "On-chain veriler bullish", "Funding rate yÃ¼kseldi", "Open interest rekor",
        "Liquidation seviyeleri yakÄ±n", "Short squeeze gelebilir", "Long squeeze riski",
        "4H chart'ta gÃ¼zel gÃ¶rÃ¼ntÃ¼", "Daily candle Ã¶nemli", "Weekly kapanÄ±ÅŸ kritik",
        "Support test ediliyor", "Resistance kÄ±rÄ±ldÄ± mÄ±", "Fibonacci seviyelerine bak",
        "RSI ne diyor acaba", "MACD kesiÅŸimi var", "Bollinger sÄ±kÄ±ÅŸtÄ±",
        "EMA kesiÅŸimi yakÄ±n", "Trend line testi", "Pattern oluÅŸuyor",
        
        # BTC yorumlarÄ± (40+)
        "BTC bugÃ¼n gÃ¼Ã§lÃ¼", "Bitcoin dominance artÄ±yor", "BTC 100K hedefinde mi",
        "BTC dÃ¼zeltme yapÄ±yor", "Bitcoin kral olmaya devam", "BTC altlarÄ± sÃ¼rÃ¼klÃ¼yor",
        "BTC konsolidasyonda", "Bitcoin bullish flag", "BTC support aldÄ±",
        "BTC resistance test", "Bitcoin volume gÃ¼Ã§lÃ¼", "BTC kurumsal ilgi yÃ¼ksek",
        "BTC mining hash rate rekor", "Bitcoin stock to flow", "BTC rainbow chart",
        "Bitcoin fear greed index", "BTC weekly close Ã¶nemli", "Bitcoin monthly candle",
        "BTC all time high ne zaman", "Bitcoin cycle peak tahminleri", "BTC halving etkisi",
        "Bitcoin adoption artÄ±yor", "BTC payment kabul ediliyor", "Bitcoin legal tender",
        
        # ETH yorumlarÄ± (30+)
        "ETH gÃ¼Ã§lÃ¼ performans", "Ethereum 2.0 etkileri", "ETH gas fee dÃ¼ÅŸtÃ¼",
        "Ethereum staking rewards", "ETH burn rate yÃ¼ksek", "Ethereum deflationary",
        "ETH DeFi dominance", "Ethereum NFT aktivitesi", "ETH layer 2 adoption",
        "Ethereum roadmap heyecan verici", "ETH vs BTC oranÄ±", "Ethereum kurumsal ilgi",
        "ETH support seviyeleri", "Ethereum resistance bÃ¶lgesi", "ETH teknik gÃ¶rÃ¼nÃ¼m",
        
        # Altcoin sohbeti (50+)
        "Altcoin sezonu baÅŸlÄ±yor mu", "Alt season ne zaman", "Altlar pump yapacak mÄ±",
        "Meme coin'ler tehlikeli", "Utility token'lar mantÄ±klÄ±", "DeFi projeleri umut vadediyor",
        "Layer 1 vs Layer 2 debate", "Gaming token'lar yÃ¼kseliÅŸte", "AI coin'ler trend",
        "RWA projeleri dikkat Ã§ekiyor", "Modular blockchain'ler", "Zero knowledge projeleri",
        "Cross-chain kÃ¶prÃ¼ler", "Interoperability Ã¶nemli", "Scaling Ã§Ã¶zÃ¼mleri",
        "SOL ekosistemi bÃ¼yÃ¼yor", "Cosmos hub aktivitesi", "Polkadot parachains",
        "Avalanche subnet'leri", "Arbitrum One bÃ¼yÃ¼mesi", "Optimism aktivitesi",
        "zkSync era baÅŸladÄ±", "Base chain hype'Ä±", "Blast L2 beklentisi",
        
        # Genel tavsiyeler (60+)
        "DYOR Ã§ok Ã¶nemli", "Kendi araÅŸtÄ±rmanÄ±zÄ± yapÄ±n", "Influencer'lara gÃ¼venmeyin",
        "Stop loss ÅŸart bu iÅŸte", "Risk yÃ¶netimi her ÅŸeyden Ã¶nemli", "Position sizing kritik",
        "Leverage dikkatli kullanÄ±n", "Spot trading daha gÃ¼venli", "Futures riskli",
        "DCA stratejisi deneyin", "Tek seferde girmeyin", "Kademeli alÄ±m yapÄ±n",
        "Profit taking unutmayÄ±n", "KarÄ± realize edin", "AÃ§gÃ¶zlÃ¼ olmayÄ±n",
        "SabÄ±rlÄ± olun bu iÅŸte", "Uzun vadeli dÃ¼ÅŸÃ¼nÃ¼n", "KÄ±sa vadeli heyecan tuzak",
        "Plan yapÄ±n plana uyun", "Trading gÃ¼nlÃ¼ÄŸÃ¼ tutun", "Hatalardan Ã¶ÄŸrenin",
        "Duygusal kararlar vermeyin", "Korku ve aÃ§gÃ¶zlÃ¼lÃ¼k dÃ¼ÅŸman", "Disiplin ÅŸart",
        "Portfolio Ã§eÅŸitlendirin", "Tek sepete koymayÄ±n", "Risk daÄŸÄ±tÄ±mÄ± Ã¶nemli",
        "Likidite olan coin'ler", "Volume yÃ¼ksek coin'ler", "Spread dÃ¼ÅŸÃ¼k olan yerler",
        "Fee hesabÄ± yapÄ±n", "Net kar hesaplayÄ±n", "Commission etkisi",
        
        # Motivasyon (40+)
        "BaÅŸaracaÄŸÄ±z birlikte ğŸ’ª", "Ä°yi karlar herkese ğŸ’°", "Haydi bakalÄ±m ğŸ”¥",
        "BugÃ¼n yeÅŸil gÃ¼n olsun", "KÃ¶tÃ¼ gÃ¼nler de geÃ§er", "Her dÃ¼ÅŸÃ¼ÅŸ fÄ±rsat",
        "HODL devam ğŸ’ğŸ™Œ", "Diamond hands kazanÄ±r", "Paper hands kaybeder",
        "SabÄ±r meyvesini verir", "Zafer sabÄ±rlÄ± olanÄ±n", "Bu da geÃ§er",
        "GÃ¼zel gÃ¼nler yakÄ±n", "Bull run geliyor", "Bear market bitti mi",
        "Cycle dÃ¶nÃ¼yor sanki", "Momentum pozitif", "Sentiment deÄŸiÅŸiyor",
        "Umudu kaybetmeyin", "Strateji Ã¶nemli panik deÄŸil", "SoÄŸukkanlÄ± kalÄ±n",
        
        # Soru ve tartÄ±ÅŸma (50+)
        "Ne dÃ¼ÅŸÃ¼nÃ¼yorsunuz", "Analiz yapan var mÄ±", "Volume nasÄ±l",
        "Support nerede sizce", "Resistance hangi seviye", "Weekly close tahmini",
        "Bu hareketi nasÄ±l yorumluyorsunuz", "Trend devam eder mi", "DÃ¼zeltme gelir mi",
        "TP1 neresi olmalÄ±", "Stop loss nereye", "Entry seviyesi Ã¶nerisi",
        "Bu coin hakkÄ±nda ne dÃ¼ÅŸÃ¼nÃ¼yorsunuz", "Fundamental analizi kim yapar", "On-chain bakan var mÄ±",
        "Hangi borsa kullanÄ±yorsunuz", "Fee oranlarÄ± nasÄ±l", "Withdrawal sorun var mÄ±",
        "Mobil app kullanÄ±ÅŸlÄ± mÄ±", "API baÄŸlantÄ±sÄ± stabil mi", "Bot kullanÄ±yor musunuz",
    ],
    "sinyaller": [
        # Sinyal yorumlarÄ± (100+)
        "Bu sinyal gÃ¼zel ğŸ¯", "Girdim hemen", "Hedef ne kadar", "Stop nerede",
        "Son sinyal mÃ¼kemmeldi ğŸ‘", "Kar aldÄ±m teÅŸekkÃ¼rler", "TP1 vurdu", "TP2 bekliyorum",
        "TP3'e kadar gider mi", "Entry seviyesi ideal", "GiriÅŸ gÃ¼zel gÃ¶rÃ¼nÃ¼yor",
        "Risk/Reward oranÄ± iyi", "Leverage Ã¶nerisi ne", "Spot mu futures mÄ±",
        "Partial profit alalÄ±m mÄ±", "Trail stop koyalÄ±m mÄ±", "Break-even'a Ã§ekelim mi",
        "Sinyal geÃ§ kalmÄ±ÅŸ mÄ±", "Hala girilebilir mi", "Retest bekleyelim mi",
        "Confirmation geldi mi", "Volume confirmation lazÄ±m", "Candle close bekleyelim",
        "4H close Ã¶nemli", "Daily close'a kadar", "Weekly close'a gÃ¶re",
        "Bu seviyeden girilebilir", "Biraz dÃ¼ÅŸsÃ¼n gireyim", "Limit order verdim",
        "Market order aÃ§tÄ±m", "Fill oldu mu", "Slippage var mÄ±ydÄ±",
        
        # SonuÃ§ paylaÅŸÄ±mlarÄ± (50+)
        "GÃ¼zel trade oldu ğŸ’°", "+%2 kar aldÄ±m", "+%1.5 ile Ã§Ä±ktÄ±m", "Hedef vurdu ğŸ¯",
        "Bu sefer kaÃ§Ä±rdÄ±m", "GeÃ§ kaldÄ±m giriÅŸe", "Stop yedim ama olsun",
        "Risk yÃ¶netimi sayesinde az zarar", "Karda Ã§Ä±ktÄ±m ÅŸÃ¼kÃ¼r", "Break-even'da kapattÄ±m",
        "Partial profit aldÄ±m", "Trail stop Ã§alÄ±ÅŸtÄ±", "TP1 ile Ã§Ä±ktÄ±m",
        "TP2'ye kadar tuttum", "TP3 vurdu harika", "Full TP aldÄ±k",
        "Win streak devam", "Losing streak bitti", "Comeback yaptÄ±m",
        
        # UyarÄ±lar (40+)
        "Dikkat riskli gÃ¶rÃ¼nÃ¼yor", "Volume dÃ¼ÅŸÃ¼k", "Spread aÃ§Ä±k",
        "Fake breakout olabilir", "Trap olmasÄ±n dikkat", "Confirmation bekleyin",
        "Leverage azaltÄ±n", "Position size kÃ¼Ã§Ã¼ltÃ¼n", "Risk yÃ¶netimi ÅŸart",
        "Stop loss olmadan girmeyin", "Her sinyale girmeyin", "Selective olun",
        "Overtrading yapmayÄ±n", "Revenge trade tehlikeli", "FOMO'ya kapÄ±lmayÄ±n",
        
        # TeÅŸekkÃ¼r (30+)
        "MuhteÅŸem sinyal yine ğŸ‘", "Admin'e teÅŸekkÃ¼rler", "Ekip harika Ã§alÄ±ÅŸÄ±yor",
        "Bu platform gerÃ§ekten iyi", "GÃ¼venilir sinyaller", "Win rate Ã§ok yÃ¼ksek",
        "Kaliteli analiz", "Profesyonel yaklaÅŸÄ±m", "Disiplinli strateji",
        "EÄŸitici iÃ§erikler", "Åeffaf paylaÅŸÄ±m", "DÃ¼rÃ¼st sonuÃ§ raporlarÄ±",
        "Para eden sistem", "ROI Ã§ok iyi", "YatÄ±rÄ±mÄ±n karÅŸÄ±lÄ±ÄŸÄ±",
    ],
    "analiz": [
        # Teknik gÃ¶stergeler (80+)
        "RSI oversold bÃ¶lgesinde", "RSI overbought dikkat", "RSI divergence var",
        "MACD bullish kesiÅŸim", "MACD bearish sinyal", "MACD histogram pozitif",
        "Stochastic dip noktasÄ±nda", "Stochastic crossover", "Bollinger sÄ±kÄ±ÅŸtÄ±",
        "Bollinger breakout", "BB squeeze sonrasÄ±", "ATR yÃ¼kseliyor",
        "Volume profile analizi", "VWAP Ã¼stÃ¼nde iÅŸlem", "POC seviyesi Ã¶nemli",
        "Ichimoku cloud analizi", "Kumo twist yakÄ±n", "Chikou span confirmation",
        "ADX trend gÃ¼Ã§lÃ¼", "DMI+ yukarÄ± kesiÅŸim", "Momentum artÄ±yor",
        "OBV pozitif divergence", "CMF akÄ±ÅŸ gÃ¼Ã§lÃ¼", "MFI oversold",
        
        # Destek/DirenÃ§ (50+)
        "Destek seviyesi gÃ¼Ã§lÃ¼", "Support test ediliyor", "DirenÃ§ kÄ±rÄ±ldÄ±",
        "Resistance Ã§ok gÃ¼Ã§lÃ¼", "S/R flip oldu", "Previous high kÄ±rÄ±ldÄ±",
        "ATH test ediliyor", "ATL'den dÃ¶ndÃ¼", "Pivot point Ã¶nemli",
        "Fibonacci 0.618 test", "Golden ratio seviyesi", "0.382 retracement",
        "1.618 extension hedef", "0.236 ilk hedef", "0.786 deep retracement",
        "EMA200 destek olarak", "SMA50 resistance", "21 EMA dinamik destek",
        "Weekly open Ã¶nemli", "Monthly open seviyesi", "Yearly pivot",
        
        # Formasyonlar (60+)
        "ÃœÃ§gen formasyonu", "Ascending triangle", "Descending triangle",
        "Symmetrical triangle", "Bull flag oluÅŸuyor", "Bear flag dikkat",
        "Bull pennant", "Bear pennant", "Double bottom gÃ¶rÃ¼nÃ¼m",
        "Double top riski", "Head and shoulders", "Inverse H&S",
        "Cup and handle", "Falling wedge bullish", "Rising wedge bearish",
        "Channel trading", "Range bound market", "Breakout bekleniyor",
        "Fakeout riski", "Trap olasÄ±lÄ±ÄŸÄ±", "Confirmation ÅŸart",
        
        # Zaman dilimleri (40+)
        "1M chart gÃ¶rÃ¼nÃ¼mÃ¼", "3M consolidation", "5M scalping setup",
        "15M entry signal", "30M confirmation", "1H trend analizi",
        "4H key level test", "Daily chart bullish", "Weekly close kritik",
        "Monthly candle Ã¶nemli", "HTF bullish LTF bearish", "Multi timeframe analiz",
        "Timeframe confluence", "Higher highs LTF'de", "Lower lows HTF'de",
        
        # Hacim analizi (40+)
        "Hacim artÄ±yor ğŸ“ˆ", "Volume confirmation var", "DÃ¼ÅŸÃ¼k hacimde dikkat",
        "OI yÃ¼kseliyor", "Open interest kritik", "Funding pozitif",
        "Funding negatif uyarÄ±", "Liquidation haritasÄ±", "Whale alert ğŸ‹",
        "Large transaction detected", "Exchange inflow", "Exchange outflow",
        "Supply shock olabilir", "Accumulation phase", "Distribution gÃ¶rÃ¼nÃ¼yor",
    ],
    "yardim": [
        # BaÅŸlangÄ±Ã§ (40+)
        "NasÄ±l baÅŸlarÄ±m", "Yeni baÅŸlayanlar iÃ§in", "Demo hesap var mÄ±",
        "Ä°lk adÄ±mlar neler", "Hangi borsa Ã¶nerirsiniz", "TÃ¼rkiye'den kullanÄ±lÄ±r mÄ±",
        "KYC gerekli mi", "Minimum yatÄ±rÄ±m ne", "Ãœcretler nasÄ±l",
        "Free trial var mÄ±", "Paket karÅŸÄ±laÅŸtÄ±rmasÄ±", "Premium farkÄ± ne",
        "VIP avantajlarÄ±", "Referral sistemi", "Komisyon oranlarÄ±",
        
        # Teknik sorular (50+)
        "Stop loss nasÄ±l", "Take profit ayarÄ±", "Trailing stop nedir",
        "Leverage nasÄ±l", "Margin call ne demek", "Liquidation nedir",
        "Limit order farkÄ±", "Market order ne zaman", "OCO order nasÄ±l",
        "API baÄŸlantÄ±sÄ±", "Webhook kurulumu", "Bot ayarlarÄ±",
        "Backtest nasÄ±l", "Paper trading", "Strategy tester",
        "Portfolio tracker", "P&L hesaplama", "Tax reporting",
        "Cold wallet", "Hot wallet gÃ¼venliÄŸi", "2FA kurulumu",
        
        # Platform sorularÄ± (30+)
        "Mobile app var mÄ±", "Desktop app", "Web platform",
        "Push notification", "Email alerts", "Telegram bildirimleri",
        "Custom alerts", "Price alerts", "Volume alerts",
        "Watchlist oluÅŸturma", "Portfolio management", "Risk management tools",
        
        # Hesap sorularÄ± (30+)
        "Åifre unuttum", "Email deÄŸiÅŸikliÄŸi", "Username deÄŸiÅŸtirme",
        "Hesap silme", "Data export", "Trade history",
        "Deposit nasÄ±l", "Withdrawal sÃ¼reci", "Fee structure",
        "Referral earnings", "Commission tracking", "Invoice alma",
    ]
}

# Merge extended messages into FAKE_USER_MESSAGES
for room, messages in EXTENDED_CHAT_MESSAGES.items():
    if room in FAKE_USER_MESSAGES:
        FAKE_USER_MESSAGES[room].extend(messages)

# AI Signal messages with more variety
AI_SIGNALS = [
    {"coin": "BTC/USDT", "action": "AL", "target": "+0.45%", "confidence": 85},
    {"coin": "ETH/USDT", "action": "AL", "target": "+0.52%", "confidence": 78},
    {"coin": "SOL/USDT", "action": "AL", "target": "+0.65%", "confidence": 72},
    {"coin": "XRP/USDT", "action": "AL", "target": "+0.38%", "confidence": 80},
    {"coin": "BNB/USDT", "action": "AL", "target": "+0.41%", "confidence": 75},
    {"coin": "ADA/USDT", "action": "AL", "target": "+0.55%", "confidence": 70},
    {"coin": "DOGE/USDT", "action": "AL", "target": "+0.72%", "confidence": 65},
    {"coin": "AVAX/USDT", "action": "AL", "target": "+0.48%", "confidence": 77},
    {"coin": "DOT/USDT", "action": "AL", "target": "+0.43%", "confidence": 73},
    {"coin": "LINK/USDT", "action": "AL", "target": "+0.51%", "confidence": 76},
    {"coin": "MATIC/USDT", "action": "AL", "target": "+0.58%", "confidence": 71},
    {"coin": "ATOM/USDT", "action": "AL", "target": "+0.47%", "confidence": 74},
    {"coin": "UNI/USDT", "action": "AL", "target": "+0.44%", "confidence": 69},
    {"coin": "LTC/USDT", "action": "AL", "target": "+0.36%", "confidence": 82},
    {"coin": "FIL/USDT", "action": "AL", "target": "+0.62%", "confidence": 68},
]

# Store for chat messages per room
_CHAT_MESSAGES = {room: list(msgs) for room, msgs in ROOM_MESSAGES.items()}

def get_room_messages(room):
    """Get messages for a specific room"""
    room_key = room.lower().replace(" ", "").replace("â­", "").strip()
    # Map room names to keys
    room_map = {
        "genel": "genel",
        "sinyaller": "sinyaller", 
        "analiz": "analiz",
        "yardim": "yardim",
        "yardÄ±m": "yardim",
        "vip": "vip",
        "vipoda": "vip",
    }
    key = room_map.get(room_key, "genel")
    return _CHAT_MESSAGES.get(key, _CHAT_MESSAGES["genel"])


def add_chat_message(*args, **kwargs):
    """Flexible chat message writer.

    Supports legacy calls: add_chat_message(room, user, msg, is_signal=False)
    And new calls with keywords: room=..., user_id=..., username=..., message=..., is_signal=..., message_type=...
    """
    # Parse inputs (legacy + new)
    room = kwargs.pop("room", None)
    user_id = kwargs.pop("user_id", None)
    username = kwargs.pop("username", None)
    message = kwargs.pop("message", None)
    is_signal = int(kwargs.pop("is_signal", 0) or 0)
    message_type = kwargs.pop("message_type", "text")

    if room is None and len(args) >= 1:
        room = args[0]
    if username is None and len(args) >= 2:
        username = args[1]
    if message is None and len(args) >= 3:
        message = args[2]
    if len(args) >= 4 and "is_signal" not in kwargs:
        is_signal = int(bool(args[3]))

    room = (room or "genel").strip()
    if not room:
        room = "genel"

    # user_id defaults
    if user_id is None:
        # if username looks like a login id, reuse it; else bot
        user_id = (username or "bot").strip() or "bot"
    if username is None:
        username = "bot"
    if message is None:
        message = ""

    # In-memory cache support (if the project uses it)
    try:
        room_key = room.lower().replace(" ", "").replace("â­", "").strip()
        if "chat_rooms" in globals() and isinstance(chat_rooms, dict):
            chat_rooms.setdefault(room_key, [])
            chat_rooms[room_key].append({
                "room": room,
                "user_id": user_id,
                "username": username,
                "message": message,
                "is_signal": is_signal,
                "message_type": message_type,
                "created_at": datetime.now(timezone.utc).isoformat()
            })
            # keep only last 200
            chat_rooms[room_key] = chat_rooms[room_key][-200:]
    except Exception:
        pass

    # DB write (must not fail)
    try:
        conn = sqlite3.connect(DB_PATH)
        cur = conn.cursor()
        # Ensure migrations run
        migrate_db(conn)

        created_at = datetime.now(timezone.utc).isoformat()
        cols = _table_columns(conn, "chat_messages")
        if "message_type" in cols:
                room = (room or "").strip() or "genel"
                cur.execute(
                    "INSERT INTO chat_messages (room, user_id, username, message, is_signal, message_type, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)",
                    (room, user_id, username, message, int(is_signal), message_type, created_at),
                )
        else:
                room = (room or "").strip() or "genel"
                cur.execute(
                    "INSERT INTO chat_messages (room, user_id, username, message, is_signal, created_at) VALUES (?, ?, ?, ?, ?, ?)",
                    (room, user_id, username, message, int(is_signal), created_at),
                )
        conn.commit()
        conn.close()
    except Exception as e:
        try:
            print(f"[CHAT] DB write error: {e}")
        except Exception:
            pass
    return True

def generate_ai_signal():
    """Generate a random AI signal"""
    signal = random.choice(AI_SIGNALS)
    return f"ğŸ“Š {signal['coin']} {signal['action']} Sinyali - Hedef: {signal['target']} (GÃ¼ven: {signal['confidence']}%)"

# Background task for fake users and AI signals
_CHAT_BOT_RUNNING = False
_LAST_MESSAGES = {}  # Track last 5 messages per room to prevent duplicates
_LAST_USERS = {}  # Track last user per room to prevent same user twice

def chat_bot_loop():
    """Background loop for fake users and AI signals"""
    global _CHAT_BOT_RUNNING, _LAST_MESSAGES, _LAST_USERS
    while _CHAT_BOT_RUNNING:
        try:
            # Post a fake message every 30-60 seconds for demo purposes
            room = random.choice(["genel", "sinyaller", "analiz", "vip"])
            
            # Get user that's different from last user in this room
            last_user = _LAST_USERS.get(room, "")
            available_users = [u for u in FAKE_CHAT_USERS if u != last_user]
            user = random.choice(available_users) if available_users else random.choice(FAKE_CHAT_USERS)
            _LAST_USERS[room] = user
            
            # Get message that's different from recent messages in this room
            msgs = FAKE_USER_MESSAGES.get(room, FAKE_USER_MESSAGES["genel"])
            recent_msgs = _LAST_MESSAGES.get(room, [])
            available_msgs = [m for m in msgs if m not in recent_msgs]
            
            # If all messages used recently, reset pool
            if not available_msgs:
                available_msgs = msgs
                _LAST_MESSAGES[room] = []
            
            msg = random.choice(available_msgs)
            
            # Track this message to prevent repeats (keep last 10)
            if room not in _LAST_MESSAGES:
                _LAST_MESSAGES[room] = []
            _LAST_MESSAGES[room].append(msg)
            if len(_LAST_MESSAGES[room]) > 10:
                _LAST_MESSAGES[room] = _LAST_MESSAGES[room][-10:]
            
            add_chat_message(room, user, msg)
            print(f"[CHAT BOT] {user} in {room}: {msg}")
            
            # Random chance to also post an AI signal (25% chance when bot posts)
            if random.random() < 0.25:
                signal_room = random.choice(["sinyaller", "vip"])
                signal_msg = generate_ai_signal()
                add_chat_message(signal_room, "ğŸ¤– AI Bot", signal_msg, is_signal=True)
                print(f"[AI SIGNAL] {signal_msg}")
            
        except Exception as e:
            print(f"[CHAT BOT] Error: {e}")
        
        # Wait 30-90 seconds between messages for live demo
        wait_time = random.randint(30, 90)
        print(f"[CHAT BOT] Next message in {wait_time} seconds")
        time.sleep(wait_time)

def start_chat_bot():
    """Start the chat bot"""
    global _CHAT_BOT_RUNNING
    if not _CHAT_BOT_RUNNING:
        _CHAT_BOT_RUNNING = True
        t = threading.Thread(target=chat_bot_loop, daemon=True)
        t.start()
        print("[CHAT BOT] Started")

# API to get room messages
@app.get("/api/chat/room_legacy/<room>")
def api_chat_room_legacy(room):
    messages = get_room_messages(room)
    return jsonify({"ok": True, "messages": messages[-20:]})  # Last 20 messages

# API to send message
@app.post("/api/chat/send")
def api_chat_send():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    j = request.get_json(silent=True) or {}
    room = str(j.get("room", "genel"))
    msg = str(j.get("message", "")).strip()
    username = session.get("username", "Anonim")

    if not msg:
        return jsonify({"ok": False, "error": "Mesaj boÅŸ olamaz"}), 400

    try:
        add_chat_message(room, username, msg)
        return jsonify({"ok": True})
    except Exception as e:
        print(f"[CHAT SEND] Error: {e}")
        return jsonify({"ok": False, "error": "Mesaj kaydedilemedi"}), 500



# API to send signal (for users)
@app.post("/api/chat/signal")
def api_chat_signal():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    j = request.get_json(silent=True) or {}
    coin = str(j.get("coin", "BTC/USDT"))
    action = str(j.get("action", "AL"))
    target = str(j.get("target", "+0.5%"))
    
    username = session.get("username", "Trader")
    signal_msg = f"ğŸ“Š {coin} {action} Sinyali - Hedef: {target}"
    
    # Post to sinyaller room
    add_chat_message("sinyaller", f"ğŸ“¢ {username}", signal_msg, is_signal=True)
    
    return jsonify({"ok": True, "message": "Sinyal paylaÅŸÄ±ldÄ±"})



def can_enter_vip(user_id: int) -> bool:
    """Premium/Elite users can enter VIP room. Admin always can."""
    try:
        # If session has role, honor it
        if safe_str(session.get("role") or "").lower() == "admin":
            return True
    except Exception:
        pass

    # Attempt to read from DB (best-effort, schema may vary)
    plan = ""
    try:
        conn = db()
        # Try a few common columns / tables
        for sql, params in [
            ("SELECT subscription_plan FROM users WHERE id=?", (user_id,)),
            ("SELECT plan FROM users WHERE id=?", (user_id,)),
            ("SELECT package FROM users WHERE id=?", (user_id,)),
            ("SELECT package_name FROM users WHERE id=?", (user_id,)),
            ("SELECT subscription_plan FROM user_profiles WHERE id=?", (user_id,)),
            ("SELECT subscription_plan FROM user_profiles WHERE user_id=?", (user_id,)),
        ]:
            try:
                row = conn.execute(sql, params).fetchone()
                if row and row[0]:
                    plan = safe_str(row[0])
                    break
            except Exception:
                continue
        conn.close()
    except Exception:
        plan = safe_str(session.get("subscription_plan") or session.get("plan") or session.get("package") or session.get("package_name") or "")

    plan_l = plan.strip().lower()
    # Allow Premium / Elite (and synonyms)
    allowed = {"premium", "elite", "elit", "vip", "ultra"}
    return plan_l in allowed


# Initialize chat with some messages
def init_chat_messages():
    """Add initial messages to chat rooms"""
    import time as t
    import random as r
    
    rooms_data = {
        "GENERAL": [
            ("crypto_whale42", "GÃ¼naydÄ±n trader'lar! BugÃ¼n piyasa nasÄ±l?"),
            ("btc_hodler99", "BTC gÃ¼Ã§lÃ¼ gÃ¶rÃ¼nÃ¼yor ğŸ’ª"),
            ("eth_master", "ETH de yÃ¼kseliyor, gÃ¼zel hareket"),
        ],
        "BTC_TRY": [
            ("bitcoin_fan", "BTC/TRY yÃ¼kseliÅŸte"),
            ("trader_ali", "Destek seviyesi tuttu"),
        ],
        "USDT_TRY": [
            ("usdt_trader", "USDT/TRY stabil gidiyor"),
            ("profit_hunter", "AlÄ±m fÄ±rsatÄ± var mÄ±?"),
        ],
        "VIP": [
            ("ğŸ¤– AI Bot", "ğŸ“Š VIP Sinyal: BTC/USDT AL - Hedef: +0.5%"),
            ("vip_member", "Bu sinyal gÃ¼zel gÃ¶rÃ¼nÃ¼yor ğŸ‘"),
        ],
    }
    
    global _CHAT_MESSAGES_BY_ROOM
    if '_CHAT_MESSAGES_BY_ROOM' not in dir():
        _CHAT_MESSAGES_BY_ROOM = {}
    
    for room, msgs in rooms_data.items():
        if room not in _CHAT_MESSAGES_BY_ROOM:
            _CHAT_MESSAGES_BY_ROOM[room] = []
        for user, msg in msgs:
            _CHAT_MESSAGES_BY_ROOM[room].append({
                "user": user,
                "msg": msg,
                "time": t.strftime("%H:%M")
            })
    
    print("[CHAT] Initial messages loaded")

# Global storage for room messages
_CHAT_MESSAGES_BY_ROOM = {}




# ============================================
# COMPREHENSIVE ADMIN TEMPLATES
# ============================================

ADMIN_SIDEBAR_HTML = """
<aside class="fixed left-0 top-0 h-full w-64 bg-[#0a0a0a] border-r border-white/5 z-50 flex flex-col">
    <div class="p-4 border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-orange-600 flex items-center justify-center font-bold text-white">A</div>
            <div>
                <span class="font-bold text-white">Admin Panel</span>
                <p class="text-xs text-gray-500">YÃ¶netim Merkezi</p>
            </div>
        </div>
    </div>
    <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
        <a href="/api/app/admin/dashboard" class="flex items-center gap-3 px-4 py-3 rounded-xl {{ 'bg-orange-600/20 text-orange-400' if active == 'dashboard' else 'text-gray-400 hover:bg-white/5' }} transition">
            <span>ğŸ“Š</span> Dashboard
        </a>
        <a href="/api/app/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl {{ 'bg-orange-600/20 text-orange-400' if active == 'users' else 'text-gray-400 hover:bg-white/5' }} transition">
            <span>ğŸ‘¥</span> KullanÄ±cÄ± YÃ¶netimi
        </a>
        <a href="/api/app/admin/education" class="flex items-center gap-3 px-4 py-3 rounded-xl {{ 'bg-orange-600/20 text-orange-400' if active == 'education' else 'text-gray-400 hover:bg-white/5' }} transition">
            <span>ğŸ“</span> EÄŸitim Merkezi
        </a>
        <a href="/api/app/admin/packages" class="flex items-center gap-3 px-4 py-3 rounded-xl {{ 'bg-orange-600/20 text-orange-400' if active == 'packages' else 'text-gray-400 hover:bg-white/5' }} transition">
            <span>ğŸ“¦</span> Paket YÃ¶netimi
        </a>
        <a href="/api/app/admin/telegram" class="flex items-center gap-3 px-4 py-3 rounded-xl {{ 'bg-orange-600/20 text-orange-400' if active == 'telegram' else 'text-gray-400 hover:bg-white/5' }} transition">
            <span>ğŸ“±</span> Telegram AyarlarÄ±
        </a>
        <div class="border-t border-white/5 my-4"></div>
        <a href="/api/app/admin/webhooks" class="flex items-center gap-3 px-4 py-3 rounded-xl {{ 'bg-orange-600/20 text-orange-400' if active == 'webhooks' else 'text-gray-400 hover:bg-white/5' }} transition">
            <span>ğŸ”—</span> Webhook YapÄ±landÄ±rmasÄ±
        </a>
        <a href="/api/app/admin/analytics" class="flex items-center gap-3 px-4 py-3 rounded-xl {{ 'bg-orange-600/20 text-orange-400' if active == 'analytics' else 'text-gray-400 hover:bg-white/5' }} transition">
            <span>ğŸ“ˆ</span> Analytics & PnL
        </a>
        <a href="/api/app/admin/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl {{ 'bg-orange-600/20 text-orange-400' if active == 'settings' else 'text-gray-400 hover:bg-white/5' }} transition">
            <span>âš™ï¸</span> Ayarlar
        </a>
    </nav>
    <div class="p-4 border-t border-white/5">
        <a href="/api/app/dashboard" class="flex items-center gap-3 px-4 py-2 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm">
            <span>ğŸ </span> Ana Sayfaya DÃ¶n
        </a>
    </div>
</aside>
"""

ADMIN_DASHBOARD_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Atalay Ulusoy Auto Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f0f0f] text-white">
    """ + ADMIN_SIDEBAR_HTML.replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'dashboard' else 'text-gray-400 hover:bg-white/5' }}", "bg-orange-600/20 text-orange-400").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'users' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'contracts' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'webhooks' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'ai' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5") + """
    
    <main class="ml-64 p-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold flex items-center gap-3">
                    <span class="text-orange-500">ğŸ“Š</span> Admin Dashboard
                </h1>
                <p class="text-gray-400 text-sm mt-1">Sistem durumu ve genel bakÄ±ÅŸ</p>
            </div>
            <button class="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-xl font-medium transition flex items-center gap-2" onclick="location.reload()">
                <span>ğŸ”„</span> Yenile
            </button>
        </div>
        
        <!-- Sistem Metrikleri -->
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 mb-6">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="text-orange-400">ğŸ“ˆ</span> Sistem Metrikleri</h2>
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-black/30 rounded-xl p-4">
                    <p class="text-gray-400 text-xs mb-1">Aktif KullanÄ±cÄ±</p>
                    <p class="text-2xl font-bold text-white">{{ stats.active_users }}</p>
                    <p class="text-xs text-green-400">â†‘ 12 bu hafta</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4">
                    <p class="text-gray-400 text-xs mb-1">Bot SayÄ±sÄ±</p>
                    <p class="text-2xl font-bold text-green-400">{{ stats.active_bots }}</p>
                    <p class="text-xs text-gray-500">Ã‡alÄ±ÅŸan</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4">
                    <p class="text-gray-400 text-xs mb-1">Ä°ÅŸlem Hacmi</p>
                    <p class="text-2xl font-bold text-blue-400">{{ stats.volume }}</p>
                    <p class="text-xs text-gray-500">Bu ay</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4">
                    <p class="text-gray-400 text-xs mb-1">Toplam Gelir</p>
                    <p class="text-2xl font-bold text-yellow-400">${{ stats.revenue }}</p>
                    <p class="text-xs text-green-400">â†‘ %15</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-6">
                <!-- Sistem SaÄŸlÄ±ÄŸÄ± -->
                <div>
                    <h3 class="text-sm font-medium text-gray-400 mb-3">Sistem SaÄŸlÄ±ÄŸÄ±</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">Sunucu</span>
                            <span class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> 99.9%</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">VeritabanÄ±</span>
                            <span class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> 100%</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">API YanÄ±t</span>
                            <span class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> 45ms</span>
                        </div>
                    </div>
                </div>
                
                <!-- Servis Durumu -->
                <div>
                    <h3 class="text-sm font-medium text-gray-400 mb-3">Servis Durumu</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">âœ“ Binance</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">Aktif</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">âœ“ API Gateway</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">Aktif</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">âœ“ Trading Engine</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">Aktif</span>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-2">
                            <span class="text-sm">âœ“ Webhook Service</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">Aktif</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trading Ä°zleme -->
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 mb-6">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="text-red-400">ğŸ“ˆ</span> Trading Ä°zleme</h2>
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div class="bg-black/30 rounded-xl p-4 text-center">
                    <span class="text-2xl">ğŸ’°</span>
                    <p class="text-xl font-bold text-green-400 mt-2">$45.8K</p>
                    <p class="text-xs text-gray-400">GÃ¼nlÃ¼k Hacim</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4 text-center">
                    <span class="text-2xl">ğŸ“Š</span>
                    <p class="text-xl font-bold text-yellow-400 mt-2">$8.5K</p>
                    <p class="text-xs text-gray-400">AÃ§Ä±k Pozisyon</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4 text-center">
                    <span class="text-2xl">ğŸ“ˆ</span>
                    <p class="text-xl font-bold text-green-400 mt-2">0.00%</p>
                    <p class="text-xs text-gray-400">GÃ¼nlÃ¼k Kar</p>
                </div>
                <div class="bg-black/30 rounded-xl p-4 text-center">
                    <p class="text-xl font-bold text-blue-400 mt-2">156</p>
                    <p class="text-xs text-gray-400">BugÃ¼nkÃ¼ Ä°ÅŸlem</p>
                </div>
            </div>
            
            <!-- Son Ä°ÅŸlemler Tablosu -->
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-gray-500 border-b border-white/5">
                        <th class="pb-2">KullanÄ±cÄ±</th>
                        <th class="pb-2">Ã‡ift</th>
                        <th class="pb-2">Miktar</th>
                        <th class="pb-2">GiriÅŸ FiyatÄ±</th>
                        <th class="pb-2">Åuanki</th>
                        <th class="pb-2">Kar</th>
                        <th class="pb-2">SÃ¼re</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-white/5">
                        <td class="py-3">Trader_One</td>
                        <td>BTC/USDT</td>
                        <td>$25.00</td>
                        <td>$103,450</td>
                        <td>$103,892</td>
                        <td class="text-green-400">+0.42%</td>
                        <td class="text-gray-400">2 saat Ã¶nce</td>
                    </tr>
                    <tr class="border-b border-white/5">
                        <td class="py-3">Trader_Two</td>
                        <td>ETH/USDT</td>
                        <td>$15.00</td>
                        <td>$3,245</td>
                        <td>$3,312</td>
                        <td class="text-green-400">+2.06%</td>
                        <td class="text-gray-400">4 saat Ã¶nce</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
</body>
</html>
"""

ADMIN_USERS_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KullanÄ±cÄ± YÃ¶netimi | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f0f0f] text-white">
    <aside class="fixed left-0 top-0 h-full w-64 bg-[#0a0a0a] border-r border-white/5 z-50 flex flex-col">
        <div class="p-4 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-orange-600 flex items-center justify-center font-bold text-white">A</div>
                <span class="font-bold text-white">Admin Panel</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="/api/app/admin" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“Š Dashboard</a>
            <a href="/api/app/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-orange-600/20 text-orange-400">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</a>
            <a href="/api/app/admin/packages" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“¦ Paket YÃ¶netimi</a>
            <a href="/api/app/admin/telegram" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“± Telegram AyarlarÄ±</a>
            <a href="/api/app/admin/webhooks" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ”— Webhook YapÄ±landÄ±rmasÄ±</a>
            <a href="/api/app/admin/education" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ EÄŸitim Merkezi</a>
            <a href="/api/app/admin/analytics" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ˆ Analitik</a>
            <a href="/api/app/admin/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">âš™ï¸ Ayarlar</a>
        </nav>
        <div class="p-4 border-t border-white/5">
            <a href="/api/app/dashboard" class="text-sm text-gray-400 hover:text-white">ğŸ  Ana Sayfaya DÃ¶n</a>
        </div>
    </aside>
    
    <main class="ml-64 p-8">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold">KullanÄ±cÄ± YÃ¶netimi</h1>
            <div class="flex gap-2">
                <input type="text" placeholder="KullanÄ±cÄ± ara..." class="bg-[#1a1a1a] border border-white/10 rounded-xl px-4 py-2 text-sm w-64">
                <button class="px-4 py-2 bg-blue-600 rounded-xl text-sm">ğŸ”</button>
            </div>
        </div>
        
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 overflow-hidden">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-gray-400 text-sm border-b border-white/5">
                        <th class="px-6 py-4">KullanÄ±cÄ±</th>
                        <th class="px-6 py-4">E-posta</th>
                        <th class="px-6 py-4">Rol</th>
                        <th class="px-6 py-4">Ãœcret Modeli</th>
                        <th class="px-6 py-4">Bakiye</th>
                        <th class="px-6 py-4">Durum</th>
                        <th class="px-6 py-4">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-sm font-bold">{{ user.username[0].upper() }}</div>
                                <span class="font-medium">{{ user.username }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-400">{{ user.email }}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded-lg text-xs {{ 'bg-red-500/20 text-red-400' if user.role == 'Admin' else 'bg-blue-500/20 text-blue-400' }}">{{ user.role }}</span></td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded-lg text-xs bg-green-500/20 text-green-400">{{ user.package }}</span></td>
                        <td class="px-6 py-4 text-green-400">{{ user.balance }} TL</td>
                        <td class="px-6 py-4">
                            <span class="flex items-center gap-1 text-green-400 text-sm"><span class="w-2 h-2 rounded-full bg-green-500"></span> Aktif</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="showUserDetails({{ user.rowid }})" class="p-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">âœï¸</button>
                                <button onclick="confirmDeleteUser({{ user.rowid }}, '{{ user.username }}')" class="p-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- User Edit Modal -->
    <div id="user-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100]">
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/10 w-full max-w-lg p-6 relative">
            <button onclick="closeModal('user-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h3 class="text-xl font-bold text-white mb-6">KullanÄ±cÄ± DÃ¼zenle</h3>
            <input type="hidden" id="editUserId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">KullanÄ±cÄ± AdÄ±</label>
                    <input type="text" id="editUsername" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white" readonly>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">E-posta</label>
                    <input type="email" id="editEmail" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Telegram Chat ID</label>
                    <input type="text" id="editTelegramId" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Paket</label>
                        <select id="editPackage" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white">
                            <option value="trial">Deneme</option>
                            <option value="basic">Basic</option>
                            <option value="pro">Pro</option>
                            <option value="elit">Elit</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">SÃ¼re (Ay)</label>
                        <input type="number" id="editPackageMonths" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white" min="1" max="12">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Yeni Åifre (opsiyonel)</label>
                    <input type="password" id="editPassword" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white" placeholder="BoÅŸ bÄ±rakÄ±lÄ±rsa deÄŸiÅŸmez">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveUserEdit()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold">ğŸ’¾ Kaydet</button>
                <button onclick="closeModal('user-modal')" class="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">Ä°ptal</button>
            </div>
        </div>
    </div>

    <script>
    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden'); 
        document.getElementById(id).classList.add('flex'); 
    }
    function closeModal(id) { 
        document.getElementById(id).classList.add('hidden'); 
        document.getElementById(id).classList.remove('flex'); 
    }

    async function showUserDetails(userId) {
        try {
            const res = await fetch(`/api/admin/users/${userId}`);
            const data = await res.json();
            if (data.ok) {
                const user = data.user;
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editTelegramId').value = user.telegram_id || '';
                document.getElementById('editPassword').value = '';
                document.getElementById('editPackage').value = user.package || 'trial';
                document.getElementById('editPackageMonths').value = user.package_months || 1;
                openModal('user-modal');
            } else {
                alert('KullanÄ±cÄ± bilgileri alÄ±namadÄ±: ' + (data.error || 'Bilinmeyen hata'));
            }
        } catch (e) {
            alert('Hata: ' + e.message);
        }
    }

    async function saveUserEdit() {
        const userId = document.getElementById('editUserId').value;
        const data = {
            email: document.getElementById('editEmail').value,
            telegram_id: document.getElementById('editTelegramId').value,
            password: document.getElementById('editPassword').value,
            package: document.getElementById('editPackage').value,
            package_months: parseInt(document.getElementById('editPackageMonths').value) || 1
        };
        
        try {
            const res = await fetch(`/api/admin/users/${userId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.ok) {
                alert('âœ… KullanÄ±cÄ± gÃ¼ncellendi!');
                closeModal('user-modal');
                location.reload();
            } else {
                alert('âŒ Hata: ' + (result.error || 'Bilinmeyen hata'));
            }
        } catch (e) {
            alert('âŒ Hata: ' + e.message);
        }
    }

    function confirmDeleteUser(userId, username) {
        if (confirm(`"${username}" kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinize emin misiniz?`)) {
            fetch(`/api/admin/users/${userId}/delete`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        alert('âœ… KullanÄ±cÄ± silindi!');
                        location.reload();
                    } else {
                        alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
                    }
                })
                .catch(e => alert('âŒ Hata: ' + e.message));
        }
    }
    </script>
</body>
</html>
"""

ADMIN_CONTRACTS_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¶zleÅŸme YÃ¶netimi | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f0f0f] text-white">
    <aside class="fixed left-0 top-0 h-full w-64 bg-[#0a0a0a] border-r border-white/5 z-50 flex flex-col">
        <div class="p-4 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-orange-600 flex items-center justify-center font-bold text-white">A</div>
                <span class="font-bold text-white">Admin Panel</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="/api/app/admin" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“Š Dashboard</a>
            <a href="/api/app/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</a>
            <a href="/api/app/admin/packages" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“¦ Paket YÃ¶netimi</a>
            <a href="/api/app/admin/telegram" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“± Telegram AyarlarÄ±</a>
            <a href="/api/app/admin/webhooks" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ”— Webhook YapÄ±landÄ±rmasÄ±</a>
            <a href="/api/app/admin/education" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ EÄŸitim Merkezi</a>
            <a href="/api/app/admin/analytics" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ˆ Analitik</a>
            <a href="/api/app/admin/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">âš™ï¸ Ayarlar</a>
        </nav>
        <div class="p-4 border-t border-white/5">
            <a href="/api/app/dashboard" class="text-sm text-gray-400 hover:text-white">ğŸ  Ana Sayfaya DÃ¶n</a>
        </div>
    </aside>
    
    <main class="ml-64 p-8">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold">SÃ¶zleÅŸme YÃ¶netimi</h1>
            <button class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-xl font-medium flex items-center gap-2">
                <span>â•</span> Yeni SÃ¶zleÅŸme
            </button>
        </div>
        
        <div class="space-y-4">
            {% for contract in contracts %}
            <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="font-bold text-lg">{{ contract.title }}</h3>
                        <div class="flex items-center gap-4 text-sm text-gray-400 mt-1">
                            <span>ğŸ‘¤ {{ contract.user }}</span>
                            <span>âœ‰ï¸ {{ contract.email }}</span>
                            <span>ğŸ“… {{ contract.date }}</span>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-lg text-sm {{ 'bg-green-500/20 text-green-400' if contract.status == 'OnaylandÄ±' else 'bg-yellow-500/20 text-yellow-400' }}">{{ contract.status }}</span>
                </div>
                <p class="text-gray-400 text-sm mb-4">{{ contract.description }}</p>
                <div class="flex gap-2">
                    <button onclick="downloadContract({{ contract.id }})" class="px-4 py-2 bg-blue-600/20 text-blue-400 rounded-xl text-sm hover:bg-blue-600/30">ğŸ“¥ PDF Ä°ndir</button>
                    <button onclick="viewContractDetails({{ contract.id }}, '{{ contract.user }}', '{{ contract.tc }}', '{{ contract.date }}')" class="px-4 py-2 bg-purple-600/20 text-purple-400 rounded-xl text-sm hover:bg-purple-600/30">ğŸ‘ï¸ Detay</button>
                    <button onclick="confirmDeleteContract({{ contract.id }}, '{{ contract.user }}')" class="px-4 py-2 bg-red-600/20 text-red-400 rounded-xl text-sm hover:bg-red-600/30">ğŸ—‘ï¸ Sil</button>
                </div>
            </div>
            {% endfor %}
            {% if not contracts %}
            <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 text-center text-gray-500">
                HenÃ¼z sÃ¶zleÅŸme kaydÄ± bulunmuyor.
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Contract Detail Modal -->
    <div id="contract-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100]">
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/10 w-full max-w-lg p-6 relative">
            <button onclick="closeModal('contract-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h3 class="text-xl font-bold text-white mb-6">ğŸ“„ SÃ¶zleÅŸme DetayÄ±</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">KullanÄ±cÄ±</label>
                        <div id="contractUser" class="bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white"></div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">TC Kimlik No</label>
                        <div id="contractTC" class="bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Kabul Tarihi</label>
                    <div id="contractDate" class="bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white"></div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('contract-modal')" class="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">Kapat</button>
            </div>
        </div>
    </div>

    <script>
    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden'); 
        document.getElementById(id).classList.add('flex'); 
    }
    function closeModal(id) { 
        document.getElementById(id).classList.add('hidden'); 
        document.getElementById(id).classList.remove('flex'); 
    }

    function downloadContract(contractId) {
        window.open(`/api/admin/contracts/${contractId}/download`, '_blank');
    }

    function viewContractDetails(id, user, tc, date) {
        document.getElementById('contractUser').textContent = user;
        document.getElementById('contractTC').textContent = tc || 'BelirtilmemiÅŸ';
        document.getElementById('contractDate').textContent = date;
        openModal('contract-modal');
    }

    function confirmDeleteContract(id, user) {
        if (confirm(`"${user}" kullanÄ±cÄ±sÄ±nÄ±n sÃ¶zleÅŸmesini silmek istediÄŸinize emin misiniz?`)) {
            fetch(`/api/admin/contracts/${id}/delete`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        alert('âœ… SÃ¶zleÅŸme silindi!');
                        location.reload();
                    } else {
                        alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
                    }
                })
                .catch(e => alert('âŒ Hata: ' + e.message));
        }
    }
    </script>
</body>
</html>
"""

ADMIN_WEBHOOKS_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook YapÄ±landÄ±rmasÄ± | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    // Define functions in head to ensure global scope before buttons render
    function copyWebhookUrl(url) {
        const fullUrl = window.location.origin + url;
        navigator.clipboard.writeText(fullUrl).then(() => {
            alert('âœ… Webhook URL kopyalandÄ±! ' + fullUrl);
        }).catch(err => {
            prompt('Webhook URL:', fullUrl);
        });
    }
    
    function testWebhook(id, url) {
        alert('ğŸ”„ Webhook test ediliyor... URL: ' + window.location.origin + url);
        fetch('/api/admin/webhooks/' + id + '/test', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) alert('âœ… Webhook baÅŸarÄ±yla Ã§alÄ±ÅŸÄ±yor!');
                else alert('âš ï¸ Webhook yanÄ±t vermedi: ' + (data.error || ''));
            })
            .catch(e => alert('âŒ Test hatasÄ±: ' + e.message));
    }
    
    function deleteWebhook(id, user) {
        if (confirm('"' + user + '" kullanÄ±cÄ±sÄ±nÄ±n webhook\'unu silmek istediÄŸinize emin misiniz?')) {
            fetch('/api/admin/webhooks/' + id + '/delete', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.ok) { alert('âœ… Webhook silindi!'); location.reload(); }
                    else alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
                })
                .catch(e => alert('âŒ Hata: ' + e.message));
        }
    }
    
    function saveNewWebhook() {
        const user = document.getElementById('newWebhookUser').value;
        const url = document.getElementById('newWebhookUrl').value.trim();
        
        if (!url) {
            alert('âš ï¸ LÃ¼tfen webhook URL girin!');
            return;
        }
        
        fetch('/api/admin/webhooks/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user: user, url: url })
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                alert('âœ… Webhook eklendi!');
                document.getElementById('newWebhookUrl').value = '';
                location.reload();
            } else {
                alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(e => alert('âŒ Hata: ' + e.message));
    }
    </script>
</head>
<body class="bg-[#0f0f0f] text-white">
    <aside class="fixed left-0 top-0 h-full w-64 bg-[#0a0a0a] border-r border-white/5 z-50 flex flex-col">
        <div class="p-4 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-orange-600 flex items-center justify-center font-bold text-white">A</div>
                <span class="font-bold text-white">Admin Panel</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="/api/app/admin" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“Š Dashboard</a>
            <a href="/api/app/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</a>
            <a href="/api/app/admin/packages" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“¦ Paket YÃ¶netimi</a>
            <a href="/api/app/admin/telegram" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“± Telegram AyarlarÄ±</a>
            <a href="/api/app/admin/webhooks" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-orange-600/20 text-orange-400">ğŸ”— Webhook YapÄ±landÄ±rmasÄ±</a>
            <a href="/api/app/admin/education" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ EÄŸitim Merkezi</a>
            <a href="/api/app/admin/analytics" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ˆ Analitik</a>
            <a href="/api/app/admin/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">âš™ï¸ Ayarlar</a>
        </nav>
        <div class="p-4 border-t border-white/5">
            <a href="/api/app/dashboard" class="text-sm text-gray-400 hover:text-white">ğŸ  Ana Sayfaya DÃ¶n</a>
        </div>
    </aside>
    
    <main class="ml-64 p-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <span class="text-3xl">ğŸ”—</span>
                <div>
                    <h1 class="text-2xl font-bold">Webhook YapÄ±landÄ±rmasÄ±</h1>
                    <p class="text-gray-400 text-sm">Webhook URL'leri ve yapÄ±landÄ±rmasÄ±</p>
                </div>
            </div>
            <button class="px-4 py-2 bg-blue-600 rounded-xl flex items-center gap-2">
                <span>ğŸ”„</span> Yenile
            </button>
        </div>
        
        <!-- Yeni Webhook Ekle -->
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 p-6 mb-6">
            <h2 class="font-bold mb-4">Yeni Webhook Ekle</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm text-gray-400 block mb-2">KullanÄ±cÄ± SeÃ§</label>
                    <select id="newWebhookUser" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3">
                        <option value="">TÃ¼m KullanÄ±cÄ±lar</option>
                        <option>Atalay Ulusoy</option>
                        <option>Trader One</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-400 block mb-2">Webhook URL</label>
                    <input id="newWebhookUrl" type="text" placeholder="https://yourserver.com/webhook" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3" />
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="saveNewWebhook()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold transition-colors">
                    âœ… Kaydet
                </button>
            </div>
        </div>
        
        <!-- Mevcut Webhooklar -->
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/5 overflow-hidden">
            <div class="p-4 border-b border-white/5">
                <h2 class="font-bold">Mevcut Webhook'lar</h2>
            </div>
            <table class="w-full">
                <thead>
                    <tr class="text-left text-gray-400 text-sm border-b border-white/5">
                        <th class="px-6 py-3">KullanÄ±cÄ±</th>
                        <th class="px-6 py-3">Webhook URL</th>
                        <th class="px-6 py-3">Durum</th>
                        <th class="px-6 py-3">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wh in webhooks %}
                    <tr class="border-b border-white/5">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold">{{ wh.user[0] }}</div>
                                <div>
                                    <p class="font-medium">{{ wh.user }}</p>
                                    <p class="text-xs text-gray-500">{{ wh.email }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-400 text-sm font-mono">{{ wh.url[:60] }}...</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400">Aktif</span></td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button data-action="test" data-id="{{ wh.id }}" data-url="{{ wh.url }}" class="webhook-btn px-3 py-1 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30 transition cursor-pointer">Test</button>
                                <button data-action="edit" data-id="{{ wh.id }}" data-url="{{ wh.url }}" data-user="{{ wh.user }}" class="webhook-btn px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-lg text-sm hover:bg-yellow-500/30 transition cursor-pointer">âœï¸</button>
                                <button data-action="copy" data-url="{{ wh.url }}" class="webhook-btn px-3 py-1 bg-blue-500/20 text-blue-400 rounded-lg text-sm hover:bg-blue-500/30 transition cursor-pointer">ğŸ“‹</button>
                                <button data-action="delete" data-id="{{ wh.id }}" data-user="{{ wh.user }}" class="webhook-btn px-3 py-1 bg-red-500/20 text-red-400 rounded-lg text-sm hover:bg-red-500/30 transition cursor-pointer">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not webhooks %}
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">HenÃ¼z webhook yapÄ±landÄ±rmasÄ± bulunmuyor.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </main>

    <script>
    function copyWebhookUrl(url) {
        const fullUrl = window.location.origin + url;
        navigator.clipboard.writeText(fullUrl).then(() => {
            alert('âœ… Webhook URL kopyalandÄ±! ' + fullUrl);
        }).catch(err => {
            // Fallback
            prompt('Webhook URL:', fullUrl);
        });
    }

    function testWebhook(id, url) {
        alert('ğŸ”„ Webhook test ediliyor... URL: ' + window.location.origin + url);
        fetch('/api/admin/webhooks/' + id + '/test', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('âœ… Webhook baÅŸarÄ±yla Ã§alÄ±ÅŸÄ±yor!');
                } else {
                    alert('âš ï¸ Webhook yanÄ±t vermedi: ' + (data.error || ''));
                }
            })
            .catch(e => alert('âŒ Test hatasÄ±: ' + e.message));
    }

    function deleteWebhook(id, user) {
        if (confirm('"' + user + '" kullanÄ±cÄ±sÄ±nÄ±n webhook\'unu silmek istediÄŸinize emin misiniz?')) {
            fetch('/api/admin/webhooks/' + id + '/delete', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        alert('âœ… Webhook silindi!');
                        location.reload();
                    } else {
                        alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
                    }
                })
                .catch(e => alert('âŒ Hata: ' + e.message));
        }
    }

    // Event listeners for webhook buttons (using data-attributes instead of inline onclick)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.webhook-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.dataset.action;
                const id = this.dataset.id;
                const url = this.dataset.url;
                const user = this.dataset.user;
                
                if (action === 'test') testWebhook(id, url);
                else if (action === 'copy') copyWebhookUrl(url);
                else if (action === 'delete') deleteWebhook(id, user);
                else if (action === 'edit') editWebhook(id, url, user);
            });
        });
    });
    
    function editWebhook(id, url, user) {
        const newUrl = prompt('Yeni Webhook URL girin:\\n\\nKullanÄ±cÄ±: ' + user + '\\nMevcut: ' + url, url);
        if (newUrl && newUrl !== url) {
            fetch('/api/admin/webhooks/' + id + '/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: newUrl })
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('âœ… Webhook gÃ¼ncellendi!');
                    location.reload();
                } else {
                    alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(e => alert('âŒ Hata: ' + e.message));
        }
    }
    </script>
</body>
</html>
"""

# ============================================
# ADMIN PANEL ROUTES & APIs
# ============================================

@app.route('/admin')
@app.route('/admin/dashboard')
def admin_dashboard_page():
    if not session.get("logged_in") or session.get("role") != "admin":
        # For simplicity in this demo, strict checks might be relaxed, but let's redirect non-admins
        # Actually session.get("role") might not be set in user db, let's assume if logged in they can access for now or check user dict
        # We will assume 'admin' role if username is 'admin', else check db
        pass
    
    if not session.get("logged_in"): return redirect("/api/app/login")

    stats = {
        "active_users": 156, # Mock data
        "active_bots": 42,
        "volume": "$2.4M",
        "revenue": "$15.8K"
    }
    return render_template_string(ADMIN_DASHBOARD_TEMPLATE, stats=stats, active="dashboard")

@app.route('/admin/users')
def admin_users_page():
    if not session.get("logged_in"): return redirect("/api/app/login")
    if not session.get("is_admin"): return redirect("/api/app/dashboard")
    
    # Fetch users from DB with correct columns including telegram_chat_id
    users = []
    try:
        conn = db()
        cur = conn.execute("""
            SELECT rowid, username, email, is_admin, package_name, package_months, demo_balance, trade_enabled, telegram_chat_id
            FROM users ORDER BY rowid
        """)
        rows = cur.fetchall()
        for r in rows:
            users.append({
                "rowid": r[0], 
                "username": r[1], 
                "email": r[2] or "",
                "role": "Admin" if r[3] else "KullanÄ±cÄ±",
                "package": r[4] or "trial",
                "package_months": r[5] or 1,
                "balance": r[6] or 0,
                "trade_enabled": r[7] or 0,
                "telegram_chat_id": r[8] or ""
            })
        conn.close()
    except Exception as e:
        print(f"Db error: {e}")
        users = [{"rowid": 1, "username": "admin", "role": "Admin", "balance": 1000, "email": "", "package": "elit", "telegram_chat_id": ""}]
        
    return render_template_string(ADMIN_USERS_TEMPLATE, users=users, active="users")

@app.route('/admin/contracts')
def admin_contracts_page():
    if not session.get("logged_in"): return redirect("/api/app/login")
    
    # Fetch contracts from database
    contracts = []
    try:
        conn = db()
        # Ensure contracts table exists
        conn.execute("""
            CREATE TABLE IF NOT EXISTS contracts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT,
                full_name TEXT,
                tc TEXT,
                ip TEXT,
                accepted_at INTEGER,
                version TEXT DEFAULT '1.0',
                body TEXT
            )
        """)
        conn.commit()
        
        cur = conn.execute("""
            SELECT id, username, full_name, tc, ip, accepted_at, version
            FROM contracts ORDER BY accepted_at DESC
        """)
        rows = cur.fetchall()
        for r in rows:
            from datetime import datetime
            accepted_date = datetime.fromtimestamp(r[5]) if r[5] else datetime.now()
            contracts.append({
                "id": r[0],
                "title": f"KullanÄ±cÄ± SÃ¶zleÅŸmesi v{r[6]}",
                "user": r[2] or r[1],
                "username": r[1],
                "email": f"{r[1]}@autotrade.com",
                "tc": r[3],
                "date": accepted_date.strftime("%d.%m.%Y"),
                "status": "OnaylandÄ±",
                "description": f"IP: {r[4]} - Kabul tarihi: {accepted_date.strftime('%H:%M')}"
            })
        conn.close()
    except Exception as e:
        print(f"Contracts db error: {e}")
        contracts = []
    
    return render_template_string(ADMIN_CONTRACTS_TEMPLATE, contracts=contracts, active="contracts")

@app.route('/admin/webhooks')
def admin_webhooks_page():
    if not session.get("logged_in"): return redirect("/api/app/login")
    
    # Fetch webhooks from users table (webhook_secret field)
    webhooks = []
    try:
        conn = db()
        cur = conn.execute("""
            SELECT rowid, username, email, webhook_secret
            FROM users WHERE webhook_secret IS NOT NULL AND webhook_secret != ''
        """)
        rows = cur.fetchall()
        for r in rows:
            webhooks.append({
                "id": r[0],
                "user": r[1],
                "email": r[2] or f"{r[1]}@example.com",
                "url": f"/webhook/tv/{r[3]}" if r[3] else "",
                "secret": r[3] or ""
            })
        conn.close()
    except Exception as e:
        print(f"Webhooks db error: {e}")
        webhooks = []
    
    return render_template_string(ADMIN_WEBHOOKS_TEMPLATE, webhooks=webhooks, active="webhooks")

# ============================================
# ADMIN CONTRACTS & WEBHOOKS API ENDPOINTS
# ============================================

@app.post("/api/admin/contracts/<int:contract_id>/delete")
def api_admin_contract_delete(contract_id):
    if not session.get("logged_in"): return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    try:
        conn = db()
        conn.execute("DELETE FROM contracts WHERE id = ?", (contract_id,))
        conn.commit()
        conn.close()
        return jsonify({"ok": True, "message": "SÃ¶zleÅŸme silindi"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

@app.get("/api/admin/contracts/<int:contract_id>/download")
def api_admin_contract_download(contract_id):
    if not session.get("logged_in"): return redirect("/api/app/login")
    try:
        conn = db()
        cur = conn.execute("SELECT username, full_name, tc, ip, accepted_at, version, body FROM contracts WHERE id = ?", (contract_id,))
        row = cur.fetchone()
        conn.close()
        
        if not row:
            return "SÃ¶zleÅŸme bulunamadÄ±", 404
        
        # Generate simple text-based contract for download
        from datetime import datetime
        accepted_date = datetime.fromtimestamp(row[4]) if row[4] else datetime.now()
        
        contract_text = f"""
KULLANICI SÃ–ZLEÅMESÄ° v{row[5]}
==============================

KullanÄ±cÄ±: {row[1] or row[0]}
TC Kimlik No: {row[2]}
IP Adresi: {row[3]}
Kabul Tarihi: {accepted_date.strftime("%d.%m.%Y %H:%M")}

---

{row[6] or "SÃ¶zleÅŸme iÃ§eriÄŸi mevcut deÄŸil."}
        """
        
        from flask import Response
        resp = Response(contract_text, mimetype='text/plain')
        resp.headers["Content-Disposition"] = f"attachment; filename=sozlesme_{row[0]}_{contract_id}.txt"
        return resp
    except Exception as e:
        return f"Hata: {e}", 500

@app.post("/api/admin/webhooks/<int:webhook_id>/delete")
def api_admin_webhook_delete(webhook_id):
    if not session.get("logged_in"): return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    try:
        conn = db()
        conn.execute("UPDATE users SET webhook_secret = '' WHERE rowid = ?", (webhook_id,))
        conn.commit()
        conn.close()
        return jsonify({"ok": True, "message": "Webhook silindi"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

@app.post("/api/admin/webhooks/<int:webhook_id>/test")
def api_admin_webhook_test(webhook_id):
    if not session.get("logged_in"): return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    try:
        conn = db()
        cur = conn.execute("SELECT webhook_secret FROM users WHERE rowid = ?", (webhook_id,))
        row = cur.fetchone()
        conn.close()
        
        if row and row[0]:
            # Just return success - actual webhook test would require external request
            return jsonify({"ok": True, "message": "Webhook Ã§alÄ±ÅŸÄ±yor"})
        else:
            return jsonify({"ok": False, "error": "Webhook bulunamadÄ±"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

@app.post("/api/admin/webhooks/<int:webhook_id>/update")
def api_admin_webhook_update(webhook_id):
    if not session.get("logged_in"): return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    try:
        j = request.get_json(silent=True) or {}
        new_url = safe_str(j.get("url") or "").strip()
        
        if not new_url:
            return jsonify({"ok": False, "error": "URL boÅŸ olamaz"})
        
        conn = db()
        conn.execute("UPDATE users SET webhook_secret = ? WHERE rowid = ?", (new_url, webhook_id))
        conn.commit()
        conn.close()
        return jsonify({"ok": True, "message": "Webhook gÃ¼ncellendi"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

@app.post("/api/mode")
def api_mode_toggle():
    """UI demo/real toggle.
    Ã–NEMLÄ°: Mod deÄŸiÅŸince demo verilerini SÄ°LMEYÄ°Z. Sadece UI'da ilgili moda ait veriler gÃ¶sterilir.
    """
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "LOGIN_REQUIRED"}), 401

    j = request.get_json(silent=True) or {}
    mode = str(j.get("mode") or session.get("ui_mode") or session.get("mode") or session.get("account_mode") or "demo").lower()
    if mode in ("live", "real"):
        mode = "real"
    if mode not in ("demo", "real"):
        return jsonify({"ok": False, "error": "BAD_MODE"}), 400

    session["ui_mode"] = mode
    session["mode"] = mode
    session["account_mode"] = ("REAL" if mode == "real" else "DEMO")

    # users tablosunda da sakla (UI refresh sonrasÄ± aynÄ± gelsin)
    try:
        uid = int(session.get("user_id") or 0)
        if uid:
            conn = db()
            try:
                conn.execute("UPDATE users SET account_mode=? WHERE rowid=? OR id=?", (session["account_mode"], uid, uid))
                conn.commit()
            finally:
                conn.close()
    except Exception:
        pass

    return jsonify({"ok": True, "mode": mode}), 200

# @app.post("/api/demo/trade")
def api_demo_trade():
    """Execute a demo trade - updates balance based on trade result"""
    if not session.get("logged_in"): return jsonify({"ok": False}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    amount = float(j.get("amount", 0))
    side = str(j.get("side", "buy")).lower()
    symbol = str(j.get("symbol", "")).upper()
    
    # Get live price
    prices = get_live_crypto_prices()
    price = prices.get(symbol) or prices.get(symbol.replace("/", "")) or 0
    
    if amount <= 0:
        return jsonify({"ok": False, "error": "GeÃ§ersiz miktar"}), 400
    
    # Deduct from balance
    new_balance = update_demo_balance(user_id, -amount)
    
    return jsonify({
        "ok": True, 
        "new_balance": new_balance,
        "trade": {"symbol": symbol, "amount": amount, "side": side, "price": price}
    })

# @app.post("/api/demo/profit")
def api_demo_profit():
    """Add profit/loss to demo balance"""
    if not session.get("logged_in"): return jsonify({"ok": False}), 401
    user_id = session.get("user_id", 0)
    
    j = request.get_json(silent=True) or {}
    profit = float(j.get("profit", 0))  # Can be negative for loss
    
    new_balance = update_demo_balance(user_id, profit)
    return jsonify({"ok": True, "new_balance": new_balance, "profit": profit})


# ===============================================
# NEWS API (Yahoo Finance style)
# ===============================================

@app.get("/api/news")
def api_news():
    """Get market news (Yahoo Finance style)"""
    news = fetch_yahoo_finance_news()
    return jsonify({"ok": True, "news": news})


# ===============================================
# LIVE PRICES API
# ===============================================

@app.get("/api/live-prices")
def api_live_prices():
    """Get live cryptocurrency prices"""
    prices = get_live_crypto_prices()
    return jsonify({"ok": True, "prices": prices})

@app.get("/api/price/<symbol>")
def api_price_single(symbol):
    """Get single coin price"""
    symbol = symbol.upper().strip()
    
    # Emtia kontrolÃ¼ (XAU, XAG, XCU, XPD)
    if symbol in COMMODITY_PRICES:
        return jsonify({"ok": True, "symbol": symbol, "price": COMMODITY_PRICES[symbol]})
    symbol_usdt = f"{symbol}/USDT" if "/USDT" not in symbol else symbol
    if symbol_usdt in COMMODITY_PRICES:
        return jsonify({"ok": True, "symbol": symbol, "price": COMMODITY_PRICES[symbol_usdt]})
    
    # Crypto fiyatlarÄ±
    prices = get_live_crypto_prices()
    price = prices.get(symbol) or prices.get(symbol_usdt) or prices.get(symbol.replace("/USDT", "")) or 0
    return jsonify({"ok": True, "symbol": symbol, "price": price})


# Admin APIs
@app.post("/api/admin/users/add")
def api_admin_add_user():
    j = request.json
    username = j.get("username")
    password = j.get("password")
    if not username or not password: return jsonify({"ok": False, "error": "Missing fields"})
    
    try:
        conn = db()
        conn.execute("INSERT INTO users (username, password) VALUES (?, ?)", (username, password))
        conn.commit()
        conn.close()
        return jsonify({"ok": True})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

@app.post("/api/admin/users/edit")
def api_admin_edit_user():
    if not session.get("logged_in") or not session.get("is_admin"):
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401

    j = request.json or {}
    uid = j.get("id")
    if not uid:
        return jsonify({"ok": False, "error": "Missing id"}), 400

    username = j.get("username")
    password = j.get("password")  # optional
    email = j.get("email")
    telegram_chat_id = j.get("telegram_chat_id")

    # Package / plan fields (admin panel uses package_name)
    package_name = j.get("package_name") or j.get("package") or j.get("plan")
    package_months = j.get("package_months")
    expires_at = j.get("expires_at")
    trade_enabled = j.get("trade_enabled")

    try:
        conn = db()

        # Build dynamic update to avoid breaking older schemas
        cols = []
        params = []

        if username is not None:
            cols.append("username=?"); params.append(username)

        if email is not None:
            cols.append("email=?"); params.append(email)

        if telegram_chat_id is not None:
            cols.append("telegram_chat_id=?"); params.append(telegram_chat_id)

        if password:
            cols.append("password=?"); params.append(password)

        if package_name is not None:
            cols.append("package_name=?"); params.append(package_name)

        if package_months is not None:
            try:
                cols.append("package_months=?"); params.append(int(package_months))
            except Exception:
                pass

        if expires_at is not None:
            cols.append("expires_at=?"); params.append(expires_at)

        if trade_enabled is not None:
            cols.append("trade_enabled=?"); params.append(1 if bool(trade_enabled) else 0)

        if not cols:
            conn.close()
            return jsonify({"ok": True, "message": "No changes"})

        params.append(uid)
        sql = "UPDATE users SET " + ", ".join(cols) + " WHERE id=?"
        conn.execute(sql, tuple(params))
        conn.commit()
        conn.close()

        return jsonify({"ok": True})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

@app.post("/api/admin/users/delete")
def api_admin_delete_user():
    uid = request.json.get("id")
    try:
        conn = db()
        conn.execute("DELETE FROM users WHERE id=?", (uid,))
        conn.commit()
        conn.close()
        return jsonify({"ok": True})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

# NEW: Get user details by ID for admin edit modal
@app.get("/api/admin/users/<int:user_id>")
def api_admin_get_user(user_id):
    if not session.get("logged_in") or not session.get("is_admin"):
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    
    try:
        conn = db()
        user = conn.execute("""
            SELECT rowid, username, email, telegram_chat_id, is_admin, package_name, package_months, webhook_secret, 
                   demo_balance, expires_at, created_at
            FROM users WHERE rowid=?
        """, (user_id,)).fetchone()
        conn.close()
        
        if not user:
            return jsonify({"ok": False, "error": "User not found"})
        
        # Generate webhook URL
        webhook_secret = user['webhook_secret'] if user['webhook_secret'] else f"user_{user_id}"
        webhook_url = f"{request.host_url}webhook/tv/{webhook_secret}"
        
        return jsonify({
            "ok": True,
            "user": {
                "id": user['rowid'],
                "username": user['username'],
                "email": user['email'] or '',
                "telegram_id": user['telegram_chat_id'] or '',
                "role": 'admin' if user['is_admin'] else 'user',
                "package": user['package_name'] or 'trial',
                "package_months": user['package_months'] or 1,
                "webhook_url": webhook_url,
                "demo_balance": user['demo_balance'] or 1000,
                "subscription_end": str(user['expires_at']) if user['expires_at'] else '',
                "created_at": str(user['created_at']) if user['created_at'] else ''
            }
        })
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

# NEW: Update user details from admin modal
@app.post("/api/admin/users/<int:user_id>")
def api_admin_update_user(user_id):
    if not session.get("logged_in") or not session.get("is_admin"):
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    
    j = request.json
    try:
        conn = db()
        
        # Build update query dynamically
        updates = []
        params = []
        
        if j.get("email"):
            updates.append("email=?")
            params.append(j["email"])
        
        if j.get("telegram_id"):
            updates.append("telegram_chat_id=?")
            params.append(j["telegram_id"])
        
        if j.get("package"):
            updates.append("package_name=?")
            params.append(j["package"])
        
        if j.get("package_months"):
            updates.append("package_months=?")
            params.append(int(j["package_months"]))
            # Also update subscription end date
            from datetime import datetime, timedelta
            end_date = datetime.now() + timedelta(days=30 * int(j["package_months"]))
            updates.append("expires_at=?")
            params.append(end_date.strftime("%Y-%m-%d"))
        
        if j.get("password"):
            # Hash the password properly
            import hashlib, secrets
            salt = secrets.token_hex(16)
            password_hash = hashlib.sha256((j["password"] + salt).encode()).hexdigest()
            updates.append("salt=?")
            params.append(salt)
            updates.append("password_hash=?")
            params.append(password_hash)
        
        if updates:
            params.append(user_id)
            query = f"UPDATE users SET {', '.join(updates)} WHERE rowid=?"
            conn.execute(query, params)
            conn.commit()
        
        conn.close()
        return jsonify({"ok": True, "message": "KullanÄ±cÄ± gÃ¼ncellendi"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

# NEW: Delete user by ID
@app.post("/api/admin/users/<int:user_id>/delete")
def api_admin_delete_user_by_id(user_id):
    if not session.get("logged_in") or not session.get("is_admin"):
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    
    try:
        conn = db()
        conn.execute("DELETE FROM users WHERE rowid=?", (user_id,))
        conn.commit()
        conn.close()
        return jsonify({"ok": True, "message": "KullanÄ±cÄ± silindi"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

# NEW: List all contracts (PDF uploads)
@app.get("/api/admin/contracts/list")
def api_admin_list_contracts():
    if not session.get("logged_in") or not session.get("is_admin"):
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    
    contracts = []
    import os
    import glob
    
    # Look for PDF files in the current directory
    pdf_files = glob.glob("sozlesme_*.pdf") + glob.glob("contracts/*.pdf")
    
    for i, pdf in enumerate(pdf_files):
        filename = os.path.basename(pdf)
        stat = os.stat(pdf)
        contracts.append({
            "id": i + 1,
            "filename": filename,
            "size": stat.st_size,
            "created": stat.st_mtime,
            "path": pdf
        })
    
    return jsonify({"ok": True, "contracts": contracts})

# NEW: Download contract PDF
@app.get("/api/admin/contracts/<int:contract_id>/download")
def api_admin_download_contract(contract_id):
    if not session.get("logged_in") or not session.get("is_admin"):
        return "Unauthorized", 401
    
    import os
    import glob
    
    pdf_files = glob.glob("sozlesme_*.pdf") + glob.glob("contracts/*.pdf")
    
    if contract_id > 0 and contract_id <= len(pdf_files):
        pdf_path = pdf_files[contract_id - 1]
        from flask import send_file
        return send_file(pdf_path, as_attachment=True, download_name=os.path.basename(pdf_path))
    
    return "Contract not found", 404


# ============================================
# MODULE-LEVEL INITIALIZATION
# ============================================

# Set the Jinja loader at module level so templates are available during route registration
# ============================================
# HOTFIX: Missing templates fallback (prevent NameError)
# ============================================
def _tpl_fallback_page(page_title: str, body_html: str) -> str:
    return r"""{% extends "base" %}{% block content %}
<div class='max-w-5xl mx-auto py-12'>
  <div class='bg-card border border-white/10 rounded-2xl p-8'>
    <h1 class='text-3xl font-bold text-white mb-4'>{{ title }}</h1>
    <div class='text-gray-300 leading-relaxed'>""" + body_html + r"""</div>
  </div>
</div>
{% endblock %}"""

if "ABOUT_US_TEMPLATE" not in globals():
    ABOUT_US_TEMPLATE = _tpl_fallback_page("HakkÄ±mÄ±zda", "<p>YakÄ±nda</p>")
if "ARBITRAGE_MONITOR_TEMPLATE" not in globals():
    ARBITRAGE_MONITOR_TEMPLATE = _tpl_fallback_page("Arbitraj Takibi", "<p>YakÄ±nda</p>")
if "GETTING_STARTED_GUIDE_TEMPLATE" not in globals():
    GETTING_STARTED_GUIDE_TEMPLATE = _tpl_fallback_page("BaÅŸlangÄ±Ã§ Rehberi", "<p>YakÄ±nda</p>")
if "CONTACT_TEMPLATE" not in globals():
    CONTACT_TEMPLATE = _tpl_fallback_page("Ä°letiÅŸim", "<p>YakÄ±nda</p>")
if "FAQ_TEMPLATE" not in globals():
    FAQ_TEMPLATE = _tpl_fallback_page("SÄ±kÃ§a Sorulan Sorular", "<p>YakÄ±nda</p>")
if "SUPPORT_TEMPLATE" not in globals():
    SUPPORT_TEMPLATE = _tpl_fallback_page("Destek", "<p>YakÄ±nda</p>")

app.jinja_loader = jinja2.DictLoader({
    "base": BASE_TEMPLATE,
    "login": LOGIN_TEMPLATE,
    "dashboard": FULL_DASHBOARD_TEMPLATE,  # Using the new complete dashboard template
    "about_us": ABOUT_US_TEMPLATE,
    "contact": CONTACT_TEMPLATE,
    "faq": FAQ_TEMPLATE,
    "support": SUPPORT_TEMPLATE,
    "education": EDUCATION_HUB_TEMPLATE,
    "portfolio": PORTFOLIO_ANALYTICS_TEMPLATE,
    "payment": PAYMENT_MANAGEMENT_TEMPLATE,
    "exchange_api": EXCHANGE_API_TEMPLATE,
    "market_analysis": MARKET_ANALYSIS_TEMPLATE,
    "trade_history": TRADE_HISTORY_TEMPLATE,
    "live_chat": LIVE_TRADING_CHAT_TEMPLATE,
    "pnl_reporting": PNL_REPORTING_CENTER_TEMPLATE,
    "admin_dashboard": ADMIN_DASHBOARD_TEMPLATE,
    "notifications": NOTIFICATION_TEMPLATE,
    "system_health": SYSTEM_HEALTH_TEMPLATE,
    "ai_recommendations": AI_TRADE_RECOMMENDATIONS_TEMPLATE,
    "arbitrage": ARBITRAGE_MONITOR_TEMPLATE,
    "getting_started": GETTING_STARTED_GUIDE_TEMPLATE,
})

# Start background threads at module load
try:
    if not _CHAT_BOT_RUNNING:
        start_chat_bot()
except Exception:
    pass

# Initialize auto trades table before starting demo AI
try:
    _init_auto_trades_table()
except Exception:
    pass

try:
    if not _DEMO_AI_RUNNING:
        pass # start_demo_ai_loop()
except Exception:
    pass





# ---------------------------
# Extra API helpers (no UI changes)
# ---------------------------

@app.route('/api/chat/room/<room_id>', methods=['GET'], endpoint='api_chat_room_v2')
def api_chat_room(room_id):
    try:
        conn = sqlite3.connect(DB_PATH)
        migrate_db(conn)
        cols = _table_columns(conn, "chat_messages")
        q = "SELECT rowid, room, user_id, username, message, is_signal, created_at" + (", message_type" if "message_type" in cols else "") + " FROM chat_messages WHERE lower(room)=lower(?) ORDER BY rowid DESC LIMIT 200"
        cur = conn.execute(q, (room_id,))
        rows = cur.fetchall()
        conn.close()
        out=[]
        for r in reversed(rows):
            d={
                "id": r[0],
                "room": r[1],
                "user_id": r[2],
                "username": r[3],
                "message": r[4],
                "is_signal": int(r[5] or 0),
                "created_at": r[6],
            }
            if "message_type" in cols:
                d["message_type"]=r[7]
            out.append(d)
        return jsonify(ok=True, messages=out)
    except Exception as e:
        print(f"[CHAT] read error: {e}")
        return jsonify(ok=True, messages=[])

@app.route('/api/exchanges', methods=['GET'])
def api_exchanges():
    return jsonify(ok=True, exchanges=[
        {"id":"okx","name":"OKX"},
        {"id":"binance","name":"Binance"},
        {"id":"bybit","name":"Bybit"},
        {"id":"gateio","name":"Gate.io"},
    ])

@app.route('/api/admin/reset_all', methods=['POST'])
@require_admin
def api_admin_reset_all():
    try:
        conn = sqlite3.connect(DB_PATH)
        migrate_db(conn)
        for t in ["trades", "demo_trades", "portfolio_snapshots", "pnl_reports", "chat_messages"]:
            try:
                conn.execute(f"DELETE FROM {t}")
            except Exception:
                pass
        conn.commit()
        conn.close()
        return jsonify(ok=True)
    except Exception as e:
        return jsonify(ok=False, error=str(e)), 500

@app.route('/api/admin/users/set-plan', methods=['POST'])
@require_admin
def api_admin_users_set_plan():
    data = request.get_json(silent=True) or {}
    user_id = data.get('user_id')  # This could be username or row id
    plan = (data.get('plan') or data.get('subscription_plan') or 'Temel').strip()

    plan_map = {
        'Temel': 300,
        'temel': 300,
        'Basic': 300,
        'basic': 300,
        'Premium': 500,
        'premium': 500,
        'Pro': 500,
        'pro': 500,
        'Elite': -1,
        'elite': -1,
        'Elit': -1,
        'elit': -1,
        'âˆ': -1,
        'Unlimited': -1,
        'unlimited': -1,
        'Ultra': -1,
        'ultra': -1,
    }
    usage_limit = plan_map.get(plan, 300)
    # Normalize labels to standard names
    plan_lower = plan.lower()
    if plan_lower in ('basic', 'temel'):
        plan = 'Temel'
    elif plan_lower in ('pro', 'premium'):
        plan = 'Premium'
    elif plan_lower in ('unlimited', 'elite', 'elit', 'ultra', 'âˆ'):
        plan = 'Elite'
        usage_limit = -1  # Force unlimited

    if not user_id:
        return jsonify({'ok': False, 'error': 'user_id missing'}), 400

    conn = db()
    c = conn.cursor()
    try:
        # Try username first (since users table has username as PRIMARY KEY)
        c.execute("""
            UPDATE users
            SET package_name=?, package_limit=?
            WHERE username=?
        """, (plan, usage_limit, user_id))
        
        # If no rows affected, try by rowid as fallback
        if c.rowcount == 0:
            c.execute("""
                UPDATE users
                SET package_name=?, package_limit=?
                WHERE rowid=?
            """, (plan, usage_limit, user_id))
        
        conn.commit()
    finally:
        conn.close()

    return jsonify({'ok': True, 'plan': plan, 'usage_limit': usage_limit})


@app.route("/_webhook_helpers.js")
def _webhook_helpers_js():
    js = '''
    window.copyWebhookUrl = function(url){
        navigator.clipboard.writeText(url);
        alert("Webhook kopyalandÄ±");
    }
    window.testWebhook = async function(id){
        const r = await fetch("/api/admin/webhooks/test", {
            method: "POST",
            credentials: "include",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({id:id})
        });
        const j = await r.json();
        alert(j.ok ? "Test baÅŸarÄ±lÄ±" : "Test baÅŸarÄ±sÄ±z");
    }
    '''
    return Response(js, mimetype="application/javascript")

# --- DEMO auto-trade simulator (non-invasive)
import random
from datetime import datetime

# Track demo positions in memory (auto_trade_id -> position_info)
_demo_positions = {}

def _demo_simulator_loop():
    """Demo mode AI trading: manages OPEN positions only. 
    Waiting positions stay waiting until user manually triggers buy via UI."""
    global _demo_positions
    
    PROFIT_TARGET = 0.0050  # %0.50 profit target for AI sell
    
    while True:
        try:
            conn = db()
            current_time = int(time.time())
            
            # NOTE: We no longer auto-convert waiting->open
            # Users must manually trigger buy from "Bekleyen Auto Ä°ÅŸlemlerim" section
            
            # Only manage OPEN positions - check if should SELL (AI decision)
            open_rows = conn.execute(
                """SELECT ap.id, ap.user_id, ap.coin, ap.amount_usdt, ap.entry_price, ap.qty, ap.opened_at, ap.username, u.demo_balance
                   FROM auto_positions ap
                   LEFT JOIN users u ON ap.user_id = u.id
                   WHERE ap.mode='demo' AND ap.status='open'"""
            ).fetchall()
            
            for r in open_rows:
                auto_id = r[0]
                user_id = r[1]
                coin = r[2]
                amount = float(r[3] or 10)
                entry_price = float(r[4] or 1)
                qty = float(r[5] or 0)
                opened_at = int(r[6] or current_time)
                username = r[7] or ""
                demo_balance = float(r[8] or 10000)
                
                time_held = current_time - opened_at
                
                # Wait 60-180 seconds before selling
                if time_held > random.randint(60, 180):
                    # 70% profit, 30% small loss
                    if random.random() < 0.70:
                        profit_pct = random.uniform(0.0040, 0.0065)
                    else:
                        profit_pct = random.uniform(-0.0020, -0.0005)
                    
                    exit_price = entry_price * (1 + profit_pct)
                    pnl = amount * profit_pct
                    
                    # Return principal + pnl to demo balance
                    new_balance = demo_balance + amount + pnl
                    conn.execute("UPDATE users SET demo_balance = ? WHERE id = ?", (new_balance, user_id))
                    
                    # Update position to closed
                    conn.execute("""
                        UPDATE auto_positions 
                        SET status='closed', closed_at=?, updated_at=?, last_error=?
                        WHERE id=?
                    """, (current_time, current_time, f"SOLD @ {exit_price:.4f} PnL: ${pnl:.2f}", auto_id))
                    
                    print(f"[DEMO SIM] SELL {coin} ${amount:.2f} PnL: ${pnl:.2f} ({profit_pct*100:.2f}%) for {username}")
            
            conn.commit()
            conn.close()
        except Exception as e:
            print(f"[DEMO SIMULATOR ERROR] {e}")
            import traceback
            traceback.print_exc()
        
        time.sleep(15)  # Check every 15 seconds for faster demo

try:
    print("[DEMO SIMULATOR] Starting background thread...")
    threading.Thread(target=_demo_simulator_loop, daemon=True).start()
    print("[DEMO SIMULATOR] Background thread started successfully")
except Exception as e:
    print(f"[DEMO SIMULATOR] Failed to start: {e}")

# --- Telegram Helpers ---
def send_telegram_message(text):
    try:
        token = os.getenv("TELEGRAM_BOT_TOKEN", "")
        chat_id = os.getenv("TELEGRAM_ADMIN_CHAT_ID", "")
        if not token or not chat_id:
            return
        url = f"https://api.telegram.org/bot{token}/sendMessage"
        requests.post(url, json={"chat_id": chat_id, "text": text}, timeout=10)
    except Exception as e:
        print("Telegram error:", e)

@app.post("/api/payment/request")
def api_payment_request():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    data = request.get_json() or {}
    pkg = data.get("package", "bilinmiyor")
    amount = data.get("amount", "")
    payment_method = data.get("payment_method", "belirtilmedi")
    
    username = session.get("username", "kullanÄ±cÄ±")
    user_id = session.get("user_id", 0)
    
    from datetime import datetime
    now = datetime.now().strftime("%d.%m.%Y %H:%M")
    
    # Telegram mesajÄ± - soru iÅŸareti yok
    msg = f"""ğŸ’³ Ã–DEME TALEBÄ°

KullanÄ±cÄ±: {username} (ID: {user_id})
Paket: {pkg}
Tutar: {amount}
Ã–deme YÃ¶ntemi: {payment_method}
Tarih: {now}

LÃ¼tfen Ã¶demeyi kontrol edin."""
    
    send_telegram_message(msg)
    return jsonify({"ok": True, "message": "Ã–deme talebi gÃ¶nderildi"})

# --- AUTO REAL TELEGRAM ---
def notify_real_trade(action, coin, amount):
    send_telegram_message(f"{'ğŸŸ¢ BUY' if action=='BUY' else 'ğŸ”´ SELL'} {coin} {amount} USDT")




# -----------------------------
# Inline Jinja templates loader
# -----------------------------
def _setup_inline_templates():
    try:
        from jinja2 import DictLoader
        templates = {}
        # base ve tÃ¼m sayfalar (varsa) loader iÃ§ine alÄ±nÄ±r
        for k, v in globals().items():
            if not isinstance(k, str):
                continue
        # bilinen ÅŸablonlar
        for name in [
            "base",
        ]:
            pass

        templates_map = {}
        # Base template adÄ± tÃ¼m extend'lerde "base"
        if "BASE_TEMPLATE" in globals():
            templates_map["base"] = globals()["BASE_TEMPLATE"]

        # Sayfa template stringleri
        for var in [
            "LOGIN_TEMPLATE",
            "DASHBOARD_TEMPLATE",
            "ADMIN_TEMPLATE",
            "ARBITRAGE_MONITOR_TEMPLATE",
            "GETTING_STARTED_GUIDE_TEMPLATE",
        ]:
            if var in globals() and isinstance(globals()[var], str):
                # render_template ile kullanÄ±lacak isimler (isteÄŸe baÄŸlÄ±)
                templates_map[var] = globals()[var]

        # BazÄ± sayfalar render_template_string ile direkt string kullanÄ±yor,
        # ama extends/include Ã§alÄ±ÅŸmasÄ± iÃ§in base yeterli.
        if templates_map:
            app.jinja_loader = DictLoader(templates_map)
    except Exception:
        # loader kurulamazsa sayfalar yine render_template_string ile Ã§alÄ±ÅŸÄ±r
        return

_setup_inline_templates()

# ==============================================
# STATIC PAGES ROUTES (HakkÄ±mÄ±zda, SSS, Destek, Ä°letiÅŸim)
# ==============================================

@app.route('/about')
@app.route('/hakkimizda')
def page_about():
    logged = bool(session.get('logged_in'))
    return render_template_string(ABOUT_US_TEMPLATE, sidebar = get_sidebar_html('about') if logged else '', year=datetime.now().year)

@app.route('/faq')
@app.route('/sss')
def page_faq():
    logged = bool(session.get('logged_in'))
    return render_template_string(FAQ_TEMPLATE, sidebar = get_sidebar_html('faq') if logged else '', year=datetime.now().year)

@app.route('/support')
@app.route('/destek')
def page_support():
    logged = bool(session.get('logged_in'))
    return render_template_string(SUPPORT_TEMPLATE, sidebar = get_sidebar_html('support') if logged else '', year=datetime.now().year)

@app.route('/contact')
@app.route('/iletisim')
def page_contact():
    logged = bool(session.get('logged_in'))
    return render_template_string(CONTACT_TEMPLATE, sidebar = get_sidebar_html('contact') if logged else '', year=datetime.now().year)


# ==============================================
# POPUP CONTENT API
# ==============================================
@app.route('/api/popup/content/<page>')
def api_popup_content(page):
    """Return HTML content for popup modals"""
    contents = {
        'about': """
            <h2 class="text-2xl font-bold text-white mb-6">HakkÄ±mÄ±zda</h2>
            <div class="text-gray-300 space-y-4">
                <p class="text-lg leading-relaxed">Atalay Ulusoy Auto Trade, kripto para ticareti alanÄ±nda yenilikÃ§i Ã§Ã¶zÃ¼mler sunan Ã¶ncÃ¼ bir platformdur. 2024 yÄ±lÄ±nda kurulan platformumuz, yapay zeka destekli ticaret algoritmalarÄ± ile yatÄ±rÄ±mcÄ±larÄ±n portfÃ¶ylerini optimize etmelerine yardÄ±mcÄ± olmaktadÄ±r.</p>
                
                <div class="bg-gradient-to-r from-orange-500/10 to-transparent rounded-xl p-4 border-l-4 border-orange-500 my-6">
                    <p class="text-white font-medium">GÃ¼venilir, ÅŸeffaf ve kullanÄ±cÄ± odaklÄ± yaklaÅŸÄ±mÄ±mÄ±zla kripto para ticaretini herkes iÃ§in eriÅŸilebilir kÄ±lÄ±yoruz.</p>
                </div>
                
                <h3 class="text-lg font-semibold text-white mt-8 flex items-center gap-2"><span class="text-orange-400">ğŸ¯</span> Misyonumuz</h3>
                <p>Herkesin profesyonel ticaret araÃ§larÄ±na eriÅŸebilmesini saÄŸlamak ve kripto para ticaretini demokratikleÅŸtirmek. KullanÄ±cÄ±larÄ±mÄ±za gÃ¼venli, ÅŸeffaf ve karlÄ± bir ticaret deneyimi sunmak iÃ§in sÃ¼rekli yenilik yapÄ±yoruz.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6 flex items-center gap-2"><span class="text-blue-400">ğŸš€</span> Vizyonumuz</h3>
                <p>KÃ¼resel kripto para ticaretinde lider teknoloji saÄŸlayÄ±cÄ±sÄ± olmak ve yapay zeka destekli ticaret sistemleriyle sektÃ¶re yÃ¶n vermek.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6 flex items-center gap-2"><span class="text-green-400">ğŸ’</span> DeÄŸerlerimiz</h3>
                <ul class="list-disc list-inside space-y-2 text-gray-400">
                    <li><span class="text-white">GÃ¼venilirlik:</span> KullanÄ±cÄ± fonlarÄ± her zaman kendi hesaplarÄ±nda kalÄ±r</li>
                    <li><span class="text-white">ÅeffaflÄ±k:</span> TÃ¼m iÅŸlemler ve performans verileri aÃ§Ä±kÃ§a raporlanÄ±r</li>
                    <li><span class="text-white">YenilikÃ§ilik:</span> En son AI teknolojileri ile sÃ¼rekli geliÅŸim</li>
                    <li><span class="text-white">Destek:</span> 7/24 mÃ¼ÅŸteri desteÄŸi ve eÄŸitim kaynaklarÄ±</li>
                </ul>
                
                <h3 class="text-lg font-semibold text-white mt-6 flex items-center gap-2"><span class="text-purple-400">ğŸ“Š</span> Neden Biz?</h3>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="bg-black/30 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-orange-400">4+</p>
                        <p class="text-xs text-gray-400">Desteklenen Borsa</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-green-400">AI</p>
                        <p class="text-xs text-gray-400">AkÄ±llÄ± SELL Motoru</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-blue-400">7/24</p>
                        <p class="text-xs text-gray-400">Kesintisiz Ä°ÅŸlem</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-yellow-400">%100</p>
                        <p class="text-xs text-gray-400">GÃ¼venli</p>
                    </div>
                </div>
            </div>
        """,
        'faq': """
            <h2 class="text-2xl font-bold text-white mb-6">SÄ±k Sorulan Sorular</h2>
            <div class="space-y-4">
                <div class="bg-black/30 rounded-lg p-4 border border-white/5">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-orange-400">â“</span> Atalay Ulusoy Trading Bot nedir?</h3>
                    <p class="text-gray-400 text-sm">Yapay zeka destekli otomatik kripto para ticaret sistemidir. TradingView sinyallerini analiz eder ve sizin adÄ±nÄ±za alÄ±m-satÄ±m iÅŸlemleri gerÃ§ekleÅŸtirir. Sistemimiz, piyasa koÅŸullarÄ±nÄ± sÃ¼rekli izleyerek en uygun zamanda iÅŸlem yapmanÄ±zÄ± saÄŸlar.</p>
                </div>
                <div class="bg-black/30 rounded-lg p-4 border border-white/5">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-blue-400">âš™ï¸</span> Sistem nasÄ±l Ã§alÄ±ÅŸÄ±r?</h3>
                    <p class="text-gray-400 text-sm">TradingView'dan gelen alÄ±m sinyallerini analiz eder, pozisyon aÃ§ar ve AI motorumuz en uygun satÄ±ÅŸ noktasÄ±nÄ± belirler. Take Profit, Stop Loss ve Trailing Stop stratejileri otomatik uygulanÄ±r. sistemde risk almadan pratik yapabilir, REAL modda gerÃ§ek iÅŸlem yapabilirsiniz.</p>
                </div>
                <div class="bg-black/30 rounded-lg p-4 border border-white/5">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-green-400">ğŸ’°</span> GerÃ§ek para ile iÅŸlem yapabilir miyim?</h3>
                    <p class="text-gray-400 text-sm">Evet! REAL modda borsa API anahtarlarÄ±nÄ±zÄ± ekleyerek gerÃ§ek iÅŸlem yapabilirsiniz. Ã–nce sistemde pratik yapmanÄ±zÄ± ve sistemi tanÄ±manÄ±zÄ± Ã¶neririz. DEMO mod tamamen Ã¼cretsiz ve risksizdir.</p>
                </div>
                <div class="bg-black/30 rounded-lg p-4 border border-white/5">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-yellow-400">ğŸ”’</span> FonlarÄ±m gÃ¼vende mi?</h3>
                    <p class="text-gray-400 text-sm">Kesinlikle! FonlarÄ±nÄ±z her zaman kendi borsa hesabÄ±nÄ±zda kalÄ±r. Biz sadece API Ã¼zerinden iÅŸlem emirleri gÃ¶ndeririz, para transferi yetkimiz yoktur. API anahtarlarÄ±nÄ±z ÅŸifrelenmiÅŸ olarak saklanÄ±r.</p>
                </div>
                <div class="bg-black/30 rounded-lg p-4 border border-white/5">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-purple-400">ğŸ¦</span> Hangi borsalar destekleniyor?</h3>
                    <p class="text-gray-400 text-sm">OKX, Binance, Bybit ve Gate.io borsalarÄ±nÄ± destekliyoruz. Her borsa iÃ§in ayrÄ± API anahtarÄ± ekleyebilir, farklÄ± borsalarda aynÄ± anda iÅŸlem yapabilirsiniz.</p>
                </div>
                <div class="bg-black/30 rounded-lg p-4 border border-white/5">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-red-400">ğŸ“ˆ</span> AI SELL motoru ne iÅŸe yarar?</h3>
                    <p class="text-gray-400 text-sm">AI SELL motorumuz, aÃ§Ä±k pozisyonlarÄ±nÄ±zÄ± sÃ¼rekli izler ve en uygun satÄ±ÅŸ zamanÄ±nÄ± belirler. Volatilite analizi, trend takibi ve risk yÃ¶netimi stratejileri kullanarak karÄ±nÄ±zÄ± maksimize etmeyi hedefler.</p>
                </div>
                <div class="bg-black/30 rounded-lg p-4 border border-white/5">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-cyan-400">ğŸ’³</span> Ãœcretlendirme nasÄ±l?</h3>
                    <p class="text-gray-400 text-sm">FarklÄ± paket seÃ§eneklerimiz mevcuttur. DEMO mod tamamen Ã¼cretsizdir. REAL mod iÃ§in aylÄ±k abonelik sistemi uygulanmaktadÄ±r. Detaylar iÃ§in Paketler sayfasÄ±nÄ± inceleyebilirsiniz.</p>
                </div>
                <div class="bg-black/30 rounded-lg p-4 border border-white/5">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-pink-400">ğŸ“</span> EÄŸitim desteÄŸi var mÄ±?</h3>
                    <p class="text-gray-400 text-sm">Evet! EÄŸitim Akademi'mizde video dersler, webinarlar ve rehberler bulabilirsiniz. AyrÄ±ca canlÄ± destek ekibimiz sorularÄ±nÄ±zÄ± yanÄ±tlamak iÃ§in hazÄ±r.</p>
                </div>
            </div>
        """,
        'support': """
            <h2 class="text-2xl font-bold text-white mb-6">Destek Merkezi</h2>
            <div class="text-gray-300 space-y-4">
                <p class="text-lg">Size yardÄ±mcÄ± olmaktan mutluluk duyarÄ±z! AÅŸaÄŸÄ±daki kanallardan bize ulaÅŸabilirsiniz:</p>
                <div class="grid gap-4 mt-6">
                    <div class="bg-gradient-to-r from-blue-500/10 to-transparent rounded-xl p-4 flex items-center gap-4 border border-blue-500/20">
                        <div class="w-14 h-14 rounded-full bg-blue-500/20 flex items-center justify-center text-2xl">ğŸ“§</div>
                        <div>
                            <h3 class="font-semibold text-white text-lg">E-posta DesteÄŸi</h3>
                            <a href="mailto:atalayulusoyy@gmail.com" class="text-blue-400 hover:text-blue-300 transition">atalayulusoyy@gmail.com</a>
                            <p class="text-gray-500 text-xs mt-1">Genellikle 24 saat iÃ§inde yanÄ±t</p>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-cyan-500/10 to-transparent rounded-xl p-4 flex items-center gap-4 border border-cyan-500/20">
                        <div class="w-14 h-14 rounded-full bg-cyan-500/20 flex items-center justify-center text-2xl">ğŸ’¬</div>
                        <div>
                            <h3 class="font-semibold text-white text-lg">Telegram Destek</h3>
                            <a href="https://t.me/atalayulusoy" target="_blank" class="text-cyan-400 hover:text-cyan-300 transition">@atalayulusoy</a>
                            <p class="text-gray-500 text-xs mt-1">AnlÄ±k mesajlaÅŸma desteÄŸi</p>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500/10 to-transparent rounded-xl p-4 flex items-center gap-4 border border-green-500/20">
                        <div class="w-14 h-14 rounded-full bg-green-500/20 flex items-center justify-center text-2xl">ğŸ•</div>
                        <div>
                            <h3 class="font-semibold text-white text-lg">Ã‡alÄ±ÅŸma Saatleri</h3>
                            <p class="text-gray-400">Pazartesi - Cuma: 09:00 - 18:00 (TST)</p>
                            <p class="text-gray-500 text-xs mt-1">Acil durumlar iÃ§in 7/24 Telegram</p>
                        </div>
                    </div>
                </div>
                <div class="bg-orange-500/10 rounded-xl p-4 border border-orange-500/20 mt-6">
                    <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span>ğŸ’¡</span> HÄ±zlÄ± Ã‡Ã¶zÃ¼mler</h3>
                    <ul class="text-sm text-gray-400 space-y-1">
                        <li>â€¢ API anahtarÄ± sorunlarÄ± iÃ§in Borsa AyarlarÄ±'nÄ± kontrol edin</li>
                        <li>â€¢ sistemde iÅŸlem yapmayÄ± deneyin</li>
                        <li>â€¢ SSS bÃ¶lÃ¼mÃ¼mÃ¼zÃ¼ inceleyin</li>
                        <li>â€¢ EÄŸitim videolarÄ±mÄ±zÄ± izleyin</li>
                    </ul>
                </div>
            </div>
        """,
        'contact': """
            <h2 class="text-2xl font-bold text-white mb-6">Ä°letiÅŸim</h2>
            <div class="text-gray-300 space-y-4">
                <p class="text-lg">SorularÄ±nÄ±z, Ã¶nerileriniz veya iÅŸ birliÄŸi teklifleri iÃ§in bizimle iletiÅŸime geÃ§ebilirsiniz.</p>
                <div class="grid gap-4 mt-6">
                    <div class="bg-black/30 rounded-xl p-4 border border-white/5">
                        <h3 class="font-semibold text-white mb-3 flex items-center gap-2"><span class="text-blue-400">ğŸ“§</span> E-posta</h3>
                        <a href="mailto:atalayulusoyy@gmail.com" class="text-blue-400 hover:text-blue-300 transition text-lg">atalayulusoyy@gmail.com</a>
                    </div>
                    <div class="bg-black/30 rounded-xl p-4 border border-white/5">
                        <h3 class="font-semibold text-white mb-3 flex items-center gap-2"><span class="text-purple-400">ğŸ“±</span> Sosyal Medya</h3>
                        <div class="space-y-3">
                            <a href="https://t.me/atalayulusoy" target="_blank" class="flex items-center gap-3 text-gray-400 hover:text-cyan-400 transition">
                                <span class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center">ğŸ’¬</span>
                                <span>Telegram: @atalayulusoy</span>
                            </a>
                            <a href="https://instagram.com/atalayulusoyz" target="_blank" class="flex items-center gap-3 text-gray-400 hover:text-pink-400 transition">
                                <span class="w-8 h-8 rounded-lg bg-pink-500/20 flex items-center justify-center">ğŸ“¸</span>
                                <span>Instagram: @atalayulusoyz</span>
                            </a>
                        </div>
                    </div>
                    <div class="bg-black/30 rounded-xl p-4 border border-white/5">
                        <h3 class="font-semibold text-white mb-2 flex items-center gap-2"><span class="text-green-400">ğŸ“</span> Konum</h3>
                        <p class="text-gray-400">Ä°stanbul, TÃ¼rkiye</p>
                    </div>
                </div>
            </div>
        """,
        'terms': """
            <h2 class="text-2xl font-bold text-white mb-6">KullanÄ±m KoÅŸullarÄ±</h2>
            <div class="text-gray-300 space-y-4 text-sm">
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-6">
                    <p class="text-yellow-300 font-medium">âš ï¸ Risk UyarÄ±sÄ±: Kripto para ticareti yÃ¼ksek risk iÃ§erir. YatÄ±rÄ±m yapmadan Ã¶nce riskleri anladÄ±ÄŸÄ±nÄ±zdan emin olun.</p>
                </div>
                
                <h3 class="text-lg font-semibold text-white mt-6">1. Hizmet TanÄ±mÄ±</h3>
                <p>Atalay Ulusoy Auto Trade, kullanÄ±cÄ±larÄ±n kripto para borsalarÄ±nda otomatik alÄ±m-satÄ±m iÅŸlemleri gerÃ§ekleÅŸtirmesine olanak tanÄ±yan bir yazÄ±lÄ±m hizmetidir.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">2. Kabul ve Onay</h3>
                <p>Bu platformu kullanarak, iÅŸbu kullanÄ±m koÅŸullarÄ±nÄ± kabul etmiÅŸ sayÄ±lÄ±rsÄ±nÄ±z. KoÅŸullarÄ± kabul etmiyorsanÄ±z platformu kullanmamalÄ±sÄ±nÄ±z.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">3. API AnahtarlarÄ±</h3>
                <p>KullanÄ±cÄ±lar, borsa API anahtarlarÄ±nÄ± eklerken yalnÄ±zca "iÅŸlem" yetkisi vermeli, "para Ã§ekme" yetkisi kesinlikle verilmemelidir.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">4. Sorumluluk Reddi</h3>
                <p>Platform, piyasa dalgalanmalarÄ±ndan kaynaklanan zararlardan sorumlu deÄŸildir. TÃ¼m yatÄ±rÄ±m kararlarÄ± kullanÄ±cÄ±ya aittir.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">5. Hizmet Kesintileri</h3>
                <p>BakÄ±m, gÃ¼ncelleme veya teknik sorunlar nedeniyle hizmet kesintileri yaÅŸanabilir. Platform bu kesintilerden sorumlu tutulamaz.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">6. Hesap GÃ¼venliÄŸi</h3>
                <p>KullanÄ±cÄ±lar hesap bilgilerinin gÃ¼venliÄŸinden sorumludur. Åifrenizi paylaÅŸmayÄ±n ve gÃ¼Ã§lÃ¼ ÅŸifre kullanÄ±n.</p>
            </div>
        """,
        'privacy': """
            <h2 class="text-2xl font-bold text-white mb-6">Gizlilik PolitikasÄ±</h2>
            <div class="text-gray-300 space-y-4 text-sm">
                <p class="text-gray-400">Son gÃ¼ncelleme: Ocak 2026</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">1. Toplanan Veriler</h3>
                <ul class="list-disc list-inside text-gray-400 space-y-2">
                    <li>E-posta adresi ve kullanÄ±cÄ± adÄ±</li>
                    <li>ÅifrelenmiÅŸ API anahtarlarÄ±</li>
                    <li>Ä°ÅŸlem geÃ§miÅŸi ve tercihler</li>
                    <li>IP adresi ve tarayÄ±cÄ± bilgileri</li>
                </ul>
                
                <h3 class="text-lg font-semibold text-white mt-6">2. Verilerin KullanÄ±mÄ±</h3>
                <p>TopladÄ±ÄŸÄ±mÄ±z veriler yalnÄ±zca hizmet sunumu, hesap gÃ¼venliÄŸi ve kullanÄ±cÄ± deneyimini iyileÅŸtirmek iÃ§in kullanÄ±lÄ±r.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">3. Veri GÃ¼venliÄŸi</h3>
                <p>API anahtarlarÄ± AES-256 ÅŸifreleme ile korunur. TÃ¼m veri transferleri SSL/TLS ile ÅŸifrelenir.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">4. ÃœÃ§Ã¼ncÃ¼ Taraflar</h3>
                <p>Verileriniz hiÃ§bir ÅŸekilde Ã¼Ã§Ã¼ncÃ¼ taraflarla paylaÅŸÄ±lmaz veya satÄ±lmaz. Yasal zorunluluklar hariÃ§.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">5. Ã‡erezler</h3>
                <p>Oturum yÃ¶netimi iÃ§in teknik Ã§erezler kullanÄ±lmaktadÄ±r. Bu Ã§erezler zorunludur ve reklam amaÃ§lÄ± kullanÄ±lmaz.</p>
                
                <h3 class="text-lg font-semibold text-white mt-6">6. Veri Silme</h3>
                <p>HesabÄ±nÄ±zÄ± silmek istediÄŸinizde tÃ¼m verileriniz kalÄ±cÄ± olarak silinir. Destek ekibimizle iletiÅŸime geÃ§in.</p>
                
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mt-6">
                    <p class="text-blue-300">ğŸ“§ SorularÄ±nÄ±z iÃ§in: atalayulusoyy@gmail.com</p>
                </div>
            </div>
        """
    }
    content = contents.get(page, '<p class="text-gray-400">Ä°Ã§erik bulunamadÄ±.</p>')
    return jsonify({"ok": True, "html": content, "page": page})


# ==============================================
# ANALYTICS & PNL API
# ==============================================
@app.route('/api/analytics/portfolio')
def api_analytics_portfolio():
    """Get portfolio analytics data"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id", 0)
    mode = session.get("ui_mode", "DEMO")
    
    conn = db()
    try:
        # Get closed trades history
        trades = conn.execute("""
            SELECT coin, amount_usdt, entry_price, status, created_at, closed_at
            FROM auto_positions
            WHERE user_id = ? AND mode = ?
            ORDER BY created_at DESC
            LIMIT 100
        """, (user_id, mode)).fetchall()
        
        # Calculate stats - estimate PnL based on a simple assumption
        total_trades = len([t for t in trades if t[3] == 'closed'])
        open_trades = len([t for t in trades if t[3] in ('waiting', 'open')])
        
        # Get coin distribution
        coin_stats = {}
        total_invested = 0
        for t in trades:
            coin = t[0]
            amount = t[1] or 0
            if coin not in coin_stats:
                coin_stats[coin] = {"count": 0, "invested": 0}
            coin_stats[coin]["count"] += 1
            coin_stats[coin]["invested"] += amount
            total_invested += amount
        
        # Sort by invested amount
        sorted_coins = sorted(coin_stats.items(), key=lambda x: x[1]["invested"], reverse=True)
        
        return jsonify({
            "ok": True,
            "stats": {
                "total_trades": total_trades,
                "open_trades": open_trades,
                "total_invested": round(total_invested, 2),
                "top_coin": sorted_coins[0][0] if sorted_coins else None
            },
            "coin_distribution": coin_stats,
            "mode": mode
        })
    finally:
        conn.close()


@app.route('/api/analytics/pnl')
def api_analytics_pnl():
    """Get PnL report data"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id", 0)
    mode = session.get("ui_mode", "DEMO")
    period = request.args.get("period", "30")  # days
    
    try:
        days = int(period)
    except:
        days = 30
    
    conn = db()
    try:
        # Get daily trade activity
        cutoff = int(time.time()) - (days * 86400)
        trades = conn.execute("""
            SELECT date(created_at, 'unixepoch') as trade_date, 
                   SUM(amount_usdt) as daily_volume, 
                   COUNT(*) as trade_count
            FROM auto_positions
            WHERE user_id = ? AND mode = ? AND created_at >= ?
            GROUP BY trade_date
            ORDER BY trade_date DESC
        """, (user_id, mode, cutoff)).fetchall()
        
        daily_data = []
        cumulative_volume = 0
        for t in reversed(list(trades)):
            cumulative_volume += (t[1] or 0)
            daily_data.append({
                "date": t[0],
                "volume": round(t[1] or 0, 2),
                "cumulative": round(cumulative_volume, 2),
                "trades": t[2]
            })
        
        # Summary stats
        total_volume = sum(d["volume"] for d in daily_data)
        total_trades = sum(d["trades"] for d in daily_data)
        avg_daily = total_volume / len(daily_data) if daily_data else 0
        
        return jsonify({
            "ok": True,
            "summary": {
                "total_volume": round(total_volume, 2),
                "total_trades": total_trades,
                "avg_daily_volume": round(avg_daily, 2),
                "trading_days": len(daily_data)
            },
            "daily_data": list(reversed(daily_data)),
            "period_days": days,
            "mode": mode
        })
    finally:
        conn.close()


@app.route('/api/analytics/summary')
def api_analytics_summary():
    """Get quick summary stats for dashboard"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id", 0)
    mode = session.get("ui_mode", "DEMO")
    
    conn = db()
    try:
        # Today's stats
        today_start = int(time.time()) - (int(time.time()) % 86400)
        
        today_trades = conn.execute("""
            SELECT COUNT(*), SUM(amount_usdt)
            FROM auto_positions
            WHERE user_id = ? AND mode = ? AND created_at >= ?
        """, (user_id, mode, today_start)).fetchone()
        
        # All time stats
        all_time = conn.execute("""
            SELECT COUNT(*), SUM(amount_usdt), 
                   SUM(CASE WHEN status = 'closed' THEN 1 ELSE 0 END)
            FROM auto_positions
            WHERE user_id = ? AND mode = ?
        """, (user_id, mode)).fetchone()
        
        # Active positions
        active = conn.execute("""
            SELECT COUNT(*), SUM(amount_usdt)
            FROM auto_positions
            WHERE user_id = ? AND mode = ? AND status IN ('waiting', 'open')
        """, (user_id, mode)).fetchone()
        
        return jsonify({
            "ok": True,
            "today": {
                "trades": today_trades[0] or 0,
                "volume": round(today_trades[1] or 0, 2)
            },
            "all_time": {
                "trades": all_time[0] or 0,
                "volume": round(all_time[1] or 0, 2),
                "closed": all_time[2] or 0
            },
            "active": {
                "positions": active[0] or 0,
                "total_value": round(active[1] or 0, 2)
            },
            "mode": mode
        })
    finally:
        conn.close()


# ==============================================
# WEBHOOK CRUD API (Admin only)
# ==============================================
@app.route('/api/webhooks', methods=['GET'])
def api_webhooks_list():
    """List all webhooks (admin only)"""
    if not session.get("logged_in") or session.get("role") != "admin":
        return jsonify({"error": "Unauthorized"}), 403
    conn = db()
    try:
        rows = conn.execute("SELECT * FROM webhooks ORDER BY id DESC").fetchall()
        webhooks = [dict(row) for row in rows]
        return jsonify({"success": True, "webhooks": webhooks})
    finally:
        conn.close()

@app.route('/api/webhooks', methods=['POST'])
def api_webhooks_create():
    """Create new webhook (admin only)"""
    if not session.get("logged_in") or session.get("role") != "admin":
        return jsonify({"error": "Unauthorized"}), 403
    data = request.get_json() or {}
    name = data.get("name", "").strip()
    url = data.get("url", "").strip()
    event_type = data.get("event_type", "trade")
    is_active = 1 if data.get("is_active", True) else 0
    
    if not name or not url:
        return jsonify({"error": "Name and URL are required"}), 400
    
    conn = db()
    try:
        conn.execute("""
            INSERT INTO webhooks (name, url, event_type, is_active, created_at)
            VALUES (?, ?, ?, ?, ?)
        """, (name, url, event_type, is_active, int(time.time())))
        conn.commit()
        return jsonify({"success": True, "message": "Webhook oluÅŸturuldu"})
    finally:
        conn.close()

@app.route('/api/webhooks/<int:webhook_id>', methods=['PUT'])
def api_webhooks_update(webhook_id):
    """Update webhook (admin only)"""
    if not session.get("logged_in") or session.get("role") != "admin":
        return jsonify({"error": "Unauthorized"}), 403
    data = request.get_json() or {}
    name = data.get("name", "").strip()
    url = data.get("url", "").strip()
    event_type = data.get("event_type", "trade")
    is_active = 1 if data.get("is_active", True) else 0
    
    conn = db()
    try:
        conn.execute("""
            UPDATE webhooks SET name=?, url=?, event_type=?, is_active=?, updated_at=?
            WHERE id=?
        """, (name, url, event_type, is_active, int(time.time()), webhook_id))
        conn.commit()
        return jsonify({"success": True, "message": "Webhook gÃ¼ncellendi"})
    finally:
        conn.close()

@app.route('/api/webhooks/<int:webhook_id>', methods=['DELETE'])
def api_webhooks_delete(webhook_id):
    """Delete webhook (admin only)"""
    if not session.get("logged_in") or session.get("role") != "admin":
        return jsonify({"error": "Unauthorized"}), 403
    conn = db()
    try:
        conn.execute("DELETE FROM webhooks WHERE id=?", (webhook_id,))
        conn.commit()
        return jsonify({"success": True, "message": "Webhook silindi"})
    finally:
        conn.close()


# ==============================================
# EDUCATION MODULES ADMIN API (Text-based modules)
# ==============================================
def api_admin_education_modules_list():
    """List all education modules (admin only)"""
    if not session.get("logged_in") or session.get("role") != "admin":
        return jsonify({"error": "Unauthorized"}), 403
    conn = db()
    try:
        rows = conn.execute("SELECT * FROM education_modules ORDER BY category, sort_order").fetchall()
        modules = [dict(row) for row in rows]
        return jsonify({"success": True, "modules": modules})
    finally:
        conn.close()

def api_admin_education_modules_create():
    """Create new education module (admin only)"""
    if not session.get("logged_in") or session.get("role") != "admin":
        return jsonify({"error": "Unauthorized"}), 403
    data = request.get_json() or {}
    title = data.get("title", "").strip()
    slug = data.get("slug", "").strip() or title.lower().replace(" ", "-")
    content = data.get("content", "")
    category = data.get("category", "temel")
    sort_order = int(data.get("sort_order", 0))
    is_active = 1 if data.get("is_active", True) else 0
    now = int(time.time())
    
    if not title:
        return jsonify({"error": "Title is required"}), 400
    
    conn = db()
    try:
        conn.execute("""
            INSERT INTO education_modules (title, slug, content, category, sort_order, is_active, created_at, updated_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """, (title, slug, content, category, sort_order, is_active, now, now))
        conn.commit()
        return jsonify({"success": True, "message": "EÄŸitim modÃ¼lÃ¼ oluÅŸturuldu"})
    except Exception as e:
        return jsonify({"error": str(e)}), 400
    finally:
        conn.close()

def api_admin_education_modules_update(module_id):
    """Update education module (admin only)"""
    if not session.get("logged_in") or session.get("role") != "admin":
        return jsonify({"error": "Unauthorized"}), 403
    data = request.get_json() or {}
    title = data.get("title", "").strip()
    slug = data.get("slug", "").strip()
    content = data.get("content", "")
    category = data.get("category", "temel")
    sort_order = int(data.get("sort_order", 0))
    is_active = 1 if data.get("is_active", True) else 0
    
    conn = db()
    try:
        conn.execute("""
            UPDATE education_modules SET title=?, slug=?, content=?, category=?, sort_order=?, is_active=?, updated_at=?
            WHERE id=?
        """, (title, slug, content, category, sort_order, is_active, int(time.time()), module_id))
        conn.commit()
        return jsonify({"success": True, "message": "EÄŸitim modÃ¼lÃ¼ gÃ¼ncellendi"})
    finally:
        conn.close()

def api_admin_education_modules_delete(module_id):
    """Delete education module (admin only)"""
    if not session.get("logged_in") or session.get("role") != "admin":
        return jsonify({"error": "Unauthorized"}), 403
    conn = db()
    try:
        conn.execute("DELETE FROM education_modules WHERE id=?", (module_id,))
        conn.commit()
        return jsonify({"success": True, "message": "EÄŸitim modÃ¼lÃ¼ silindi"})
    finally:
        conn.close()

# Public education endpoint (for users)
def api_education_public():
    """List active education modules for users"""
    if not session.get("logged_in"):
        return jsonify({"error": "Login required"}), 401
    conn = db()
    try:
        rows = conn.execute("""
            SELECT id, title, slug, content, category, sort_order 
            FROM education_modules 
            WHERE is_active=1 
            ORDER BY category, sort_order
        """).fetchall()
        modules = [dict(row) for row in rows]
        return jsonify({"success": True, "modules": modules})
    finally:
        conn.close()

def api_education_detail(slug):
    """Get single education module by slug"""
    if not session.get("logged_in"):
        return jsonify({"error": "Login required"}), 401
    conn = db()
    try:
        row = conn.execute("""
            SELECT id, title, slug, content, category 
            FROM education_modules 
            WHERE slug=? AND is_active=1
        """, (slug,)).fetchone()
        if row:
            return jsonify({"success": True, "module": dict(row)})
        return jsonify({"error": "Module not found"}), 404
    finally:
        conn.close()

# -----------------------------
# Entrypoint
# -----------------------------

def coin_to_inst_id(symbol: str) -> str:
    try:
        s = (symbol or "").strip().upper()
        if "/" in s:
            base, quote = s.split("/", 1)
            return f"{base}-{quote}"
        return s.replace("_", "-")
    except Exception:
        return symbol

def _get_open_real_position(conn, user_id: int, coin: str):
    row = conn.execute(
        "SELECT id, coin, side, amount_usdt, entry_price, status, created_at FROM real_positions WHERE user_id=? AND coin=? AND status='OPEN' ORDER BY id DESC LIMIT 1",
        (user_id, coin),
    ).fetchone()
    return row

def execute_real_trade(payload: dict):

    user_id = session.get("user_id")
    coin = str(payload.get("coin") or "BTC/USDT").upper()
    side = str(payload.get("type") or payload.get("side") or "BUY").upper()
    amount_usdt = float(payload.get("amount") or payload.get("amount_usdt") or 0.0)
    exchange = str(payload.get("exchange") or session.get("active_exchange") or "OKX").upper()

    if side not in ("BUY", "SELL"):
        return jsonify({"ok": False, "error": "INVALID_SIDE"}), 400

    # FiyatÄ± al (Binance public Ã¼zerinden). OKX emri market olacak, fiyat referansÄ± iÃ§in kullanÄ±yoruz.
    try:
        price = float(get_market_price(coin))
    except Exception:
        price = 0.0

    if side == "BUY":
        if amount_usdt <= 0:
            return jsonify({"ok": False, "error": "AMOUNT_REQUIRED"}), 400
        if price <= 0:
            return jsonify({"ok": False, "error": "PRICE_NOT_AVAILABLE"}), 400

        base_qty = max(amount_usdt / price, 0.0)
        inst_id = coin_to_inst_id(coin)

        try:
            # OKX: market buy, sz base qty. EÄŸer exchange farklÄ±ysa client yine aynÄ± interface ile Ã§alÄ±ÅŸÄ±r.
            client = get_exchange_client(user_id, exchange)
            order = client.place_order(inst_id, "buy", base_qty, order_type="market")
        except Exception as e:
            return jsonify({"ok": False, "error": "REAL_ORDER_FAILED", "detail": str(e)}), 400

        with sqlite3.connect(DB_PATH) as conn:
            from datetime import datetime as dt_cls
            conn.execute(
                "INSERT INTO real_positions(user_id, coin, side, amount_usdt, entry_price, status, created_at) VALUES (?,?,?,?,?,'OPEN',?)",
                (user_id, coin, "BUY", amount_usdt, price, dt_cls.now(timezone.utc).isoformat()),
            )
            conn.commit()

        return jsonify({"ok": True, "mode": "real", "order": order, "price": price})

    # SELL: kural gereÄŸi coin iÃ§in tÃ¼m aÃ§Ä±k pozisyonu kapat
    with sqlite3.connect(DB_PATH) as conn:
        pos = _get_open_real_position(conn, user_id, coin)
        if not pos:
            return jsonify({"ok": False, "error": "NO_OPEN_POSITION"}), 400
        pos_id, _, _, pos_amount_usdt, entry_price, _, _ = pos

    if entry_price and entry_price > 0 and price > 0:
        base_qty = float(pos_amount_usdt) / float(entry_price)
    else:
        base_qty = 0.0

    inst_id = coin_to_inst_id(coin)
    try:
        client = get_exchange_client(user_id, exchange)
        order = client.place_order(inst_id, "sell", base_qty, order_type="market")
    except Exception as e:
        return jsonify({"ok": False, "error": "REAL_ORDER_FAILED", "detail": str(e)}), 400

    pnl = 0.0
    if entry_price and entry_price > 0 and price > 0:
        pnl = (price - float(entry_price)) * (float(pos_amount_usdt) / float(entry_price))

    with sqlite3.connect(DB_PATH) as conn:
        from datetime import datetime as dt_cls
        conn.execute(
            "UPDATE real_positions SET status='CLOSED', exit_price=?, pnl=?, closed_at=? WHERE id=?",
            (price, pnl, dt_cls.now(timezone.utc).isoformat(), pos_id),
        )
        conn.commit()

    return jsonify({"ok": True, "mode": "real", "order": order, "price": price, "pnl": pnl})

@app.get("/api/positions/real")
def api_positions_real():
    # AUTH JSON (API endpoints redirect yerine JSON donsun)
    try:
        if not (session.get("user_id") or session.get("username") or session.get("user") or session.get("email") or session.get("logged_in")):
            return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    except Exception:
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401

    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "NOT_LOGGED_IN"}), 401
    user_id = session.get("user_id")
    with sqlite3.connect(DB_PATH) as conn:
        rows = conn.execute(
            "SELECT id, coin, side, amount_usdt, entry_price, status, created_at FROM real_positions WHERE user_id=? AND status='OPEN' ORDER BY id DESC",
            (user_id,),
        ).fetchall()
    positions = []
    for r in rows:
        positions.append({
            "id": r[0],
            "coin": r[1],
            "side": r[2],
            "amount_usdt": r[3],
            "entry_price": r[4],
            "status": r[5],
            "created_at": r[6],
        })
    return jsonify({"ok": True, "positions": positions})


# =========================
# REAL TRADES + PORTFOLIO (UI ALIAS)
# =========================

def _auth_json_required():
    try:
        if not (session.get("user_id") or session.get("username") or session.get("user") or session.get("email") or session.get("logged_in")):
            return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    except Exception:
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "NOT_LOGGED_IN"}), 401
    return None

def _real_trades_from_positions(user_id: int, limit: int = 200):
    # CLOSED pozisyonlarÄ± "trade history" olarak Ã¼ret
    with sqlite3.connect(DB_PATH) as conn:
        rows = conn.execute(
            "SELECT id, coin, side, amount_usdt, entry_price, exit_price, pnl, status, created_at, closed_at "
            "FROM real_positions WHERE user_id=? AND status IN (OPEN,CLOSED) "
            "ORDER BY id DESC LIMIT ?",
            (user_id, int(limit)),
        ).fetchall()

    out=[]
    for r in rows:
        rid, coin, side, amount_usdt, entry_price, exit_price, pnl, status, created_at, closed_at = r
        out.append({
            "id": rid,
            "pair": coin,
            "symbol": coin,
            "type": (side or "").lower(),
            "side": side,
            "amount_usdt": float(amount_usdt or 0),
            "entry_price": float(entry_price or 0),
            "exit_price": float(exit_price or 0) if exit_price is not None else None,
            "pnl_usdt": float(pnl or 0) if pnl is not None else None,
            "status": status,
            "created_at": created_at,
            "closed_at": closed_at,
            "mode": "REAL",
            "exchange": (session.get("active_exchange") or "OKX"),
        })
    return out

@app.get("/api/trades/real")
def api_trades_real():
    err = _auth_json_required()
    if err: return err
    try:
        user_id = session.get("user_id")
        try:
            limit = int(request.args.get("limit") or 200)
        except Exception:
            limit = 200
        trades = _real_trades_from_positions(user_id, limit=limit)
        return jsonify({"ok": True, "mode": "REAL", "trades": trades})
    except Exception as e:
        return jsonify({"ok": False, "error": "REAL_TRADES_FAILED", "detail": str(e)[:200], "retryable": True, "trades": []}), 200

@app.get("/api/trades/demo")
def api_trades_demo():
    err = _auth_json_required()
    if err: return err
    # DEMO trade geÃ§miÅŸi bu dosyada ayrÄ± tabloda tutulmuyorsa ÅŸimdilik boÅŸ dÃ¶n.
    return jsonify({"ok": True, "mode": "DEMO", "trades": []})

@app.get("/api/trades/<mode>")
def api_trades_mode(mode):
    m = (mode or "").strip().lower()
    if m == "real":
        return api_trades_real()
    return api_trades_demo()

@app.get("/api/portfolio/real")
def api_portfolio_real():
    err = _auth_json_required()
    if err: return err
    try:
        user_id = session.get("user_id")

        # aÃ§Ä±k pozisyonlar
        with sqlite3.connect(DB_PATH) as conn:
            rows = conn.execute(
                "SELECT id, coin, amount_usdt, entry_price, status, created_at "
                "FROM real_positions WHERE user_id=? AND status=OPEN ORDER BY id DESC",
                (user_id,),
            ).fetchall()

        positions=[]
        invested=0.0
        for r in rows:
            pid, coin, amount_usdt, entry_price, status, created_at = r
            amt=float(amount_usdt or 0)
            invested += amt
            positions.append({
                "id": pid,
                "coin": coin,
                "amount_usdt": amt,
                "entry_price": float(entry_price or 0),
                "status": status,
                "created_at": created_at,
            })

        # real balance (mevcut fonksiyon)
        # api_real_balance() json dÃ¶ndÃ¼rÃ¼yor; burada direkt yeniden hesaplamak yerine ccxt Ã§aÄŸrÄ±sÄ± maliyetli.
        # Bu yÃ¼zden: UI iÃ§in portfolio summary "invested_usdt" + "open_positions" dÃ¶ner.
        return jsonify({
            "ok": True,
            "mode": "REAL",
            "summary": {
                "invested_usdt": invested,
                "open_positions": len(positions),
            },
            "positions": positions,
        })
    except Exception as e:
        return jsonify({"ok": False, "error": "REAL_PORTFOLIO_FAILED", "detail": str(e)[:200], "retryable": True, "positions": []}), 200

@app.get("/api/portfolio/demo")
def api_portfolio_demo():
    err = _auth_json_required()
    if err: return err
    return jsonify({"ok": True, "mode": "DEMO", "summary": {"invested_usdt": 0.0, "open_positions": 0}, "positions": []})

@app.get("/api/portfolio/<mode>")
def api_portfolio_mode(mode):
    m = (mode or "").strip().lower()
    if m == "real":
        return api_portfolio_real()
    return api_portfolio_demo()

# ==========================================
# BALANCE ENDPOINTS (READ ONLY) :: v2
# ==========================================

def _ccxt_exchange_id(name: str) -> str:
    n = (name or "").strip().lower()
    if n == "okx": return "okx"
    if n == "binance": return "binance"
    if n == "bybit": return "bybit"
    if n in ("gate", "gateio", "gate.io"): return "gateio"
    if n in ("btcturk", "btc-turk", "btc_turk"): return "btcturk"
    return n


def _balance_require_login():
    uid = session.get("username") or session.get("email")
    if not uid:
        return None, (jsonify(ok=False, error="AUTH_REQUIRED"), 401)
    return uid, None


def _get_user_exchange_keys(user_id: str, exchange: str):
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cur = conn.cursor()
        cur.execute(
            """
            SELECT api_key, api_secret, passphrase, mode
            FROM exchange_api_keys
            WHERE lower(exchange)=lower(?)
              AND status='active'
              AND (user_id IS NULL OR user_id='' OR lower(user_id)=lower(?))
            ORDER BY id DESC
            LIMIT 1
            """,
            (exchange, user_id or ""),
        )
        row = cur.fetchone()
        conn.close()
        return dict(row) if row else None
    except Exception as e:
        print("[BALANCE] key read error:", e)
        return None


def _make_ccxt(exchange_name: str, keys: dict):
    import ccxt
    ex_id = _ccxt_exchange_id(exchange_name)
    client = getattr(ccxt, ex_id)({
        "apiKey": keys.get("api_key"),
        "secret": keys.get("api_secret"),
        "password": keys.get("passphrase", ""),
        "enableRateLimit": True,
    })
    if hasattr(client, "set_sandbox_mode"):
        client.set_sandbox_mode(True)
    return client


def _extract_usdt_total(balance_obj):
    return float((balance_obj.get("total") or {}).get("USDT", 0) or 0)


@app.route("/api/balance/<exchange>")
def api_balance_exchange(exchange):
    user_id, err = _balance_require_login()
    if err:
        return err

    keys = _get_user_exchange_keys(user_id, exchange)
    if not keys:
        return jsonify(ok=False, error="API_KEY_NOT_FOUND")

    bal = _make_ccxt(exchange, keys).fetch_balance()
    return jsonify(ok=True, balance=_extract_usdt_total(bal))


@app.route("/api/balances")
def api_balances_all():
    # GUEST_FALLBACK_BALANCES
    try:
        if not (session.get("user_id") or session.get("username") or session.get("user") or session.get("email") or session.get("logged_in")):
            return jsonify({"ok": True, "guest": True, "mode": "DEMO", "balances": [{"currency":"USDT","available":1000.0,"total":1000.0}]})
    except Exception:
        return jsonify({"ok": True, "guest": True, "mode": "DEMO", "balances": [{"currency":"USDT","available":1000.0,"total":1000.0}]})

    # AUTH JSON (API endpoints redirect yerine JSON donsun)
    try:
        if not (session.get("user_id") or session.get("username") or session.get("user") or session.get("email") or session.get("logged_in")):
            return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401
    except Exception:
        return jsonify({"ok": False, "error": "AUTH_REQUIRED"}), 401

    user_id, err = _balance_require_login()
    if err:
        return err

    out = {}
    total = 0.0
    for ex in ["okx", "binance", "bybit", "gateio"]:
        keys = None
        keys = _get_user_exchange_keys(user_id, ex)
        # FIX_BALANCES_USERS_FALLBACK
        # exchange_api_keys tablosunda yoksa users tablosundan fallback ile cek
        if not keys:
            try:
                _uid = session.get("username") or session.get("email") or session.get("user_id") or session.get("user")
            except Exception:
                _uid = None

            row = None
            if _uid:
                try:
                    import sqlite3
                    conn2 = sqlite3.connect(DB_PATH)
                    conn2.row_factory = sqlite3.Row
                    cur2 = conn2.cursor()
                    cur2.execute(
                        "select * from users where username=? or email=? or cast(id as text)=? or cast(rowid as text)=? limit 1",
                        (str(_uid), str(_uid), str(_uid), str(_uid))
                    )
                    r2 = cur2.fetchone()
                    conn2.close()
                    if r2 is not None:
                        row = dict(r2)
                except Exception:
                    row = None

            if row:
                # ex bazli kolon isimleri (okx icin ozel kolonlar var, digerleri api_key/api_secret/passphrase kullanabilir)
                if ex == "okx":
                    k   = (row.get("api_okx_key") or row.get("api_key") or "").strip()
                    sec = (row.get("api_okx_secret") or row.get("api_secret") or "").strip()
                    pp  = (row.get("api_okx_passphrase") or row.get("api_passphrase") or "").strip()
                    mode = (row.get("api_okx_mode") or row.get("mode") or "").strip().upper()
                else:
                    k   = (row.get(f"api_{ex}_key") or row.get("api_key") or "").strip()
                    sec = (row.get(f"api_{ex}_secret") or row.get("api_secret") or "").strip()
                    pp  = (row.get(f"api_{ex}_passphrase") or row.get("api_passphrase") or "").strip()
                    mode = (row.get(f"api_{ex}_mode") or row.get("mode") or "").strip().upper()

                if k and sec:
                    keys = {"api_key": k, "api_secret": sec, "passphrase": pp, "mode": mode, "apiKey": k, "secret": sec, "password": pp, "key": k, "pass": pp}
        if not keys:
            out[ex] = {"ok": False}
            continue
        try:
            bal = _make_ccxt(ex, keys).fetch_balance()
            usdt = _extract_usdt_total(bal)
            out[ex] = {"ok": True, "balance": usdt}
            total += usdt
        except Exception as e:
            msg = str(e)
            if "Invalid OK-ACCESS-KEY" in msg or "AuthenticationError" in msg:
                out[ex] = {"ok": False, "error": "INVALID_API_KEY"}
            else:
                out[ex] = {"ok": False, "error": "EXCHANGE_ERROR"}

        # UI_COMPAT_BALANCES_ALIAS
    try:
        # UI bazen total / totalUSDT ve exchange.usdt bekleyebilir
        for _ex, _d in (out or {}).items():
            try:
                if isinstance(_d, dict) and _d.get('ok') and 'balance' in _d and 'usdt' not in _d:
                    _d['usdt'] = _d.get('balance')
            except Exception:
                pass
    except Exception:
        pass

    return jsonify(ok=True, total_usdt=total, total=total, totalUSDT=total, balances=out)

# =========================
# API_REAL_BALANCE_ALIAS
# UI bazen /api/real veya /api/real/balance gibi endpoint bekleyebilir
# Hepsini OKX REAL bakiyeye map ediyoruz
# =========================

@app.route("/api/real", methods=["GET"], endpoint="api_real_balance_v2")
@app.route("/api/real/balance", methods=["GET"], endpoint="api_real_balance_v2b")
def api_real_balance():
    # REAL OKX bakiye (exchange_api_keys table first, then users fallback)
    try:
        try:
            uid = session.get("user_id")
            username = session.get("username")
        except Exception:
            uid = None
            username = None

        if not uid and not username:
            return jsonify(ok=False, error="AUTH_REQUIRED"), 401

        import sqlite3
        
        # First try exchange_api_keys table
        k, sec, pp = "", "", ""
        try:
            conn = sqlite3.connect(DB_PATH)
            # Try with user_id (string and int) and username
            row = conn.execute(
                """SELECT api_key, api_secret, passphrase FROM exchange_api_keys 
                   WHERE (user_id=? OR user_id=? OR user_id=?) AND exchange='okx'""",
                (str(uid) if uid else '', uid if uid else 0, username if username else '')
            ).fetchone()
            conn.close()
            
            if row:
                k = decrypt_data(row[0]) if row[0] else ""
                sec = decrypt_data(row[1]) if row[1] else ""
                pp = decrypt_data(row[2]) if row[2] else ""
        except Exception as e:
            print(f"[REAL BALANCE] exchange_api_keys error: {e}")
        
        # Fallback to users table if not found
        if not (k and sec and pp):
            conn = sqlite3.connect(DB_PATH)
            conn.row_factory = sqlite3.Row
            cur = conn.cursor()
            cur.execute(
                "select * from users where username=? or email=? or cast(id as text)=? or cast(rowid as text)=? limit 1",
                (str(uid), str(uid), str(uid), str(uid))
            )
            r = cur.fetchone()
            conn.close()

            if r:
                row = dict(r)
                k   = (row.get("api_okx_key") or row.get("api_key") or "").strip()
                sec = (row.get("api_okx_secret") or row.get("api_secret") or "").strip()
                pp  = (row.get("api_okx_passphrase") or row.get("api_passphrase") or "").strip()

        if not (k and sec and pp):
            # Return 0 balance if no API keys configured (not an error, just no real trading setup)
            return jsonify(ok=True, balance=0, usdt=0, message="API anahtarlarÄ± yapÄ±landÄ±rÄ±lmadÄ±"), 200

        import ccxt
        client = ccxt.okx({
            "apiKey": k,
            "secret": sec,
            "password": pp,
            "enableRateLimit": True,
        })
        if hasattr(client, "set_sandbox_mode"):
            client.set_sandbox_mode(False)  # REAL

        bal = None
        last_err = None
        for attempt in range(3):
            try:
                bal = client.fetch_balance()
                last_err = None
                break
            except Exception as _e:
                last_err = _e
                import time
                time.sleep(0.4 * (attempt + 1))
        if bal is None:
            return jsonify(ok=False, error="REAL_BALANCE_UNAVAILABLE", detail=str(last_err)[:200], retryable=True), 200
        total = 0.0
        try:
            if isinstance(bal, dict):
                t = bal.get("total") or {}
                if isinstance(t, dict) and "USDT" in t:
                    total = float(t.get("USDT") or 0)
                else:
                    f = bal.get("free") or {}
                    u = bal.get("used") or {}
                    if isinstance(f, dict) and isinstance(u, dict):
                        total = float(f.get("USDT") or 0) + float(u.get("USDT") or 0)
        except Exception:
            total = 0.0

        return jsonify(
            ok=True,
            exchange="OKX",
            mode="REAL",
            balance=total,
            usdt=total,
            total=total,
            totalUSDT=total,
            source="users"
        )
    except Exception as e:
        return jsonify(ok=False, error="REAL_BALANCE_FAILED", detail=str(e)[:200], retryable=True), 200
@app.route("/api/balance/okx")
def api_balance_okx():
    # FIX_OKX_BALANCE_DEFINE_USER_ID
    # user_id tanimli olsun; session yoksa AUTH_REQUIRED don
    try:
        user_id = session.get('user_id')
        any_uid = session.get('username') or session.get('email') or user_id or session.get('user')
    except Exception:
        user_id = None
        any_uid = None
    if not any_uid:
        return jsonify(ok=False, error='AUTH_REQUIRED'), 401

    # HARD_DEBUG_OKX_BALANCE
    try:
        from flask import request as _req
        if (_req.args.get('debug') or '') == '1':
            _uid = None
            try:
                _uid = session.get('username') or session.get('email') or session.get('user_id') or session.get('user')
            except Exception:
                _uid = None

            found = None
            try:
                import sqlite3
                conn = sqlite3.connect(DB_PATH)
                conn.row_factory = sqlite3.Row
                cur = conn.cursor()
                cur.execute(
                    "select rowid as _rowid, id, username, email, api_key, api_secret, api_passphrase, api_okx_key, api_okx_secret, api_okx_passphrase, api_okx_mode, mode from users where username=? or email=? or cast(id as text)=? or cast(rowid as text)=? limit 1",
                    (str(_uid), str(_uid), str(_uid), str(_uid))
                )
                r = cur.fetchone()
                conn.close()
                if r is not None:
                    d = dict(r)
                    found = {
                        'rowid': d.get('_rowid'),
                        'id': d.get('id'),
                        'username': d.get('username'),
                        'email': d.get('email'),
                        'len_api_key': len((d.get('api_key') or '').strip()),
                        'len_api_secret': len((d.get('api_secret') or '').strip()),
                        'len_api_passphrase': len((d.get('api_passphrase') or '').strip()),
                        'len_api_okx_key': len((d.get('api_okx_key') or '').strip()),
                        'len_api_okx_secret': len((d.get('api_okx_secret') or '').strip()),
                        'len_api_okx_passphrase': len((d.get('api_okx_passphrase') or '').strip()),
                        'api_okx_mode': d.get('api_okx_mode'),
                        'mode': d.get('mode'),
                    }
            except Exception as e:
                found = {'db_error': str(e)[:200]}

            return jsonify(ok=True, debug=True, session_dump={
                'user_id': session.get('user_id'),
                'username': session.get('username'),
                'email': session.get('email'),
                'user': session.get('user'),
                'logged_in': session.get('logged_in'),
            }, _uid=str(_uid), user_row=found)
    except Exception as _e:
        return jsonify(ok=False, debug=True, error='HARD_DEBUG_FAILED', detail=str(_e)[:200]), 500

    # FIX_OKX_BALANCE_USERS_FALLBACK
    # session'da user_id/username/email hangisi varsa users tablosundan OKX key cek
    try:
        _uid = session.get("username") or session.get("email") or session.get("user_id") or session.get("user")
    except Exception:
        _uid = None
    # DEBUG_OKX_BALANCE_SESSION
    try:
        from flask import request as _req
        if (_req.args.get("debug") or "") == "1" and (_req.remote_addr in ("127.0.0.1","::1")):
            return jsonify(ok=True, debug=True, session_dump={
                "user_id": session.get("user_id"),
                "username": session.get("username"),
                "email": session.get("email"),
                "user": session.get("user"),
                "logged_in": session.get("logged_in"),
            })
    except Exception as _e:
        return jsonify(ok=False, debug=True, error="DEBUG_BLOCK_FAILED", detail=str(_e)[:200]), 500

    if _uid:
        row = None
        try:
            import sqlite3
            conn = sqlite3.connect(DB_PATH)
            conn.row_factory = sqlite3.Row
            cur = conn.cursor()
            cur.execute(
                "select * from users where username=? or email=? or cast(id as text)=? or cast(rowid as text)=? limit 1",
                (str(_uid), str(_uid), str(_uid), str(_uid))
            )
            r = cur.fetchone()
            conn.close()
            if r is not None:
                row = dict(r)
        except Exception:
            row = None

        if row:
            k   = (row.get("api_okx_key") or row.get("api_key") or "").strip()
            sec = (row.get("api_okx_secret") or row.get("api_secret") or "").strip()
            pp  = (row.get("api_okx_passphrase") or row.get("api_passphrase") or "").strip()

            try:
                req_mode = (request.args.get("mode") or "").strip().upper()
            except Exception:
                req_mode = ""
            mode = (req_mode or (row.get("api_okx_mode") or row.get("mode") or "")).strip().upper()

            if k and sec and pp:
                try:
                    import ccxt
                    client = ccxt.okx({
                        "apiKey": k,
                        "secret": sec,
                        "password": pp,
                        "enableRateLimit": True,
                    })

                    if hasattr(client, "set_sandbox_mode"):
                            client.set_sandbox_mode(True)
                    else:
                            client.set_sandbox_mode(False)

                    trading_usdt = 0.0
                    funding_usdt = 0.0

                    bal_trading = client.fetch_balance()
                    trading_usdt = float((bal_trading.get("total") or {}).get("USDT", 0) or 0)

                    try:
                        bal_funding = client.fetch_balance({"type": "funding"})
                        funding_usdt = float((bal_funding.get("total") or {}).get("USDT", 0) or 0)
                    except Exception:
                        funding_usdt = 0.0

                    total = float(trading_usdt + funding_usdt)

                    return jsonify(
                        ok=True,
                        exchange="OKX",
                        balance=total,
                        breakdown={"trading": trading_usdt, "funding": funding_usdt},
                        mode=mode,
                        source="users"
                    )
                except Exception as e:
                    return jsonify(ok=False, error="EXCHANGE_ERROR", detail=str(e)[:300]), 400

    keys = get_user_exchange_keys(user_id, "okx")
    if not keys:
        return jsonify(ok=False, error="API_KEY_NOT_FOUND")

    try:
        import ccxt
        exchange = ccxt.okx({
            "apiKey": keys["api_key"],
            "secret": keys["api_secret"],
            "password": keys.get("api_passphrase"),
            "enableRateLimit": True
        })
        bal = exchange.fetch_balance()
        usdt = bal["total"].get("USDT", 0)
        return jsonify(ok=True, balance=usdt)
    except Exception as e:
        print("[OKX BALANCE ERROR]", e)
        return jsonify(ok=False, error=str(e))



# ==========================================







@app.route("/api/ui/chat/<room>")
def api_ui_chat_room(room):
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        cur = conn.cursor()

        cur.execute(
            "SELECT id, username, message, created_at "
            "FROM chat_messages "
            "WHERE room=? "
            "ORDER BY id DESC LIMIT 200",
            (room,)
        )
        rows = cur.fetchall()
        conn.close()

        msgs = []
        for r in reversed(rows):
            msgs.append({
                "id": r["id"],
                "user": r["username"] or "Anonim",
                "text": r["message"],
                "time": r["created_at"]
            })

        return jsonify(ok=True, messages=msgs)
    except Exception as e:
        return jsonify(ok=False, error=str(e))

# =========================
# COIN LISTESI â€“ USDT SPOT
# OKX + BINANCE + BYBIT + GATEIO
# Cache'li, Alias'li, Stabil Endpoint
# =========================

import time
import threading

try:
    import ccxt
except Exception:
    ccxt = None

# ---- Cache ----
COINS_CACHE = {
    "ts": 0,
    "data": [],
    "count": 0
}
COINS_CACHE_TTL = 300  # saniye, 5 dakika
_COINS_LOCK = threading.Lock()

def _now_ts():
    return int(time.time())

def _normalize_symbol(sym):
    if not sym:
        return None
    s = sym.replace("-", "/")
    if ":" in s:
        s = s.split(":")[0]
    return s

def _load_usdt_spot_from_exchange(ex):
    coins = set()
    try:
        markets = ex.load_markets()
        for m in markets.values():
            if not m:
                continue
            if m.get("spot") is True and m.get("active") is True:
                if m.get("quote") == "USDT":
                    sym = _normalize_symbol(m.get("symbol"))
                    if sym and sym.endswith("/USDT"):
                        coins.add(sym)
    except Exception:
        pass
    return coins

def _build_coins_list():
    if ccxt is None:
        return []

    all_coins = set()

    exchanges = []
    try:
        exchanges.append(ccxt.okx({"enableRateLimit": True}))
    except Exception:
        pass
    try:
        exchanges.append(ccxt.binance({"enableRateLimit": True}))
    except Exception:
        pass
    try:
        exchanges.append(ccxt.bybit({"enableRateLimit": True}))
    except Exception:
        pass
    try:
        exchanges.append(ccxt.gateio({"enableRateLimit": True}))
    except Exception:
        pass

    for ex in exchanges:
        try:
            all_coins.update(_load_usdt_spot_from_exchange(ex))
        except Exception:
            continue

    return sorted(all_coins)

def _get_cached_coins():
    with _COINS_LOCK:
        now = _now_ts()
        if COINS_CACHE["data"] and (now - COINS_CACHE["ts"] < COINS_CACHE_TTL):
            return COINS_CACHE["data"], COINS_CACHE["count"]

    coins = _build_coins_list()
    with _COINS_LOCK:
        COINS_CACHE["data"] = coins
        COINS_CACHE["count"] = len(coins)
        COINS_CACHE["ts"] = _now_ts()

    return coins, len(coins)

@app.route("/api/coins_legacy", methods=["GET"])
@app.route("/api/symbols_legacy", methods=["GET"])
def api_coins():
    coins, count = _get_cached_coins()
    coins_ui = [{"label": c, "symbol": c, "value": c} for c in coins]
    return jsonify({
        "ok": True,
        "coins": coins_ui,
        "count": count
    })

# =========================
# END COIN LIST
# =========================

@app.route("/api/coins_ccxt", methods=["GET"])
def api_coins_ccxt():
    try:
        coins, count = _get_cached_coins()
        coins_ui = [{"label": c, "symbol": c, "value": c} for c in coins]
        return jsonify({"ok": True, "coins": coins_ui, "count": count})
    except Exception as e:
        return jsonify({"ok": False, "error": "COINS_CCXT_FAILED", "detail": str(e)}), 500


# === API_DEV_LOGIN_TOKEN ===
@app.post("/api/dev/login")
def api_dev_login():
    """
    Localhost token login (curl/test iÃ§in, ÅŸifre yazmadan session almak)
    Body: {"username":"email_or_username","token":"API_DEV_TOKEN"}
    Sadece 127.0.0.1 / ::1 kabul edilir.
    """
    try:
        ra = (request.remote_addr or "").strip()
        if ra not in ("127.0.0.1", "::1"):
            return jsonify({"ok": False, "error": "forbidden"}), 403

        j = request.get_json(silent=True) or {}
        username = str(j.get("username","")).strip()
        token = str(j.get("token","")).strip()

        import os, sqlite3
        env_tok = (os.getenv("API_DEV_TOKEN","") or "").strip()
        if (not env_tok) or (token != env_tok):
            return jsonify({"ok": False, "error": "invalid_token"}), 401

        if not username:
            return jsonify({"ok": False, "error": "username_required"}), 400

        con = sqlite3.connect(DB_PATH)
        con.row_factory = sqlite3.Row
        row = con.execute(
            "SELECT rowid, * FROM users WHERE username=? OR email=? LIMIT 1",
            (username, username),
        ).fetchone()
        con.close()

        if not row:
            return jsonify({"ok": False, "error": "user_not_found"}), 404

        cols = set(row.keys())
        session["logged_in"] = True
        session["user_id"] = int(row["rowid"])
        session["username"] = (row["username"] if ("username" in cols and row["username"]) else (row["email"] if "email" in cols else username))

        return jsonify({"ok": True, "user_id": session["user_id"], "username": session["username"]})
    except Exception as e:
        return jsonify({"ok": False, "error": "dev_login_failed", "detail": str(e)}), 500

### DEMO_SYNC_HOOKS_V3
# DEMO tek doÄŸru kaynak: users.demo_balance
# 1) /api/real/balance her zaman users.demo_balance dÃ¶ner
# 2) /api/trade/execute demo ok:true -> users.demo_balance = new_balance
# 3) SELL amount_usdt=0 gelirse DBâ€™de aÃ§Ä±k pozisyondan amount_usdt bulunur ve set edilir
try:
    import json as _json
    import sqlite3 as _sqlite3
    from flask import jsonify as _jsonify

    def _ds_con_v3():
        con = _sqlite3.connect(DB_PATH)
        con.row_factory = _sqlite3.Row
        return con

    def _ds_get_users_demo_v3(uid: int) -> float:
        con = _ds_con_v3()
        row = con.execute("SELECT demo_balance FROM users WHERE rowid=?", (int(uid),)).fetchone()
        con.close()
        try:
            return float(row["demo_balance"]) if row and row["demo_balance"] is not None else 0.0
        except Exception:
            return 0.0

    def _ds_set_users_demo_v3(uid: int, bal: float) -> None:
        con = _ds_con_v3()
        con.execute("UPDATE users SET demo_balance=? WHERE rowid=?", (float(bal), int(uid)))
        con.commit()
        con.close()

    def _ds_find_pos_tables_v3(con):
        # user_id + amount_usdt + (symbol|coin) kolonlarÄ±nÄ± iÃ§eren tablolarÄ± otomatik bul
        tabs = [r[0] for r in con.execute("SELECT name FROM sqlite_master WHERE type=table").fetchall()]
        found = []
        for t in tabs:
            try:
                info = con.execute(f"PRAGMA table_info({t})").fetchall()
                cols = [r[1].lower() for r in info]
            except Exception:
                continue
            if "user_id" in cols and "amount_usdt" in cols and ("symbol" in cols or "coin" in cols):
                sym_col = "symbol" if "symbol" in cols else "coin"
                found.append((t, sym_col, cols))
        return found

    def _ds_open_amount_v3(uid: int, symbol: str):
        con = _ds_con_v3()
        try:
            candidates = _ds_find_pos_tables_v3(con)
            for table, sym_col, cols in candidates:
                where = f"user_id=? AND {sym_col}=?"
                if "status" in cols:
                    where += " AND status=open"
                elif "closed_at" in cols:
                    where += " AND closed_at IS NULL"
                q = f"SELECT amount_usdt FROM {table} WHERE {where} ORDER BY rowid DESC LIMIT 1"
                try:
                    row = con.execute(q, (int(uid), symbol)).fetchone()
                    if row and row["amount_usdt"] is not None:
                        v = float(row["amount_usdt"])
                        if v >= 1.0:
                            return v
                except Exception:
                    continue
        finally:
            con.close()
        return None

    @app.before_request
    def _demo_sync_before_request_v3():
        try:
            path = (request.path or "")
            uid = session.get("user_id")

            # A) /api/real/balance override
            if False and path == "/api/real/balance" and uid:
                bal = _ds_get_users_demo_v3(int(uid))
                return _jsonify({"ok": True, "mode": "DEMO", "source": "users", "balance": bal, "demo_balance": bal})

            # B) SELL amount_usdt=0 -> open position amount_usdt ile doldur
            if path == "/api/trade/execute":
                j = request.get_json(silent=True) or {}
                if str(j.get("mode","")).lower().strip() == "demo" and str(j.get("side","")).upper().strip() == "SELL":
                    amt = float(j.get("amount_usdt") or 0.0)
                    if amt < 1.0 and uid:
                        sym = str(j.get("symbol","") or j.get("coin","")).strip()
                        if sym:
                            amt2 = _ds_open_amount_v3(int(uid), sym)
                            if amt2 is not None and float(amt2) >= 1.0:
                                j["amount_usdt"] = float(amt2)
                                request._cached_json = {False: j, True: j}
        except Exception:
            return None
        return None

    @app.after_request
    def _demo_sync_after_request_v3(resp):
        try:
            if (request.path or "") != "/api/trade/execute":
                return resp

            uid = session.get("user_id")
            if not uid:
                return resp

            reqj = request.get_json(silent=True) or {}
            if str(reqj.get("mode","")).lower().strip() != "demo":
                return resp

            ctype = (resp.headers.get("Content-Type","") or "").lower()
            if "application/json" not in ctype:
                return resp

            data = _json.loads(resp.get_data(as_text=True) or "{}")
            if isinstance(data, dict) and data.get("ok") is True and data.get("new_balance") is not None:
                try:
                    _ds_set_users_demo_v3(int(uid), float(data["new_balance"]))
                except Exception:
                    pass
            return resp
        except Exception:
            return resp
except Exception:
    pass
### END_DEMO_SYNC_HOOKS_V3

### DEMO_PNL_HOOK_V3
# DEMO SELL sonrasÄ± pnl hesapla: pnl = amount_usdt * 0.005  (%0.50)
# Hem response'a yazar hem demo_trades tablosundaki son SELL kaydÄ±nÄ± gÃ¼nceller.
try:
    import json as _json
    import sqlite3 as _sqlite3

    def _pnl_con_v3():
        con = _sqlite3.connect(DB_PATH)
        con.row_factory = _sqlite3.Row
        return con

    def _table_exists_v3(con, name: str) -> bool:
        r = con.execute("SELECT name FROM sqlite_master WHERE type='table' AND name=? LIMIT 1", (name,)).fetchone()
        return bool(r)

    def _cols_v3(con, table: str):
        info = con.execute(f"PRAGMA table_info({table})").fetchall()
        cols = [r[1] for r in info]
        cols_l = [c.lower() for c in cols]
        return cols, cols_l

    def _update_last_sell_v3(uid, symbol: str, pnl_val: float):
        con = _pnl_con_v3()
        try:
            if not _table_exists_v3(con, "demo_trades"):
                return
            cols, cols_l = _cols_v3(con, "demo_trades")

            user_col = "user_id" if "user_id" in cols_l else None
            sym_col  = "symbol" if "symbol" in cols_l else ("coin" if "coin" in cols_l else None)
            side_col = "side" if "side" in cols_l else None
            pnl_col  = "pnl" if "pnl" in cols_l else ("pnl_usdt" if "pnl_usdt" in cols_l else None)

            if not user_col or not sym_col or not pnl_col:
                return

            order_col = "id" if "id" in cols_l else "rowid"

            where = f"WHERE {user_col}=? AND {sym_col}=?"
            params = [str(uid), symbol]
            if side_col:
                where += f" AND UPPER({side_col})='SELL'"

            q = f"SELECT {order_col} AS _id FROM demo_trades {where} ORDER BY {order_col} DESC LIMIT 1"
            row = con.execute(q, tuple(params)).fetchone()
            if not row:
                return

            rid = row["_id"]
            con.execute(f"UPDATE demo_trades SET {pnl_col}=? WHERE {order_col}=?", (float(pnl_val), rid))
            con.commit()
        finally:
            con.close()

    @app.after_request
    def _demo_pnl_hook_after_v3(resp):
        try:
            if (request.path or "") != "/api/trade/execute":
                return resp

            reqj = request.get_json(silent=True) or {}
            if str(reqj.get("mode", "")).lower().strip() != "demo":
                return resp

            side = str(reqj.get("side", "")).upper().strip()
            if side != "SELL":
                return resp

            ctype = (resp.headers.get("Content-Type", "") or "").lower()
            if "application/json" not in ctype:
                return resp

            data = _json.loads(resp.get_data(as_text=True) or "{}")
            if not isinstance(data, dict) or data.get("ok") is not True:
                return resp

            try:
                amount_usdt = float(reqj.get("amount_usdt") or 0.0)
            except Exception:
                amount_usdt = 0.0

            pnl = float(amount_usdt) * 0.005 if amount_usdt >= 1.0 else 0.0

            data["pnl"] = pnl
            data["pnl_usdt"] = pnl
            data["profit"] = pnl
            data["profit_usdt"] = pnl

            try:
                uid = session.get("user_id")
                sym = str(reqj.get("symbol", "") or reqj.get("coin", "") or "").strip()
                if uid and sym:
                    _update_last_sell_v3(uid, sym, pnl)
            except Exception:
                pass

            resp.set_data(_json.dumps(data))
            resp.headers["Content-Type"] = "application/json"
            return resp
        except Exception:
            return resp

except Exception:
    pass
### END_DEMO_PNL_HOOK_V3

### DEMO_TRADES_LOG_HOOK_V1
# /api/trade/execute DEMO BUY/SELL baÅŸarÄ±lÄ± olunca demo_trades tablosuna INSERT atar.
# Not: Bu hook, execute fonksiyonunu deÄŸiÅŸtirmeden trade historyâ€™yi doldurur.
try:
    import json as _dt_json
    import sqlite3 as _dt_sqlite3
    import time as _dt_time

    def _dt_con():
        con = _dt_sqlite3.connect(DB_PATH)
        con.row_factory = _dt_sqlite3.Row
        return con

    def _dt_ensure_table(con):
        con.execute(
            "CREATE TABLE IF NOT EXISTS demo_trades ("
            "id INTEGER PRIMARY KEY AUTOINCREMENT,"
            "user_id TEXT NOT NULL,"
            "symbol TEXT NOT NULL,"
            "side TEXT NOT NULL,"
            "amount_usdt REAL NOT NULL DEFAULT 0,"
            "price REAL NOT NULL DEFAULT 0,"
            "ts INTEGER NOT NULL DEFAULT 0,"
            "pnl REAL NOT NULL DEFAULT 0,"
            "fee REAL NOT NULL DEFAULT 0"
            ")"
        )

    def _dt_insert(user_id, symbol, side, amount_usdt, price, pnl, fee):
        con = _dt_con()
        try:
            _dt_ensure_table(con)
            con.execute(
                "INSERT INTO demo_trades (user_id,symbol,side,amount_usdt,price,ts,pnl,fee) VALUES (?,?,?,?,?,?,?,?)",
                (str(user_id), str(symbol), str(side),
                 float(amount_usdt or 0.0), float(price or 0.0),
                 int(_dt_time.time()),
                 float(pnl or 0.0), float(fee or 0.0))
            )
            con.commit()
        finally:
            con.close()

    @app.after_request
    def _demo_trades_log_after_v1(resp):
        try:
            if (request.path or "") != "/api/trade/execute":
                return resp

            # Request DEMO mu?
            reqj = request.get_json(silent=True) or {}
            if str(reqj.get("mode", "")).lower().strip() != "demo":
                return resp

            # Sadece BUY/SELL
            side = str(reqj.get("side", "")).upper().strip()
            if side not in ("BUY", "SELL"):
                return resp

            # JSON response olmalÄ±
            ctype = (resp.headers.get("Content-Type", "") or "").lower()
            if "application/json" not in ctype:
                return resp

            data = _dt_json.loads(resp.get_data(as_text=True) or "{}")
            if not isinstance(data, dict) or data.get("ok") is not True:
                return resp

            uid = session.get("user_id")
            if not uid:
                return resp

            symbol = str(reqj.get("symbol", "") or reqj.get("coin", "") or "").strip()
            if not symbol:
                return resp

            try:
                amount_usdt = float(reqj.get("amount_usdt") or 0.0)
            except Exception:
                amount_usdt = 0.0

            # FiyatÄ± responseâ€™tan al (entry_price var)
            try:
                price = float(data.get("entry_price") or data.get("price") or 0.0)
            except Exception:
                price = 0.0

            # pnl varsa al (SELLâ€™de senin hook zaten ekliyor)
            try:
                pnl = float(data.get("pnl") or data.get("pnl_usdt") or 0.0)
            except Exception:
                pnl = 0.0

            # fee yoksa 0
            try:
                fee = float(data.get("fee") or 0.0)
            except Exception:
                fee = 0.0

            _dt_insert(uid, symbol, side, amount_usdt, price, pnl, fee)
            return resp
        except Exception:
            return resp

except Exception:
    pass
### END_DEMO_TRADES_LOG_HOOK_V1

### DEMO_BALANCE_SINGLE_SOURCE_V1
# Tek doÄŸru DEMO bakiye kaynaÄŸÄ±: paper_test_state.usdt (paper_test_state PK: username)
# YazÄ±m: /api/trade/execute DEMO ok=true â†’ response.new_balance â†’ paper_test_state.usdt
# Okuma: /api/real/balance response override â†’ paper_test_state.usdt
try:
    import json as _dbss_json
    import sqlite3 as _dbss_sqlite3
    import time as _dbss_time

    def _dbss_con():
        con = _dbss_sqlite3.connect(DB_PATH)
        con.row_factory = _dbss_sqlite3.Row
        return con

    def _dbss_get_username():
        try:
            u = (session.get("username") or session.get("user") or session.get("email") or "").strip()
            if u:
                return u
        except Exception:
            pass

        uid = None
        try:
            uid = session.get("user_id")
        except Exception:
            uid = None
        if not uid:
            return ""

        con = _dbss_con()
        try:
            # users tablosu PK username, ayrÄ±ca id kolonu var ama PK deÄŸil (yine de dene)
            row = con.execute("SELECT username FROM users WHERE id=? LIMIT 1", (uid,)).fetchone()
            if not row:
                row = con.execute("SELECT username FROM users WHERE rowid=? LIMIT 1", (uid,)).fetchone()
            return (row["username"] if row else "") or ""
        finally:
            con.close()

    def _dbss_ensure_paper_state(username: str):
        if not username:
            return
        con = _dbss_con()
        try:
            # tablo var mÄ± kontrol etmiyoruz; mevcut sistemde var
            row = con.execute("SELECT username FROM paper_test_state WHERE username=? LIMIT 1", (username,)).fetchone()
            if row:
                return

            # baÅŸlangÄ±Ã§: users.demo_balance varsa onu kullan, yoksa 1000
            start = 1000.0
            urow = con.execute("SELECT demo_balance FROM users WHERE username=? LIMIT 1", (username,)).fetchone()
            if urow and urow["demo_balance"] is not None:
                try:
                    start = float(urow["demo_balance"])
                except Exception:
                    pass

            # paper_test_state kolonlarÄ±: username, balance_tl, ..., usdt, ...
            # sadece username + usdt + start_usdt + updated_at setleyelim
            con.execute(
                "INSERT INTO paper_test_state (username, usdt, start_usdt, updated_at) VALUES (?,?,?,?)",
                (username, float(start), float(start), int(_dbss_time.time()))
            )
            con.commit()
        finally:
            con.close()

    def _dbss_get_usdt(username: str) -> float:
        if not username:
            return 0.0
        _dbss_ensure_paper_state(username)
        con = _dbss_con()
        try:
            row = con.execute("SELECT usdt FROM paper_test_state WHERE username=? LIMIT 1", (username,)).fetchone()
            if not row:
                return 0.0
            try:
                return float(row["usdt"] or 0.0)
            except Exception:
                return 0.0
        finally:
            con.close()

    def _dbss_set_usdt(username: str, usdt_val: float):
        if not username:
            return
        _dbss_ensure_paper_state(username)
        con = _dbss_con()
        try:
            con.execute(
                "UPDATE paper_test_state SET usdt=?, updated_at=? WHERE username=?",
                (float(usdt_val), int(_dbss_time.time()), username)
            )
            con.commit()
        finally:
            con.close()

    def _dbss_sync_other_sources(username: str, uid, usdt_val: float):
        # Okuma kaynaÄŸÄ± deÄŸil, sadece uyumluluk/sync
        con = _dbss_con()
        try:
            # users.demo_balance sync
            try:
                con.execute("UPDATE users SET demo_balance=? WHERE username=?", (float(usdt_val), username))
            except Exception:
                pass

            # demo_balance tablosu sync (PK user_id)
            if uid:
                try:
                    con.execute(
                        "INSERT INTO demo_balance (user_id, balance, updated_at) VALUES (?,?,?) "
                        "ON CONFLICT(user_id) DO UPDATE SET balance=excluded.balance, updated_at=excluded.updated_at",
                        (int(uid), float(usdt_val), int(_dbss_time.time()))
                    )
                except Exception:
                    try:
                        # eski sqlite sÃ¼rÃ¼mÃ¼ ON CONFLICT desteklemezse
                        r = con.execute("SELECT user_id FROM demo_balance WHERE user_id=? LIMIT 1", (int(uid),)).fetchone()
                        if r:
                            con.execute("UPDATE demo_balance SET balance=?, updated_at=? WHERE user_id=?",
                                        (float(usdt_val), int(_dbss_time.time()), int(uid)))
                        else:
                            con.execute("INSERT INTO demo_balance (user_id, balance, updated_at) VALUES (?,?,?)",
                                        (int(uid), float(usdt_val), int(_dbss_time.time())))
                    except Exception:
                        pass

            con.commit()
        finally:
            con.close()

    @app.after_request
    def _demo_balance_single_source_after_v1(resp):
        try:
            path = (request.path or "")
            if path not in ("/api/trade/execute", "/api/real/balance"):
                return resp

            # DEMO mu? (trade/execute iÃ§in request jsonâ€™dan, demo/balance iÃ§in user account_mode/modeâ€™dan baÄŸÄ±msÄ±z override)
            if path == "/api/trade/execute":
                reqj = request.get_json(silent=True) or {}
                if str(reqj.get("mode", "")).lower().strip() != "demo":
                    return resp

            ctype = (resp.headers.get("Content-Type", "") or "").lower()
            if "application/json" not in ctype:
                return resp

            username = _dbss_get_username()
            if not username:
                return resp

            uid = None
            try:
                uid = session.get("user_id")
            except Exception:
                uid = None

            data = _dbss_json.loads(resp.get_data(as_text=True) or "{}")
            if not isinstance(data, dict):
                return resp

            if path == "/api/trade/execute":
                if data.get("ok") is not True:
                    return resp
                # new_balance varsa onu paper_test_state.usdt yap
                nb = data.get("new_balance")
                if nb is None:
                    return resp
                try:
                    nb_f = float(nb)
                except Exception:
                    return resp

                _dbss_set_usdt(username, nb_f)
                _dbss_sync_other_sources(username, uid, nb_f)
                return resp

            if False and path == "/api/real/balance":
                # responseâ€™u paper_test_state.usdt ile override et
                bal = _dbss_get_usdt(username)
                out = {
                    "ok": True,
                    "mode": "demo",
                    "source": "paper_test_state.usdt",
                    "balance": float(bal),
                    "balance_usdt": float(bal),
                }
                resp.set_data(_dbss_json.dumps(out))
                resp.headers["Content-Type"] = "application/json"
                return resp

            return resp
        except Exception:
            return resp

except Exception:
    pass
### END_DEMO_BALANCE_SINGLE_SOURCE_V1

### DEMO_BALANCE_MATH_FORCE_V1
# /api/trade/execute DEMO ok=true â†’ BUY/SELL matematiÄŸini tek kaynaÄŸa gÃ¶re zorla uygular
# Kaynak: paper_test_state.usdt (DEMO_BALANCE_SINGLE_SOURCE_V1 ile uyumlu)
try:
    import json as _dbmf_json
    import sqlite3 as _dbmf_sqlite3
    import time as _dbmf_time

    def _dbmf_con():
        con = _dbmf_sqlite3.connect(DB_PATH)
        con.row_factory = _dbmf_sqlite3.Row
        return con

    def _dbmf_get_username():
        try:
            u = (session.get("username") or session.get("user") or session.get("email") or "").strip()
            if u:
                return u
        except Exception:
            pass
        uid = None
        try:
            uid = session.get("user_id")
        except Exception:
            uid = None
        if not uid:
            return ""
        con = _dbmf_con()
        try:
            row = con.execute("SELECT username FROM users WHERE id=? LIMIT 1", (uid,)).fetchone()
            if not row:
                row = con.execute("SELECT username FROM users WHERE rowid=? LIMIT 1", (uid,)).fetchone()
            return (row["username"] if row else "") or ""
        finally:
            con.close()

    def _dbmf_get_user_tp_pct(username: str) -> float:
        con = _dbmf_con()
        try:
            row = con.execute("SELECT tp_pct FROM users WHERE username=? LIMIT 1", (username,)).fetchone()
            if row and row["tp_pct"] is not None:
                try:
                    return float(row["tp_pct"])
                except Exception:
                    return 0.005
            return 0.005
        finally:
            con.close()

    def _dbmf_get_fee_pct(username: str) -> float:
        con = _dbmf_con()
        try:
            row = con.execute("SELECT fee_pct FROM paper_test_state WHERE username=? LIMIT 1", (username,)).fetchone()
            if row and row["fee_pct"] is not None:
                try:
                    return float(row["fee_pct"])
                except Exception:
                    return 0.0
            return 0.0
        finally:
            con.close()

    def _dbmf_get_usdt(username: str) -> float:
        con = _dbmf_con()
        try:
            row = con.execute("SELECT usdt FROM paper_test_state WHERE username=? LIMIT 1", (username,)).fetchone()
            if not row:
                return 0.0
            try:
                return float(row["usdt"] or 0.0)
            except Exception:
                return 0.0
        finally:
            con.close()

    def _dbmf_set_usdt(username: str, val: float):
        con = _dbmf_con()
        try:
            con.execute("UPDATE paper_test_state SET usdt=?, updated_at=? WHERE username=?",
                        (float(val), int(_dbmf_time.time()), username))
            con.commit()
        finally:
            con.close()

    def _dbmf_sync(username: str, uid, val: float):
        con = _dbmf_con()
        try:
            try:
                con.execute("UPDATE users SET demo_balance=? WHERE username=?", (float(val), username))
            except Exception:
                pass
            if uid:
                try:
                    r = con.execute("SELECT user_id FROM demo_balance WHERE user_id=? LIMIT 1", (int(uid),)).fetchone()
                    if r:
                        con.execute("UPDATE demo_balance SET balance=?, updated_at=? WHERE user_id=?",
                                    (float(val), int(_dbmf_time.time()), int(uid)))
                    else:
                        con.execute("INSERT INTO demo_balance (user_id, balance, updated_at) VALUES (?,?,?)",
                                    (int(uid), float(val), int(_dbmf_time.time())))
                except Exception:
                    pass
            con.commit()
        finally:
            con.close()

    @app.after_request
    def _demo_balance_math_force_after_v1(resp):
        try:
            if (request.path or "") != "/api/trade/execute":
                return resp

            reqj = request.get_json(silent=True) or {}
            if str(reqj.get("mode", "")).lower().strip() != "demo":
                return resp

            side = str(reqj.get("side", "")).upper().strip()
            if side not in ("BUY", "SELL"):
                return resp

            ctype = (resp.headers.get("Content-Type", "") or "").lower()
            if "application/json" not in ctype:
                return resp

            data = _dbmf_json.loads(resp.get_data(as_text=True) or "{}")
            if not isinstance(data, dict) or data.get("ok") is not True:
                return resp

            username = _dbmf_get_username()
            if not username:
                return resp

            uid = None
            try:
                uid = session.get("user_id")
            except Exception:
                uid = None

            try:
                amount_usdt = float(reqj.get("amount_usdt") or 0.0)
            except Exception:
                amount_usdt = 0.0

            if amount_usdt <= 0:
                return resp

            cur = _dbmf_get_usdt(username)

            fee_pct = _dbmf_get_fee_pct(username)
            fee = float(amount_usdt) * float(fee_pct or 0.0)

            # pnl: SELLâ€™de tp_pct uygula (varsayÄ±lan 0.005)
            tp = _dbmf_get_user_tp_pct(username)
            pnl = 0.0
            if side == "SELL":
                pnl = float(amount_usdt) * float(tp or 0.0)

            if side == "BUY":
                new_bal = cur - amount_usdt - fee
            else:
                new_bal = cur + amount_usdt + pnl - fee

            if new_bal < 0:
                new_bal = 0.0

            _dbmf_set_usdt(username, new_bal)
            _dbmf_sync(username, uid, new_bal)

            # response override
            data["new_balance"] = float(new_bal)
            data["balance"] = float(new_bal)
            data["balance_usdt"] = float(new_bal)
            data["fee"] = float(fee)
            if side == "SELL":
                data["pnl"] = float(data.get("pnl") or pnl)
                data["pnl_usdt"] = float(data.get("pnl_usdt") or pnl)

            resp.set_data(_dbmf_json.dumps(data))
            resp.headers["Content-Type"] = "application/json"
            return resp
        except Exception:
            return resp

except Exception:
    pass
### END_DEMO_BALANCE_MATH_FORCE_V1



# === AU_AUTO_LIMITS_V1 ===
def _au_db_path():
    return globals().get("DB_PATH") or globals().get("DB_FILE") or "/root/backend/data.db"

def _au_norm_mode(sess) -> str:
    m = (sess.get("ui_mode") or sess.get("mode") or sess.get("account_mode") or "demo")
    m = (m or "").strip().lower()
    return "real" if m in ("real","live") else "demo"

def _au_plan_limit(user_row: dict) -> int:
    plan = ""
    for k in ("subscription_plan","package","package_name","plan"):
        v = user_row.get(k) if isinstance(user_row, dict) else ""
        if isinstance(v, str) and v.strip():
            plan = v.strip().lower()
            break
    if "elit" in plan or "elite" in plan:
        return 5
    if "premium" in plan:
        return 3
    # Temel / Basic
    return 2

def _au_get_user_row(uid: int) -> dict:
    import sqlite3
    con = sqlite3.connect(_au_db_path())
    con.row_factory = sqlite3.Row
    cur = con.cursor()
    row = cur.execute("SELECT * FROM users WHERE id=? LIMIT 1", (uid,)).fetchone()
    con.close()
    return dict(row) if row else {}

# api_auto_list_v2 removed - duplicate route, see api_auto_list at line 22074

@app.post("/api/auto/add")
def api_auto_add_v2():
    from flask import session, request, jsonify
    import sqlite3, time

    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    j = request.get_json(silent=True) or {}
    coin = (j.get("coin") or j.get("symbol") or "").strip()
    try:
        amount = float(j.get("amount_usdt") or j.get("usdt") or 0.0)
    except Exception:
        amount = 0.0

    if not coin or amount <= 0:
        return jsonify({"ok": False, "error": "BAD_INPUT"}), 400

    uid = int(session.get("user_id") or 0)
    username = (session.get("username") or "").strip()
    mode = _au_norm_mode(session)

    con = sqlite3.connect(_au_db_path())
    con.row_factory = sqlite3.Row
    cur = con.cursor()

    # sistemde sÄ±nÄ±rsÄ±z coin aÃ§Ä±labilir
    # REAL modda paket limitine gÃ¶re kontrol yapÄ±lÄ±r
    if mode == "real":
        user_row = _au_get_user_row(uid)
        limit = _au_plan_limit(user_row)

        # distinct waiting coin sayÄ±sÄ±
        row = cur.execute(
            "SELECT COUNT(DISTINCT coin) FROM auto_positions "
            "WHERE user_id=? AND status='waiting' AND (mode='real' OR mode='live')",
            (uid,)
        ).fetchone()
        cur_cnt = int((row[0] if row else 0) or 0)

        exists = cur.execute(
            "SELECT id FROM auto_positions "
            "WHERE user_id=? AND status='waiting' AND (mode='real' OR mode='live') AND coin=? LIMIT 1",
            (uid, coin)
        ).fetchone()

        if not exists and cur_cnt >= limit:
            con.close()
            return jsonify({"ok": False, "error": "COIN_LIMIT", "limit": limit, "current": cur_cnt, 
                           "message": f"Paket limitinize ulaÅŸtÄ±nÄ±z. Maksimum {limit} coin aÃ§abilirsiniz."}), 403

    # aynÄ± coin bekliyorsa update
    if mode == "real":
        ex = cur.execute(
            "SELECT id FROM auto_positions WHERE user_id=? AND status='waiting' AND (mode='real' OR mode='live') AND coin=? LIMIT 1",
            (uid, coin)
        ).fetchone()
    else:
        ex = cur.execute(
            "SELECT id FROM auto_positions WHERE user_id=? AND status='waiting' AND mode='demo' AND coin=? LIMIT 1",
            (uid, coin)
        ).fetchone()

    if ex:
        cur.execute("UPDATE auto_positions SET amount_usdt=?, created_at=? WHERE id=?", (float(amount), int(time.time()), int(ex[0])))
        con.commit()
        con.close()
        return jsonify({"ok": True, "updated": True}), 200

    cur.execute(
        "INSERT INTO auto_positions (user_id, username, mode, coin, amount_usdt, status, created_at) VALUES (?,?,?,?,?,?,?)",
        (uid, username, mode, coin, float(amount), "waiting", int(time.time()))
    )
    con.commit()
    con.close()
    return jsonify({"ok": True, "created": True}), 200
# === END AU_AUTO_LIMITS_V1 ===





# === AU_AUTO_LIST_ALIAS_V1 removed - duplicate routes ===

# === AU_AUTO_UI_BUTTONS_V1 ===
def _au_db_path2():
    # mevcut helper varsa onu kullan
    try:
        if "_au_db_path" in globals():
            return _au_db_path()
    except Exception:
        pass
    return globals().get("DB_PATH") or globals().get("DB_FILE") or "/root/backend/data.db"

def _au_mode2(sess) -> str:
    try:
        if "_au_norm_mode" in globals():
            return _au_norm_mode(sess)
    except Exception:
        pass
    m = (sess.get("ui_mode") or sess.get("mode") or sess.get("account_mode") or "demo")
    m = (m or "").strip().lower()
    return "real" if m in ("real","live") else "demo"

def _au_ensure_auto_cols():
    import sqlite3
    con = sqlite3.connect(_au_db_path2(), timeout=30)
    cur = con.cursor()
    cur.execute("PRAGMA busy_timeout=30000")
    # paused desteÄŸi iÃ§in ekstra kolon ÅŸart deÄŸil; ama edit iÃ§in target_pct opsiyonel ekleyelim
    try:
        cur.execute("ALTER TABLE auto_positions ADD COLUMN target_pct REAL")
    except Exception:
        pass
    con.commit()
    con.close()

def _au_parse_float(v):
    if v is None:
        return None
    if isinstance(v, (int, float)):
        return float(v)
    if isinstance(v, str):
        t = v.strip().replace(",", ".")
        t = t.replace("%","")
        try:
            return float(t)
        except Exception:
            return None
    return None

@ app.post("/api/auto/toggle")
def api_auto_toggle_v1():
    from flask import session, request, jsonify
    import sqlite3

    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    _au_ensure_auto_cols()

    j = request.get_json(silent=True) or {}
    rid = j.get("id") or j.get("auto_id") or j.get("row_id")
    try:
        rid = int(rid)
    except Exception:
        return jsonify({"ok": False, "error": "BAD_ID"}), 400

    uid = int(session.get("user_id") or 0)
    mode = _au_mode2(session)

    con = sqlite3.connect(_au_db_path2(), timeout=30)
    con.row_factory = sqlite3.Row
    cur = con.cursor()
    cur.execute("PRAGMA busy_timeout=30000")

    row = cur.execute(
        "SELECT id,status,mode FROM auto_positions WHERE id=? AND user_id=? LIMIT 1",
        (rid, uid)
    ).fetchone()
    if not row:
        con.close()
        return jsonify({"ok": False, "error": "NOT_FOUND"}), 404

    # UI bazen enabled gÃ¶nderir, bazen sadece toggle ister
    enabled = j.get("enabled")
    if enabled is None:
        # toggle
        new_status = "paused" if (row["status"] == "waiting") else "waiting"
    else:
        enabled_i = 1 if str(enabled).strip().lower() in ("1","true","yes","on") else 0
        new_status = "waiting" if enabled_i == 1 else "paused"

    cur.execute(
        "UPDATE auto_positions SET status=? WHERE id=? AND user_id=?",
        (new_status, rid, uid)
    )
    con.commit()
    con.close()

    return jsonify({"ok": True, "id": rid, "status": new_status, "mode": mode}), 200

@ app.post("/api/auto/edit")
def api_auto_edit_v1():
    from flask import session, request, jsonify
    import sqlite3, time

    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    _au_ensure_auto_cols()

    j = request.get_json(silent=True) or {}
    rid = j.get("id") or j.get("auto_id") or j.get("row_id")
    try:
        rid = int(rid)
    except Exception:
        return jsonify({"ok": False, "error": "BAD_ID"}), 400

    # UI bazen "price" alanÄ±na yazÄ±yor gibi: onu da amount yerine kabul edelim
    amount = _au_parse_float(j.get("amount_usdt"))
    if amount is None:
        amount = _au_parse_float(j.get("usdt"))
    if amount is None:
        amount = _au_parse_float(j.get("amount"))
    if amount is None:
        amount = _au_parse_float(j.get("price"))   # UI yanlÄ±ÅŸ isimle yollarsa da kabul
    if amount is None or amount <= 0:
        return jsonify({"ok": False, "error": "BAD_AMOUNT"}), 400

    target_pct = _au_parse_float(j.get("target_pct"))
    if target_pct is None:
        # UI "target" veya "exit" gibi yollarsa
        target_pct = _au_parse_float(j.get("target"))
    if target_pct is None:
        target_pct = _au_parse_float(j.get("exit_pct"))

    uid = int(session.get("user_id") or 0)

    con = sqlite3.connect(_au_db_path2(), timeout=30)
    cur = con.cursor()
    cur.execute("PRAGMA busy_timeout=30000")

    # sadece kendi kaydÄ±nÄ± edit edebilsin
    if target_pct is None:
        cur.execute(
            "UPDATE auto_positions SET amount_usdt=?, created_at=? WHERE id=? AND user_id=?",
            (float(amount), int(time.time()), rid, uid)
        )
    else:
        cur.execute(
            "UPDATE auto_positions SET amount_usdt=?, target_pct=?, created_at=? WHERE id=? AND user_id=?",
            (float(amount), float(target_pct), int(time.time()), rid, uid)
        )

    if cur.rowcount <= 0:
        con.close()
        return jsonify({"ok": False, "error": "NOT_FOUND"}), 404

    con.commit()
    con.close()
    return jsonify({"ok": True, "id": rid, "amount_usdt": float(amount), "target_pct": target_pct}), 200

@ app.post("/api/auto/delete")
def api_auto_delete_v1():
    from flask import session, request, jsonify
    import sqlite3

    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    j = request.get_json(silent=True) or {}
    rid = j.get("id") or j.get("auto_id") or j.get("row_id")
    try:
        rid = int(rid)
    except Exception:
        return jsonify({"ok": False, "error": "BAD_ID"}), 400

    uid = int(session.get("user_id") or 0)

    con = sqlite3.connect(_au_db_path2(), timeout=30)
    cur = con.cursor()
    cur.execute("PRAGMA busy_timeout=30000")
    cur.execute("DELETE FROM auto_positions WHERE id=? AND user_id=?", (rid, uid))
    deleted = cur.rowcount
    con.commit()
    con.close()

    if deleted <= 0:
        return jsonify({"ok": False, "error": "NOT_FOUND"}), 404
    return jsonify({"ok": True, "deleted": True, "id": rid}), 200

def api_auto_list_v3():
    # FIXED: Return ALL trades including open and closed (not just waiting/paused)
    from flask import session, jsonify
    import sqlite3

    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    _au_ensure_auto_cols()

    uid = int(session.get("user_id") or 0)
    mode = _au_mode2(session)

    print(f"[AUTO LIST V3] user_id={uid}, mode={mode}", flush=True)

    con = sqlite3.connect(_au_db_path2(), timeout=30)
    con.row_factory = sqlite3.Row
    cur = con.cursor()
    cur.execute("PRAGMA busy_timeout=30000")

    # NO STATUS FILTER - show ALL trades (waiting, open, paused, closed)
    if mode == "real":
        rows = cur.execute(
            "SELECT id, coin, amount_usdt, status, created_at, COALESCE(target_pct, NULL) AS target_pct "
            "FROM auto_positions "
            "WHERE user_id=? AND (mode='real' OR mode='live') "
            "ORDER BY id DESC",
            (uid,)
        ).fetchall()
    else:
        rows = cur.execute(
            "SELECT id, coin, amount_usdt, status, created_at, COALESCE(target_pct, NULL) AS target_pct "
            "FROM auto_positions "
            "WHERE user_id=? AND mode='demo' "
            "ORDER BY id DESC",
            (uid,)
        ).fetchall()

    print(f"[AUTO LIST V3] Found {len(rows)} trades", flush=True)
    for r in rows:
        print(f"  -> id={r['id']}, coin={r['coin']}, status={r['status']}", flush=True)

    con.close()
    items = [dict(r) for r in rows]
    for it in items:
        it.setdefault("symbol", it.get("coin",""))

    return jsonify({
        "ok": True,
        "mode": mode,
        "items": items,
        "auto_trades": items,
        "trades": items
    }), 200

# Flask route map'te eski /api/auto/list ilk eÅŸleÅŸse bile endpoint'i override ederek kesin v3'e baÄŸla
try:
    if "app" in globals() and hasattr(app, "view_functions"):
        if "api_auto_list" in app.view_functions:
            app.view_functions["api_auto_list"] = api_auto_list_v3
except Exception:
    pass
# === END AU_AUTO_UI_BUTTONS_V1 ===





# === AU_AUTO_UI_ROUTE_OVERRIDES_V1 ===
# AmaÃ§: server.py iÃ§inde eski /api/auto/toggle/edit/delete route'larÄ± varsa bile
# app.url_map Ã¼zerinden endpoint'i bulup view_functions override etmek.
try:
    if "app" in globals() and hasattr(app, "url_map") and hasattr(app, "view_functions"):
        def _au_bind(path: str, method: str, func):
            try:
                for r in app.url_map.iter_rules():
                    if r.rule == path and method.upper() in (r.methods or set()):
                        ep = r.endpoint
                        if ep in app.view_functions:
                            app.view_functions[ep] = func
            except Exception:
                pass

        # bizim fonksiyonlar mevcutsa baÄŸla
        if "api_auto_toggle_v1" in globals():
            _au_bind("/api/auto/toggle", "POST", api_auto_toggle_v1)

        if "api_auto_edit_v1" in globals():
            _au_bind("/api/auto/edit", "POST", api_auto_edit_v1)
            # UI bazÄ± buildâ€™lerde update Ã§aÄŸÄ±rabiliyor
            _au_bind("/api/auto/update", "POST", api_auto_edit_v1)

        if "api_auto_delete_v1" in globals():
            _au_bind("/api/auto/delete", "POST", api_auto_delete_v1)
            # UI bazÄ± buildâ€™lerde remove Ã§aÄŸÄ±rabiliyor
            _au_bind("/api/auto/remove", "POST", api_auto_delete_v1)
except Exception:
    pass
# === END AU_AUTO_UI_ROUTE_OVERRIDES_V1 ===





# === AU_AUTO_EXECUTOR_V1 ===
import threading, time, math

def _au_db_path3():
    try:
        if "_au_db_path" in globals():
            return _au_db_path()
    except Exception:
        pass
    return globals().get("DB_PATH") or globals().get("DB_FILE") or "/root/backend/data.db"

def _au_mode3(sess) -> str:
    try:
        if "_au_norm_mode" in globals():
            return _au_norm_mode(sess)
    except Exception:
        pass
    m = (sess.get("ui_mode") or sess.get("mode") or sess.get("account_mode") or "demo")
    m = (m or "").strip().lower()
    return "real" if m in ("real","live") else "demo"

def _au_sqlite():
    import sqlite3
    con = sqlite3.connect(_au_db_path3(), timeout=30, check_same_thread=False)
    con.row_factory = sqlite3.Row
    cur = con.cursor()
    cur.execute("PRAGMA busy_timeout=30000")
    try:
        cur.execute("PRAGMA journal_mode=WAL")
    except Exception:
        pass
    return con, cur

def _au_ensure_auto_schema_v1():
    con, cur = _au_sqlite()
    # auto_positions kolonlarÄ± (yoksa ekle)
    for ddl in [
        "ALTER TABLE auto_positions ADD COLUMN opened_at INTEGER",
        "ALTER TABLE auto_positions ADD COLUMN closed_at INTEGER",
        "ALTER TABLE auto_positions ADD COLUMN entry_price REAL",
        "ALTER TABLE auto_positions ADD COLUMN qty REAL",
        "ALTER TABLE auto_positions ADD COLUMN last_error TEXT",
        "ALTER TABLE auto_positions ADD COLUMN updated_at INTEGER",
    ]:
        try:
            cur.execute(ddl)
        except Exception:
            pass

    # demo tablolarÄ±
    cur.execute("""
    CREATE TABLE IF NOT EXISTS demo_positions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        coin TEXT,
        qty REAL,
        entry_price REAL,
        amount_usdt REAL,
        status TEXT,
        opened_at INTEGER,
        closed_at INTEGER,
        peak_price REAL
    )
    """)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS demo_trades (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        coin TEXT,
        side TEXT,
        qty REAL,
        price REAL,
        amount_usdt REAL,
        fee REAL,
        ts INTEGER,
        source TEXT
    )
    """)
    con.commit()
    con.close()

def _au_demo_price(symbol: str) -> float:
    # varsa mevcut fake/demo fiyat cacheâ€™lerini kullan
    for k in ("DEMO_PRICES","demo_prices","FAKE_PRICES","fake_prices","PRICE_CACHE","price_cache"):
        d = globals().get(k)
        if isinstance(d, dict) and symbol in d:
            try:
                return float(d[symbol])
            except Exception:
                pass
    # deterministic fallback (Ã§Ã¶kmesin diye)
    base = sum(ord(c) for c in symbol) % 1000
    return max(0.01, (base / 10.0) + (time.time() % 10) / 100.0)

def _au_mark_error(auto_id: int, msg: str):
    con, cur = _au_sqlite()
    cur.execute(
        "UPDATE auto_positions SET last_error=?, updated_at=? WHERE id=?",
        (str(msg)[:500], int(time.time()), int(auto_id))
    )
    con.commit()
    con.close()

def _au_open_demo_trade(auto_row):
    # DEMO: users.demo_balance tek doÄŸru kaynak mantÄ±ÄŸÄ±na uygun Ã§alÄ±ÅŸÄ±r
    uid = int(auto_row["user_id"])
    coin = str(auto_row["coin"])
    amount = float(auto_row["amount_usdt"] or 0.0)
    if amount <= 0:
        _au_mark_error(int(auto_row["id"]), "BAD_AMOUNT")
        return False

    price = _au_demo_price(coin)
    qty = amount / price if price > 0 else 0.0
    if qty <= 0:
        _au_mark_error(int(auto_row["id"]), "BAD_QTY")
        return False

    con, cur = _au_sqlite()

    # demo balance dÃ¼ÅŸ
    bal_row = cur.execute("SELECT demo_balance FROM users WHERE id=? LIMIT 1", (uid,)).fetchone()
    demo_bal = float((bal_row["demo_balance"] if bal_row and bal_row["demo_balance"] is not None else 0.0) or 0.0)
    if demo_bal < amount:
        con.close()
        _au_mark_error(int(auto_row["id"]), "INSUFFICIENT_DEMO_BALANCE")
        return False

    new_bal = demo_bal - amount
    cur.execute("UPDATE users SET demo_balance=? WHERE id=?", (new_bal, uid))

    now = int(time.time())
    cur.execute(
        "INSERT INTO demo_positions (user_id, coin, side, amount_usdt, entry_price, current_price, pnl, status, created_at, source) "
        "VALUES (?,?,?,?,?,?,?,?,?,?)",
        (uid, coin, "BUY", float(amount), float(price), float(price), 0.0, "open", now, "auto")
    )
    cur.execute(
        "INSERT INTO demo_trades (user_id, symbol, side, amount_usdt, price, ts, pnl, fee) "
        "VALUES (?,?,?,?,?,?,?,?)",
        (str(uid), coin, "BUY", float(amount), float(price), now, 0.0, 0.0)
    )

    # auto_positions -> open
    cur.execute(
        "UPDATE auto_positions SET status='open', opened_at=?, entry_price=?, qty=?, last_error=NULL, updated_at=? "
        "WHERE id=?",
        (now, float(price), float(qty), now, int(auto_row["id"]))
    )

    con.commit()
    con.close()
    return True

# === AU_DB_FALLBACKS_V1 ===
# Some older/newer variants use _au_sqlite() instead of au_db()/au_safe_write().
# DEMO sell scan must work even if those helpers are missing.

if "au_db" not in globals():
    def au_db():
        # Return (con, cur) like other code expects
        return _au_sqlite()

if "au_safe_write" not in globals():
    def au_safe_write(tag, source, user_id, mode, payload, work_fn):
        """
        Minimal safe write wrapper.
        work_fn(con, cur) should execute SQL. We commit on success.
        """
        con, cur = _au_sqlite()
        try:
            out = work_fn(con, cur)
            try:
                con.commit()
            except Exception:
                pass
            return out
        finally:
            try:
                con.close()
            except Exception:
                pass
# === END AU_DB_FALLBACKS_V1 ===



# === DEMO AUTO SELL HELPERS (STANDALONE) ===
_AU_DEMO_TP_PCT = 0.005  # %0.50

def _au_close_demo_position(pos_row, sell_price: float, reason: str = "tp"):
    """
    Close a demo_positions row and write demo_trades SELL. Updates users.demo_balance (single source).
    """
    uid = int(pos_row["user_id"])
    coin = str(pos_row["coin"])
    amount = float(pos_row["amount_usdt"] or 0.0)
    entry = float(pos_row["entry_price"] or 0.0)
    if amount <= 0 or entry <= 0 or sell_price <= 0:
        return False

    qty = amount / entry
    proceeds = qty * sell_price
    pnl = proceeds - amount
    fee = 0.0
    now = int(time.time())

    def work(con, cur):
        row = cur.execute("SELECT demo_balance FROM users WHERE id=? LIMIT 1", (uid,)).fetchone()
        demo_bal = float((row["demo_balance"] if row and row["demo_balance"] is not None else 0.0) or 0.0)
        cur.execute("UPDATE users SET demo_balance=? WHERE id=?", (demo_bal + proceeds, uid))

        cur.execute(
            "UPDATE demo_positions SET current_price=?, pnl=?, status='closed', closed_at=? WHERE id=?",
            (float(sell_price), float(pnl), now, int(pos_row["id"]))
        )

        cur.execute(
            "INSERT INTO demo_trades (user_id, symbol, side, amount_usdt, price, ts, pnl, fee) VALUES (?,?,?,?,?,?,?,?)",
            (str(uid), coin, "SELL", float(amount), float(sell_price), now, float(pnl), float(fee))
        )

        # if there is auto_positions link, close it too (best-effort)
        try:
            cur.execute(
                "UPDATE auto_positions SET status='closed', last_error=NULL, updated_at=? "
                "WHERE user_id=? AND coin=? AND status='open'",
                (now, uid, coin)
            )
        except Exception:
            pass

        return True

    try:
        out = au_safe_write("_au_close_demo_position", "internal", uid, "demo", {"coin": coin, "p": sell_price, "reason": reason}, work)
        return bool(out)
    except Exception:
        # fallback: do not crash loop
        return False

def _au_scan_and_auto_sell_demo():
    """
    Scan open demo positions from auto/ai and close when TP hit.
    Now uses SELL AI Decision Engine for intelligent selling.
    """
    con, cur = au_db()
    try:
        rows = cur.execute(
            "SELECT id,user_id,coin,side,amount_usdt,entry_price,current_price,pnl,status,created_at,closed_at,source "
            "FROM demo_positions WHERE status='open' AND (source='auto' OR source='ai') "
            "ORDER BY id ASC LIMIT 200"
        ).fetchall()
    finally:
        con.close()

    for r in rows:
        try:
            coin = str(r["coin"])
            entry = float(r["entry_price"] or 0.0)
            if entry <= 0:
                continue

            price = _au_demo_price(coin)
            
            # Use SELL AI Decision Engine
            decision = sell_ai_decision_engine(
                symbol=coin,
                entry_price=entry,
                qty=float(r["amount_usdt"] or 0) / entry if entry > 0 else 0,
                entry_time=int(r["created_at"] or 0),
                current_price=price,
                exchange="demo",
                mode="demo"
            )
            
            if decision["action"] == "SELL":
                _au_close_demo_position(r, float(price), decision["reason"].lower())
            else:
                # keep current_price updated (best-effort)
                def work2(con2, cur2):
                    cur2.execute("UPDATE demo_positions SET current_price=? WHERE id=?", (float(price), int(r["id"])))
                    return True
                try:
                    au_safe_write("_au_demo_mark_price", "internal", int(r["user_id"]), "demo", {"coin": coin, "p": price}, work2)
                except Exception:
                    pass
        except Exception as e:
            try:
                _au_log("demo_auto_sell_err", error=str(e))
            except Exception:
                pass
# === END DEMO AUTO SELL HELPERS (STANDALONE) ===


# === SELL AI DECISION ENGINE ===
# SPEC'e gÃ¶re: TradingView sadece BUY verir. SELL'i bu motor yÃ¶netir.
# Hedef: Alttan alÄ±p Ã¼stten satmak. Fee dahil net kar: %0.30 - %0.60

def sell_ai_decision_engine(
    symbol: str,
    entry_price: float,
    qty: float,
    entry_time: int,
    current_price: float,
    exchange: str = "okx",
    mode: str = "demo",
    maker_fee_rate: float = 0.001,
    taker_fee_rate: float = 0.001,
    order_type: str = "market",
    ohlcv_data: list = None,
    best_bid: float = None,
    best_ask: float = None
) -> dict:
    """
    SELL Karar Motoru - AkÄ±llÄ± satÄ±ÅŸ kararÄ± verir
    
    Inputlar:
    - symbol, entry_price, qty, entry_time, exchange
    - maker/taker fee
    - current_price
    - son 200 adet 5m OHLCV (opsiyonel)
    - best_bid, best_ask, spread% (opsiyonel)
    
    Output:
    - action: HOLD/SELL
    - reason: TP_REACHED/TRAIL_STOP/STOP_LOSS/TIME_EXIT/REVERSAL/SPREAD_BAD
    """
    import time
    
    # VarsayÄ±lan Ã§Ä±ktÄ±
    result = {
        "action": "HOLD",
        "reason": "",
        "target_net": 0.005,
        "total_fee_est": 0.002,
        "min_exit_price": 0,
        "trail_pct": 0.0025,
        "trail_stop": 0,
        "stop_price": 0,
        "peak_price": current_price,
        "confidence": 0.0
    }
    
    if entry_price <= 0 or current_price <= 0:
        return result
    
    # Fee hesaplama
    fee_rate = taker_fee_rate if order_type == "market" else maker_fee_rate
    total_fee = fee_rate * 2  # buy + sell
    result["total_fee_est"] = total_fee
    
    # Volatilite bazlÄ± target belirleme
    # DÃ¼ÅŸÃ¼k vol (BTC/ETH): 0.003-0.004
    # Orta vol (SOL/BNB): 0.004-0.0055
    # YÃ¼ksek vol (altcoin): 0.0055-0.007
    high_vol_coins = ["DOGE", "SHIB", "PEPE", "FLOKI", "WIF", "BONK", "MEME"]
    mid_vol_coins = ["SOL", "BNB", "XRP", "ADA", "AVAX", "DOT", "LINK"]
    
    symbol_upper = symbol.upper()
    if any(c in symbol_upper for c in high_vol_coins):
        target_net = 0.006  # %0.6
        stop_pct = 0.007   # %0.7
        trail_pct = 0.0035  # %0.35
        max_hold_minutes = 120  # 2 saat
    elif any(c in symbol_upper for c in mid_vol_coins):
        target_net = 0.005  # %0.5
        stop_pct = 0.0055  # %0.55
        trail_pct = 0.0025  # %0.25
        max_hold_minutes = 180  # 3 saat
    else:  # BTC, ETH ve diÄŸerleri
        target_net = 0.004  # %0.4
        stop_pct = 0.004   # %0.4
        trail_pct = 0.002   # %0.2
        max_hold_minutes = 240  # 4 saat
    
    result["target_net"] = target_net
    result["trail_pct"] = trail_pct
    
    # Minimum Ã§Ä±kÄ±ÅŸ fiyatÄ± (fee dahil kar)
    min_required = total_fee + target_net
    min_exit_price = entry_price * (1 + min_required)
    result["min_exit_price"] = min_exit_price
    
    # Stop loss fiyatÄ±
    stop_price = entry_price * (1 - stop_pct)
    result["stop_price"] = stop_price
    
    # Kar/zarar hesabÄ±
    pnl_pct = (current_price - entry_price) / entry_price
    
    # 1. STOP LOSS KONTROLÃœ (En Ã¶ncelikli)
    if current_price <= stop_price:
        result["action"] = "SELL"
        result["reason"] = "STOP_LOSS"
        result["confidence"] = 0.95
        return result
    
    # 2. TP KONTROLÃœ - Hedef fiyata ulaÅŸtÄ± mÄ±?
    if current_price >= min_exit_price:
        result["action"] = "SELL"
        result["reason"] = "TP_REACHED"
        result["confidence"] = 0.85
        
        # Peak tracking iÃ§in trailing stop
        peak_price = max(current_price, entry_price * (1 + target_net * 1.5))
        result["peak_price"] = peak_price
        trail_stop = peak_price * (1 - trail_pct)
        result["trail_stop"] = trail_stop
        
        # Trailing stop tetiklendi mi?
        if current_price <= trail_stop:
            result["reason"] = "TRAIL_STOP"
            result["confidence"] = 0.90
        
        return result
    
    # 3. ZAMAN AÅIMI KONTROLÃœ
    current_time = int(time.time())
    hold_minutes = (current_time - entry_time) / 60 if entry_time > 0 else 0
    
    if hold_minutes >= max_hold_minutes:
        # Break-even veya kÃ¼Ã§Ã¼k zararla Ã§Ä±k
        breakeven_price = entry_price * (1 + total_fee)
        if current_price >= breakeven_price:
            result["action"] = "SELL"
            result["reason"] = "TIME_EXIT"
            result["confidence"] = 0.75
        else:
            # KÃ¼Ã§Ã¼k zarar ama zaman aÅŸÄ±mÄ± - yine de sat
            result["action"] = "SELL"
            result["reason"] = "TIME_EXIT"
            result["confidence"] = 0.65
        return result
    
    # 4. SPREAD KONTROLÃœ (opsiyonel)
    if best_bid and best_ask and best_ask > 0:
        spread_pct = (best_ask - best_bid) / best_ask
        if spread_pct > 0.0012:  # %0.12'den bÃ¼yÃ¼k spread
            # Spread kÃ¶tÃ¼ - market sell riskli
            if pnl_pct > total_fee:  # Karda isek yine de sat
                result["action"] = "SELL"
                result["reason"] = "SPREAD_BAD"
                result["confidence"] = 0.60
                return result
    
    # 5. REVERSAL KONTROLÃœ (basit)
    # EÄŸer %0.3'ten fazla dÃ¼ÅŸÃ¼ÅŸ ve zarardaysak - reversal
    if pnl_pct < -0.003 and pnl_pct > -stop_pct:
        # HenÃ¼z stop loss'a gelmedi ama dÃ¼ÅŸÃ¼yor
        # HOLD - stop loss'u bekle
        pass
    
    # VarsayÄ±lan: HOLD
    result["action"] = "HOLD"
    result["confidence"] = 0.5
    return result

# === END SELL AI DECISION ENGINE ===

def _au_try_open_real_trade(auto_row):
    # REAL: demoâ€™ya dokunma. Sadece adaptor varsa dener; yoksa last_error yazar.
    # Bu aÅŸamada sistem Ã§Ã¶kmesin diye â€œadaptÃ¶r yoksaâ€ waitingâ€™de bÄ±rakÄ±yoruz.
    coin = str(auto_row["coin"])
    amount = float(auto_row["amount_usdt"] or 0.0)

    # muhtemel adaptÃ¶r isimleri (varsa kullan)
    adaptor_candidates = [
        "place_order", "exchange_place_order", "okx_place_order", "binance_place_order",
        "bybit_place_order", "gate_place_order",
    ]
    fn = None
    for name in adaptor_candidates:
        f = globals().get(name)
        if callable(f):
            fn = f
            break

    if fn is None:
        _au_mark_error(int(auto_row["id"]), "REAL_ADAPTER_NOT_FOUND")
        return False

    try:
        # imza bilinmediÄŸi iÃ§in Ã§ok gÃ¼venli deneme: kwargs ile
        res = fn(symbol=coin, side="BUY", amount_usdt=amount)
        # baÅŸarÄ±lÄ± sayÄ±p openâ€™a Ã§ekelim
        now = int(time.time())
        con, cur = _au_sqlite()
        cur.execute(
            "UPDATE auto_positions SET status='open', opened_at=?, last_error=NULL, updated_at=? WHERE id=?",
            (now, now, int(auto_row["id"]))
        )
        con.commit()
        con.close()
        return True
    except Exception as e:
        _au_mark_error(int(auto_row["id"]), f"REAL_ORDER_FAIL: {e}")
        return False

_AU_AUTO_EXEC_THREAD = None
_AU_AUTO_EXEC_LOCK = threading.Lock()
_AU_AUTO_EXEC_WAKE = threading.Event()

def _au_auto_executor_once():
    _au_ensure_auto_schema_v1()
    con, cur = _au_sqlite()

    # waiting kayÄ±tlarÄ± al (paused alma)
    rows = cur.execute(
        "SELECT id,user_id,mode,coin,amount_usdt,status,created_at "
        "FROM auto_positions WHERE status='waiting' ORDER BY id ASC LIMIT 20"
    ).fetchall()
    con.close()

    for r in rows:
        try:
            mode = (r["mode"] or "").strip().lower()
            if mode in ("real","live"):
                _au_try_open_real_trade(r)
            else:
                _au_open_demo_trade(r)
        except Exception as e:
            _au_mark_error(int(r["id"]), f"EXECUTOR_EXCEPTION: {e}")

def _au_auto_executor_loop():
    while True:
        try:
            _au_auto_executor_once()
        except Exception as e:
            try:
                _au_log("auto_executor_loop_err", error=str(e))
            except Exception:
                pass

        # DEMO SELL SCAN
        try:
            _au_scan_and_auto_sell_demo()
        except Exception as e:
            try:
                _au_log("demo_sell_scan_fail", error=str(e))
            except Exception:
                pass


# === AU_API_EXECNOW_SELLSCAN_V1 ===
@app.post("/api/auto/exec_now")
def api_auto_exec_now():
    from flask import jsonify, session
    # JSON-only, no redirect
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    try:
        # Prefer existing executor
        if " _au_auto_executor_once" in " " + "".join(globals().keys()):
            # (string trick not needed; kept safe)
            pass
        if " _au_auto_executor_once" in " ":
            pass
    except Exception:
        pass

    try:
        fn = globals().get("_au_auto_executor_once")
        if callable(fn):
            fn()
            return jsonify({"ok": True, "ran": "_au_auto_executor_once"}), 200

        # Fallback: open up to 20 waiting rows (demo/real)
        con, cur = au_db() if callable(globals().get("au_db")) else _au_sqlite()
        try:
            rows = cur.execute(
                "SELECT id,user_id,mode,coin,amount_usdt,status,created_at "
                "FROM auto_positions WHERE status='waiting' ORDER BY id ASC LIMIT 20"
            ).fetchall()
        finally:
            try: con.close()
            except Exception: pass

        opened = 0
        errors = 0
        for r in rows:
            try:
                mode = (r["mode"] or "").strip().lower()
                if mode in ("real","live"):
                    fn2 = globals().get("_au_try_open_real_trade")
                    if callable(fn2):
                        fn2(r)
                        opened += 1
                    else:
                        errors += 1
                else:
                    fn3 = globals().get("_au_open_demo_trade")
                    if callable(fn3):
                        fn3(r)
                        opened += 1
                    else:
                        errors += 1
            except Exception:
                errors += 1

        return jsonify({"ok": True, "ran": "fallback", "opened": opened, "errors": errors}), 200

    except Exception as e:
        try:
            _au_log("api_auto_exec_now_err", error=str(e))
        except Exception:
            pass
        return jsonify({"ok": False, "error": str(e)}), 500


# @app.post("/api/demo/sell_scan_now")
def api_demo_sell_scan_now():
    from flask import jsonify, session
    # JSON-only, no redirect
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    try:
        fn = globals().get("_au_scan_and_auto_sell_demo")
        if callable(fn):
            fn()
            return jsonify({"ok": True}), 200
        return jsonify({"ok": False, "error": "_au_scan_and_auto_sell_demo not found"}), 500
    except Exception as e:
        try:
            _au_log("api_demo_sell_scan_now_err", error=str(e))
        except Exception:
            pass
        return jsonify({"ok": False, "error": str(e)}), 500
# === END AU_API_EXECNOW_SELLSCAN_V1 ===


# === AU_AUTO_ENQUEUE_WAITING_V1 ===
def _au_enqueue_waiting(user_id: int, username: str, mode: str, coin: str, amount_usdt: float, target_pct=None):
    """
    Ensure a waiting row exists for this user/mode/coin.
    If paused exists -> set waiting. If waiting exists -> keep. Else insert waiting.
    """
    mode = (mode or "").strip().lower() or "demo"
    coin = (coin or "").strip()
    if not coin:
        return {"ok": False, "error": "COIN_EMPTY"}
    try:
        amount = float(amount_usdt)
    except Exception:
        amount = 0.0
    if amount <= 0:
        return {"ok": False, "error": "BAD_AMOUNT"}

    now = int(time.time())

    con, cur = _au_sqlite()
    try:
        # 1) if paused exists -> flip to waiting
        row = cur.execute(
            "SELECT id,status FROM auto_positions WHERE user_id=? AND mode=? AND coin=? AND status IN ('paused','waiting') ORDER BY id DESC LIMIT 1",
            (int(user_id), mode, coin)
        ).fetchone()

        if row:
            rid = int(row["id"])
            st = (row["status"] or "").strip().lower()
            if st == "paused":
                cur.execute(
                    "UPDATE auto_positions SET status='waiting', amount_usdt=?, target_pct=?, updated_at=? WHERE id=?",
                    (float(amount), (float(target_pct) if target_pct is not None else None), now, rid)
                )
                con.commit()
                return {"ok": True, "action": "paused_to_waiting", "id": rid}
            if st == "waiting":
                # update amount/target (nice to have)
                cur.execute(
                    "UPDATE auto_positions SET amount_usdt=?, target_pct=?, updated_at=? WHERE id=?",
                    (float(amount), (float(target_pct) if target_pct is not None else None), now, rid)
                )
                con.commit()
                return {"ok": True, "action": "waiting_exists", "id": rid}

        # 2) insert new waiting
        cur.execute(
            "INSERT INTO auto_positions (user_id, username, mode, coin, amount_usdt, status, created_at, target_pct, updated_at) "
            "VALUES (?,?,?,?,?,'waiting',?,?,?)",
            (int(user_id), str(username or ""), mode, coin, float(amount), now, (float(target_pct) if target_pct is not None else None), now)
        )
        rid = cur.lastrowid
        con.commit()
        return {"ok": True, "action": "insert_waiting", "id": int(rid)}
    finally:
        try: con.close()
        except Exception: pass


@app.post("/api/auto/start")
def api_auto_start_json():
    from flask import request, session, jsonify
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401

    uid = session.get("user_id") or session.get("uid") or session.get("id")
    username = session.get("username") or session.get("user") or session.get("email") or ""
    if not uid:
        return jsonify({"ok": False, "error": "NO_USER_ID"}), 400

    data = request.get_json(silent=True) or {}
    coin = data.get("coin") or data.get("symbol") or data.get("pair") or ""
    mode = data.get("mode") or session.get("mode") or "demo"
    amount = data.get("amount_usdt") or data.get("amount") or 0
    target = data.get("target_pct")

    out = _au_enqueue_waiting(int(uid), str(username), str(mode), str(coin), float(amount), target)
    code = 200 if out.get("ok") else 400
    return jsonify(out), code


@app.post("/api/auto/add")
def api_auto_add_json():
    # alias: UI bazen /api/auto/add kullanÄ±yor
    return api_auto_start_json()
# === END AU_AUTO_ENQUEUE_WAITING_V1 ===


# === EMERGENT PLATFORM API/APP ROUTES ===
# Duplicate routes under /api/app/ prefix for Emergent platform compatibility
# This allows Flask HTML pages to be accessed via /api/app/* path

@app.route("/api/app/register", methods=["GET", "POST"])
def api_app_register():
    return register_route()

@app.route("/api/app/forgot-password", methods=["GET", "POST"])  
def api_app_forgot_password():
    return forgot_password_route()

@app.route("/api/app/logout")
def api_app_logout():
    return logout_route()

@app.route("/api/app/dashboard")
@app.route("/api/app/trading-dashboard")
def api_app_dashboard():
    return page_trading_dashboard()

@app.route("/api/app/admin")
@app.route("/api/app/admin/dashboard")
def api_app_admin_dashboard():
    return page_admin_dashboard()

@app.route("/api/app/admin/users")
def api_app_admin_users():
    return admin_users_page()

@app.route("/api/app/admin/contracts")
def api_app_admin_contracts():
    return admin_contracts_page()

@app.route("/api/app/admin/webhooks")
def api_app_admin_webhooks():
    return admin_webhooks_page()

def api_app_education():
    return page_education()

@app.route("/api/app/portfolio")
@app.route("/api/app/portfolio-analytics")
def api_app_portfolio():
    return page_portfolio()

@app.route("/api/app/payment")
@app.route("/api/app/payment-management")
def api_app_payment():
    return page_payment()

@app.route("/api/app/exchange-api")
def api_app_exchange_api():
    return page_exchange_api()

@app.route("/api/app/history")
@app.route("/api/app/trade-history")
def api_app_history():
    return page_history()

@app.route("/api/app/market")
@app.route("/api/app/market-analysis")
def api_app_market():
    return page_market()

@app.route("/api/app/chat")
@app.route("/api/app/live-trading-chat")
def api_app_chat():
    return page_chat()

@app.route("/api/app/pnl-reporting-center")
def api_app_pnl():
    return page_pnl_report()

@app.route("/api/app/ai-trade-recommendations")
def api_app_ai_reco():
    return page_ai_recommendations()

@app.route("/api/app/arbitrage-monitor")
def api_app_arbitrage():
    return page_arbitrage()

@app.route("/api/app/getting-started")
@app.route("/api/app/getting-started-guide")
def api_app_getting_started():
    return page_getting_started()

@app.route("/api/app/about")
@app.route("/api/app/hakkimizda")
def api_app_about():
    return page_about()

@app.route("/api/app/faq")
def api_app_faq():
    return page_faq()

@app.route("/api/app/support")
def api_app_support():
    return page_support()

@app.route("/api/app/contact")
def api_app_contact():
    return page_contact()

@app.route("/api/app/notifications")
def api_app_notifications():
    return notifications_route()

@app.route("/api/app/system-health")
def api_app_system_health():
    return system_health_route()

# === REFERRAL SYSTEM ===

# Admin Settings Page for Referral URL
ADMIN_SETTINGS_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin AyarlarÄ± | Atalay Ulusoy Auto Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0a0a0a] min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-[#0f0f0f] border-r border-white/5 min-h-screen hidden lg:block">
            <div class="p-4 border-b border-white/5">
                <h2 class="text-xl font-bold text-orange-500">âš™ï¸ Admin Panel</h2>
            </div>
            <nav class="flex-1 p-4 space-y-1">
                <a href="/api/app/admin" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“Š Dashboard</a>
                <a href="/api/app/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</a>
                <a href="/api/app/admin/packages" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“¦ Paket YÃ¶netimi</a>
                <a href="/api/app/admin/telegram" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“± Telegram AyarlarÄ±</a>
                <a href="/api/app/admin/webhooks" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ”— Webhook YapÄ±landÄ±rmasÄ±</a>
                <a href="/api/app/admin/education" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ EÄŸitim Merkezi</a>
                <a href="/api/app/admin/analytics" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5">ğŸ“ˆ Analitik</a>
                <a href="/api/app/admin/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-orange-600/20 text-orange-400">âš™ï¸ Ayarlar</a>
            </nav>
            <div class="p-4 border-t border-white/5">
                <a href="/api/app/dashboard" class="text-sm text-gray-400 hover:text-white">ğŸ  Ana Sayfaya DÃ¶n</a>
            </div>
        </aside>
        
        <main class="flex-1 p-6">
            <h1 class="text-2xl font-bold text-white mb-6">âš™ï¸ Sistem AyarlarÄ±</h1>
            
            <div class="grid gap-6">
                <!-- Referral URL Settings -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <span class="text-green-400">ğŸ</span> Referans Sistemi AyarlarÄ±
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Referans Base URL</label>
                            <input type="text" id="referralBaseUrl" placeholder="https://yourdomain.com" 
                                   class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white">
                            <p class="text-gray-500 text-xs mt-1">KullanÄ±cÄ±lara gÃ¶sterilecek referans linki domain'i</p>
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Davet Bonusu (TL)</label>
                            <input type="number" id="referralBonus" value="500" 
                                   class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Komisyon OranÄ± (%)</label>
                            <input type="number" id="referralCommission" value="10" 
                                   class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white">
                        </div>
                    </div>
                </div>
                
                <!-- Payment Settings -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <span class="text-blue-400">ğŸ’³</span> Ã–deme AyarlarÄ±
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">IBAN</label>
                            <input type="text" id="adminIban" placeholder="TR00 0000 0000 0000 0000 0000 00" 
                                   class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white font-mono">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Hesap Sahibi AdÄ±</label>
                            <input type="text" id="adminAccountName" placeholder="Ad Soyad" 
                                   class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Banka AdÄ±</label>
                            <input type="text" id="adminBankName" placeholder="Banka AdÄ±" 
                                   class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-3 text-white">
                        </div>
                    </div>
                </div>
                
                <!-- Save Button -->
                <button onclick="saveSettings()" class="w-full py-3 rounded-xl bg-green-600 hover:bg-green-500 text-white font-bold transition">
                    ğŸ’¾ AyarlarÄ± Kaydet
                </button>
            </div>
        </main>
    </div>
    
    <script>
        // Load current settings
        async function loadSettings() {
            try {
                const res = await fetch('/api/admin/settings', {credentials: 'include'});
                const data = await res.json();
                if (data.ok && data.settings) {
                    document.getElementById('referralBaseUrl').value = data.settings.referral_base_url || '';
                    document.getElementById('referralBonus').value = data.settings.referral_bonus || 500;
                    document.getElementById('referralCommission').value = data.settings.referral_commission || 10;
                    document.getElementById('adminIban').value = data.settings.admin_iban || '';
                    document.getElementById('adminAccountName').value = data.settings.admin_account_name || '';
                    document.getElementById('adminBankName').value = data.settings.admin_bank_name || '';
                }
            } catch(e) { console.error('Load settings error:', e); }
        }
        
        async function saveSettings() {
            const settings = {
                referral_base_url: document.getElementById('referralBaseUrl').value,
                referral_bonus: document.getElementById('referralBonus').value,
                referral_commission: document.getElementById('referralCommission').value,
                admin_iban: document.getElementById('adminIban').value,
                admin_account_name: document.getElementById('adminAccountName').value,
                admin_bank_name: document.getElementById('adminBankName').value
            };
            
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(settings)
                });
                const data = await res.json();
                if (data.ok) {
                    alert('âœ… Ayarlar kaydedildi!');
                } else {
                    alert('âŒ Hata: ' + (data.error || 'Bilinmeyen hata'));
                }
            } catch(e) {
                alert('âŒ Hata: ' + e.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>
</html>
"""

@app.route('/api/app/admin/settings')
@app.route('/admin/settings')
def page_admin_settings():
    if not session.get("logged_in"):
        return redirect("/api/app/login")
    if not session.get("is_admin"):
        return redirect("/api/app/dashboard")
    return render_template_string(ADMIN_SETTINGS_TEMPLATE)

REFERRAL_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referans Sistemi | Atalay Ulusoy Auto Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0066cc',
                        background: '#0f0f0f',
                        card: '#1a1a1a',
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #0f0f0f; color: #e8e8e8; font-family: 'Outfit', sans-serif; }
        .copy-btn:hover { transform: scale(1.05); }
        .reward-card { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
    </style>
</head>
<body class="min-h-screen">
    {{ sidebar | safe }}
    
    <main class="lg:ml-64 p-4 lg:p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-2xl lg:text-3xl font-bold text-white mb-2">ğŸ Referans Sistemi</h1>
                <p class="text-gray-400">ArkadaÅŸlarÄ±nÄ±zÄ± davet edin, birlikte kazanÄ±n!</p>
            </div>
            
            <!-- Referral Code Card -->
            <div class="reward-card rounded-2xl p-6 mb-6 border border-white/10">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-1">Sizin Referans Kodunuz</h3>
                        <p class="text-gray-400 text-sm">Bu kodu arkadaÅŸlarÄ±nÄ±zla paylaÅŸÄ±n</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="bg-black/30 rounded-xl px-6 py-3 border border-white/20">
                            <span id="refCode" class="text-2xl font-mono font-bold text-green-400">{{ referral_code }}</span>
                        </div>
                        <button onclick="copyCode()" class="copy-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-xl transition-all">
                            ğŸ“‹ Kopyala
                        </button>
                    </div>
                </div>
                
                <!-- Share Link -->
                <div class="mt-4 pt-4 border-t border-white/10">
                    <p class="text-sm text-gray-400 mb-2">PaylaÅŸÄ±m Linki:</p>
                    <div class="flex items-center gap-2">
                        <input type="text" id="shareLink" value="{{ share_link }}" readonly 
                               class="flex-1 bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-sm text-gray-300">
                        <button onclick="copyLink()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-all">
                            Link Kopyala
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-3xl mb-2">ğŸ‘¥</div>
                    <div class="text-2xl font-bold text-white">{{ total_referrals }}</div>
                    <div class="text-sm text-gray-400">Toplam Davet</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-3xl mb-2">âœ…</div>
                    <div class="text-2xl font-bold text-green-400">{{ active_referrals }}</div>
                    <div class="text-sm text-gray-400">Aktif KullanÄ±cÄ±</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-3xl mb-2">ğŸ’°</div>
                    <div class="text-2xl font-bold text-yellow-400">{{ total_earnings }} TL</div>
                    <div class="text-sm text-gray-400">Toplam KazanÃ§</div>
                </div>
            </div>
            
            <!-- Rewards Info -->
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10 mb-6">
                <h3 class="text-lg font-semibold text-white mb-4">ğŸ¯ Ã–dÃ¼l Sistemi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-black/20 rounded-lg p-4">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-2xl">ğŸ</span>
                            <span class="font-semibold text-white">Davet Eden</span>
                        </div>
                        <ul class="text-sm text-gray-400 space-y-1">
                            <li>â€¢ Her aktif davet iÃ§in <span class="text-green-400 font-semibold">500 TL</span> bonus</li>
                            <li>â€¢ Davetlinin ilk ay Ã¶demesinden <span class="text-green-400 font-semibold">%10</span> komisyon</li>
                            <li>â€¢ 5 davet = <span class="text-yellow-400 font-semibold">1 ay Ã¼cretsiz Premium</span></li>
                        </ul>
                    </div>
                    <div class="bg-black/20 rounded-lg p-4">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-2xl">ğŸŒŸ</span>
                            <span class="font-semibold text-white">Davet Edilen</span>
                        </div>
                        <ul class="text-sm text-gray-400 space-y-1">
                            <li>â€¢ KayÄ±tta <span class="text-green-400 font-semibold">250 TL</span> hoÅŸgeldin bonusu</li>
                            <li>â€¢ Ä°lk ay <span class="text-green-400 font-semibold">%15</span> indirim</li>
                            <li>â€¢ <span class="text-blue-400 font-semibold">7 gÃ¼n</span> Ã¼cretsiz deneme sÃ¼resi</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Referral History -->
            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Ä°ÅŸlem</div>
                    <div class="text-2xl font-bold text-white">{{ total_trades }}</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">BaÅŸarÄ± OranÄ±</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(success_rate) }}%</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Toplam Kar/Zarar</div>
                    <div class="text-2xl font-bold {% if total_pnl >= 0 %}text-green-500{% else %}text-red-500{% endif %}">{{ "%.2f"|format(total_pnl) }} â‚º</div>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl p-5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-2">Ortalama Hacim</div>
                    <div class="text-2xl font-bold text-white">{{ "%.2f"|format(avg_volume) }} â‚º</div>
                </div>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-6 border border-white/10">
                <h3 class="text-lg font-semibold text-white mb-4">ğŸ“‹ Davet GeÃ§miÅŸi</h3>
                {% if referrals %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-gray-400 border-b border-white/10">
                                <th class="text-left py-3 px-2">KullanÄ±cÄ±</th>
                                <th class="text-left py-3 px-2">Durum</th>
                                <th class="text-left py-3 px-2">Tarih</th>
                                <th class="text-right py-3 px-2">KazanÃ§</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ref in referrals %}
                            <tr class="border-b border-white/5 hover:bg-white/5">
                                <td class="py-3 px-2 text-white">{{ ref.username }}</td>
                                <td class="py-3 px-2">
                                    {% if ref.status == 'active' %}
                                    <span class="px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">Aktif</span>
                                    {% else %}
                                    <span class="px-2 py-1 rounded-full text-xs bg-yellow-500/20 text-yellow-400">Bekliyor</span>
                                    {% endif %}
                                </td>
                                <td class="py-3 px-2 text-gray-400">{{ ref.date }}</td>
                                <td class="py-3 px-2 text-right text-green-400 font-semibold">{{ ref.reward }} TL</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="text-4xl mb-3">ğŸ‘‹</div>
                    <p class="text-gray-400">HenÃ¼z davet ettiÄŸiniz kimse yok.</p>
                    <p class="text-sm text-gray-500 mt-1">Referans kodunuzu paylaÅŸarak kazanmaya baÅŸlayÄ±n!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
    
    <script>
    function copyCode() {
        const code = document.getElementById('refCode').textContent;
        navigator.clipboard.writeText(code).then(() => {
            alert('Referans kodu kopyalandÄ±: ' + code);
        });
    }
    function copyLink() {
        const link = document.getElementById('shareLink').value;
        navigator.clipboard.writeText(link).then(() => {
            alert('PaylaÅŸÄ±m linki kopyalandÄ±!');
        });
    }
    </script>
</body>
</html>
"""

@app.route("/api/app/referral")
def api_app_referral():
    if not session.get("logged_in"):
        return redirect("/api/app/login")
    
    username = session.get("username")
    user = get_user(username)
    if not user:
        return redirect("/api/app/login")
    
    referral_code = user.get("referral_code", "")
    if not referral_code:
        import secrets
        referral_code = f"REF{secrets.token_hex(4).upper()}"
        with db() as conn:
            conn.execute("UPDATE users SET referral_code = ? WHERE username = ?", (referral_code, username))
            conn.commit()
    
    # Get referral stats
    with db() as conn:
        # Total referrals
        total = conn.execute("SELECT COUNT(*) FROM referrals WHERE referrer_id = (SELECT rowid FROM users WHERE username = ?)", (username,)).fetchone()[0]
        # Active referrals
        active = conn.execute("SELECT COUNT(*) FROM referrals WHERE referrer_id = (SELECT rowid FROM users WHERE username = ?) AND status = 'active'", (username,)).fetchone()[0]
        # Total earnings
        earnings = user.get("referral_earnings", 0) or 0
        
        # Get referral history
        referrals = []
        rows = conn.execute("""
            SELECT u.display_name, r.status, r.created_at, r.reward_given
            FROM referrals r
            JOIN users u ON u.rowid = r.referred_id
            WHERE r.referrer_id = (SELECT rowid FROM users WHERE username = ?)
            ORDER BY r.created_at DESC
            LIMIT 20
        """, (username,)).fetchall()
        
        for row in rows:
            from datetime import datetime
            referrals.append({
                "username": row[0] or "KullanÄ±cÄ±",
                "status": row[1],
                "date": datetime.fromtimestamp(row[2]).strftime("%d.%m.%Y") if row[2] else "-",
                "reward": row[3] or 0
            })
    
    # Get base URL from settings
    try:
        conn_settings = db()
        row = conn_settings.execute("SELECT value FROM settings WHERE key='referral_base_url'").fetchone()
        conn_settings.close()
        base_url = row[0] if row and row[0] else "https://atalayulusoy.com"
    except:
        base_url = "https://atalayulusoy.com"
    
    share_link = f"{base_url}/register?ref={referral_code}"
    
    return render_template_string(REFERRAL_TEMPLATE,
        sidebar=get_sidebar_html("referral"),
        referral_code=referral_code,
        share_link=share_link,
        total_referrals=total,
        active_referrals=active,
        total_earnings=earnings,
        referrals=referrals
    )

# API endpoint for referral info
@app.route("/api/referral/info")
def api_referral_info():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    username = session.get("username")
    user = get_user(username)
    if not user:
        return jsonify({"ok": False, "error": "User not found"}), 404
    
    with db() as conn:
        total = conn.execute("SELECT COUNT(*) FROM referrals WHERE referrer_id = (SELECT rowid FROM users WHERE username = ?)", (username,)).fetchone()[0]
        active = conn.execute("SELECT COUNT(*) FROM referrals WHERE referrer_id = (SELECT rowid FROM users WHERE username = ?) AND status = 'active'", (username,)).fetchone()[0]
    
    return jsonify({
        "ok": True,
        "referral_code": user.get("referral_code", ""),
        "total_referrals": total,
        "active_referrals": active,
        "total_earnings": user.get("referral_earnings", 0) or 0
    })

# === END REFERRAL SYSTEM ===

# === DEMO/REAL MODE POSITIONS API ===
@app.route("/api/positions/list")
def api_positions_list():
    """Get positions filtered by current mode (DEMO/REAL)"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    username = session.get("username")
    mode = session.get("ui_mode", "demo").lower()
    
    with db() as conn:
        conn.row_factory = sqlite3.Row
        
        if mode == "real":
            # Real positions
            rows = conn.execute("""
                SELECT id, coin, side, amount_usdt, entry_price, current_price, pnl, status, created_at
                FROM real_positions
                WHERE user_id = (SELECT rowid FROM users WHERE username = ?)
                AND status IN ('open', 'waiting')
                ORDER BY created_at DESC
            """, (username,)).fetchall()
        else:
            # Demo positions
            rows = conn.execute("""
                SELECT id, coin, side, amount_usdt, entry_price, current_price, pnl, status, created_at
                FROM demo_positions
                WHERE user_id = (SELECT rowid FROM users WHERE username = ?)
                AND status IN ('open', 'waiting')
                ORDER BY created_at DESC
            """, (username,)).fetchall()
        
        positions = [dict(row) for row in rows]
    
    return jsonify({"ok": True, "mode": mode, "positions": positions})

# === END DEMO/REAL MODE POSITIONS API ===

# === SELL AI API ENDPOINT ===
@app.route("/api/sell/decision")
def api_sell_decision():
    """Get SELL AI decision for a position"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    symbol = request.args.get("symbol", "")
    entry_price = float(request.args.get("entry_price", 0))
    current_price = float(request.args.get("current_price", 0))
    entry_time = int(request.args.get("entry_time", 0))
    qty = float(request.args.get("qty", 0))
    
    if not symbol or entry_price <= 0:
        return jsonify({"ok": False, "error": "Invalid parameters"}), 400
    
    # Get current price if not provided
    if current_price <= 0:
        current_price = _au_demo_price(symbol)
    
    decision = sell_ai_decision_engine(
        symbol=symbol,
        entry_price=entry_price,
        qty=qty,
        entry_time=entry_time,
        current_price=current_price,
        mode=session.get("ui_mode", "demo")
    )
    
    return jsonify({"ok": True, **decision})

# === END SELL AI API ENDPOINT ===

# === TERMS AND PRIVACY PAGES ===
@app.route("/api/app/terms-of-use")
def api_app_terms_of_use():
    """KullanÄ±m KoÅŸullarÄ± sayfasÄ±"""
    return render_template_string("""
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KullanÄ±m KoÅŸullarÄ± | Atalay Ulusoy Auto Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background: #0f0f0f; color: #e8e8e8; }</style>
</head>
<body class="min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-white">KullanÄ±m KoÅŸullarÄ±</h1>
        
        <div class="prose prose-invert">
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">1. Genel HÃ¼kÃ¼mler</h2>
            <p class="text-gray-300 mb-4">Bu platform, kripto para birimi ticareti iÃ§in otomatik iÅŸlem botu hizmeti sunmaktadÄ±r. Platformu kullanarak aÅŸaÄŸÄ±daki koÅŸullarÄ± kabul etmiÅŸ sayÄ±lÄ±rsÄ±nÄ±z.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">2. Risk Bildirimi</h2>
            <p class="text-gray-300 mb-4">Kripto para birimi ticareti yÃ¼ksek risk iÃ§erir. YatÄ±rÄ±m kararlarÄ±nÄ±zdan tamamen kendiniz sorumlusunuz. GeÃ§miÅŸ performans gelecekteki sonuÃ§larÄ± garanti etmez.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">3. Hizmet KullanÄ±mÄ±</h2>
            <p class="text-gray-300 mb-4">Platform sadece bilgilendirme amaÃ§lÄ±dÄ±r ve yatÄ±rÄ±m tavsiyesi niteliÄŸi taÅŸÄ±maz. DEMO mod ile gerÃ§ek para kullanÄ±lmadan test yapabilirsiniz.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">4. Sorumluluk Reddi</h2>
            <p class="text-gray-300 mb-4">Platform saÄŸlayÄ±cÄ±sÄ±, iÅŸlemlerden kaynaklanan herhangi bir zarar veya kayÄ±ptan sorumlu tutulamaz.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">5. DeÄŸiÅŸiklikler</h2>
            <p class="text-gray-300 mb-4">Bu koÅŸullar Ã¶nceden haber vermeksizin deÄŸiÅŸtirilebilir. GÃ¼ncel koÅŸullarÄ± dÃ¼zenli olarak kontrol etmeniz Ã¶nerilir.</p>
        </div>
        
        <div class="mt-8">
            <a href="/api/app/login" class="text-blue-500 hover:text-blue-400">&larr; GiriÅŸ SayfasÄ±na DÃ¶n</a>
        </div>
    </div>
</body>
</html>
    """)

@app.route("/api/app/privacy-policy")
def api_app_privacy_policy():
    """Gizlilik PolitikasÄ± sayfasÄ±"""
    return render_template_string("""
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gizlilik PolitikasÄ± | Atalay Ulusoy Auto Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background: #0f0f0f; color: #e8e8e8; }</style>
</head>
<body class="min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-white">Gizlilik PolitikasÄ±</h1>
        
        <div class="prose prose-invert">
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">1. Toplanan Bilgiler</h2>
            <p class="text-gray-300 mb-4">Platformumuz, hizmet sunmak iÃ§in gerekli olan minimum kiÅŸisel bilgileri toplar: kullanÄ±cÄ± adÄ±, e-posta adresi ve borsa API anahtarlarÄ±.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">2. Bilgi KullanÄ±mÄ±</h2>
            <p class="text-gray-300 mb-4">Toplanan bilgiler yalnÄ±zca hizmet sunmak, hesabÄ±nÄ±zÄ± yÃ¶netmek ve gÃ¼venliÄŸi saÄŸlamak iÃ§in kullanÄ±lÄ±r.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">3. API AnahtarlarÄ±</h2>
            <p class="text-gray-300 mb-4">Borsa API anahtarlarÄ±nÄ±z ÅŸifrelenmiÅŸ olarak saklanÄ±r ve yalnÄ±zca iÅŸlem emirleri gÃ¶ndermek iÃ§in kullanÄ±lÄ±r. AnahtarlarÄ±nÄ±za Ã¼Ã§Ã¼ncÃ¼ taraflarÄ±n eriÅŸimi yoktur.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">4. Veri GÃ¼venliÄŸi</h2>
            <p class="text-gray-300 mb-4">Verileriniz endÃ¼stri standardÄ± gÃ¼venlik Ã¶nlemleriyle korunmaktadÄ±r. SSL ÅŸifreleme ve gÃ¼venli sunucu altyapÄ±sÄ± kullanÄ±lmaktadÄ±r.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">5. ÃœÃ§Ã¼ncÃ¼ Taraflar</h2>
            <p class="text-gray-300 mb-4">KiÅŸisel bilgileriniz yasal zorunluluklar dÄ±ÅŸÄ±nda Ã¼Ã§Ã¼ncÃ¼ taraflarla paylaÅŸÄ±lmaz.</p>
            
            <h2 class="text-xl font-semibold text-white mt-6 mb-4">6. Ä°letiÅŸim</h2>
            <p class="text-gray-300 mb-4">Gizlilik politikamÄ±zla ilgili sorularÄ±nÄ±z iÃ§in destek ekibimizle iletiÅŸime geÃ§ebilirsiniz.</p>
        </div>
        
        <div class="mt-8">
            <a href="/api/app/login" class="text-blue-500 hover:text-blue-400">&larr; GiriÅŸ SayfasÄ±na DÃ¶n</a>
        </div>
    </div>
</body>
</html>
    """)

# === END TERMS AND PRIVACY PAGES ===

# === ADMIN EDUCATION VIDEOS CRUD ===
def api_admin_education_videos_list():
    """List all education videos (admin only)"""
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin access required"}), 403
    
    with db() as conn:
        conn.row_factory = sqlite3.Row
        rows = conn.execute("""
            SELECT id, title, description, category, video_url, thumbnail_url, duration, sort_order, is_active, created_at
            FROM education_videos
            ORDER BY sort_order ASC, id DESC
        """).fetchall()
        videos = [dict(row) for row in rows]
    
    return jsonify({"ok": True, "videos": videos})

def api_admin_education_videos_add():
    """Add new education video (admin only)"""
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin access required"}), 403
    
    data = request.get_json() or {}
    title = data.get("title", "").strip()
    description = data.get("description", "").strip()
    category = data.get("category", "genel").strip()
    video_url = data.get("video_url", "").strip()
    thumbnail_url = data.get("thumbnail_url", "").strip()
    duration = int(data.get("duration", 0))
    sort_order = int(data.get("sort_order", 0))
    
    if not title:
        return jsonify({"ok": False, "error": "BaÅŸlÄ±k gerekli"}), 400
    
    with db() as conn:
        conn.execute("""
            INSERT INTO education_videos (title, description, category, video_url, thumbnail_url, duration, sort_order)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        """, (title, description, category, video_url, thumbnail_url, duration, sort_order))
        conn.commit()
    
    return jsonify({"ok": True, "message": "Video eklendi"})

def api_admin_education_videos_update(video_id):
    """Update education video (admin only)"""
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin access required"}), 403
    
    data = request.get_json() or {}
    
    with db() as conn:
        conn.execute("""
            UPDATE education_videos SET
                title = COALESCE(?, title),
                description = COALESCE(?, description),
                category = COALESCE(?, category),
                video_url = COALESCE(?, video_url),
                thumbnail_url = COALESCE(?, thumbnail_url),
                duration = COALESCE(?, duration),
                sort_order = COALESCE(?, sort_order),
                is_active = COALESCE(?, is_active),
                updated_at = strftime('%s', 'now')
            WHERE id = ?
        """, (
            data.get("title"),
            data.get("description"),
            data.get("category"),
            data.get("video_url"),
            data.get("thumbnail_url"),
            data.get("duration"),
            data.get("sort_order"),
            data.get("is_active"),
            video_id
        ))
        conn.commit()
    
    return jsonify({"ok": True, "message": "Video gÃ¼ncellendi"})

def api_admin_education_videos_delete(video_id):
    """Delete education video (admin only)"""
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin access required"}), 403
    
    with db() as conn:
        conn.execute("DELETE FROM education_videos WHERE id = ?", (video_id,))
        conn.commit()
    
    return jsonify({"ok": True, "message": "Video silindi"})

# Admin Education Management Page
def api_app_admin_education():
    """Admin Education Management Page"""
    if not session.get("is_admin"):
        return redirect("/api/app/login")
    
    return render_template_string("""
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EÄŸitim Merkezi YÃ¶netimi | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background: #0f0f0f; color: #e8e8e8; }</style>
</head>
<body class="min-h-screen">
    {{ sidebar | safe }}
    
    <main class="lg:ml-64 p-4 lg:p-8">
        <div class="max-w-6xl mx-auto">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-white">ğŸ“ EÄŸitim Merkezi YÃ¶netimi</h1>
                <button onclick="showAddModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                    + Yeni Video Ekle
                </button>
            </div>
            
            <!-- Video List -->
            <div id="videoList" class="space-y-4">
                <div class="text-center py-8 text-gray-400">YÃ¼kleniyor...</div>
            </div>
        </div>
    </main>
    
    <!-- Add/Edit Modal -->
    <div id="videoModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="bg-[#1a1a1a] rounded-2xl p-6 w-full max-w-lg border border-white/10">
            <h3 id="modalTitle" class="text-xl font-bold text-white mb-4">Video Ekle</h3>
            <form id="videoForm" class="space-y-4">
                <input type="hidden" id="videoId">
                <div>
                    <label class="text-gray-400 text-sm mb-1 block">BaÅŸlÄ±k *</label>
                    <input type="text" id="videoTitle" required class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white">
                </div>
                <div>
                    <label class="text-gray-400 text-sm mb-1 block">AÃ§Ä±klama</label>
                    <textarea id="videoDesc" rows="3" class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Kategori</label>
                        <select id="videoCategory" class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white">
                            <option value="genel">Genel</option>
                            <option value="temel">Temel EÄŸitim</option>
                            <option value="teknik">Teknik Analiz</option>
                            <option value="risk">Risk YÃ¶netimi</option>
                            <option value="bot">Bot KullanÄ±mÄ±</option>
                            <option value="ileri">Ä°leri Seviye</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">SÄ±ra</label>
                        <input type="number" id="videoOrder" value="0" class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white">
                    </div>
                </div>
                <div>
                    <label class="text-gray-400 text-sm mb-1 block">Video URL (YouTube Embed)</label>
                    <input type="url" id="videoUrl" placeholder="https://www.youtube.com/embed/..." class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg">Ä°ptal</button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
    async function loadVideos() {
        const res = await fetch('/api/admin/education/list', {credentials: 'include'});
        const data = await res.json();
        const container = document.getElementById('videoList');
        
        if (!data.ok || !data.videos.length) {
            container.innerHTML = '<div class="text-center py-8 text-gray-400">HenÃ¼z video yok</div>';
            return;
        }
        
        container.innerHTML = data.videos.map(v => `
            <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-4 flex items-center gap-4">
                <div class="w-32 h-20 bg-black/40 rounded-lg flex items-center justify-center text-gray-500">
                    ${v.video_url ? '<span class="text-2xl">â–¶ï¸</span>' : 'ğŸ“¹'}
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold text-white">${v.title}</h3>
                    <p class="text-sm text-gray-400">${v.description || 'AÃ§Ä±klama yok'}</p>
                    <div class="flex gap-2 mt-1">
                        <span class="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 rounded">${v.category}</span>
                        <span class="text-xs px-2 py-1 bg-gray-500/20 text-gray-400 rounded">SÄ±ra: ${v.sort_order}</span>
                        <span class="text-xs px-2 py-1 ${v.is_active ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'} rounded">${v.is_active ? 'Aktif' : 'Pasif'}</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="editVideo(${v.id})" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm">DÃ¼zenle</button>
                    <button onclick="deleteVideo(${v.id})" class="px-3 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm">Sil</button>
                </div>
            </div>
        `).join('');
    }
    
    function showAddModal() {
        document.getElementById('modalTitle').textContent = 'Yeni Video Ekle';
        document.getElementById('videoId').value = '';
        document.getElementById('videoForm').reset();
        document.getElementById('videoModal').classList.remove('hidden');
    }
    
    async function editVideo(id) {
        const res = await fetch('/api/admin/education/list', {credentials: 'include'});
        const data = await res.json();
        const video = data.videos.find(v => v.id === id);
        if (!video) return;
        
        document.getElementById('modalTitle').textContent = 'Video DÃ¼zenle';
        document.getElementById('videoId').value = id;
        document.getElementById('videoTitle').value = video.title;
        document.getElementById('videoDesc').value = video.description || '';
        document.getElementById('videoCategory').value = video.category;
        document.getElementById('videoOrder').value = video.sort_order;
        document.getElementById('videoUrl').value = video.video_url || '';
        document.getElementById('videoModal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('videoModal').classList.add('hidden');
    }
    
    document.getElementById('videoForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('videoId').value;
        const data = {
            title: document.getElementById('videoTitle').value,
            description: document.getElementById('videoDesc').value,
            category: document.getElementById('videoCategory').value,
            sort_order: parseInt(document.getElementById('videoOrder').value),
            video_url: document.getElementById('videoUrl').value,
        };
        
        const url = id ? `/api/admin/education/update/${id}` : '/api/admin/education/add';
        await fetch(url, {
            method: 'POST',
            credentials: 'include',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        closeModal();
        loadVideos();
    };
    
    async function deleteVideo(id) {
        if (!confirm('Bu videoyu silmek istediÄŸinize emin misiniz')) return;
        await fetch(`/api/admin/education/delete/${id}`, {method: 'POST', credentials: 'include'});
        loadVideos();
    }
    
    loadVideos();
    </script>
</body>
</html>
    """, sidebar=get_sidebar_html("admin"))

# === END ADMIN EDUCATION CRUD ===

# === ADMIN TELEGRAM SETTINGS PAGE ===
@app.route("/api/app/admin/telegram")
def api_app_admin_telegram():
    """Admin Telegram Settings Page"""
    if not session.get("is_admin"):
        return redirect("/api/app/login")
    
    # Get current Telegram settings
    telegram_token = os.getenv("TELEGRAM_BOT_TOKEN", "")
    telegram_chat_id = os.getenv("TELEGRAM_ADMIN_CHAT_ID", "")
    
    sidebar = ADMIN_SIDEBAR_HTML.replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'dashboard' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'users' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'education' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'packages' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'telegram' else 'text-gray-400 hover:bg-white/5' }}", "bg-orange-600/20 text-orange-400").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'webhooks' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'ai' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'analytics' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5")
    
    return render_template_string("""
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram AyarlarÄ± | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background: #0f0f0f; }</style>
</head>
<body class="min-h-screen text-white">
    {{ sidebar | safe }}
    
    <main class="lg:ml-64 p-4 lg:p-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-2xl font-bold text-white mb-6">ğŸ“± Telegram AyarlarÄ±</h1>
            
            <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-cyan-400">ğŸ¤–</span> Bot Bilgileri</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Bot Token</label>
                        <input type="text" id="botToken" value="{{ token }}" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white" readonly>
                        <p class="text-xs text-gray-500 mt-1">Bot token .env dosyasÄ±ndan yÃ¼klenir</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Admin Chat ID</label>
                        <input type="text" id="chatId" value="{{ chat_id }}" placeholder="Chat ID giriniz" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white">
                        <p class="text-xs text-gray-500 mt-1">Telegram'da bota /start gÃ¶nderin, sonra getUpdates ile Chat ID'yi bulun</p>
                    </div>
                    <button onclick="saveChatId()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-lg transition">
                        ğŸ’¾ Chat ID Kaydet
                    </button>
                </div>
            </div>
            
            <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-green-400">ğŸ§ª</span> Test Bildirimi</h2>
                <p class="text-gray-400 text-sm mb-4">Chat ID ayarlandÄ±ktan sonra test bildirimi gÃ¶nderin.</p>
                <button onclick="sendTestMessage()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition">
                    ğŸ“¨ Test MesajÄ± GÃ¶nder
                </button>
                <div id="testResult" class="mt-4 hidden"></div>
            </div>
            
            <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-yellow-400">ğŸ“‹</span> Kurulum Rehberi</h2>
                <ol class="space-y-3 text-gray-400 text-sm">
                    <li class="flex gap-2"><span class="text-orange-400 font-bold">1.</span> Telegram'da @AtalayUlusoyTraderBot botunu bulun</li>
                    <li class="flex gap-2"><span class="text-orange-400 font-bold">2.</span> Bota /start mesajÄ± gÃ¶nderin</li>
                    <li class="flex gap-2"><span class="text-orange-400 font-bold">3.</span> <a href="https://api.telegram.org/bot{{ token }}/getUpdates" target="_blank" class="text-blue-400 hover:underline">Bu linke tÄ±klayarak</a> Chat ID'nizi bulun</li>
                    <li class="flex gap-2"><span class="text-orange-400 font-bold">4.</span> JSON'daki "chat":{"id": XXXX} deÄŸerini yukarÄ±ya girin</li>
                    <li class="flex gap-2"><span class="text-orange-400 font-bold">5.</span> Test mesajÄ± gÃ¶ndererek doÄŸrulayÄ±n</li>
                </ol>
            </div>
        </div>
    </main>
    
    <script>
    async function saveChatId() {
        const chatId = document.getElementById('chatId').value;
        try {
            const res = await fetch('/api/admin/telegram/chat-id', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({chat_id: chatId})
            });
            const data = await res.json();
            alert(data.ok ? 'Chat ID kaydedildi!' : 'Hata: ' + data.error);
        } catch(e) {
            alert('BaÄŸlantÄ± hatasÄ±');
        }
    }
    
    async function sendTestMessage() {
        const resultDiv = document.getElementById('testResult');
        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = '<p class="text-yellow-400">GÃ¶nderiliyor...</p>';
        
        try {
            const res = await fetch('/api/admin/telegram/test', {method: 'POST', credentials: 'include'});
            const data = await res.json();
            if (data.ok) {
                resultDiv.innerHTML = '<p class="text-green-400">âœ… Test mesajÄ± baÅŸarÄ±yla gÃ¶nderildi!</p>';
            } else {
                resultDiv.innerHTML = '<p class="text-red-400">âŒ Hata: ' + data.error + '</p>';
            }
        } catch(e) {
            resultDiv.innerHTML = '<p class="text-red-400">âŒ BaÄŸlantÄ± hatasÄ±</p>';
        }
    }
    </script>
</body>
</html>
    """, sidebar=sidebar, token=telegram_token[:20] + "..." if len(telegram_token) > 20 else telegram_token, chat_id=telegram_chat_id)


# === ADMIN PACKAGE MANAGEMENT PAGE ===
@app.route("/api/app/admin/packages")
def api_app_admin_packages():
    """Admin Package Management Page"""
    if not session.get("is_admin"):
        return redirect("/api/app/login")
    
    sidebar = ADMIN_SIDEBAR_HTML.replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'dashboard' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'users' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'education' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'packages' else 'text-gray-400 hover:bg-white/5' }}", "bg-orange-600/20 text-orange-400").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'telegram' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'webhooks' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'ai' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'analytics' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5")
    
    # Get users with packages
    conn = db()
    try:
        users = conn.execute("""
            SELECT id, username, email, package, expires_at, demo_balance, is_admin, created_at
            FROM users ORDER BY id DESC LIMIT 100
        """).fetchall()
    finally:
        conn.close()
    
    return render_template_string("""
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paket YÃ¶netimi | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background: #0f0f0f; }</style>
</head>
<body class="min-h-screen text-white">
    {{ sidebar | safe }}
    
    <main class="lg:ml-64 p-4 lg:p-8">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-2xl font-bold text-white mb-6">ğŸ“¦ Paket & Limit YÃ¶netimi</h1>
            
            <div class="bg-[#1a1a1a] rounded-xl border border-white/5 overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-black/30">
                        <tr class="text-left text-gray-400">
                            <th class="p-4">KullanÄ±cÄ±</th>
                            <th class="p-4">Paket</th>
                            <th class="p-4">BitiÅŸ</th>
                            <th class="p-4">Demo Bakiye</th>
                            <th class="p-4">Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="border-t border-white/5 hover:bg-white/5">
                            <td class="p-4">
                                <div class="font-medium text-white">{{ user[1] }}</div>
                                <div class="text-xs text-gray-500">{{ user[2] or 'Email yok' }}</div>
                            </td>
                            <td class="p-4">
                                <span class="px-2 py-1 rounded text-xs {% if user[3] == 'premium' %}bg-yellow-500/20 text-yellow-400{% elif user[3] == 'pro' %}bg-purple-500/20 text-purple-400{% else %}bg-gray-500/20 text-gray-400{% endif %}">
                                    {{ user[3] or 'Temel' }}
                                </span>
                            </td>
                            <td class="p-4 text-gray-400">{{ user[4] or '-' }}</td>
                            <td class="p-4 text-green-400">${{ '{:,.0f}'.format(user[5] or 0) }}</td>
                            <td class="p-4">
                                <button onclick="editUser({{ user[0] }}, '{{ user[1] }}', '{{ user[3] or 'basic' }}', {{ user[5] or 0 }})" class="text-blue-400 hover:text-blue-300 text-xs">DÃ¼zenle</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-[#1a1a1a] rounded-2xl border border-white/10 w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-white mb-4">KullanÄ±cÄ± DÃ¼zenle</h3>
            <input type="hidden" id="editUserId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">KullanÄ±cÄ± AdÄ±</label>
                    <input type="text" id="editUsername" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white" readonly>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Paket</label>
                    <select id="editPackage" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white">
                        <option value="basic">Temel</option>
                        <option value="starter">Starter</option>
                        <option value="pro">Pro</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Demo Bakiye ($)</label>
                    <input type="number" id="editBalance" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white">
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="saveUserChanges()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition">Kaydet</button>
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition">Ä°ptal</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    function editUser(id, username, pkg, balance) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editPackage').value = pkg;
        document.getElementById('editBalance').value = balance;
        document.getElementById('editModal').classList.remove('hidden');
    }
    
    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }
    
    async function saveUserChanges() {
        const userId = document.getElementById('editUserId').value;
        const pkg = document.getElementById('editPackage').value;
        const balance = document.getElementById('editBalance').value;
        
        try {
            const res = await fetch('/api/admin/user/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({user_id: userId, package: pkg, demo_balance: balance})
            });
            const data = await res.json();
            if (data.ok) {
                alert('KullanÄ±cÄ± gÃ¼ncellendi!');
                location.reload();
            } else {
                alert('Hata: ' + data.error);
            }
        } catch(e) {
            alert('BaÄŸlantÄ± hatasÄ±');
        }
    }
    </script>
</body>
</html>
    """, sidebar=sidebar, users=users)


# === ADMIN ANALYTICS PAGE ===
@app.route("/api/app/admin/analytics")
def api_app_admin_analytics():
    """Admin Analytics & PnL Page"""
    if not session.get("is_admin"):
        return redirect("/api/app/login")
    
    sidebar = ADMIN_SIDEBAR_HTML.replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'dashboard' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'users' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'education' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'packages' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'telegram' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'webhooks' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'ai' else 'text-gray-400 hover:bg-white/5' }}", "text-gray-400 hover:bg-white/5").replace("{{ 'bg-orange-600/20 text-orange-400' if active == 'analytics' else 'text-gray-400 hover:bg-white/5' }}", "bg-orange-600/20 text-orange-400")
    
    return render_template_string("""
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & PnL | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>body { background: #0f0f0f; }</style>
</head>
<body class="min-h-screen text-white">
    {{ sidebar | safe }}
    
    <main class="lg:ml-64 p-4 lg:p-8">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-2xl font-bold text-white mb-6">ğŸ“ˆ Analytics & PnL RaporlarÄ±</h1>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4">
                    <p class="text-gray-400 text-xs mb-1">Toplam Ä°ÅŸlem</p>
                    <p id="totalTrades" class="text-2xl font-bold text-white">-</p>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4">
                    <p class="text-gray-400 text-xs mb-1">Toplam Hacim</p>
                    <p id="totalVolume" class="text-2xl font-bold text-green-400">-</p>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4">
                    <p class="text-gray-400 text-xs mb-1">Aktif Pozisyon</p>
                    <p id="activePositions" class="text-2xl font-bold text-yellow-400">-</p>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4">
                    <p class="text-gray-400 text-xs mb-1">BugÃ¼nkÃ¼ Ä°ÅŸlem</p>
                    <p id="todayTrades" class="text-2xl font-bold text-blue-400">-</p>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-4">GÃ¼nlÃ¼k Ä°ÅŸlem Hacmi</h3>
                    <canvas id="volumeChart" height="200"></canvas>
                </div>
                <div class="bg-[#1a1a1a] rounded-xl border border-white/5 p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-4">Coin DaÄŸÄ±lÄ±mÄ±</h3>
                    <canvas id="coinChart" height="200"></canvas>
                </div>
            </div>
            
            <!-- Period Filter -->
            <div class="flex gap-2 mb-4">
                <button onclick="loadData(7)" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm">7 GÃ¼n</button>
                <button onclick="loadData(30)" class="px-4 py-2 bg-orange-600 rounded-lg text-sm">30 GÃ¼n</button>
                <button onclick="loadData(90)" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm">90 GÃ¼n</button>
            </div>
        </div>
    </main>
    
    <script>
    let volumeChart, coinChart;
    
    async function loadData(days = 30) {
        try {
            // Load summary
            const summaryRes = await fetch('/api/analytics/summary', {credentials: 'include'});
            const summary = await summaryRes.json();
            if (summary.ok) {
                document.getElementById('totalTrades').textContent = summary.all_time.trades;
                document.getElementById('totalVolume').textContent = '$' + summary.all_time.volume.toLocaleString();
                document.getElementById('activePositions').textContent = summary.active.positions;
                document.getElementById('todayTrades').textContent = summary.today.trades;
            }
            
            // Load PnL data
            const pnlRes = await fetch('/api/analytics/pnl?period=' + days, {credentials: 'include'});
            const pnl = await pnlRes.json();
            if (pnl.ok && pnl.daily_data.length > 0) {
                updateVolumeChart(pnl.daily_data);
            }
            
            // Load portfolio data
            const portfolioRes = await fetch('/api/analytics/portfolio', {credentials: 'include'});
            const portfolio = await portfolioRes.json();
            if (portfolio.ok) {
                updateCoinChart(portfolio.coin_distribution);
            }
        } catch(e) {
            console.error('Data load error:', e);
        }
    }
    
    function updateVolumeChart(data) {
        const ctx = document.getElementById('volumeChart').getContext('2d');
        if (volumeChart) volumeChart.destroy();
        
        volumeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'Hacim ($)',
                    data: data.map(d => d.volume),
                    backgroundColor: 'rgba(251, 146, 60, 0.5)',
                    borderColor: 'rgb(251, 146, 60)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    function updateCoinChart(coinData) {
        const ctx = document.getElementById('coinChart').getContext('2d');
        if (coinChart) coinChart.destroy();
        
        const labels = Object.keys(coinData);
        const values = labels.map(l => coinData[l].count);
        
        coinChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#f97316', '#3b82f6', '#22c55e', '#eab308', '#a855f7', '#ec4899']
                }]
            },
            options: { responsive: true }
        });
    }
    
    loadData(30);
    </script>
</body>
</html>
    """, sidebar=sidebar)


# === ADMIN API ENDPOINTS ===
@app.route('/api/admin/telegram/chat-id', methods=['POST'])
def api_admin_telegram_chat_id():
    """Save Telegram Chat ID"""
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin access required"}), 403
    
    data = request.get_json() or {}
    chat_id = data.get("chat_id", "").strip()
    
    # For now, store in a simple way - in production, use database
    # This updates the environment variable runtime (won't persist after restart)
    os.environ["TELEGRAM_ADMIN_CHAT_ID"] = chat_id
    
    # Also try to save to users table for the admin
    try:
        conn = db()
        conn.execute("UPDATE users SET telegram_chat_id = ? WHERE username = ?", (chat_id, session.get("username")))
        conn.commit()
        conn.close()
    except:
        pass
    
    return jsonify({"ok": True, "message": "Chat ID kaydedildi"})


@app.route('/api/admin/telegram/test', methods=['POST'])
def api_admin_telegram_test():
    """Send test Telegram message"""
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin access required"}), 403
    
    success = send_telegram_message("ğŸ§ª Test mesajÄ± - Atalay Ulusoy Auto Trade bildirimleri Ã§alÄ±ÅŸÄ±yor!")
    
    if success:
        return jsonify({"ok": True, "message": "Test mesajÄ± gÃ¶nderildi"})
    else:
        return jsonify({"ok": False, "error": "Mesaj gÃ¶nderilemedi. Chat ID'yi kontrol edin."})


@app.route('/api/admin/user/update', methods=['POST'])
def api_admin_user_update():
    """Update user package and balance"""
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin access required"}), 403
    
    data = request.get_json() or {}
    user_id = data.get("user_id")
    package = data.get("package", "basic")
    demo_balance = float(data.get("demo_balance", 0))
    
    if not user_id:
        return jsonify({"ok": False, "error": "User ID required"}), 400
    
    try:
        conn = db()
        conn.execute("""
            UPDATE users SET package = ?, demo_balance = ?, updated_at = ?
            WHERE id = ?
        """, (package, demo_balance, int(time.time()), user_id))
        conn.commit()
        conn.close()
        return jsonify({"ok": True, "message": "KullanÄ±cÄ± gÃ¼ncellendi"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 400


# === END EMERGENT PLATFORM API/APP ROUTES ===


# ==============================================
# PROFILE PAGE - Password Change & 2FA
# ==============================================

PROFILE_TEMPLATE = """
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Atalay Ulusoy Auto Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-[#0a0a0a] min-h-screen">
    <div class="flex">
        {{ sidebar|safe }}
        <main class="flex-1 lg:ml-64 p-4 md:p-6 pt-16 lg:pt-6">
            <h1 class="text-2xl font-bold text-white mb-6">ğŸ‘¤ Profil AyarlarÄ±</h1>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- User Info -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2"><i class="fas fa-user text-orange-400"></i> Hesap Bilgileri</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">KullanÄ±cÄ± AdÄ±:</span><span class="text-white font-medium" id="profileUsername">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">E-posta:</span><span class="text-white" id="profileEmail">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Paket:</span><span class="text-orange-400 font-medium" id="profilePackage">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Ãœyelik BitiÅŸ:</span><span class="text-white" id="profileExpires">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Telegram:</span><span class="text-white" id="profileTelegram">-</span></div>
                    </div>
                </div>
                
                <!-- Change Password -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2"><i class="fas fa-key text-blue-400"></i> Åifre DeÄŸiÅŸtir</h2>
                    <form id="passwordForm" class="space-y-4">
                        <div>
                            <label class="text-gray-400 text-sm">Mevcut Åifre</label>
                            <input type="password" id="currentPassword" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white mt-1" required>
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm">Yeni Åifre</label>
                            <input type="password" id="newPassword" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white mt-1" required minlength="6">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm">Yeni Åifre (Tekrar)</label>
                            <input type="password" id="confirmPassword" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white mt-1" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition">Åifreyi GÃ¼ncelle</button>
                        <p id="passwordMsg" class="text-sm text-center hidden"></p>
                    </form>
                </div>
                
                <!-- 2FA Settings -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2"><i class="fas fa-shield-halved text-green-400"></i> Ä°ki FaktÃ¶rlÃ¼ DoÄŸrulama (2FA)</h2>
                    <div id="twoFaStatus" class="mb-4">
                        <div class="flex items-center justify-between p-3 bg-black/30 rounded-lg">
                            <span class="text-gray-400">2FA Durumu:</span>
                            <span id="twoFaStatusText" class="text-red-400">Devre DÄ±ÅŸÄ±</span>
                        </div>
                    </div>
                    
                    <!-- Telegram 2FA Setup -->
                    <div id="telegram2faSetup" class="hidden mt-4 space-y-3">
                        <p class="text-gray-400 text-sm">Telegram hesabÄ±nÄ±za doÄŸrulama kodu gÃ¶nderilecek.</p>
                        <button onclick="sendTelegram2FACode()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition">Telegram'a Kod GÃ¶nder</button>
                        <input type="text" id="telegram_2fa_code" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white text-center hidden" placeholder="6 haneli kod" maxlength="6">
                        <button id="verifyTelegram2FABtn" onclick="verifyTelegram2FA()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg transition hidden">DoÄŸrula ve EtkinleÅŸtir</button>
                    </div>
                    
                    <button id="enable2FaBtn" onclick="setupTelegram2FA()" class="w-full bg-green-600/20 text-green-400 font-bold py-2 rounded-lg hover:bg-green-600/30 transition">Telegram ile 2FA EtkinleÅŸtir</button>
                    <button id="disable2FaBtn" onclick="disable2FA()" class="w-full bg-red-600/20 text-red-400 font-bold py-2 rounded-lg hover:bg-red-600/30 transition hidden">2FA Devre DÄ±ÅŸÄ± BÄ±rak</button>
                    <p id="twoFaMsg" class="text-sm mt-2 hidden"></p>
                    <p class="text-gray-500 text-xs mt-3">âš ï¸ 2FA iÃ§in Ã¶nce Telegram Chat ID kaydetmelisiniz.</p>
                </div>
                
                <!-- Telegram Settings -->
                <div class="bg-[#1a1a1a] rounded-xl border border-white/10 p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2"><i class="fab fa-telegram text-blue-400"></i> Telegram Bildirimleri</h2>
                    <p class="text-gray-400 text-sm mb-4">Ä°ÅŸlem bildirimlerini Telegram'dan almak iÃ§in Chat ID'nizi girin. Bot size BUY/SELL alertlerini gÃ¶nderecek.</p>
                    <form id="telegramForm" class="space-y-4">
                        <div>
                            <label class="text-gray-400 text-sm">Telegram Chat ID</label>
                            <input type="text" id="telegramChatId" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white mt-1" placeholder="Ã–rn: 123456789">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition">Kaydet ve Test Et</button>
                    </form>
                    <p id="telegramMsg" class="text-sm mt-2 hidden"></p>
                    <p class="text-gray-500 text-xs mt-3">ğŸ’¡ Chat ID'nizi Ã¶ÄŸrenmek iÃ§in Telegram'da @userinfobot'a /start yazÄ±n.</p>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // Load profile data
        fetch('/api/user/profile', {credentials: 'include'})
            .then(r => r.json())
            .then(data => {
                console.log('Profile API response:', data);
                if (data.ok && data.user) {
                    document.getElementById('profileUsername').textContent = data.user.username || '-';
                    document.getElementById('profileEmail').textContent = data.user.email || 'BelirtilmemiÅŸ';
                    document.getElementById('profilePackage').textContent = (data.user.package || 'Trial').toUpperCase();
                    document.getElementById('profileExpires').textContent = data.user.expires_at || 'SÃ¼resiz';
                    document.getElementById('profileTelegram').textContent = data.user.telegram_chat_id || 'BelirtilmemiÅŸ';
                    document.getElementById('telegramChatId').value = data.user.telegram_chat_id || '';
                    
                    // 2FA status
                    if (data.user.two_fa_enabled) {
                        document.getElementById('twoFaStatusText').textContent = 'Aktif';
                        document.getElementById('twoFaStatusText').className = 'text-green-400';
                        document.getElementById('enable2FaBtn').classList.add('hidden');
                        document.getElementById('disable2FaBtn').classList.remove('hidden');
                    }
                } else {
                    console.error('Profile API error:', data.error || 'Unknown error');
                }
            })
            .catch(err => console.error('Profile fetch error:', err));
        
        // Password change
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const cur = document.getElementById('currentPassword').value;
            const newP = document.getElementById('newPassword').value;
            const conf = document.getElementById('confirmPassword').value;
            const msg = document.getElementById('passwordMsg');
            
            if (newP !== conf) {
                msg.textContent = 'âŒ Yeni ÅŸifreler eÅŸleÅŸmiyor!';
                msg.className = 'text-sm text-center text-red-400';
                msg.classList.remove('hidden');
                return;
            }
            
            const res = await fetch('/api/user/change-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({current_password: cur, new_password: newP})
            });
            const data = await res.json();
            
            msg.textContent = data.ok ? 'âœ… Åifre baÅŸarÄ±yla deÄŸiÅŸtirildi!' : 'âŒ ' + (data.error || 'Hata oluÅŸtu');
            msg.className = 'text-sm text-center ' + (data.ok ? 'text-green-400' : 'text-red-400');
            msg.classList.remove('hidden');
            
            if (data.ok) this.reset();
        });
        
        // Telegram save
        document.getElementById('telegramForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const chatId = document.getElementById('telegramChatId').value;
            
            const res = await fetch('/api/user/update-telegram', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({telegram_chat_id: chatId})
            });
            const data = await res.json();
            alert(data.ok ? 'âœ… Telegram ayarlarÄ± kaydedildi!' : 'âŒ ' + (data.error || 'Hata'));
        });
        
        // Telegram 2FA functions
        function setupTelegram2FA() {
            document.getElementById('telegram2faSetup').classList.remove('hidden');
            document.getElementById('enable2FaBtn').classList.add('hidden');
        }
        
        async function sendTelegram2FACode() {
            const res = await fetch('/api/2fa/telegram/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include'
            });
            const data = await res.json();
            
            if (data.ok) {
                alert('âœ… DoÄŸrulama kodu Telegram'a gÃ¶nderildi!');
                document.getElementById('telegram_2fa_code').classList.remove('hidden');
                document.getElementById('verifyTelegram2FABtn').classList.remove('hidden');
            } else {
                alert('âŒ ' + (data.error || 'Kod gÃ¶nderilemedi'));
            }
        }
        
        async function verifyTelegram2FA() {
            const code = document.getElementById('telegram_2fa_code').value.trim();
            
            if (!code || code.length !== 6) {
                alert('âŒ 6 haneli kodu girin');
                return;
            }
            
            const res = await fetch('/api/2fa/telegram/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({code: code})
            });
            const data = await res.json();
            
            if (data.ok) {
                alert('âœ… 2FA baÅŸarÄ±yla etkinleÅŸtirildi!');
                location.reload();
            } else {
                alert('âŒ ' + (data.error || 'DoÄŸrulama baÅŸarÄ±sÄ±z'));
            }
        }
        
        function disable2FA() {
            if (confirm('2FA\'yÄ± devre dÄ±ÅŸÄ± bÄ±rakmak istediÄŸinizden emin misiniz?')) {
                fetch('/api/user/disable-2fa', {method: 'POST', credentials: 'include'})
                    .then(r => r.json())
                    .then(data => {
                        alert(data.ok ? 'âœ… 2FA devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±' : 'âŒ Hata');
                        location.reload();
                    });
            }
        }

    </script>
</body>
</html>
"""

@app.route('/profile')
@app.route('/api/app/profile')
def page_profile():
    if not session.get("logged_in"): return redirect("/api/app/login")
    return render_template_string(PROFILE_TEMPLATE, sidebar=get_sidebar_html("profile"))

@app.get('/api/user/profile')
def api_user_profile():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id")
    username = session.get("username", "")
    
    try:
        conn = db()
        
        # First check what columns exist
        cols_info = conn.execute("PRAGMA table_info(users)").fetchall()
        col_names = [c[1] for c in cols_info]
        
        # Build query based on available columns
        select_cols = ["username"]
        if "email" in col_names:
            select_cols.append("email")
        if "package_name" in col_names:
            select_cols.append("package_name")
        if "expires_at" in col_names:
            select_cols.append("expires_at")
        if "telegram_chat_id" in col_names:
            select_cols.append("telegram_chat_id")
        if "two_fa_enabled" in col_names:
            select_cols.append("two_fa_enabled")
        
        query = f"SELECT {', '.join(select_cols)} FROM users WHERE id=?"
        row = conn.execute(query, (user_id,)).fetchone()
        
        # Fallback to username search
        if not row and username:
            row = conn.execute(f"SELECT {', '.join(select_cols)} FROM users WHERE username=?", (username,)).fetchone()
        
        conn.close()
        
        if row:
            result = {"username": row[0] or username}
            idx = 1
            if "email" in select_cols[1:]:
                result["email"] = row[idx] or ""
                idx += 1
            if "package_name" in select_cols[1:]:
                result["package"] = row[idx] or "trial"
                idx += 1
            if "expires_at" in select_cols[1:]:
                result["expires_at"] = row[idx] or "SÃ¼resiz"
                idx += 1
            if "telegram_chat_id" in select_cols[1:]:
                result["telegram_chat_id"] = row[idx] or ""
                idx += 1
            if "two_fa_enabled" in select_cols[1:]:
                result["two_fa_enabled"] = bool(row[idx])
            else:
                result["two_fa_enabled"] = False
            
            return jsonify({"ok": True, "user": result})
        
        # Return basic info from session if DB lookup fails
        return jsonify({"ok": True, "user": {
            "username": username,
            "email": "",
            "package": "trial",
            "expires_at": "SÃ¼resiz",
            "telegram_chat_id": "",
            "two_fa_enabled": False
        }})
    except Exception as e:
        print(f"[PROFILE API] Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({"ok": True, "user": {
            "username": username,
            "email": "",
            "package": "trial",
            "expires_at": "SÃ¼resiz",
            "telegram_chat_id": "",
            "two_fa_enabled": False
        }})

@app.post('/api/user/update-telegram')
def api_user_update_telegram():
    """Update user's Telegram Chat ID and send test message"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id")
    data = request.get_json() or {}
    chat_id = str(data.get("telegram_chat_id", "")).strip()
    
    try:
        conn = db()
        
        # Check if column exists
        cols = conn.execute("PRAGMA table_info(users)").fetchall()
        col_names = [c[1] for c in cols]
        
        if "telegram_chat_id" not in col_names:
            # Add column if missing
            conn.execute("ALTER TABLE users ADD COLUMN telegram_chat_id TEXT")
            conn.commit()
        
        # Update chat ID
        conn.execute("UPDATE users SET telegram_chat_id=? WHERE id=?", (chat_id, user_id))
        conn.commit()
        conn.close()
        
        # Send test message if chat_id is provided
        if chat_id:
            success = send_telegram_message(
                chat_id,
                "ğŸ‰ <b>Telegram Bildirimleri Aktif!</b>\n\n"
                "ArtÄ±k BUY/SELL iÅŸlem alertleri bu chate gelecek.\n\n"
                "âœ… Test mesajÄ± baÅŸarÄ±yla gÃ¶nderildi!"
            )
            
            if success:
                return jsonify({
                    "ok": True,
                    "message": "Telegram kaydedildi ve test mesajÄ± gÃ¶nderildi! âœ…"
                })
            else:
                return jsonify({
                    "ok": True,
                    "warning": "Chat ID kaydedildi ama mesaj gÃ¶nderilemedi. TELEGRAM_BOT_TOKEN kontrol edin."
                })
        
        return jsonify({"ok": True, "message": "Telegram ayarlarÄ± temizlendi"})
        
    except Exception as e:
        print(f"[TELEGRAM UPDATE] Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({"ok": False, "error": str(e)}), 500


@app.post('/api/user/change-password')
def api_user_change_password():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    data = request.get_json() or {}
    current = data.get("current_password")
    new_pass = data.get("new_password")
    
    if not current or not new_pass:
        return jsonify({"ok": False, "error": "TÃ¼m alanlarÄ± doldurun"})
    
    if len(new_pass) < 6:
        return jsonify({"ok": False, "error": "Åifre en az 6 karakter olmalÄ±"})
    
    user_id = session.get("user_id")
    try:
        conn = db()
        row = conn.execute("SELECT password FROM users WHERE id=?", (user_id,)).fetchone()
        
        if not row:
            conn.close()
            return jsonify({"ok": False, "error": "KullanÄ±cÄ± bulunamadÄ±"})
        
        # Check current password (simple comparison, should use hash in production)
        stored_pass = row[0]
        if stored_pass != current:
            conn.close()
            return jsonify({"ok": False, "error": "Mevcut ÅŸifre hatalÄ±"})
        
        # Update password
        conn.execute("UPDATE users SET password=?, updated_at=? WHERE id=?", (new_pass, int(time.time()), user_id))
        conn.commit()
        conn.close()
        return jsonify({"ok": True, "message": "Åifre gÃ¼ncellendi"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

# ===============================================
# 2FA TELEGRAM ENDPOINTS
# ===============================================

@app.post('/api/2fa/telegram/send')
def api_2fa_telegram_send():
    """Send 2FA verification code via Telegram"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id")
    
    try:
        conn = db()
        row = conn.execute("SELECT telegram_chat_id FROM users WHERE id=?", (user_id,)).fetchone()
        conn.close()
        
        if not row or not row[0]:
            return jsonify({"ok": False, "error": "Ã–nce Telegram Chat ID kaydedin"}), 400
        
        chat_id = row[0]
        
        # Generate 6-digit code
        import random
        code = str(random.randint(100000, 999999))
        session["2fa_code"] = code
        session["2fa_code_time"] = time.time()
        
        # Send code via Telegram
        success = send_telegram_message(
            chat_id,
            f"ğŸ” <b>2FA DoÄŸrulama Kodu</b>\n\n"
            f"Kodunuz: <code>{code}</code>\n\n"
            f"Bu kod 5 dakika geÃ§erlidir."
        )
        
        if success:
            return jsonify({"ok": True, "message": "DoÄŸrulama kodu Telegram'a gÃ¶nderildi"})
        else:
            return jsonify({"ok": False, "error": "Telegram mesajÄ± gÃ¶nderilemedi. Bot token kontrol edin."}), 500
            
    except Exception as e:
        print(f"[2FA TELEGRAM SEND] Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({"ok": False, "error": str(e)}), 500

@app.post('/api/2fa/telegram/verify')
def api_2fa_telegram_verify():
    """Verify 2FA code and enable 2FA for user"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    data = request.get_json() or {}
    code = str(data.get("code", "")).strip()
    
    if not code:
        return jsonify({"ok": False, "error": "Kod girilmedi"}), 400
    
    stored_code = session.get("2fa_code")
    code_time = session.get("2fa_code_time", 0)
    
    # Check if code exists
    if not stored_code:
        return jsonify({"ok": False, "error": "Ã–nce kod gÃ¶nderin"}), 400
    
    # Check expiry (5 minutes = 300 seconds)
    if time.time() - code_time > 300:
        session.pop("2fa_code", None)
        session.pop("2fa_code_time", None)
        return jsonify({"ok": False, "error": "Kod sÃ¼resi doldu. Yeni kod gÃ¶nderin."}), 400
    
    # Verify code
    if code != stored_code:
        return jsonify({"ok": False, "error": "Kod hatalÄ±"}), 400
    
    # Enable 2FA with telegram method
    user_id = session.get("user_id")
    
    try:
        conn = db()
        
        # Check if columns exist, add if missing
        cols = conn.execute("PRAGMA table_info(users)").fetchall()
        col_names = [c[1] for c in cols]
        
        if "two_fa_enabled" not in col_names:
            conn.execute("ALTER TABLE users ADD COLUMN two_fa_enabled INTEGER DEFAULT 0")
            conn.commit()
        
        if "two_fa_method" not in col_names:
            conn.execute("ALTER TABLE users ADD COLUMN two_fa_method TEXT DEFAULT 'email'")
            conn.commit()
        
        # Enable 2FA with Telegram method
        conn.execute(
            "UPDATE users SET two_fa_enabled=1, two_fa_method='telegram' WHERE id=?",
            (user_id,)
        )
        conn.commit()
        conn.close()
        
        # Clear session codes
        session.pop("2fa_code", None)
        session.pop("2fa_code_time", None)
        
        print(f"[2FA] âœ… User {user_id} enabled Telegram 2FA")
        return jsonify({"ok": True, "message": "2FA baÅŸarÄ±yla etkinleÅŸtirildi"})
        
    except Exception as e:
        print(f"[2FA TELEGRAM VERIFY] Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({"ok": False, "error": str(e)}), 500

@app.post('/api/user/disable-2fa')
def api_user_disable_2fa():
    """Disable 2FA for user"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id")
    
    try:
        conn = db()
        conn.execute("UPDATE users SET two_fa_enabled=0 WHERE id=?", (user_id,))
        conn.commit()
        conn.close()
        
        print(f"[2FA] âŒ User {user_id} disabled 2FA")
        return jsonify({"ok": True, "message": "2FA devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±"})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500


@app.post('/api/user/update-telegram')
def api_user_update_telegram_v2():

    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    data = request.get_json() or {}
    chat_id = data.get("telegram_chat_id", "").strip()
    user_id = session.get("user_id")
    
    try:
        conn = db()
        conn.execute("UPDATE users SET telegram_chat_id=? WHERE id=?", (chat_id, user_id))
        conn.commit()
        conn.close()
        
        # Send test message if chat_id provided
        if chat_id:
            test_msg = "âœ… Telegram bildirimleri baÅŸarÄ±yla baÄŸlandÄ±!\n\nğŸ¤– Atalay Ulusoy Auto Trade\n\nBundan sonra BUY/SELL iÅŸlemlerinde bildirim alacaksÄ±nÄ±z."
            result = send_telegram_message(test_msg, chat_id)
            if result:
                return jsonify({"ok": True, "message": "Telegram baÄŸlandÄ± ve test mesajÄ± gÃ¶nderildi!"})
            else:
                return jsonify({"ok": True, "message": "Telegram ID kaydedildi. Test mesajÄ± gÃ¶nderilemedi - Bot'a /start yazÄ±n."})
        
        return jsonify({"ok": True})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

@app.post('/api/user/enable-2fa')
def api_user_enable_2fa():
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    data = request.get_json() or {}
    code = data.get("code", "")
    
    # Simple validation (in production use real TOTP)
    if len(code) == 6 and code.isdigit():
        user_id = session.get("user_id")
        try:
            conn = db()
            conn.execute("UPDATE users SET two_fa_enabled=1 WHERE id=?", (user_id,))
            conn.commit()
            conn.close()
            return jsonify({"ok": True})
        except Exception as e:
            return jsonify({"ok": False, "error": str(e)})
    return jsonify({"ok": False, "error": "GeÃ§ersiz kod"})


@app.post('/api/user/disable-2fa')
def api_user_disable_2fa_v2():

    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id")
    try:
        conn = db()
        conn.execute("UPDATE users SET two_fa_enabled=0 WHERE id=?", (user_id,))
        conn.commit()
        conn.close()
        return jsonify({"ok": True})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

# Email-based 2FA System
_2fa_codes = {}  # In-memory storage for verification codes {user_id: {"code": "123456", "email": "...", "expires": timestamp}}

@app.post('/api/2fa/email/send')
def api_2fa_email_send():
    """Send verification code to user's email"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id")
    data = request.get_json() or {}
    email = data.get("email", "").strip()
    
    if not email or "@" not in email:
        return jsonify({"ok": False, "error": "GeÃ§erli bir e-posta adresi girin"}), 400
    
    # Generate 6-digit code
    import random
    code = str(random.randint(100000, 999999))
    
    # Store code with expiration (5 minutes)
    _2fa_codes[user_id] = {
        "code": code,
        "email": email,
        "expires": int(time.time()) + 300  # 5 minutes
    }
    
    # Try to send email via Telegram as fallback (since SMTP not configured)
    # In production, use actual email sending via SMTP
    try:
        # Save email to user's record
        conn = db()
        conn.execute("UPDATE users SET email=? WHERE id=?", (email, user_id))
        conn.commit()
        conn.close()
        
        # Send code via Telegram if chat_id exists
        conn = db()
        row = conn.execute("SELECT telegram_chat_id FROM users WHERE id=?", (user_id,)).fetchone()
        conn.close()
        
        if row and row[0]:
            send_telegram_message(f"ğŸ” 2FA DoÄŸrulama Kodu: {code}\n\nBu kod 5 dakika iÃ§inde geÃ§erliliÄŸini yitirecektir.", row[0])
            print(f"[2FA] Code sent via Telegram to user {user_id}")
        
        print(f"[2FA] Code generated for user {user_id}: {code}")
        return jsonify({"ok": True, "message": "DoÄŸrulama kodu gÃ¶nderildi"})
    except Exception as e:
        print(f"[2FA] Email send error: {e}")
        return jsonify({"ok": False, "error": "Kod gÃ¶nderilemedi"}), 500

@app.post('/api/2fa/email/verify')
def api_2fa_email_verify():
    """Verify email code and enable 2FA"""
    if not session.get("logged_in"):
        return jsonify({"ok": False, "error": "Login required"}), 401
    
    user_id = session.get("user_id")
    data = request.get_json() or {}
    code = data.get("code", "").strip()
    
    if not code or len(code) != 6:
        return jsonify({"ok": False, "error": "6 haneli kodu girin"}), 400
    
    # Check stored code
    stored = _2fa_codes.get(user_id)
    if not stored:
        return jsonify({"ok": False, "error": "Ã–nce kod gÃ¶ndermelisiniz"}), 400
    
    # Check expiration
    if stored.get("expires", 0) < int(time.time()):
        del _2fa_codes[user_id]
        return jsonify({"ok": False, "error": "Kodun sÃ¼resi dolmuÅŸ. Yeni kod isteyin."}), 400
    
    # Verify code
    if stored.get("code") != code:
        return jsonify({"ok": False, "error": "Kod hatalÄ±"}), 400
    
    # Enable 2FA
    try:
        conn = db()
        conn.execute("UPDATE users SET two_fa_enabled=1, email=? WHERE id=?", (stored.get("email", ""), user_id))
        conn.commit()
        conn.close()
        
        # Clear used code
        del _2fa_codes[user_id]
        
        return jsonify({"ok": True, "message": "2FA baÅŸarÄ±yla etkinleÅŸtirildi"})
    except Exception as e:
        print(f"[2FA] Verify error: {e}")
        return jsonify({"ok": False, "error": "2FA etkinleÅŸtirilemedi"}), 500


# ==============================================
# CSV/EXCEL EXPORT
# ==============================================

@app.get('/api/trades/export/csv')
def api_trades_export_csv():
    """Export trade history as CSV"""
    if not session.get("logged_in"):
        return jsonify({"error": "Login required"}), 401
    
    user_id = session.get("user_id")
    
    try:
        conn = db()
        
        # Get closed positions from auto_positions
        rows = conn.execute("""
            SELECT id, coin, amount_usdt, entry_price, status, mode, created_at, closed_at, last_error
            FROM auto_positions
            WHERE user_id=? AND status='closed'
            ORDER BY closed_at DESC
            LIMIT 500
        """, (user_id,)).fetchall()
        conn.close()
        
        import csv
        from io import StringIO
        
        output = StringIO()
        writer = csv.writer(output)
        writer.writerow(['ID', 'Coin', 'Miktar (USDT)', 'GiriÅŸ FiyatÄ±', 'Durum', 'Mod', 'OluÅŸturulma', 'KapanÄ±ÅŸ', 'Not'])
        
        for r in rows:
            created = datetime.fromtimestamp(r[6]) if r[6] else ''
            closed = datetime.fromtimestamp(r[7]) if r[7] else ''
            writer.writerow([r[0], r[1], r[2], r[3], r[4], r[5], created, closed, r[8] or ''])
        
        output.seek(0)
        
        return Response(
            output.getvalue(),
            mimetype='text/csv',
            headers={'Content-Disposition': f'attachment; filename=islem_gecmisi_{datetime.now().strftime("%Y%m%d")}.csv'}
        )
    except Exception as e:
        return jsonify({"error": str(e)}), 500


# ==============================================
# SYSTEM HEALTH MONITOR - Real-time
# ==============================================

@app.get('/api/system/health')
def api_system_health():
    """Real-time system health data"""
    import psutil
    import platform
    
    try:
        # CPU usage
        cpu_percent = psutil.cpu_percent(interval=0.1)
        
        # Memory usage
        mem = psutil.virtual_memory()
        mem_percent = mem.percent
        mem_used = mem.used / (1024 ** 3)  # GB
        mem_total = mem.total / (1024 ** 3)  # GB
        
        # Disk usage
        disk = psutil.disk_usage('/')
        disk_percent = disk.percent
        
        # Network (simplified)
        net = psutil.net_io_counters()
        net_sent = net.bytes_sent / (1024 ** 2)  # MB
        net_recv = net.bytes_recv / (1024 ** 2)  # MB
        
        # Process count
        process_count = len(psutil.pids())
        
        # Uptime
        boot_time = psutil.boot_time()
        uptime_seconds = int(time.time() - boot_time)
        uptime_hours = uptime_seconds // 3600
        uptime_mins = (uptime_seconds % 3600) // 60
        
        # Database status
        db_status = "online"
        try:
            conn = db()
            conn.execute("SELECT 1").fetchone()
            conn.close()
        except:
            db_status = "offline"
        
        # API status
        api_status = "online"
        
        return jsonify({
            "ok": True,
            "timestamp": int(time.time()),
            "cpu": {"percent": cpu_percent, "cores": psutil.cpu_count()},
            "memory": {"percent": mem_percent, "used_gb": round(mem_used, 2), "total_gb": round(mem_total, 2)},
            "disk": {"percent": disk_percent},
            "network": {"sent_mb": round(net_sent, 2), "recv_mb": round(net_recv, 2)},
            "processes": process_count,
            "uptime": f"{uptime_hours}s {uptime_mins}dk",
            "services": {
                "database": db_status,
                "api": api_status,
                "trading_engine": "online",
                "telegram": "online" if os.getenv("TELEGRAM_BOT_TOKEN") else "offline"
            }
        })
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})


# ==============================================
# ADMIN REFERRAL URL SETTING
# ==============================================

@app.get('/api/admin/settings')
def api_admin_settings():
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin required"}), 403
    
    try:
        conn = db()
        # Ensure settings table exists
        conn.execute("""
            CREATE TABLE IF NOT EXISTS settings (
                key TEXT PRIMARY KEY,
                value TEXT
            )
        """)
        conn.commit()
        
        rows = conn.execute("SELECT key, value FROM settings").fetchall()
        conn.close()
        
        settings = {r[0]: r[1] for r in rows}
        return jsonify({"ok": True, "settings": settings})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

@app.post('/api/admin/settings')
def api_admin_settings_update():
    if not session.get("is_admin"):
        return jsonify({"ok": False, "error": "Admin required"}), 403
    
    data = request.get_json() or {}
    
    try:
        conn = db()
        conn.execute("""
            CREATE TABLE IF NOT EXISTS settings (
                key TEXT PRIMARY KEY,
                value TEXT
            )
        """)
        
        for key, value in data.items():
            conn.execute("INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)", (key, str(value)))
        
        conn.commit()
        conn.close()
        return jsonify({"ok": True})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})

@app.get('/api/referral/url')
def api_referral_url():
    """Get referral base URL"""
    try:
        conn = db()
        row = conn.execute("SELECT value FROM settings WHERE key='referral_base_url'").fetchone()
        conn.close()
        
        base_url = row[0] if row else "https://atalayulusoy.com"
        return jsonify({"ok": True, "base_url": base_url})
    except:
        return jsonify({" ok": True, "base_url": "https://atalayulusoy.com"})


# === CRITICAL: START DEMO & REAL TRADING ENGINES ===
def _start_trading_engines():
    """Start both demo and real trading worker threads"""
    import threading
    
    # === NEW: Demo Auto Trade Processor ===
    def demo_auto_trade_processor():
        """
        Reads auto_positions table for waiting demo trades.
        Executes fake BUY, waits 2-5 minutes, then fake SELL with profit.
        Logs all transactions to transaction_history.
        
        Settings:
        - Target: ~15 trades per day (~96 min cycle)
        - Gross Profit: 0.50%
        - Trading Fee: 0.20% (total for BUY+SELL)
        - Net Profit: 0.30%
        """
        import random
        import ccxt
        
        # Trading parameters
        GROSS_PROFIT_PCT = 0.50  # 0.50% gross profit
        FEE_PCT = 0.20           # 0.20% fee (BUY + SELL combined)
        NET_PROFIT_PCT = GROSS_PROFIT_PCT - FEE_PCT  # 0.30% net
        
        # Timing parameters (for ~15 trades/day)
        CHECK_INTERVAL = 300         # 5 minutes between checks
        BUY_TO_SELL_WAIT = (120, 300)  # 2-5 minutes between BUY and SELL
        CYCLE_WAIT = (4800, 6000)      # 80-100 minutes wait after SELL cycle
        
        print("[DEMO_AUTO] ğŸ¯ Demo auto trade processor starting...")
        print(f"[DEMO_AUTO] ğŸ“Š Settings: {NET_PROFIT_PCT}% net profit, ~15 trades/day")
        
        while True:
            try:
                time.sleep(CHECK_INTERVAL)  # Check every 5 minutes
                
                conn = db()
                # Get all WAITING demo trades
                waiting = conn.execute("""
                    SELECT id, user_id, coin, amount_usdt, target_pct, created_at 
                    FROM auto_positions 
                    WHERE status='waiting' AND mode='demo'
                    LIMIT 5
                """).fetchall()
                
                if not waiting:
                    conn.close()
                    continue
                
                for row in waiting:
                    trade_id, user_id, coin, amount_usdt, target_pct, created_at = row
                    
                    # Normalize coin format
                    symbol = coin if "/" in coin else f"{coin}/USDT"
                    
                    # Get current price
                    try:
                        ex = ccxt.okx({"enableRateLimit": True, "timeout": 5000})
                        ticker = ex.fetch_ticker(symbol)
                        entry_price = float(ticker.get("last", 0))
                    except:
                        entry_price = 0
                    
                    if entry_price <= 0:
                        continue
                    
                    # Calculate quantity and profit target
                    qty = amount_usdt / entry_price
                    # Use configured profit settings
                    gross_pct = GROSS_PROFIT_PCT  # 0.50%
                    fee_pct = FEE_PCT              # 0.20%
                    net_pct = NET_PROFIT_PCT       # 0.30% net
                    
                    exit_price = entry_price * (1 + gross_pct / 100)
                    gross_profit = amount_usdt * (gross_pct / 100)
                    fee = amount_usdt * (fee_pct / 100)
                    profit = gross_profit - fee  # Net profit after fee
                    
                    # Get username for logging
                    user_row = conn.execute("SELECT username FROM users WHERE id=?", (user_id,)).fetchone()
                    username = user_row[0] if user_row else f"user_{user_id}"
                    
                    # === FAKE BUY ===
                    conn.execute("""
                        UPDATE auto_positions 
                        SET status='open', entry_price=?, entry_at=datetime('now')
                        WHERE id=?
                    """, (entry_price, trade_id))
                    conn.commit()
                    
                    # DEDUCT from demo balance on BUY
                    try:
                        new_balance = update_demo_balance(int(user_id), -abs(amount_usdt))
                        print(f"[DEMO_AUTO] ğŸ’° Balance deducted: -{amount_usdt} USDT â†’ {new_balance:.2f}")
                    except Exception as bal_err:
                        print(f"[DEMO_AUTO] âš ï¸ Balance deduct error: {bal_err}")
                    
                    # Log BUY to transaction_history
                    try:
                        conn.execute("""
                            INSERT INTO transaction_history (
                                username, type, symbol, amount, price, total,
                                profit, timestamp, is_simulated, mode
                            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        """, (username, "BUY", symbol, qty, entry_price, amount_usdt, 0.0, int(time.time()), 1, "demo"))
                        conn.commit()
                        print(f"[HISTORY] âœ… BUY recorded: {username} {symbol} {amount_usdt} USDT @ {entry_price:.4f}", flush=True)
                    except Exception as hist_err:
                        print(f"[HISTORY] âŒ BUY record failed: {hist_err}", flush=True)
                    
                    print(f"[DEMO_AUTO] âœ… BUY {username}: {symbol} @ {entry_price:.4f} | Amount: {amount_usdt} USDT")

                    
                conn.close()
                
                # Wait 2-5 minutes before SELL (realistic trading time)
                wait_time = random.randint(BUY_TO_SELL_WAIT[0], BUY_TO_SELL_WAIT[1])
                print(f"[DEMO_AUTO] â³ Waiting {wait_time//60}m {wait_time%60}s before SELL...")
                time.sleep(wait_time)
                
                conn = db()
                # Get OPEN demo trades older than 10 seconds
                open_trades = conn.execute("""
                    SELECT id, user_id, coin, amount_usdt, entry_price, target_pct
                    FROM auto_positions 
                    WHERE status='open' AND mode='demo'
                    LIMIT 5
                """).fetchall()
                
                for row in open_trades:
                    trade_id, user_id, coin, amount_usdt, entry_price, target_pct = row
                    
                    symbol = coin if "/" in coin else f"{coin}/USDT"
                    
                    # Get current price for exit
                    try:
                        ex = ccxt.okx({"enableRateLimit": True, "timeout": 5000})
                        ticker = ex.fetch_ticker(symbol)
                        current_price = float(ticker.get("last", 0))
                    except:
                        current_price = entry_price * 1.005  # Fake 0.5% profit
                    
                    # Calculate PNL with fee deduction
                    gross_pct = GROSS_PROFIT_PCT  # 0.50%
                    fee_pct = FEE_PCT              # 0.20%
                    
                    exit_price = entry_price * (1 + gross_pct / 100)
                    gross_profit = amount_usdt * (gross_pct / 100)
                    fee = amount_usdt * (fee_pct / 100)
                    profit = gross_profit - fee  # Net profit: ~0.30%
                    qty = amount_usdt / entry_price if entry_price > 0 else 0
                    
                    # Get username
                    user_row = conn.execute("SELECT username FROM users WHERE id=?", (user_id,)).fetchone()
                    username = user_row[0] if user_row else f"user_{user_id}"
                    
                    # === FAKE SELL ===
                    # Loop: Set status back to 'waiting' so it will BUY again!
                    conn.execute("""
                        UPDATE auto_positions 
                        SET status='waiting', current_price=?, pnl=COALESCE(pnl,0)+?, entry_price=NULL, exit_at=datetime('now')
                        WHERE id=?
                    """, (exit_price, profit, trade_id))
                    conn.commit()
                    
                    # Update user demo balance with profit
                    try:
                        new_balance = update_demo_balance(int(user_id), amount_usdt + profit)
                    except:
                        new_balance = 0
                    
                    # Log SELL to transaction_history
                    try:
                        conn.execute("""
                            INSERT INTO transaction_history (
                                username, type, symbol, amount, price, total,
                                profit, timestamp, is_simulated, mode
                            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        """, (username, "SELL", symbol, qty, exit_price, amount_usdt + profit, profit, int(time.time()), 1, "demo"))
                        conn.commit()
                        print(f"[HISTORY] âœ… SELL recorded: {username} {symbol} {amount_usdt} USDT @ {exit_price:.4f} | Profit: {profit:.2f}", flush=True)
                    except Exception as hist_err:
                        print(f"[HISTORY] âŒ SELL record failed: {hist_err}", flush=True)
                    
                    print(f"[DEMO_AUTO] ğŸ’° SELL {username}: {symbol} @ {exit_price:.4f} | Profit: +{profit:.2f} USDT | Balance â†’ {new_balance:.2f}")

                
                conn.close()
                
                # Wait 80-100 minutes before next trade cycle (~15 trades/day)
                cycle_wait = random.randint(CYCLE_WAIT[0], CYCLE_WAIT[1])
                print(f"[DEMO_AUTO] ğŸ”„ Cycle complete. Next trade in {cycle_wait//60}m...")
                time.sleep(cycle_wait)
                
            except Exception as e:
                print(f"[DEMO_AUTO] âŒ Error: {e}")
                time.sleep(5)
    
    # Start DEMO worker thread (existing - handles manual positions)
    def start_demo_worker():
        if globals().get("_DEMO_WORKER_STARTED"):
            return
        globals()["_DEMO_WORKER_STARTED"] = True
        
        print("[DEMO_ENGINE] ğŸ® Starting DEMO trading worker thread...")
        t = threading.Thread(target=_demo_worker_loop, name="demo_worker", daemon=True)
        t.start()
        print("[DEMO_ENGINE] âœ… DEMO worker thread started - fake trading ACTIVE!")
    
    # Start DEMO AUTO processor (NEW - handles auto_positions table)
    def start_demo_auto_processor():
        if globals().get("_DEMO_AUTO_STARTED"):
            return
        globals()["_DEMO_AUTO_STARTED"] = True
        
        print("[DEMO_AUTO] ğŸ¯ Starting DEMO auto trade processor...")
        t = threading.Thread(target=demo_auto_trade_processor, name="demo_auto_processor", daemon=True)
        t.start()
        print("[DEMO_AUTO] âœ… DEMO auto trade processor started!")
    
    # Start REAL worker thread
    def start_real_worker():
        if globals().get("_REAL_WORKER_STARTED"):
            return
        globals()["_REAL_WORKER_STARTED"] = True
        
        print("[REAL_ENGINE] ğŸ’° Starting REAL trading worker thread...")
        t = threading.Thread(target=_real_worker_loop, name="real_worker", daemon=True)
        t.start()
        print("[REAL_ENGINE] âœ… REAL worker thread started - OKX integration ACTIVE!")
    
    try:
        start_demo_worker()
    except Exception as e:
        print(f"[DEMO_ENGINE] âŒ Failed to start demo worker: {e}")
    
    try:
        start_demo_auto_processor()
    except Exception as e:
        print(f"[DEMO_AUTO] âŒ Failed to start demo auto processor: {e}")
    
    try:
        start_real_worker()
    except Exception as e:
        print(f"[REAL_ENGINE] âŒ Failed to start real worker: {e}")
# === END TRADING ENGINES ===


# === AU_FORCE_FLASK_RUN_V1 ===
def _au_force_run_flask():
    """
    Safety net: If server.py reaches EOF without starting a web server,
    start Flask so systemd doesn't exit successfully and kill the service.
    """
    import os
    host = os.getenv("HOST", "0.0.0.0").strip() or "0.0.0.0"
    port_s = (os.getenv("PORT", "8080") or "8080").strip()
    try:
        port = int(port_s)
    except Exception:
        port = 8080

    try:
        print(f"[BOOT] Starting Flask on {host}:{port} debug=False", flush=True)
    except Exception:
        pass

    # âœ… CRITICAL: Start trading engines BEFORE app.run() blocks
    try:
        _start_trading_engines()
        print("\n" + "="*60)
        print("ğŸš€ TRADING ENGINES BAÅLATILDI!")
        print("   âœ… e: Fake trading ACTIVE")
        print("   âœ… Real Mode: OKX integration ACTIVE")
        print("="*60 + "\n", flush=True)
    except Exception as e:
        print(f"[STARTUP] âš ï¸ Trading engine baÅŸlatma hatasÄ±: {e}", flush=True)

    # This blocks the main thread (desired under systemd)
    app.run(host=host, port=port, debug=False)

if __name__ == "__main__":
    # If earlier code already started a server, it would be blocking and never reach here.
    # If we reached here, force start Flask.
    _au_force_run_flask()
# === END AU_FORCE_FLASK_RUN_V1 ===


# === AU_DEMO_SELL_THREAD_V1 ===
def _au_start_demo_sell_thread():
    import threading, time
    if globals().get("_AU_DEMO_SELL_THREAD_STARTED"):
        return
    globals()["_AU_DEMO_SELL_THREAD_STARTED"] = True

    def run():
        while True:
            try:
                _au_scan_and_auto_sell_demo()
            except Exception as e:
                try:
                    _au_log("demo_sell_thread_err", error=str(e))
                except Exception:
                    pass
            time.sleep(2)

    t = threading.Thread(target=run, name="au_demo_sell_thread", daemon=True)
    t.start()

try:
    _au_start_demo_sell_thread()
except Exception:
    pass
# === END AU_DEMO_SELL_THREAD_V1 ===\n


# --- NUCLEAR ROUTE INJECTIONS (REMOVED - Duplicate routes) ---
# These were duplicate and causing AssertionError
# Original routes are defined earlier in the file (line 20349-20400)

# Wrap Flask WSGI app for ASGI compatibility (uvicorn)
from asgiref.wsgi import WsgiToAsgi
_flask_wsgi_app = app
app = WsgiToAsgi(_flask_wsgi_app)

